var evaluaterInited = false
var evaluating = false
window._vkm_debug = true

var evaluater
var evalMode, refText
var submitEl = document.getElementById('submit')
var resultEl = document.getElementById('result')

initEvaluater()
submitEl.addEventListener('click', toggleRecord)

// 初始化Evaluater实例
function initEvaluater() {
  evaluater = new VKEvaluater({
    appId: 'cca8e592d7b2451d86f622a1cdaf84de',
    env: 'test',
    onState: function(state) {
      // 初始化成功
      if(state.code === 3) {
        console.log('初始化成功')
        evaluaterInited = true
      }

      // 获得评测结果
      if(state.code === 6) {
        var result = state.data
        console.log('评测结果', result)
        resultEl.value = JSON.stringify(result, null, 4)
      }
      console.log('state code: ', state.code)
      // 详细state见说明文档中的"状态码说明"
    },
    onError: (error) => {
      console.log('错误信息', error)
      // 发送评测文本信息失败
      if(error.code === 4001) {
        evaluater.stop()
        alert('评测文本信息有误')
      }

      // 详细error见说明文档中的"错误码说明"
    }
  })
}

function toggleRecord() {
  if(evaluating) {
    submitEl.innerHTML = '开始录音'
    evaluating = false
    evaluater.stop()
    resultEl.value = '结果获取中...'
  } else {
    evaluating = true
    submitEl.innerHTML = '录音中...'
    resultEl.value = ''

    // 获取各项参数
    evalMode = getRadioValue('evalMode')
    refText = getInputValue('text')

    // 开始评测
    evaluater.start({
      refText: refText,
      textMode: 0,
      evalMode: evalMode,
      rank: 100
    })
  }
}

function getInputValue(id) {
  return document.getElementById(id).value
}

function getRadioValue(name) {
  var elList = document.querySelectorAll('input[name="' + name + '"]')

  for(var i=0; i<elList.length; i++) {
    if(elList[i].checked) {
      return parseInt(elList[i].value)
      break
    }
  }
}
