{"version":3,"sources":["../src/index.js"],"names":["states","require","filepush","default","EvaluaterCore","AudioRecorder","coreStates","NOT_READY","CONNECTING","PREPARE_START","WAITING_AUDIO_STREAM","RESULT_RECEIVING","RESULT_RECEIVED","CLOSED","VKEvaluater","options","env","apiUrlMap","test","pre","prod","appId","_errorCb","onError","_stateCb","onState","_audioUploadingList","_audioUploadedList","_resultList","_audioUploading","_resultDealing","_currId","_currAudioBlob","apiUrl","start","stop","close","state","that","evaluater","recorder","init","err","_throwError","_evaluaterStateChange","_evaluaterError","onRecording","stream","_checkCondition","sendAudioStream","exportBlob","blob","push","id","audioBlob","_startAudioUpload","info","sendAudioInfo","_updateAndEmitState","AUDIO_RECORDING","_generateUniqStr","newState","_log","code","_updateState","data","result","view","audioUrl","updateState","scoreId","_dealResult","resultItem","find","audioItem","uploadResultInfo","_uploadEvaluateResult","splice","indexOf","_uploadError","stage","Error","console","warn","type","recorderErrMap","evaluaterErrMap","message","map","unknown","_uploadAudio","cb","location","hostname","filename","file","File","lastModified","Date","now","upload","accessKey","secretKey","client","path","addfiles","submit","objects","url","length","once","item","shift","_myAjax","userId","deviceInfo","JSON","stringify","_getDeviceInfo","success","error","description","time","getTime","serverVersion","settings","xhr","XMLHttpRequest","hasError","onerror","onloadend","status","res","parse","responseText","e","open","setRequestHeader","send","userAgent","navigator","vendor","platform","appName","str","Math","random","toString","toUpperCase","toLowerCase","window","_vkm_debug","_vkm_evaluate_debug","args","Array","prototype","slice","call","arguments","unshift","debug","apply","arr","params","keys","Object","i","allMatch","j","key","module","exports"],"mappings":"AAAA;;;;;AAKA,IAAIA,SAASC,QAAQ,UAAR,CAAb;AACA,IAAIC,WAAWD,QAAQ,aAAR,EAAuBE,OAAtC;;AAEA,IAAIC,gBAAgBH,QAAQ,oBAAR,CAApB;AACA,IAAII,gBAAgBJ,QAAQ,oBAAR,CAApB;AACA,IAAIK,aAAa;AACfC,aAAW,CADI;AAEfC,cAAY,CAFG;AAGfC,iBAAe,CAHA;AAIfC,wBAAsB,CAJP;AAKfC,oBAAkB,CALH;AAMfC,mBAAiB,CANF;AAOfC,UAAQ;AAPO,CAAjB;;AAUA,SAASC,WAAT,CAAqBC,OAArB,EAA8B;AAC5B,MAAIC,MAAMD,QAAQC,GAAlB;AACAC,cAAY;AACVC,UAAM,8CADI;AAEVC,SAAK,2CAFK;AAGVC,UAAM;AAHI,GAAZ;;AAMA,MAAIC,QAAQN,QAAQM,KAApB;AACA,MAAIC,WAAWP,QAAQQ,OAAvB;AACA,MAAIC,WAAWT,QAAQU,OAAvB;AACA,MAAIC,sBAAsB,EAA1B;AACA,MAAIC,qBAAqB,EAAzB;AACA,MAAIC,cAAc,EAAlB;AACA;AACA,MAAIC,kBAAkB,KAAtB;AACA;AACA;AACA,MAAIC,iBAAiB,KAArB;AACA,MAAIC,UAAU,IAAd;AACA,MAAIC,iBAAiB,IAArB;AACA,MAAIC,SAAShB,UAAUD,OAAO,MAAjB,CAAb;;AAEA;;AAEA;AACA,OAAKkB,KAAL,GAAaA,KAAb;AACA,OAAKC,IAAL,GAAYA,IAAZ;AACA,OAAKC,KAAL,GAAaA,KAAb;AACA,OAAKC,KAAL,GAAarC,OAAOO,SAApB;;AAEA,MAAI+B,OAAO,IAAX;;AAEA,MAAIC,SAAJ;AACAD,OAAKE,QAAL,GAAgB,IAAInC,aAAJ,EAAhB;;AAEA;AACAoC;;AAEA;AACA,WAASA,IAAT,GAAgB;AACd;AACAH,SAAKE,QAAL,CAAcC,IAAd,CAAmB,UAASC,GAAT,EAAc;AAC/B,UAAGA,GAAH,EAAQ;AACNC,oBAAYD,GAAZ,EAAiB,EAACF,UAAU,IAAX,EAAjB;AACD,OAFD,MAEO;AACL;AACAD,oBAAY,IAAInC,aAAJ,CAAkB;AAC5BiB,iBAAOA,KADqB;AAE5BL,eAAKA,GAFuB;AAG5BS,mBAASmB,qBAHmB;AAI5BrB,mBAASsB;AAJmB,SAAlB,CAAZ;AAMD;AACF,KAZD;;AAcA;AACAP,SAAKE,QAAL,CAAcM,WAAd,CAA0B,UAASC,MAAT,EAAiB;AACzC,UAAG,CAACC,gBAAgB,iBAAhB,CAAJ,EAAwC;;AAExCT,gBAAUU,eAAV,CAA0BF,MAA1B;AACD,KAJD;AAKAT,SAAKE,QAAL,CAAcU,UAAd,CAAyB,UAASC,IAAT,EAAe;AACtCnB,uBAAiBmB,IAAjB;AACAzB,0BAAoB0B,IAApB,CAAyB,EAAEC,IAAItB,OAAN,EAAeuB,WAAWH,IAA1B,EAAzB;AACAI;AACD,KAJD;AAKD;;AAED;AACA,WAASrB,KAAT,CAAesB,IAAf,EAAqB;AACnB,QAAG,CAACR,gBAAgB,OAAhB,CAAJ,EAA8B;;AAE9B;AACAT,cAAUkB,aAAV,CAAwBD,IAAxB;;AAEA;AACAlB,SAAKE,QAAL,CAAcN,KAAd;AACA;AACAwB,wBAAoB1D,OAAO2D,eAA3B;;AAEA;AACA;AACD;;AAED,WAASxB,IAAT,GAAgB;AACd,QAAG,CAACa,gBAAgB,MAAhB,CAAJ,EAA6B;;AAE7BjB,cAAU6B,iBAAiB,EAAjB,CAAV;;AAEA;AACAtB,SAAKE,QAAL,CAAcL,IAAd;AACAI,cAAUJ,IAAV;AACD;;AAED,WAASC,KAAT,GAAiB;AACf,QAAGE,KAAKD,KAAL,KAAerC,OAAOO,SAAtB,IAAmC+B,KAAKD,KAAL,KAAerC,OAAOa,MAA5D,EAAoE;AACpE;AACAyB,SAAKE,QAAL,CAAcL,IAAd;AACAI,cAAUH,KAAV;AACD;;AAED,WAASQ,qBAAT,CAA+BiB,QAA/B,EAAyC;AACvCC,SAAK,iCAAL,EAAwCD,QAAxC;;AAEA,YAAOA,SAASE,IAAhB;AACE,WAAKzD,WAAWC,SAAhB;AACEyD,qBAAahE,OAAOO,SAApB;AACA;AACF,WAAKD,WAAWE,UAAhB;AACEkD,4BAAoB1D,OAAOQ,UAA3B;AACA;AACF,WAAKF,WAAWG,aAAhB;AACE,YAAG,CAACqB,cAAJ,EAAoB;AAClB4B,8BAAoB1D,OAAOS,aAA3B;AACD;AACD;AACF,WAAKH,WAAWK,gBAAhB;AACE+C,4BAAoB1D,OAAOW,gBAA3B;AACA;AACF,WAAKL,WAAWM,eAAhB;AACE,YAAIqD,OAAOJ,SAASI,IAApB;AACA,YAAIC,SAASD,KAAKE,IAAlB;AACAD,eAAOZ,SAAP,GAAmBtB,cAAnB;AACA;AACA,YAAGkC,OAAOE,QAAV,EAAoB;AAClBV,8BAAoB1D,OAAOY,eAA3B,EAA4C,IAA5C,EAAkDsD,MAAlD;AACA3B,oBAAU8B,WAAV,CAAsBrE,OAAOS,aAA7B;AACD,SAHD,MAGO;AACLqB,2BAAiB,IAAjB;AACD;AACD;AACAF,oBAAYwB,IAAZ,CAAiB,EAAEC,IAAItB,OAAN,EAAemC,QAAQA,MAAvB,EAA+BI,SAASL,KAAKK,OAA7C,EAAjB;AACAC,oBAAYxC,OAAZ;AACA;AACF,WAAKzB,WAAWO,MAAhB;AACE6C,4BAAoB1D,OAAOa,MAA3B;AACA;AAhCJ;AAkCD;;AAED;AACA,WAAS0D,WAAT,CAAqBlB,EAArB,EAAyB;AACvB,QAAImB,aAAaC,KAAK7C,WAAL,EAAkB,EAAEyB,IAAIA,EAAN,EAAlB,CAAjB;AACA,QAAIqB,YAAYD,KAAK9C,kBAAL,EAAyB,EAAE0B,IAAIA,EAAN,EAAzB,CAAhB;;AAEA,QAAG,CAACmB,UAAD,IAAe,CAACE,SAAnB,EAA8B;;AAE9B,QAAIR,SAASM,WAAWN,MAAxB;AACA;AACA;AACA,QAAG,CAACA,OAAOE,QAAX,EAAqB;AACnBF,aAAOE,QAAP,GAAkBM,UAAUN,QAA5B;AACAV,0BAAoB1D,OAAOY,eAA3B,EAA4C,IAA5C,EAAkDsD,MAAlD;;AAEApC,uBAAiB,KAAjB;AACAS,gBAAU8B,WAAV,CAAsBrE,OAAOS,aAA7B;AACD;;AAED;AACA,QAAIkE,mBAAmB,EAAEL,SAASE,WAAWF,OAAtB,EAA+BF,UAAUM,UAAUN,QAAnD,EAAvB;AACAQ,0BAAsBD,gBAAtB,EAAwC,YAAW,CAAE,CAArD;;AAEA;AACA/C,gBAAYiD,MAAZ,CAAmBjD,YAAYkD,OAAZ,CAAoBN,UAApB,CAAnB,EAAoD,CAApD;AACA7C,uBAAmBkD,MAAnB,CAA0BlD,mBAAmBmD,OAAnB,CAA2BJ,SAA3B,CAA1B,EAAiE,CAAjE;AACD;;AAED,WAAS7B,eAAT,CAAyBH,GAAzB,EAA8B;AAC5BoB,SAAK,sBAAL,EAA6BpB,GAA7B;;AAEA,YAAOA,IAAIqB,IAAX;AACE,WAAK,IAAL;AACA,WAAK,IAAL;AACA,WAAK,IAAL;AACEpB,oBAAYD,GAAZ,EAAiB,EAACF,UAAU,IAAX,EAAjB;;AAEA,YAAG,CAAC,IAAD,EAAO,IAAP,EAAasC,OAAb,CAAqBpC,IAAIqB,IAAzB,IAAiC,CAAC,CAArC,EAAwC;AACtCgB,uBAAarC,GAAb;AACD;AACD;AACF,WAAK,IAAL;AACEC,oBAAYD,GAAZ,EAAiB,EAACF,UAAU,IAAX,EAAjB;AACA;AACF,WAAK,IAAL;AACA,WAAK,IAAL;AACA,WAAK,IAAL;AACEF,aAAKE,QAAL,CAAcL,IAAd;AACAQ,oBAAYD,GAAZ,EAAiB,EAACH,WAAW,IAAZ,EAAjB;AACA;AACF;AACEI,oBAAYD,GAAZ,EAAiB,EAACF,UAAU,IAAX,EAAjB;AACAsB,aAAK,wBAAL,EAA+BpB,GAA/B;;AAEF;AAvBF;AAyBD;;AAED,WAASM,eAAT,CAAyBgC,KAAzB,EAAgC;AAC9BlB,SAAK,SAAL,EAAgBkB,KAAhB,EAAuB,WAAvB,EAAoC1C,KAAKD,KAAzC;;AAEA;AACA,QAAGC,KAAKD,KAAL,KAAerC,OAAOO,SAAzB,EAAoC;AAClC,YAAM,IAAI0E,KAAJ,CAAU,qCAAV,CAAN;AACD;AACD,QAAG3C,KAAKD,KAAL,KAAerC,OAAOQ,UAAzB,EAAqC;AACnC,YAAM,IAAIyE,KAAJ,CAAU,+CAAV,CAAN;AACD;AACD;AACA;AACA;AACA,QAAG3C,KAAKD,KAAL,KAAerC,OAAOa,MAAzB,EAAiC;AAC/B,YAAM,IAAIoE,KAAJ,CAAU,sFAAV,CAAN;AACD;;AAED,QAAGD,UAAU,OAAV,IAAqB1C,KAAKD,KAAL,KAAerC,OAAOS,aAA9C,EAA6D;AAC3D,YAAM,IAAIwE,KAAJ,CAAU,8DAAV,CAAN;AACD;AACD,QAAGD,UAAU,MAAV,IAAoB1C,KAAKD,KAAL,KAAerC,OAAO2D,eAA7C,EAA8D;AAC5DuB,cAAQC,IAAR,CAAa,4DAAb;AACA,aAAO,KAAP;AACD;;AAED,WAAO,IAAP;AACD;;AAED,WAASxC,WAAT,CAAqByC,IAArB,EAA2BrE,OAA3B,EAAoC;AAClC,QAAIsE,iBAAiB;AACnB,cAAQ;AADW,KAArB;;AAIA,QAAIC,kBAAkB;AACpB,YAAM,oBADc;AAEpB,YAAM,eAFc;AAGpB,YAAM,gBAHc;AAIpB,YAAM,UAJc;AAKpB,YAAM,kBALc;AAMpB,YAAM,cANc;AAOpB,YAAM,iBAPc;AAQpB,YAAM;AARc,KAAtB;;AAWA,QAAIC,UAAUxE,WAAWA,QAAQwE,OAAjC;;AAEA;AACA,QAAGxE,WAAWA,QAAQyB,QAAR,KAAqB,IAAnC,EAAyC;AACvC+C,gBAAUH,KAAKG,OAAf;AACAH,aAAOC,eAAeD,KAAKrB,IAApB,CAAP;AACD;AACD;AACA,QAAGhD,WAAWA,QAAQwB,SAAR,KAAsB,IAApC,EAA0C;AACxCgD,gBAAUH,KAAKG,OAAf;AACAH,aAAOE,gBAAgBF,KAAKrB,IAArB,CAAP;AACD;;AAED,QAAIyB,MAAM;AACR,4BAAsB,EAAEzB,MAAM,IAAR,EAAcwB,SAASA,WAAW,wBAAlC,EADd;AAER,0BAAoB,EAAExB,MAAM,IAAR,EAAcwB,SAASA,WAAW,sBAAlC,EAFZ;AAGR,8BAAwB,EAAExB,MAAM,IAAR,EAAcwB,SAASA,WAAW,wBAAlC,EAHhB;AAIR,uBAAiB,EAAExB,MAAM,IAAR,EAAcwB,SAAS,uBAAvB,EAJT;AAKR,wBAAkB,EAAExB,MAAM,IAAR,EAAcwB,SAAS,iBAAvB,EALV;AAMR,wBAAkB,EAAExB,MAAM,IAAR,EAAcwB,SAAS,iBAAvB,EANV;AAOR,kBAAY,EAAExB,MAAM,IAAR,EAAcwB,SAAS,eAAvB,EAPJ;;AASR;AACA,0BAAoB,EAAExB,MAAM,IAAR,EAAcwB,SAASA,WAAW,oBAAlC,EAVZ;AAWR,sBAAgB,EAAExB,MAAM,IAAR,EAAcwB,SAASA,WAAW,iBAAlC,EAXR;AAYR,yBAAmB,EAAExB,MAAM,IAAR,EAAcwB,SAASA,WAAW,kBAAlC,EAZX;AAaR,iBAAW,EAAExB,MAAM,IAAR,EAAcwB,SAAS,eAAvB;AAbH,KAAV;;AAgBA,QAAI7C,MAAM8C,IAAIJ,IAAJ,CAAV;AACA,QAAG1C,GAAH,EAAQA,IAAI6C,OAAJ,GAAcA,WAAW7C,IAAI6C,OAA7B;;AAERjE,aAASoB,OAAO8C,IAAIC,OAApB;AACD;;AAED,WAASzB,YAAT,CAAsBH,QAAtB,EAAgC;AAC9BvB,SAAKD,KAAL,GAAawB,QAAb;AACD;;AAED,WAASH,mBAAT,CAA6BG,QAA7B,EAAuC0B,OAAvC,EAAgDtB,IAAhD,EAAsD;AACpDD,iBAAaH,QAAb;;AAEArC,aAAS,EAACuC,MAAMF,QAAP,EAAiB0B,SAASA,OAA1B,EAAmCtB,MAAMA,IAAzC,EAAT;AACD;;AAED;AACA,WAASyB,YAAT,CAAsBpC,SAAtB,EAAiCqC,EAAjC,EAAqC;AACnC;AACA,QAAGC,SAASC,QAAT,KAAsB,WAAzB,EAAsC;AACpC/B,WAAK,gCAAL;AACA,aAAO6B,GAAG,IAAH,EAAS,uEAAT,CAAP;AACD;;AAED,QAAIG,WAAWlC,iBAAiB,EAAjB,CAAf;AACA,QAAImC,OAAO,IAAIC,IAAJ,CAAS,CAAC1C,SAAD,CAAT,EAAsBwC,WAAW,MAAjC,EAAyC,EAACV,MAAM,WAAP,EAAoBa,cAAcC,KAAKC,GAAL,EAAlC,EAAzC,CAAX;;AAEA,QAAIC,SAAS,IAAIlG,QAAJ,CAAa;AACxBmG,iBAAW,kBADa;AAExBC,iBAAW,kCAFa;AAGxBC,cAAQ,aAHgB;AAIxBC,YAAM;AAJkB,KAAb,CAAb;;AAOAJ,WAAOK,QAAP,CAAgBV,IAAhB;AACAK,WAAOM,MAAP,CAAc,UAAShE,GAAT,EAAcuB,IAAd,EAAoB;AAChC,UAAGvB,GAAH,EAAQ;AACNiD,WAAGjD,GAAH;AACD,OAFD,MAEO;AACLiD,WAAG,IAAH,EAAS1B,KAAK0C,OAAL,CAAa,CAAb,EAAgBC,GAAzB;AACD;AACF,KAND,EAMG,YAAW;AACZ;AACD,KARD;AASD;;AAED,WAASrD,iBAAT,GAA6B;AAC3B,QAAG1B,eAAH,EAAoB;;AAEpB,QAAGH,oBAAoBmF,MAApB,KAA+B,CAAlC,EAAqC;;AAErChF,sBAAkB,IAAlB;;AAEA,QAAIiF,OAAO,YAAW;AACpBC,aAAOrF,oBAAoBsF,KAApB,EAAP;;AAEA;AACA,UAAG,CAACD,IAAJ,EAAU;AACRlF,0BAAkB,KAAlB;AACA;AACD;;AAED6D,mBAAaqB,KAAKzD,SAAlB,EAA6B,UAASZ,GAAT,EAAc0B,QAAd,EAAwB;AACnD,YAAG1B,GAAH,EAAQoB,KAAK,mBAAL,EAA0BpB,GAA1B;;AAERqE,aAAK3C,QAAL,GAAgBA,YAAY,IAA5B;AACAzC,2BAAmByB,IAAnB,CAAwB2D,IAAxB;AACAxC,oBAAYwC,KAAK1D,EAAjB;;AAEAyD;AACD,OARD;AASD,KAlBD;;AAoBAA;AACD;;AAED;AACA,WAASlC,qBAAT,CAA+BmC,IAA/B,EAAqCpB,EAArC,EAAyC;AACvCsB,YAAQ;AACNL,WAAK3E,SAAS,cADR;AAENmD,YAAM,MAFA;AAGNnB,YAAM;AACJiD,gBAAQnG,QAAQmG,MAAR,IAAkB,EADtB,EAC0B;AAC9B7F,eAAOA,KAFH;AAGJiD,iBAASyC,KAAKzC,OAHV;AAIJF,kBAAU2C,KAAK3C,QAJX;AAKJ+C,oBAAYC,KAAKC,SAAL,CAAeC,gBAAf;AALR,OAHA;AAUNC,eAAS,YAAW;AAClB5B,cAAMA,IAAN;AACA7B,aAAK,gCAAL;AACD,OAbK;AAcN0D,aAAO,UAAS9E,GAAT,EAAc;AACnBiD,cAAMA,IAAN;AACA7B,aAAK,6BAAL,EAAoCpB,GAApC;AACD;AAjBK,KAAR;AAmBD;;AAED;AACA,WAASqC,YAAT,CAAsBrC,GAAtB,EAA2B;AACzBuE,YAAQ;AACNL,WAAK3E,SAAS,kBADR;AAENmD,YAAM,MAFA;AAGNnB,YAAM;AACJ5C,eAAOA,KADH;AAEJ0C,cAAM,OAFF;AAGJ0D,qBAAaL,KAAKC,SAAL,CAAe;AAC1BH,kBAAQnG,QAAQmG,MAAR,IAAkB,EADA,EACI;AAC9B3B,mBAAS7C,IAAI6C,OAFa;AAG1BmC,gBAAM,IAAIxB,IAAJ,GAAWyB,OAAX,EAHoB;AAI1B;AACAR,sBAAYC,KAAKC,SAAL,CAAeC,gBAAf,CALc;AAM1BM,yBAAe;AANW,SAAf;AAHT,OAHA;AAeNL,eAAS,YAAW;AAClBzD,aAAK,sBAAL;AACD,OAjBK;AAkBN0D,aAAO,UAAS9E,GAAT,EAAc;AACnBoB,aAAK,qBAAL,EAA4BpB,GAA5B;AACD;AApBK,KAAR;AAsBD;;AAED,WAASuE,OAAT,CAAiBY,QAAjB,EAA2B;AACzBA,aAASN,OAAT,GAAmBM,SAASN,OAAT,IAAoB,YAAW,CAAE,CAApD;AACAM,aAASL,KAAT,GAAiBK,SAASL,KAAT,IAAkB,YAAW,CAAE,CAAhD;;AAEA,QAAIM,MAAM,IAAIC,cAAJ,EAAV;AACA,QAAIC,WAAW,KAAf;;AAEAF,QAAIG,OAAJ,GAAc,UAASvF,GAAT,EAAc;AAC1BoB,WAAK,UAAL,EAAiBpB,GAAjB;AACAsF,iBAAW,IAAX;AACD,KAHD;;AAKAF,QAAII,SAAJ,GAAgB,YAAW;AACzB,UAAGF,QAAH,EAAa;AACXH,iBAASL,KAAT,CAAe,uBAAf;AACD,OAFD,MAEO;AACL;AACA,YAAGM,IAAIK,MAAJ,KAAe,GAAlB,EAAuB;AACrBN,mBAASL,KAAT,CAAe,6BAAf;AACA;AACD;;AAED;AACA,YAAIY,GAAJ;AACA,YAAI;AACFA,gBAAMhB,KAAKiB,KAAL,CAAWP,IAAIQ,YAAf,CAAN;AACD,SAFD,CAEE,OAAOC,CAAP,EAAU;AACV,iBAAOV,SAASL,KAAT,CAAe,uBAAf,CAAP;AACD;;AAED,YAAGM,IAAIK,MAAJ,KAAe,GAAlB,EAAuB;AACrBN,mBAASN,OAAT,CAAiBa,IAAInE,IAArB;AACD,SAFD,MAEO,IAAG6D,IAAIK,MAAJ,KAAe,GAAlB,EAAuB;AAC5BN,mBAASL,KAAT,CAAeY,IAAI7C,OAAnB;AACD;AACF;AACF,KAxBD;;AA0BAuC,QAAIU,IAAJ,CAASX,SAASzC,IAAT,IAAiB,KAA1B,EAAiCyC,SAASjB,GAA1C,EAA+C,IAA/C;;AAEA,QAAGiB,SAASzC,IAAT,KAAkB,MAAlB,IAA4ByC,SAAS5D,IAAxC,EAA8C;AAC5C6D,UAAIW,gBAAJ,CAAqB,cAArB,EAAoC,iCAApC;AACAX,UAAIY,IAAJ,CAAStB,KAAKC,SAAL,CAAeQ,SAAS5D,IAAxB,CAAT;AACD,KAHD,MAGO;AACL6D,UAAIY,IAAJ;AACD;AACF;;AAED,WAASpB,cAAT,GAA0B;AACxB,WAAO;AACLqB,iBAAWC,UAAUD,SADhB;AAELE,cAAQD,UAAUC,MAFb;AAGLC,gBAAUF,UAAUE,QAHf;AAILC,eAASH,UAAUG;AAJd,KAAP;AAMD;;AAED,WAASnF,gBAAT,CAA0BiD,MAA1B,EAAkC;AAChC,QAAImC,MAAM,EAAV;AACAnC,aAASA,UAAU,EAAnB;AACA,WAAOA,QAAP,EAAiB;AACfmC,aAAO,CAACC,KAAKC,MAAL,KAAgB,EAAhB,GAAqB,CAAtB,IAA2B,CAA3B,GAA+B,CAACD,KAAKC,MAAL,KAAgB,EAAhB,GAAqB,CAAtB,EAAyBC,QAAzB,CAAkC,EAAlC,CAA/B,GACH,CAACF,KAAKC,MAAL,KAAgB,EAAhB,GAAqB,CAAtB,EAAyBC,QAAzB,CAAkC,EAAlC,EAAsCC,WAAtC,EADJ;AAED;AACD,WAAOJ,IAAIK,WAAJ,EAAP;AACD;;AAED,WAASvF,IAAT,GAAgB;AACd,QAAG,EAAGwF,OAAOC,UAAP,KAAsB,IAAvB,IAAiCD,OAAOE,mBAAP,KAA+B,IAAlE,CAAH,EAA6E;;AAE7E,QAAIC,OAAOC,MAAMC,SAAN,CAAgBC,KAAhB,CAAsBC,IAAtB,CAA2BC,SAA3B,CAAX;AACA;AACAL,SAAKM,OAAL,CAAa,YAAb;AACA7E,YAAQ8E,KAAR,CAAcC,KAAd,CAAoB/E,OAApB,EAA6BuE,IAA7B;AACD;;AAED,WAAShF,IAAT,CAAcyF,GAAd,EAAmBC,MAAnB,EAA2B;AACzB,QAAIC,OAAOC,OAAOD,IAAP,CAAYD,MAAZ,CAAX;AACA,SAAI,IAAIG,IAAE,CAAV,EAAaA,IAAEJ,IAAIrD,MAAnB,EAA2ByD,GAA3B,EAAgC;AAC9B,UAAIvD,OAAOmD,IAAII,CAAJ,CAAX;AACA,UAAIC,WAAW,IAAf;AACA,WAAI,IAAIC,IAAE,CAAV,EAAaA,IAAEJ,KAAKvD,MAApB,EAA4B2D,GAA5B,EAAiC;AAC/B,YAAIC,MAAML,KAAKI,CAAL,CAAV;AACA,YAAGzD,KAAK0D,GAAL,MAAcN,OAAOM,GAAP,CAAjB,EAA8B;AAC5BF,qBAAW,KAAX;AACA;AACD;AACF;AACD,UAAGA,QAAH,EAAa;AACX,eAAOxD,IAAP;AACD;AACF;;AAED,WAAO,IAAP;AACD;AACF;;AAED,IAAGuC,MAAH,EAAWA,OAAOxI,WAAP,GAAqBA,WAArB;AACX4J,OAAOC,OAAP,GAAiB7J,WAAjB","file":"index.js","sourcesContent":["/*\n * 评测组件集成版\n *\n * 组件包含了录音和评测两个主要的功能\n */\nvar states = require('./states')\nvar filepush = require('fe-filepush').default\n\nvar EvaluaterCore = require('evaluater-core-vkm')\nvar AudioRecorder = require('audio-recorder-vkm')\nvar coreStates = {\n  NOT_READY: 1,\n  CONNECTING: 2,\n  PREPARE_START: 3,\n  WAITING_AUDIO_STREAM: 4,\n  RESULT_RECEIVING: 5,\n  RESULT_RECEIVED: 6,\n  CLOSED: 7\n}\n\nfunction VKEvaluater(options) {\n  var env = options.env\n  apiUrlMap = {\n    test: 'https://a66-ecp.vipkid-qa.com.cn/iscp/api/v1',\n    pre: 'https://pre-ecp.vipkid.com.cn/iscp/api/v1',\n    prod: 'https://wss.vipkid.com.cn/iscp/api/v1'\n  }\n\n  var appId = options.appId\n  var _errorCb = options.onError\n  var _stateCb = options.onState\n  var _audioUploadingList = []\n  var _audioUploadedList = []\n  var _resultList = []\n  // 音频数据上传的标识，为减少对业务端的影响，目前是队列上传，即每次只有一个音频在上传。\n  var _audioUploading = false\n  // 评测结果是否仍在处理中的标识\n  // 主要用于结果中无audioUrl的情况，需要有上传到cdn的等待过程\n  var _resultDealing = false\n  var _currId = null\n  var _currAudioBlob = null\n  var apiUrl = apiUrlMap[env || 'prod']\n\n  // TODO 检查初始化参数\n\n  // this.init = init\n  this.start = start\n  this.stop = stop\n  this.close = close\n  this.state = states.NOT_READY\n\n  var that = this\n\n  var evaluater\n  that.recorder = new AudioRecorder()\n\n  // 自动执行初始化操作\n  init()\n\n  // 初始化\n  function init() {\n    // 初始化录音组件\n    that.recorder.init(function(err) {\n      if(err) {\n        _throwError(err, {recorder: true})\n      } else {\n        // 初始化评测核心组件\n        evaluater = new EvaluaterCore({\n          appId: appId,\n          env: env,\n          onState: _evaluaterStateChange,\n          onError: _evaluaterError,\n        })\n      }\n    })\n\n    // 绑定录音回调函数\n    that.recorder.onRecording(function(stream) {\n      if(!_checkCondition('sendAudioStream')) return\n\n      evaluater.sendAudioStream(stream)\n    })\n    that.recorder.exportBlob(function(blob) {\n      _currAudioBlob = blob\n      _audioUploadingList.push({ id: _currId, audioBlob: blob })\n      _startAudioUpload()\n    })\n  }\n\n  // 开始评测\n  function start(info) {\n    if(!_checkCondition('start')) return\n\n    // 发送评测文本信息\n    evaluater.sendAudioInfo(info)\n\n    // 开始录音\n    that.recorder.start()\n    // _updateState(states.START_AUDIO_RECORD)\n    _updateAndEmitState(states.AUDIO_RECORDING)\n\n    // TODO 增加录音超时判断\n    // Tip: 使用timeout\n  }\n\n  function stop() {\n    if(!_checkCondition('stop')) return\n\n    _currId = _generateUniqStr(16)\n\n    // 停止录音\n    that.recorder.stop()\n    evaluater.stop()\n  }\n\n  function close() {\n    if(that.state === states.NOT_READY || that.state === states.CLOSED) return\n    // 停止录音\n    that.recorder.stop()\n    evaluater.close()\n  }\n\n  function _evaluaterStateChange(newState) {\n    _log('*** EvaluaterCore state change:', newState)\n\n    switch(newState.code) {\n      case coreStates.NOT_READY:\n        _updateState(states.NOT_READY)\n        break\n      case coreStates.CONNECTING:\n        _updateAndEmitState(states.CONNECTING)\n        break\n      case coreStates.PREPARE_START:\n        if(!_resultDealing) {\n          _updateAndEmitState(states.PREPARE_START)\n        }\n        break\n      case coreStates.RESULT_RECEIVING:\n        _updateAndEmitState(states.RESULT_RECEIVING)\n        break\n      case coreStates.RESULT_RECEIVED:\n        var data = newState.data\n        var result = data.view\n        result.audioBlob = _currAudioBlob\n        // 评测结果中包含audioUrl，说明第三方返回了audioUrl，直接将结果返回给客户端\n        if(result.audioUrl) {\n          _updateAndEmitState(states.RESULT_RECEIVED, null, result)\n          evaluater.updateState(states.PREPARE_START);\n        } else {\n          _resultDealing = true\n        }\n        // 评测结果中无audioUrl，需要sdk先将audio上传至cdn，然后和结果一并返回给业务端\n        _resultList.push({ id: _currId, result: result, scoreId: data.scoreId })\n        _dealResult(_currId)\n        break\n      case coreStates.CLOSED:\n        _updateAndEmitState(states.CLOSED)\n        break\n    }\n  }\n\n  // 处理评测结果，主要在评测结果返回后，或者音频上传结束后触发\n  function _dealResult(id) {\n    var resultItem = find(_resultList, { id: id })\n    var audioItem = find(_audioUploadedList, { id: id })\n\n    if(!resultItem || !audioItem) return\n\n    var result = resultItem.result\n    // 处理评测结果中无第三方audioUrl的情况\n    // 即使用cdn的url代表第三方audioUrl，然后将结果返回给客户端\n    if(!result.audioUrl) {\n      result.audioUrl = audioItem.audioUrl\n      _updateAndEmitState(states.RESULT_RECEIVED, null, result)\n      \n      _resultDealing = false;\n      evaluater.updateState(states.PREPARE_START);\n    }\n\n    // 上报评测结果\n    var uploadResultInfo = { scoreId: resultItem.scoreId, audioUrl: audioItem.audioUrl }\n    _uploadEvaluateResult(uploadResultInfo, function() {})\n\n    // 清除已处理项\n    _resultList.splice(_resultList.indexOf(resultItem), 1)\n    _audioUploadedList.splice(_audioUploadedList.indexOf(audioItem), 1)\n  }\n\n  function _evaluaterError(err) {\n    _log('EvaluaterCore error:', err)\n\n    switch(err.code) {\n      case 1101:\n      case 1104:\n      case 1105:\n        _throwError(err, {recorder: true})\n\n        if([1104, 1105].indexOf(err.code) > -1) {\n          _uploadError(err)\n        }\n        break\n      case 1107:\n        _throwError(err, {recorder: true})\n        break\n      case 4001:\n      case 4002:\n      case 4003:\n        that.recorder.stop()\n        _throwError(err, {evaluater: true})\n        break\n      default:\n        _throwError(err, {recorder: true})\n        _log('evaluater core error: ', err)\n\n      // TODO 增加更多地错误判断，比如文本参数错误\n    }\n  }\n\n  function _checkCondition(stage) {\n    _log('stage: ', stage, ', state: ', that.state)\n\n    // 首先，检测init状态\n    if(that.state === states.NOT_READY) {\n      throw new Error('[VKEvaluater] The server not ready.')\n    }\n    if(that.state === states.CONNECTING) {\n      throw new Error('[VKEvaluater] The server still in connecting.')\n    }\n    // if(that.state === states.CANCELING) {\n    //   throw new Error('[VKEvaluaterCore] In canceling, please waiting for cancel finished.')\n    // }\n    if(that.state === states.CLOSED) {\n      throw new Error('[VKEvaluaterCore] The server already closed. Please re-init it before use it agiain.')\n    }\n\n    if(stage === 'start' && that.state !== states.PREPARE_START) {\n      throw new Error('[VKEvaluater] Start must be called after evaluater prepared.')\n    }\n    if(stage === 'stop' && that.state !== states.AUDIO_RECORDING) {\n      console.warn('[VKEvaluater] Stop must be called after evaluater.start().')\n      return false\n    }\n\n    return true\n  }\n\n  function _throwError(type, options) {\n    var recorderErrMap = {\n      902001: 'recordNotSupport',\n    }\n\n    var evaluaterErrMap = {\n      1101: 'evaluateNotSupport',\n      1104: 'cannotConnect',\n      1105: 'connectTimeout',\n      1107: 'authFial',\n      4001: 'audioInfoInvalid',\n      4002: 'evaluateFail',\n      4003: 'evaluateTimeout',\n      1000: 'unknown'\n    }\n\n    var message = options && options.message\n\n    // 将audioRecorder的error转换成自身的error\n    if(options && options.recorder === true) {\n      message = type.message\n      type = recorderErrMap[type.code]\n    }\n    // 将evaluater的error转换成自身的error\n    if(options && options.evaluater === true) {\n      message = type.message\n      type = evaluaterErrMap[type.code]\n    }\n\n    var map = {\n      'evaluateNotSupport': { code: 1101, message: message || 'evaluate not supported' },\n      'recordNotSupport': { code: 1102, message: message || 'record not supported' },\n      'recordPermissionDeny': { code: 1103, message: message || 'record permission deny' },\n      'cannotConnect': { code: 1104, message: 'server cannot connect' },\n      'connectTimeout': { code: 1105, message: 'connect timeout' },\n      'networkAnomaly': { code: 1106, message: 'network anomaly' },\n      'authFial': { code: 1107, message: 'appId invalid' },\n\n      /* 其他异常错误 */\n      'audioInfoInvalid': { code: 4001, message: message || 'audio info invalid' },\n      'evaluateFail': { code: 4002, message: message || 'evaluate failed' },\n      'evaluateTimeout': { code: 4003, message: message || 'evaluate timeout' },\n      'unknown': { code: 1000, message: 'unknown error' },\n    }\n\n    var err = map[type]\n    if(err) err.message = message || err.message\n\n    _errorCb(err || map.unknown)\n  }\n\n  function _updateState(newState) {\n    that.state = newState\n  }\n\n  function _updateAndEmitState(newState, message, data) {\n    _updateState(newState)\n\n    _stateCb({code: newState, message: message, data: data})\n  }\n\n  // 上传音频文件至CDN\n  function _uploadAudio(audioBlob, cb) {\n    // 忽略本地测试环境\n    if(location.hostname === 'localhost') {\n      _log('localhost环境下，上传CDN会涉及跨域，所以跳过上传')\n      return cb(null, 'https://media.vipkidstatic.com/speechcloud/audio/3fccefb4632daaf9.wav')\n    }\n\n    var filename = _generateUniqStr(16)\n    var file = new File([audioBlob], filename + '.wav', {type: 'audio/wav', lastModified: Date.now()})\n\n    var upload = new filepush({\n      accessKey: '8572e0430fce035c',\n      secretKey: '07c84c233bee4e23bac60b38b4cc675a',\n      client: 'speechcloud',\n      path: 'speechcloud/audio/'\n    })\n\n    upload.addfiles(file)\n    upload.submit(function(err, data) {\n      if(err) {\n        cb(err)\n      } else {\n        cb(null, data.objects[0].url)\n      }\n    }, function() {\n      // _log(file, progressEvent)\n    })\n  }\n\n  function _startAudioUpload() {\n    if(_audioUploading) return\n\n    if(_audioUploadingList.length === 0) return\n\n    _audioUploading = true\n\n    var once = function() {\n      item = _audioUploadingList.shift()\n\n      // 已无待上传音频\n      if(!item) {\n        _audioUploading = false\n        return\n      }\n\n      _uploadAudio(item.audioBlob, function(err, audioUrl) {\n        if(err) _log('upload audio fail', err)\n\n        item.audioUrl = audioUrl || null\n        _audioUploadedList.push(item)\n        _dealResult(item.id)\n\n        once()\n      })\n    }\n\n    once()\n  }\n\n  // 上报请求及结果信息\n  function _uploadEvaluateResult(item, cb) {\n    _myAjax({\n      url: apiUrl + '/result/save',\n      type: 'post',\n      data: {\n        userId: options.userId || '', //新增 用来获取用户数据\n        appId: appId,\n        scoreId: item.scoreId,\n        audioUrl: item.audioUrl,\n        deviceInfo: JSON.stringify(_getDeviceInfo())\n      },\n      success: function() {\n        cb && cb()\n        _log('upload evaluate result success')\n      },\n      error: function(err) {\n        cb && cb()\n        _log('send evaluate result fail: ', err)\n      }\n    })\n  }\n\n  // 上报错误信息\n  function _uploadError(err) {\n    _myAjax({\n      url: apiUrl + '/abnormal/report',\n      type: 'post',\n      data: {\n        appId: appId,\n        code: '50001',\n        description: JSON.stringify({\n          userId: options.userId || '', //新增 用来获取用户数据\n          message: err.message,\n          time: new Date().getTime(),\n          // TODO add device info\n          deviceInfo: JSON.stringify(_getDeviceInfo()),\n          serverVersion: 'v2'\n        })\n      },\n      success: function() {\n        _log('upload error success')\n      },\n      error: function(err) {\n        _log('upload error fail: ', err)\n      }\n    })\n  }\n\n  function _myAjax(settings) {\n    settings.success = settings.success || function() {}\n    settings.error = settings.error || function() {}\n\n    var xhr = new XMLHttpRequest();\n    var hasError = false\n\n    xhr.onerror = function(err) {\n      _log('xhr err:', err)\n      hasError = true\n    }\n\n    xhr.onloadend = function() {\n      if(hasError) {\n        settings.error('cannot connect server')\n      } else {\n        // deal unexpected error\n        if(xhr.status === 404) {\n          settings.error('server error(404 not found)')\n          return\n        }\n\n        // deal JSON.parse error\n        var res\n        try {\n          res = JSON.parse(xhr.responseText)\n        } catch (e) {\n          return settings.error('response format error');\n        }\n\n        if(xhr.status === 200) {\n          settings.success(res.data);\n        } else if(xhr.status === 400) {\n          settings.error(res.message);\n        }\n      }\n    }\n\n    xhr.open(settings.type || 'get', settings.url, true);\n\n    if(settings.type === 'post' && settings.data) {\n      xhr.setRequestHeader(\"Content-Type\",\"application/json; charset=utf-8\");\n      xhr.send(JSON.stringify(settings.data));\n    } else {\n      xhr.send();\n    }\n  }\n\n  function _getDeviceInfo() {\n    return {\n      userAgent: navigator.userAgent,\n      vendor: navigator.vendor,\n      platform: navigator.platform,\n      appName: navigator.appName\n    }\n  }\n\n  function _generateUniqStr(length) {\n    var str = ''\n    length = length || 32\n    while (length--) {\n      str += (Math.random() * 16 | 0) % 2 ? (Math.random() * 16 | 0).toString(16)\n        : (Math.random() * 16 | 0).toString(16).toUpperCase()\n    }\n    return str.toLowerCase()\n  }\n\n  function _log() {\n    if(!((window._vkm_debug === true) || (window._vkm_evaluate_debug === true))) return\n\n    var args = Array.prototype.slice.call(arguments)\n    // args.unshift(new Date().toLocaleString())\n    args.unshift('Evaluater:')\n    console.debug.apply(console, args)\n  }\n\n  function find(arr, params) {\n    var keys = Object.keys(params)\n    for(var i=0; i<arr.length; i++) {\n      var item = arr[i]\n      var allMatch = true\n      for(var j=0; j<keys.length; j++) {\n        var key = keys[j]\n        if(item[key] !== params[key]) {\n          allMatch = false\n          break\n        }\n      }\n      if(allMatch) {\n        return item\n      }\n    }\n\n    return null\n  }\n}\n\nif(window) window.VKEvaluater = VKEvaluater\nmodule.exports = VKEvaluater\n"]}