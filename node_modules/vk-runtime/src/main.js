//引入本地配置文件
import vf2e from '../vf2e.config'
const isDev = vf2e.env_isDev

import app from './app.vue'
import VueRouter from 'vue-router'
import routes from './router-config.js'
import utils from './utils/_untils'
import cookies from 'cookies-js'
import Vue from 'vue'
import clickSound from './assets/sound/click_sound.wav'
import dragonUtils from './utils/_dragon.js'
import Raven from 'raven-js'
import RavenVue from 'raven-js/plugins/vue'

/* 添加全局组件--start */
import overVideo from './pages/project_demo/components/video_box.vue'
import netError from './pages/project_demo/components/net_error.vue'
import TopPart from './pages/common/top_part.vue'
import arrow from './pages/common/arrow.vue'
import dialog from './pages/common/vk_dialog.vue'
Vue.component("videoBox", overVideo)
Vue.component("netError", netError)
Vue.component("TopPart", TopPart)
Vue.component("arrow", arrow)
Vue.component("lcDialog", dialog)
/* 添加全局组件--end */

/* 全局注册指令--start */
import model from "./pages/common/plugins/Model"
Vue.use(model)
import vkToast from './pages/common/plugins/Toast'
Vue.use(vkToast)
//加载图片错误组件
import ErrorImg from './pages/common/plugins/ErrorImg'
Vue.use(ErrorImg)
//添加全局插件sound 注入click声音
import Sound from './pages/common/plugins/Sound'
/*soundResources变量为cdn地址时为了解决子模块播放声音问题（vk-runtime打包问题）*/
const soundResources = isDev?'https://s.vipkidstatic.com/fe-static/lc/learningcenter/click_sound-1108.wav':clickSound
Vue.use(Sound, [
  {name: "click", path: soundResources}
])
/* 全局注册指令--end */

const match = navigator.userAgent.toLowerCase().match(/vipkid\/(\d+.\d+.\d+)/)
const uaVer = match ? match[1] : null

// 打点需要的设备版本号
let deviceVer = 'browser'
if (dragonUtils.isOnDragonClient()) {
  // PCAPP
  deviceVer ="PCAPP_" + uaVer
} else if (cookies.get('isFromApp')) {
  //IPAD
  let ipadVer = utils.getAppVersion()
  deviceVer = "IPAD_" + ipadVer
}else{
  // WEB
  deviceVer = 'browser'
}

Vue.prototype.IS_IN_IPAD_APP = cookies.get('isFromApp')
Vue.use(VueRouter)

const router = new VueRouter({
  routes,
  mode: 'history',
  saveScrollPosition: true
})

/* eslint-disable */
/***************** 增量添加 平台拆分 代码 start*/
import './lib/log.config.js'
import './lib/sensorsdata.min.js'
import './lib/session.js'
import './lib/polyfill.min.js'

//import i18n from './runtime/i18n'
import { _push } from './runtime/routerRecord'
import moduleList from './runtime/moduleList'
import { loadModule } from './runtime/loader'

import runtime from './runtime/vk-runtime'

runtime({
  router, 
  //i18n, 
  utils, 
  cookies
})

let routerMap = []
if(isDev){
  routerMap = moduleList.dev
}else{
  routerMap = moduleList.prod
}


/*************** 增量添加 平台拆分 代码 end */
/* eslint-enable */

router.beforeEach((to, from, next) => {
  /* eslint-disable */
  /*************** 增量添加 平台拆分 代码 start */
    const toPath = to.path.replace(/(.*)\?.*/,'$1').replace(/\/([^\/]*).*/,'$1')

    if(!isDev){
      if(routerMap[toPath]){
        console.log(`加载${toPath}开始`)
        loadModule(routerMap[toPath], toPath).then((info)=>{
          console.log(info)
          console.log(`加载${toPath}结束`)
        })
      }
    }
    
    _push(to.fullPath)    
  /*************** 增量添加 平台拆分 代码 end */
  /* eslint-enable */
  let referrer = from.fullPath === '/' ? document.referrer : location.href

  if (to.matched) {
    for (let route of routes) {
      if (to.matched.length != 0 && to.matched[0].path === route.path) {
        //防范在url地址上的XSS攻击
        if (utils.xssCheck(to.path)) {
          window.location.href = "/403"
          return
        }
        document.title = route.title || 'VIPKID学习中心 - VIPKID在线少儿英语'
        break
      } else {
        document.title = 'VIPKID学习中心 - VIPKID在线少儿英语'
      }
    }
    next()
  }

  if(to.matched.length === 0){
    if(routerMap[toPath]){
      next()
    }else{
      next('/404')
    }
  }

  //next()
  //打点代码应放在next()执行后面，next为堆栈形式
  sa.register({
    product: 'student_learning',
    parent_id: cookies.get('parentId') || '',
    student_id: cookies.get('studentId') || '',
    vk_session_id: cookies.get('vk_session_id'),
    client: deviceVer,
    $referrer: referrer,
    $url: location.href,
    $url_path: location.pathname,
    $title: document.title,
    $browser_language: navigator.language
  })
  sa.track('$pageview')
})

var _vkForEach = function (fun, con) {
  var len = this.length
  var con = arguments[1]
  if (typeof fun !== "function") {
    throw fun + " is not a function!"
  }
  for (var i = 0; i < len; i++) {
    fun.call(con, this[i], i, this)
  }
}
Array.prototype.vkForEach = _vkForEach
NodeList.prototype.vkForEach = _vkForEach

window.eventBus = new Vue()

window.Vm = new Vue({
  router,
  el: '#app',
  render: h => h(app)
})

if(!isDev){
  Raven.config('https://a9050b351ab145e0a64961567e80db30@sentry.vipkid.com.cn/188')
  .addPlugin(RavenVue, Vue)
  .install()
}
