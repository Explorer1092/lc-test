import axios from 'oaxios'
const cookies = require('cookies-js')
axios.interceptors.request.use(function (config) {
  let cookieAuth = cookies.get('Authorization')
  let cookie_session = cookies.get('vk_session_id')
  if (cookie_session) {
    config.headers['vk-session-id'] = cookie_session
  }
  if (!config.headers.hasOwnProperty('Authorization') && cookieAuth) {
    config.headers['Authorization'] = cookieAuth.replace(/\"/g, '')
    if (config.params) {
      config.params.v = Math.random()
    }
  } else {
    window.location.href = 'https://' + window.location.host.replace(/lc/, 'www') + '/login'
  }
  return config
})

axios.interceptors.response.use(response => {
  if (response.headers['vk-mvp-url']) {
    location.href = response.headers['vk-mvp-url']
  }
  return response
}, err => {
  let res = err.response
  if (res.status === 401) {
    if (navigator.userAgent.toLowerCase().match(/vipkid/i)) {
      window.__bridge.logout() //小恐龙退出登录
    } else {
      window.location.href = 'https://' + window.location.host.replace(/lc/, 'www') + '/login'
    }
  }
  if (err.response.data) {
    //记录错误日志
    sa.track('learning_click', {
      'error_url': err.config.url,
      'error_msg': JSON.stringify(err.response.data)
    })
  }
  return Promise.reject(err)
})

export default axios
