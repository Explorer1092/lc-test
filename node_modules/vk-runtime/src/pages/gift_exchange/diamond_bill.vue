<template lang="jade">
.gift-wrapper
  vkDialog(v-show="alertDialog", @rightBtnEvent="closeDialog", :title="alertTitle", :contentText="alertContent")
  fullPageLoading(v-if="isFullPageLoadingShow")
  top-part(:title_cn="title_chinese", :title_eng="title_english", :isAbsoluteFix="true")
  .user-guide-mask(v-if="isShowUserGuideMask")
  .main-container
    .filter-container
      .filter-item.margin-right(@click="switchToGainList", :class="{active: gainListShow}") 获得
      .filter-item(@click="switchToPayList", :class="{active: payListShow}") 支出
    .balance-container
      img(src="../../img/gift/green-diamond.png")
      span.balance-num {{studentDiamond}}
    .list-container
      .gain-list-contaier(v-show="gainListShow")
        .normal-list-hold(v-if="gainList.length > 0")
          .list-box
            .list-item.gain-list-item(v-for="(item, index) in gainList")
              .list-item-header
                .list-item-student(v-show="item.source=='STUDENT'")
                .list-item-parent(v-show="item.source=='PARENT'")
              span.time {{ getDate( item.createDateTime ) }}
              slide-text.name(:text="item.description")
              .gain-number.clearfix
                img(src="../../img/gift/green-diamond.png")
                span +{{item.changeCount}}
          gainListPager(:totalPage = "gainListTotalPage", @jumpToPageEvent = "getGainDiamondFlow")
        .none-list-hold(v-else)
          img.none-img(src="../../img/gift/empty@2x.png")
          p 暂时没有记录～
        
      .pay-list-contaier(v-show="payListShow")
        .normal-list-hold(v-if="orderList.length > 0")
          .list-box
            .list-item.pay-list-item(v-for="(item, index) in orderList")
              img.pay-list-img(:src="item.eshopGoods[0].imgUrl", @error="loadingImageError")
              .goods-info-box
                .goods-name {{item.eshopGoods[0].name}}
                .goods-qty 数量： {{item.eshopGoods[0].count}}
              .split-line
              .bill-info-box
                .bill-time {{getDate(item.createDateTime)}}
                .bill-number 订单号：{{item.orderCode}}
                .bill-state-box
                  template(v-if="item.status == 'CONFIRMED' && item.orderType == 'PET_MANURE'")
                    span.bill-state 已签收
                  template(v-if="item.status == 'TO_BE_CONFIRMED'")
                    span.bill-state 待确认
                    span.bill-describe 还差一步，快让爸爸妈妈在手机上确认订单吧~
                  template(v-if="item.status == 'CANCEL' && item.orderType == 'REAL'")
                    span.bill-state.red 已取消
                    span.bill-describe 宝贝您的兑换礼品被爸爸妈妈取消了
                  template(v-if="item.status == 'WAIT_FOR_RECEIVING' && item.orderType == 'REAL'")
                    span.bill-state 待收货
                    span.bill-describe 亲爱的宝贝，你的礼物已经在路上啦~
                  template(v-if="item.status == 'CONFIRMED' && item.orderType == 'REAL'")
                    span.bill-state 已确认/待发货
                    span.bill-describe 礼物将在7-15个工作日内为您寄出。
                  template(v-if="item.status == 'DELIVERED' && item.orderType == 'REAL'")
                    span.bill-state 已发货
                  template(v-if="item.status == 'DELIVERING' && item.orderType == 'REAL'")
                    span.bill-state 发货中
                  template(v-if="item.status == 'FAILED'")
                    span.bill-state.red  兑换失败
                    span.bill-describe 订单信息有异常，兑换失败
                  template(v-if="item.status == 'RECEIVED'")
                    span.bill-state 已签收
                    span.bill-describe 礼物已经签收啦，继续赚取能量石来兑换更多礼物吧~
                  template(v-if="item.status == 'CANCEL' && (item.orderType == 'COURSE' || item.orderType == 'QUALITY_OPEN_COURSE' )")
                    span.bill-state.red 已取消
                    span.bill-describe /(ㄒoㄒ)/~~订单已经被爸爸妈妈取消了！
                  template(v-if="item.status == 'CONFIRMED' && (item.orderType == 'COURSE' || item.orderType == 'QUALITY_OPEN_COURSE')")
                    span.bill-state 已确认 
                    span.bill-describe 将于24小时内充值入账户
                  template(v-if="item.status == 'DELIVERED' && (item.orderType == 'COURSE' || item.orderType == 'QUALITY_OPEN_COURSE' )")
                    span.bill-state 兑换成功
                  template(v-if="item.status == 'INVALIDATION'")
                    span.bill-state.red 已失效
                    span.bill-describe 爸爸妈妈十天未确认订单，订单已自动失效
              .bill-cost.clearfix
                img(src="../../img/gift/green-diamond.png")
                span -{{item.eshopGoods[0].eggshellNumber * item.eshopGoods[0].count}}
          orderListPager(:totalPage = "orderListTotalPage", @jumpToPageEvent = "getOrderListByPageNum")
        .none-list-hold(v-else)
          img.none-img(src="../../img/gift/empty@2x.png")
          p 暂时没有记录～        
    img.hiddenDom(src="../../img/gift/gift_not_load.png", v-show="false", ref="defaultImg")
        
</template>
<style lang="stylus" scoped>
  *
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    -webkit-touch-callout: none
  .clearfix:before, .clearfix:after
    display:table
    content:""
  .clearfix:after
     clear:both
  .hiddenDom
    width: 0
    height: 0
    display: none
  .gift-wrapper
    width: 100%
    height: 100%
    position: relative
    background-image url('../../img/bg-star-1.png')
    .user-guide-mask
      width: 100%
      height: 100%
      position: fixed
      top: 0
      left: 0
      right: 0
      bottom: 0
      background: #000
      opacity: 0.6
      z-index: 10
    .diamond-entry-container
      position: absolute
      top: 30px
      right: 46px
      z-index: 9
      .diamond-entry-button
        width: 124px
        height: 46px
        line-height: 46px
        border-radius: 100px
        background-color: rgba(255,255,255,0.2)
        color: #ffffff
        padding: 0 0 0 51px
        box-sizing: border-box
        cursor: pointer
        &:hover
          background-color: rgba(255,255,255,0.4)
        img
          width: 36px
          height: 36px
          float: left
          position: absolute
          top: 4px
          left: 9px
        span
          float: left
    .main-container
      width: 940px
      height: 550px
      position: absolute
      display: inline-block
      top: 50%
      left: 50%
      margin: -239px 0 0 -470px
      .balance-container
        position: absolute
        top: -8px
        right: 0
        color: #ffffff
        img
          width: 36px
          height: 36px
          position: relative
          top: 10px
        .balance-num
          font-size: 25px
          color: #39f6f3
          font-weight: bold
      .filter-container
        min-width: 261px
        border-radius: 100px
        background-color: rgba(0, 0, 0, 0.2)
        display: inline-block
        box-sizing: border-box
        font-size: 18px
        padding: 7px 7px
        .filter-item
          width: 120px
          height: 26px
          line-height: 26px
          font-size: 18px
          position: relative
          color: #ffffff
          background-color: rgba(225, 225, 225, 0.2)
          box-sizing: border-box
          border-radius: 100px
          float: left
          cursor: pointer
          text-align: center
          &:hover
            background-color: rgba(225, 225, 225, 0.4)
          &.active
            background-color: #a061fd
          &.margin-right
            margin: 0 7px 0 0
        .diamond-icon
          width: 26px
          height: 26px
          float: left
        span
          float: left
          line-height: 26px
      .list-container
        margin: 20px -20px 20px 0
        .gain-list-contaier, .pay-list-contaier
          .none-list-hold
            height: 446px
            position: relative
            text-align: center
            margin: 40px 0 0 0
            img.none-img
              width: 280px
              height: 280px
              margin-bottom: 20px
            p
              color: #b396ff
              font-size: 26px

          .normal-list-hold
            .list-box
              height: 446px
            .list-item
              position relative
              width: 940px
              margin:  10px 0 10px 0
              background-size: 100% 100%
              background-repeat: no-repeat
              display: block
              position: relative
              color: white
              font-size: 16px
              box-sizing: border-box
              &.gain-list-item
                position relative
                background-image: url(../../img/gift/bg-list-in.png)
                height: 60px
                padding: 0 0 0 69px
                .time
                  height: 60px
                  line-height: 60px
                  display: inline-block
                  vertical-align: middle
                  margin-right: 54px
                .name
                  max-width: 500px
                  white-space: nowrap
                  display: inline-block
                  vertical-align: middle
                  line-height: 60px
                  margin-right: 107px
                .gain-number
                  position absolute
                  left 794px
                  display: inline-block
                  vertical-align: middle
                  img
                    width: 26px
                    height: 26px
                    float: left
                    padding: 19px 0 0 0
                  span
                    float: left
                    line-height: 60px
                    font-size: 20px
                    font-weight: bold
              .list-item-header
                 position absolute
                 left 0px
                 width 64px
                 height 60px 
                 background url(../../img/gift/diamond_bill_list_header@2x.png) no-repeat
                 background-size 64px auto
              &.pay-list-item
                background-image: url(../../img/gift/bg-list-out.png)
                height: 130px
                .pay-list-img
                  width: 110px
                  height: 110px
                  position: absolute
                  top: 10px
                  left: 35px
                  margin-right: 20px
                .goods-info-box
                  display: inline-block
                  margin: 20px 0 0 165px
                  color: #ffffff
                  .goods-name
                    font-size: 16px
                    line-height: 1.3em
                    font-weight: 400
                    width: 135px
                    height: 59px
                    margin-bottom: 12px
                    overflow: hidden
                    word-break: break-all
                    -moz-user-select: text;
                    -webkit-user-select: text;
                    -ms-user-select: text;
                    -khtml-user-select: text;
                    user-select: text;
                    -webkit-font-smoothing: antialiased;
                    -webkit-touch-callout: default;
                  .goods-qty
                    font-size: 14px
                    width: 135px
                    height: 16px
                    line-height: 16px
                .split-line
                  width: 5px
                  height: 80px
                  border-radius: 100px
                  background-color: #8561ed
                  position: absolute
                  top: 25px
                  left: 315px
                .bill-info-box
                  position: absolute
                  margin: 0 0 0 20px
                  left: 320px
                  top: 20px
                  font-size: 16px
                  color: #ffffff
                  .bill-time
                    margin: 0 0 11px 0
                  .bill-number
                    margin: 0 0 12px 0
                    -moz-user-select: text;
                    -webkit-user-select: text;
                    -ms-user-select: text;
                    -khtml-user-select: text;
                    user-select: text;
                    -webkit-touch-callout:default ;
                  .bill-state-box
                    .bill-state
                      margin: 0 20px 0 0
                      &.red
                        color: #ff6600
                    .bill-describe
                      color: #b6aec3
                .bill-cost
                  display: inline-block
                  vertical-align: middle
                  position: absolute
                  top: 33px
                  right: 33px
                  width: 100px
                  img
                    width: 26px
                    height: 26px
                    float: left
                    padding: 17px 0 0 0
                  span
                    float: left
                    line-height: 60px
                    font-size: 20px
                    font-weight: bold

/*增加的样式，样式后代子元素过多，会影响性能的*/
.list-item-student
   position absolute
   left 16px 
   top 16px
   width 28px
   height 28px 
   background url(../../img/gift/diamond_bill_list_kid@2x.png) no-repeat
   background-size 28px auto;
.list-item-parent  
   position absolute
   left 15px 
   top 16px
   width 28px
   height 28px 
   background url(../../img/gift/diamond_bill_list_parent@2x.png) no-repeat
   background-size 28px auto; 
      

</style>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import utils from '../../utils/_untils.js'
  import TopPart from '../common/top_part.vue'
  import fullPageLoading from "../common/vk_turn_page_loading.vue"
  import slideText from '../common/vk_slide_text.vue'
  import orderListPager from '../common/vk_pager.vue'
  import gainListPager from '../common/vk_pager.vue'
  import vkDialog from '../common/vk_dialog.vue'
  export default {
    data() {
      return {
        title_chinese: '能量石记录',
        title_english: 'Rewards Records',
        isShowUserGuideMask: false,
        isFullPageLoadingShow: false,
        gainListShow: true,
        payListShow: false,
        totalPage: 1,
        orderList: [],
        gainList: [],
        studentDiamond: '',
        timeouts: [],
        orderListTotalPage: 1,
        gainListTotalPage: 1,
        alertDialog: false,
        alertTitle: '',
        alertContent: '',
        testI: 0
      }
    },
    props: [],
    mounted() {
      this.getOrderListByPageNum( 1 )
      this.getGainDiamondFlow( 1 )
      this.getStudentDiamonds()
    },
    computed: {
    },
    methods: {
      loadingImageError(e) {
        e.target.src = this.$refs.defaultImg.src
      },
      networkFailedAlert() {
        this.alertTitle = 'sorry!'
        this.alertContent = '网络异常！'
        this.alertDialog = true
        this.isShowUserGuideMask = true
        this.isFullPageLoadingShow = false
      },
      closeDialog() {
        this.alertDialog = false
        this.isShowUserGuideMask = false
      },
      getDate( ts ) {
        return utils.formatDate(ts, false) 
      },
      switchToGainList() {
        this.gainListShow = true
        this.payListShow = false
        this.currListType = 1
      },
      switchToPayList() {
        this.gainListShow = false
        this.payListShow = true
        this.currListType = 2
      },
      getOrderListByPageNum( pageNum ) {
        this.isFullPageLoadingShow = true
        
        axios.get('/rest/learninggw/api/pc/eshop/order/findPageEshopOrder', {
          params: {
            studentId: cookies.get('studentId'),
            limit: 3,
            start: pageNum
          }
        })
          .then((res) => {
            if( res.data.code == 200 && res.data.data ) {
              this.orderList = res.data.data.data
              this.orderListTotalPage = res.data.data.totalPages
              this.isFullPageLoadingShow = false
            } else {
              this.orderList = 0
            }
          })
          .catch((err) => {
            this.networkFailedAlert()
          })
      },
      getGainDiamondFlow( pageNum ) {
        this.isFullPageLoadingShow = true
        
        axios.get('/rest/learninggw/api/pc/magic/eggshell/findPageEggshellChangeLog', {
          params: {
            studentId: cookies.get('studentId'),
            type: 'INCREASE',
            start: pageNum,
            limit: 6
          }
        })
          .then((res) => {
            if( res.data.code == 200 && res.data.data ) {
              this.gainList = res.data.data.data
              this.gainListTotalPage = res.data.data.totalPages
              this.isFullPageLoadingShow = false
            } else {
              this.orderList = 0
            }
          })
          .catch((err) => {
            this.networkFailedAlert()
          })
      },
      getStudentDiamonds() {
        axios.get('/rest/learninggw/api/pc/magic/eggshell/getByStudentId', {
          params: {
            studentId: cookies.get('studentId')
          }
        })
          .then((res) => {
            this.studentDiamond = res.data.data.availableNumber
          })
      }
    },
    components: {
      TopPart,
      fullPageLoading,
      slideText,
      orderListPager,
      gainListPager,
      vkDialog
    }
  }
</script>
