<template lang="jade">
  .pre-record-layer(v-bind:class="{'pre-record-layer-full-screen':isFullScreen}")
    .pre-record-content(id="aiPanel" class="aiPanel")
       .pre-record-start-video(class="record")
         .pre-record-start-content(v-show="isRecordStart",@click="startRecord")
           .pre-record-start-img
           .pre-record-start-trip
           p 点击开始录音
         .pre-record-process-content(v-show="isRecording",@click="endRecord")
            svg(
               width="166"
               height="166"
               viewbox="0 0 166 166"
            )
              circle(cx="83" cy="83" r="70" stroke-width="18" stroke="rgba(255,182,0,0.1)" fill="none")
              circle(cx="83" cy="83" r="70" stroke-width="18" stroke="rgba(255,182,0,0.8)"
                  transform="matrix(0,-1,1,0,0,166)"
                  stroke-dasharray="0 1069"
                  fill="none"
                  ref="circle"
              )
            .pre-record-middle
            .pre-record-shock
            p 点击结束录音
       .pre-score-view(v-show="scoreView")     
          img(class="pre-score-img bounceIn animated", :src="scoreImg" v-if="scoreViewSuccess" )
          img(class="bounceIn animate pre-error" v-if="scoreViewFailed" src="../../../img/video/pre-video-network-error@2x.png")
          .text(v-if= "scoreViewFailed" ) 出错了～重新录一遍吧～
          .pre-recodrd-part-content
             .pre-record-replay-button(
                class="replay"
                v-bind:class="{'pre-record-replay-full-screen-button':isFullScreen,'replayOff':!audioPlaying,'replayOn':audioPlaying}"
                v-show= "scoreViewSuccess"
                @click= "audioPlyaToggle"
             )
                p(class="pre-start-play-record-trips") 播放录音
                p(class="pre-pause-play-record-trips") 停止回放
             .pre-record-replay-button-error(
                v-show = "scoreViewFailed"
                v-bind:class="{'pre-record-replay-full-screen-button-error':isFullScreen}"
             )
                p(class="pre-start-play-record-trips") 播放录音
             .pre-record-rerecord-button(
               v-bind:class="{'pre-record-rerecord-full-screen-button':isFullScreen}"
               @click="recordAgain"
             ) 
                p 重新录音
             .pre-record-start-play-button(
                @click="continuePlay"
                v-bind:class="{'pre-record-start-play-full-screen-button':isFullScreen}"
             )
                p 继续观看
          audio.record-player(ref="recordAudio", :src="audioUrl", @ended="onAudioPlayEnd")
    .pre-record-no-record-button(
      v-show="isRecordStart"
      v-bind:class="{'pre-record-no-record-button-full-screen':isFullScreen}",
      @click="stopRecord"
    )  不想录音, 跳过 
      span 
    .dialogBody
      #recorder
</template>
<script>
import VVOS from "vvos-js"
import axios from 'axios'
import cookie from "cookies-js"
import VKEvaluater from 'evaluater-vkm'
const getTokenUrl = location.protocol + "//"+ location.host + "/rest/learninggw/api/pc/material/preClassVideo/getToken"
const callBackUrl = location.protocol + "//"+ location.host + "/rest/learninggw/api/pc/material/preClassVideo/uploadCallBack"
// 实例状态
const states = {
  NOT_READY: 1, // 未就绪
  CONNECTING: 2, // 连接中
  PREPARE_START: 3, // 已就绪
  AUDIO_RECORDING: 4, // 录音中
  RESULT_RECEIVING: 5, // 评测结果获取中
  RESULT_RECEIVED: 6, // 已获得评测结果(时刻)
  CLOSED: 7, // 服务已关闭
  INTERRUPTED: 8 // 录音被打断(来电、权限更改、耳机插拔、蓝牙切换等)(时刻)
}
export default{
  data(){
    return {
      isRecordStart:true, //录音开始
      isRecording:false,//录音中
      recordProcessIndex:0,//录音定时器
      scoreViewFailed:false,//分数错误视图
      scoreView:false,//分数视图
      scoreViewSuccess:false,
      scoreImg:'',//分数视图
      socre:'',
      timer: 0,
      evaluater: null, // 测评实例
      evaluaterState: 1, 
      recordResult: null, // 测评结果
      audio: null,
      audioUrl: '', // 录音地址
      audioPlaying: false
    }
  },
  props:{
    isFullScreen:{
      type:Boolean,
      default:false
    },
    recordIndex:{
      type:Number,
      default:0
    },
    recordInfo:{
      type:Array,
      default(){
        return []
      }
    },
    showErrorScoreView:{
      type:Boolean,
      default:false
    },
    materialId: {
      type: String,
      default: ""
    },
    showScoreView:{
      type:Boolean,
      default:true
    }
  },
  watch:{
     
    recordIndex(newVule,oldVule){
      this.resetParams()
    },
    //显示分数视图
    showScoreView(newVaule,oldVale){
      if(newVaule){
        this.isRecordStart = false
        this.isRecording = false
        this.scoreViewSuccess = true
        this.scoreViewFailed = false
        this.scoreView = true
        this.scoreViewSuccess = true
        this.scoreViewFailed = false
      }
    },
    showErrorScoreView(newValue,oldValue){
      if(newValue == true){
        this.isRecordStart = false
        this.isRecording = false
        this.scoreView = true
        this.scoreViewSuccess = false
        this.scoreViewFailed = true
      }
    }
  },
  mounted(){
    this.initRecord()
  },
  destroyed(){
    this.clearUrlObj()
    clearInterval(this.recordProcessIndex)
    clearTimeout(this.timer)
    this.evaluater.close()
  },
  methods:{
    //设置复位
    resetParams(){
      this.isRecordStart = true
      this.isRecording = false 
      this.scoreViewFailed = false
    },
    //重新录音
    recordAgain(){
      this.clearUrlObj()
      //强制停止回放
      this.stopAudioPlay()
      this.scoreView = false
      this.isRecordStart = true
      if(this.scoreViewFailed == true){
        this.scoreViewFailed = false
      }
      sa.track('recordButtonClick',{
        "click_id":"pc_learning_pre_vedio_repeat_record_button"    
      }) 
    },
    continuePlay(){
      this.clearUrlObj()
      //强制停止回放，保证回放和视频播放不同时占用音响，导致竞争关系
      this.stopAudioPlay()
      this.stopRecord()
      sa.track('learning_click',{
        "click_id":'pc_learning_pre_vedio_skip_record_button'
      })
    },
    //设置分数图片
    setDataImg(score,recordIndex){
      let socreArray = this.recordInfo[recordIndex].rateCriteria
      let length = socreArray.length
      for(let i = 0; i<length;i++){
        if(score >= socreArray[i].scoreMin && score <= socreArray[i].scoreMax ){
          this.scoreImg = socreArray[i].url
          break
        }
      }
    },
    //停止录音
    stopRecord(){
      //复位
      this.isRecordStart = true
      this.isRecording = false
      this.scoreView = false
      this.onScoreError = false
      this.$emit("stopRecord")
    },
    setRecordProcess(){
      let start = 0
      let perimeter = Math.PI * 2 * 70
      let duration = this.recordInfo[this.recordIndex].duration
      this.recordProcessIndex = setInterval(()=>{
        start += 100
        let percent = start/duration
        this.$refs.circle.setAttribute("stroke-dasharray",perimeter * percent + " " + perimeter * (1- percent))
      },100)
    },
    clearCicleProcess(){
      let start = 0
      let perimeter = Math.PI * 2 * 70
      let percent = 0
      this.$refs.circle.setAttribute("stroke-dasharray",perimeter * percent + " " + perimeter * (1- percent))
    },
    upRecordFile(){
      let upload = new VVOS({
        api:{
          gettoken:getTokenUrl,
          notifier:callBackUrl
        },
        cover:true,
        client: 'vos-js.sdk 1.0.0.0'
      })
      let file = new File([this.recordResult.audioBlob],cookie.get('studentId')+'.wav')

      file.key = cookie.get('studentId')+'.wav'

      upload.addfiles([file])

      upload.submit({
        gettoken:{
          studentId:parseInt(cookie.get("studentId")),
          lessonId:parseInt(this.$route.params.id),
          audioSuffix:".wav",
          startTime:parseInt(this.recordInfo[this.recordIndex].startTime)
        },
        notifier: {
          studentId:parseInt(cookie.get("studentId")),
          score:parseInt(this.score),
          startTime:parseInt(this.recordInfo[this.recordIndex].startTime),
          curriculumVersion:parseInt(this.$route.params.curriculum_version),
          lessonId:parseInt(this.$route.params.id),
          materialId:parseInt(this.materialId)
        }
      },(err,data)=>{
      },(err,process)=>{
      })
    },
    //初始化测评实例
    initRecord(){
      let getSdkOpt = () => {
        const envObj = {
          test: 'test',
          prod: 'prod'
        }
        const appIdObj = {
          test: '371ee4ff514c4c67b173aaf5cc13669f',
          prod: 'bf37366a096a493880787b22032abe13'
        }
        // 正式环境
        let env = envObj.prod
        let appId = appIdObj.prod
        // 测试环境
        let host = window.location.host
        let reg = /^\w\d+/
        if (reg.test(host)) {
          env = envObj.test
          appId = appIdObj.test
        }
        return {env, appId}
      }
      let sdkOpt = getSdkOpt()
      this.audio = this.$refs.recordAudio
      // 评测实例
      this.evaluater = new VKEvaluater({
        appId: sdkOpt.appId,
        env: sdkOpt.env,
        onState: state => {
          this.evaluaterStateHandle(state)
        },
        onError: err => {
          this.evaluaterErrorHandle(err)
        }
      })
    },
    // 状态处理
    evaluaterStateHandle(state) {
      this.evaluaterState = state.code
      switch (state.code) {
      case states.AUDIO_RECORDING:
        // 开始录音
        this.isRecordStart = false
        this.isRecording = true
        this.setRecordProcess()
        sa.track('recordButtonClick',{
          "click_id":"pc_learning_pre_vedio_record_button"
        })
        break
      case states.RESULT_RECEIVED:
        // 获取测评结果
        this.recordResult = state.data
        this.isRecording = false
        this.scoreView = true
        this.$emit("closeRecordingLayer",{haveScore:true})
        this.score = state.data.overall
        this.audioUrl = (window.URL || window.webkitURL).createObjectURL(state.data.audioBlob)
        this.setDataImg(this.score, this.recordIndex)
        this.upRecordFile()
        this.clearCicleProcess()
        sa.track('PreVedioVoxResult', {
          studentId: cookie.get('studentId'),//学生ID
          lessonId: this.$route.params.id ,//课程ID
          voiceScore: this.score,
          materialId: this.materialId,//视频资源，如果有对应的视频资源，就传过来
          curriculumVersion: this.$route.params.curriculum_version
        })
        break
      default:
          // 没有对应状态码
      }
    },
    // 错误处理
    evaluaterErrorHandle(err) {
      // 每个错误类型暂时不单独处理，统一调用父组件的自定义事件
      switch (err.code) {
      case 1000:
        // 未知错误
        break
      case 1101:
        // 环境不支持WebSocket功能
        break
      case 1102:
        // 环境不支持录音功能
        break
      case 1103:
        // 无法获取录音权限
        break
      case 1104:
        // 评测服务无法连接
        break
      case 1105:
        // 评测服务连接超时
        break
      case 1106:
        // 网络异常
        break
      case 1107:
        // 认证失败，appId无效
        break
      case 4001:
        // 文本信息错误, 包括必填项为空、类型错误等
        break
      case 4002:
        // 评测失败: ${err.message}
        break
      case 4003:
        // 评测超时: ${err.message}
        break
      default:
          // 未知错误没有错误吗
      }
      this.showErrorView()
    },
    // 异常提示
    showErrorView() {
      this.$emit("closeRecordingLayer", {haveScore: false})
      // 之前的出错提示代码在watch里，重试任然失败不会触发，这里再改一下状态
      this.isRecordStart = false
      this.isRecording = false
      this.scoreView = true
      this.scoreViewSuccess = false
      this.scoreViewFailed = true
    },
    // 开始录音
    startRecord() {
      // SDK未就绪 提示错误
      if (this.evaluaterState != states.PREPARE_START) {
        this.showErrorView()
        return
      }
      // 获取配置
      let getEvaluaterOpt = () => {
        let evaluaterOpt = {
          // refText: 'hello world',  // 音频文件对应的文本内容
          // keyWords: '', 关键字列表。当evalMode=3，即Hitalk模式时，用于指示关键字
          textMode: 0, // 0: 普通文本, 1: 支持音素, 3: 支持oov单词的音素
          evalMode: 1, // 0: 单词，1：句子，2：段落 3: Hitalk
          rank: 100,
          receiveTimeout: 10000
        }
        let refText = this.recordInfo[this.recordIndex].content
        let parseRefText = ''
        try{
          parseRefText = JSON.parse(refText)
        }catch(e){
          parseRefText = refText
        }
        if (typeof parseRefText == "object"){
          evaluaterOpt.textMode = 3
          evaluaterOpt.refTextObj = parseRefText
        } else {
          evaluaterOpt.refText = refText
        }
        return evaluaterOpt
      }
      // 开始录音
      this.evaluater.start(getEvaluaterOpt())
      // 超时自动停止录音
      let duration = this.recordInfo[this.recordIndex].duration
      this.timer = setTimeout(() => {
        this.endRecord()
      }, duration)
    },
    // 结束录音
    endRecord() {
      clearTimeout(this.timer)
      clearInterval(this.recordProcessIndex)
      this.$emit("showRecordingLayer")
      this.evaluater.stop()
    },
    // 播放/停止
    audioPlyaToggle() {
      if (this.audioPlaying) {
        this.stopAudioPlay()
      }else {
        this.audio.play()
        this.audioPlaying = true
      }
    },
    // 停止播放
    stopAudioPlay() {
      this.audio.pause()
      this.audio.currentTime = 0
      this.audioPlaying = false
    },
    // 录音播放结束
    onAudioPlayEnd() {
      this.audioPlaying = false
    },
    // 清除URL对象
    clearUrlObj() {
      let url = window.URL || window.webkitURL
      url.revokeObjectURL(this.audioUrl)
      this.audioUrl = ''
    }
  }
}
</script>
<style lang="stylus" scoped>
   .pre-record-layer
      position: absolute
      top:0
      left 0
      width:100%
      height:100%
      z-index 100
      border-radius:25px
      background:rgba(0,0,0,0.5)
   .pre-record-layer-full-screen
      border-radius:0
   .pre-record-content
     position:relative
     width:100%
     height:100%
   .pre-record-start-video
      position:absolute
      left:50%;
      height 189px
      width:156px
      bottom:94px
      margin-left:-78px;
   .pre-record-start-content
      position:absolute
      width:100%
      height:100%
      p  
        position:absolute
        left:36px
        bottom:18px
        font-family:"PingFangSC-Regular"
        font-size:14px
        color:#fff
        line-height: 20px
   .pre-record-start-trip
      position: absolute
      top:71px
      left:78px
      width: 66px
      height 67px
      background:url('../../../img/video/pre-record-hand@2x.png') no-repeat
      background-size:66px 67px
      animation-name:upanddown
      animation-timing-function:linear
      animation-iteration-count :infinite
      animation-duration:1.5s
   .pre-record-start-img
      position:absolute
      top:28px
      left:28px
      width:100px
      height:100px
      background:url(../../../img/video/pre-start-record-button@2x.png) no-repeat
      background-size:100px auto
   .pre-record-process-content
      position:absolute
      height:100%
      width:100%
      p
       position:absolute
       bottom:0
       width:100% 
       text-align:center
       color:#fff
       font-size:14px 
       font-family:"PingFangSC-Regular"
   .pre-record-middle
       position:absolute
       top:18px
       left:18px
       width: 130px
       height:130px
       background url("../../../img/video/pre-record-bottom@2x.png") no-repeat
       background-size:130px 130px
   .pre-record-shock
       position:absolute
       margin-left:5px;
       left:50%
       top:80px
       height 20px
       width:10px
       border-top-left-radius: 10px
       border-bottom-left-radius:10px
       transform-origin:0 center 
       transform:rotateZ(-90deg)
       background:#fff
       animation-name: shock
       animation-duration 1s
       animation-iteration-count:infinite
       animation-timing-function:ease-in
   @keyframes shock 
      0%
        width: 10px
      25%
        width: 12px
      50%
        width: 20px
      75%
        width: 22px
      80%
        width: 30px
      100%
        width:15px
   @keyframes upanddown
      0% 
        transform:translate(50px,50px)
      100%
        transform:translate(0px,0px)
    // 不想录音的样式
   .pre-record-no-record-button   
      position: absolute
      right:74px
      bottom:109px
      padding: 5px 10px 5px 20px
      width: 150px
      height: 30px
      background:rgba(0,0,0,0.7)
      border-radius:17px
      color:#fff
      font-size: 14px
      box-sizing:border-box
      line-height:20px;
      span 
        position:absolute
        top:8px
        right:10px
        width: 10px
        height:14px
        background:url(../../../img/video/pre-no-record-arrow@2x.png) no-repeat
        background-size:10px 14px
    .pre-record-no-record-button-full-screen
        top:40px;
    .pre-score-view
        position:absolute
        width :100%
        height:100%
        img 
          display:block
          position:relative
          top:7.3%
          left:21%
          width:58%
        .text 
           position: absolute
           top: 53%
           width: 100%
           font-size: 16px
           color: #fff
           text-align: center
    .pre-recodrd-part-content
          position:absolute
          bottom:16%
          display:flex 
          width: 100%
          height 140px 
          justify-content:center
          align-items:flex-end
          display: -webkit-flex
          -webkit-justify-content:center
          -webkit-align-items:flex-end
    .pre-record-replay-button
        position:relative
        padding-right:4%
        width :60px
        height :90px
        &.replayOff
          background url("../../../img/video/pre-play-record-button@2x.png") no-repeat
          background-size:60px 60px
          .pre-start-play-record-trips
            display:block
        &.replayOn 
          background url("../../../img/video/pre-pause-button@2x.png") no-repeat
          background-size:60px 60px
          .pre-pause-play-record-trips
            display:block
        p
         display:none
         position:absolute
         bottom:0
         width:100%
         font-size:14px
         color:#fff
    .pre-record-replay-button-error 
        position:relative
        padding-right:4%
        width :60px
        height :90px
        background:url("../../../img/video/pre-play-button@2x.png") no-repeat
        background-size:60px 60px
        .pre-start-play-record-trips
           position:absolute
           bottom:0
           width:100%
           font-size:14px
           color:#fff
    .pre-record-replay-full-screen-button
        width:80px 
        height:116px
        &.replayOff
          background url("../../../img/video/pre-play-record-button@2x.png") no-repeat 
          background-size:80px 80px
        &.replayOn
          background url("../../../img/video/pre-pause-button@2x.png") no-repeat 
          background-size:80px 80px
    .pre-record-replay-full-screen-button-error 
        width:80px 
        height:116px
        background:url("../../../img/video/pre-play-button@2x.png") no-repeat 
        background-size:80px 80px
    .pre-record-rerecord-button
         position:relative
         padding-right:5%
         width:60px 
         height:90px 
         background url("../../../img/video/pre-repeat-button@2x.png") no-repeat
         background-size:60px 60px
         p  
           position:absolute
           bottom:0
           width:100%
           font-size:14px 
           color:#fff
    .pre-record-rerecord-full-screen-button
        width:80px 
        height:116px 
        background url("../../../img/video/pre-repeat-button@2x.png") no-repeat
        background-size:80px 80px
    .pre-record-start-play-button
       position:relative
       width:80px 
       height:104px 
       background:url("../../../img/video/pre-next-step-button@2x.png") no-repeat
       background-size:80px 80px
       p  
         position:absolute
         padding-left:10%
         bottom:0
         width:100%
         font-size:14px 
         color:#fff
    .pre-record-start-play-full-screen-button
       width:100px 
       height:126px 
       background:url("../../../img/video/pre-next-step-button@2x.png") no-repeat
       background-size:100px 100px
   .dialogBody
       display:none
   img.pre-error 
       display:block
       position:relative
       top: 7.3%
       left: 38%
       width: 24%    
</style>


