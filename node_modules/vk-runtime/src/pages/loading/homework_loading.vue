<template lang="jade">
  .home-work-loading-container
    img.mid-img(src="../../img/loading/homework-loading.png")
    .loading-content-box
      .loading-text 正在加载课后作业... 大约需要几分钟
      .loading-progress-hd
        .loading-progress-bg
        .loading-progress(:style="{width: progressPercentage + '%'}")
      .loading-text-small 宝贝耐心等待哦，或点击
        span(@click="goback") 返回
    my-dialog(:tipText="alertText",
              cancelButton="回退",
              confirmButton="重试",
              type="choose",
              title="Notice",
              isShowTitle = true,
              @library-dialog-cancel="goback",
              @library-dialog-confirm="reload",
              v-if="isBadNetworkAlertShow")
</template>
<script>
import axios from 'axios'
import cookies from 'cookies-js'
import dragonUtils from '../../utils/_dragon.js'
import myDialog from "../readers/common/dialog.vue"
export default {
  data: function() {
    return {
      studentId: this.$route.params.stuId,
      lessonId: this.$route.params.lessonId,
      curriculumVersion: this.$route.params.curriculumVersion,
      type: this.$route.params.type, //1为课前预习 2为课后作业
      progressPercentage: 0,
      studentHomeworkId: 0,
      fileUrl: "",
      md5: '',
      isBadNetworkAlertShow: false,
      alertText: '网络异常～',
      timeouts: [],
      isAllowToOpenFile: true,
      nhwMark: ''
    }
  },
  components: {
    myDialog
  },
  computed: {},
  beforeDestroy() {
    this.isAllowToOpenFile = false
    //销毁定时器
    for (var i = 0; i < this.timeouts.length; i++) {
      clearTimeout(this.timeouts[i])
    }
  },
  mounted() {
    //mini/standard和SL对掉后，mini/standard跳到SL就不再显示右上角nhw入口了,所以，mini/standard跳SL的时候带上一个参数fromnhw=1，这里就隐藏掉右上角nhw入口
    if (location.search.indexOf('fromnhw') > -1) {
      this.nhwMark = '?fromnhw=1'
    }
    if (dragonUtils.isOnDragonClient()) {
      //小恐龙
      let manager = new __bridge.HomeWorkManager() //小恐龙
      manager.on('progress', (args) => {
        if (this.md5 == args.md5) {
        //eslint-disable-next-line no-console
          console.log('->progress', args)
          this.progressPercentage = args.precent
        }
      })
      manager.on('failed', (args) => {
        //eslint-disable-next-line no-console
        console.log('->failed', args)
        //eslint-disable-next-line no-console
        console.log('->failed', args.message)
        this.isBadNetworkAlertShow = true
        sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 101, error_log: ${args.message.toString()}` })
      })
      manager.on('extract', (args) => {
        //eslint-disable-next-line no-console
        console.log('->extract', args)
        if (this.md5 == args.md5) {
          manager.getState(this.md5, this.fileUrl)
            .then((args) => {
              if (args) {
                if (this.isAllowToOpenFile) {
                  window.location.replace(`/homework/${this.studentId}/${this.lessonId}/${this.type}?targetUrl=file://${args}/story.html${this.nhwMark}`) //window.location为了清掉下载线程
                }
              } else {
                if (this.isAllowToOpenFile) {
                  this.isBadNetworkAlertShow = true
                  sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 102, error_log: ${args.toString()}` })
                }
              }
            })
            .catch((err) => {
              sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 107, error_log: ${err.toString()}` })
            })
        }
      })
      manager.on('checksum', (args) => {
        //eslint-disable-next-line no-console
        console.log('->checksum', args)
      })
      manager.on('complete', (args) => {
        //eslint-disable-next-line no-console
        console.log('->complete', args)
      })
      this.getHomeWork()
    } else {
      //课后作业
      window.location.replace('/homework/' + this.studentId + '/' + this.lessonId + '/' + this.type + '?curriculumVersion=' + this.curriculumVersion) //window.location为了清掉下载线程
    }
  },
  methods: {
    getDragonVersion() {
      let ua = navigator.userAgent.toLowerCase()
      if (ua.match(/vipkid\/([0-9]{1,}.)*/gi)) {
        return ua.match(/vipkid\/([0-9]{1,}.)*/gi)[0].split('/')[1]
      }
    },
    reload() {
      window.location.reload()
    },
    goback() {
      window.history.back()
    },
    getHomeWork() {
      axios.get('/rest/learninggw/api/pc/service/homework/getClientFileInfo', {
        params: {
          studentId: this.studentId,
          lessonId: this.lessonId,
          type: this.type,
          curriculumVersion: this.curriculumVersion
        }
      })
        .then((res) => {
        //eslint-disable-next-line no-console
          console.log('res', res)
          let manager = new __bridge.HomeWorkManager() //小恐龙
          if (res.data.code != 200) {
            if (res.data.code == 204) {
              sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 204, error_log: ${res.data.toString()}` })
            } else {
              sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 103, error_log: ${res.data.toString()}` })
            }
            this.isBadNetworkAlertShow = true
            return
          }
          this.fileUrl = res.data.data.fileUrl
          this.md5 = res.data.data.eTag
          this.studentHomeworkId = res.data.data.studentHomeworkId
          
          this.timeouts.push(setTimeout(() => {
            
            manager.getState(this.md5, this.fileUrl)
              .then((args) => {
                if (args) {
                  window.location.replace(`/homework/${this.studentId}/${this.lessonId}/${this.type}?targetUrl=file://${args}/story.html${this.nhwMark}`) //window.location为了清掉下载线程
                } else {
                  manager.download(this.md5, this.fileUrl)
                    .then((args) => {
                      //eslint-disable-next-line no-console
                      console.log('->download', args)
                    })
                    .catch((err) => {
                      sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 106, error_log: ${err.toString()}` })
                      this.isBadNetworkAlertShow = true
                    })
                }
              })
            
          }, 1000))
          
        })
        .catch((err) => {
          this.isBadNetworkAlertShow = true
          sa.track('pc_client_error', { 'pc_client_error_info': `version: ${this.getDragonVersion()}, studentId: ${cookies.get('studentId')}, error_code: 105, error_log: ${err.toString()}` })
        })
    }
  }
}
</script>
<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    font-weight: 300
    -webkit-touch-callout: none

  .home-work-loading-container
    position: absolute
    margin: 0 auto
    left: 0
    right: 0
    text-align: center
    width: 600px
    height: 700px
    top: 50%
    margin-top: -300px
    .mid-img
      width: 440px
      height: 376px
    .loading-content-box
      text-align: center
      color: white
      margin-top: 30px
      .loading-text
        margin-bottom: 20px
        font-size: 24px
      .loading-text-small
        font-size: 18px
        span
          color: #a18ee3
          margin-left: 10px
          text-decoration: underline
          cursor: pointer
      .loading-progress-hd
        position: relative
        width: 550px
        height: 12px
        border-radius: 99px
        margin: 0 auto 20px auto
        .loading-progress-bg
          position: absolute
          left: 0
          top: 0
          width: 100%
          height: 100%
          background-color: white
          opacity: 0.2
          border-radius: 99px
        .loading-progress
          position: absolute
          left: 0
          top: 0
          width: 1%
          height: 100%
          background-color: #ff6600
          border-radius: 99px
</style>
