<template lang="jade">
  .book-record-action.aiPanel(id="aiPanel")
      my-dialog(
        :tipText="'宝贝录音传输未成功<br>尝试重新录制'",
        :confirmButton="'知道了'",
        :type="'alert'",
        title="Notice",
        isShowTitle = true,
        :isShowCloseButton='false',
        @library-dialog-cancel="closeDialog",
        v-if="isRecordFailed"
      )
      my-dialog(
        :tipText="'宝贝录音评分超时<br>尝试重新录制'",
        :confirmButton="'知道了'",
        :type="'alert'",
        title="Notice",
        isShowTitle = true,
        :isShowCloseButton='false',
        @library-dialog-cancel="closeTimeOutDialog",
        v-if="isRecordTimeOut"
      )
      .listem.left(data-list="1" v-show="recordCurrentData[0].canRecord")
         .record.left(data-index=1)
           .record-to-start(v-show="!leftIsRecord")
           .record-processing(v-show="leftIsRecord")
              svg(
               width="80"
               height="80"
               viewbox="0 0 80 80"
              )
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.1)" fill="none")
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.8)"
                  transform="matrix(0,-1,1,0,0,80)"
                  stroke-dasharray="0 1069"
                  fill="none"
                  ref="circleLfet"
              )
              .record-middle
              .record-shock
         .replays.left(data-index=1 v-show="isShowLeftReplay" @click="clickRecordPlay(1)" ref="leftRecordPlayButton")
         .play.left(data-index=1 v-show="isShowLeftPlay")
         .score.left(v-show="showLeftScore",:class="leftScoreFlag")
            .score-text {{leftPageScore}}
      .listem.right(data-list="2" v-show="recordCurrentData[1].canRecord")
         .record.right(data-index=2)
           .record-to-start(v-show="!rightIsRecord")
           .record-processing(v-show="rightIsRecord")
              svg(
               width="80"
               height="80"
               viewbox="0 0 80 80"
              )
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.1)" fill="none")
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.8)"
                  transform="matrix(0,-1,1,0,0,80)"
                  stroke-dasharray="0 1069"
                  fill="none"
                  ref="circleRight"
              )
              .record-middle
              .record-shock
         .replays.right(data-index=2 v-show="isShowRightReplay" @click="clickRecordPlay(2)" ref="rightRecordPlayButton")
         .play.right(data-index=2 v-show="isShowRightPlay")
         .score.right(v-show="showRightScore",:class="rightScoreFlag")
           .score-text {{rightPageScore}}
      .dialogBody
         #recorder
</template>
<script>
import myDialog from "./../common/dialog.vue"
import cookie from "cookies-js"
import chivox from 'chivox'
import VVOS from "vvos-js"

export default {
  data(){
    return {
      aiPanel: null,
      leftIsRecord:false,
      rightIsRecord:false,
      isShowRightReplay:false,
      isShowLeftReplay:false,
      showLeftScore:false,
      showRightScore:false,
      rightScoreFlag:'bad', //分为 bad ,normal good ,excellent 四个等级
      leftScoreFlag:'normal',//

      leftPageRecordBuff:null, //左侧的录音文件
      rightPageRecordBuff:null,//右侧的录音文件

      leftPageRecordBuffUrl:'', //左侧录音文件BlobUrl
      rightPageRecordBuffUrl:'', //右侧录音文件的BlobUrl
      leftUpSuccess:false,
      rightUpSuccess:false,
      leftPageScore:0,
      rightPageScore:0,
      recordText:'',
      recordTime:0,
      recordEndTime:0,
      recordPageIndex:0,//录音的索引(而不是页码)
      currentPage:0,
      workScoreMap:null,
      scoreSegment:"0,0,0,0",
      startTimer:0,//定时器
      isShowRightPlay:false,
      isShowLeftPlay:false,
      recordAudio:null,
      isRecordPlay:false,//是否在播放录音文件
      isRecordFailed:false,//弹窗提示
      timer:0,//录音定时器
      timeOut:30000,//录音打分超时 将超时改为30s
      isRecordTimeOut:false
    }
  },
  components:{
    myDialog
  },
  props:{
    recordCurrentPages:{
      type:Number,
      default:0
    },
    dudSummaryId:{
      type:Number,
      default:0
    },
    pageCount:{
      type:Number,
      default:0
    },
    recordCurrentData:{
      type:Array,
      default:function(){
        return [
          {
            text:'',
            index:1,
            duration:0,
            pageMapQueue:1,
            canRecord:false,
            direction:"left"
          },
          {
            text:'',
            index:1,
            duration:0,
            pageMapQueue:2,
            canRecord:false,
            direction:"right"
          }
        ]
      }
    }
  },
  watch:{
    //当recordCurrentPages变化时
    recordCurrentPages:function(val){
      //如果当前的数据有分数，不隐藏，否则隐藏
      if(this.recordCurrentData[1].score!==false){
        this.isShowRightPlay = true
        this.showRightScore = true
        this.showRecordScore("2",this.recordCurrentData[1].score)
      } else{
        this.showRightScore = false
        this.isShowRightPlay = false
      }
      if(this.recordCurrentData[0].score!==false){
        this.isShowLeftPlay = true
        this.showLeftScore = true
        this.showRecordScore("1",this.recordCurrentData[0].score)
      } else {
        this.showLeftScore = false
        this.isShowLeftPlay = false
      }
      this.isShowRightReplay = false
      this.isShowLeftReplay = false
      this.closeRecordAudio()
    }
  },
  methods:{
    closeTimeOutDialog(){
      this.isRecordTimeOut = false
    },
    //录音定时器
    startTimeOut(){
      this.timer = setTimeout(()=>{
        this.isRecordTimeOut = true
        this.$emit("closeScoreLayer")
        this.clearCircleProcess("1")
        this.clearCircleProcess("2")
        // 评分超时，超过14s
        sa.track('learning_click', {
          'click_id': 'pc_learning_vedio_record_get_score_timeout'
        })
      }, this.timeOut)
    },
    closeTimeOut(){
      clearTimeout(this.timer)
    },
    closeRecordAudio(){
      if(this.recordAudio){
        this.recordAudio.pause()
      }
    },
    closeDialog(){
      this.isRecordFailed = false
    },
    // 设置定时器
    setTimer(index){
      let duration = this.recordCurrentData[index-1].duration
      let start = 0
      let circle = null
      let perimeter = Math.PI * 2 * 30
     
      if(index == "1"){
        circle = this.$refs.circleLfet
      } else {
        circle = this.$refs.circleRight
      }
      this.startTimer = setInterval(()=>{
        start += 100
        let percent = start/duration
        circle.setAttribute('stroke-dasharray',
          perimeter * percent + " " + perimeter * (1- percent)
        )
      },100)
    },
    //点击播放按钮
    clickRecordPlay(index){
      this.recordAudio.currentTime = 0
      if(this.isRecordPlay){
        this.stopAudio()
      } else{
        this.playAudio(index)
        this.$emit("stopPlay")
      }
    },
    initAudio(){
      this.recordAudio = document.createElement('audio')
      this.recordAudio.addEventListener('ended',()=>{
        this.isRecordPlay = false
        this.$refs.leftRecordPlayButton.classList.add('replayOff')
        this.$refs.leftRecordPlayButton.classList.remove('replayOn')
        this.$refs.rightRecordPlayButton.classList.remove('replayOn')
        this.$refs.rightRecordPlayButton.classList.add('replayOff')
      })
    },
    //打分成功之后，改变对应按钮的状态
    changeAudioStyle(index){
      if(index ==1){
        this.$refs.leftRecordPlayButton.classList.add('replayOff')
      } else {
        this.$refs.rightRecordPlayButton.classList.add('replayOff')
      }
    },
    //播放录音
    playAudio(index){
      if(index == 1){
        this.$refs.leftRecordPlayButton.classList.add('replayOn')
        this.$refs.leftRecordPlayButton.classList.remove('replayOff')
        this.$refs.rightRecordPlayButton.classList.remove('replayOn')
        this.$refs.rightRecordPlayButton.classList.add('replayOff')
        this.recordAudio.src = this.leftPageRecordBuffUrl
      } else {
        this.$refs.rightRecordPlayButton.classList.add('replayOn')
        this.$refs.rightRecordPlayButton.classList.remove('replayOff')
        this.$refs.leftRecordPlayButton.classList.remove('replayOn')
        this.$refs.leftRecordPlayButton.classList.add('replayOff')
        this.recordAudio.src = this.rightPageRecordBuffUrl
      }
      let promise = this.recordAudio.play()
      promise.then(()=>{
        this.isRecordPlay = true
      })
    },
    //停止录音
    stopAudio(index){
      this.recordAudio.pause()
      this.isRecordPlay = false
      this.recordAudio.currentTime = 0
      this.$refs.leftRecordPlayButton.classList.add('replayOff')
      this.$refs.leftRecordPlayButton.classList.remove('replayOn')
      this.$refs.rightRecordPlayButton.classList.remove('replayOn')
      this.$refs.rightRecordPlayButton.classList.add('replayOff')
    },
    // 清空 circle 进程
    clearCircleProcess(index){
      let start = 0
      let perimeter = Math.PI * 2 * 70
      let percent = 0
      let circle = null
      if(index =="1"){
        circle = this.$refs.circleLfet
      } else {
        circle = this.$refs.circleRight
      }
      circle.setAttribute("stroke-dasharray",perimeter * percent + " " + perimeter * (1- percent))
    },
    //将录音Blob转化为BlobUrl
    blobToUrl(index){
      let blobUrl = URL.createObjectURL(window.recordBuff)
      if(index == '1'){
        this.leftPageRecordBuffUrl = blobUrl
        window.leftPageRecordBuffUrl = blobUrl
      } else 
        this.rightPageRecordBuffUrl = blobUrl
      window.rightPageRecordBuffUrl = blobUrl
    },
    //缓存Blob文件
    cacheBlob(index){
      let blob = window.recordBuff.slice()
      if(index == '1'){
        this.leftPageRecordBuff = blob
      } else 
        this.rightPageRecordBuff = blob
    },
    changeAudioSrc(index){
      if(index=='1'){
        window.recordAudio.src = this.leftPageRecordBuffUrl
      } else 
        window.recordAudio.src = this.rightPageRecordBuffUrl
    },
    //设置录音参数
    setRecordParms(index){
      index = parseInt(index)
      let duration = this.recordCurrentData[index -1].duration
      let refText = this.recordCurrentData[index -1].text
      let parseRefText = null
      let recordParams = null
      this.recordPageIndex = this.recordCurrentData[index -1].index
      this.currentPage = this.recordCurrentData[index -1].pageMapQueue
      try {
        parseRefText = JSON.parse(refText)
        this.recordText = parseRefText.text.toString()
      }catch(e){
        parseRefText = refText
        this.recordText = parseRefText.toString()
      }
      if(typeof parseRefText == 'object'){
        recordParams = {
          textMode:3,
          waringTone:false,
          coreType: "en.sent.child",
          refText: parseRefText,
          userId: cookie.get("studentId")
        }
      } else {
        recordParams ={
          waringTone:false,
          coreType: "en.sent.child",
          refText: parseRefText.toString(),
          userId: cookie.get("studentId")
        }
      }
      // 设置参数
      this.aiPanel.setData({
        duration:parseInt(duration),
        serverParams:recordParams
      })
    },
    
    /** 
      * @description 处理返回分数中每个单词的得分
      * @param {object} pronObject 返回的句子分数对象
      */
    // 处理返回分数中每个单词的得分
    processScore(pronObject){
      let wordScoreArray = []
      let workScoreMap = []
      for(let i =0; i < pronObject.getWordSize(); i++){
        let wordMap = {}
        let wordScore = pronObject.getWord(i).getScore()
        wordMap.word = pronObject.getWord(i).data.char
        wordMap.score = wordScore
        workScoreMap.push(wordMap)
        wordScoreArray.push(wordScore)
      }
      this.workScoreMap = JSON.stringify(workScoreMap)
      this.scoreSegment = wordScoreArray.toString()
    },
    //上传录音文件
    upRecordBuff(index){
      const getTokenUrl = location.protocol + "//"+ location.host + "/rest/learninggw/api/pc/service/digitlib/getRecordToken"
      const callBackUrl = location.protocol + "//"+ location.host + "/rest/learninggw/api/pc/service/digitlib/getRecordCallbackToken"
      let upload = new VVOS({
        api:{
          gettoken:getTokenUrl,
          notifier:callBackUrl
        },
        cover:true,
        client: 'vos-js.sdk 1.0.0.0'
      })
      let file = new File([window.recordBuff],cookie.get('studentId') + this.recordTime+'.wav')
      file.key = cookie.get('studentId') + this.recordTime +'.wav'
      upload.addfiles([file])
      upload.submit({
        gettoken:{
          studentId:parseInt(cookie.get("studentId")),
          bookId:parseInt(this.$route.params.id),
          audioSuffix:".wav",
          bookCode:this.$route.params.bookCode,
          currentPage:this.currentPage,
          startTime:this.recordTime
        },
        notifier: {
          studentId:parseInt(cookie.get("studentId")),
          score:parseInt(this.score),
          currentPage:this.currentPage, //页面索引
          startTime:this.recordTime,
          dudSummaryId:parseInt(this.dudSummaryId),
          pageIndex:this.recordPageIndex, //录音的索引
          pageCount:this.pageCount,//录音总数
          //分数系统 "0,0,0,0"
          scoreSegment:this.scoreSegment,
          endTime:this.recordEndTime,
          wordSegment:this.recordText,
          workScoreMap:this.workScoreMap
        }
      },(err,data)=>{
        if(data.data){
          let audioUrl = data.data.data ? data.data.data: "https://sdk.cloud.chivox.com/chivoxsdk-js/v4.0/Examples/static/mp3/en/past.mp3"
          this.emitRecordSuccess(index,audioUrl)
          sa.track('learning_click', {
            'click_id': 'pc_learning_vedio_record_up_file_sucess'
          })
        }
        if(err){
          this.isRecordFailed = true
        }
      },(err,process)=>{
      })
    },

    emitRecordSuccess(index,audioUrl){
      if(index == "1"){
        this.leftUpSuccess = true
        this.$emit("changeRecordInformation",{
          currentPage:this.currentPage,
          recordUpFileUrl:audioUrl,
          score:this.leftPageScore
        })
        if(this.recordCurrentData[1].havedRecord){
          this.rightUpSuccess = true
        }
      }
      if(index == "2"){
        this.rightUpSuccess = true
        this.$emit("changeRecordInformation",{
          currentPage:this.currentPage,
          recordUpFileUrl:audioUrl,
          score:this.rightPageScore
        })
        if(this.recordCurrentData[0].havedRecord){
          this.leftUpSuccess = true
        }
      }
      if(this.rightUpSuccess && this.leftUpSuccess){
        this.$emit("recordSuccess",{
          currentPage:this.currentPage
        })
        this.leftUpSuccess = false
        this.rightUpSuccess = false
      }
    },
    //显示录音得分
    showRecordScore(index,score){
      if(score===false){
        return
      }
      let scoreString = ""
      if(score<=55){
        scoreString = "bad"
      } else if(score <= 70){
        scoreString = "normal"
      } else if(score <=85) {
        scoreString = "good"
      } else if(score<=100){
        scoreString = "excellent"
      }
      switch(index){
      case "1":
        this.showLeftScore = true
        this.leftScoreFlag = scoreString
        this.leftPageScore = score
        break
      case "2":
        this.showRightScore = true 
        this.rightScoreFlag = scoreString
        this.rightPageScore = score
        break
      }
    },
    setPlayParams(index){
      this.aiPanel.params.data = {
        audioUrl:this.recordCurrentData[index -1].playUrl
      }
    },
    showPlayButton(){
      if(this.recordCurrentData[0].playUrl){
        this.isShowLeftPlay = true
      }
      if(this.recordCurrentData[1].playUrl){
        this.isShowRightPlay = true
      }
    },
    closePlayButton(index){
      this.isShowLeftPlay = false
      this.isShowRightPlay = false
    },
    initRecord(){
      let recordParams = {
        waringTone:false,
        coreType: "en.sent.child",
        refText: "Hello,world!",
        userId: cookie.get("studentId")
      }
      this.aiPanel = new chivox.AiPanel({
        appKey:chivox.keyConfig.appKey,
        mode:chivox.MODE.HTML5,
        sigurl:'/rest/learninggw/api/pc/material/preClassVideo/getChivoxHash?studentId=' + cookie.get("studentId"),
        data:{
          duration:3000,
          serverParams:recordParams
        },
        onBeforePlay:(el)=>{
          let index = el.dataset.index
          this.setPlayParams(index)
          this.$emit("stopPlay")
        },
        //此处可以设置录音参数，录音前清除之前数据
        onBeforeRecord:(el)=>{
          let index = el.dataset.index
          this.$emit("stopPlay")
          switch(index){
          case "1":
            this.showLeftScore = false
            this.isShowLeftPlay = false
            this.isShowLeftReplay = false
            break
          case "2":
            this.isShowRightPlay = false
            this.isShowRightReplay = false
            this.showRightScore = false
            break
          }
          this.setRecordParms(index)
        },
        //录音真正开始
        onRecordStart:(el)=>{
          let current = (new Date()).getTime()
          let index = el.dataset.index
          this.recordTime = current
          switch(index){
          case "1":
            this.leftIsRecord = true
            break
          case "2":
            this.rightIsRecord = true
          }
          this.setTimer(index)
        },
        //自动停止录音，或手动停止录音
        onAfterRecord:(el)=>{
          clearInterval(this.startTimer)
          this.leftIsRecord = false
          this.rightIsRecord = false
          this.recordEndTime = (new Date()).getTime()
          this.$emit("showScoreLayer")
          this.startTimeOut()
          sa.track('learning_click', {
            'click_id': 'pc_learning_vedio_record_start_get_score'
          })
        },
        //评分成功的
        onScore:(data,el)=>{
          let index = el.dataset.index
          let responseTime = (new Date()).getTime() - this.recordEndTime //驰声返回分数的时间
          this.clearCircleProcess(index)
          this.blobToUrl(index)
          this.cacheBlob(index)
          this.$emit("closeScoreLayer")
          this.closeTimeOut()
          if(index == 1){
            this.isShowLeftReplay = true
          } else {
            this.isShowRightReplay = true
          }
          const resultObj = new chivox.EnSentScore(data)
          let pron = parseInt(resultObj.getPron())//语音评分
          this.score = pron
          this.changeAudioStyle(index)
          this.showRecordScore(index,pron)//显示分数
          this.processScore(resultObj)//处理分数
          this.upRecordBuff(index)
          sa.track('learning_click', {
            'click_id': 'pc_learning_vedio_record_get_score_success'
          })
          sa.track('learning_click', {
            'click_id': 'pc_learning_vedio_record_up_file'
          })
          //驰声返回接口的时间 ms 计数
          sa.track('learing_click',{
            'click_id': 'pc_learning_vedio_record_get_score_time',
            'qos':responseTime
          })
        },
        //评分失败
        onScoreError:(errorType)=>{
          this.closeTimeOut()
          this.clearCircleProcess("1")
          this.clearCircleProcess("2")
          this.isRecordFailed = true
          sa.track('learning_click', {
            'click_id': 'pc_learning_vedio_record_get_score_failed'
          })
        }
      })
      this.aiPanel.Dialog.close()
    }
  },
  mounted(){
    this.initAudio()
    this.$nextTick(()=>{
      this.initRecord()
      setTimeout(()=>{
        this.showPlayButton()
        this.showRecordScore("1",this.recordCurrentData[0].score)
        this.showRecordScore("2",this.recordCurrentData[1].score)
      },2000)
    })
  },
  destroyed(){
    this.aiPanel.dispose()
    this.aiPanel = null
  }
}
</script>
<style lang="stylus" scoped>
    .book-record-action
      position:relative
      margin:130px auto 0
      height:100px 
      width:840px
      .listem
         position:absolute
         width:420px 
         height:100px
         &.left
            left:0px
         &.right
            right:0px
    .record
      position:absolute
      top:10px  
      width:80px 
      height:80px
      cursor:pointer
      &.left  
        left:30px 
      &.right 
        right:30px 
      &:hover 
        opacity:.8
    .record-to-start
      margin:10px
      width:60px 
      height:60px 
      background:url(../../../img/library/pre-start-record-button@2x.png) no-repeat
      background-size:60px 60px
    .replays,.play 
      position:absolute 
      top:28px 
      width:44px 
      height:44px 
      cursor:pointer
      &.playOff
        background:url(../../../img/library/dl-record-to-play.png) no-repeat
        background-size:44px 44px
      &.playOn
        background:url(../../../img/library/pre-pause-button@2x.png) no-repeat
        background-size:44px 44px
      &.replayOff
        background:url(../../../img/library/dl-record-to-play.png) no-repeat
        background-size:44px 44px 
      &.replayDisabled
        background:url(../../../img/library/dl-record-to-play.png) no-repeat
        background-size:44px 44px 
      &.replayOn
        background:url(../../../img/library/pre-pause-button@2x.png) no-repeat
        background-size:44px 44px
      &:hover 
        opacity:.8
      &.left 
        left:120px 
      &.right
        right:120px 
    .score
      position:absolute
      top:13px 
      width:74px 
      height:67px 
      &.left 
        right:30px
      &.right
        left:30px 
      &.bad
        color:#ED6161
        background:url(../../../img/library/dl-current-score-bad.png) no-repeat
      &.normal
        color:#FFB600
        background:url(../../../img/library/dl-current-score-normal.png) no-repeat
        background-size:74px 67px 
      &.good 
        color:#90D0FF
        background:url(../../../img/library/dl-current-score-good.png) no-repeat
      &.excellent
        color:#79DC7D
        background:url(../../../img/library/dl-current-score-excellent.png) no-repeat
    .score-text
        position:absolute
        top:40px 
        width:74px 
        text-align:center
        font-family:"Arial-BoldMT"
        font-size: 20px
    .record-processing
        width:100%
        height:100%
    .record-middle
        position:absolute 
        top:10px
        left:10px 
        width:60px 
        height:60px 
        background:url(../../../img/library/pre-record-bottom@2x.png) no-repeat
        background-size:60px 60px
    .dialogBody
       display: none
</style>