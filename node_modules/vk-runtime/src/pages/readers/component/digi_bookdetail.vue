<template lang="jade">
  .book_detail_dialog_wrapper(v-if="isBookDetailShow")
    .black-mirror(@click="closeThisLayer")
    .book-detail-box
      .close-btn(@click="closeThisLayer")
      .book-detal-title {{bookDetailDataProp.name}}
      .white-board
        .book-box
          img(:src="bookDetailDataProp.coverResUrl")
          .book-marker.book-marker-no-content
        .book-intro
          .book-intro-title Information
          .book-intro-content(v-html="bookDetailDataProp.description")                                                               
        .book-detail-button-container
          .borrow-button(@click="confirmBorrowBook", v-if="this.numberOfStudentBorrow_ < 3 && bookDetailDataProp.stockAvailable > 0") Borrow
          .borrow-button.grey(v-else, @click="showBorrowFailToast") Borrow
          .borrow-text
            span.grey 馆藏绘本数量：{{bookDetailDataProp.stockAvailable}}
            template(v-if="this.numberOfStudentBorrow_ >= 3")
              span.orange 书架里没有位置，还1本之后再借阅！
    my-dialog(tipText="确定要借阅这本书吗？", :type = "'confirm'", title="Notice", isShowTitle = true, @library-dialog-cancel="cancelDialog", @library-dialog-confirm='borrowBook(bookDetailDataProp.id, bookDetailDataProp.code)', v-if="isShowDialog")
    .success-borrow-toast(v-if="isMaskShow")
      .black-mask(v-if="isMaskShow")
      transition(enter-active-class="animated bounceIn", leave-active-class="animated bounceOut")
        img.reader-toast(src="../../../img/digireader/reader-totast@2x.png", v-if="isToastShow")
        img.reader-toast(src="../../../img/digireader/no-inventory-pop.png", v-if="isNoInventoryToastShow")
        img.reader-toast(src="../../../img/digireader/no-position-pop.png", v-if="isNoPosToastShow")
</template>
<style lang="stylus" scoped>
  *
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    -webkit-touch-callout: none
  SPIRIT_PIC_WIDTH = 1430px / 2 
  COMMON_BACKGROUND_IMG()
    background-image: url('../../../img/digireader/reader_spirit.png')
    background-size: SPIRIT_PIC_WIDTH
    background-repeat: no-repeat
  .book_detail_dialog_wrapper
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    z-index: 22
    .black-mirror
      position: fixed
      top: 0
      bottom: 0
      left: 0
      right: 0
      z-index: 20
      width: 100%
      height: 100%
      background-color: rgba(0, 0, 0, 0.7)
    .book-detail-box
      position: absolute
      z-index: 22
      top: 50%
      left: 50%
      margin-top: -255px
      margin-left: -405px
      display: inline-block
      width: 810px
      height: 510px
      box-sizing: border-box
      background-color: #a18ee3
      border-radius: 18px
      box-shadow: 3px 2px 14px 0 #36185c
      text-align: center
      .close-btn
        position: absolute
        top: -10px
        right: -10px
        display:inline-block
        width: 40px
        height: 40px
        cursor: pointer
        background-position: -292px -36px
        COMMON_BACKGROUND_IMG()
        &:hover
          background-position: -337px -35px
        &:active
          background-position: -383px -36px
      .book-detal-title
        width: 93%
        margin: 28px auto
        text-align: center
        font-size: 34px
        color: #ffffff
        overflow: hidden
        white-space: nowrap
        text-overflow: ellipsis
        -webkit-font-smoothing: antialiased
      .white-board
        position: relative
        width: 780px
        height: 394px
        display: inline-block
        background-image: url('../../../img/digireader/whiteboard.png')
        background-repeat: no-repeat
        background-size: 100% 100%
        .book-box
          background-image: url('../../../img/digireader/reader_spirit.png')
          background-size: 1117px
          background-repeat: no-repeat
          background-position: -729px 0px
          position: absolute
          width: 275px
          height: 330px
          top: 35px
          left: 48px
          img
            width: 259px
            height: 290px
            position: absolute
            top: 0
            right: 0
          .book-marker
            COMMON_BACKGROUND_IMG()
            position: absolute
            bottom: 2px
            left: 26px
            &.book-marker-no-content
              width: 28px
              height: 15px
              background-position: -43px -5px
              bottom: 4px
              left: 13px
            &.book-marker-math
              width: 28px
              height: 26px
              background-position: -332px 0
            &.book-marker-science
              width: 28px
              height: 26px
              background-position: -296px 0
            &.book-marker-social
              width: 28px
              height: 26px
              background-position: -368px 0
        .book-intro
          position: absolute
          top: 28px
          right: 42px
          width: 382px
          height: 271px
          overflow-y: auto
          &::-webkit-scrollbar
            width: 5px
          &::-webkit-scrollbar-thumb  
            border-radius: 999px
            background: rgba(0,0,0,0.2);
          .book-intro-title
            font-size: 28px
            font-weight: 500
            text-align: center
            color: #555555
            margin: 0px 0 7px 0
          .book-intro-content
            font-size: 20px
            color: #555555
            text-align: justify
            line-height: 1.4em
        .book-detail-button-container
          position: absolute
          bottom: 19px
          right: 48px
          width: 382px
          text-align: center
          .borrow-button
            COMMON_BACKGROUND_IMG()
            width: 159px
            height: 53px
            line-height: 53px
            text-align: center
            background-position: -1px -480px
            margin: 0 auto
            cursor: pointer
            color: white
            font-size: 20px
            &:hover
              background-position: -162px -480px
            &:active
              background-position: -323px -483px
            &.grey
              cursor: not-allowed
              background-position: 0px -692px
              width: 160px
          .borrow-text
            font-size: 12px
            margin-top: 5px
            .grey
              display: inline
              color: #666666
            .orange
              display: inline
              color: #ff6600
              margin-left: 23px
  .success-borrow-toast
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    z-index: 222
    .black-mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background-color: rgba(0, 0, 0, 0.6)
    .reader-toast
      position: absolute
      top: 50%
      left: 50%
      width: 372px
      margin-top: -76px
      margin-left: -185px
  </style>
<script>
  import myDialog from "../common/dialog.vue"
  import axios from 'axios'
  import cookies from 'cookies-js'
  import utils from '../../../utils/_untils.js'
  import { $get, $post, $all } from '../api.js'

  const studentId = cookies.get('studentId')
  export default {
    data() {
      return {
        isBookDetailShow: this.isBookDetailShowProp,
        isShowDialog: false,
        isMaskShow: false,
        isToastShow: false,
        pending: false,
        isNoPosToastShow: false,
        isNoInventoryToastShow: false
      }
    },
    components: {
      myDialog
    },
    props: ['isBookDetailShowProp', 'bookDetailDataProp', 'numberOfStudentBorrow_'],
    mounted(){
      
    },
    methods: {
      showBorrowOkToast() {
        this.isMaskShow = true
        this.$nextTick(()=>{
          this.isToastShow = true
        })
        setTimeout(()=> {
          this.$router.push({ path: '/myBookshelf' })
        }, 2000)
      },
      showBorrowFailToast() {
        if( !this.IS_IN_IPAD_APP ) return
        this.isMaskShow = true
        this.$nextTick(()=>{
          if(this.bookDetailDataProp.stockAvailable <= 0) {
            this.isNoInventoryToastShow = true
          } else if(this.numberOfStudentBorrow_ >= 3) {
            this.isNoPosToastShow = true
          }
        })
        setTimeout(()=> {
          this.isNoInventoryToastShow = false
          this.isNoPosToastShow = false
          setTimeout(()=> {
            this.isMaskShow = false
          }, 500)
        }, 1000)
      },
      confirmBorrowBook() {
        if( this.IS_IN_IPAD_APP ) {
          utils.clickEvent(cookies.get('studentId'), 
            this.bookDetailDataProp.id, 
            utils.clickEventConst.IPAD, 
            utils.clickEventConst.CLICK_BORROW_BUTTON, 
            null, null)
        } else {
          utils.clickEvent(cookies.get('studentId'), 
            this.bookDetailDataProp.id, 
            utils.clickEventConst.PC, 
            utils.clickEventConst.CLICK_BORROW_BUTTON, 
            null, null)
        }
        this.isShowDialog = true
      },
      borrowBook(bookId, code) {
        var url = '/api/pc/service/digitlib/borrowBook/'+ cookies.get('studentId') +'/'+ bookId + '/' + code
        if(!this.pending) {
          this.pending = true
          $post(url).then((res) => {
            this.pending = false
            if(res.data.code == 200) {
              this.showBorrowOkToast()
            } else {
              alert(res.data.msg)
              window.location.reload(true)
            }
          }).catch((err) => {
            this.pending = false
          })
        }
      },
      cancelDialog(){
        this.isShowDialog = !this.isShowDialog
      },
      dispathEventAndClose(event, arg='') {
        this.$emit(event,arg,this.bookid)
      },
      closeThisLayer() {
        this.isBookDetailShow = false
        this.$emit('bookDetailSwitch')
      }
    },
    watch: {
      isBookDetailShowProp(curVal, oldVal) {
        this.isBookDetailShow = curVal
      }
    }
  }
</script>