<template lang="jade">
  .book_detail_dialog_wrapper(v-if="isBookDetailShow")
    .black-mirror(@click="closeThisLayer")
    .book-detail-box
      .close-btn(@click="closeThisLayer")
      .book-detal-title {{bookDetailDataProp.name}}
      .white-board
        .book-box
          img(:src="bookDetailDataProp.coverResUrl")
          .book-marker.book-marker-no-content
        .book-intro
          .book-intro-title Information
          .book-intro-content(v-html="bookDetailDataProp.description")                                                               
        .book-detail-button-container
          .button-box
            .go-read-button(@click="goReadingBook(bookDetailDataProp.id)") Begin
            .return-book-button(@click="confirmReturnBook") Return Now
          .borrow-text
            .progress-container
              .progress-bg
                .progress(v-if="bookDetailDataProp.pageCount != 0", :style="{width: (parseInt(bookDetailDataProp.currentPage)/parseInt(bookDetailDataProp.pageCount)) * 100 + '%'}")
                .progress(v-else, style="width: 0%")
              .progress-percent(v-if="bookDetailDataProp.pageCount != 0") {{ parseInt( parseInt(bookDetailDataProp.currentPage) / parseInt(bookDetailDataProp.pageCount) * 100 ) }}%
              .progress-percent(v-else) 0%
            span(:class="[isLessThan20Mins ? 'orange' : 'grey']") 剩余阅读时间:{{ countDown(bookDetailDataProp.scheduleReturnTime, bookDetailDataProp.serverTime) }}
    .success-borrow-toast(v-if="isMaskShow")
      .black-mask(v-if="isMaskShow")
      transition(enter-active-class="animated bounceIn", leave-active-class="animated bounceOut")
        img.reader-toast(src="../../../img/digireader/reader-totast@2x.png", v-show="isToastShow")
</template>
<style lang="stylus" scoped>
  *
    -webkit-font-smoothing: antialiased
  SPIRIT_PIC_WIDTH = 1430px / 2 
  COMMON_BACKGROUND_IMG()
    background-image: url('../../../img/digireader/reader_spirit.png')
    background-size: SPIRIT_PIC_WIDTH
    background-repeat: no-repeat
  .book_detail_dialog_wrapper
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    z-index: 22
    .black-mirror
      position: fixed
      top: 0
      bottom: 0
      left: 0
      right: 0
      z-index: 20
      width: 100%
      height: 100%
      background-color: rgba(0, 0, 0, 0.6)
    .book-detail-box
      position: absolute
      z-index: 22
      top: 50%
      left: 50%
      margin-top: -255px
      margin-left: -405px
      display: inline-block
      width: 810px
      height: 510px
      box-sizing: border-box
      background-color: #a18ee3
      border-radius: 18px
      box-shadow: 3px 2px 14px 0 #36185c
      text-align: center
      .close-btn
        position: absolute
        top: -10px
        right: -10px
        display:inline-block
        width: 40px
        height: 40px
        cursor: pointer
        background-position: -292px -36px
        COMMON_BACKGROUND_IMG()
        &:hover
          background-position: -337px -35px
        &:active
          background-position: -383px -36px
      .book-detal-title
        width: 93%
        margin: 28px auto
        text-align: center
        font-size: 34px
        color: #ffffff
        overflow: hidden
        white-space: nowrap
        text-overflow: ellipsis
        -webkit-font-smoothing: antialiased
      .white-board
        position: relative
        width: 780px
        height: 394px
        display: inline-block
        background-image: url('../../../img/digireader/whiteboard.png')
        background-repeat: no-repeat
        background-size: 100% 100%
        .book-box
          background-image: url('../../../img/digireader/reader_spirit.png')
          background-size: 1117px
          background-repeat: no-repeat
          background-position: -729px 0px
          position: absolute
          width: 275px
          height: 330px
          top: 35px
          left: 48px
          img
            width: 259px
            height: 290px
            position: absolute
            top: 0
            right: 0
          .book-marker
            COMMON_BACKGROUND_IMG()
            position: absolute
            bottom: 2px
            left: 26px
            &.book-marker-no-content
              width: 28px
              height: 15px
              background-position: -43px -5px
              bottom: 4px
              left: 13px
            &.book-marker-math
              width: 28px
              height: 26px
              background-position: -332px 0
            &.book-marker-science
              width: 28px
              height: 26px
              background-position: -296px 0
            &.book-marker-social
              width: 28px
              height: 26px
              background-position: -368px 0
        .book-intro
          position: absolute
          top: 32px
          right: 42px
          width: 382px
          height: 253px
          overflow-y: auto
          &::-webkit-scrollbar
            width: 5px
          &::-webkit-scrollbar-thumb  
            border-radius: 999px
            background: rgba(0,0,0,0.2)
          .book-intro-title
            font-size: 28px
            font-weight: 500
            text-align: center
            color: #555555
            margin: 0px 0 12px 0
          .book-intro-content
            font-size: 20px
            color: #555555
            text-align: justify
            line-height: 1.4em
        .book-detail-button-container
          position: absolute
          bottom: 23px
          right: 48px
          width: 382px
          text-align: center
          .go-read-button
            COMMON_BACKGROUND_IMG()
            width: 159px
            height: 53px
            line-height: 53px
            text-align: center
            background-position: -1px -481px
            margin: 0 auto
            cursor: pointer
            color: white
            font-size: 20px
            display: inline-block
            vertical-align: middle
            margin-right: 40px
            &:hover
              background-position: -162px -481px
            &:active
              background-position: -323px -483px
          .return-book-button
            COMMON_BACKGROUND_IMG()
            width: 160px
            height: 50px
            line-height: 50px
            text-align: center
            background-position: 0px -594px
            margin: 0 auto
            cursor: pointer
            color: white
            font-size: 20px
            display: inline-block
            vertical-align: middle
            &:hover
              background-position: -163px -593px
            &:active
              background-position: -327px -592px
          .borrow-text
            font-size: 12px
            margin-top: 5px
            text-align: left
            span
              width: 160px
              text-align: center
              display: inline-block
              vertical-align: middle
              &.grey
                color: #666666
              &.orange
                color: #ff6600
            .progress-container
              width: 210px
              margin-top: 3px
              display: inline-block
              vertical-align: middle
              padding-left: 22px
              box-sizing: border-box
              .progress-bg
                position: relative
                width: 110px
                height: 4px
                background-color: #ffddc6
                border-radius: 99px
                display: inline-block
                vertical-align: middle
                .progress
                  position: absolute
                  height: 4px
                  top: 0
                  left: 0
                  background-color: #ff6600
                  border-radius: 99px
              .progress-percent
                color: #ff6600
                font-size: 14px
                display: inline-block
                vertical-align: middle
                margin-left: 12px
  .success-borrow-toast
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    z-index: 222
    .black-mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background-color: rgba(0, 0, 0, 0.6)
    .reader-toast
      position: absolute
      top: 50%
      left: 50%
      width: 372px
      margin-top: -76px
      margin-left: -185px
      z-index: 222
  </style>
<script>
  import myDialog from "../common/dialog.vue"
  import axios from 'axios'
  import cookies from 'cookies-js'
  import { $get, $post, $all } from '../api.js'

  const studentId = cookies.get('studentId')
  export default {
    data() {
      return {
        isBookDetailShow: this.isBookDetailShowProp,
        isShowDialog: false,
        isMaskShow: false,
        isToastShow: false,
        scheduleReturnTime: 0,
        serverTime: 0,
        isLessThan20Mins: false
      }
    },
    components: {
      myDialog
    },
    props: ['isBookDetailShowProp', 'bookDetailDataProp'],
    mounted(){
    },
    methods: {
      countDown(scheduleReturnTime, serverTime) {
        var secLeft = parseInt( (scheduleReturnTime - serverTime) / 1000 )
        var days,hours,mins
        days = parseInt( secLeft / 86400 )
        hours = parseInt( secLeft / 3600 )
        mins = parseInt( secLeft / 60 )
        if(mins <= 20) {
          this.isLessThan20Mins = true
        }
        return (days ? days + '天' : hours ? hours + '小时' : mins ? mins + '分' : secLeft + '秒')
      },
      confirmReturnBook() {
        this.$emit('returnBookBUS', this.bookDetailDataProp.id, this.bookDetailDataProp.code)
      },
      goReadingBook(id) {
        if( this.IS_IN_IPAD_APP ) {
          window.location.href = 'http://' + window.location.host.replace(/lc/,'learning') + '/new/book/' + id + '/2'
        } else {
          window.location = '/book/' + id + '/2'
        }
      },
      confirmBorrowBook() {
        this.isShowDialog = true
      },
      cancelDialog(){
        this.isShowDialog = !this.isShowDialog
      },
      dispathEventAndClose(event, arg='') {
        this.$emit(event,arg,this.bookid)
      },
      closeThisLayer() {
        this.isBookDetailShow = false
        this.$emit('bookDetailSwitch')
      }
    },
    watch: {
      isBookDetailShowProp(curVal, oldVal) {
        this.isBookDetailShow = curVal
      }
    }
  }
</script>