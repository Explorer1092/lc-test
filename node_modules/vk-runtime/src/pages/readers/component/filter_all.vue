// to do 录音的选择还没有完成
<template lang="jade">
  .filter(v-show="isFilterShow")
    .black-mirror(@click="closeThisFilterWindow")
    my-dialog(tipText="确定要删除筛选条件吗？",
              type="confirm",
              title="Notice",
              isShowTitle=true,
              @library-dialog-cancel="cancelDialog",
              @library-dialog-confirm='deleteFilter',
              v-if="isShowDialog")
    .filter-wrap
      .filter-window
        .close-btn(@click="closeThisFilterWindow")
        .ok-btn(@click="confirmFilter") OK
        .reset-filter(@click="resetFilter")
          img(src="../../../img/library/reset_filter_btn.png")
          span 重置筛选
        .title 请选择筛选条件
        .expand-btn(:class="{'expanding': isExpandingAdvancedFilter}", @click="switchAdvancedFilter") {{AdvancedFilterSwitchText}}
        .filter-options-container
          .advanced-filter-wrap(v-show="isExpandingAdvancedFilter")
            .section-box
              p 系列
              .filter-options-box.seri
                .filter-item(v-for="item in filterData.types", @click = "item.isAvailable ? chooseItem(item.queryField, 'types') : null", :class="[{'selected': item.isCurrent}, item.isAvailable ? 'available' : 'disable']")
                  .box-table
                    .box-table-cell 
                      p {{item.nameEN}}
            .section-box
              p 蓝思值
              .filter-options-box.lexi
                template(v-for="item in filterData.lexile")
                  .filter-item(@click = "item.isAvailable ? chooseItem(item.queryField, 'lexiles') : null", :class="[{'selected': item.isCurrent}, item.isAvailable ? 'available' : 'disable']") {{item.nameEN}}
          .section-box
            p 功能
            .filter-options-box.feature
                .filter-item.double-line(
                   v-for="item in filterData.allowRepeats"
                   @click = "item.isAvailable ? chooseItem(item.queryField, 'allowRepeats') : null",
                   :class="[{'selected': item.isCurrent}, item.isAvailable ? 'available' : 'disable']"
                )
                  p {{item.nameCH}}
                  p {{item.nameEN}}
                   
          .section-box
            p 级别
            .filter-options-box.lev
              template(v-for="item in filterData.levels")
                .filter-item(@click = "item.isAvailable ? chooseItem(item.queryField, 'levels') : null", :class="[{'selected': item.isCurrent}, item.isAvailable ? 'available' : 'disable']") {{processLevelText(item.nameEN)}}
          .section-box
            p 全部阅读偏好
            .filter-options-box.fav
              .filter-item.double-line(v-for="item in filterData.tags", @click = "item.isAvailable ? chooseItem(item.queryTag, 'tags', item.queryField) : null", :class="[{'selected': item.isCurrent}, item.isAvailable ? 'available' : 'disable']")
                p {{item.nameCH}}
                p {{item.nameEN}}
</template>

<style lang="stylus" scoped>
*
  -moz-user-select: none
  -webkit-user-select: none
  -ms-user-select: none
  -khtml-user-select: none
  user-select: none
  -webkit-font-smoothing: antialiased
  -webkit-touch-callout: none
  .filter
    width: 100%
    height: 100%
    position: relative
    z-index: 19
    .black-mirror
      position: fixed
      top: 0
      bottom: 0
      left: 0
      right: 0
      z-index: 20
      width: 100%
      height: 100%
      background-color: rgba(0, 0, 0, 0.6)
    .filter-window
      position: absolute
      z-index: 21
      top: 50%
      left: 50%
      width: 885px
      height: 680px
      background: url('../../../img/library/modal-group-rivet@2x.png') no-repeat
      background-size: 100%
      margin: -340px 0 0 -442px
      .reset-filter
        position: absolute
        bottom: 45px
        left: 87px
        cursor: pointer
        color: #8C6ED8
        font-size: 18px
        img
          width: 28px
          display: inline-block
          vertical-align: bottom
          transition: all 0.5s
        &:hover
          img
            transform: rotateZ(180deg)
        span
          margin-left: 10px
          display: inline-block
          vertical-align: bottom

      .ok-btn
        position: absolute
        z-index: 1
        bottom: 20px
        left: 368px
        background: url('../../../img/library/filter-ok-btn.png') no-repeat
        background-position: 0 0
        background-size: 160px
        width: 160px
        height: 58px
        line-height: 52px
        cursor: pointer
        text-align: center
        color: white
        font-size: 22px
        &:hover
          opacity: 0.6
      .close-btn
        position: absolute
        z-index: 1
        top: -10px
        right: -10px
        background: url('../../../img/common/close-btn-sprite.png') no-repeat
        background-size: 150px 40px
        background-position: 0 0
        width: 40px
        height: 40px
        cursor: pointer
        &:hover
          background-position: -55px 0
        &:active
          background-position: -110px 0
          
      .title
        font-size: 24px
        font-weight: 600
        text-align: center
        color: #ffffff
        line-height: 77px
        letter-spacing: 2px
      .expand-btn
        position: absolute
        top: 93px
        right: 111px
        font-size: 20px
        color: #8c6ed8
        cursor: pointer
        &:hover
          opacity: 0.8
        &:after
          content: ''
          width: 12px
          height: 12px
          position: absolute
          top: 4px
          right: -32px
          border: 2px solid #8c6ed8
          border-bottom-color: transparent
          border-right-color: transparent
          transform: rotate(-45deg) rotateX(180deg)
          transition: all 200ms ease-out
        &.expanding:after
          top: 10px
          transform: rotate(45deg)
      .filter-options-container
        width: 757px
        height: 420px
        position: absolute
        top: 127px
        left: 69px
        overflow-y: auto
        &::-webkit-scrollbar
            border-radius: 29px
            width: 8px
            background-color: rgba(164, 135, 241, 0.2)
        &::-webkit-scrollbar-thumb
          border-radius: 29px
          width: 8px
          background-color: #b396ff
        p
          font-size: 16px
        .filter-options-box
          margin-left: 183px
          text-indent: -181px
          &.lexi
            .filter-item
              &:first-child
                background-image: url('../../../img/library/lexile.png')
          &.seri
            .filter-item
              &:first-child
                background-image: url('../../../img/library/type.png')
          &.feature
            .filter-item
              &:first-child
                background-image: url('../../../img/library/funciton@2x.png')
          &.lev
            .filter-item
              &:first-child
                background-image: url('../../../img/library/level-icon.png')
          &.fav
            .filter-item
              &:first-child
                background-image: url('../../../img/library/cate.png')
          .filter-item
            text-indent: 0
            width: 170px
            height: 40px
            line-height: 40px
            border-radius: 45px
            border: 1px solid #8c6ed8
            display: inline-block
            vertical-align: middle
            margin: 10px 5px
            text-align: center
            color: #8c6ed8
            box-sizing: border-box
            .box-table
              display: table
              height: 100%
              width: 100%
              text-align: center
              .box-table-cell
                display: table-cell
                line-height: 14px
                vertical-align: middle
            &.double-line
               line-height: 16px
               padding-top: 3px
              p
                font-size: 14px
                width: 86%
                overflow: hidden
                display: inline-block
            &:first-child
              margin: 10px 10px 10px 0px
              background-size: 30px 30px
              padding-left: 10px
              background-position: 6px 5px
              background-repeat: no-repeat
            &:hover
              border-color: #DCD3F3
              background-color: #DCD3F3
              color: #8C6ED8
            &.available
              cursor: pointer
              &:hover
                border-color: #DCD3F3
                background-color: #DCD3F3
                color: #8C6ED8
              &.selected
                color: white !important
                border: 1px solid #8c6ed8
                background-color: #8c6ed8
            &.disable
              border: 1px solid #eeeeee
              color: #eee
              cursor: not-allowed
              background-color: transparent
            
              

</style>

<script>
import myDialog from "../common/dialog.vue"
import utils from '../../../utils/_untils.js'
import Velocity from 'velocity-animate'
import cookies from 'cookies-js'
import axios from 'axios'
export default {
  data() {
    return {
      isShowDialog: false,
      isFilterShow: true,
      isExpandingAdvancedFilter: false,
      AdvancedFilterSwitchText: '展开高级筛选',
      filterData: {
        types: [],
        lexile: [],
        levels: [],
        tags: [],
        allowRepeats:[] //功能 分为只能越，或者包括录音
      },
      filterSelectedPost: {
        types: [],
        lexileSections: [],
        levels: [],
        lastClickCategory: '',
        tags: [],
        allowRepeats:[]
      }, //此对象用于getCategoryFilterResult接口的请求
      filterSelectedGet: {
        types: '',
        lexileSections: '',
        tagNames: '',
        tags: '',
        feature:''
      }, //此对象用于getBookList接口的请求
      filterSelectedShowName: {
        levels: {nameEN: null, nameCH: null},
        lexiles: {nameEN: null, nameCH: null},
        types: {nameEN: null, nameCH: null},
        tags: {nameEN: null, nameCH: null},
        feature:{nameEN: null,nameCH:null},
        allowRepeats:{nameEN:null,nameCH:null}
      } //此对象用于显示在父级页面顶部
    }
  },
  components: {
    myDialog
  },
  props: ['currentLevelProp', 'currentTypeProp'],
  mounted() {
  },
  watch: {
    currentLevelProp(curVal, oldVal) {
      curVal ? this.filterSelectedPost.levels.push(curVal) : this.filterSelectedPost.levels = []
      this.filterSelectedPost.lastClickCategory = 'levels'
      this.filterSelectedGet.tagNames = curVal
      this.setFilter(true)
    },
    currentTypeProp(curVal, oldVal) {
      curVal ? this.filterSelectedPost.types.push(curVal) : this.filterSelectedPost.types = []
      this.filterSelectedPost.lastClickCategory = 'types'
      this.filterSelectedGet.types = curVal
      this.setFilter(true)
    }
  },
  methods: {
    processLevelText( text ) {
      let result = text.match(/\d/)
      if(result) {
        return 'Level ' + result.toString()
      } else {
        return text
      }
    },
    confirmFilter() {
      sa.track('learning_click', {'click_id': 'pc_learning_digital_library_confirm_filter'})
      this.$emit('getBookListByFilterEvent', this.filterSelectedGet)
      this.$emit('setFilterSelectedEvent', this.filterSelectedShowName)
      this.closeThisFilterWindow()
    },
    chooseItem(filterQuery, filterType, bookListQuery) {
      if(filterQuery == '[object Object]') {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_filter_' + bookListQuery})
      } else if(filterQuery == '' || filterQuery == null ) {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_filter_all'})
      } else {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_filter_' + filterQuery})
      }
      /*
       * @filterQuery 当为‘all‘时，此字段为空。为空即为选择“all”
      */
      switch(filterType) {
      case 'types':
        this.filterSelectedPost.types = []
        filterQuery ? this.filterSelectedPost.types.push(filterQuery) : this.filterSelectedPost.types = []
        this.filterSelectedPost.lastClickCategory = filterType
        this.filterSelectedGet.types = filterQuery
        break
      case 'lexiles':
        this.filterSelectedPost.lexileSections = []
        filterQuery ? this.filterSelectedPost.lexileSections.push(filterQuery) : this.filterSelectedPost.lexileSections = []
        this.filterSelectedPost.lastClickCategory = filterType
        this.filterSelectedGet.lexileSections = filterQuery
        break
      case 'levels':
        this.filterSelectedPost.levels = []
        filterQuery ? this.filterSelectedPost.levels.push(filterQuery) : this.filterSelectedPost.levels = []
        this.filterSelectedPost.lastClickCategory = filterType
        this.filterSelectedGet.tagNames = filterQuery //过滤level的字段是tagNames
        break
      case 'tags':
        this.filterSelectedPost.tags = []
        filterQuery ? this.filterSelectedPost.tags.push(filterQuery) : this.filterSelectedPost.tags = []
        this.filterSelectedPost.lastClickCategory = filterType
        this.filterSelectedGet.tags = bookListQuery
        break
      case 'allowRepeats':
        this.filterSelectedPost.allowRepeats = []
        filterQuery ? this.filterSelectedPost.allowRepeats.push(filterQuery) : this.filterSelectedPost.allowRepeats = []
        this.filterSelectedPost.lastClickCategory = filterType
        this.filterSelectedGet.allowRepeats = filterQuery
        break
      }
      this.$nextTick(() => {
        this.setFilter()
      })
    },
    resetFilter() {
      for(let key in this.filterSelectedPost) {
        if(key == 'lastClickCategory') {
          this.filterSelectedPost[key] = ''
        } else {
          this.filterSelectedPost[key] = []
        }
      }
      for(let key in this.filterSelectedGet) {
        this.filterSelectedGet[key] = ''
      }
      this.setFilter(true)
    },
    setFilter(flag) {
      axios.post(`/rest/learninggw/api/pc/service/digitlib/getCategoryFilterResult?studentId=${cookies.get('studentId')}`, this.filterSelectedPost).then((res) => {
        let data = res.data.data
        this.filterData.types = data.types
        this.filterData.lexile = data.lexiles
        this.filterData.levels = data.levels
        this.filterData.tags = data.tags
        this.filterData.allowRepeats = data.allowRepeats
        for(let i in data) {
          if(data[i]) {
            for( let j = 0; j < data[i].length; j++ ) {
              if(data[i][j].isCurrent == 1) {
                this.filterSelectedShowName[i].nameEN = data[i][j].nameEN
                this.filterSelectedShowName[i].nameCH = data[i][j].nameCH
              }
            }
          }
        }
        if(flag) {
          this.$emit('setFilterSelectedEvent', this.filterSelectedShowName)
        }
      })
    },
    cancelDialog(){
      this.isShowDialog = !this.isShowDialog
    },
    deleteFilter() {
    },
    closeThisFilterWindow() {
      this.$emit('closeFilterEvent')
    },
    switchAdvancedFilter() {
      sa.track('learning_click', {'click_id': 'pc_learning_digital_library_toggle_advanced_options'})
      this.isExpandingAdvancedFilter = !this.isExpandingAdvancedFilter
      this.AdvancedFilterSwitchText = this.isExpandingAdvancedFilter ? '收起高级筛选' : '展开高级筛选'
    }
  }
}
</script>
