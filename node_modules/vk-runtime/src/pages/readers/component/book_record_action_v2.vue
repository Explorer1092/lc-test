<template lang="jade">
  .book-record-action
      my-dialog(
        :tipText="noticeText",
        :confirmButton="'知道了'",
        :type="'alert'",
        title="Notice",
        isShowTitle = true,
        :isShowCloseButton='false',
        @library-dialog-cancel="closeDialog()",
        v-show="showDialog"
      )
      audio(ref="recordAudio", v-show="false", :src="audioUrl", @ended="endAudioPlay()")
      .listem.left(data-list="1", v-show="recordCurrentData[0].canRecord")
         .record.left(data-index="1", @click="controlRecord(1)")
           .record-to-start(v-show="!leftIsRecord", :class="{refuseRecord: rightIsRecord || originAudioPlaying || audioPlaying}")
           .record-processing(v-show="leftIsRecord")
              svg(width="80", height="80", viewbox="0 0 80 80")
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.1)" fill="none")
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.8)" fill="none"
                  transform="matrix(0,-1,1,0,0,80)"
                  stroke-dasharray="0 1069"
                  ref="circleLfet")
              .record-middle
         .play.left(data-index=1, ref="leftRecordPlayButton", v-show="showLeftPlay && !leftIsRecord", :class="{playOn:leftIsPlaying, playOff:!leftIsPlaying, refusePlay: rightIsRecord || originAudioPlaying}", @click="controlAudio(1)")
         .score.left(v-show="showLeftScore && !leftIsRecord", :class="leftScoreFlag")
            .score-text {{leftPageScore}}
      .listem.right(data-list="2", v-show="recordCurrentData[1].canRecord")
         .record.right(data-index="2", @click="controlRecord(2)")
           .record-to-start(v-show="!rightIsRecord", :class="{refuseRecord: leftIsRecord || originAudioPlaying || audioPlaying}")
           .record-processing(v-show="rightIsRecord")
              svg(width="80", height="80", viewbox="0 0 80 80")
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.1)" fill="none")
                circle(cx="40" cy="40" r="30" stroke-width="18" stroke="rgba(255,182,0,0.8)" fill="none"
                  transform="matrix(0,-1,1,0,0,80)"
                  stroke-dasharray="0 1069"
                  ref="circleRight")
              .record-middle
         .play.right(data-index=2, ref="rightRecordPlayButton", v-show="showRightPlay && !rightIsRecord", :class="{playOn:rightIsPlaying, playOff:!rightIsPlaying, refusePlay: leftIsRecord || originAudioPlaying}", @click="controlAudio(2)")
         .score.right(v-show="showRightScore && !rightIsRecord", :class="rightScoreFlag")
           .score-text {{rightPageScore}}
      .dialogBody
         #recorder
</template>
<script>
import myDialog from "./../common/dialog.vue"
import cookie from "cookies-js"
import VKEvaluater from "evaluater-vkm"
import VVOS from "vvos-js"

export default {
  data(){
    return {
      // New: jcy add begin
      // 书本数据
      studentId: parseInt(cookie.get("studentId")),
      bookId: parseInt(this.$route.params.id),
      bookCode: this.$route.params.bookCode,
      currentPage: 0, 
      originAudioPlaying: false, // 书籍的原音频的播放状态 default: false
      // 标记状态 -> 左页
      leftIsRecord: false, // 左页是否处在录音状态 -> 控制 Record 按钮的显示效果
      showLeftScore: false, // 左页 -> 分数 显示否
      leftScoreFlag: 'normal', // 左页 -> 分为 bad ,normal good ,excellent 四个等级
      showLeftPlay: false, // 左页 -> 播放录音的按钮 显示否
      leftIsPlaying: false, // 左页 -> 正在播放音频 否
      leftPageScore: 0, // 左页 -> 分数
      leftPageRecordBuff: null, // 左页 -> 的录音文件
      leftPageRecordBuffUrl: '', // 左页 -> 录音文件BlobUrl
      // 标记状态 -> 右页
      rightIsRecord:false, // 右页是否处在录音状态 -> 控制 Record 按钮的显示效果
      showRightScore: false, // 右页 -> 分数 显示否
      rightScoreFlag:'bad', // 右页 -> 分为 bad ,normal good ,excellent 四个等级
      showRightPlay: false, // 右页 -> 播放录音的按钮 显示否
      rightIsPlaying: false, // 右页 -> 正在播放音频 否
      rightPageScore: 0, // 右页 -> 分数
      rightPageRecordBuff: null,//右侧的录音文件
      rightPageRecordBuffUrl: '', //右侧录音文件的BlobUrl
      // audio 数据
      recordAudio: null, // 播放音频的设备
      audioUrl: '', // 音频的播放 url
      currentAudioIndex: 1, // 播放音频的当前索引值 左侧：1， 右侧：1
      audioPlaying: false, // 录音的播放 状态，false:音频播放结束，true: 音频正在播放中 ing...
      // record 数据
      evaluater: null, // 评分 SDK
      evaluaterReady: false, // 已准备待续
      isRecordFailed: false, // 录音失败 的状态，与弹窗的显示否 相关
      recordText:'', // 录音时，书页的文本数据
      recordStartTime: 0, // 录音开始时间
      recordEndTime: 0, // 录音结束时间
      recordResult: null, // 录制音频后的结果
      recordingTimer: null, // recording 时的, 动画 interval timer
      uploadingTimer: null, // uploading 时的，动画 interval timer
      currentRecordIndex: 1, // 录音书页的当前索引值 左侧：1，右侧：2
      currentPageScore: 0, // 当前页的录音得分
      currentRecordBuff: '', // 当前录音后取的 音频 Buff文件
      currentAudioUrl: '', // 当前录音后取得的 audio  url
      outTimeTimer: null, // 记录录音超时的 timer
      outTime: 35000, // 超时的时长 35s
      // 阶段状态
      recording: false, // 录制音频的状态 false:录制结束，true: 正在录制
      recordResultReceiving: false, // 录音结果获取中
      uploading: false, // 录音结果上传中
      // 录音数据上传
      leftUpSuccess:false,
      rightUpSuccess:false,
      // dialog
      noticeText: '录音失败，请稍后重试',
      noticeBox: {
        recordFailed: '录音失败，请稍后重试',
        recordTimeout: '宝贝录音评分超时<br>尝试重新录制',
        netWorkException: '网络服务存在异常<br>请稍后重试',
        uploadFailed: '录音上传失败，请稍后重试'
      },
      dialogType: 1, // 1:关闭dialog时，不重载组件 2：关闭dialog时，重载组件
      showDialog: false, // 是否显示弹出框
      // 上传 VVOS 所需数据
      indexOfRecords: 0,// 当前这个录音，在所有录音序列中的 索引值
      workScoreMap: null, // 传给VVOS 的单个单词的 评分数据，格式 [{"word":???, "score":???}，......]
      scoreSegment: "0,0,0,0" // 穿给VVOS 的分数系统，字符串，格式 'score1, score2, score3, ......'
    }
  },
  components:{
    myDialog
  },
  props:{
    recordCurrentPages:{
      type:Number,
      default:0
    },
    dudSummaryId:{
      type:Number,
      default:0
    },
    pageCount:{
      type:Number,
      default:0
    },
    currentPlayingElement: null,
    recordCurrentData:{
      type:Array,
      default:function(){
        return [
          {
            text:'',
            index:1,
            duration:0,
            pageMapQueue:1,
            canRecord:false,
            direction:"left"
          },
          {
            text:'',
            index:1,
            duration:0,
            pageMapQueue:2,
            canRecord:false,
            direction:"right"
          }
        ]
      }
    }
  },
  watch:{
    currentPlayingElement: function(val) {
      this.originAudioPlaying = Boolean(val)
    },
    // 当 recordCurrentPages变化时, 也就是翻页时
    recordCurrentPages:function(val){
      // 书籍原音频播放状态 设为false
      this.originAudioPlaying = false
      // 处理书页录音 tools 
      let leftData = this.recordCurrentData[0]
      let rightData = this.recordCurrentData[1]
      this.handRecordTools(1, leftData.score, leftData.playUrl)
      this.handRecordTools(2, rightData.score, rightData.playUrl)
    },
    // 监听 recordResult 变化
    recordResult: function(newVal, oldVal) {
      this.handleRecordResult()
    },
    // 监听 录音的播放 状态
    audioPlaying: function(val) {
      this.coordinateTurnBtns()
    },
    // 监听 录音录音进行中 状态
    recording: function(val) {
      this.coordinateTurnBtns()
    },
    // 监听 录音结果获取中 状态
    recordResultReceiving: function(val) {
      this.coordinateTurnBtns()
    },
    // 监听 录音结果上传中 状态
    uploading: function(val) {
      this.coordinateTurnBtns()
    }
  },
  methods:{
    /************** START: UI 控制 *********************************************/
    // Mth: 调整，正处在播放音频 或 录制音频过程中时，不许允许翻页动作，也就是不显示翻页按钮
    coordinateTurnBtns() {
      if (this.audioPlaying || this.recording || this.recordResultReceiving || this.uploading) {
        this.$emit('coordinateTurnBtns', false)
      } else {
        this.$emit('coordinateTurnBtns', true)
      }
    },
    // Mth: 录音 && 播放音频 && 分数显示，的集中控制器
    handRecordTools(index, score, audioUrl) {
      switch(index){
      case 1: // 左侧 录音播放按钮 & 分数
        if (score !== false) {
          this.showLeftPlay = true
          this.showLeftScore = true
          this.leftPageScore = score
          this.setScoreFlag(1, score)
          this.leftPageRecordBuffUrl = audioUrl
        } else {
          this.showLeftPlay = false
          this.showLeftScore = false
        }
        break
      case 2: // 右侧 录音播放按钮 & 分数
        if (score !== false) {
          this.showRightPlay = true
          this.showRightScore = true
          this.rightPageScore = score
          this.setScoreFlag(2, score)
          this.rightPageRecordBuffUrl = audioUrl
        } else {
          this.showRightPlay = false
          this.showRightScore = false
        }
        break
      }
    },
    // Mth: 设置 分数的 flag
    setScoreFlag(index, score) {
      // 选择 分数的主题
      let flag = ''
      if (score <= 55) {
        flag = "bad"
      } else if(score <= 70){
        flag = "normal"
      } else if(score <= 85) {
        flag = "good"
      } else if(score <= 100){
        flag = "excellent"
      }
      // 设置 分数主题
      index === 1 && (this.leftScoreFlag = flag) // 设置 左侧页 scroe 主题
      index === 2 && (this.rightScoreFlag = flag) // 设置 右侧页 score 主题
    },
    // Mth：开始 record circle process 动画 
    startCircleProcess() {
      let duration = this.recordCurrentData[this.currentRecordIndex - 1].duration // 获取录音所需时长，根据原音频进行设置
      let start = 0
      let circle = null
      let perimeter = Math.PI * 2 * 30
      // 选择 circle UI
      this.currentRecordIndex === 1 && (circle = this.$refs.circleLfet)
      this.currentRecordIndex === 2 && (circle = this.$refs.circleRight)
      // 动画开始
      this.recordingTimer = setInterval(()=>{
        start += 100
        let percent = start / duration
        circle.setAttribute('stroke-dasharray', perimeter * percent + " " + perimeter * (1- percent))
        percent >= 1 && this.endRecord() // 当占比 大于 1时，结束 录音
      },100)
    },
    // Mth：清除 record circle process 动画 
    clearCircleProcess(){
      // 定义变量
      let start = 0
      let percent = 0
      let circle = null
      let perimeter = Math.PI * 2 * 70
      // 选择 circle UI
      this.currentRecordIndex === 1 && (circle = this.$refs.circleLfet)
      this.currentRecordIndex === 2 && (circle = this.$refs.circleRight)
      // 动画结束，即录制按钮的外边框 周长为 0
      circle.setAttribute("stroke-dasharray", perimeter * percent + " " + perimeter * (1- percent))
    },
    /************** END: UI 控制 *********************************************/
    /************** START: loading && dialog *********************************************/
    // Mth: 显示全屏loading 
    showFullLoading() {
      this.$emit("showScoreLayer") // 显示全屏loading 
    },
    // Mth: 关闭全屏loading
    closeFullLoading() {
      this.$emit("closeScoreLayer") // 关闭全屏loading
    },
    // Mth: 显示 dialog （提示信息，dialog类型）
    openDialog(noticText, dialogType) {
      noticText = noticText || '出现错误，请稍后重试' // 默认：提示信息
      dialogType = dialogType || 2 // 默认：2
      this.noticeText = noticText // 设置提示框中的 提示信息文本
      this.dialogType = dialogType // 1:关闭dialog时，不重载组件 2：关闭dialog时，重载组件
      this.showDialog = true //  显示弹窗, 点击按钮后，重新准备录制
    },
    // Mth: 关闭 dialog
    closeDialog() {
      this.dialogType === 1 && (this.showDialog = false)
      this.dialogType === 2 && (this.showDialog = false, this.$router.go(0)) // 关闭 dialog， 并且重新加载页面
    },
    /************** END: loading && dialog *********************************************/
    /************** START: 计时器 *********************************************/
    // Mth: 记录录音的超时，开始，（录音超时第二道防线）
    startOutTimeTimer() {
      this.outTimeTimer = setTimeout(() => {
        this.evaluater.close() // 销毁实例
        this.closeFullLoading() // 关闭屏loading
        // 弹出框提示
        this.openDialog(this.noticeBox.recordTimeout, 2) // （录音超时, 2)
        // 打点 评分超时
        sa.track('learning_click', {
          'click_id': 'pc_learning_video_record_get_score_timeout'
        })
        // 评分超时，超过 35s
      }, this.outTime)
    },
    // Mth: 主动取消 录音超时的记录
    endOutTimeTimer() {
      clearTimeout(this.outTimeTimer)
      this.outTimeTimer = null
    },
    /************** END: 计时器 *********************************************/
    /************** START: Audio 方法 *********************************************/
    // Mth: 初始化 Audio
    initAudio() {
      this.recordAudio = this.$refs.recordAudio
      this.recordAudio.pause()
    },
    // Mth：播放录音功能 控制器 
    controlAudio(index) {
      // 书籍的原音频的 处在播放状态 时，阻止点击 播放录音按钮
      if (this.originAudioPlaying) return
      // 处在录音状态时，阻止点击 播放录音按钮
      if (this.recording) return
      // 在接收 智能语音平台返回结果过程中，阻止点击 播放录音按钮
      if (this.recordResultReceiving) return 
      // 在 录音数据上传到 vvos 过程中，阻止点击 播放录音按钮
      if (this.uploading) return 
      // 在上传的动画进行中，阻止点击 播放录音按钮
      if (this.uploadingTimer) return 

      // index 存在，且(&&) 为数字 时
      if (typeof index === 'number') {
        // 点击当前播放音频按钮 时
        if (this.currentAudioIndex === index) {
          this.audioPlaying ? this.endAudioPlay() : this.startAudioPlay()
        }
        // 点击另一页音频播放按钮 时
        else {
          this.audioPlaying && this.endAudioPlay()
          this.currentAudioIndex = index // 设置当前的索引值 为 index
          this.startAudioPlay()
        }
      }
      // index 不为数字，或者 没有index 时
      else {
        this.audioPlaying && this.endAudioPlay()
      }
    },
    // Mth: 录音播放 开始
    startAudioPlay() {
      this.audioPlaying = true // 录音播放中
      // 播放左侧页的音频
      if (this.currentAudioIndex === 1) {
        this.audioUrl = this.leftPageRecordBuffUrl // 设置 Audio URL
        this.leftIsPlaying = true // 左侧 音频调至 播放中 状态 
      }
      // 播放右侧页的录音 
      else {
        this.audioUrl = this.rightPageRecordBuffUrl // 设置 Audio URL
        this.rightIsPlaying = true
      }
      this.$nextTick(() => {
        this.recordAudio.play() // audio.play()
      })
    },
    // Mth：录音播放 结束
    endAudioPlay(){
      this.audioPlaying = false // 录音结束播放
      this.currentAudioIndex === 1 && (this.leftIsPlaying = false) // 左侧 音频调至 播放结束 状态 
      this.currentAudioIndex === 2 && (this.rightIsPlaying = false) // 右侧 音频调至 播放结束 状态 
      this.recordAudio.pause() // audio.pause()
      this.recordAudio.currentTime = 0 // 播放进度设为 0
    },
    /************** END: Audio 方法 *********************************************/
    /************** START: Record 方法 *********************************************/
    // Mth：初始化 evaluater, 智能语音云平台 SDK
    initEvaluater() {
      // 获取 智能语音平台SDK 相应信息 
      let getSdkInfo = () => {
        let envObj = {test: 'test', prod: 'prod'} // sdk 环境变量集合
        let appIdObj = { // appId 变量集合
          test: '53381bc0ab0f43b2a600da021b1e5107',
          prod: 'c1e35f6f1c7d46f5830b176ee1d975c5'
        }
        // 测试环境
        let env = envObj.test
        let appId = appIdObj.test
        // 线上环境的判断
        if (window.location.hostname === 'lc.vipkid.com.cn' || window.location.hostname === 'pre-lc.vipkid.com.cn' ) {
          env = envObj.prod
          appId = appIdObj.prod
        } 
        return {env: env, appId: appId}
      }
      // sdk 信息对象
      let sdk = getSdkInfo()  

      // 录音进程状态码说明
      let states = {
        NOT_READY: 1, // 未就绪
        CONNECTING: 2, // 链接中
        PREPARE_START: 3, // 已就绪
        AUDIO_RECORDING: 4, // 录音中
        RESULT_RECEIVING: 5, // 评测结果获取中
        RESULT_RECEIVED: 6, // 已获得评测结果（时刻）
        CLOSED: 7, // 服务已关闭
        INTERRUPTED: 8 // 录音被打断（来电、权限更改、耳机拔出、蓝牙切换等）（时刻）
      }
      // 初始化 VKEvaluater
      this.evaluater = new VKEvaluater({
        appId: sdk.appId, // appId
        env: sdk.env, // 测试环境：'test', Pre环境: 'pre', 线上环境：'prod' 
        onState: state => {
          switch (state.code) {
          case states.NOT_READY:
            // ##Evaluater 未就绪...
            break
          case states.CONNECTINGz:
            // ##Evaluater 连接中...
            break
          case states.PREPARE_START:
            // ##Evaluater 已就绪
            this.evaluaterReady = true // evaluater ready 状态设为 true
            break
          case states.AUDIO_RECORDING:
            // ##Evaluater 录音中...
            break
          case states.RESULT_RECEIVING:
            // ##评测结果获取中...
            break
          case states.RESULT_RECEIVED:
            // ##已获取评测结果...
            this.evaluaterReady = false // evaluater ready 状态设为 false
            this.recordResult = state.data // 取得录音评测的结果数据
            break
          case states.CLOSED:
            // ##服务已关闭...
            break
          case states.INTERRUPTED:
            // ##录音被打断...
            break
          default:
            // ##state.code 不存在，录音失败...
            break
          }
        },
        onError: err => {
          let errInfo = ''
          switch (err.code) {
          case 1000:
            errInfo = 'Error: code: 1000, 未知错误'
            break
          case 1101:
            errInfo = 'Error: code: 1101, 环境不支持WebSocket功能'
            break
          case 1102:
            errInfo = 'Error: code: 1102, 环境不支持录音功能'
            break
          case 1103:
            errInfo = 'Error: code: 1103, 无法获取录音权限'
            break
          case 1104:
            errInfo = 'Error: code: 1104, 服务无法连接'
            break
          case 1105:
            errInfo = 'Error: code: 1105, 服务连接超时'
            break
          case 1106:
            errInfo = 'Error: code: 1106, 网络异常'
            break
          case 1107:
            errInfo = 'Error: code: 1107, 认证失败，appId无效'
            break
          case 4001:
            errInfo = 'Error: code: 4001, 文本信息错误，包括必填项为空、类型错误等'
            break
          case 4002:
            errInfo = 'Error: code: 4002, 评测失败'
            break
          case 4003:
            errInfo = 'Error: code: 4003, 评测超时'
            break
          default:
            errInfo = 'Error: err.code不存在, 无法判断问题所在'
            break
          }
          this.handleRecordError(err, errInfo) // 处理错误结果
        }
      })
    },
    // LOGICAL：录音功能 控制器
    controlRecord(index) {
      // 书籍的原音频的 处在播放状态 时，阻止点击 录制按钮
      if (this.originAudioPlaying) return
      // 录音正在播放时，阻止点击 录制按钮
      if (this.audioPlaying) return
      // 在接收 智能语音平台返回结果过程中，阻止点击 录制按钮
      if (this.recordResultReceiving) return 
      // 在 录音数据上传到 vvos 过程中，阻止点击 录制按钮
      if (this.uploading) return 
      // 在上传的动画进行中，阻止点击 录制按钮
      if (this.uploadingTimer) return 
      // evaluater 未处在准备就绪状态，阻止点击 录制按钮
      if (!this.evaluaterReady) return

      // 点击 目标，为 左右页的录制 按钮时，1：左录音按钮 2：右录制按钮
      if (typeof index === 'number') {
        // 1. 点击当前录制按钮（正在录制的 or 上次录制的） 
        if (this.currentRecordIndex === index) {
          // 状态：正在录制中
          if (this.recording) {
            this.endRecord()
          }
          // 状态：一系列录制所必须得动作结束 or 还未开始录制 时
          else if (!this.recording && !this.recordResultReceiving && !this.uploading) {
            this.startRecord()
          }
        }
        // 2. 点击 另一个录制按钮时
        if (this.currentRecordIndex !== index) {
          if (!this.recording && !this.recordResultReceiving && !this.uploading) {
            this.currentRecordIndex = index
            this.startRecord()
          }
        }
      // 预留的其它调用方式。 如，在录音状态时不能播放音频等功能，可手动调用controlRecord() 【不传 index 参数，或者 typeof index 不为 'number'】
      } else {
        this.recording && this.endRecord()
      }
    },
    // Mth: 取得传递给 SDK 的参数
    getRecordParam() {
      // VKEvaluater 的参数模板
      let recordParamTemp = {
        refText: "hello world",
        textMode: 0,
        evalMode: 1, // 0: 单词，1：句子，2：段落
        rank: 100,
        receiveTimeout: 15000 // 规定，从录音结束到获得评测结果 所能持续的最长时间， 默认：5000 （录音超时第一道防线）
      }
      // 取得 refText的文本字符串信息
      let itemIndex = this.currentRecordIndex - 1 // 得到 recordCurrentData 数组中的 item 索引
      let refText = this.recordCurrentData[itemIndex].text // 绘本音频的文本字段内容
      let parseRefText = null
      try {
        parseRefText = JSON.parse(refText).text.toString()
      } catch(e) {
        parseRefText = JSON.parse(refText).toString()
      }
      // 设置 recordText 的值，这个值后期要作为值，存入 VVOS
      this.recordText = parseRefText 
      // 设置 recordParamTemp 的 refText 文本信息
      parseRefText && (recordParamTemp.refText = parseRefText) 
      // 返回 使用评分 SDK 所需要的参数
      return recordParamTemp
    },
    // Mth：开始录音
    startRecord() {
      this.recordStartTime = (new Date()).getTime() // 得到录音的开始时间
      this.currentRecordIndex === 1 && (this.leftIsRecord = true) // 1时，左侧录制按钮显示
      this.currentRecordIndex === 2 && (this.rightIsRecord = true) // 2时，右侧录制按钮显示
      this.startCircleProcess() // 开始 record circle process 动画
      // 开始录音
      this.recording = true // 录制状态设置为 true
      this.evaluater.start(this.getRecordParam()) 
    },
    // Mth：录音结束
    endRecord() {
      this.showFullLoading() // 显示全屏loading
      this.recordResultReceiving = true // 录音结果获取中
      this.currentRecordIndex === 1 && (this.leftIsRecord = false) // 1时，左侧录制按钮显示
      this.currentRecordIndex === 2 && (this.rightIsRecord = false) // 2时，右侧录制按钮显示
      this.clearCircleProcess() // 清除 record circle process 动画
      this.recordingTimer && ( clearInterval(this.recordingTimer), this.recordingTimer = null ) // clear recording interval timer
      // 开始监测录音， 录音超时计时器 打开
      this.startOutTimeTimer()
      // 停止录音
      this.recording = false // 录制状态设置为 false
      this.evaluater.stop() 
      // 打点
      sa.track('learning_click', {
        'click_id': 'pc_learning_video_record_start_get_score'
      })
    },
    // 处理 录制音频后 得到的录音结果
    handleRecordResult() {
      this.endOutTimeTimer() // 录音超时 监测计时器, 关闭
      this.currentPageScore = this.recordResult.overall // 句子评分 总分
      this.currentRecordBuff = this.recordResult.audioBlob // audio 的 Blob 文件
      this.currentAudioUrl = (window.URL || window.webkitURL).createObjectURL(this.currentRecordBuff) // Blob转成音频文件
      this.handRecordTools(this.currentRecordIndex, this.currentPageScore, this.currentAudioUrl) // 控制 Record 相关UI的设置
      this.recordEndTime = (new Date()).getTime() // 得到录音的结束时间
      this.recordResultReceiving = false // 录音结果获取 结束
      // 打点
      sa.track('learning_click', {
        'click_id': 'pc_learning_video_record_get_score_success'
      })
      sa.track('learning_click', {
        'click_id': 'pc_learning_video_record_up_file'
      })
      sa.track('learing_click',{
        'click_id': 'pc_learning_video_record_get_score_time',
        'qos': (this.reocordStarTime - this.recordEndTime) // 智能语音平台 返回接口的时间 ms 计数
      })
      // 上传录音数据
      this.uploadRecordBuff()
    },
    // 处理 录制音频后，SDK 返回结果失败
    handleRecordError(err, errInfo) {
      this.endOutTimeTimer() // 录音超时 监测计时器, 关闭
      this.recordResultReceiving = false // 状态设置：录音结果获取 结束
      // 关闭全屏 loading
      this.closeFullLoading()
      // 弹出框提示
      if (err.code === 4003) {
        this.openDialog(this.noticeBox.recordTimeout, 1) // 打开弹出框 （超时，1）
      } else if(err.code === 1000 || err.code === 1104 || err.code === 1105 || err === 1106) {
        this.openDialog(this.noticeBox.netWorkException, 2) // 打开弹出框 （网络服务异常，2）
      } else {
        this.openDialog(this.noticeBox.recordFailed, 1) // 打开弹出框 （录音失败，1）
      }
      // 打点：录音失败
      sa.track('learning_click', {
        'click_id': 'pc_learning_book_record_get_score_failed',
        'error_msg': JSON.stringify(err)
      })
      // 抛出错误信息
    },
    /************** END: Record 方法 *********************************************/
    /************** START: 操作 VVOS *********************************************/
    // Mth: redeay upload params
    getUploadParam() {
      let detailData = this.recordResult.details // 从 this.recordResult.details 数据中整理
      let wordScoreArray = []
      let wordScoreMap = []
      for (let i=0; i<detailData.length; i++) {
        let detail = detailData[i]
        let item = {}
        item.word = detail.char.toString()
        item.score = detail.score
        wordScoreMap.push(item)
        wordScoreArray.push(item.score)
      }
      // this.workSocreMap
      this.workScoreMap = JSON.stringify(wordScoreMap) 
      // this.scoreSegment
      this.scoreSegment = wordScoreArray.toString() 
      // this.currentPage
      this.currentPage = this.recordCurrentData[this.currentRecordIndex-1].pageMapQueue
      // indexOfRecords
      this.indexOfRecords = this.recordCurrentData[this.currentRecordIndex-1].index
      // VVOS 上传所需要的两个主要参数对象,作为最终整理好的参数 返回
      let token = {
        studentId: parseInt(this.studentId),
        bookId: parseInt(this.bookId),
        audioSuffix: ".wav",
        bookCode: this.bookCode,
        currentPage: this.currentPage, // 从 recordCurrentData 中获取
        startTime: this.recordStartTime
      }
      let notifier = {
        studentId: parseInt(this.studentId),
        score: parseInt(this.currentPageScore),
        currentPage: this.currentPage, // 当前页面 number
        startTime: this.recordStartTime,
        dudSummaryId: parseInt(this.dudSummaryId),
        pageIndex: this.indexOfRecords,
        pageCount: this.pageCount, // 录音总数
        // 分数系统 "0,0,0,0"
        scoreSegment: this.scoreSegment,
        endTime: this.recordEndTime,
        wordSegment: this.recordText,
        workScoreMap: this.workScoreMap
      }
      return {token:token, notifier: notifier}
    },
    // 将录音后数据上传到 服务器，再次翻到此页时，由父组件获取数据-->此组件
    uploadRecordBuff() {
      this.uploading = true // 上传状态开始
      let params = this.getUploadParam() // 取得 upload 所需要的参数对象
      // api URL
      const getTokenUrl = location.protocol + "//"+ location.host + "/rest/learninggw/api/pc/service/digitlib/getRecordToken"
      const callBackUrl = location.protocol + "//"+ location.host + "/rest/learninggw/api/pc/service/digitlib/getRecordCallbackToken"
      // VVOS 实例
      let upload = new VVOS({
        api:{
          gettoken: getTokenUrl,
          notifier: callBackUrl
        },
        cover:true,
        client: 'vos-js.sdk 1.0.0.0'
      })
      // 音频文件 实例化，并添加到 VVOS实例中 
      let file = new File([this.currentRecordBuff], this.studentId + this.recordStartTime + '.wav')
      file.key = this.studentId + this.recordStartTime + '.wav' // 作为上传文件的key值
      upload.addfiles([file])
      // 提交 VVOS实例
      upload.submit({
        gettoken: params.token,
        notifier: params.notifier
      }, (err, data) => {
        // 上传录音文件之后
        this.uploading = false // 上传状态 调整为 false
        // 关闭全屏 loading
        this.closeFullLoading() 
        // ERROR: 错误处理
        if (err) {
          // 弹出框提示
          this.openDialog(this.noticeBox.uploadFailed, 2) // （录音上传失败, 2)
        }
        // SUCCESS:返回结果处理
        if (data.data) {
          let audioUrl = data.data.data ? data.data.data : "https://sdk.cloud.chivox.com/chivoxsdk-js/v4.0/Examples/static/mp3/en/past.mp3"
          this.emitRecordSuccess(this.currentRecordIndex, audioUrl)
          // 打点：上传成功
          sa.track('learning_click', {
            'click_id': 'pc_learning_video_record_up_file_sucess'
          })
        }
      })
    },
    // 通知父组件 录音成功, 以待父组件做一些数据处理
    emitRecordSuccess(index, audioUrl){
      if(index === 1){
        this.leftUpSuccess = true
        this.$emit("changeRecordInformation",{
          currentPage: this.currentPage,
          recordUpFileUrl: audioUrl,
          score: this.leftPageScore
        })
        if(this.recordCurrentData[1].havedRecord){
          this.rightUpSuccess = true
        }
      }
      if(index === 2){
        this.rightUpSuccess = true
        this.$emit("changeRecordInformation",{
          currentPage: this.currentPage,
          recordUpFileUrl: audioUrl,
          score: this.rightPageScore
        })
        if(this.recordCurrentData[0].havedRecord){
          this.leftUpSuccess = true
        }
      }
      if(this.rightUpSuccess && this.leftUpSuccess){
        this.$emit("recordSuccess",{
          currentPage: this.currentPage
        })
        this.leftUpSuccess = false
        this.rightUpSuccess = false
      } 
    }
    /************** END: 操作 VVOS *********************************************/
  },
  created() {
    // 初始化 自研SDK
    this.initEvaluater() 
  },
  mounted(){
    // 初始化 音频设备 audio
    this.initAudio()
  },
  destroyed(){
    // 销毁评测实例
    this.evaluater.close()
  }
}
</script>
<style lang="stylus" scoped>
  .book-record-action
    position: relative
    margin: 130px auto 0
    height: 100px 
    width: 840px
    .listem
      position: absolute
      width: 420px 
      height: 100px
      &.left
        left: 0px
      &.right
        right: 0px
      .record
        position: absolute
        top: 10px  
        width: 80px 
        height: 80px
        cursor: pointer
        &.left  
          left: 30px 
        &.right 
          right: 30px 
        &:hover 
          opacity: .8
        .record-to-start
          margin: 10px
          width: 60px 
          height: 60px 
          background: url(../../../img/library/pre-start-record-button@2x.png) no-repeat
          background-size: 60px 60px
          &.refuseRecord
            opacity: 0.7
            box-shadow: 0 0 20px 20px rgba(0, 0, 0, 0.3) inset
            border-radius: 30px
        .record-processing
          width: 100%
          height: 100%
          .record-middle
            position: absolute 
            top: 10px
            left: 10px 
            width:60px 
            height: 60px 
            background: url(../../../img/library/pre-record-bottom@2x.png) no-repeat
            background-size: 60px 60px
      .play 
        position: absolute 
        top: 28px 
        width: 44px 
        height: 44px 
        cursor: pointer
        &.playOff
          background: url(../../../img/library/dl-record-to-play.png) no-repeat
          background-size: 44px 44px
        &.playOn
          background: url(../../../img/library/pre-pause-button@2x.png) no-repeat
          background-size: 44px 44px
        &.refusePlay
          opacity: 0.7
          box-shadow: 0 0 20px 20px rgba(0, 0, 0, 0.5) inset
          border-radius: 44px
        &:hover 
          opacity: .8
        &.left 
          left: 120px 
        &.right
          right: 120px 
      .score
        position: absolute
        top: 13px 
        width: 74px 
        height: 67px 
        &.left 
          right: 30px
        &.right
          left: 30px 
        &.bad
          color: #ED6161
          background: url(../../../img/library/dl-current-score-bad.png) no-repeat
        &.normal
          color: #FFB600
          background: url(../../../img/library/dl-current-score-normal.png) no-repeat
          background-size: 74px 67px 
        &.good 
          color: #90D0FF
          background: url(../../../img/library/dl-current-score-good.png) no-repeat
        &.excellent
          color: #79DC7D
          background: url(../../../img/library/dl-current-score-excellent.png) no-repeat
        .score-text
            position: absolute
            top: 40px 
            width: 74px 
            text-align: center
            font-family: "Arial-BoldMT"
            font-size: 20px
    .dialogBody
      display: none
</style>