<template lang="jade">
  .book-wrapper(v-cloak)
    my-header
    .top
    .book-contain
      .book-record-datas.record-flag(@click="goToRecrodData()" v-if="isHaveRecord == true")
        .text 配音报告
        .flag
      .listen-record-sound.record-flag(@click="clickListenMyRecord()",v-bind:class="{'grayButtonFilter':isHaveRecord==false}")
        .text 听我配音
        .flag
      .hang-board-position-control
        p.below {{bookTitle.bookName}}
      .recoder-progress
        .recorder-item(
          v-for="item in recordPageList",
          v-if="item.pageMapQueue !=''"
          v-bind:class='{"have-recorded":item.haveRecordStyle,"recording":item.recording}'
        ) {{item.pageMapQueue}}
      .leftbtn(@click="pageTurn('pre')", v-if="isShowLeftBtn")
      .rightbtn(@click="pageTurn('next')", v-if="isShowRightBtn")
      img.book-bg(src="../../../img/readers/books.png")
      .reader-content-loading(v-if="!isShowBookContent")
        .first-part.loading-book
          img(src="../../../img/readers/loading.gif")
        .last-part.loading-book
          img(src="../../../img/readers/loading.gif")
      .reader-content(v-show="isShowBookContent")
        .first-part(:data-group = "bookPageFirst.group")
          template(v-for="item in bookPageFirst.images")
            img.js-reader-img(:src="item.url", @load="loadingImage($event)")
          p.reader-txt {{bookPageFirst.subtitle}}
          template(v-for="item in bookPageFirst.audios")
            audio(v-show = "false", :src="item.url", controls, id="audio-1")
          i.book-page {{bookPageFirst.sequence}}
          template(v-if="bookPageFirst.isAudio")
            span.sound-control-btn(data-page="one", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
              img.wave-1(src="../../../img/library/voice_wave_1.png")
              img.wave-2(src="../../../img/library/voice_wave_2.png")
              img.wave-3(src="../../../img/library/voice_wave_3.png")
            span.sound-control-btn.no-replay-btn(v-else)
        .turn-page(v-for="(item,index) in bookPageList")
          .page-show(:data-group = "item.pageOne.group")
            template(v-for="item in item.pageOne.images")
              img.js-reader-img.turn-page-img(:src="item.url", @load="loadingImage($event)")
            p.reader-txt.reader-txt-right {{item.pageOne.subtitle}}
            audio(v-if = "item.pageOne.audios.length > 0", :src="item.pageOne.audios[0].url" controls, :id="'audio-' + item.pageOne.sequence")
            i.book-page.turn-book-page-right.page-right {{item.pageOne.sequence}}
            template(v-if="item.pageOne.isAudio")
              span.sound-control-btn.replay-btn-right(data-page="two", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
                img.wave-1(src="../../../img/library/voice_wave_1.png")
                img.wave-2(src="../../../img/library/voice_wave_2.png")
                img.wave-3(src="../../../img/library/voice_wave_3.png")
              span.no-replay-btn.no-replay-btn-right(v-else)
          .page-hide(:data-group = "item.pageTwo.group")
            template(v-for="item in item.pageTwo.images")
              img.js-reader-img(:src="item.url", @load="loadingImage($event)")
            p.reader-txt {{item.pageTwo.subtitle}}
            audio(v-if = "item.pageTwo.audios.length > 0", :src="item.pageTwo.audios[0].url" controls, :id="'audio-'+ item.pageTwo.sequence")
            i.book-page.turn-book-page {{item.pageTwo.sequence}}
            template(v-if="item.pageTwo.isAudio")
              span.sound-control-btn(data-page="one", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
                img.wave-1(src="../../../img/library/voice_wave_1.png")
                img.wave-2(src="../../../img/library/voice_wave_2.png")
                img.wave-3(src="../../../img/library/voice_wave_3.png")
              span.no-replay-btn(v-else)
        .last-part(:data-group = "bookPageLast.group")
           .listen-record.circle(@click="clickListenMyRecord()")
              img(src="../../../img/library/dl-listen-record-data.png")
              .text 听我配音
           .record-data.circle(@click="goToRecrodData()")
              img(src="../../../img/library/dl-record-book-inforamtion.png")
              .text 配音报告
    book-recrd-action(
      @closeScoreLayer="closeScoreLayer",
      @showScoreLayer="showScoreLayer",
      :recordCurrentPages="recordCurrentPage",
      :recordCurrentData = "recordCurrentData",
      :dudSummaryId ="dudSummaryId",
      :pageCount = "recordPageCount",
      @stopPlay = "stopPlayOrigin()"
      @recordSuccess="recordSucessCallback"
      @changeRecordInformation ="changeRecordInformation"
      )
    full-page-loading(v-if="isFullPageLoadingShow",:loadingText="loadingText")
    my-dialog(
        v-if="isShowDialog",
        :isShowCloseButton='dialogShowCloseButton',
        :type="dialogConfirm",
        :title="dialogTitle",
        :imgType="dialogMood",
        isShowTitle = true,
        :confirmButton="dialogConfirmButtonText",
        :tipText ="dialogTipHtmlText",
        @library-dialog-cancel="closeDialog()"
    )
    record-trips-layer(v-if="false")
</template>

<script>
  import recordFindPng from '../../../img/library/dl-finish-record.png'
  import cookies from 'cookies-js'
  import axios from 'axios'
  import {$get, $post} from '../api.js'
  import utils from '../../../utils/_untils.js'
  import fullPageLoading from "../../common/vk_turn_page_loading.vue"
  import myHeader from "../header.vue"
  import bookRecrdAction from '../component/book_record_action.vue'
  import myDialog from '../common/dialog.vue'
  import VVOS from "vvos-js"
  import recordTripsLayer from './../component/record_trips_layer.vue'
  export default {
    props: [],
    data() {
      return {
        hoverTextClassName: {
          AUTO: 'hover-text-auto',
          MANUAL: 'hover-text-man'
        },
        test: 'asd',
        playStatusHoverClass: 'hover-text-man',
        isSpeedHoverTip: true,
        mcBookDetailUrl: '/api/pc/service/reader/getBookDetail',
        readEndTimeUrl: '/api/pc/service/reader/setEndTime',
        bookId: this.$route.params.id,
        bookCode: "",
        readerType: this.$route.params.type, //1为mc_reader 2为第三方绘本
        bookTitle: {},
        status: {
          isPlay: false,
          isMute: false,
          isTurnCurrentPage: false, //手动翻转后限制延时翻页
          isVoiceReplay: false
        },
        delayTimer: '',
        speedFast: 'speed-btn-2',
        isShowBookContent: false,
        isShowLeftBtn: false,
        isShowRightBtn: false,
        bookPages: 0,
        isTurnPage: false,//判断是否播放本页音频还是需要翻页
        currentGroupNum: 0,
        currentGroupTotal: '',
        zIndex: 0,
        page: '',
        pageCount: 0,
        book: '',
        bookPageFirst: '',
        bookPageLast: '',
        pageGroup: 0,
        bookPageList: [],
        currentPage: 0,
        nowReadingPage: 0,
        StateOfAudioControlOnPageCorner: 1, //1: needs to pause; 2: needs to play
        currentAudioOfAudioControlOnPageCorner: {},
        currentPlayingElement: null,
        isFullPageLoadingShow:false,
        loadingText:'正在评分中...',
        audioLeftDuration:10000,
        audioRightDuration:10000,
        recordCurrentData:[{
          text:'',
          index:1,
          duration:10000,
          pageMapQueue:1,
          canRecord:false,
          direction:"left"
        },
        {
          text:'',
          index:1,
          duration:10000,
          pageMapQueue:2,
          canRecord:false,
          direction:"right"
        }],
        
        isHaveRecord:false,
        recordPageList:[],
        recordStartPage:0,
        recordCurrentPage:0,
        recordPageCount:0,
        //弹窗的属性
        isShowDialog:false,
        dialogConfirm:'confirm',
        dialogTitle:'Notice',
        dialogMood:'happy',
        dialogConfirmButtonText:'确定',
        dialogCancelButtonText:'取消',
        dialogShowCloseButton:false,
        dialogTipHtmlText:'你确定吗？',
        dudSummaryId:0
      }
    },
    mounted(){
      axios.all([this.getcurentPage(),this.getRecordAudioUrl(),this.getBookDetail()])
        .then(axios.spread((res, accet, perms)=>{
          this.processCureentPage(res)
          this.mixAudioDataAndPageData(accet,perms)
          this.setCurrentRightBtn()      
        }))
      //具体某一个绘本打开的总次数
      sa.track('learning_click', {
        'click_id': 'pc_learning_vedio_record_open_record_book'+ this.bookId
      }),
      //所有绘本打开的次数
      sa.track('learning_click', {
        'click_id': 'pc_learning_vedio_record_open_all_record_book'
      })
    },
    watch:{
      recordCurrentPage:function(newVal,oldVal){
        this.setAudioRecordDudation(newVal)
        this.setRecordData(this.audioLeftDuration,this.audioRightDuration)
        this.setPageListCurrentRecording()
        if(newVal>oldVal){
          this.setPageListHaveRecord(newVal,this.isHaveRecord)
        }
      }
    },
    methods: {
      //设置录音页面的映射
      setRecordListMap(recordList){
        let length = recordList.length
        let myRecordListMap = {}
        for(let i=0; i<length;i++){
          let index = recordList[i].pageIndex.toString()
          myRecordListMap[index] = recordList[i]
        }
        return myRecordListMap
      },
      
      setCurrentRightBtn(){
        if(this.recordCurrentPage % 2==0){
          if(this.recordPageList[this.recordCurrentPage-1].havedRecord &&this.recordPageList[this.recordCurrentPage-2].havedRecord){
            this.isShowRightBtn = true
          } else 
            this.isShowRightBtn = false
        } else if(this.recordCurrentPage%2 ==1){
          if(this.recordPageList[this.recordCurrentPage-1].havedRecord &&this.recordPageList[this.recordCurrentPage].havedRecord){
            this.isShowRightBtn = true
          } else 
            this.isShowRightBtn = false
        }
      },
      processCureentPage(res){
        let recordCurrentPage = 0
        let data = res.data
        let isHaveRecord = false
        this.dudSummaryId = data.data.id
         
        if(data.data.currentPage == null ){
          recordCurrentPage = 1
        } else if(data.data.status == 0){
          if(data.data.currentPage == 0){
            recordCurrentPage = 1
          } else {
            recordCurrentPage = res.data.data.currentPage
          }
        } else if(data.data.status == 1){
            
          recordCurrentPage = 1
          isHaveRecord = true
        }
        this.isShowRightBtn = this.isHaveRecord = isHaveRecord
        this.recordStartPage = recordCurrentPage
        this.recordCurrentPage = recordCurrentPage
      },
      getcurentPage(){
        return axios.get(`/rest/learninggw/api/pc/service/digitlib/startRecord`,{
          params:{
            studentId:cookies.get('studentId'),
            bookId:this.bookId
          }
        })
      },
      getRecordAudioUrl(){
        return axios.get('/rest/learninggw/api/pc/service/digitlib/getRecordList',{
          params:{
            studentId: cookies.get("studentId"),
            bookId: this.bookId
          }
        })
      },
      getBookDetail() {
        //获取绘本详情信息
        let url = ""
        let param = null
        if (this.readerType == 2) {
          url = `/api/pc/service/digitlib/${cookies.get('studentId')}/${this.bookId}/${this.$route.params.bookCode}/detail`
        } else if (this.readerType == 1) {
          url = this.mcBookDetailUrl
          param = {
            t: new Date().getTime(),
            studentId: cookies.get('studentId'),
            bookId: this.bookId
          }
        }
        return $get(url, param)
      },
      stopPlayOrigin(){
        let audioBtns = document.querySelectorAll('.sound-control-btn')
        let length = audioBtns.length
        for(let i = 0; i<audioBtns.length;i++){
          audioBtns[i].classList.remove('playing')
        }
        this.audioPause('page')
      },
      recordSucessCallback(preload){
        this.isShowRightBtn = true
        this.setPageListHaveRecord(this.recordCurrentPage + 2,this.isHaveRecord)
      },
      changeRecordInformation(preload){
        let pageNum = preload.currentPage
        let fileUrl = preload.recordUpFileUrl
        let score = preload.score
        //如果是双数
        this.recordPageList[pageNum-1].playUrl = fileUrl
        this.recordPageList[pageNum-1].score = score
      },
      //设置已读属性,
      setPageListHaveRecord(value,isHaveRecord){
        // haveReocord属性用来控制翻译按钮，haveRecordStyle 属性用来控制 录音进度
        // 有些页面是没有录音按钮，但必须保证能够翻页
        if(isHaveRecord == true){
          let length = this.recordPageList.length
          for(let i = 0; i<length;i++){
            this.recordPageList[i].havedRecord = true
            this.recordPageList[i].haveRecordStyle = true
          }
          return
        }
        if(value % 2 == 1){
          if(value==1){
            this.recordPageList[value-1].havedRecord = true
            this.recordPageList[value-1].haveRecordStyle = true
          } else {
            this.recordPageList[value -3].havedRecord = true
            this.recordPageList[value -2].havedRecord = true
            this.recordPageList[value -3].haveRecordStyle = true
            this.recordPageList[value -2].haveRecordStyle = true
          }
        } else {
          if(value == 2){
            this.recordPageList[value-2].havedRecord = true
            this.recordPageList[value-2].haveRecordStyle = true
          } else{
            this.recordPageList[value-4].havedRecord = true
            this.recordPageList[value-3].havedRecord = true
            this.recordPageList[value-4].haveRecordStyle = true
            this.recordPageList[value-3].haveRecordStyle = true
          }
        }
      },
      //设置当前录音属性
      setPageListCurrentRecording(){
        let index = this.recordCurrentPage
        let length =this.recordPageList.length
        for(let i = 0; i<length;i++){
          this.recordPageList[i].recording = false
        }
        for(let i = 0; i<length;i++){
          this.recordPageList[i].recording = false
        }
        if(index %2 == 1){
          this.recordPageList[index-1].recording = true
          this.recordPageList[index].recording = true
        } else {
          this.recordPageList[index-2].recording =true
          this.recordPageList[index-1].recording = true
        }
      },
      setAudioRecordDudation(val){
        let audioLeft = null
        let audioRight = null
        if(val % 2 == 1){
          audioLeft = document.getElementById("audio-" + val)
          audioRight = document.getElementById('audio-' + (val +1))
        } else {
          audioLeft = document.getElementById("audio-" + (val-1))
          audioRight = document.getElementById('audio-' + val)
        }
        if(audioLeft){         
          //如果是梦想绘本录音时长设置为30000 三十秒 第三个播放器 free talk
          if ((this.bookTitle.bookName === 'I Have a Dream' || this.bookTitle.bookName.replace(/\s+/g, '') === 'IHaveaDream') && (val === 4 || val === 3)) {
            this.audioLeftDuration = 30000
          } else {
            this.audioLeftDuration =parseInt((audioLeft.duration+ 4)*1000)
          }
        } else {
          this.audioLeftDuration = 10000
        }
        if(audioRight){
          this.audioRightDuration = parseInt((audioRight.duration + 4)*1000)
        } else{
          this.audioRightDuration = 10000
        }      
      },  
      setRecordData(audioLeftDuration,audioRightDuration){
        this.recordCurrentData = []
        let index = this.recordCurrentPage
        if(index % 2 == 0 && index !== 0){
          this.recordPageList[index-2].duration = this.audioLeftDuration
          this.recordPageList[index -1].duration = this.audioRightDuration
          this.recordCurrentData.push(this.recordPageList[index-2])
          this.recordCurrentData.push(this.recordPageList[index-1]) 
        } else {
          this.recordPageList[index-1].duration = this.audioLeftDuration
          this.recordPageList[index].duration = this.audioRightDuration
          this.recordCurrentData.push(this.recordPageList[index -1])
          this.recordCurrentData.push(this.recordPageList[index]) 
        }
      },
      //设置录音的对应
      setRecordList(page,haveRecordList){
        let currentPage = this.recordStartPage
        let j = 0
        let isHaveRecordList = false 
        let recordList = null
        //判断haveRecordList是否为数组，如果不是数组的话，那么就不录音
        if(Array.isArray(haveRecordList) && haveRecordList.length>=1){
          recordList = this.setRecordListMap(haveRecordList)
          isHaveRecordList = true
        }
        page.map((item,index)=>{
           
          let recordPageItem ={}
          recordPageItem.pageMapQueue = item.sequence
          //判断是否最后的页面
          if(recordPageItem.pageMapQueue == ""){
            recordPageItem.isLastPage = true
            recordPageItem.playUrl = ""
            recordPageItem.score = false
          }
          //判断是单页，还是双数页
          if((index+1)%2 == 1){
            recordPageItem.direction = "left"
          } else {
            recordPageItem.direction = 'right'
          }
          //判断是否已经录音
          if(index+1 < currentPage){
            recordPageItem.haveRecordStyle = true
          } else {
            recordPageItem.havedRecord =false
            recordPageItem.haveRecordStyle = false
          }
          //判断是否能够录音
          if(item.contentForChivox){
            recordPageItem.text = item.contentForChivox
            recordPageItem.canRecord = true
            recordPageItem.duration = 10000
            this.recordPageCount += 1
            recordPageItem.index = this.recordPageCount
          
            if(isHaveRecordList&&recordList[this.recordPageCount.toString()]){
              recordPageItem.playUrl = recordList[this.recordPageCount.toString()].audioUrl
              recordPageItem.score = recordList[this.recordPageCount.toString()].score
              recordPageItem.havedRecord = true
            } else{
              recordPageItem.playUrl = ""
              recordPageItem.score = false
            }
          } else {
            recordPageItem.playUrl = ""
            recordPageItem.score = false
            recordPageItem.canRecord = false
            recordPageItem.havedRecord = true
          }
          recordPageItem.recording = false
          this.recordPageList.push(recordPageItem)
        })
        //添加一页，为最后的页面
        let recordPageItem = {}
        recordPageItem.direction = "right"
        recordPageItem.pageMapQueue = "" //pageMapQueue 为空保证不显示该页的序列
        recordPageItem.havedRecord = false
        recordPageItem.haveRecordStyle = false
        recordPageItem.canRecord = false
        recordPageItem.recording = false
        recordPageItem.isLastPage = true
        this.recordPageList.push(recordPageItem)
      },
      goToRecrodData(){
        this.$router.push({path:`/bookRecordData/${this.$route.params.id}`})
      },
      closeDialog(){
        this.isShowDialog = false
      },
      clickListenMyRecord(){
        if(this.isHaveRecord == false){
          this.dialogConfirm = 'alert'
          this.isShowDialog = true
          this.dialogTipHtmlText = '<p>宝贝还没有给绘本配音,<br/>配音后可以听效果</p>'
          this.dialogConfirmButtonText = '知道了'
        } else {
          window.location = `/bookListenRecord/${this.$route.params.id}/${this.readerType}/${this.$route.params.bookCode}`
        }
      },
      showScoreLayer(){
        this.isFullPageLoadingShow = true
      },
      closeScoreLayer(){
        this.isFullPageLoadingShow = false
      },
      mixAudioDataAndPageData(accet, res) {
        let page = res.data.data.pages
        let haveRecordList = accet.data.data
        let pageObj = {}
        let finshPage = {}
        finshPage.sequence = ""
        finshPage.images = [{url:recordFindPng}]
        finshPage.audios = []
        finshPage.subtitle = ""
        page.push(finshPage)

        this.bookCode = res.data.data.code
        if (res.data.data.curriculumSN&&res.data.data.curriculumSN.length>0) {
          let levelName = `Level ${res.data.data.curriculumSN[0].split('-')[1].substr(1)}`
          let unitName = `Unit ${res.data.data.curriculumSN[0].split('-')[2].substr(1)}`
          this.bookTitle = {
            bookName: res.data.data.name,
            levelName: `${levelName}  ${unitName}`
          }
        } else {
          this.bookTitle = {
            bookName: res.data.data.name
          }
        }
        this.pageCount = res.data.data.pageCount + 1
        this.currentGroupTotal = Math.round(page.length / 2) - 2
        this.setRecordList(page,haveRecordList)
        this.setPageListCurrentRecording()
        this.setPageListHaveRecord(this.recordStartPage,this.isHaveRecord)          
        //增加页码组合
        Array.from(page).map((item, idx) => {
          item.group = this.pageGroup
          item.isAudio = item.audios.length === 0 ? false : true
          if (idx != 0 && idx % 2 == 1) {
            this.pageGroup += 1
          }
        })
        Array.from(page).map((item, idx) => {
          //取出第一页
          if (idx === 0) {
            this.bookPageFirst = item
          }
          //剩下分组两个音频一组，分为正反页
          if (idx % 2 === 0 && idx != 0) {
            pageObj.pageTwo = item
            this.bookPageList.push(pageObj)
            pageObj = {}
          } else if (idx % 2 === 1 && idx != 0) {
            pageObj.pageOne = item
            if (idx === page.length - 1) {
              this.bookPageLast = item
            }
          }
        })
        this.$nextTick(() => {
          this.turnPage()
          this.monitorAudio()
          this.setRecordData(this.audioLeftDuration,this.audioRightDuration)
          setTimeout(() => {
            if (this.readerType == 2) {
              for (let i = 0; i < (Math.round((this.recordStartPage) / 2) - 1); i++) {
                this.pageTurn('next', true)
              }
            }
            // this.audioFlip(this.currentGroupNum)
          }, 1000)
        })
      },
      loadingImage(ev) {
        let target = ev.target
        if (+target.parentNode.getAttribute('data-group') === 0) {
          setTimeout(() => {
            this.isShowBookContent = true
          }, 1000)
        }
      },
      play(){
        setTimeout(() => {
          window.location.href = `/homework/activity/${cookies.get("studentId")}/${this.bookCode}/${this.bookId}`
        }, 300)
      },
      turnPage() {
        this.nowReadingPage += 2
        this.recordReadingProgress()
        this.book = document.querySelector('.reader-content')
        this.page = document.getElementsByClassName("turn-page")
        let bookLength = this.book.children.length - 2
        this.zIndex = this.book.children.length - 1
        for (let z = 0; z < bookLength; z++) {
          this.page[z].style.zIndex = this.zIndex--
        }
        document.querySelector('.last-part').style.zIndex = 0
      },
      //添加video的end事件监听声音结束，开始播放声音
      monitorAudio() {
        let audio = document.querySelectorAll('audio')
        Array.from(audio).map((item, idx) => {
          item.addEventListener('ended', (event) => {
            if(this.currentPlayingElement) {
              utils.removeClass(this.currentPlayingElement, 'playing')
              this.currentPlayingElement = null
              this.StateOfAudioControlOnPageCorner = 1
            }
            if (this.status.isVoiceReplay) return
            let tag = event.target
            let groupNum = tag.parentElement.getAttribute('data-group')
            let videoContent = document.querySelectorAll(`[data-group="${groupNum}"]`)
            this.currentGroupNum = groupNum //当前播放视频的页数
            if (this.isTurnPage) {
              if (this.isShowRightBtn && this.status.isPlay && this.currentGroupNum <= this.currentGroupTotal) {
                this.nextPage()
              } else {
                if (this.status.isPlay) {
                  setTimeout(() => {
                    if (videoContent[1].querySelector('audio')) {
                      videoContent[1].querySelector('audio').currentTime = 0
                      this.setSoundCtlBtnToPlaying(videoContent[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
                      videoContent[1].querySelector('audio').play()
                      this.isTurnPage = true
                    } else {
                      setTimeout(() => {
                        this.nextPage()
                      }, 3000)
                    }
                  }, 3000)
                }
              }
              this.isTurnPage = false
            } else {
              if(!videoContent[1]) return
              if (videoContent[1].querySelector('audio')) {
                videoContent[1].querySelector('audio').currentTime = 0
                // this.setSoundCtlBtnToPlaying(videoContent[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
                // videoContent[1].querySelector('audio').play()
              } else {
                if (this.status.isPlay){
                  setTimeout(() => {
                    this.nextPage()
                  }, 3000)
                }
              }
              this.isTurnPage = true
            }
          })
        })

        let playAudio = document.querySelectorAll('[data-group="0"]')
        //判断首页是否存在音频不存在翻到下一页
        if (playAudio[0].querySelector('audio')) {
          if (!isNaN(playAudio[0].querySelector('audio').duration)) {
            playAudio[0].querySelector('audio').currentTime = 0
          }
        } else if (playAudio[1].querySelector('audio')) {
          if (!isNaN(playAudio[1].querySelector('audio').duration)) {
            playAudio[0].querySelector('audio').currentTime = 0
          }
          this.isTurnPage = false
        } 
      },
      setSoundCtlBtnToPlaying( obj ) {
        if(this.currentPlayingElement) {
          utils.removeClass(this.currentPlayingElement, 'playing')
          this.currentPlayingElement = null          
        } 
        if(obj) {
          obj.className += ' playing'
        }
        this.currentPlayingElement = obj
        this.StateOfAudioControlOnPageCorner = 1
      },
      audioPause(isFrom) {
        let audio = document.querySelectorAll('audio')
        let playing = false
        //判断是否有有audio在播放中
        Array.from(audio).map((item, idx) => {
          if (isFrom === 'page') {
            item.pause()
            // item.currentTime = 0
          } else if (isFrom === 'play') {
            if (!item.paused) {
              playing = true
            }
          }
        })
        if (isFrom === 'play') {
          return playing
        }
      },
      audioPlay(idx, status){
        let audio = document.querySelectorAll('audio')
        if (status === 'playbackRate') {
          Array.from(audio).map((item, index) => {
            item.playbackRate = idx
          })
        } else if (status === 'mute') {
          Array.from(audio).map((item, index) => {
            item.muted = this.status.isMute
          })
        }
      },
      audioFlip(audioGroup) {
        let currentAudioGroup = document.querySelectorAll(`[data-group="${audioGroup}"]`)
        //判断每组是否有音频
        if (currentAudioGroup.length > 0 && currentAudioGroup[0].querySelector('audio')) {
          currentAudioGroup[0].querySelector('audio').currentTime = 0
          this.setSoundCtlBtnToPlaying(currentAudioGroup[0].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
          // currentAudioGroup[0].querySelector('audio').play()
          this.isTurnPage = false
        } else if (currentAudioGroup.length > 1 && currentAudioGroup[1].querySelector('audio')) {
          if (audioGroup != 0) {
            clearTimeout(this.delayTimer)
            this.delayTimer = setTimeout(() => {
              currentAudioGroup[1].querySelector('audio').currentTime = 0
              this.setSoundCtlBtnToPlaying(currentAudioGroup[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
              currentAudioGroup[1].querySelector('audio').play()
              this.isTurnPage = true
            }, 3000)
          } else {
            currentAudioGroup[1].querySelector('audio').currentTime = 0
            this.setSoundCtlBtnToPlaying(currentAudioGroup[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
            currentAudioGroup[1].querySelector('audio').play()
            this.isTurnPage = true
          }
        }
      },
      audioControlOnPageCorner(event) {
        if (this.status.isTurnCurrentPage) return
        if(this.currentPlayingElement) {
          utils.removeClass(this.currentPlayingElement, 'playing')
        }
        let tag = event.target
        this.currentAudioOfAudioControlOnPageCorner = tag.parentElement.parentElement.querySelector('audio')
        if (tag.getAttribute('data-page') === 'one') {
          this.isTurnPage = false
        } else if (tag.getAttribute('data-page') === 'two') {
          this.isTurnPage = true
        }
        this.audioPause('page')
        /**
         *   @ this.StateOfAudioControlOnPageCorner 1: needs to pause; 2: needs to play
         **/
        if( event.target.parentElement == this.currentPlayingElement ) {
          this.currentPlayingElement = null
          setTimeout(() => {
            if(this.StateOfAudioControlOnPageCorner == 1) {
              this.StateOfAudioControlOnPageCorner = 2
              this.currentAudioOfAudioControlOnPageCorner.pause()
            } else if(this.StateOfAudioControlOnPageCorner == 2) {
              this.StateOfAudioControlOnPageCorner = 1
              this.currentAudioOfAudioControlOnPageCorner.play()
              tag.parentElement.className += ' playing'
              this.currentPlayingElement = tag.parentElement
            }
          }, 0)
        } else {
          this.StateOfAudioControlOnPageCorner = 1
          this.currentAudioOfAudioControlOnPageCorner.play()
          tag.parentElement.className += ' playing'
          this.currentPlayingElement = tag.parentElement
        }
  
        if (this.status.isPlay) {
          this.status.isVoiceReplay = false
        } else {
          this.status.isVoiceReplay = true
        }
      },
      pageTurn(direction, isLocationPage){
        if( this.currentAudioOfAudioControlOnPageCorner ) {
          this.currentAudioOfAudioControlOnPageCorner.currentTime = 0
        }
        
        this.StateOfAudioControlOnPageCorner = 1
        this.status.isVoiceReplay = false
        clearTimeout(this.delayTimer)
        if (direction === 'next' && !this.status.isTurnCurrentPage) {
          if (this.bookPages < this.book.children.length - 2) {
            if (this.page[this.bookPages].style.animation === "page 0.7s linear 1 forwards") return
            this.nowReadingPage += 2
            this.recordReadingProgress()
            this.status.isTurnCurrentPage = true
            if (isLocationPage) {
              this.page[this.bookPages].style.animation = "page 0s linear 1 forwards"
              this.status.isTurnCurrentPage = false
              let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[1]
              changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 1
              changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 0
              this.page[this.bookPages].style.zIndex = 0
              this.bookPages++
              this.audioPause('page')
              this.currentGroupNum++
              if (this.currentGroupNum < 0) return
            } else {
              this.recordCurrentPage += 2
              this.page[this.bookPages].style.animation = "page 0.7s linear 1 forwards"
              setTimeout(() => {
                this.status.isTurnCurrentPage = false
              }, 700)
              setTimeout(() => {
                //修改层级兼容ie
                let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[1]
                changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 1
                changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 0
                this.page[this.bookPages].style.zIndex = 0
                this.bookPages++
              }, 250)
              setTimeout(() => {
                if (this.bookPages != this.book.children.length - 2 && this.isHaveRecord ==true) {
                  this.isShowRightBtn = true
                } else if(this.bookPages == this.book.children.length - 2 && this.isHaveRecord == false) {
                  this.isHaveRecord = true
                  this.isShowRightBtn = false
                } else if(this.bookPages == this.book.children.length - 2 && this.isHaveRecord == true){
                  this.isShowRightBtn = false
                } else {
                  this.setCurrentRightBtn()
                }
                this.audioPause('page')
                this.currentGroupNum++
                if (this.currentGroupNum < 0) return
                // this.audioFlip(this.currentGroupNum)s
              }, 260)
            }
            if( this.page[this.bookPages] ) {
              this.zIndex = this.page[this.bookPages].style.zIndex
            }
            this.isShowLeftBtn = true
          } else {
            setTimeout(() => {
              this.bookPages = this.book.children.length - 2
            }, 250)
          }
        } else if (direction === 'pre' && !this.status.isTurnCurrentPage) {
          this.isShowRightBtn = true
          if (this.bookPages != 0) {
            this.status.isTurnCurrentPage = true
            if (this.page[this.bookPages - 1].style.animation === "page1 0.7s linear 1 forwards") return
            this.nowReadingPage -= 2
            this.recordCurrentPage -= 2
            this.recordReadingProgress()
            this.page[this.bookPages - 1].style.animation = "page1 0.7s linear 1 forwards"
            setTimeout(() => {
              this.status.isTurnCurrentPage = false
            }, 700)
            setTimeout(() => {
              //修改层级兼容ie
              if (this.currentGroupNum > this.bookPageLast.group) this.currentGroupNum = this.bookPageLast.group
              let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[0]
              changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 0
              changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 1
              this.page[this.bookPages - 1].style.zIndex = this.zIndex++
              this.bookPages--
            }, 250)
          } else {
            setTimeout(() => {
              this.bookPage = 0
            }, 250)
          }
          setTimeout(() => {
            if (!this.bookPages) {
              this.isShowLeftBtn = false
            } else {
              this.isShowLeftBtn = true
            }
            this.audioPause('page')
            this.currentGroupNum--
            // this.audioFlip(this.currentGroupNum)
          }, 260)
        }
      },
      nextPage(isLocationPage){
        if (this.status.isTurnCurrentPage) return
        this.isShowLeftBtn = true
        if (this.bookPages < this.book.children.length - 2) {
          this.status.isTurnCurrentPage = true
          if (this.page[this.bookPages].style.animation === "page 0.7s linear 1 forwards") return
          this.nowReadingPage += 2
          this.recordReadingProgress()
          this.page[this.bookPages].style.animation = "page 0.7s linear 1 forwards"
          this.zIndex = this.page[this.bookPages].style.zIndex
          setTimeout(() => {
            this.status.isTurnCurrentPage = false
          }, 700)
          setTimeout(() => {
            //修改层级兼容ie
            let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[1]
            changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 1
            changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 0
            this.page[this.bookPages].style.zIndex = 0
            this.bookPages++
          }, 250)
        } else {
          setTimeout(() => {
            this.bookPages = this.book.children.length - 2
          }, 250)
        }
        setTimeout(() => {
          if (this.bookPages < this.book.children.length - 2) {
            this.isShowRightBtn = true
          } else {
            this.isShowRightBtn = false
          }
          this.audioPause('page')
          this.currentGroupNum++
          if (this.currentGroupNum < 0) return
          // this.audioFlip(this.currentGroupNum)
        }, 260)
      },
      recordReadingProgress() {
        if (this.readerType != 2) return //目前只有第三方绘本支持阅读进度记录
        if (this.nowReadingPage >= this.pageCount) {
          this.nowReadingPage = this.pageCount
        }
      },

      //added by luomingzhong
      goToRecordDetailData(){
        this.$router.push({path: '/bookRecordData'})
      }
    },
    components: {
      myHeader, 
      bookRecrdAction,
      fullPageLoading,
      myDialog,
      recordTripsLayer
    }
  }
</script>

<style lang="stylus" scoped>
  ul, li
    list-style: none
    list-style-image: none

  a
    text-decoration: none
    color: #333
  
  audio 
    display: none
  /*翻书下一页的动画*/
  @keyframes page {
    0% {
      -webkit-transform: rotateY(0deg)
      -moz-transform: rotateY(0deg)
      -ms-transform: rotateY(0deg)
      transform: rotateY(0deg)
    }
    100% {
      -webkit-transform: rotateY(-180deg)
      -moz-transform: rotateY(-180deg)
      -ms-transform: rotateY(-180deg)
      transform: rotateY(-180deg)
    }
  }

  /*翻书上一页的动画*/
  @keyframes page1 {
    0% {
      -webkit-transform: rotateY(-180deg)
      -moz-transform: rotateY(-180deg)
      -ms-transform: rotateY(-180deg)
      transform: rotateY(-180deg)
    }
    100% {
      -webkit-transform: rotateY(0deg)
      -moz-transform: rotateY(0deg)
      -ms-transform: rotateY(0deg)
      transform: rotateY(0deg)
    }
  }
    
  .book-wrapper
    background-repeat: no-repeat
    background-position: center
    background-size: 1920px
    background-color: #6D4C9E
    width: 100%
    height: 100%
    background-image: url('../../../img/library/bg-book-1280-1920.png')
    background-size: 1920px
    [v-cloak]
      display: none
    .readers-title
      & > p
        padding: 0
        margin: 0 0 10px
        font-size: 24px
      & > .book-name
        font-size: 36px
    .hang-board-position-control
      position: absolute
      top: -35px
      left: 0
      right: 0
      text-align: center
      p 
        color:#fff
        font-size:24px 
        font-weight:700
        font-family: 'PingFangSC-Semibold'
    .top
      height: 50%
      margin-bottom: -400px
    .book-contain
      width: 1000px
      min-height: 462px
      position: relative
      top: 106px
      margin: 0 auto
      @media  screen and (min-width: 1281px) and (max-width:1480px)
         top:120px
      .leftbtn
        position: absolute
        width: 38px
        height: 78px
        top: 236px
        left: 29px
        cursor: pointer
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -195px -105px
        @media  screen and (min-width: 1281px) and (max-width:1480px)
          top:250px
        &:hover
          opacity: 0.8
        &:active
          background-position: -342px -105px
      .rightbtn
        position: absolute
        width: 40px
        height: 78px
        top: 236px
        right: 29px
        cursor: pointer
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -275px -105px
        @media  screen and (min-width: 1281px) and (max-width:1480px)
           top: 250px
        &:hover
          opacity: 0.8
        &:active
          background-position: -421px -105px
      .reader-content-loading,
      .reader-content
        width: 824px
        height: 462px
        position: absolute
        top: 70px
        left: 90px
        -webkit-perspective: 1200px
        -moz-perspective: 1200px
        -ms-perspective: 1200px
        perspective: 1200px
        -webkit-transform-style: preserve-3d
        -moz-transform-style: preserve-3d
        -ms-transform-style: preserve-3d
        transform-style: preserve-3d
        .loading-book
          background:#fff
          z-index: 1
          & > img
            width: 30px
            height: 30px
            display: block
            position: absolute
            left: 50%
            top: 50%
            margin: -15px 0 0 -15px
        .sound-control-btn
          display: block
          width: 44px
          height: 44px
          position: absolute
          top: 20px
          left: 20px
          background: url('../../../img/library/voice_btn_sprite.png') no-repeat
          background-size: 96px
          background-position: 0 0
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
          cursor: pointer
          &:hover
            opacity: 0.8
          &:active
            background-position: -52px 0
          img.wave-1
            position: absolute
            width: 44px
          img.wave-2
            position: absolute
            width: 44px
            animation-fill-mode: both
          img.wave-3
            position: absolute
            width: 44px
            animation-fill-mode: both
          &.playing
            img.wave-1
              animation: wave_1_animate 1.5s infinite
              animation-fill-mode: both
            img.wave-2
              animation: wave_1_animate 1.5s infinite
              animation-delay: 0.5s
              animation-fill-mode: both
            img.wave-3
              animation: wave_1_animate 1.5s infinite
              animation-delay: 1s
              animation-fill-mode: both
        .replay-btn-right
          -webkit-transform: translateZ(2px)
          -moz-transform: translateZ(2px)
          -ms-transform: translateZ(2px)
          transform: translateZ(2px)
          cursor: pointer
          left: initial
          right: 20px
          &:hover
            opacity: 0.8
          &:active
            background-position: -52px 0
        .no-replay-btn
          display: block
          width: 44px
          height: 44px
          position: absolute
          top: 20px
          left: 20px
          background: url('../../../img/readers/novoice.png')
          background-size: 100% 100%
          &.no-replay-btn-right
            display: block
            width: 44px
            height: 44px
            position: absolute
            top: 20px
            right: 20px
            left: initial
            background: url('../../../img/readers/novoice.png')
            background-size: 100% 100%
        & > div,
        .page-show,
        .page-hide
          width: 412px
          height: 462px
          position: absolute
          & > img
            width: 100%
            height: 464px
          & > .turn-page-img
            -webkit-transform: translateZ(2px)
            -moz-transform: translateZ(2px)
            -ms-transform: translateZ(2px)
            transform: translateZ(2px)
          .reader-txt
            width: 389px
            height: 96px
            line-height: 1.4
            font-size: 20px
            position: absolute
            top: 350px
            left: 20px
            color: #000
            margin: 0 auto
            -webkit-transform: translateZ(1px)
            -moz-transform: translateZ(1px)
            -ms-transform: translateZ(1px)
            transform: translateZ(1px)
          .reader-txt-right
            -webkit-transform: translateZ(2px)
            -moz-transform: translateZ(2px)
            -ms-transform: translateZ(2px)
            transform: translateZ(2px)
        .book-page
          display: block
          width: 24px
          height: 26px
          text-align: center
          line-height: 23px
          font-style: normal
          background: url(../../../img/readers/no@2x.png)
          background-size: 100% 100%
          color: #fff
          position: absolute
          bottom: 10px
          left: 16px
          font-size: 14px
        .turn-book-page
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
        .turn-book-page-right
          -webkit-transform: translateZ(2px)
          -moz-transform: translateZ(2px)
          -ms-transform: translateZ(2px)
          transform: translateZ(2px)
        .page-right
          right: 26px
          left: initial
        .turn-page
          position: absolute
          right: 0
          -webkit-transform-origin: left
          -moz-transform-origin: left
          -ms-transform-origin: left
          transform-origin: left
          -webkit-transform-style: preserve-3d
          -moz-transform-style: preserve-3d
          -ms-transform-style: preserve-3d
          transform-style: preserve-3d
          & > div
            display: block
            width: 100%
            min-height: 462px
            position: absolute
          .page-hide
            z-index: 0
            -webkit-transform: rotatey(-180deg) translateZ(1px)
            -moz-transform: rotatey(-180deg) translateZ(1px)
            -ms-transform: rotatey(-180deg) translateZ(1px)
            transform: rotatey(-180deg) translateZ(1px)
          .page-show
            z-index: 1
            -webkit-transform: translateZ(1px)
            -moz-transform: translateZ(1px)
            -ms-transform: translateZ(1px)
            transform: translateZ(1px)
        .last-part
          position: absolute
          right: 0
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
          background:#fff
          .circle 
            position:absolute
            right:124px
            width:150px 
            height:150px 
            border-radius:100%
            background:#F5F2FE
            cursor: pointer
            &:hover
              opacity:.7
            img
              position:absolute
              top:27px
              left:49px
              width:50px
            .text 
              position:absolute
              top:98px
              width:100%
              color:#555
              text-align:center
            &.listen-record
              top:63px
            &.record-data
              top:255px
      .book-bg
        width: 868px
        height: 498px
        position: relative
        top: 17px
        left: 66px
  /*
  * added by luomingzhog
  * @date 2018-04-19
  */
  .recoder-progress
      position:relative
      top:12px
      left:24px
      width:948px
      height:42px
      display:flex
      display: -webkit-flex
      justify-content:center
      align-items:center
      -webkit-justify-content:center
      -webkit-align-items:center
      .recorder-item
         box-sizing:border-box
         width:20px
         height:24px
         border:2px solid #B396FF
         color:#fff
         font-size:12px
         line-height:20px
         text-align:center
         border-radius: 5px
         background:#8561ED
         transition:all .5s ease-in
         &.have-recorded
           background:#FFB600
           border:2px solid #FFCC4E
         &.recording
           width:25px
           height:30px
           font-size:16px
           line-height:25px
           background:#FFB600
           border:2px solid #FFCC4E
         &:nth-child(2n+1){
           margin-left:4px
         }
  .record-flag
     position:absolute
     right:-85px
     height:33px 
     width:106px
     cursor: pointer
     &:hover 
       opacity: .8
     &.book-record-datas
        top:6px
       .flag
         background:url(../../../img/library/dl-record-book-inforamtion.png) no-repeat
         background-size:27px 33px
     &.listen-record-sound
       top:-45px
       .flag
         background:url(../../../img/library/dl-listen-record-data.png) no-repeat
         background-size:27px 33px
       &.grayButtonFilter
         filter:grayscale(1)
     .flag
      position:absolute
      height:33px 
      width:27px
     .text
      position:absolute
      top:1.5px
      right:0px
      width:90px
      height:30px
      border-top-right-radius:30px
      border-bottom-right-radius:30px
      color:#fff
      text-indent:21px
      font-size:14px 
      line-height:30px
      background:rgba(0,0,0,.3)        
@keyframes wave_1_animate
  0%
    opacity: 0
  50%
    opacity: 1
  100%
    opacity: 1
  
</style>
