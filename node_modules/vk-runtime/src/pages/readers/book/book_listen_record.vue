<template lang="jade">
  .book-wrapper(v-cloak)
    .hang-board-position-control
      .hang-board
        .infinite-part
        .right-end
        .text-wrap
          .text-wrap-hd
            p.above {{bookTitle.levelName}}
            p.below {{bookTitle.bookName}}
    my-header
    .top
    .book-contain
      .recoder-progress
        .recorder-item(
          v-for="item in recordPageList",
          v-bind:class='{"have-recorded":item.isHaveRecord,"recording":(item.index - nowReadingPage == -1) || (item.index - nowReadingPage == 0)}'
        ) {{item.index}}
      .leftbtn(@click="pageTurn('pre')", v-if="isShowLeftBtn")
      .rightbtn(@click="pageTurn('next')", v-if="isShowRightBtn")
      .replay-this-book-btn(@click="replayThisBook", v-else)
      img.book-bg(src="../../../img/readers/books.png")
      .reader-content-loading(v-if="!isShowBookContent")
        .first-part.loading-book
          img(src="../../../img/readers/loading.gif")
        .last-part.loading-book
          img(src="../../../img/readers/loading.gif")
      .reader-content(v-show="isShowBookContent")
        .first-part(:data-group = "bookPageFirst.group")
          template(v-for="item in bookPageFirst.images")
            img.js-reader-img(:src="item.url", @load="loadingImage($event)")
          p.reader-txt {{bookPageFirst.subtitle}}
          template(v-for="item in bookPageFirst.audios")
            audio(v-show = "false", :src="item.url", controls)
          i.book-page {{bookPageFirst.sequence}}
          template(v-if="bookPageFirst.isAudio")
            span.sound-control-btn(data-page="one", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
              img.wave-1(src="../../../img/library/voice_wave_1.png")
              img.wave-2(src="../../../img/library/voice_wave_2.png")
              img.wave-3(src="../../../img/library/voice_wave_3.png")
            span.sound-control-btn.no-replay-btn(v-else)
        .turn-page(v-for="(item,index) in bookPageList")
          .page-show(:data-group = "item.pageOne.group")
            template(v-for="item in item.pageOne.images")
              img.js-reader-img.turn-page-img(:src="item.url", @load="loadingImage($event)")
            p.reader-txt.reader-txt-right {{item.pageOne.subtitle}}
            template(v-for="item in item.pageOne.audios")
              audio(v-show = "false", :src="item.url" controls)
            i.book-page.turn-book-page-right.page-right {{item.pageOne.sequence}}
            template(v-if="item.pageOne.isAudio")
              span.sound-control-btn.replay-btn-right(data-page="two", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
                img.wave-1(src="../../../img/library/voice_wave_1.png")
                img.wave-2(src="../../../img/library/voice_wave_2.png")
                img.wave-3(src="../../../img/library/voice_wave_3.png")
              span.no-replay-btn.no-replay-btn-right(v-else)
          .page-hide(:data-group = "item.pageTwo.group")
            template(v-for="item in item.pageTwo.images")
              img.js-reader-img(:src="item.url", @load="loadingImage($event)")
            p.reader-txt {{item.pageTwo.subtitle}}
            template(v-for="item in item.pageTwo.audios")
              audio(v-show = "false", :src="item.url" controls)
            i.book-page.turn-book-page {{item.pageTwo.sequence}}
            template(v-if="item.pageTwo.isAudio")
              span.sound-control-btn(data-page="one", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
                img.wave-1(src="../../../img/library/voice_wave_1.png")
                img.wave-2(src="../../../img/library/voice_wave_2.png")
                img.wave-3(src="../../../img/library/voice_wave_3.png")
              span.no-replay-btn(v-else)
        .last-part(:data-group = "bookPageLast.group")
          template(v-for="item in bookPageLast.images")
            img.js-reader-img(:src="item.url", @load="loadingImage($event)")
          p.reader-txt.reader-txt-right(v-if="bookPageLast.group") {{bookPageLast.subtitle}}
          template(v-for="item in bookPageLast.audios")
            audio(v-show = "false", :src="item.url" controls)
          i.book-page.page-right(v-if="bookPageLast.group") {{bookPageLast.sequence}}
          template(v-if="bookPageLast.isAudio")
            span.sound-control-btn.replay-btn-right(data-page="two", @click.stop="audioControlOnPageCorner($event)", v-if="!status.isMute")
              img.wave-1(src="../../../img/library/voice_wave_1.png")
              img.wave-2(src="../../../img/library/voice_wave_2.png")
              img.wave-3(src="../../../img/library/voice_wave_3.png")
            span.no-replay-btn(v-else)
      .operation-reading
        .operation-page-turn
          span.play-btn(:class="[{'display-btn': !status.isPlay}, playStatusHoverClass]", @click="setPlay")
    .book-record-datas.record-flag(@click="goToRecrodData()")
        .text 配音报告
        .flag
</template>
<script>
  import cookies from 'cookies-js'
  import {$get, $post} from '../api.js'
  import utils from '../../../utils/_untils.js'
  import myHeader from "../header.vue"
  import axios from 'axios'
  export default {
    props: [],
    data() {
      return {
        hoverTextClassName: {
          AUTO: 'hover-text-auto',
          MANUAL: 'hover-text-man'
        },
        test: 'asd',
        playStatusHoverClass: 'hover-text-man',
        isSpeedHoverTip: true,
        mcBookDetailUrl: '/api/pc/service/reader/getBookDetail',
        readEndTimeUrl: '/api/pc/service/reader/setEndTime',
        bookId: this.$route.params.id,
        bookCode: "",
        readerType: this.$route.params.type, //1为mc_reader 2为第三方绘本
        bookTitle: {},
        status: {
          isPlay: true,
          isMute: false,
          isShowSpeed: false,
          isTurnCurrentPage: false, //手动翻转后限制延时翻页
          isVoiceReplay: false
        },
        delayTimer: '',
        speedFast: 'speed-btn-2',
        isShowBookContent: false,
        isShowLeftBtn: false,
        isShowRightBtn: true,
        bookPages: 0,
        isTurnPage: false,//判断是否播放本页音频还是需要翻页
        currentGroupNum: 0,
        currentGroupTotal: '',
        zIndex: 0,
        page: '',
        pageCount: 0,
        book: '',
        bookPageFirst: '',
        bookPageLast: '',
        pageGroup: 0,
        bookPageList: [],
        serverCurrPage: 0,
        currentPage: 2,
        nowReadingPage: 0,
        StateOfAudioControlOnPageCorner: 1, //1: needs to pause; 2: needs to play
        currentAudioOfAudioControlOnPageCorner: {},
        currentPlayingElement: null,
        recordPageList:[]
      }
    },
    mounted(){
      axios.all([this.getRecordAudioUrl(),this.getBookDetail()])
        .then(axios.spread((accet,perms)=>{
          this.mixAudioDataAndPageData(accet,perms)
        }))
    },
    methods: {
      goToRecrodData(){
        this.$router.push({path:`/bookRecordData/${this.bookId}`})
      },
      mixAudioDataAndPageData(accet,perms){
        let audioUrl = accet.data.data
        let pageList = perms.data.data.pages
        let length = pageList.length
        let j = 0
        let recordList = []
        for(let i = 0; i < length; i ++){
          let tempRecordList = {}
          if(pageList[i].contentForChivox == ""){
            pageList[i].audios = []

            tempRecordList.isCanRecord = false
            tempRecordList.isHaveRecord = true
          } else {
            if(audioUrl[j]){
              let tempAudioUrl = audioUrl[j].audioUrl
              let audioItem = { url: tempAudioUrl}
              let audioArray = []
              audioArray.push(audioItem)
             
              pageList[i].audios = audioArray
              tempRecordList.isHaveRecord = true
            } else {
              pageList[i].audios = []
              tempRecordList.isHaveRecord = false
            }
            tempRecordList.isCanRecord = true
            j++
          }
          tempRecordList.index = i + 1
          recordList.push(tempRecordList)
          this.recordPageList = recordList
        }
        this.processPageInformation(perms.data)
      },
      getRecordAudioUrl(){
        return axios.get('/rest/learninggw/api/pc/service/digitlib/getRecordList',{
          params:{
            studentId: cookies.get("studentId"),
            bookId: this.bookId
          }
        })
      },
      replayThisBook() {
        location.reload()
      },
      //处理图片信息
      processPageInformation(data){
        let page = data.data.pages
        let pageObj = {}
        this.bookCode = data.data.code
        if (data.data.curriculumSN) {
          let levelName = `Level ${data.data.curriculumSN[0].split('-')[1].substr(1)}`
          let unitName = `Unit ${data.data.curriculumSN[0].split('-')[2].substr(1)}`
          this.bookTitle = {
            bookName: data.data.name,
            levelName: `${levelName}  ${unitName}`
          }
        } else {
          this.bookTitle = {
            bookName: data.data.name
          }
        }
        this.pageCount = data.data.pageCount
        this.currentGroupTotal = Math.round(page.length / 2) - 2
        this.serverCurrPage = 1
        //增加页码组合
        Array.from(page).map((item, idx) => {
          item.group = this.pageGroup
          item.isAudio = item.audios.length === 0 ? false : true
          if (idx != 0 && idx % 2 == 1) {
            this.pageGroup += 1
          }
        })
        Array.from(page).map((item, idx) => {
          //取出第一页
          if (idx === 0) {
            this.bookPageFirst = item
          }
          //剩下分组两个音频一组，分为正反页
          if (idx % 2 === 0 && idx != 0) {
            pageObj.pageTwo = item
            this.bookPageList.push(pageObj)
            pageObj = {}
          } else if (idx % 2 === 1 && idx != 0) {
            pageObj.pageOne = item
            if (idx === page.length - 1) {
              this.bookPageLast = item
            }
          }
        })
        this.$nextTick(() => {
          this.turnPage()
          this.monitorAudio()
          setTimeout(() => {
            if (this.readerType == 2) {
              for (let i = 0; i < (Math.round(this.serverCurrPage / 2) - 1); i++) {
                this.pageTurn('next', true)
              }
            }
            this.audioFlip(this.currentGroupNum)
          }, 1000)
        })
      },
      //获取页面信息
      getBookDetail() {
        let url = ""
        let param = null
        if (this.readerType == 2) {
          url = `/api/pc/service/digitlib/${cookies.get('studentId')}/${this.bookId}/${this.$route.params.bookCode}/detail`
        } else if (this.readerType == 1) {
          url = this.mcBookDetailUrl
          param = {
            t: new Date().getTime(),
            studentId: cookies.get('studentId'),
            bookId: this.bookId
          }
        }
        return $get(url, param)
      },
      loadingImage(ev) {
        let target = ev.target
        if (+target.parentNode.getAttribute('data-group') === 0) {
          setTimeout(() => {
            this.isShowBookContent = true
          }, 1000)
        }
      },
      play(){
        setTimeout(() => {
          window.location.href = `/homework/activity/${cookies.get("studentId")}/${this.bookCode}/${this.bookId}`
        }, 300)
      },
      turnPage() {
        this.nowReadingPage += 2
        this.recordReadingProgress()
        this.book = document.querySelector('.reader-content')
        this.page = document.getElementsByClassName("turn-page")
        let bookLength = this.book.children.length - 2
        this.zIndex = this.book.children.length - 1
        for (let z = 0; z < bookLength; z++) {
          this.page[z].style.zIndex = this.zIndex--
        }
        document.querySelector('.last-part').style.zIndex = 0
      },
      //添加video的end事件监听声音结束，开始播放声音
      monitorAudio() {
        let audio = document.querySelectorAll('audio')
        Array.from(audio).map((item, idx) => {
          item.addEventListener('ended', (event) => {
            if(this.currentPlayingElement) {
              utils.removeClass(this.currentPlayingElement, 'playing')
              this.currentPlayingElement = null
              this.StateOfAudioControlOnPageCorner = 2
            }
            if (this.status.isVoiceReplay) return
            let tag = event.target
            let groupNum = tag.parentElement.getAttribute('data-group')
            let videoContent = document.querySelectorAll(`[data-group="${groupNum}"]`)
            this.currentGroupNum = groupNum //当前播放视频的页数
            if (this.isTurnPage) {
              if (this.isShowRightBtn && this.status.isPlay && this.currentGroupNum <= this.currentGroupTotal) {
                this.nextPage()
              } else {
                if (this.status.isPlay) {
                  setTimeout(() => {
                    if (videoContent[1].querySelector('audio')) {
                      videoContent[1].querySelector('audio').currentTime = 0
                      this.setSoundCtlBtnToPlaying(videoContent[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
                      videoContent[1].querySelector('audio').play()
                      this.isTurnPage = true
                    } else {
                      setTimeout(() => {
                        this.nextPage()
                      }, 3000)
                    }
                  }, 3000)
                }
              }
              this.isTurnPage = false
            } else {
              if(!videoContent[1]) return
              if (videoContent[1].querySelector('audio')) {
                videoContent[1].querySelector('audio').currentTime = 0
                this.setSoundCtlBtnToPlaying(videoContent[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
                videoContent[1].querySelector('audio').play()
              } else {
                if (this.status.isPlay){
                  setTimeout(() => {
                    this.nextPage()
                  }, 3000)
                }
              }
              this.isTurnPage = true
            }
          })
        })

        let playAudio = document.querySelectorAll('[data-group="0"]')
        //判断首页是否存在音频不存在翻到下一页
        if (playAudio[0].querySelector('audio')) {
          if (!isNaN(playAudio[0].querySelector('audio').duration)) {
            playAudio[0].querySelector('audio').currentTime = 0
          }
          this.setSoundCtlBtnToPlaying(playAudio[0].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
          playAudio[0].querySelector('audio').play()
          
        } else if (playAudio[1].querySelector('audio')) {
          if (!isNaN(playAudio[1].querySelector('audio').duration)) {
            playAudio[0].querySelector('audio').currentTime = 0
          }
          this.setSoundCtlBtnToPlaying(playAudio[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
          playAudio[1].querySelector('audio').play()
          this.isTurnPage = true
        } else {
          //判断是否自动翻页
          clearTimeout(this.delayTimer)
          this.delayTimer = setTimeout(() => {
            if (this.status.isPlay && this.currentGroupNum <= this.currentGroupTotal) {
              this.nextPage()
            }
          }, 3000)
        }
      },
      setSoundCtlBtnToPlaying( obj ) {
        if(this.currentPlayingElement) {
          utils.removeClass(this.currentPlayingElement, 'playing')
          this.currentPlayingElement = null          
        } 
        if(obj) {
          obj.className += ' playing'
        }
        this.currentPlayingElement = obj
        this.StateOfAudioControlOnPageCorner = 1
      },
      audioPause(isFrom) {
        let audio = document.querySelectorAll('audio')
        let playing = false
        //判断是否有有audio在播放中
        Array.from(audio).map((item, idx) => {
          if (isFrom === 'page') {
            item.pause()
            // item.currentTime = 0
          } else if (isFrom === 'play') {
            if (!item.paused) {
              playing = true
            }
          }
        })
        if (isFrom === 'play') {
          return playing
        }
      },
      audioPlay(idx, status){
        let audio = document.querySelectorAll('audio')
        if (status === 'playbackRate') {
          Array.from(audio).map((item, index) => {
            item.playbackRate = idx
          })
        } else if (status === 'mute') {
          Array.from(audio).map((item, index) => {
            item.muted = this.status.isMute
          })
        }
      },
      audioFlip(audioGroup) {
        let currentAudioGroup = document.querySelectorAll(`[data-group="${audioGroup}"]`)
        //判断每组是否有音频
        if (currentAudioGroup.length > 0 && currentAudioGroup[0].querySelector('audio')) {
          currentAudioGroup[0].querySelector('audio').currentTime = 0
          this.setSoundCtlBtnToPlaying(currentAudioGroup[0].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
          currentAudioGroup[0].querySelector('audio').play()
          this.isTurnPage = false
        } else if (currentAudioGroup.length > 1 && currentAudioGroup[1].querySelector('audio')) {
          if (audioGroup != 0) {
            clearTimeout(this.delayTimer)
            this.delayTimer = setTimeout(() => {
              currentAudioGroup[1].querySelector('audio').currentTime = 0
              this.setSoundCtlBtnToPlaying(currentAudioGroup[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
              currentAudioGroup[1].querySelector('audio').play()
              this.isTurnPage = true
            }, 3000)
          } else {
            currentAudioGroup[1].querySelector('audio').currentTime = 0
            this.setSoundCtlBtnToPlaying(currentAudioGroup[1].querySelector('audio').parentElement.querySelector('.sound-control-btn'))
            currentAudioGroup[1].querySelector('audio').play()
            this.isTurnPage = true
          }
        } else {
          //判断是否是一组第一组停顿3s与判断是否需要自动翻页
          if (this.currentGroupNum <= this.currentGroupTotal) {
            if (audioGroup != 0) {
              clearTimeout(this.delayTimer)
              this.delayTimer = setTimeout(() => {
                if (this.status.isPlay && this.currentGroupNum <= this.currentGroupTotal) {
                  this.nextPage()
                }
              }, 6000)
            } else {
              clearTimeout(this.delayTimer)
              this.delayTimer = setTimeout(() => {
                if (this.status.isPlay && this.currentGroupNum <= this.currentGroupTotal) {
                  this.nextPage()
                }
              }, 3000)
            }
          }
        }
      },
      audioControlOnPageCorner(event) {
        if (this.status.isTurnCurrentPage) return
        if(this.currentPlayingElement) {
          utils.removeClass(this.currentPlayingElement, 'playing')
        }
        this.status.isShowSpeed = false
        let tag = event.target
        this.currentAudioOfAudioControlOnPageCorner = tag.parentElement.parentElement.querySelector('audio')
        if (tag.getAttribute('data-page') === 'one') {
          this.isTurnPage = false
        } else if (tag.getAttribute('data-page') === 'two') {
          this.isTurnPage = true
        }
        this.audioPause('page')
        /**
         *   @ this.StateOfAudioControlOnPageCorner 1: needs to pause; 2: needs to play
         **/
        if( event.target.parentElement == this.currentPlayingElement ) {
          this.currentPlayingElement = null
          setTimeout(() => {
            if(this.StateOfAudioControlOnPageCorner == 1) {
              this.StateOfAudioControlOnPageCorner = 2
              this.currentAudioOfAudioControlOnPageCorner.pause()
              // utils.removeClass(tag.parentElement, 'playing')
            } else if(this.StateOfAudioControlOnPageCorner == 2) {
              this.StateOfAudioControlOnPageCorner = 1
              this.currentAudioOfAudioControlOnPageCorner.play()
              tag.parentElement.className += ' playing'
              this.currentPlayingElement = tag.parentElement
            }
          }, 0)
        } else {
          this.StateOfAudioControlOnPageCorner = 1
          this.currentAudioOfAudioControlOnPageCorner.play()
          tag.parentElement.className += ' playing'
          this.currentPlayingElement = tag.parentElement
        }
  
        if (this.status.isPlay) {
          this.status.isVoiceReplay = false
        } else {
          this.status.isVoiceReplay = true
        }
      },
      setPlay() {
        this.status.isShowSpeed = false
        this.status.isVoiceReplay = false
        if (this.status.isPlay) {
          sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_manual_play'})
          this.playStatusHoverClass = this.hoverTextClassName.AUTO
          this.status.isPlay = !this.status.isPlay
        } else {
          sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_auto_play'})
          this.playStatusHoverClass = this.hoverTextClassName.MANUAL
          this.status.isPlay = !this.status.isPlay
          if (!this.audioPause('play') && this.currentGroupNum <= this.currentGroupTotal) {
            this.nextPage()
          }
        }
      },
      showSpeed(){
        this.isSpeedHoverTip = !this.isSpeedHoverTip
        this.status.isShowSpeed = !this.status.isShowSpeed
      },
      pageTurn(direction, isLocationPage){
        if( this.currentAudioOfAudioControlOnPageCorner ) {
          this.currentAudioOfAudioControlOnPageCorner.currentTime = 0
        }
        this.StateOfAudioControlOnPageCorner = 1
        this.status.isVoiceReplay = false
        clearTimeout(this.delayTimer)
        if (direction === 'next' && !this.status.isTurnCurrentPage) {
          if (this.bookPages < this.book.children.length - 2) {
            if (this.page[this.bookPages].style.animation === "page 0.7s linear 1 forwards") return
            this.nowReadingPage += 2
            this.recordReadingProgress()
            this.status.isTurnCurrentPage = true
            if (isLocationPage) {
              this.page[this.bookPages].style.animation = "page 0s linear 1 forwards"
              this.status.isTurnCurrentPage = false
              let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[1]
              changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 1
              changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 0
              this.page[this.bookPages].style.zIndex = 0
              this.bookPages++
              if (this.bookPages != this.book.children.length - 2) {
                this.isShowRightBtn = true
              } else {
                this.isShowRightBtn = false
              }
              this.audioPause('page')
              this.currentGroupNum++
              if (this.currentGroupNum < 0) return
              // this.audioFlip(this.currentGroupNum)
            } else {
              this.page[this.bookPages].style.animation = "page 0.7s linear 1 forwards"
              setTimeout(() => {
                this.status.isTurnCurrentPage = false
              }, 700)
              setTimeout(() => {
                //修改层级兼容ie
                let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[1]
                changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 1
                changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 0
                this.page[this.bookPages].style.zIndex = 0
                this.bookPages++
              }, 250)
              setTimeout(() => {
                if (this.bookPages != this.book.children.length - 2) {
                  this.isShowRightBtn = true
                } else {
                  this.isShowRightBtn = false
                }
                this.audioPause('page')
                this.currentGroupNum++
                if (this.currentGroupNum < 0) return
                this.audioFlip(this.currentGroupNum)
              }, 260)
            }
            if( this.page[this.bookPages] ) {
              this.zIndex = this.page[this.bookPages].style.zIndex
            }
            this.isShowLeftBtn = true
          } else {
            setTimeout(() => {
              this.bookPages = this.book.children.length - 2
            }, 250)
          }
        } else if (direction === 'pre' && !this.status.isTurnCurrentPage) {
          this.isShowRightBtn = true
          if (this.bookPages != 0) {
            this.status.isTurnCurrentPage = true
            if (this.page[this.bookPages - 1].style.animation === "page1 0.7s linear 1 forwards") return
            this.nowReadingPage -= 2
            this.recordReadingProgress()
            this.page[this.bookPages - 1].style.animation = "page1 0.7s linear 1 forwards"
            setTimeout(() => {
              this.status.isTurnCurrentPage = false
            }, 700)
            setTimeout(() => {
              //修改层级兼容ie
              if (this.currentGroupNum > this.bookPageLast.group) this.currentGroupNum = this.bookPageLast.group
              let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[0]
              changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 0
              changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 1
              this.page[this.bookPages - 1].style.zIndex = this.zIndex++
              this.bookPages--
            }, 250)
          } else {
            setTimeout(() => {
              this.bookPage = 0
            }, 250)
          }
          setTimeout(() => {
            if (!this.bookPages) {
              this.isShowLeftBtn = false
            } else {
              this.isShowLeftBtn = true
            }
            this.audioPause('page')
            this.currentGroupNum--
            this.audioFlip(this.currentGroupNum)
          }, 260)
        }
      },
      nextPage(isLocationPage){
        if (this.status.isTurnCurrentPage) return
        this.isShowLeftBtn = true
        if (this.bookPages < this.book.children.length - 2) {
          this.status.isTurnCurrentPage = true
          if (this.page[this.bookPages].style.animation === "page 0.7s linear 1 forwards") return
          this.nowReadingPage += 2
          this.recordReadingProgress()
          this.page[this.bookPages].style.animation = "page 0.7s linear 1 forwards"
          this.zIndex = this.page[this.bookPages].style.zIndex
          setTimeout(() => {
            this.status.isTurnCurrentPage = false
          }, 700)
          setTimeout(() => {
            //修改层级兼容ie
            let changePageZindex = document.querySelectorAll(`[data-group="${this.currentGroupNum}"]`)[1]
            changePageZindex.parentElement.querySelector('.page-hide').style.zIndex = 1
            changePageZindex.parentElement.querySelector('.page-show').style.zIndex = 0
            this.page[this.bookPages].style.zIndex = 0
            this.bookPages++
          }, 250)
        } else {
          setTimeout(() => {
            this.bookPages = this.book.children.length - 2
          }, 250)
        }
        setTimeout(() => {
          if (this.bookPages < this.book.children.length - 2) {
            this.isShowRightBtn = true
          } else {
            this.isShowRightBtn = false
          }
          this.audioPause('page')
          this.currentGroupNum++
          if (this.currentGroupNum < 0) return
          this.audioFlip(this.currentGroupNum)
        }, 260)
      },
      recordReadingProgress() {
        if (this.readerType != 2) return //目前只有第三方绘本支持阅读进度记录
        if (this.nowReadingPage >= this.pageCount) {
          this.nowReadingPage = this.pageCount
        }
      }
    },
    components: {
      myHeader
    }
  }
</script>

<style lang="stylus" scoped>
  ul, li
    list-style: none
    list-style-image: none

  a
    text-decoration: none
    color: #333

  /*翻书下一页的动画*/
  @keyframes page {
    0% {
      -webkit-transform: rotateY(0deg)
      -moz-transform: rotateY(0deg)
      -ms-transform: rotateY(0deg)
      transform: rotateY(0deg)
    }
    100% {
      -webkit-transform: rotateY(-180deg)
      -moz-transform: rotateY(-180deg)
      -ms-transform: rotateY(-180deg)
      transform: rotateY(-180deg)
    }
  }

  /*翻书上一页的动画*/
  @keyframes page1 {
    0% {
      -webkit-transform: rotateY(-180deg)
      -moz-transform: rotateY(-180deg)
      -ms-transform: rotateY(-180deg)
      transform: rotateY(-180deg)
    }
    100% {
      -webkit-transform: rotateY(0deg)
      -moz-transform: rotateY(0deg)
      -ms-transform: rotateY(0deg)
      transform: rotateY(0deg)
    }
  }
    
  .book-wrapper
    color: #fff
    background-repeat: no-repeat
    background-position: center
    background-size: 1920px
    background-color: #624490
    width: 100%
    height: 100%
    background-image: url('../../../img/readers/bg-readbook-1280-1920.png')
    background-size: 1920px
    [v-cloak]
      display: none
    .readers-title
      & > p
        padding: 0
        margin: 0 0 10px
        font-size: 24px
      & > .book-name
        font-size: 36px
    .hang-board-position-control
      position: absolute
      top: 0
      left: 0
      right: 0
      text-align: center 
      .hang-board
        display: inline-block
        position: relative
        margin: 0 auto
        line-height: 27px
        font-size: 24px
        font-weight: 600
        color: #ffffff
        height: 119px
        background-image: url('../../../img/library/top-hang-left-end.png')
        background-position: left
        background-size: 100%
        background-size: contain
        background-repeat: no-repeat
        padding: 0 124px 0 291px
        .text-wrap
          position: relative
          top: -86px
          left: -80px
          display: table
          height: 54px
          .text-wrap-hd
            display: table-cell
            vertical-align: middle
        .right-end
          position: absolute
          top: 0
          right: 0
          height: 100%
          width: 124px
          background-image: url('../../../img/library/top-hang-right-end.png')
          background-size: contain
          background-repeat: no-repeat
        .infinite-part
          height: 100%
          width: 100%
          background-image: url('../../../img/library/top-hang-infinite-part.png')
          background-repeat: repeat-x
          background-size: contain
    .top
      height: 50%
      margin-bottom: -400px
    .book-contain
      width: 1000px
      min-height: 462px
      position: relative
      top: 127px
      margin: 0 auto
      .leftbtn
        position: absolute
        width: 38px
        height: 78px
        top: 236px
        left: 29px
        cursor: pointer
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -195px -105px
        &:hover
          opacity: 0.8
        &:active
          background-position: -342px -105px
      .rightbtn
        position: absolute
        width: 40px
        height: 78px
        top: 236px
        right: 29px
        cursor: pointer
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -275px -105px
        &:hover
          opacity: 0.8
        &:active
          background-position: -421px -105px
      .replay-this-book-btn
        position: absolute
        width: 92px
        height: 80px
        top: 236px
        right: -24px
        cursor: pointer
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -1px -191px
        &:hover
          background-position: -119px -191px
        &:active
          background-position: -242px -191px
      .reader-content-loading,
      .reader-content
        width: 824px
        height: 462px
        position: absolute
        top: 70px
        left: 90px
        -webkit-perspective: 1200px
        -moz-perspective: 1200px
        -ms-perspective: 1200px
        perspective: 1200px
        -webkit-transform-style: preserve-3d
        -moz-transform-style: preserve-3d
        -ms-transform-style: preserve-3d
        transform-style: preserve-3d
        .loading-book
          background: #fff
          z-index: 1
          & > img
            width: 30px
            height: 30px
            display: block
            position: absolute
            left: 50%
            top: 50%
            margin: -15px 0 0 -15px
        .sound-control-btn
          display: block
          width: 44px
          height: 44px
          position: absolute
          top: 20px
          left: 20px
          background: url('../../../img/library/voice_btn_sprite.png') no-repeat
          background-size: 96px
          background-position: 0 0
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
          cursor: pointer
          &:hover
            opacity: 0.8
          &:active
            background-position: -52px 0
          img.wave-1
            position: absolute
            width: 44px
          img.wave-2
            position: absolute
            width: 44px
            animation-fill-mode: both
          img.wave-3
            position: absolute
            width: 44px
            animation-fill-mode: both
          &.playing
            img.wave-1
              animation: wave_1_animate 1.5s infinite
              animation-fill-mode: both
            img.wave-2
              animation: wave_1_animate 1.5s infinite
              animation-delay: 0.5s
              animation-fill-mode: both
            img.wave-3
              animation: wave_1_animate 1.5s infinite
              animation-delay: 1s
              animation-fill-mode: both
        .replay-btn-right
          -webkit-transform: translateZ(2px)
          -moz-transform: translateZ(2px)
          -ms-transform: translateZ(2px)
          transform: translateZ(2px)
          cursor: pointer
          left: initial
          right: 20px
          &:hover
            opacity: 0.8
          &:active
            background-position: -52px 0
        .no-replay-btn
          display: block
          width: 44px
          height: 44px
          position: absolute
          top: 20px
          left: 20px
          background: url('../../../img/readers/novoice.png')
          background-size: 100% 100%
          &.no-replay-btn-right
            display: block
            width: 44px
            height: 44px
            position: absolute
            top: 20px
            right: 20px
            left: initial
            background: url('../../../img/readers/novoice.png')
            background-size: 100% 100%
        & > div,
        .page-show,
        .page-hide
          width: 412px
          height: 462px
          position: absolute
          & > img
            width: 100%
            height: 464px
          & > .turn-page-img
            -webkit-transform: translateZ(2px)
            -moz-transform: translateZ(2px)
            -ms-transform: translateZ(2px)
            transform: translateZ(2px)
          .reader-txt
            width: 389px
            height: 96px
            line-height: 1.4
            font-size: 20px
            position: absolute
            top: 350px
            left: 20px
            color: #000
            margin: 0 auto
            -webkit-transform: translateZ(1px)
            -moz-transform: translateZ(1px)
            -ms-transform: translateZ(1px)
            transform: translateZ(1px)
          .reader-txt-right
            -webkit-transform: translateZ(2px)
            -moz-transform: translateZ(2px)
            -ms-transform: translateZ(2px)
            transform: translateZ(2px)
        .book-page
          display: block
          width: 24px
          height: 26px
          text-align: center
          line-height: 23px
          font-style: normal
          background: url(../../../img/readers/no@2x.png)
          background-size: 100% 100%
          color: #fff
          position: absolute
          bottom: 10px
          left: 16px
          font-size: 14px
        .turn-book-page
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
        .turn-book-page-right
          -webkit-transform: translateZ(2px)
          -moz-transform: translateZ(2px)
          -ms-transform: translateZ(2px)
          transform: translateZ(2px)
        .page-right
          right: 26px
          left: initial
        .turn-page
          position: absolute
          right: 0
          -webkit-transform-origin: left
          -moz-transform-origin: left
          -ms-transform-origin: left
          transform-origin: left
          -webkit-transform-style: preserve-3d
          -moz-transform-style: preserve-3d
          -ms-transform-style: preserve-3d
          transform-style: preserve-3d
          & > div
            display: block
            width: 100%
            min-height: 462px
            position: absolute
          .page-hide
            z-index: 0
            -webkit-transform: rotatey(-180deg) translateZ(1px)
            -moz-transform: rotatey(-180deg) translateZ(1px)
            -ms-transform: rotatey(-180deg) translateZ(1px)
            transform: rotatey(-180deg) translateZ(1px)
          .page-show
            z-index: 1
            -webkit-transform: translateZ(1px)
            -moz-transform: translateZ(1px)
            -ms-transform: translateZ(1px)
            transform: translateZ(1px)
        .last-part
          position: absolute
          right: 0
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
      .book-bg
        width: 868px
        height: 498px
        position: relative
        top: 17px
        left: 66px
      .operation-reading
        position: absolute
        bottom: -75px
        right: 66px
        margin-left: 10px
        & > div
          display: inline-block
          width: 44px
          margin-left: 30px
          cursor: pointer
        .operation-page-turn
          .play-btn
            display: block
            width: 44px
            height: 44px
            background: url('../../../img/readers/play.png')
            background-size: 100% 100%
            &:hover
              background: url('../../../img/readers/playhover.png')
              background-size: 100% 100%
            &:active
              background: url('../../../img/readers/playvisited.png')
              background-size: 100% 100%
            &.hover-text-auto:hover
              &:after
                content: "点击自动翻页"
                font-size: 12px
                display: inline-block
                position: absolute
                width: 86px
                height: 24px
                border-radius: 15px
                background-color: rgba(255, 255, 255, 0.5)
                top: -28px
                left: 9px
                text-align: center
                line-height: 22px
                -webkit-font-smoothing: antialiased
            &.hover-text-man:hover
              &:after
                content: "点击手动翻页"
                font-size: 12px
                display: inline-block
                position: absolute
                width: 86px
                height: 24px
                border-radius: 15px
                background-color: rgba(255, 255, 255, 0.5)
                top: -28px
                left: 9px
                text-align: center
                line-height: 22px
                -webkit-font-smoothing: antialiased
          .display-btn
            background: url('../../../img/readers/display.png')
            background-size: 100% 100%
            &:hover
              background: url('../../../img/readers/displayhover.png')
              background-size: 100% 100%
            &:active
              background: url('../../../img/readers/displayvisited.png')
              background-size: 100% 100%
          .no-play-btn
            display: block
            width: 44px
            height: 44px
            background: url('../../../img/readers/noplay.png')
            background-size: 100% 100%
        .operation-voice
          .muted-btn
            background: url('../../../img/readers/mute.png')
            background-size: 100% 100%
            &:hover
              background: url('../../../img/readers/mutehover.png')
              background-size: 100% 100%
            &:active
              background: url('../../../img/readers/mutevisited.png')
              background-size: 100% 100%
  .record-flag
     position:absolute
     right:30px
     height:33px 
     width:106px
     cursor: pointer
     @media screen and (max-width:1280px)
       right:40px
     @media screen and (min-width:1281px) and (max-width:1480px)
       right:60px
     @media screen and (min-width:1481px) and (max-width:1920px)
       right:300px
     @media screen and (min-width:1921px)
       right:360px
     &:hover 
       opacity: .8
     &.book-record-datas
        top:86px
       .flag
         background:url(../../../img/library/dl-record-book-inforamtion.png) no-repeat
         background-size:27px 33px
     &.listen-record-sound
       top:27px
       .flag
         background:url(../../../img/library/dl-listen-record-data.png) no-repeat
         background-size:27px 33px
       &.grayButtonFilter
         filter:grayscale(1)
     .flag
      position:absolute
      height:33px 
      width:27px
     .text
      position:absolute
      top:1.5px
      right:0px
      width:90px
      height:30px
      border-top-right-radius:30px
      border-bottom-right-radius:30px
      color:#fff
      text-indent:21px
      font-size:14px 
      line-height:30px
      background:rgba(0,0,0,.3)  
@keyframes wave_1_animate
  0%
    opacity: 0
  50%
    opacity: 1
  100%
    opacity: 1
.recoder-progress
      position:relative
      top:12px
      width:948px
      height:42px
      display:flex
      display:-webkit-flex
      justify-content:center
      align-items:center
      -webkit-justify-content:center
      -webkit-align-items:center
      .recorder-item
         box-sizing:border-box
         width:20px
         height:24px
         border:2px solid #B396FF
         color:#fff
         font-size:12px
         line-height:20px
         text-align:center
         border-radius: 5px
         background:#8561ED
         transition:all .5s ease-in
         &.have-recorded
           background:#FFB600
           border:2px solid #FFCC4E
         &.recording
           width:25px
           height:30px
           font-size:16px
           line-height:25px
           background:#FFB600
           border:2px solid #FFCC4E
         &:nth-child(2n+1){
           margin-left:4px
         }
</style>
