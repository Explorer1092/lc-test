<template lang="jade">
  .book-wrapper(v-cloak)
    .hang-board
      .box
        .left
        .center
          p.above(v-if="!!bookTitle.levelName") {{bookTitle.levelName}}
          p.bottom {{bookTitle.bookName}}
        .right
    activity-btn(v-if="isShowActivity",:playFun="joinPlay")
    my-header
    processBar(ref="processBar", @processComplete="openThisBook", :start="loadStart", :stop="loadEnd", :sumNumber="bookPageSum", :loadedNumber="loadImages", :barColor="`color5`")
    .book-contain
      audio(autoplay, @ended="pageReadEnd", ref="bookAudio")
      .side-left
        .btn-left(@click="turnPrev", v-show="isShowLeftBtn")
      .book-content(ref="bookContent")
        div(@transitionend="endTurned",:class="[{'open': isBookOpen}, 'page'+item.sequence, 'turnslow']", v-for="(item,index) in pagesData", :key="index")
          img(@load="loadImage", 
              @error="errorImage(index)", 
              :src="item.images[0].url==='' ? defaultImage : item.images[0].url",
              width="412",
              height="464")
          span(@click.capture="audioStateChange(item.sequence)", :class="{'playing':currentPageNum===item.sequence && audioPause===false }" v-if="(!item.audios[0] || !item.audios[0].url) ? false : true")
            img(src="../../../img/library/voice_wave_1.png")
            img(src="../../../img/library/voice_wave_2.png")
            img(src="../../../img/library/voice_wave_3.png")
          i(class="read-await", v-show="autoTurn && timer && (!item.audios[0] || !item.audios[0].url) && currentPageNum===item.sequence")
          p(class="reader-txt", v-if="!!item.subtitle") {{item.subtitle}}
          i(class="pagination") {{item.sequence}}
      .side-right
        .btn-right(@click="turnNext", v-show="isShowRightBtn")
        .btn-replay(@click="replayBook", v-show="isShowReplayBtn")
    ul.operation-box
      li(@click="autoTurn=!autoTurn", :class="{'btn-autoturn':autoTurn, 'btn-handturn':!autoTurn}")
      li(@click="muted=!muted", :class="{'btn-voice':!muted, 'btn-novoice':muted}")
      li(@click="audioSpeedBtnsShow=!audioSpeedBtnsShow", :class="['btn-speed', {'btn-speed-1':audioSpeedBtn1, 'btn-speed-2':audioSpeedBtn2, 'btn-speed-3':audioSpeedBtn3}]")
      transition(name="fade05")
        li(@click="changeAudioSpeed(0.8, 1, 0, 0)", class="btn-speed-1", v-if="audioSpeedBtnsShow")
      transition(name="fade10")
        li(@click="changeAudioSpeed(1.0, 0, 1, 0)", class="btn-speed-2", v-if="audioSpeedBtnsShow")
      transition(name="fade15")
        li(@click="changeAudioSpeed(1.3, 0, 0, 1)", class="btn-speed-3", v-if="audioSpeedBtnsShow")

</template>

<script>
import cookies from "cookies-js"
import axios from "axios"
import formurlencoded from 'form-urlencoded'
import utils from "../../../utils/_untils.js"
import myHeader from "../header.vue"
import processBar from "./processbar.vue"
import defaultImage from "../../../img/digireader/empty_dino.png"
import activityBtn from "./activity_btn.vue"
export default {
  props: [],
  data() {
    return {
      // mcBook getBookDetail 交互接口
      mcBookDetailUrl: "/rest/learninggw/api/pc/service/reader/getBookDetail",
      // 打点记录的接口
      readStartTimeUrl: '/rest/learninggw/api/pc/service/reader/setBeginTime', // read start time 记录接口
      readEndTimeUrl: '/rest/learninggw/api/pc/service/reader/setEndTime', // read end time 记录接口
      activityButtonInfoUrl: '/rest/learninggw/api/pc/material/activity/getActivityButtonInfo', // 
      // readerType
      readerType: this.$route.params.type, //1为mc_reader 2为第三方绘本
      // 图片加载
      defaultImage: defaultImage, // 图片加载错误, 默认图片
      loadImages: 0, // 已加载图片的数量
      loadStart: false, // 加载开始否
      loadEnd: false, // 加载结束否
      loadProcess: 0, // 加载进度
      // Buttons:
      isShowActivity: false, // 状态：去参加活动按钮
      isShowLeftBtn: false, // 状态：控制 book向左翻页按钮的显示隐藏
      isShowRightBtn: true, // 状态：控制 book向右翻页按钮的显示隐藏
      isShowReplayBtn: false, // 状态：控制 book replay按钮按钮的显示隐藏
      // Student:
      studentId: cookies.get("studentId"), // 学生 ID
      // Book:
      bookId: this.$route.params.id, // 书本 ID
      bookCode: this.$route.params.bookCode, // 书本 code 
      bookDetail: {}, // 书籍 详细信息
      bookTitle: {}, // 书籍的Title, 由于绘本的版本不同，要做不同的处理
      bookPageSum: 0, // 书籍 总页数
      bookAudioSrcs: [], // 书籍包含的所有音频 路径
      bookAudio: "", // 书籍的音频播放器
      isBookOpen: false, // 书籍是否打开
      // Page:
      pagesData: [], // 书本页 详细信息
      pages: "", // 书本的所有页 Dom文档
      pageBaseNum: 1, // 书翻到了第几页的页码
      currentPageNum: 1, // 当前的页码
      startPageNum: 1, // 开始读书籍的开始页（因为做了进度存储）
      pageHaveAudio: false, // 当前页是否有音频资源，默认：false
      currentPageReadEnd: false, // 当前页是否已读完（包括有音频 和 无音频的书页）
      pageTurnEnd: true, // 翻页结束状态，默认：true
      pageActionBox: [], // 用来记录向后翻页和向前翻页的动作的记忆盒子，向后翻页会存入-个 '1', 向前翻页会存入一个 '-1'
      transitionEndTimes: 1, // 翻页时 transition执行的次数，与 pageBaseNum配合，判断是否在连续翻页中
      turnDuration: 1, // 上一页，下一页 的翻页过程的持续时间(s), 为class类 turnslow + turnlazy 的时间和
      replayDuration: 300, // replay按钮被点击时 一次翻页的持续时间(ms), 为 class类 turnfast + turnlazyfast 的时间和
      locationPageDuration: 200, // 定位到上次读到的书页，没翻一次页，所持续的时间
      // 页面状态控制
      autoTurn: false, // 是否自动翻页
      muted: false, // 音频是否静音
      audioCurrentSpeed: 1.0, // 音频当前播放速度
      audioSpeedBtnsShow: false, // 音频播放速度的显示状态
      audioPause: false, // 音频的暂停状态
      audioPauseCanChange: true, // 音频暂停状态是否可改变
      // 当前显示的音频速度按钮
      audioSpeedBtn1: false,
      audioSpeedBtn2: true,
      audioSpeedBtn3: false,
      //没有音频页的定时器
      timer: null
    }
  },
  created() {
    if (this.readerType == 2) {
      //第三方绘本
      this.getBookDetail(
        `/rest/learninggw/api/pc/service/digitlib/${this.studentId}/${
          this.bookId
        }/${this.bookCode}/detail`
      )
    } else if (this.readerType == 1) {
      //major course reader
      this.getBookDetail(this.mcBookDetailUrl, {
        t: new Date().getTime(),
        studentId: this.studentId,
        bookId: this.bookId
      })
    }
  },
  mounted() {
    this.loadStart = true // 显示进度条组件
  },
  beforeDestroy() {
    // 清除 timer
    this.timer && this.clearTimer()
  },
  computed: {
    // 重组数组 - 奇数索引正序 偶数索引倒序
    pagesFormatArr() {
      let arr = this.bookDetail.pages
      let arr1 = [],
        arr2 = [],
        newArr = []

      arr.forEach(function(item, index, thisArray) {
        if (index % 2 === 0) {
          arr1.push(item)
        } else {
          arr2.unshift(item)
        }
      })

      for (let i = 0; i < arr1.length; i++) {
        arr[i] ? newArr.push(arr1[i]) : ""
        arr2[i] ? newArr.push(arr2[i]) : ""
      }
      return newArr
    },
    // 组建 audios的 url数组
    audiosArr() {
      let arr = this.bookDetail.pages,
        newArr = []
      arr.forEach((item, index, thisArr) => {
        item.audios.length != 0 && item.audios[0].url
          ? newArr.push(item.audios[0].url)
          : newArr.push("")
      })
      return newArr
    },
    // 能执行翻页操作的 左侧书页的最大页号
    maxNum() {
      return this.pagesData.length % 2 === 0 ? this.pagesData.length - 1 : this.pagesData.length
    }
  },
  methods: {
    // 得到关于书籍的详细信息
    getBookDetail(url, paramObj) {
      axios.get(url, { params: paramObj }).then(res => {
        this.bookDetail = res.data.data // book的构成数据
        this.pagesData = this.pagesFormatArr // 格式化后的 bookpages 的数据
        this.bookPageSum = this.bookDetail.pageCount // 书的总页数
        this.startPageNum = this.bookDetail.currentPage || this.startPageNum // 设置 书籍的开始页
        this.bookAudioSrcs = this.audiosArr // 音频的数组
        this.bookAudio = this.$refs.bookAudio // 音频播放器 dom
        this.pages = this.$refs.bookContent // 存储 pages Dom 已被后续使用
        this.bookCode = this.bookDetail.code // bookCode
        // bookTitle
        if (this.bookDetail.type == 1 && this.bookDetail.curriculumSN && this.bookDetail.curriculumSN.length != 0) {
          let levelName = `Level ${res.data.data.curriculumSN[0].split('-')[1].substr(1)}`
          let unitName = `Unit ${res.data.data.curriculumSN[0].split('-')[2].substr(1)}`
          this.bookTitle = {
            bookName: this.bookDetail.name,
            levelName: `${levelName}  ${unitName}`
          }
        } else {
          this.bookTitle = {
            bookName: this.bookDetail.name
          }
        }
      })
    },
    // 图片加载完成后，执行之后的操作
    loadImage(e) {
      this.loadImages++
      if (this.loadImages === this.bookPageSum) {
        this.loadEnd = true // 图片都加载完了之后，loadEnd=true
      }
    },
    // 图片加载失败, 使用备用图片
    errorImage(num) {
      this.pagesData[num].images[0].url = this.defaultImage
    },
    // 打开这本书
    openThisBook() {
      // 1. 显示书本
      this.isBookOpen = true
      // 2. 开始读书
      this.readThisBook()
    },
    // 开始读书
    readThisBook() {
      // 打点：记录 read start time
      this.recordReadStartTime()
      // 定位从哪一页开始读
      if (this.startPageNum <= 2) {
        // 开始读当前页
        this.readCurrentPage()
      } else {
        this.locationToRead()
      }
    },
    // 从上次读到的位置开始读书
    locationToRead() {
      let needTurnTimes = Math.ceil(this.startPageNum / 2) - 1 // 翻到 startPageNum页，所需要执行翻页的次数
      let intervalTimer = setInterval(() => {
        needTurnTimes --
        this.turnNext()
        if (!needTurnTimes) {
          intervalTimer && clearInterval(intervalTimer) // 清除 intervalTimer
        }
      }, this.locationPageDuration)
    },
    // 读当前页
    readCurrentPage() {
      this.currentPageReadEnd = false // 当前页，标记为 未读完状态
      if (this.haveAudioSource(this.currentPageNum)) {
        this.audioPlay() // 有音频资源，播放音频
      } else {
        this.dotPlay() // 没有音频，dotPlay()
      }
    },
    // 如果当前页有音频，播放音频
    audioPlay() {
      this.audioPause = false // 当页上的小喇叭 取消暂停状态
      this.bookAudio.muted = this.muted // 设置静音否
      this.bookAudio.playbackRate = this.audioCurrentSpeed // 设置当前播放速度
      this.resetAudio() // 重置 bookAudio
      this.bookAudio.play()
        .then(() => {
          this.bookAudio.autoplay = true
        })
        .catch((e) => {
          this.audioPause = true
        })
    },
    // 当前页没有音频时，显示延时等待动画效果 结束
    dotPlay() {
      //自动翻页情况下，没有音频资源的人为设定5s阅读时间
      if (this.autoTurn) {
        this.timer = setTimeout(() => {
          this.pageReadEnd() // 不存在音频资源，手动 调用 audioEnded事件
        }, 5000)
      } else {
        this.pageReadEnd() // 不存在音频资源，手动 调用 audioEnded事件
      }
    },
    // 当页阅读完毕
    pageReadEnd() {
      // 打点：记录播放进度
      this.recordReadProcess()
      this.currentPageReadEnd = true // 当前页，标记为读完状态
      if (this.pageHaveAudio) {
        this.audioPause = true // 小喇叭 切换暂停状态
      } else {
        this.timer && this.clearTimer()
      }
      // 如果是最后一页, 播放图书阅读就此结束
      if (this.currentPageNum === this.bookPageSum) {
        // 打点：记录 read end time
        this.recordReadEndTime()
        return
      } 
      // 偶数页 和 奇数页 分别做处理
      if (this.currentPageNum % 2 != 0) {
        // 奇数页
        this.currentPageNum++
        this.readCurrentPage()
      } else {
        // 偶数页
        this.autoTurn && this.turnNext()
      }
    },
    // 设置 控制翻页相关按钮的显示状态
    setTurnBtnsStatus() {
      // 1. 书籍页数小于 2时
      if (this.bookPageSum <= 2) {
        this.isShowLeftBtn = false
        this.isShowRightBtn = false
        this.isShowReplayBtn = false
      }
      // 2. 书籍页数 不小于 2时
      else {
        // 自动翻页时
        if (this.autoTurn) {
          // 2-1: 非最后一页时
          this.isShowLeftBtn = false
          this.isShowRightBtn = false
          this.isShowReplayBtn = false
          // 2-2: 最后一页
          if (this.pageBaseNum === this.maxNum) {
            this.isShowReplayBtn = true
          }
        }
        // 非自动翻页时
        else {
          // 2-1: 第一页时
          if (this.pageBaseNum === 1) {
            this.isShowLeftBtn = false
            this.isShowRightBtn = true
            this.isShowReplayBtn = false
          }
          // 2-2: 最后一页时
          else if (this.pageBaseNum === this.maxNum) {
            this.isShowLeftBtn = true
            this.isShowRightBtn = false
            this.isShowReplayBtn = true
          }
          // 2-3: 非第一页 && 非最后一页 时
          else {
            this.isShowLeftBtn = true
            this.isShowRightBtn = true
            this.isShowReplayBtn = false
          }
        }
      }
    },
    // 向后翻页
    turnNext() {
      if (this.pageBaseNum === this.maxNum) return // 当 currentPageNum 达到左侧能达到的最大页号时，不执行翻页
      this.resetAudio() // 首先重置 bookAudio
      this.pageTurnEnd = false // 翻页结束状态置为 false
      this.audioPauseCanChange = false // 音频暂停状态是否可改变 置为：false
      this.timer && this.clearTimer() // 清除timer
      let targetPage = this.getPage(this.pageBaseNum + 1), // 获取 target页的 DOM
        nextPage = this.getPage(this.pageBaseNum + 2) // 获取 next页的 DOM
      utils
        .removeClass(targetPage, "turnlazy turnfast turnlazyfast") // 通过改变 class 配合 css,达到向后翻页效果
        .addClass(targetPage, "turned")
        .removeClass(nextPage, "turnfast turnlazyfast")
        .addClass(nextPage, "turned turnlazy")
      this.pageBaseNum += 2 // 操作两页，所以 pageBaseNum 加 2
      this.currentPageNum = this.pageBaseNum // 设置当前的页码，供播放音频使用
      this.pageActionBox.push(1, 1) // 翻页动作记忆盒子 存入动作 '1'，供判断是否连续翻页使用
      this.pageBaseNum === this.maxNum && (this.isShowRightBtn = false) // 如果翻到最后一页，【立即】隐藏向后翻页按钮
    }, 
    // 向前翻页
    turnPrev() {
      if (this.pageBaseNum === 1) return // 判断 this.pageBaseNum === 1时，不往下执行
      this.pageBaseNum === this.maxNum && (this.isShowReplayBtn = false) // 处在最后一页时，点击向前翻页，replay按钮立即隐藏
      this.resetAudio() // 首先重置 bookAudio
      this.pageTurnEnd = false // 翻页结束状态置为 false
      this.audioPauseCanChange = false // 音频暂停状态是否可改变 置为：false
      this.timer && this.clearTimer() // 清除timer
      let targetPage = this.getPage(this.pageBaseNum), // 获取 target页的 DOM
        prevPage = this.getPage(this.pageBaseNum - 1) // 获取 prev页的 DOM
      utils
        .addClass(prevPage, "turnlazy") // 通过改变 class 配合 css,达到向前翻页效果
        .removeClass(prevPage, "turned")
        .removeClass(targetPage, "turned turnlazy")
      this.pageBaseNum -= 2 // 操作两页，所以 pageBaseNum 减 2
      this.currentPageNum = this.pageBaseNum // 设置当前的页码，供播放音频使用
      this.pageActionBox.push(-1, -1) // 翻页动作记忆盒子 存入动作 '-1'
      this.pageBaseNum === 1 && (this.isShowLeftBtn = false) // 如果翻到第一页，【立即】隐藏向前翻页按钮
    },
    // 翻页动作结束
    endTurned(e) {
      // 当 e.elapsedTime === this.turnDuation时，一次翻页动作结束
      this.transitionEndTimes += this.pageActionBox.shift() // transionend后的一个判断基数，用于和 pageBaseNum 比较来，判断是否在连续翻页过程中
      // 判断是否在连续翻页中，待翻页整个过程结束后
      if (this.transitionEndTimes === this.pageBaseNum) {
        this.readCurrentPage() // 读当前页
        // 重新设置 翻页相关按钮的显示情况
        this.setTurnBtnsStatus()
        // 翻页结束状态 置为: true
        this.pageTurnEnd = true 
        // 音频暂停状态是否可改变 置为：true
        this.audioPauseCanChange = true 
        // 打点：记录 自动翻页 和 手动翻页 情况
        this.recordAutoTurn(this.autoTurn)
      }
    },
    // 重新读这本书
    replayBook() {
      // 判断当 replay到首页时，相关数据初始化，跳出递归
      if (this.pageBaseNum === 1) {
        this.currentPageNum = 1 // currentPageNum 初始化
        this.pageTurnEnd = true // 翻页结束状态 置为: true
        this.setTurnBtnsStatus() // 重新设置 翻页相关按钮的显示情况
        this.readCurrentPage() // 播放音频
        return
      }
      this.isShowReplayBtn && (this.isShowReplayBtn = false) // 【立即】隐藏 replayBtn
      this.timer && this.clearTimer() // 最后一页有timer，并且未清除时，当replay到第1页时,先清空timer
      this.pageBaseNum === this.maxNum ? this.resetAudio() : "" // 首先重置 bookAudio
      let targetPage = this.getPage(this.pageBaseNum), // 获取 target页的 DOM
        prevPage = this.getPage(this.pageBaseNum - 1) // 获取 prev页的 DOM
      utils
        .addClass(prevPage, "turnfast turnlazyfast") // 通过改变 class 配合 css,达到向前翻页效果
        .removeClass(prevPage, "turned turnlazy")
        .addClass(targetPage, "turnfast")
        .removeClass(targetPage, "turned turnlazy")
      this.pageBaseNum -= 2 // 操作两页，所以 pageBaseNum 减 2
      this.pageActionBox.push(-1, -1) // 添加动作记忆
      // 间隔 this.replayBook时间，递归调用 replayBook()方法
      setTimeout(() => {
        this.replayBook()
      }, this.replayDuration)
    },
    // 获取具体某一页的 dom元素
    getPage(num) {
      return this.pages.querySelector(".page" + num) || ""
    },
    /**
     * @desc 匹配页面是否应该有 audio资源
     * @param num [type = number] 页码
     * @return 存在audio资源，设置 bookAudio为所匹配的资源，并返回 true, 否则，返回 false
     */
    haveAudioSource(num) {
      this.pageHaveAudio = false
      if (this.bookAudioSrcs[num - 1]) {
        this.pageHaveAudio = true 
        this.bookAudio.src = this.bookAudioSrcs[num - 1]
      } else {
        this.pageHaveAudio = false
      }
      return this.pageHaveAudio
    },
    /**
     * @desc 当选择音频播放速度后，1.进行音频速度变化 2.当前显示的音频播放速度按钮变化
     * @param [type: double] speed: 新的音频速度
     * @param [type: number][0,1] btn1: this.audioSpeedBtn1 的新值判断依据
     * @param [type: number][0,1] btn2: this.audioSpeedBtn2 的新值判断依据
     * @param [type: number][0,1] btn2: this.audioSpeedBtn2 的新值判断依据
     */
    changeAudioSpeed(speed, btn1, btn2, btn3) {
      this.audioSpeedBtnsShow = false
      if (speed === this.audioCurrentSpeed) return // 速度没有发生变化，不往下执行
      btn1 != this.audioSpeedBtn1 && (this.audioSpeedBtn1 = Boolean(btn1))
      btn2 != this.audioSpeedBtn2 && (this.audioSpeedBtn2 = Boolean(btn2))
      btn3 != this.audioSpeedBtn3 && (this.audioSpeedBtn3 = Boolean(btn3))
      this.audioCurrentSpeed = speed
    },
    // audio 的播放和暂停间进行状态切换
    audioStateChange(num) {
      if (!this.audioPauseCanChange) return // 如果 this.audioPauseCanChange 为 false 时，不向下执行
      // 点击当前页的 小喇叭
      if(num === this.currentPageNum){ 
        this.audioPause=!this.audioPause // 直接切换暂停状态
      } else {
        this.currentPageNum = num // 设置当前页码为 num
        this.timer && this.clearTimer() // 如果在暂停状态切换过程中，是从前一个无音频状态下切换过来的（自动翻页时），要清除一下 timer
        this.readCurrentPage() // 读当前页
      }
    },
    // 重置 audio
    resetAudio() {
      this.bookAudio.pause()
      this.bookAudio.currentTime = 0
    },
    // clear timer(定时器)
    clearTimer() {
      clearTimeout(this.timer)
      this.timer = null
    },
    // 显示activity
    showActivity(){
      axios.get(this.activityButtonInfoUrl, {
        params: {
          deviceType: 1,
          studentId: this.studentId,
          bookId: this.bookId,
          readerCode: this.bookCode
        }
      }).then(res => {
        //显示activity
        if (res.data.code == 200 && res.data.data.currentStatus > 2) {
          this.isShowActivity = true
        }
      })
    },
    // 参加互动练习
    joinPlay(){
      // 记录点击了参加互动练习的按钮
      this.recordJoinActivity()
      // 300ms后 页面跳转
      setTimeout(() => {
        window.location.href = `/homework/activity/${this.studentId}/${this.bookCode}/${this.bookId}`
      }, 300)
    },
    // 打点：记录点击参加互动练习按钮的记录
    recordJoinActivity() {
      sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_join_activity'})
      utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC_FINISHED_BOOK_ENTRANCE, utils.clickEventConst.ACTIVITY, '', '')
    },
    // 打点：记录 read start time
    recordReadStartTime() {
      if (this.readerType == 2) {
        utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.START_READING, null, null)
      }
      axios.post(this.readStartTimeUrl, formurlencoded({studentId: this.studentId, bookId: this.bookId}))
    },
    // 打点：记录 read end time
    recordReadEndTime() {
      if (this.readerType == 2) {
        if (cookies.get('isFromApp')) {
          // IPAD端：记录 last page
          utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.IPAD, utils.clickEventConst.LAST_PAGE)
        } else {
          // pc端：记录 last page
          utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.LAST_PAGE)
        }
        // 记录：向后台提交 read end time
        axios.post(this.readEndTimeUrl, formurlencoded({studentId: this.studentId, bookId: this.bookId}))
      } else {
        // 记录：向后台提交 read end time
        axios.post(this.readEndTimeUrl, formurlencoded({studentId: this.studentId, bookId: this.bookId}))
          .then(() => {
            // 显示 activity
            this.showActivity()
          })
      }
    },
    // 打点：记录 自动翻页 和 手动翻页 情况
    recordAutoTurn(arg) {
      if (arg) {
        // 神测 打点记录
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_auto_play'})
        // 数据库记录
        utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.TURN_PAGE, utils.clickEventConst.TURN_PAGE__AUTO, '')
      } else {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_manual_play'})
        utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.TURN_PAGE, utils.clickEventConst.TURN_PAGE__MANUAL, '')
      }
    },
    // 打点：记录音频 mute 的变化
    recordMute(arg) {
      if (!arg) {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_audio_mute'})
        utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.SOUND_SWITCH, utils.clickEventConst.SOUND_SWITCH__UNMUTE, '')
      } else {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_audio_unmute'})
        utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.SOUND_SWITCH, utils.clickEventConst.SOUND_SWITCH__MUTE, '')
      }
    },
    // 打点：记录音速变化
    recordAudioSpeed(arg) {
      utils.clickEvent(this.studentId, this.bookId, utils.clickEventConst.PC, utils.clickEventConst.VOICE_SPEED, arg, '')
    },
    // 打点：记录播放进度
    recordReadProcess() {
      if (this.readerType == 2) {
        axios.post(`/rest/learninggw/api/pc/service/digitlib/read/${this.studentId}/${this.bookId}/${this.bookPageSum}/${this.currentPageNum}`, {})
      }
    },
    // 打点：记录replay 按钮 被点击记录
    recordReplay() {
      // 神测 打点记录
      sa.track('learning_click', {'click_id': 'pc_learning_digital_library_read_book_replay_this_book'})
      // readerType 数据库存储
      if(this.readerType == 2) {
        axios.post(`/rest/learninggw/api/pc/service/digitlib/read/${this.studentId}/${this.bookId}/${this.pageCount}/1`)
      }
    }
  },
  watch: {
    // 监听自动翻页状态
    autoTurn: function(val, oldVal) {
      // 打点：记录 自动翻页 和 手动翻页 情况
      this.recordAutoTurn(val)
      // 控制翻页按钮的显示
      this.setTurnBtnsStatus()
      // 如果本页已经读完，并且，pageTurnEnd状态为true，则，执行this.pageReadEnd()方法，否则，do nothing...,待本页读完
      this.currentPageReadEnd && this.pageTurnEnd && this.pageReadEnd() 
    },
    // 监听静音状态
    muted: function(val, oldVal) {
      this.bookAudio.muted = val
      // 打点：记录音频 mute 的变化
      this.recordMute(val)
    },
    // 监听当前 音速变化
    audioCurrentSpeed: function(val, oldVal) {
      this.bookAudio.playbackRate = val
      // 打点：记录 音速的变化
      this.recordAudioSpeed(val)
    },
    // 监听音频 暂停状态
    audioPause: function(val, oldVal) {
      let pauseBtn = this.getPage(this.currentPageNum).querySelector("span")
      if (pauseBtn) { // 如果 小喇叭存在的时候，再相应的调整它的 播放状态
        if (val) {
          this.bookAudio.pause()
          utils.removeClass(pauseBtn, "playing")
        } else {
          this.bookAudio.play()
          utils.addClass(pauseBtn, "playing")
        }
      }
    }
  },
  components: {
    // 活动按钮
    activityBtn,
    // header组件，包含上一步按钮
    myHeader, 
    // 进度条组件
    processBar 
  }
}
</script>

<style lang="stylus" scoped>
@keyframes blurAnimate
  0%
    transform: scale(0.3, 0.3)
  50%
    transform: scale(0.8, 0.8)
  100%
    transform: scale(1.2, 1.2)
// 小喇叭音波波动动画
@keyframes wave
  0%
    opacity: 0
  50%
    opacity: 0.5
  100%
    opacity: 1
// vue transition动画效果
.fade05-enter-active, .fade-leave-active
  transition: opacity 0.5s
.fade05-enter, .fade-leave-to
  opacity: 0
.fade10-enter-active, .fade-leave-active
  transition: opacity 1s
.fade10-enter, .fade-leave-to
  opacity: 0
.fade15-enter-active, .fade-leave-active
  transition: opacity 1.5s
.fade15-enter, .fade-leave-to
  opacity: 0
// 全局总体样式
.book-wrapper
  width: 100%
  height: 100%
  background: #624490 url('../../../img/readers/bg-readbook-1280-1920.png') no-repeat center / 1920px auto
  [v-cloak]
    display: none
  // 顶部样式
  .hang-board
    text-align: center
    font-size: 0
    .box
      display: inline-block
      margin: 0 auto
      .left, .center, .right
        display: table-cell
        vertical-align: middle
        height: 119px
        font-size: 0
      .left
        width: 124px
        background: transparent url('../../../img/library/top-hang-left-end.png') no-repeat left / auto 119px
      .center
        background: transparent url('../../../img/library/top-hang-infinite-part.png') repeat-x left / auto 119px
        padding: 0 84px
        p
          line-height: 27px
          font-size: 24px
          font-weight: 600
          text-align: center
          color: #ffffff
      .right
        width: 124px
        background: transparent url('../../../img/library/top-hang-right-end.png') no-repeat left / auto 119px
  // 图书内容部分
  .book-contain
    position: relative
    top: 50%
    -moz-transform: translateY(-50%)
    -webkit-transform: translateY(-50%)
    -ms-transform: translateY(-50%)
    transform: translateY(-50%)
    margin: 0 auto
    margin-top: -119px
    width: 1068px
    height: 498px
    line-height: 498px
    font-size: 0
    .side-left, .side-right, .book-content
      display: inline-block
      vertical-align: middle
    .side-left
      width: 100px
      height: 100px
      line-height: 100px
      text-align: right
      margin-right: -1px
      .btn-left
        display: inline-block
        vertical-align: middle
        width: 38px
        height: 76px
        border-top-left-radius: 100% 50%
        border-bottom-left-radius: 100% 50%
        box-shadow: -2px 0 3px 3px rgba(0, 0, 0, 0.1)
        cursor: pointer
        background: transparent url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px auto
        background-position: -196px -106px
        &:hover
          opacity: 0.8
        &:active
          background-position: -343px -106px
          box-shadow: -1px 0 1px 2px rgba(0, 0, 0, 0.1)
    .side-right
      width: 100px
      height: 100px
      line-height: 100px
      margin-left: -1px
      text-align: left
      .btn-right
        display: inline-block
        vertical-align: middle
        width: 38px
        height: 76px
        border-top-right-radius: 100% 50%
        border-bottom-right-radius: 100% 50%
        box-shadow: 2px 0 3px 3px rgba(0, 0, 0, 0.1)
        cursor: pointer
        background: transparent url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px auto
        background-position: -276px -106px
        &:hover
          opacity: 0.8
        &:active
          background-position: -423px -106px
          box-shadow: -1px 0 1px 2px rgba(0, 0, 0, 0.1)
      .btn-replay
        display: inline-block
        vertical-align: middle
        width: 92px
        height: 80px
        cursor: pointer
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -1px -191px
        &:hover
          background-position: -119px -191px
        &:active
          background-position: -242px -191px
    .book-content
      display: inline-block
      vertical-align: middle
      position: relative
      width: 868px
      height: 498px
      background: transparent url('../../../img/readers/books.png') no-repeat center / 868px 498px
      div
        position: absolute
        top: 11px
        width: 412px
        height: 464px
        -moz-transition-property: transform
        -moz-transition-timing-function: linear
        -webkit-transition-property: transform
        -webkit-transition-timing-function: linear
        transition-property: transform
        transition-timing-function: linear
        opacity: 0
        background-color: white
        &.open
          opacity: 1
        &:nth-child(2n+1)
          left: 25px
          -moz-transform-origin: right
          -moz-transform: rotateY(90deg)
          -webkit-transform-origin: right
          -webkit-transform: rotateY(90deg)
          -ms-transform-origin: right
          -ms-transform: rotateY(90deg)
          transform-origin: right
          transform: rotateY(90deg)
          > span
            left: 20px
          > i
            left: 16px
          .read-await
            left: 20px  
        &:nth-child(2n+1).turned
          -moz-transform: rotateY(0deg)
          -webkit-transform: rotateY(0deg)
          -ms-transform: rotateY(0deg)
          transform: rotateY(0deg)
        &:nth-child(2n)
          left: 434px
          -moz-transform-origin: left
          -moz-transform: rotateY(0deg)
          -webkit-transform-origin: left
          -webkit-transform: rotateY(0deg)
          -ms-transform-origin: left
          -ms-transform: rotateY(0deg)
          transform-origin: left
          transform: rotateY(0deg)
          > span
            left: 352px
          > i
            left: 372px
          .read-await
            left: 352px  
        &:nth-child(2n).turned
          -moz-transform: rotateY(-90deg)
          -webkit-transform: rotateY(-90deg)
          -ms-transform: rotateY(-90deg)
          transform: rotateY(-90deg)
        &:first-child
          -moz-transform: rotateY(0deg)
          -webkit-transform: rotateY(0deg)
          -ms-transform: rotateY(0deg)
          transform: rotateY(0deg)
        &.turnslow
          -moz-transition-duration: 0.5s
          -webkit-transition-duration: 0.5s
          transition-duration: 0.5s
        &.turnfast
          -moz-transition-duration: 0.15s // this.replayDuration = turnfast + turnlazyfast
          -webkit-transition-duration: 0.15s // this.replayDuration = turnfast + turnlazyfast
          transition-duration: 0.15s // this.replayDuration = turnfast + turnlazyfast
        &.turnlazy
          -moz-transition-delay: 0.5s
          -webkit-transition-delay: 0.5s
          transition-delay: 0.5s
        &.turnlazyfast
          -moz-transition-delay: 0.15s
          -webkit-transition-delay: 0.15s
          transition-delay: 0.15s
        span
          display: block
          width: 44px
          height: 44px
          border-radius: 50%
          position: absolute
          top: 20px
          background: url('../../../img/library/voice_btn_sprite.png') no-repeat
          background-size: 96px
          background-position: 0 0
          -webkit-transform: translateZ(1px)
          -moz-transform: translateZ(1px)
          -ms-transform: translateZ(1px)
          transform: translateZ(1px)
          cursor: pointer
          opacity: 0.8
          &:hover
            opacity: 0.9
            box-shadow: -1px -1px 2px 2px rgba(0, 0, 0, 0.3)
          img
            position: absolute
            width: 44px
            opacity: 0.2
          &.playing
            opacity: 1
            img
              opacity: 1
              &:first-child
                -webkit-animation: wave 1.5s linear 0s infinite both
                -moz-animation: wave 1.5s linear 0s infinite both
                animation: wave 1.5s linear 0s infinite both
              &:nth-child(2)
                -webkit-animation: wave 1.5s linear 0.5s infinite both
                -moz-animation: wave 1.5s linear 0.5s infinite both
                animation: wave 1.5s linear 0.5s infinite both
              &:nth-child(3)
                -webkit-animation: wave 1.5s linear 1s infinite both
                -moz-animation: wave 1.5s linear 1s infinite both
                animation: wave 1.5s linear 1s infinite both
        .read-await
          display: flex
          align-items: center
          justify-content: center
          display: -webkit-flex
          -webkit-justify-content:center
          -webkit-align-items:center
          position: absolute
          background: #ad99f8
          top: 20px
          width: 44px
          height: 44px
          border-radius: 44px
          &:after
            content: ''
            display: inline-block
            width: 18px
            height: 18px
            border-radius: 24px
            background: rgba(255, 255, 255, 0.8)
            -webkit-animation: blurAnimate 0.5s infinite
            -moz-animation: blurAnimate 0.5s infinite
            animation: blurAnimate 0.5s infinite
            animation-direction: alternate
        .reader-txt
            width: 389px
            height: 96px
            line-height: 1.4
            font-size: 20px
            position: absolute
            top: 350px
            left: 20px
            color: #000
            margin: 0 auto
        i.pagination
          display: block
          width: 24px
          height: 26px
          text-align: center
          line-height: 23px
          font-style: normal
          background: url('../../../img/readers/no@2x.png')
          background-size: contain
          color: #fff
          position: absolute
          bottom: 10px
          font-size: 14px


  // 图书的控制模块
  ul.operation-box
    position: relative
    top: 50%
    -moz-transform: translateY(-50%)
    -webkit-transform: translateY(-50%)
    -ms-transform: translateY(-50%)
    transform: translateY(-50%)
    width: 868px
    height: 44px
    margin: 0 auto
    margin-top: -200px
    text-align: right
    color: #ffffff
    li
      position: relative
      display: inline-block
      margin-left: 30px
      cursor: pointer
      width: 44px
      height: 44px
      border-radius: 50%
      &:nth-child(4)
        top: -54px
        margin-left: -44px
      &:nth-child(5)
        top: -108px
        margin-left: -44px
      &:nth-child(6)
        top: -162px
        margin-left: -44px
      // 1.是否自动翻页 按钮
      // 初始显示 && 点击 btn-noturn 按钮后，切换而来
      &.btn-autoturn
        background: #fff url('../../../img/readers/play.png') no-repeat left / 100% 100%
      &.btn-autoturn:hover
        background: #fff url('../../../img/readers/playhover.png') no-repeat left / 100% 100%
        &:after
          content: '手动翻页'
          display: inline-block
          position: absolute
          top: -28px
          left: -16px
          width: 76px
          height: 24px
          border-radius: 15px
          background-color: rgba(255, 255, 255, 0.5)
          line-height: 23px
          text-align: center
          font-size: 12px
          -webkit-font-smoothing: antialiase
          box-shadow: 0 -1px 1px 1px rgba(0, 0, 0, 0.3)
      &.btn-autoturn:active
        background: #fff url('../../../img/readers/playvisited.png') no-repeat left / 100% 100%
      // 状态由点击 btn-turnpage 按钮后，切换为 btn-noturn 按钮
      &.btn-handturn
        background: #fff url('../../../img/readers/display.png') no-repeat left / 100% 100%
      &.btn-handturn:hover
        background: #fff url('../../../img/readers/displayhover.png') no-repeat left / 100% 100%
        &:after
          content: '自动翻页'
          display: inline-block
          position: absolute
          top: -28px
          left: -16px
          width: 76px
          height: 24px
          border-radius: 15px
          background-color: rgba(255, 255, 255, 0.5)
          line-height: 23px
          text-align: center
          font-size: 12px
          -webkit-font-smoothing: antialiase
          box-shadow: 0 -1px 1px 1px rgba(0, 0, 0, 0.3)
      &.btn-handturn:active
        background: #fff url('../../../img/readers/displayvisited.png') no-repeat left / 100% 100%
      // 2.是否自动播放录音 按钮
      // 初始显示 && 点击 btn-novoice 按钮后，切换而来
      &.btn-voice
        background: #fff url('../../../img/readers/voice.png') no-repeat left / 100% 100%
      &.btn-voice:hover
        background: #fff url('../../../img/readers/voicehover.png') no-repeat left / 100% 100%
        &:after
          content: '声音关闭'
          display: inline-block
          position: absolute
          top: -28px
          left: -16px
          width: 76px
          height: 24px
          border-radius: 15px
          background-color: rgba(255, 255, 255, 0.5)
          line-height: 23px
          text-align: center
          font-size: 12px
          -webkit-font-smoothing: antialiase
          box-shadow: 0 -1px 1px 1px rgba(0, 0, 0, 0.3)
      &.btn-voice:active
        background: #fff url('../../../img/readers/voicevisited.png') no-repeat left / 100% 100%
      // 状态由点击 btn-voice 按钮后，切换而来
      &.btn-novoice
        background: #fff url('../../../img/readers/mute.png') no-repeat left / 100% 100%
      &.btn-novoice:hover
        background: #fff url('../../../img/readers/mutehover.png') no-repeat left / 100% 100%
        &:after
          content: '声音开启'
          display: inline-block
          position: absolute
          top: -28px
          left: -16px
          width: 76px
          height: 24px
          border-radius: 15px
          background-color: rgba(255, 255, 255, 0.5)
          line-height: 23px
          text-align: center
          font-size: 12px
          -webkit-font-smoothing: antialiase
          box-shadow: 0 -1px 1px 1px rgba(0, 0, 0, 0.3)
      &.btn-novoice:active
        background: #fff url('../../../img/readers/mutevisited.png') no-repeat left / 100% 100%
      // 3. 调整播放速度 按钮
      &.btn-speed:hover
        &:after
          content: '调整语速'
          display: inline-block
          position: absolute
          z-index: 10
          top: -28px
          left: -16px
          width: 76px
          height: 24px
          border-radius: 15px
          background-color: rgba(255, 255, 255, 0.5)
          line-height: 23px
          text-align: center
          font-size: 12px
          -webkit-font-smoothing: antialiase
          box-shadow: 0 -1px 1px 1px rgba(0, 0, 0, 0.3)
      &.btn-speed-1
        background: #fff url('../../../img/readers/0.5x.png') no-repeat left / 100% 100%
      &.btn-speed-1:hover
        background: #fff url('../../../img/readers/0.5xhover.png') no-repeat left / 100% 100%
      &.btn-speed-1:active
        background: #fff url('../../../img/readers/0.5xvisited.png') no-repeat left / 100% 100%
      &.btn-speed-2
        background: #fff url('../../../img/readers/1.0x.png') no-repeat left / 100% 100%
      &.btn-speed-2:hover
        background: #fff url('../../../img/readers/1.0xhover.png') no-repeat left / 100% 100%
      &.btn-speed-2:active
        background: #fff url('../../../img/readers/1.0xvisited.png') no-repeat left / 100% 100%
      &.btn-speed-3
        background: #fff url('../../../img/readers/1.5x.png') no-repeat left / 100% 100%
      &.btn-speed-3:hover
        background: #fff url('../../../img/readers/1.5xhover.png') no-repeat left / 100% 100%
      &.btn-speed-3:active
        background: #fff url('../../../img/readers/1.5xvisited.png') no-repeat left / 100% 100%
</style>

