<template lang="jade">
  .library_all_bg
    fullPageLoading(v-if="isFullPageLoadingShow")
    my-dialog(:tipText="'网络有点问题，检查一下网络连接吧'", :confirmButton="'刷新页面'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-close = "closeDialog()",@library-dialog-cancel="reloadPage", v-if="isBadNetworkAlertShow")
    top-part(:title_cn = "title_chinese", :title_eng = "title_english", :isAbsoluteFix = "true", :onIpadApp = "true", :gobackurl="'/digitalLibrary'", :mark="'libarary_booklist'")
    .black-mirror(v-if="isShowBlackMirror")
    myBookButton
    .page-num-container
      span.current-page {{currentPage}}
      span &nbsp/
      span.total-page {{pageTotal}}
    .page-operation-hd
      .next-page(@click="nextPage", v-show="isShowNextBtn")
      .prev-page(@click="prevPage", v-show="isShowPrevBtn")
    .book-list-wrap
      .book-item-box(v-for = "(item, index) in allBookList")
        bookItem(:bookDataProp = "item", 
                 :config = "bookConfig", 
                 :mark = "'library_list'",
                 @closeFullPageLoadingEvent = "closeFullPageLoading")
    .filter-wrap(@click = "openFilter")
      .filter-item.type-width(v-show="seriesName")
        img.filter-item-icon(src="../../../img/library/type.png")
        .filter-text-box
          .place-holder
          p.type-width {{seriesName}}
      .filter-item.lexile-width(v-show="lexileName")
        img.filter-item-icon(src="../../../img/library/lexile.png")
        .filter-text-box
          .place-holder
          p.lexile-width {{lexileName}}
      .filter-item.level-width(v-show="levelName")
        img.filter-item-icon(src="../../../img/library/level-icon.png")
        .filter-text-box
          .place-holder
          p.level-width {{levelName}}
      .filter-item.preference-width(v-show="preferenceName")
        img.filter-item-icon(src="../../../img/library/cate.png")
        .filter-text-box
          .place-holder
          p.preference-widthd(v-html="preferenceName")
      .delete-filter-btn(@click.stop="resetFilter")
    transition(enter-active-class="animated bounceInDown",leave-active-class="animated bounceOutUp")
      filter-component(v-show="isFilterShow", ref="filterComponent"
                        @closeFilterEvent = "closeFilter",
                        @getBookListByFilterEvent = "getBookListByFilter",
                        :currentLevelProp = "currentLevel",
                        :currentTypeProp = 'filterData.type',
                        :isGary = "isInGray",
                        @setFilterSelectedEvent = "setFilterSelected")
</template>
<script>
import axios from 'axios'
import cookies from 'cookies-js'
import TopPart from '../../common/top_part.vue'
import myDialog from "./../common/dialog.vue"
import Velocity from 'velocity-animate'
import bookItem from '../component/book_list_item.vue'
import filterComponent from "../component/filter_all.vue"
import myBookButton from '../component/top_right_button.vue'
import fullPageLoading from "../../common/vk_turn_page_loading.vue"
import {loadURL, getQueryString} from '../libarary_utils.js'

export default {
  data: function() {
    return {
      title_chinese: '',
      title_english: '',
      libraryType: this.$route.params.type,
      isFullPageLoadingShow: true,
      isGuideShow: false,
      isShowBlackMirror: false,
      isShowBookList: false,
      isShowInitAnimationThings: false,
      bookConfig: {
        style: 2,
        bookListLengthOfCurrPage: 0
      },
      isFilterShow: false,
      allBookList: [],
      currentLevel: null,
      seriesName: '',
      lexileName: '',
      levelName: '',
      preferenceName: '',
      filterData: {
        lexileSections: '', //蓝思值
        tagIDs: '', //偏好
        tagNames: '', //level
        type: '' //系列
      },
      onePageLimit: 0,
      indexOfBookList: 0,
      isShowNextBtn: true,
      isShowPrevBtn: false,
      totalNumOfBookList: 0,
      currentPage: 0,
      pageTotal: 0,
      isBadNetworkAlertShow: false,
      isRefreshBookList: false,
      isInGray:false
    }
  },
  components: {
    TopPart,
    myDialog,
    bookItem,
    filterComponent: filterComponent,
    myBookButton,
    fullPageLoading
  },
  // watch: {
  //   '$route': 'refreshData'
  // },
  mounted() {
    if (cookies.get('isFromApp')) {
      loadURL('vkappbridge://loading/stop') //停止ipad的loading界面
    }
    if(this.$route.params.type == 'all') {
      this.getCurrentLevel()
    } else {
      this.getDataByType()
    }
  },
  methods: {
    closeDialog(){
      this.isBadNetworkAlertShow = false
    },
    refreshData() {
      this.isRefreshBookList = true
      this.indexOfBookList = 0
      this.getDataByType()
    },
    getDataByType() {
      this.filterData.type = this.$route.params.type
      this.currentLevel = '' //即'all levels'
      this.windowAdaptation()
      window.onresize = () => {
        this.windowAdaptation()
      }
    },
    resetFilter() {
      this.$refs.filterComponent.resetFilter()
      this.$refs.filterComponent.confirmFilter()
      this.$router.replace({path:'/digitalLibrary/bookList/all'})
    },
    closeFullPageLoading() {
      this.isFullPageLoadingShow = false
    },
    reloadPage() {
      window.location.reload(true)
    },
    nextPage() {
      this.isShowPrevBtn = true
      if (this.indexOfBookList + this.onePageLimit <= this.totalNumOfBookList) {
        this.indexOfBookList += this.onePageLimit
        this.getAllBookList()
      }
      if (this.indexOfBookList + this.onePageLimit >= this.totalNumOfBookList) {
        this.isShowNextBtn = false
      }
    },
    prevPage() {
      this.isShowNextBtn = true
      if (this.indexOfBookList - this.onePageLimit >= 0) {
        this.indexOfBookList -= this.onePageLimit
        this.getAllBookList()
      }
      if (this.indexOfBookList - this.onePageLimit < 0) {
        this.isShowPrevBtn = false
      }
    },
    setFilterSelected( data ) {
      this.seriesName = data.types['nameEN']
      this.lexileName = data.lexiles['nameEN']
      this.levelName = this.processLevelText(data.levels['nameEN'])
      if(data.tags['nameCH'] && data.tags['nameEN']) {
        this.preferenceName = data.tags['nameCH'] + '<br>' + data.tags['nameEN']
      } else {
        this.preferenceName = null
      }
    },
    processLevelText( text ) {
      if(!text) {
        return ''
      }
      let result = text.match(/\d/)
      if(result) {
        return 'Level ' + result.toString()
      } else {
        return text
      }
    },
    getCurrentLevel() {
      axios.get('/rest/learninggw/api/pc/service/digitlib/getCurrentLevel',{
        params: {
          studentId: cookies.get('studentId')
        }
      }).then((res) => {
        this.currentLevel = res.data.data.serialNumber //当前level
        this.filterData.tagNames = this.currentLevel
        this.windowAdaptation()
        window.onresize = () => {
          this.windowAdaptation()
        }
      })
        .catch((err) => {
          this.isFullPageLoadingShow = false
          this.isBadNetworkAlertShow = true
        })
    },
    getBookListByFilter( config ) {
      this.filterData.lexileSections = config.lexileSections
      this.filterData.tagIDs = config.tags
      this.filterData.tagNames = config.tagNames
      this.filterData.type = config.types
      this.filterData.allowRepeats = config.allowRepeats
      this.indexOfBookList = 0
      this.$nextTick(() => {
        this.getAllBookList()
      })
    },
    getAllBookList() {
      this.isFullPageLoadingShow = true
      this.allBookList = []
      axios.get('/rest/learninggw/api/pc/service/digitlib/getBookList', {
        params: {
          studentId: cookies.get('studentId'),
          start: this.indexOfBookList,
          limit: this.onePageLimit,
          lexileSections: this.filterData.lexileSections,
          tagIDs: this.filterData.tagIDs,
          tagNames: this.filterData.tagNames,
          type: this.filterData.type,
          allowRepeats:this.filterData.allowRepeats
        }
      }).then((res) => {
        if (!res.data.data) {
          if (cookies.get('isFromApp')) {
            alert('您没有权限')
          } else {
            this.$router.push({path: '/'})
          }
          return
        }
        this.totalNumOfBookList = res.data.data.total
        this.currentPage = res.data.data.currentPage
        this.pageTotal = res.data.data.totalPage
        this.bookConfig.bookListLengthOfCurrPage = res.data.data.books.length
        for(let i = 0; i < res.data.data.books.length; i++) {
          this.allBookList.push(res.data.data.books[i])
        }
        setTimeout(() => {
          if (!res.data.data.books.length) {
            this.isFullPageLoadingShow = false
          }
        }, 500)
        if (this.pageTotal <= 1) {
          this.isShowNextBtn = false
          this.isShowPrevBtn = false
        } else {
          if (this.currentPage != this.pageTotal) {
            this.isShowNextBtn = true
          }
          if (this.currentPage == 1) {
            this.isShowPrevBtn = false
          }
        }
      })
        .catch((err) => {
          this.isFullPageLoadingShow = false
          this.isBadNetworkAlertShow = true
        })
    },
    openFilter() {
      this.isFilterShow = true
      this.isShowBlackMirror = true
    },
    closeFilter() {
      this.isFilterShow = false
      this.isShowBlackMirror = false
    },
    windowAdaptation() {
      let screenWidth = window.innerWidth
      if(screenWidth >= 1920) {
        this.getBookListByLimit(12)
      } else if(screenWidth < 1920 && screenWidth > 1480) {
        this.getBookListByLimit(10)
      } else {
        this.getBookListByLimit(8)
      }
    },

    getBookListByLimit( limit ) {
      if( this.onePageLimit != limit || this.isRefreshBookList) {
        this.isRefreshBookList = false
        this.onePageLimit = limit
        this.allBookList = []
        this.getAllBookList()
      }
    }
  }
}
</script>
<style lang="stylus" scoped>
*
  box-sizing: border-box
  -moz-user-select: none
  -webkit-user-select: none
  -ms-user-select: none
  -khtml-user-select: none
  user-select: none
  -webkit-font-smoothing: antialiased
  font-weight: 300
  -webkit-touch-callout: none
  .library_all_bg
    background-repeat: no-repeat
    background-position: center
    background-size: 1920px
    background-color: #624490
    width: 100%
    height: 100%
    @media screen and (max-width: 1280px)
      background-image: url('../../../img/library/bg-book-1280-1480.png')
      background-size: 1480px
    @media screen and (min-width: 1280px) and (max-width: 1480px)
      background-image: url('../../../img/library/bg-book-1280-1480.png')
      background-size: 1480px
    @media screen and (min-width: 1480px) and (max-width: 1920px)
      background-image: url('../../../img/library/bg-book-1480-1920.png')
      background-size: 1920px
    @media screen and (min-width: 1920px)
      background-image: url('../../../img/library/bg-1920.png')
      background-size: 2600px
    .page-num-container
      position: absolute
      top: 50%
      left: 50%
      margin: 300px 0 0 0
      color: white
      font-size: 18px
    .page-operation-hd
      .next-page
        position: absolute
        top: 50%
        left: 50%
        margin: 0px 0 0 379px
        width: 78px
        height: 78px
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: 0 0
        cursor: pointer
        &:hover
          background-position: -188px 0
        &:active
          background-position: -389px 0
        @media screen and (max-width: 1280px)
          margin: 0px 0 0 376px
        @media screen and (min-width: 1280px) and (max-width: 1480px)
          margin: 0px 0 0 376px
        @media screen and (min-width: 1480px) and (max-width: 1920px)
          margin: 0px 0 0 439px
        @media screen and (min-width: 1920px)
          margin: 0px 0 0 549px
      .prev-page
        position: absolute
        top: 50%
        left: 50%
        margin: 0px 0 0 -448px
        width: 78px
        height: 78px
        background: url('../../../img/library/lib_spire.png') no-repeat
        background-size: 595px
        background-position: -89px 0
        &:hover
          background-position: -288px 0
        &:active
          background-position: -483px 0
        @media screen and (max-width: 1280px)
          margin: 0px 0 0 -449px
        @media screen and (min-width: 1280px) and (max-width: 1480px)
          margin: 0px 0 0 -449px
        @media screen and (min-width: 1480px) and (max-width: 1920px)
          margin: 0px 0 0 -518px
        @media screen and (min-width: 1920px)
          margin: 0px 0 0 -627px
    .book-list-wrap
      width: 658px
      position: absolute
      top: 50%
      left: 50%
      @media screen and (max-width: 1280px)
        width: 707px
        margin: -195px 0 0 -326px
      @media screen and (min-width: 1280px) and (max-width: 1480px)
        width: 707px
        margin: -195px 0 0 -326px
      @media screen and (min-width: 1480px) and (max-width: 1920px)
        width: 878px
        margin: -217px 0 0 -413px
      @media screen and (min-width: 1920px)
        width: 1048px
        margin: -216px 0 0 -500px
      .book-item-box
        display: inline-block
        margin-right: 43px
        margin-bottom: 33px
      .book-item-box:nth-child(4n)
        // margin-right: 0
    .filter-wrap
      position: absolute
      top: 50%
      left: 50%
      width: 680px
      height: 60px
      border-radius: 100px
      background-color: #5f3fa6
      padding: 10px 41px 0 0px
      text-align: center
      @media screen and (max-width: 1280px)
        margin: -337px 0 0 -328px
      @media screen and (min-width: 1280px) and (max-width: 1480px)
        margin: -337px 0 0 -328px
      @media screen and (min-width: 1480px) and (max-width: 1920px)
        margin: -379px 0 0 -331px
      @media screen and (min-width: 1920px)
        margin: -391px 0 0 -339px
      .delete-filter-btn
        position: absolute
        top: -7px
        right: -10px
        width: 74px
        height: 74px
        background: url('../../../img/library/delete_filter_btn.png') no-repeat
        background-size: 100%
        cursor: pointer
        transition: all 150ms ease-out
        &:hover
          transform: rotate(360deg)
      .filter-item
        display: inline-block
        vertical-align: middle
        height: 42px
        text-align: left
        cursor: pointer
        &.type-width
          max-width: 176px
        &.lexile-width
          width: 120px
        &.level-width
          width: 120px
        &.preference-width
          width: 175px
        img.filter-item-icon
          width: 30px
          height: 30px
          display: inline-block
          vertical-align: middle
          margin-right: 5px
        .filter-text-box
          display: inline-block
          vertical-align: middle
          height: 100%
          .place-holder
            height: 100%
            display: inline-block
            vertical-align: middle
          p
            display: inline-block
            vertical-align: middle
            color: #fff
            &.type-width
              width: 135px
            &.lexile-width
              width: 75px
            &.level-width
              width: 75px
            &.preference-width
              width: 140px
</style>


