<template lang="jade">
.bookshelf-wrapper(v-cloak)
  fullPageLoading(v-if="isFullPageLoadingShow")
  top-part(:title_cn = "title_chinese", :title_eng = "title_english", :isAbsoluteFix = "true")
  bookdetail(:isBookDetailShowProp = "isBookDetailShow", @bookDetailSwitch = "bookDetailSwitcher", :bookDetailDataProp = "bookDetailDataProp_", @returnBookBUS = 'confirmReturnBook')
  my-dialog(:tipText="'确定要还回去这本书吗？'", :type = "'confirm'", title="Notice", isShowTitle = true, @library-dialog-cancel="cancelDialog", @library-dialog-confirm='returnBook', v-if="isShowDialog")
  my-dialog(:tipText="bookExpireText", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-cancel="cancelBookExpireDialog", v-if="isShowBookExpirePop")
  my-dialog(:tipText="'网络有点问题，检查一下网络连接吧'", :confirmButton="'刷新页面'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-cancel="reloadPage", v-if="isBadNetworkAlertShow")
  .return-book-button(@click="iWannaReturnBook") {{returnBookText}}
  .bookshelf-container
    .my-book-list-container
      template(v-for="(item, index) in myBookList")
        template(v-if="!item.isdashed")
          .my-book-list-item(@click="openBookDetail(item.id)", @mouseenter="bookNameMouseEnter($event)", @mouseleave="bookNameMouseLeave($event)")
            .book-container(:class="{bookshake: isBookShake}")
              transition(enter-active-class="animated bounceIn", leave-active-class="animated bounceOut")
                .return-book-button-oncover(@click.stop="confirmReturnBook(item.id, item.code)" v-if="isReturnBookButtonOnCoverShow")
              .book
                img.book-cover(:src = "item.coverResUrl + '?imageView2/2/w/328/h/370'", @load="loadingImage", @error="loadingImageError")
                .book-marker.book-marker-math(v-if="item.tag[1].id == DLType_Math_Id")
                .book-marker.book-marker-science(v-else-if="item.tag[1].id == DLType_Science_Id")
                .book-marker.book-marker-social(v-else-if="item.tag[1].id == DLType_Social_Id")
                .book-marker.book-marker-social(v-else-if="item.tag[1].id == DLType_Social_Id")
                img.book-marker-word(v-else, :src="item.tag[0].imgUrl ? item.tag[0].imgUrl.split(';')[0] : ''")
            .book-name-wrap(:class="{textellipsis: isOnIpad}")
              .book-name {{item.name}}
            .progress-container
              .progress-bg
                .progress(v-if="item.pageCount != 0", :style="{width: (parseInt(item.currentPage)/parseInt(item.pageCount)) * 100 + '%'}")
                .progress(v-else, style="width: 0%")
              .progress-percent(v-if="item.pageCount != 0") {{ parseInt( parseInt(item.currentPage) / parseInt(item.pageCount) * 100 ) }}%
              .progress-percent(v-else) 0%
            .count-down-container(:class="{red: isLessThan20Mins}") {{ countDown(item.scheduleReturnTime, item.serverTime) }}
        template(v-else)
          li.dashed-book
  .success-toast(v-if="isMaskShow")
    .black-mask(v-if="isMaskShow")
    transition(enter-active-class="animated bounceIn", leave-active-class="animated bounceOut")
      img.reader-toast(src="../../../img/digireader/return-success@2x.png", v-show="isToastShow")
  .success-toast(v-if="isNoBorrowMaskShow")
    .black-mask(v-if="isNoBorrowMaskShow")
    transition(enter-active-class="animated bounceIn", leave-active-class="animated bounceOut")
      img.reader-toast(src="../../../img/digireader/no-borrow@2x.png", v-show="isNoBorrowToastShow")
</template>
<style lang="stylus" scoped>
  *
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    -webkit-touch-callout: none
  $screenWidthSmaller_1080 = "screen and (max-width: 1080px)"
  SPIRIT_PIC_WIDTH = 1430px / 2
  COMMON_BACKGROUND_IMG()
    background-image: url('../../../img/digireader/reader_spirit.png')
    background-size: SPIRIT_PIC_WIDTH
    background-repeat: no-repeat
  .bookshelf-wrapper
    .return-book-button
      COMMON_BACKGROUND_IMG()
      position: fixed
      z-index: 11
      top: 23px
      right: 38px
      width: 159px
      height: 53px
      background-position: -1px -480px
      line-height: 53px
      text-align: center
      cursor: pointer
      color: #fff
      font-size: 20px
      &:hover
        background-position: -162px -480px
      &:active
        background-position: -323px -483px
    .bookshelf-container
      background-image:url('../../../img/digireader/bookcase.png')
      background-repeat: no-repeat
      width: 822px
      height: 436px
      margin: -218px 0 0 -411px 
      position: absolute
      top: 50%
      left: 50%
      &:before
        content: ''
        position: absolute
        height: 999px
        width: 2px
        background-color: #8760fd
        bottom: 428px
        left: 90px
        z-index: -1
      &:after
        content: ''
        position: absolute
        height: 999px
        width: 2px
        background-color: #8760fd
        bottom: 428px
        right: 90px
        z-index: -1
      @media $screenWidthSmaller_1080
        transform: scale(0.9)
        -ms-transform: scale(0.9) 	
        -moz-transform: scale(0.9)
        -webkit-transform: scale(0.9)
        -o-transform: scale(0.9)
        transform-origin: 50% 0
        -ms-transform-origin: 50% 0
        -moz-transform-origin: 50% 0
        -webkit-transform-origin: 50% 0
        -o-transform-origin: 50% 0
    .my-book-list-container
      position: absolute
      width: 663px
      display: inline-block
      top: 69px
      left: 11px
      right: 0
      margin: 0 auto
      white-space: nowrap
      .dashed-book
        min-height: 209px
        border: 2px dashed #8561ed
        border-radius: 20px
        width: 174px
        display: inline-block
        margin: 0 23px 0 21px
        position: relative
        list-style: none
      .my-book-list-item
        width: 174px
        float: left
        margin: 0 23px 0 18px
        cursor: pointer
        position: relative
        &.text-move
          .book-name
            animation: bookNameMove 5s linear infinite
            -webkit-animation: bookNameMove 5s linear infinite
          .book-name-wrap
            text-overflow: initial
        .return-book-button-oncover
          position: absolute
          top: -13px
          right: -20px
          z-index: 2
          display:inline-block
          width: 40px
          height: 40px
          cursor: pointer
          background-position: -292px -36px
          COMMON_BACKGROUND_IMG()
          &:hover
            background-position: -337px -35px
          &:active
            background-position: -383px -36px
        .book-container
          position: relative
          &.bookshake
            animation: shake-opacity 0.7s infinite
          .book
            COMMON_BACKGROUND_IMG()
            width: 100%
            height: 211px
            background-position: -467px 0px
            .book-cover
              width: 164px
              height: 185px
              position: absolute
              right: 0px
              top: 0px
            .book-marker-word
              position: absolute
              bottom: -7px
              left: 15px
              width: 28px
              height: 24px
            .book-marker
              COMMON_BACKGROUND_IMG()
              position: absolute
              bottom: -7px
              left: 15px
              &.book-marker-no-content
                width: 28px
                height: 15px
                background-position: -43px -5px
                bottom: 4px
              &.book-marker-math
                width: 28px
                height: 26px
                background-position: -332px 0
              &.book-marker-science
                width: 28px
                height: 26px
                background-position: -296px 0
              &.book-marker-social
                width: 28px
                height: 26px
                background-position: -368px 0
        .book-name-wrap
          width: 100%
          overflow: hidden
          white-space: nowrap
          margin-top: 20px
          text-overflow: ellipsis
          &.textellipsis
            text-overflow: ellipsis
          .book-name
            display: inline-block
            color: white
            font-size: 20px
          .text-move .book-name
            animation: bookNameMove 5s linear infinite
            -webkit-animation: bookNameMove 5s linear infinite
        .progress-container
          width: 100%
          margin-top: 3px
          .progress-bg
            position: relative
            width: 110px
            height: 4px
            background-color: #6827c7
            border-radius: 99px
            display: inline-block
            vertical-align: middle
            .progress
              position: absolute
              height: 4px
              top: 0
              left: 0
              background-color: #b396ff
              border-radius: 99px
          .progress-percent
            color: #bdc5ff
            font-size: 14px
            display: inline-block
            vertical-align: middle
            margin-left: 12px
        .count-down-container
          background-color: #532fb3
          border-radius: 99px
          padding: 5px 18px
          color: #bdc5ff
          display: inline-block
          font-size: 13px
          margin-top: 8px
          &.red
            color: #ffb600
  .success-toast
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    z-index: 222
    .black-mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background-color: rgba(0, 0, 0, 0.6)
    .reader-toast
      position: absolute
      top: 50%
      left: 50%
      width: 372px
      margin-top: -76px
      margin-left: -185px
      z-index: 222
            
  @css{
    @keyframes shake-opacity {
      10% {
        transform: rotate(-1deg);
      }
      20% {
        transform:  rotate(1deg);
      }
      30% {
        transform:  rotate(1deg);
      }
      40% {
        transform: rotate(-1deg);
      }
      50% {
        transform:  rotate(1deg);
      }
      60% {
        transform:  rotate(-1deg);
      }
      70% {
        transform:  rotate(-1deg);
      }
      80% {
        transform:  rotate(1deg);
      }
      90% {
        transform:  rotate(-1deg);
      }
      100% {
        transform: rotate(0); 
      } 
    }
    @-webkit-keyframes bookNameMove {
        from {
          transform: translate3d(0, 0, 0)
        }
        to {
          transform: translate3d(-100%, 0, 0)
        }
    }
    @keyframes bookNameMove {
        from {
          transform: translate3d(0, 0, 0)
        }
        to {
          transform: translate3d(-100%, 0, 0)
        }
    }
  }              
</style>

<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import utils from '../../../utils/_untils.js'
  import { $get, $post, $all } from '../api.js'

  import TopPart from '../../common/top_part.vue'
  import myHeader from "../header.vue"
  import myDialog from "../common/dialog.vue"
  import bookdetail from "../component/bookshelf_detail.vue"
  import fullPageLoading from "../../common/vk_turn_page_loading.vue"

  const studentId = cookies.get('studentId')
  export default {
    data() {
      return {
        isBadNetworkAlertShow: false,
        isFullPageLoadingShow: cookies.get('isFromApp') ? false : true,
        DLType_Math_Id: 11,
        DLType_Science_Id: 12,
        DLType_Social_Id: 13,
        title_chinese: '我的书架',
        title_english: 'My Bookshelf',
        progress: 30,
        countDownText: '距还书3小时',
        myBookList: [],
        isBookDetailShow: false,
        bookDetailDataProp_: {},
        currBookId: null,
        currBookCode: null,
        isShowDialog: false,
        isMaskShow: false,
        isToastShow: false,
        isNoBorrowMaskShow: false,
        isNoBorrowToastShow: false,
        isReturnBookButtonOnCoverShow: false,
        returnBookText: '我要还书',
        isBookShake: false,
        isLessThan20Mins: false,
        isOnIpad: false,
        bookExpireText: '没有内容',
        bookExpireList: [],
        isShowBookExpirePop: false,
        studentBorrowBookIds: [],
        bookListLength: null,
        pending: false
      }
    },
    props: [],
    mounted(){
      this.getMyBookList()
      this.checkBookExpire()
      this.isOnIpad = utils.isOnIpad()
    },
    methods:{
      reloadPage() {
        window.location.reload(true)
      },
      loadingImageError() {
        this.loadingControlByImgState()
      },
      loadingImage() {
        this.loadingControlByImgState()
      },
      loadingControlByImgState() {
        if( this.bookListLength == 1) {
          if(cookies.get('isFromApp')) {
            setTimeout(() => {
              this.isFullPageLoadingShow = false
              this.loadURL('vkappbridge://loading/stop')
            }, 300)
          } else {
            setTimeout(() => {
              this.isFullPageLoadingShow = false
            }, 300)
          }
        }
        this.bookListLength--
      },
      bookNameMouseEnter(event) {
        if(!utils.isOnIpad()) event.target.className += ' text-move'
      },
      bookNameMouseLeave(event) {
        if(!utils.isOnIpad()) utils.removeClass(event.target, 'text-move')
      },
      checkBookExpire() {
        var url = '	/api/pc/service/digitlib/getNotNoticeReturnedBooks'
        $get(url, {
          studentId: studentId
        })
          .then((res) => {
            let bookName = ''
            if( res.data.data ) {
              this.bookExpireList = res.data.data.books
              this.bookExpireList.vkForEach((item, index) => {
                this.studentBorrowBookIds.push(item.studentBorrowBookId)
                bookName += '《' + item.name + '》'
                if( index != this.bookExpireList.length - 1 ) {
                  bookName += '、'
                }
              })
              this.bookExpireText = bookName + '已到期，自动归还成功。'
              if(this.studentBorrowBookIds.length)
                this.isShowBookExpirePop = true
            } else {
            //没有到期的书
            }
          })
          .catch((err) => {})
      },
      confirmBookExpire() {
        if(this.studentBorrowBookIds.length == 0) {
          return
        }
        $post('/api/pc/service/digitlib/updateNotifiedBooks', {
          studentBorrowBookIds: this.studentBorrowBookIds.toString()
        })
      },
      cancelBookExpireDialog() {
        this.confirmBookExpire()
        this.isShowBookExpirePop = false
      },
      countDown(scheduleReturnTime, serverTime) {
        if(scheduleReturnTime < serverTime) {
          return '该还书啦！'
        } else {
          var secLeft = parseInt( (scheduleReturnTime - serverTime) / 1000 )
          var days,hours,mins
          days = parseInt( secLeft / 86400 )
          hours = parseInt( secLeft / 3600 )
          mins = parseInt( secLeft / 60 )
          if(mins <= 20) {
            this.isLessThan20Mins = true
          }
          return '距还书' + (days ? days + '天' : hours ? hours + '小时' : mins ? mins + '分' : secLeft + '秒')
        }
      },
      iWannaReturnBook() {
        this.isReturnBookButtonOnCoverShow = !this.isReturnBookButtonOnCoverShow
        this.returnBookText = this.isReturnBookButtonOnCoverShow ? '取消还书' : '我要还书'
        this.isBookShake = !this.isBookShake
      },
      showSuccessToast() {
        this.isMaskShow = true
        this.$nextTick(() => {
          this.isToastShow = true
        })
        setTimeout(()=> {
          window.location.reload()
        }, 2000)
      },
      showNoBorrowToast() {
        this.isNoBorrowMaskShow = true
        this.$nextTick(() => {
          this.isNoBorrowToastShow = true
        })
        setTimeout(()=> {
          this.$router.back() //bug
        }, 2000)
      },
      confirmReturnBook(bookId, bookCode) {
        this.currBookId = bookId
        this.currBookCode = bookCode
        this.isShowDialog = true
      },
      returnBook() {
        var url = '/api/pc/service/digitlib/returnBook/' + studentId + '/' + this.currBookId + '/' + this.currBookCode
        if(!this.pending) {
          this.pending = true
          $post(url, {})
            .then((res) => {
              this.pending = false
              if(res.data.code == 200){
                this.showSuccessToast()
              } else {
                alert(res.data.msg)
                window.location.reload(true)
              }
            })
            .catch((err) => {
              this.pending = false
              this.isFullPageLoadingShow = false
              this.isBadNetworkAlertShow = true
            })
        }
      },
      openBookDetail(bookId) {
        var url = '/api/pc/service/digitlib/' + studentId + '/' + bookId + '/detail'
        $get(url, {})
          .then((res) => {
            this.isBookDetailShow = true
            this.bookDetailDataProp_ = res.data.data
          })
          .catch((err) => {
            this.isBadNetworkAlertShow = true
          })
        
      },
      bookDetailSwitcher() {
        this.isBookDetailShow = false
      },
      cancelDialog(){
        this.isShowDialog = !this.isShowDialog
      },
      loadURL(url) {
        var iFrame
        iFrame = document.createElement("iframe")
        iFrame.setAttribute("src", url)
        iFrame.setAttribute("style", "display:none;")
        document.body.appendChild(iFrame)
        //把它从dom上移除掉
        iFrame.parentNode.removeChild(iFrame)
        iFrame = null
      },
      getMyBookList() {
        var url = '/api/pc/service/digitlib/'+ studentId +'/myBookShelf'
        $get(url,{})
          .then((res) => {
            this.isFullPageLoadingShow = true
            this.bookListLength = res.data.data.books ? res.data.data.books.length : 1
            for(let i = 0; i < 3; i++) {
              if(res.data.data.books && res.data.data.books[i]) {
                res.data.data.books[i].isdashed = false
                this.myBookList.push(res.data.data.books[i])
              } else {
                this.myBookList.push({isdashed: true})
              }
            }
            if(!res.data.data.books) {
              this.isFullPageLoadingShow = false
              this.showNoBorrowToast()
            }
          })
          .catch((err)=>{
            this.isFullPageLoadingShow = false
            this.isBadNetworkAlertShow = true
          })
      }
      
    },
    components: {
      TopPart,
      bookdetail,
      myDialog,
      fullPageLoading
    }
  }
</script>
