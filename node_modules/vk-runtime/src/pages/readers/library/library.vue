<template lang="jade">
  .library-wrapper
    my-dialog(tipText="完成下个学习周期之后就可以获得新的绘本哦~", type = "alert", confirmButton = "知道了", title="Notice", isShowTitle = true, v-on:library-dialog-cancel="cancelDialog", v-if="isShowDialog")
    my-header(:goBackUrl="'/major_extension_mc'")
      p(slot="title") {{title_cn}}
      p(slot="title") {{title_ng}}
    .top
    .library-list
      .leftbtn(@click="prePage", v-if="isShowLeftBtn")
        img(src="../../../img/readers/leftbtn.png")
      .rightbtn(@click="nextPage", v-if="isShowRightBtn")
        img(src="../../../img/readers/rightbtn.png")
      ul.library-list-body
        template(v-for="(item,index) in bookList")
          template(v-if="!item.isdashed")
            li.library-list-item(@click="openBookDetail(index)", v-if="item.isUnlock === 1")
              .book-img-contain
                img.book(src = "../../../img/readers/book.png")
                img.book.book-cover(:src = "item.coverResUrl")
              p.book-name {{item.name}}
              p.book-page-view
                img(src="../../../img/readers/reader.png")
                span {{item.clickRate}}
              img.read-status-icon(v-if="item.status === 0", src="../../../img/readers/readstatus.png")
            li.library-list-item(v-else)
              .book-img-contain
                div(:class="{'dom-opacity': item.isUnlock === 0}")
                  img.book(src = "../../../img/readers/book.png")
                  img.book.book-cover(:src = "item.coverResUrl")
                  .book-mask
                .lock-book(@click="dialogClick")
                  img.lock-img(src="../../../img/readers/lock.png")
              p.book-name {{item.name}}
              p.book-page-view
                img(src="../../../img/readers/reader.png")
                span {{item.clickRate}}
          template(v-else)
            li.dashed-book.library-list-item

</template>

<style lang="stylus" scoped>
  ul, li
    list-style: none
    list-style-image: none

  a
    text-decoration: none
    color: #333

  .library-wrapper
    height: 100%
    color: #fff
    .top
      height: 50%
      margin-bottom: -400px
    .book_detail_dialog_wrapper
      .level-title,
      .unit-title
        line-height: 1.4
        padding-top: 13px
        font-size: 24px
      .unit-title
        padding: 0
        font-size: 34px
    .library_dialog_wrapper
      .alert-text
        position: absolute
        top: 50%
        margin-top: -40px
        text-align: center
    .readers-title
      & > p
        padding: 0
        margin: 0 0 10px
        font-size: 36px
    [v-cloak]
      display: none
  //弹层样式
    .book_detail_dialog_wrapper
      .description
        width: 460px
        float: left
      .description-title
        font-size: 28px
        text-align: center
      .description-text
        font-size: 20px
      .book-img-contain
        width: 210px
        position: absolute
        right: 56px
        top: 21px
        .book
          width: 100%
          height: 254px
        .book-cover
          width: 199px
          height: 223px
          position: absolute
          top: 0px
          left: 14px

    .dom-opacity
      opacity: 0.5
      .book-mask
        width: 164px
        height: 185px
        position: absolute
        top: 0px
        left: 10px
        background-color: rgba(0, 0, 0, 0.5)
    .library-list
      width: 1000px
      position: relative
      top: 127px
      margin: 0 auto
      .leftbtn
        width: 38px
        position: absolute
        top: 215px
        left: 0
        cursor: pointer
        & > img
          width: 38px
          height: 70px
      .rightbtn
        width: 38px
        position: absolute
        top: 215px
        right: 0
        cursor: pointer
        & > img
          width: 38px
          height: 70px
      .library-list-body
        width: 100%
        padding: 0
        margin: 0
        margin-left: 42px
      .library-list-item
        width: 174px
        display: inline-block
        margin: 0 23px 18px
        float: left
        cursor: pointer
        position: relative
        .read-status-icon
          width: 51px
          height: 51px
          position: absolute
          top: -4px
          right: -4px
        .book-img-contain
          position: relative
          .lock-book
            width: 164px
            height: 186px
            position: absolute
            top: 0px
            left: 10px
            & > img
              width: 46px
              height: 55px
              position: absolute
              top: 50%
              left: 50%
              margin: -23px 0 0 -27px
        .read-status-end,
        .read-status-new
          width: 72px
          height: 28px
          line-height: 28px
          position: absolute
          right: 2px
          top: 1px
          font-style: normal
          font-size: 14px
          background: #7dbf4b
          text-align: center
          border-bottom-left-radius: 10px
        .read-status-end
          background: #ccc
        .book
          width: 100%
          height: 211px
        .book-cover
          width: 164px
          height: 185px
          position: absolute
          right: 0px
          top: 0px
        .book-name
          font-size: 16px
          margin: 7px 0
          height: 21px
          overflow: hidden
          text-overflow: ellipsis
          width: 100%
          white-space: nowrap
        .book-page-view
          font-size: 14px
          margin: 7px 0
          & > img
            width: 22px
            height: 12px
            margin-right: 6px
      .dashed-book
        min-height: 209px
        border: 2px dashed #8561ed
        border-radius: 20px
        margin-bottom: 90px
</style>

<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import {$get, $post, $all} from '../api.js'
  import utils from '../../../utils/_untils.js'
  import myHeader from "../header.vue"
  import myDialog from "../common/dialog.vue"
  import Vue from 'vue'
  import bookDetail from '../../common/book_detail.vue'
  import model from "../../common/plugins/Model"
  Vue.use(model)
  export default {
    props: [],
    data() {
      return {
        title_cn: '',
        title_ng: '',
        tagId: this.$route.params.id,
        bookListUrl: '/api/pc/service/reader/getBookList',
        clickBookUrl: '/api/pc/service/reader/clickBook',
        readStartTimeUrl: '/api/pc/service/reader/setBeginTime',
        page: -1,
        pageTotal: 0,
        isShowBookDetail: false,
        isShowDialog: false,
        isShowLeftBtn: false,
        isShowRightBtn: true,
        bookList: [],
        currentBookDetail: '',
        bookDetailConfig: null,
        isDetailShow: false
      }
    },
    mounted(){
      if (this.tagId == 8) {
        this.title_cn = '自然拼读故事'
        this.title_ng = 'Phonics Stories'
      } else if (this.tagId == 9) {
        this.title_cn = '主题故事'
        this.title_ng = 'Themed Readers'
      } else if (this.tagId == 14) {
        this.title_cn = '漫画故事'
        this.title_ng = 'Comic Stories'
      }
      this.getBookList()
    },
    methods: {
      closeDetailWindow() {
        this.isDetailShow = false
      },
      getBookList(){
        $get(this.bookListUrl, {
          t: new Date().getTime(),
          studentId: cookies.get('studentId'),
          tagId: this.tagId,
          currPage: this.page
        })
          .then((res) => {
            this.bookList = []
            for (let i = 0; i < 8; i++) {
              if (res.data.data.books[i]) {
                res.data.data.books[i].isdashed = false
                this.bookList.push(res.data.data.books[i])
              } else {
                this.bookList.push({isdashed: true})
              }
            }
            this.page = res.data.data.current
            this.pageTotal = res.data.data.total
            if (this.page > 1) {
              this.isShowLeftBtn = true
            }
            if (this.pageTotal === this.page) {
              this.isShowRightBtn = false
            }
            if (this.pageTotal === 0) {
              this.isShowLeftBtn = false
              this.isShowRightBtn = false
            }
          })
          .catch((err) => {
          })
      },
      setClickBook(id){
        return $post(this.clickBookUrl, {
          studentId: cookies.get('studentId'),
          bookId: id
        })
      },
      setReadStartTime(id){
        return $post(this.readStartTimeUrl, {
          studentId: cookies.get('studentId'),
          bookId: id
        })
      },
      cancelDialog(){
        this.isShowDialog = !this.isShowDialog
      },
      dialogClick(){
        this.isShowDialog = true
      },
      openBookDetail(id){
        this.currentBookDetail = this.bookList[id]
        let level = `Level ${this.currentBookDetail.curriculumSN[0].split('-')[1].substr(1)}`
        let unit = `Unit ${this.currentBookDetail.curriculumSN[0].split('-')[2].substr(1)}`
        let readStatus = false
        if (this.currentBookDetail.status == 1) {
          readStatus = true
        }
        
        this.$modelShow({
          source: utils.clickEventConst.PC_MC_READER_ENTRANCE,
          unit: unit,
          level: level,
          bookCode: this.currentBookDetail.code,
          id: this.currentBookDetail.id,
          router: this.$router,
          showName: this.currentBookDetail.name,
          bookCoverResUrl: this.currentBookDetail.coverResUrl,
          bookDescription: this.currentBookDetail.description,
          readStatus: readStatus,
          model: bookDetail
        })
      },
      prePage(){
        this.isShowRightBtn = true
        if (this.page - 1 <= 1) {
          this.isShowLeftBtn = false
        }
        if (this.page - 1 > 0) {
          this.page -= 1
          this.getBookList()
        }
      },
      nextPage(){
        this.isShowLeftBtn = true
        if (this.page + 1 >= this.pageTotal) {
          this.isShowRightBtn = false
        }
        if (this.page + 1 <= this.pageTotal) {
          this.page += 1
          this.getBookList()
        }
      }
    },
    components: {
      myHeader,
      myDialog,
      bookDetail
    }
  }
</script>
