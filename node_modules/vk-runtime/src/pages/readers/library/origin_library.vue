<template lang="jade">
  .library-wrapper(v-cloak)
    fullPageLoading(v-if="isFullPageLoadingShow")
    bookdetail(:isBookDetailShowProp = "isBookDetailShow", @bookDetailSwitch = "bookDetailSwitcher", :bookDetailDataProp = "bookDetailDataProp_", :numberOfStudentBorrow_ = "numberOfStudentBorrow")
    top-part(:title_cn = "title_chinese", :title_eng = "title_english", :isAbsoluteFix = "true", :gobackurl="'/digitalLibrary'")
    .no-auth(v-if="isNoAuth")
      .text
        p 您好，数字图书馆的读物和课程内容相关，为使您获得更好
        p 的阅读体验，建议您先为宝贝报名课程，再进行阅览学习。
        p.bigger 如有任何问题，请致电1010-1613
      img.no-auth-dino(src="../../../img/digireader/empty_dino.png")
      vk-button(type="lg-enable",text="返回首页",:isNewTab="false",link="/")
    .library-list(v-if="!isNoAuth")
      filter-component(@closeUserGuideBUS = "closeUserGuide", 
                        @setBookMarkerBUS = "setBookMarker", 
                        @filterEvent="getBooklistByFilter", 
                        :levelInfoObj = "levelInfoObj", 
                        :typeInfoObj = "typeInfoObj", 
                        :isShowUserGuideSecond="isShowUserGuideSecond", 
                        :currentLevelId = "currentLevelId",
                        :levelSmallIconCollection = "levelSmallIconCollection",
                        :typeSmallIconCollection = "typeSmallIconCollection"
                        )
      .leftbtn(@click="prePage", v-if="isShowLeftBtn")
        img(src="../../../img/readers/leftbtn.png")
      .rightbtn(@click="nextPage", v-if="isShowRightBtn")
        img(src="../../../img/readers/rightbtn.png")
      ul.library-list-body.clearfix
        //- .book-list-mask
        //-   img(src="../../../img/common/loading.gif")
        template(v-for="(item, index) in bookList")
          template(v-if="!item.isdashed")
            li.library-list-item(:class="[index > 3 ? 'no-margin-bottom' : '']", @click="openBookDetail(item.id, item.borrowStatus)", @mouseenter="bookNameMouseEnter($event)", @mouseleave="bookNameMouseLeave($event)")
              .book-img-contain(@mouseenter="reactMouseEnter($event)", @mouseleave="reactMouseLeave($event)", :class="animateCss")
                .book
                img.book-cover(:src = "item.coverResUrl + '?imageView2/2/w/328/h/370'", @load="loadingImage($event)", @error="loadingImageError")
                .read-status-icon.no-inventory(v-if="item.stockAvailable === 0")
                .read-status-icon.borrowing(v-else-if="item.borrowStatus == 1")
                .read-status-icon.borrowed(v-else-if="item.borrowStatus === 3")
                template(v-if="!isAllSubjects")
                  img.book-marker-no-word(:src="item.tag[0].imgUrl.split(';')[1]")
                template(v-else)
                  img.book-marker-word(:src="item.tag[0].imgUrl.split(';')[0]")
              .book-name-wrap(:class="{textellipsis: isOnIpad}")
                .book-name {{item.name}}
              .book-page-view
                img(src="../../../img/readers/reader.png")
                span.clickrate {{item.clickRate}}
                .inventory
                span.inventory-text {{item.stockAvailable}}
          template(v-else)
            li.dashed-book(:class="[index > 3 ? 'no-margin-bottom' : '']")
    .bookshelf-entry-container(:class="{'user-guide': isShowUserGuideFirst}")
      .bookshelf-entry.borrow-1(@click="isShowUserGuideFirst ? null : jumpToMyBookshelf()", v-if="numberOfStudentBorrow==1")
        | 我的书架1/3
      .bookshelf-entry.borrow-2(@click="isShowUserGuideFirst ? null : jumpToMyBookshelf()", v-else-if="numberOfStudentBorrow==2")
        | 我的书架2/3
      .bookshelf-entry.borrow-3(@click="isShowUserGuideFirst ? null : jumpToMyBookshelf()", v-else-if="numberOfStudentBorrow==3")
        | 我的书架3/3
      .bookshelf-entry.no-borrow(v-else)
        | 未借书
      .quesion-button(@click="showHowToBorrowDialog")
      img.guide-mybooks(src="../../../img/digireader/guide_mybooks.png", v-if="isShowUserGuideFirst")
      img.guide-how-to-borrow(src="../../../img/digireader/guide_howtoborrow.png", v-if="isShowUserGuideFirst")
    img.guide-next-step(src="../../../img/digireader/guide-next@2x.png", v-if="isShowUserGuideFirst", @click.stop="nextUserGuideLayer")
    my-dialog(:tipText="'1.宝贝可以同时借（最多）3个绘本；<br>2.每个绘本借阅的时间为14天，到期后绘本会自动归还哦。'", :type="'alert'", :cancelButton = "'知道了'", :title="'Notice'", isShowTitle = true, @library-dialog-cancel="cancelHowToBorrowDialog", v-if="isShowHowToBorrowDialog")
    my-dialog(:tipText="bookExpireText", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-cancel="cancelBookExpireDialog", v-if="isShowBookExpirePop")
    my-dialog(:tipText="'网络有点问题，检查一下网络连接吧'", :confirmButton="'刷新页面'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-cancel="reloadPage", v-if="isBadNetworkAlertShow")
    .user-guide-mask(v-if="isShowUserGuideMask")
</template>
<style lang="stylus" scoped>
  *
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    -webkit-touch-callout: none

  $screenWidthSmaller_1080 = "screen and (max-width: 1080px)"
  $screenWidthSmaller_1366 = "screen and (max-width: 1366px)"
  SPIRIT_PIC_WIDTH = 1430px / 2
  .clearfix:before, .clearfix:after
    display: table
    content: ""

  .clearfix:after
    clear: both

  ul, li
    list-style: none
    list-style-image: none

  a
    text-decoration: none
    color: #333
  .no-auth
    position: absolute
    top: 50%
    left: 50%
    width: 580px
    height: 546px
    margin: -228px 0 0 -293px
    text-align: center
    .no-auth-dino
      position: relative
      top: -12px
    .text
      font-size: 20px
      line-height: 1.5em
      color: #371575
      text-align: center
      font-weight: 400
      background-image: url('../../../img/digireader/bg_tip.png')
      background-size: 100% 100%
      width: 580px
      height: 147px
      box-sizing: border-box
      padding: 20px 0 0 0

      p.bigger
        font-size: 24px
        font-weight: 800

  .user-guide-mask
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    background-color: rgba(0, 0, 0, 0.6)
    z-index: 10

  .guide-next-step
    position: absolute
    top: 183px
    right: 122px
    width: 111px
    z-index: 99
    cursor: pointer
    display: inline-block

  .win_size
    position: fixed
    bottom: 10px
    left: 10px

  .library-wrapper
    height: 100%
    color: #fff
    background-image: url('../../../img/digireader/digi-entry-bg.png')
    background-size: 100%
    .level-title,
    .unit-title
      line-height: 1.4
      padding-top: 13px
      font-size: 24px
    .unit-title
      padding: 0
      font-size: 34px
    .library_dialog_wrapper
      .alert-text
        position: absolute
        top: 50%
        margin-top: -40px
        text-align: center
    .readers-title
      & > p
        padding: 0
        margin: 0 0 10px
        font-size: 36px
    [v-cloak]
      display: none
  //弹层样式
    .book_detail_dialog_wrapper
      .description
        width: 460px
        float: left
      .description-title
        font-size: 28px
        text-align: center
      .description-text
        font-size: 20px
      .book-img-contain
        width: 210px
        position: absolute
        right: 56px
        top: 21px
        .book
          background-image: url('../../../img/digireader/reader_spirit.png')
          background-size: 866px
          background-repeat: no-repeat
          width: 100%
          height: 254px
          background-position: -564px -1px
        .book-cover
          width: 199px
          height: 223px
          position: absolute
          top: 0px
          left: 14px
    .dom-opacity
      opacity: 0.5
      .book-mask
        width: 164px
        height: 185px
        position: absolute
        top: 0px
        left: 10px
        background-color: rgba(0, 0, 0, 0.7)
    .library-list
      width: 1000px
      position: relative
      top: 50%
      margin: -279px auto 0 auto
      @media $screenWidthSmaller_1080
        zoom: 0.9
      .leftbtn
        width: 38px
        position: absolute
        top: 50%
        left: -36px
        cursor: pointer
        margin-top: -54px
        z-index: 2
        &:hover
          opacity: 0.8
        & > img
          width: 38px
          height: 70px
      .rightbtn
        width: 38px
        position: absolute
        top: 50%
        right: 0
        cursor: pointer
        margin-top: -54px
        z-index: 2
        &:hover
          opacity: 0.8
        & > img
          width: 38px
          height: 70px
      .library-list-body
        width: 100%
        padding: 0
        margin: 0
        margin-left: 42px
        position: relative
        .book-list-mask
          position: absolute
          top: -7px
          left: 0
          right: 135px
          bottom: 0
          background-color: rgba(0, 0, 0, 0.8)
          z-index: 10
          text-align: center
          & > img
            margin: 0 auto
            position: absolute
            top: 50%
            margin-top: -132px
            left: 0
            right: 0
      .library-list-item
        width: 174px
        height: 282px
        margin: 0 23px 15px
        float: left
        cursor: pointer
        position: relative
        &.text-move
          .book-name
            animation: bookNameMove 5s linear infinite
            -webkit-animation: bookNameMove 5s linear infinite
          .book-name-wrap
            text-overflow: initial
        &.no-margin-bottom
          margin-bottom: 0
        .read-status-icon
          width: 66px
          height: 67px
          position: absolute
          top: -4px
          left: -4px
          background-image: url('../../../img/digireader/reader_spirit.png')
          background-size: SPIRIT_PIC_WIDTH
          background-repeat: no-repeat
          &.no-inventory
            background-position: -210px -22px
          &.borrowing
            background-position: -134px -22px
          &.borrowed
            background-position: -629px -233px
        .book-img-contain
          position: relative
          &.animated
            animation-duration: 0.5s
          .book
            background-image url('../../../img/digireader/empty-book@2x.png')
            background-size: 100% 100%
            background-repeat: no-repeat
            width: 100%
            height: 211px
          .book-marker-word
            position: absolute
            bottom: -7px
            left: 15px
            width: 28px
            height: 24px
          .book-marker-no-word
            position: absolute
            bottom: 1px
            left: 15px
            width: 28px
            height: 12px
          .lock-book
            width: 164px
            height: 186px
            position: absolute
            top: 0px
            left: 10px
            & > img
              width: 46px
              height: 55px
              position: absolute
              top: 50%
              left: 50%
              margin: -23px 0 0 -27px
        .read-status-end,
        .read-status-new
          width: 72px
          height: 28px
          line-height: 28px
          position: absolute
          right: 2px
          top: 1px
          font-style: normal
          font-size: 14px
          background: #7dbf4b
          text-align: center
          border-bottom-left-radius: 10px
        .read-status-end
          background: #ccc
        .book-cover
          width: 164px
          height: 185px
          position: absolute
          right: 0px
          top: 0px
        .book-name-wrap
          width: 100%
          overflow: hidden
          white-space: nowrap
          margin-top: 10px
          text-overflow: ellipsis
          &.textellipsis
            text-overflow: ellipsis
          .book-name
            font-size: 16px
            margin: 5px 0 0 0
            height: 21px
            white-space: nowrap
            display: inline-block
        .book-page-view
          font-size: 14px
          margin: 7px 0
          white-space: nowrap
          overflow: hidden
          img
            width: 22px
            height: 12px
            margin-right: 6px
            display: inline-block
            vertical-align: middle
          .clickrate
            margin-right: 20px
            display: inline-block
            vertical-align: middle
          .inventory
            background-image: url('../../../img/digireader/reader_spirit.png')
            background-size: SPIRIT_PIC_WIDTH
            background-repeat: no-repeat
            display: inline-block
            vertical-align: middle
            width: 13px
            height: 14px
            background-position: -77px -5px
            margin-right: 10px
          .inventory-text
            display: inline-block
            vertical-align: middle
      .dashed-book
        width: 174px
        height: 209px
        border: 2px dashed #8561ed
        border-radius: 20px
        cursor: default
        box-sizing: border-box
        display: inline-block
        margin: 0 23px 97px 23px
        float: left
        position: relative
        &.no-margin-bottom
          margin-bottom: 0

  .bookshelf-entry-container
    position: absolute
    top: 24px
    right: 39px
    z-index: 10
    &.user-guide
      z-index: 12
    .guide-mybooks
      position: absolute
      top: 0
      left: 0
      width: 166px
      top: 62px
      left: -90px
      width: 166px
      z-index: 99
    .guide-how-to-borrow
      position: absolute
      top: 63px
      right: -16px
      width: 138px
      z-index: 99
    .bookshelf-entry
      background-color: rgba(0,0,0, 0.2)
      width: 110px
      height: 36px
      border-radius: 60px
      display: inline-block
      vertical-align: middle
      margin-right: 25px
      cursor: pointer
      position: relative
      box-sizing: border-box
      padding: 7px 0 0 16px
      font-size: 15px
      &:before
        content: ""
        width: 36px
        height: 36px
        position: absolute
        top: 0
        left: -24px
        background-image: url('../../../img/digireader/icon-bookshelf@2x.png')
        background-repeat: no-repeat
        background-size: 100% 100%
      &.no-borrow
        padding: 7px 0 0 36px
        cursor: not-allowed
      &.borrow-1
        &:after
          content: ''
          position: absolute
          height: 30px
          width: 40px
          border-radius: 15px
          background-color: #b396ff
          z-index: -1
          top: 3px
          left: 0
      &.borrow-2
        &:after
          content: ''
          position: absolute
          height: 30px
          width: 70px
          border-radius: 15px
          background-color: #b396ff
          z-index: -1
          top: 3px
          left: 0
      
      &.borrow-3
        &:after
          content: ''
          position: absolute
          height: 30px
          width: 107px
          border-radius: 15px
          background-color: #b396ff
          z-index: -1
          top: 3px
          left: 0

    .quesion-button
      background-image: url('../../../img/digireader/reader_spirit.png')
      background-size: SPIRIT_PIC_WIDTH
      background-repeat: no-repeat
      width: 51px
      cursor: pointer
      height: 51px
      display: inline-block
      vertical-align: middle
      background-position: -439px -231px
      &:hover
        background-position: -494px -231px
      &:active
        background-position: -551px -232px

  @css {
    @-webkit-keyframes bookNameMove {
      from {
        transform: translate3d(0, 0, 0)
      }
      to {
        transform: translate3d(-100%, 0, 0)
      }
    } @keyframes bookNameMove {
        from {
          transform: translate3d(0, 0, 0)
        }
        to {
          transform: translate3d(-100%, 0, 0)
        }
      }
  }
</style>

<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import {$get, $post, $all} from '../api.js'
  import utils from '../../../utils/_untils.js'
  import TopPart from '../../common/top_part.vue'
  import myHeader from "../header.vue"
  import filterComponent from "../component/filter_vo.vue"
  import myDialog from "../common/dialog.vue"
  import bookdetail from "../component/digi_bookdetail.vue"
  import fullPageLoading from "../../common/vk_turn_page_loading.vue"
  import vkButton from "../../common/vk_button.vue"

  export default {
    data() {
      return {
        isNoAuth: true,
        isFullPageLoadingShow: cookies.get('isFromApp') ? false : true,
        isBadNetworkAlertShow: false,
        isShowUserGuideMask: false,
        isShowUserGuideFirst: false,
        isShowUserGuideSecond: false,
        DLType_Math_Id: 11,
        DLType_Science_Id: 12,
        DLType_Social_Id: 13,
        title_chinese: '原创系列',
        title_english: 'VIPKID Originals',
        bookListUrl: '/api/pc/service/digitlib/getBookList',
        clickBookUrl: '/api/pc/service/reader/clickBook',
        readStartTimeUrl: '/api/pc/service/reader/setBeginTime',
        pageTotal: 0,
        currentPage: 0,
        isShowHowToBorrowDialog: false,
        isShowLeftBtn: false,
        isShowRightBtn: true,
        bookList: [],
        currentBookDetail: '',
        animateCss: '',
        isBookDetailShow: false,
        isAllSubjects: true,
        browserType: null,
        indexOfBookList: 0,
        limitOfBookList: 8,
        totalNumOfBookList: null,
        levelInfoObj: [],
        typeInfoObj: {},
        filterId: [],
        bookDetailDataProp_: {},
        numberOfStudentBorrow: 0,
        isOnIpad: false,
        bookExpireText: '没有内容',
        bookExpireList: [],
        isShowBookExpirePop: false,
        studentBorrowBookIds: [],
        bookListLength: null,
        currentLevelId: '',
        levelSmallIconCollection: [],
        typeSmallIconCollection: []
      }
    },
    props: [],
    mounted(){
      this.getEntryData()
      this.checkUserPay()
    },
    methods: {
      //检查用户是否购买
      checkUserPay() {
        axios.get(`/rest/learninggw/api/pc/service/digitlib/${cookies.get("studentId")}/isPayUser`)
          .then((res) => {
            if (res.data.code == 200) {
              if (res.data.data) {
                this.initData()
                this.isNoAuth = false
                return
              }
            }
            this.isFullPageLoadingShow = false
            this.isNoAuth = true
          }
          ).catch((error) => {
            this.isFullPageLoadingShow = false
            this.isNoAuth = true
          })
      },
      initData(){
        axios.all([this.setLevelInfoObj(), this.setTypeInfoObj()])
          .then(axios.spread((acct, perms) => {
            this.getBookList()
          }))
        this.setStudentBorrowStatus()
        this.popTips()
        this.checkBookExpire()
        this.isOnIpad = utils.isOnIpad()
        if (cookies.get('isFromApp')) {
          this.loadURL('vkappbridge://loading/stop') //停止ipad的loading界面
        }
      },
      getEntryData() {
        axios.get('/rest/learninggw/api/pc/service/digitlib/homepage', {})
          .then((res) => {
            this.title_chinese = res.data.data.originalClassic.titleCH
          })
          .catch((err) => {
            this.title_chinese = '原创系列'
          })
      },
      reloadPage() {
        window.location.reload(true)
      },
      nextUserGuideLayer() {
        this.isShowUserGuideFirst = false
        this.isShowUserGuideSecond = true
      },
      closeUserGuide() {
        this.isShowUserGuideMask = false
      },
      checkBookExpire() {
        var url = '/api/pc/service/digitlib/getNotNoticeReturnedBooks'
        $get(url, {
          studentId: cookies.get('studentId')
        })
          .then((res) => {
            bookExpireList = res.data.data
            let bookName = ''
            if (bookExpireList) {
              bookExpireList.vkForEach((item, index) => {
                this.studentBorrowBookIds.push(item.studentBorrowBookId)
                bookName += '《' + item.name + '》'
                if (index != bookExpireList.length - 1) {
                  bookName += '、'
                }
              })
              this.bookExpireText = bookName + '已到期，自动归还成功。'
              if (this.studentBorrowBookIds.length)
                this.isShowBookExpirePop = true
            } else {
              //没有到期的书
            }
          })
          .catch((err) => {
          })
      },
      confirmBookExpire() {
        if (this.studentBorrowBookIds.length == 0) {
          return
        }
        $post('/api/pc/service/digitlib/updateNotifiedBooks', {
          studentBorrowBookIds: this.studentBorrowBookIds.toString()
        })
          .then((res) => {
          })
          .catch((err) => {
          })
      },
      cancelBookExpireDialog() {
        this.confirmBookExpire()
        this.isShowBookExpirePop = false
      },
      bookNameMouseEnter(event) {
        if (!utils.isOnIpad()) event.target.className += ' text-move'
      },
      bookNameMouseLeave(event) {
        if (!utils.isOnIpad()) utils.removeClass(event.target, 'text-move')
      },
      loadURL(url) {
        var iFrame
        iFrame = document.createElement("iframe")
        iFrame.setAttribute("src", url)
        iFrame.setAttribute("style", "display:none;")
        document.body.appendChild(iFrame)
        //把它从dom上移除掉
        iFrame.parentNode.removeChild(iFrame)
        iFrame = null
      },
      setStudentBorrowStatus() {
        var url = '/api/pc/service/digitlib/' + cookies.get('studentId') + '/myBookShelf'
        $get(url, {})
          .then((res) => {
            this.numberOfStudentBorrow = res.data.data.books.length
          })
          .catch((err) => {
          })
      },
      setLevelInfoObj() {
        return axios.get('/rest/learninggw/api/pc/service/digitlib/getLevelAndCategoryInfo', {
          params: {
            tag: 'l_tsb',
            studentId: cookies.get('studentId')
          }
        })
          .then((res) => {
            let data = res.data.data
            for(let i = 0; i < data.length; i++) {
              this.levelInfoObj.push(data[i])
              this.levelSmallIconCollection[data[i].id] = data[i].imgSmallUrl
              if( data[i].isCurrentLevel ) {
                this.currentLevelId = data[i].id
                this.filterId = data[i].id
              }
            }
          })
          .catch((err) => {
            this.isFullPageLoadingShow = false
            this.isBadNetworkAlertShow = true
          })
      },
      setTypeInfoObj() {
        return axios.get('/rest/learninggw/api/pc/service/digitlib/getLevelAndCategoryInfo', {
          params: {
            tag: 'tsb',
            studentId: cookies.get('studentId')
          }
        })
          .then((res) => {
            let data = res.data.data
            for(let i = 0; i < data.length; i++) {
              this.$set(this.typeInfoObj, data[i].id, data[i])
              this.typeSmallIconCollection[data[i].id] = data[i].imgSmallUrl
            }
          })
          .catch((err) => {
            this.isFullPageLoadingShow = false
            this.isBadNetworkAlertShow = true
          })
      },
      jumpToMyBookshelf() {
        this.$playSound("click")
        this.$router.push({path: '/myBookshelf'})
      },
      setBookMarker(subjectType) {
        if (subjectType == 0) {
          this.isAllSubjects = true
        } else {
          this.isAllSubjects = false
        }
      },
      bookDetailSwitcher() {
        this.isBookDetailShow = false
      },
      reactMouseEnter(event) {
        event.target.className += ' animated pulse'
      },
      reactMouseLeave(event) {
        utils.removeClass(event.target, 'animated')
        utils.removeClass(event.target, 'pulse')
      },
      getBooklistByFilter(arr) {
        for (var i = 0; i < arr.length; i++) {
          if (arr[i] == 0) {
            arr.splice(i, 1)
            i--
          }
        }
        this.filterId = arr.toString()
        this.indexOfBookList = 0
        this.getBookList()
      },
      loadingImageError() {
        this.loadingControlByImgState()
      },
      loadingImage() {
        this.loadingControlByImgState()
      },
      loadingControlByImgState() {
        if (this.bookListLength == 1) {
          if (cookies.get('isFromApp')) {
            setTimeout(() => {
              this.isFullPageLoadingShow = false
            }, 300)
          } else {
            setTimeout(() => {
              this.isFullPageLoadingShow = false
            }, 300)
          }
        }
        this.bookListLength--
      },
      getBookList() {
        this.isFullPageLoadingShow = true
        $get(this.bookListUrl, {
          tagIDs: this.filterId,
          studentId: cookies.get('studentId'),
          limit: this.limitOfBookList,
          start: this.indexOfBookList,
          type: 3
        })
          .then((res) => {
            if (!res.data.data) {
              if (cookies.get('isFromApp')) {
                alert('您没有权限')
              } else {
                this.$router.push({path: '/'})
              }
              return
            }
            this.bookListLength = res.data.data.books.length
            this.bookList = []
            this.currentPage = res.data.data.currentPage
            this.pageTotal = res.data.data.totalPage
            this.totalNumOfBookList = res.data.data.total
            if (!res.data.data.books.length) {
              this.isFullPageLoadingShow = false
            }
            this.$nextTick(() => {
              for (let i = 0; i < 8; i++) {
                if (res.data.data.books[i]) {
                  res.data.data.books[i].isdashed = false
                  this.bookList.push(res.data.data.books[i])
                } else {
                  this.bookList.push({isdashed: true})
                }
              }
            })
            if (this.pageTotal <= 1) {
              this.isShowRightBtn = false
              this.isShowLeftBtn = false
            } else {
              if (this.currentPage != this.pageTotal) {
                this.isShowRightBtn = true
              }
              if (this.currentPage == 1) {
                this.isShowLeftBtn = false
              }
            }
          })
          .catch((err) => {
            this.isFullPageLoadingShow = false
            this.isBadNetworkAlertShow = true
          })
      },
      setClickBook(id){
        return $post(this.clickBookUrl, {
          studentId: cookies.get('studentId'),
          bookId: id
        })
      },
      setReadStartTime(id){
        return $post('/api/pc/service/reader/setBeginTime', {
          studentId: cookies.get('studentId'),
          bookId: id
        })
      },
      cancelHowToBorrowDialog() {
        this.isShowHowToBorrowDialog = !this.isShowHowToBorrowDialog
      },
      showHowToBorrowDialog() {
        this.isShowHowToBorrowDialog = true
      },
      openBookDetail(bookId, borrowStatus) {
        if (borrowStatus == 1) {
          if (this.IS_IN_IPAD_APP) {
            window.location.href = 'http://' + window.location.host.replace(/lc/, 'learning') + '/new/book/' + bookId + '/2'
          } else {
            window.location = '/book/' + bookId + '/2'
          }
          return
        }
        if (this.IS_IN_IPAD_APP) {
          utils.clickEvent(cookies.get('studentId'), bookId, utils.clickEventConst.IPAD, utils.clickEventConst.CLICK_BOOKCOVER, null, 1)
        } else {
          utils.clickEvent(cookies.get('studentId'), bookId, utils.clickEventConst.PC, utils.clickEventConst.CLICK_BOOKCOVER, null, 1)
        }
        var url = '/api/pc/service/digitlib/' + cookies.get('studentId') + '/' + bookId + '/detail'
        $get(url, {})
          .then((res) => {
            this.isBookDetailShow = true
            this.bookDetailDataProp_ = res.data.data
          })
          .catch((err) => {
            this.isFullPageLoadingShow = false
            this.isBadNetworkAlertShow = true
          })
      },
      prePage() {
        this.isShowRightBtn = true
        if (this.indexOfBookList - this.limitOfBookList >= 0) {
          this.indexOfBookList -= this.limitOfBookList
          this.getBookList()
        }
        if (this.indexOfBookList - this.limitOfBookList < 0) {
          this.isShowLeftBtn = false
        }
      },
      nextPage() {
        this.isShowLeftBtn = true
        if (this.indexOfBookList + this.limitOfBookList <= this.totalNumOfBookList) {
          this.indexOfBookList += this.limitOfBookList
          this.getBookList()
        }
        if (this.indexOfBookList + this.limitOfBookList >= this.totalNumOfBookList) {
          this.isShowRightBtn = false
        }
      },
      popTips() {
        $post(`/api/pc/service/digitlib/${cookies.get('studentId')}/visitorDigLibTimes`, {})
          .then((res) => {
            if (res.data.data == 1) {
              this.isShowHowToBorrowDialog = true
              this.isShowUserGuideFirst = true
              this.isShowUserGuideMask = true
            }
          })
          .catch((err) => {
          })
      }
    },
    components: {
      TopPart,
      myHeader,
      myDialog,
      bookdetail,
      filterComponent,
      fullPageLoading,
      vkButton
    }
  }
</script>
