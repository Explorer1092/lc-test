<template lang="jade">
  .detail_bg
    top-part(:title_cn = "title_chinese", :title_eng = "title_english", :isAbsoluteFix = "true", :gobackurl="''", :mark="'libarary_detail'")
    .black-mirror(v-if="isGuideShow")
    my-dialog(:tipText="'网络有点问题，检查一下网络连接吧'", :confirmButton="'刷新页面'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-close ="closeAlert",@library-dialog-cancel="reloadPage", v-if="isBadNetworkAlertShow")
    my-dialog(:tipText= "ipadRecodrDialogTrips", :confirmButton="'好的'", :type="'alert'", title="Notice", isShowTitle = true,@library-dialog-cancel="closeIpadDialog", v-if="isInPad",:isShowCloseButton="false")
    myBookButton
    .hang-board-postion-control
      .hang-board
        .infinite-part
        .right-end
        p {{bookResData.name}}
    .main-content-wrap
      .guess-like-title Guess you like
      .guess-like-content-wrap
        template(v-if="isGotAuth")
          .book-item-box(v-for="item in guessYouLikeBookList")
            bookItem(:bookDataProp = "item", :config = "guessLikeBookConfig", :isReplaceUrl = "true", :mark = "'library_detail_guess_you_like'")
        template(v-else)
          .no-auth
            img(src="../../../img/readers/empty-book@2x.png")
            p 宝贝暂无推荐绘本
      .white-board
        .favorite-btn-box
          .favorite-btn(@click = "clickHeart", :class="{'liked' : isFavorite}")
        .record-btn(@click = "goRecordingView" v-show="isCanRecord")
          p Record
        .read-btn(@click = "goReading")
          p Read
        .instruction-btn(v-if="bookResData.type == 2", @click="goBookListByType('0')") Teacher Created Materials
        .instruction-btn(v-else-if="bookResData.type == 3", @click="goBookListByType('1')") Teacher Story Books
        .instruction-btn(v-else-if="bookResData.type == 4", @click="goBookListByType('2')") Bob Books
        .instruction-btn(v-else-if="bookResData.type == 5", @click="goBookListByType('3')") Write-In Reader

        .left
          bookItem(:bookDataProp = "bookResData", :config = "bookConfig", :mark = "'library_detail_recommond'")
          .book-info-wrap
            h4 Preference
            p {{ preferenceName }}
            h4 Reading Level
            p {{ levelShowName }}
            h4 Lexile
            p {{ lexileVaule }}
            h4 Page
            p {{ bookResData.pageCount }}
        .right
          .book-content-wrap
            h2 {{bookResData.name}}
            .content-text(v-html="bookResData.description")
    transition(enter-active-class="animated bounceInDown",leave-active-class="animated bounceOutUp")
      downApp(v-show="isShowDownApp",:tripsContent="recordText",:isShowTrips="isShowTrips")
</template>
<script>
import axios from 'axios'
import cookies from 'cookies-js'

import TopPart from '../../common/top_part.vue'
import myDialog from "./../common/dialog.vue"
import Velocity from 'velocity-animate'
import bookItem from '../component/book_list_item.vue'
import myBookButton from '../component/top_right_button.vue'
import downApp from '../../common/vk_down_app.vue'
import dragonUtils from '../../../utils/_dragon.js'
import {loadURL} from '../libarary_utils.js'
export default {
  data: function() {
    return {
      isShowDownApp:false,
      recordText:'宝贝绘本配音暂不支持网页<br>给绘本配音请下载VIPKID学习中心客户端！',
      title_chinese: '',
      title_english: '',
      isGuideShow: false,
      numberOfStudentBorrow: '',
      isShowHowToBorrowDialog: false,
      cn: 'lc_dl_userguide_' + cookies.get('studentId'),
      pbData:{},
      voData:{},
      isShowBookList: false,
      isShowInitAnimationThings: false,
      bookData: {
        labelImgSrc: '',
        bookFaceImgSrc: 'https://teacher-media.vipkid.com.cn/resource/d0b5bd5f11ef452e85c9a7fd59db4f91.jpg',
        bookName: 'A Family\'s Story',
        clickRate: 1233
      },
      bookConfig: {
        style: 4,
        disableClick: true
      },
      guessLikeBookConfig: {
        style: 3
      },
      numberOfBooksShow: 8,
      booksArray: [1,2,3,4,5,6,7,8],
      bookResData: {},
      lexileVaule: 0,
      guessYouLikeBookList: [],
      isFavorite: false,
      id: 0,
      bookCode: this.$route.params.bookCode,
      isBadNetworkAlertShow: false,
      preferenceName: 'Science',
      levelShowName: 'level X',
      isGotAuth: true,
      isCanRecord:false,
      isInPad:false,
      isShowTrips:false,
      ipadRecodrDialogTrips:'宝贝绘本配音暂不支持iPad<br>请升级iPad APP',
      ipadVersionArray:[],// ipad 版本号
      isNewBox: false,// 是否在新容器
      // isUnlock 灰度测试标识
      isUnlock: 0 // 0: 非灰度 // 1: 灰度
    }
  },
  components: {
    TopPart,
    myDialog,
    bookItem,
    myBookButton,
    downApp
  },
  watch: {
    '$route': 'getDetail'
  },
  mounted() {
    if(this.IS_IN_IPAD_APP){ // 根据ipad 版本号 区分新老容器
      this.ipadVersionArray = this.getAppVersion().split(".")
      if((parseInt(this.ipadVersionArray[0]) > 2) || (parseInt(this.ipadVersionArray[0]) == 2 && parseInt(this.ipadVersionArray[1])>=14)){
        // 版本号大于2 或者版本号大于等于 2.14 进新容器
        this.isNewBox = true
      }else{
        // 版本号小于2.14的进老容器
        this.isNewBox = false
      }
    }
    this.getDetail()
    this.getGuessYouLikeBookList()
  },
  methods: {
    closeIpadDialog(){
      this.isInPad = false
    },
    closeAlert(){
      this.isBadNetworkAlertShow = false
    },
    //去录音报告视图
    goReadingInformationView(){
      this.$router.push({path: '/bookRecordData'})
    },
    //去录音课本
    goRecordingView(){
      sa.track('learning_click', {
        'click_id': 'pc_learning_vedio_record_coming_record_view'
      })
      if( this.IS_IN_IPAD_APP ) {
        if(this.isNewBox){ // 新容器
          let route = `vkstudy://reader/readerRecord?bookId=${this.id}`
          let routeCode = encodeURIComponent(route)
          loadURL(`vkappbridge://ipadcommon/ipadRouter?route=${routeCode}`)
        }else{ // 老容器
          location.href = 'http://learning.vipkid.com.cn/new/recordbook/' + this.id + '/2'
        }
      } else {
        // isUnlock 灰度测试中的，标识
        if (this.isUnlock === 0) {
          window.location = '/bookRecord/' + this.id + '/2/' + this.bookResData.code
        } else {
          window.location = '/bookRecordV2/' + this.id + '/2/' + this.bookResData.code
        }
      }
    },
    // 根据 book的 type跳转到不同 help.vue的路由
    goBookListByType( type ) {
      this.$router.push({path:'/digitalLibrary/help/' + type})
      sa.track('learning_click', {'click_id': 'pc_learning_digital_seriers_button_type_is_' + type})
    },
    reloadPage() {
      window.location.reload(true)
    },
    clickHeart() {
      sa.track('learning_click', {'click_id': 'pc_learning_digital_detail_set_favorite'})
      if( this.isFavorite ) {
        this.cancelFavorite()
      } else {
        this.setFavorite()
      }
    },
    processLevelText( text ) {
      return 'Level ' + text.match(/\d/).toString()
    },
    setFavorite() {
      axios.post(`/rest/learninggw/api/pc/service/digitlib/addCollectionBook?studentId=${cookies.get('studentId')}&bookCode=${this.bookCode}`)
        .then((res) => {
          this.isFavorite = !this.isFavorite
        })
    },
    cancelFavorite() {
      axios.post(`/rest/learninggw/api/pc/service/digitlib/deleteCollectionBook?studentId=${cookies.get('studentId')}&bookCode=${this.bookCode}`).then((res) => {
        this.isFavorite = !this.isFavorite
      })
    },
    cancelHowToBorrowDialog() {
      this.isShowHowToBorrowDialog = !this.isShowHowToBorrowDialog
    },
    showHowToBorrowDialog() {
      this.isShowHowToBorrowDialog = true
    },
    goReading() {
      sa.track('learning_click', {'click_id': 'pc_learning_digital_library_detail_go_reading_button_id_' + this.id})
      if( this.IS_IN_IPAD_APP ) {
        if(this.isNewBox == true){
          // 新容器
          let route = `vkstudy://reader/readerDetail?readerId=${this.id}&bookType=1`
          let routeCode = encodeURIComponent(route)
          loadURL(`vkappbridge://ipadcommon/ipadRouter?route=${routeCode}`)
        }else{
          // 老容器
          window.location.href = 'http://' + window.location.host.replace(/lc/,'learning') + '/new/book/' + this.id + '/2'
        }
      } else {
        window.location = '/book/' + this.id + '/2/' + this.bookResData.code
      }
    },

    /**
     * @description ipad录音版本上线发布时间是6月11日（有些灰度发布），
     *        在6月11之前，
     *        ipad版本小于2.10.0的告诉去PCApp
     *        在6月11之后
     *        ipad版本小于2.10.0让用户去升级ipad App
     *        大于>2.10.0用户可以录音
     *   @param year {int}
     *   @param month {int}
     *   @param day {int}
    */
    checkoutIpadVersion(year=2018,month=5,day=11){
      let publishTime = (new Date(year, month, day)).getTime()
      let currentTime = (new Date()).getTime()
      let versionArray = this.getAppVersion().split(".")

      this.isShowDownApp =false
      
      if( parseInt(versionArray[0])>2||
          (parseInt(versionArray[0]) == 2&&parseInt(versionArray[1])>=10)
      ) {
        //版本大于2，不弹窗,或者版本号为2.10版本，能够录音
        this.isCanRecord = true
        this.isInPad = false
      } else {
      //此外根据时间去判断。
        if(currentTime >= publishTime){
          this.ipadRecodrDialogTrips = "宝贝绘本配音暂不支持iPad<br>请升级该App"
        } else {
          this.ipadRecodrDialogTrips = "宝贝绘本配音暂不支持iPad<br>给绘本配音请下载VIPKID学习中心客户端"
        }
        this.isInPad = true
        this.isCanRecord = false
      }
    },
    //获取Ipad App版本号
    getAppVersion(){
      let appUserAgentInformaition = navigator.userAgent
      let appUserAgentInformaitionArray = appUserAgentInformaition.split(" ")
      let version = ""
      appUserAgentInformaitionArray.forEach((item,index)=>{
        if(item.indexOf('study-app')>-1){
          version = item.slice(10)
        }
      })
      return version
    },
    getDetail() {
      axios.get(`/rest/learninggw/api/pc/service/digitlib/${cookies.get('studentId')}/${this.$route.params.id}/${this.$route.params.bookCode}/detail`)
        .then((res) => {
          let data = res.data.data
          // 是否可以录音
          let isCanRecord = data.allowRepeat ? true:false
          // 智能语音平台，灰度标识
          this.isUnlock = data.isUnlock

          this.bookResData = data
          this.lexileVaule = data.lexile.showName
          this.id = data.id
          this.bookCode = data.code
          this.isFavorite = data.isCollected ? true : false
          for(let i = 0; i < data.tag.length; i++) {
            if( data.tag[i].name.match(/MC/) ) {
              this.levelShowName = this.processLevelText(data.tag[i].name)
            } else {
              this.preferenceName = data.tag[i].name
            }
          }
          if(isCanRecord){
            this.isCanRecord = true
            //如果是在客户端，
            if(dragonUtils.isOnDragonClient()) {
              this.isShowDownApp =false
              this.isCanRecord = true
            } else if(cookies.get('isFromApp')){
              //如果在ipad端
              //判断版本号
              this.checkoutIpadVersion(2018,5,11)
            } else {
            //在pc端
              this.isCanRecord = false
              this.isShowDownApp = true
            }
          } else{
            this.isCanRecord = false
            this.isShowDownApp = false
          }
          if(cookies.get('isFromApp')) {
            loadURL('vkappbridge://loading/stop') //停止ipad的loading界面
          }
        })
        .catch((err) => {
          if (cookies.get('isFromApp')) {
            loadURL('vkappbridge://loading/stop') //停止ipad的loading界面
          }
          this.isBadNetworkAlertShow = true
        })
    },
    getGuessYouLikeBookList() {
      axios.get('/rest/learninggw/api/pc/service/digitlib/recommendBooks', {
        params:{
          studentId: cookies.get('studentId'),
          limit: 2,
          start: 0
        }
      }).then((res) => {
        if(res.data.code == '100001') {
          this.isGotAuth = false
        } else {
          for(let i = 0; i < res.data.data.data.length; i++) {
            this.guessYouLikeBookList.push(res.data.data.data[i])
          }
        }
      })
    }
  }
}
</script>
<style lang="stylus" scoped>
*
  box-sizing: border-box
  -moz-user-select: none
  -webkit-user-select: none
  -ms-user-select: none
  -khtml-user-select: none
  user-select: none
  -webkit-font-smoothing: antialiased
  font-weight: 300
  -webkit-touch-callout: none
  .detail_bg
    background-repeat: no-repeat
    background-position: center
    background-size: 1920px
    background-color: #6D4C9E
    width: 100%
    height: 100%
    background-image: url('../../../img/library/bg-book-1280-1920.png')
    background-size: 1920px
    .hang-board-postion-control
      position: absolute
      top: 0
      left: 0
      right: 0
      text-align: center 
      .hang-board
        display: inline-block
        position: relative
        margin: 0 auto
        line-height: 119px
        font-size: 24px
        font-weight: 600
        color: #ffffff
        height: 119px
        min-width: 448px
        background-image: url('../../../img/library/top-hang-left-end.png')
        background-position: left
        background-size: 100%
        background-size: contain
        background-repeat: no-repeat
        padding: 0 124px 0 291px
        p
          position: relative
          top: -115px
          left: -82px
        .right-end
          position: absolute
          top: 0
          right: 0
          height: 100%
          width: 124px
          background-image: url('../../../img/library/top-hang-right-end.png')
          background-size: contain
          background-repeat: no-repeat
        .infinite-part
          height: 100%
          width: 100%
          background-image: url('../../../img/library/top-hang-infinite-part.png')
          background-repeat: repeat-x
          background-size: contain
    .main-content-wrap
      position: absolute
      top: 50%
      left: 50%
      margin: -261px 0 0 -410px
      width: 821px
      height: 571px
      .guess-like-content-wrap
        position: absolute
        top: 107px
        right: 23px
        .no-auth
          img
            width: 100%
            margin-bottom: 5px
          p
            color: white
        .book-item-box
          margin: 29px 0 41px 0
      .instruction-btn
        background-color: #b396ff
        height: 50px
        padding: 0 20px 0 20px
        line-height: 50px
        font-size: 14px
        font-weight: bolder
        color: #fff
        text-align: center
        position: absolute
        bottom: 20px
        left: 0
        cursor: pointer
        transition: all 0.2s ease-out
        &:hover
          padding: 0 30px 0 30px
        &:after
          content: ''
          position: absolute
          right: -10px
          top: 0
          background-image: url('../../../img/library/button-help@2x.png')
          background-repeat: no-repeat
          background-size: contain
          background-position: center right
          height: 50px
          width: 11px
      .read-btn
        position: absolute
        bottom: 20px
        right: 10px
        width: 140px
        height: 50px
        background-image: url('../../../img/library/button-h-50-orange-light-icon@2x.png')
        background-size: 100%
        background-repeat: no-repeat
        cursor: pointer
        &:hover
          opacity: 0.8
        p 
         position: absolute
         line-height:50px
         left:50px
         font-weight:700
         font-size:18px 
         color:#fff
      .record-btn 
        position: absolute
        right:160px 
        bottom: 20px 
        width: 140px 
        height: 50px 
        background-image: url('../../../img/library/dl-go-record-book-button.png')
        background-size: 100%
        background-repeat: no-repeat
        cursor: pointer
        &:hover
          opacity: 0.8
        p 
         position: absolute
         line-height 50px
         left:45px
         font-weight:700
         font-size:18px 
         color:#fff
      .guess-like-title
        position: absolute
        top: 27px
        right: -40px
        width: 208px
        height: 60px
        box-sizing: border-box
        background-image: url('../../../img/library/guesstips@2x.png')
        background-repeat: no-repeat
        background-size: 100%
        color: white
        font-size: 18px
        line-height: 59px
        padding: 0 0 0 20px
      .white-board
        position: absolute
        top: 27px
        left: 30px
        width: 608px
        height: 521px
        background-color: white
        border-radius: 20px
        padding: 30px 30px 30px 30px
        .favorite-btn-box
          position: absolute
          top: 20px
          right: 20px
          .favorite-btn
            width: 30px
            height: 25px
            background: url('../../../img/library/heart_sprite.png') no-repeat
            background-position: -32px 0
            background-size: 62px
            cursor: pointer
            &.liked
              background-position: 0 0
            
        .left
          display: inline-block
          vertical-align: top
          width: 27%
        .right
          display: inline-block
          vertical-align: top
          width: 73%
        .book-itself
          position: relative
          width: 130px
          height: 146px
          border-radius: 6px
          overflow: hidden
          img.book-mask
            position: absolute
            top: 0
            left: 0
            right: 0
            z-index: 2
            width: 100%
          img.book-face
            width: 100%
          img.book-label
            position: absolute
            top: 0px
            left: 5px
            width: 28px
            height: 24px
            z-index: 2
        .book-clickrate-wrap
          margin-top: 2px
          img.eye
            width: 20px
            margin-right: 5px
            display: inline-block
            vertical-align: middle
          span.clickrate
            display: inline-block
            vertical-align: middle
            font-size: 12px
            color: rgba(118, 89, 185, 0.8)
        .book-info-wrap
          margin-top: 21px
          h4
            font-size: 14px
            line-height: 1.14
            color: #787878
            font-weight: 400
          p
            font-size: 20px
            font-weight: 600
            color: #555555
            margin-bottom: 11px
            margin-top: 3px
        .book-content-wrap
          color: #555555
          h2
            font-size: 24px
            font-weight: 600
            margin-bottom: 10px
          .content-text
            font-size: 20px
            overflow-y: auto
            height: 352px
            &::-webkit-scrollbar
                border-radius: 29px
                width: 8px
                background-color: rgba(164, 135, 241, 0.2)
            &::-webkit-scrollbar-thumb
              border-radius: 29px
              width: 8px
              background-color: #b396ff
</style>


