<template lang="jade">
.library_home_bg
  .library_home_bg_star
    top-part(:title_cn = "title_chinese", :title_eng = "title_english", :isAbsoluteFix = "true",:gobackurl="'/'", :mark="'libarary_home'")
    .black-mirror(v-if="isGuideShow")
    img.bg-l-r.ani.slide-right(ref="lowerRightCloud", src="../../img/library/bg_lower_right.png", v-if="isShowInitAnimationThings")
    img.bg-l-l.ani.slide-left(ref="lowerLeftCloud", src="../../img/library/bg_lower_left.png", v-if="isShowInitAnimationThings")
    img.bg-l-m.ani.slide-bottom(ref="lowerMiddleCloud", src="../../img/library/bg_bottom_cloud.png", v-if="isShowInitAnimationThings")
    img.bg-m-l.ani.slide-left(ref="midLeftCloud", src="../../img/library/xmlid-383@2x.png", v-if="isShowInitAnimationThings")
    img.bg-m-r.ani.slide-right(ref="midRightCloud", src="../../img/library/xmlid-54@2x.png", v-if="isShowInitAnimationThings")
    my-dialog(:tipText="'1.宝贝可以同时借（最多）3个绘本；<br>2.每个绘本借阅的时间为14天，到期后绘本会自动归还哦。'", :type="'alert'", :cancelButton = "'知道了'", :title="'Notice'", isShowTitle = true, @library-dialog-cancel="cancelHowToBorrowDialog", v-if="isShowHowToBorrowDialog")
    my-dialog(:tipText="'网络有点问题，检查一下网络连接吧'", :confirmButton="'刷新页面'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-cancel="reloadPage", v-if="isBadNetworkAlertShow")
    stone(:showDreamEntry="showDreamEntry")
    //我的梦想绘本入口
    .my-dream-entry(v-if="showDreamEntry", @click.stop="goToDream")
      img(src="../../img/library/my-dream-entry@2x.png", class="my-dream-book")
      img(src="../../img/library/my-dream-bg-light@2x.png", class="my-dream-bg-light")
      .bubble-wrapper(:class="{'is-show-dream-entry-tip': isShowDreamEntryTip}", v-if="isShowDreamEntryTipApp") 点击录制宝贝梦想
    myBookButton
    .no-auth(v-if="isNoAuth")
      .text
        p 您好，数字图书馆的读物和课程内容相关，为使您获得更好
        p 的阅读体验，建议您先为宝贝报名课程，再进行阅览学习。
        p.bigger 如有任何问题，请致电95753
      img.no-auth-dino(src="../../img/digireader/empty_dino.png")
      vk-button(type="lg-enable",text="返回首页",:isNewTab="false",link="/")
    .smller-screen-control(v-else)
      .main-content-wrap.ani.aircraft-animation(ref="airCraft", v-if="isShowBookList")
        img.tail-cover(src="../../img/library/air_craft_tail_cover.png")
        .title-left 
          p {{recommendBooksColumName}}
        .title-right 
          p {{currLevelShowName}}
        .more-btn.left(@click.stop="goToLink('/digitalLibrary/bookList/3')") 更多
        .more-btn.right(@click.stop="goToLink('/digitalLibrary/bookList/all')") 更多
        .animated-star(ref="starBox")
          img.star_1(src="../../img/library/star_1.png")
          img.star_2(src="../../img/library/star_2.png")
          img.star_3(src="../../img/library/star_3.png")
          img.star_4(src="../../img/library/star_4.png")
          img.star_5(src="../../img/library/star_4.png")
        .lamp-light
          img.lamp(src="../../img/library/lamp@2x.png")
          img.light(ref="lightImg", src="../../img/library/lighting@2x.png")
        img.flower(src="../../img/library/flower@2x.png")

        .left-con 
          .book-item-box(v-for="item in originalBookList")
            bookItem(:bookDataProp = "item", :config = 'bookConfig', :mark = "'library_home_tsb'")
        .right-con
          .book-item-box(v-for="item in allBookList")
            bookItem(:bookDataProp = "item", :config = 'bookConfig', :mark = "'library_home_default'")
</template>
<script>
import axios from 'axios'
import cookies from 'cookies-js'
import TopPart from '../common/top_part.vue'
import myDialog from "./common/dialog.vue"
import Velocity from 'velocity-animate'
import bookItem from './component/book_list_item.vue'
import myBookButton from './component/top_right_button.vue'
import stone from './component/stone.vue'
import vkButton from "../common/vk_button.vue"
import {loadURL} from './libarary_utils.js'
import {localStorageUtil} from '../../utils/_untils.js'

export default {
  data: function() {
    return {
      isNoAuth: false,
      title_chinese: '',
      title_english: '',
      isGuideShow: false,
      isShowHowToBorrowDialog: false,
      recommendBooksColumName:'Teacher StoryBooks',
      cn: 'lc_dl_userguide_' + cookies.get('studentId'),
      pbData:{},
      voData:{},
      isShowBookList: false,
      isShowInitAnimationThings: false,
      bookData: {
        labelImgSrc: '',
        bookFaceImgSrc: 'https://teacher-media.vipkid.com.cn/resource/d0b5bd5f11ef452e85c9a7fd59db4f91.jpg',
        bookName: 'this is a brand new world with Kent',
        clickRate: 1233
      },
      bookConfig: {
        style: 1
      },
      allBookList: [],
      originalBookList: [],
      isBadNetworkAlertShow: false,
      currLevelShowName: 'level 1',
      currLevelTagName: '',
      //梦想绘本是否被展示
      showDreamEntry: false,
      //梦想绘本入口路由
      dreamEntryPatch: '',
      isShowDreamEntryTip: true,
      //是否显示梦想入口文本提示 app
      isShowDreamEntryTipApp: true
    }
  },
  components: {
    TopPart,
    myDialog,
    bookItem,
    myBookButton,
    vkButton,
    stone
  },
  beforeDestroy: function () {
    document.removeEventListener('mousemove', this.mouseMoveReaction)
    document.removeEventListener('mousemove', this.mouseMoveReaction, true)
  },
  mounted() {
    this.checkUserPay()
    this.checkDreamEntry()
    this.dreamEntryTipApp()
  },
  methods: {
    //梦想绘本入口提示 app下逻辑
    dreamEntryTipApp() {
      if (this.IS_IN_IPAD_APP) {
        //ipad
        this.isShowDreamEntryTip = false
        if (localStorageUtil.get('has-show-dream-entry-tip')) {
          this.isShowDreamEntryTipApp = false
        } else {
          this.isShowDreamEntryTipApp = true
          localStorageUtil.set('has-show-dream-entry-tip', 'show')
        }
      }
    },
    //跳转梦想绘本页
    goToDream() {
      if (this.dreamEntryPatch === '') {
        return
      }
      sa.track('learning_click', {'click_id': 'pc_learning_digital_library_home_enter_dream_book'})
      this.$router.push({path: this.dreamEntryPatch})
    },
    //检查梦想绘本入口
    checkDreamEntry() {
      axios.get(`/rest/learninggw/api/pc/service/digitlib/getDreamBookRouteInfo`, {
        params: {
          studentId: cookies.get("studentId")
        }
      }).then((res) => {
        if (res.data.code == 200) {
          if (res.data.data.isActivityOpen) {
            this.showDreamEntry = true
            this.dreamEntryPatch = `/digitalLibrary/detail/${res.data.data.dreamBookId}/${res.data.data.dreamBookCode}`
          } else {
            this.showDreamEntry = false
          }
        }
      }
      )
    },
    checkUserPay() {
      axios.get(`/rest/learninggw/api/pc/service/digitlib/${cookies.get("studentId")}/isPayUser`)
        .then((res) => {
          if (cookies.get('isFromApp')) {
            loadURL('vkappbridge://loading/stop') //停止ipad的loading界面
          }
          if (res.data.code == 200) {
            if (res.data.data) {
              this.isNoAuth = false
              this.getRecommendBookList()
              this.getCurrentLevel() //在此方法里面获取图书列表
              setTimeout(() => {
                this.isShowBookList = true
              }, 500)
              this.isShowInitAnimationThings = true
              this.initAnimation()
              return
            }
          }
          //如果接口失败或没有权限，走这里
          this.isFullPageLoadingShow = false
          this.isNoAuth = true
        }
        ).catch((error) => {
          this.isFullPageLoadingShow = false
          this.isNoAuth = true
        })
    },
    processLevelText( text ) {
      if(text == 'All levels') {
        return text
      } else {
        return 'Level ' + text.match(/\d/).toString()
      }
    },
    getCurrentLevel() {
      axios.get('/rest/learninggw/api/pc/service/digitlib/getCurrentLevel',{
        params: {
          studentId: cookies.get('studentId')
        }
      }).then((res) => {
        this.currLevelShowName = this.processLevelText(res.data.data.serialNumber) //当前level
        this.currLevelTagName = res.data.data.serialNumber
        this.getAllBookList()
      })
    },
    initAnimation() {
      //动画效果
      setTimeout(() => {
        this.$nextTick(() => {
          document.addEventListener('mousemove', this.mouseMoveReaction)
        })
      }, 800)
    },
    getAllBookList() {
      axios.get('/rest/learninggw/api/pc/service/digitlib/getBookList', {
        params: {
          tagNames: this.currLevelTagName,
          studentId: cookies.get('studentId'),
          limit: 6,
          start: 0,
          type: '' //表示选择全部type
        }
      }).then((res) => {
        for(let i = 0; i < res.data.data.books.length; i++) {
          this.allBookList.push(res.data.data.books[i])
        }
      })
    },
    getRecommendBookList() {
      axios.get('/rest/learninggw/api/pc/service/digitlib/recommendBooks', {
        params:{
          studentId: cookies.get('studentId'),
          limit: 2,
          start: 0
        }
      }).then((res) => {
        for(let i = 0; i < res.data.data.data.length; i++) {
          this.originalBookList.push(res.data.data.data[i])
        }
        if(res.data.data.data[0].type == 4){
          this.recommendBooksColumName = "Bob Books"
        } else 
          this.recommendBooksColumName = "Teacher StoryBooks"
      })
    },
    mouseMoveReaction(e) {
      let xpos = e.clientX
      let ypos = e.clientY

      let ax = -(window.innerWidth / 2 - xpos) / 80
      let ay = -(window.innerHeight / 2 - ypos) / 40
      let axLess = -(window.innerWidth / 2 - xpos) / 150
      let ayLess = -(window.innerHeight / 2 - ypos) / 90

      let lightAngle = -(window.innerHeight / 2 - ypos) / 100

      if(ax > 0 && ay > 0) {
        this.$refs.lowerRightCloud.style.transform = `translateX(${ax}px) translateY(${ay}px)`
      }
      if(ax < 0 && ay > 0 ) {
        this.$refs.lowerLeftCloud.style.transform = `translateX(${ax}px) translateY(${ay}px)`
      }
      this.$refs.airCraft.style.transform = `translateX(${axLess}px) translateY(${ayLess}px)`
      this.$refs.lowerMiddleCloud.style.transform = `translateX(${ax}px)`

      this.$refs.midLeftCloud.style.transform = `translateY(-${ay}px)`
      this.$refs.midRightCloud.style.transform = `translateY(-${ay}px)`
      this.$refs.lightImg.style.transform = `rotateZ(${lightAngle}deg)`
    },
    cancelHowToBorrowDialog() {
      this.isShowHowToBorrowDialog = !this.isShowHowToBorrowDialog
    },
    showHowToBorrowDialog() {
      this.isShowHowToBorrowDialog = true
    },
    goToLink(link) {
      if( link == '/digitalLibrary/bookList/3') {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_home_recommend_tsb_more'})
      } else {
        sa.track('learning_click', {'click_id': 'pc_learning_digital_library_home_recommend_default_more'})
      }
      this.$playSound("click")
      
      if(cookies.get('isFromApp') === '1'){ // 在ipad 端使用$router
        this.$router.push({path: link})
      }else{
        window.location.href = link
      }
     
    },
    loadURL(url) {
      var iFrame
      iFrame = document.createElement("iframe")
      iFrame.setAttribute("src", url)
      iFrame.setAttribute("style", "display:none;")
      document.body.appendChild(iFrame)
      //把它从dom上移除掉
      iFrame.parentNode.removeChild(iFrame)
      iFrame = null
    }
  }
}
</script>
<style lang="stylus" scoped>
*
  box-sizing: border-box
  -moz-user-select: none
  -webkit-user-select: none
  -ms-user-select: none
  -khtml-user-select: none
  user-select: none
  -webkit-font-smoothing: antialiased
  font-weight: 300
  -webkit-touch-callout: none
.smller-screen-control
  width: 100%
  height: 100%
  @media screen and (max-width: 1100px)
    transform: scale(0.9)
.ani
  animation-timing-function: ease-out
  animation-fill-mode: none
  
.slide-left
  animation-name: slideInLeft
  animation-duration: 1s
.slide-right
  animation-name: slideInRight
  animation-duration: 2s
.slide-lower-right
  animation-name: slideInLowerRight
  animation-duration: 3s
.slide-lower-left
  animation-name: slideInLowerLeft
  animation-duration: 2.5s
.slide-bottom
  animation-name: slideInBottom
  animation-duration: 1.5s
.library_home_bg
  background: #403e92; /* Old browsers */
  background: -moz-linear-gradient(top, #403e92 0%, #7190e0 100%); /* FF3.6-15 */
  background: -webkit-linear-gradient(top, #403e92 0%,#7190e0 100%); /* Chrome10-25,Safari5.1-6 */
  background: linear-gradient(to bottom, #403e92 0%,#7190e0 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
  // background-image: url('../../img/library/library_home_bg_color.png')
  background-size: 100% 100%
  perspective: 800px
  transform-style: preserve-3d
.library_home_bg_star
  position: absolute
  top: 0
  left: 0
  right: 0
  bottom: 0
  background-image: url('../../img/library/library_home_bg_stars.png')
  background-size: 100%
  
  .my-dream-entry
    position: absolute
    top: 24px
    right: 210px
    width: 60px
    height: 60px
    cursor: pointer
    animation: dreamMove 1.5s infinite
    animation-direction: alternate
    z-index: 12

    .my-dream-book
      display: block
      position: absolute
      top: 0
      left: 0
      z-index: 14

    .my-dream-bg-light
      display: block
      position: absolute
      top: 0
      left: 0
      animation: blurAnimate 1.5s infinite
      animation-direction: alternate
      z-index: 13

    .bubble-wrapper, .is-show-dream-entry-tip
      position: absolute
      box-sizing: border-box
      padding-top: 24px
      top: 60px
      left: -45px
      width: 150px
      height: 55px
      line-height: 20px
      text-align: center
      font-size: 14px
      color: #8F82BC
      background-image: url('../../img/library/my-dream-bubblebg@3x.png')
      background-size: 100%
      background-repeat: no-repeat
    .is-show-dream-entry-tip
      display: none
      opacity: 0
    &:hover .is-show-dream-entry-tip
      display: block
      animation: zoomIn 0.5s
      opacity: 1 

  .no-auth
    position: absolute
    top: 50%
    left: 50%
    width: 580px
    height: 546px
    margin: -228px 0 0 -293px
    text-align: center
    .no-auth-dino
      position: relative
      top: -12px
    .text
      font-size: 20px
      line-height: 1.5em
      color: #371575
      text-align: center
      font-weight: 400
      background-image: url('../../img/digireader/bg_tip.png')
      background-size: 100% 100%
      width: 580px
      height: 147px
      box-sizing: border-box
      padding: 20px 0 0 0

      p.bigger
        font-size: 24px
        font-weight: 800
  .black-mirror
    position: fixed
    top: 0
    bottom: 0
    left: 0
    right: 0
    background-color: rgba(0, 0, 0, 0.7)
    z-index: 11
  .bg-l-r
    width: 209px
    position: absolute
    right: 0
    bottom: 0
    transition: all 0.3s ease-out
    transform: translate3d(0,0, 0)
  .bg-l-l
    width: 242px
    position: absolute
    left: 0
    bottom: 0
    transition: all 0.3s ease-out
    transform: translate3d(0,0, 0)
  .bg-l-m
    width: 247px
    position: absolute
    left: 34%
    bottom: 0
    transition: all 0.3s ease-out
    transform: translate3d(0,0, 0)
  .bg-m-l
    width: 69px
    position: absolute
    left: 0
    top: 45%
    transition: all 0.3s ease-out
  .bg-m-r
    width: 160px
    position: absolute
    right: 0
    bottom: 30%
    transition: all 0.3s ease-out
  .main-content-wrap
    position: absolute
    background: url('../../img/library/airship.png') no-repeat
    background-repeat: no-repeat
    width: 996px
    height: 652px
    background-size: 100%
    top: 50%
    left: 50%
    margin: -326px 0 0 -498px
    transition: all 0.3s ease-out
    transform: translate3d(0, 0, 0)
    &.aircraft-animation
      animation-name: aircraftAnimation
      animation-duration: 0.5s
      animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000)
      .title-left
        position: absolute
        top: 84px
        left: 165px
        display: table
        p
          display: table-cell
          vertical-align: middle
          width: 129px
          height: 48px
          font-size: 14px
          font-weight: 600
          line-height: 1.14
          text-align: center
          color: #fff
      .title-right
        position: absolute
        top: 84px
        left: 375px
        display: table
        p
          display: table-cell
          vertical-align: middle
          width: 129px
          height: 48px
          font-size: 14px
          font-weight: 600
          line-height: 1.14
          text-align: center
          color: #fff
    .tail-cover
      width: 70px
      position: absolute
      top: 232px
      right: 34px
      z-index: 3
    .more-btn
      position: absolute
      background-image: url('../../img/library/more-button@2x.png')
      background-size: 100%
      background-repeat: no-repeat
      width: 92px
      height: 44px
      line-height: 44px
      text-align: center
      color: white
      font-size: 18px
      font-weight: 500
      cursor: pointer
      &:hover
        opacity: 0.9
      &.left
        bottom: 41px
        left: 184px
      &.right
        bottom: 41px
        right: 343px
    .animated-star
      position: absolute
      bottom: 1px
      right: 0px
      img.star_1
        position: absolute
        bottom: 183px
        right: -70px
        width: 48px
        animation: star_1_animation 1.2s
        animation-delay: 0.5s
        animation-fill-mode: both
      img.star_2
        position: absolute
        bottom: 159px
        right: -18px
        width: 41px
        animation: star_2_animation 1.5s
        animation-delay: 0.3s
        animation-fill-mode: both
      img.star_3
        position: absolute
        bottom: 223px
        right: -25px
        width: 31px
        animation: star_3_animation 1.4s
        animation-delay: 0.8s
        animation-fill-mode: both
      img.star_4
        position: absolute
        bottom: 120px
        right: -60px
        width: 25px
        animation: star_4_animation 1.2s
        animation-delay: 0.6s
        animation-fill-mode: both
      img.star_5
        position: absolute
        bottom: 284px
        right: -70px
        width: 25px
        animation: star_5_animation 1s
        animation-delay: 0.9s
        animation-fill-mode: both
    .lamp-light
      img.lamp
        position: absolute
        width: 83px
        bottom: 119px
        left: 35px
        z-index: 1
      img.light
        position: absolute
        width: 164px
        bottom: 111px
        left: -120px
        opacity: 0
        animation: lightAnimation 1.4s
        animation-delay: 1s
        animation-fill-mode: both
        transform-origin: right
    img.flower
      position: absolute
      width: 85px
      bottom: 25px
      right: 69px
      animation: flowerAnimation 1.4s
      animation-delay: 0.6s
      animation-fill-mode: both
      z-index: 3

    .left-con
      position: absolute
      top: 141px
      left: 132px
      width: 192px
      height: 431px
      .book-item-box
        width: 100%
        padding-left: 35px
      .book-item-box:nth-child(1)
        margin-bottom: 14px
        margin-top: 11px
    .right-con
      position: absolute
      top: 125px
      right: 134px
      width: 512px
      height: 461px
      padding: 30px 0 0 30px
      .book-item-box
        display: inline-block
        vertical-align: middle
        margin-bottom: 10px
        margin-right: 33px
      .book-item-box:nth-child(3n)
        margin-right: 0        
@keyframes aircraftAnimation
  from 
    opacity: 0
    transform: translate3d(3000px, 0, 0)
  60%
    opacity: 1
    transform: translate3d(-25px, 0, 0)
  75%
    transform: translate3d(10px, 0, 0)
  90%
    transform: translate3d(-5px, 0, 0)
  to
    transform: translate3d(0, 0, 0)

@keyframes slideInLeft
  from
    transform: translate3d(-300px, 0, 0)
  to
    transform: translate3d(0, 0, 0)
@keyframes slideInRight
  from
    transform: translate3d(300px, 0, 0)
  to
    transform: translate3d(0, 0, 0)
@keyframes slideInLowerRight
  from
    transform: translate3d(-300px, 200px, 0)
  to
    transform: translate3d(0, 0, 0)
@keyframes slideInLowerLeft
  from
    transform: translate3d(300px, 200px, 0)
  to
    transform: translate3d(0, 0, 0)
@keyframes slideInBottom
  from
    transform: translate3d(200px, 100px, 0)
  to
    transform: translate3d(0, 0, 0)
    

@keyframes lightAnimation
  0%
    opacity: 0
  20%
    opacity: 1
  40%
    opacity: 0
  60%
    opacity: 1
  80%
    opacity: 0
  100%
    opacity: 1

@keyframes flowerAnimation
  0%
    transform: rotateZ(0deg)
  100%
    transform: rotateZ(360deg)
@keyframes star_1_animation
  0%
    transform: translateX(-117px) rotateZ(0deg)
  100%
    transform: translateX(0) rotateZ(360deg)
@keyframes star_2_animation
  0%
    transform: translateX(-78px) rotateZ(0deg)
  100%
    transform: translateX(0) rotateZ(360deg)
@keyframes star_3_animation
  0%
    transform: translateX(-97px) rotateZ(0deg)
  100%
    transform: translateX(0) rotateZ(360deg)
@keyframes star_4_animation
  0%
    transform: translateX(-117px) rotateZ(0deg)
  100%
    transform: translateX(0) rotateZ(360deg)
@keyframes star_5_animation
  0%
    transform: translateX(-106px) rotateZ(0deg)
  100%
    transform: translateX(0) rotateZ(360deg)
@keyframes blurAnimate
  0%
    transform: scale(1, 1)
  100%
    transform: scale(1.05, 1.05)

@keyframes zoomIn
  from 
    opacity: 0
    transform: scale3d(.3, .3, .3)
  50%
    opacity: 1

@keyframes dreamMove
  0%
    transform: translateY(1px)
  100%
    transform: translateY(-1px)    
</style>


