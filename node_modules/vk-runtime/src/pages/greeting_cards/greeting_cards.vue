<template lang="jade">
    .greeting-cards-container
      //后退
      top-part(:isAbsoluteFix="true", :ifShow="false")
      //弹出层背景
      .greeting-cards-guide-mask(v-if="isShowUserGuideMask", @click="closeDialog")
      //中心背景区域
      .greeting-cards-center-bg
      //动画背景
      bg
      //发送成功前内容区域
      .greeting-cards-con(v-show="!isSucceed && !isLoadingList")
        //左侧内容区
        .greeting-cards-con-left-con(v-show="cardsList.length>0")
          .greeting-cards-con-left-con-top
            .select-teacher-btn(@click="openShow")
              .select-teacher-btn-con
                img.select-teacher-btn-img(v-if="selectedTeacherId<=0 || !selectedTeacher.avatar",src="../../img/greeting_cards/user_imag@2x.png")
                img.select-teacher-btn-img(v-if="selectedTeacherId>0 && selectedTeacher.avatar",:src="selectedTeacher.avatar")
                p.select-teacher-btn-text(:title="selectedTeacher.showName?selectedTeacher.showName:'选择老师'") {{selectedTeacher.showName?selectedTeacher.showName:'选择老师'}}
                .select-teacher-btn-icon
            .stone-con
              .stone-img 
              .stone-num-bg
                .stone-num-con(:title="availableNumber") {{availableNumber}}
            // 贺卡轮播和赠言
            cards-scroll(:cardsList="cardsList",@selectCardObj="selectCardObj",@givingCon="givingCon",:isSucceed="isSucceed")
          // 发送按钮
          img.greeting-cards-con-left-con-bottom(src="../../img/greeting_cards/send.png",@click="sendCard")
        // 右侧内容区
        .greeting-cards-con-right-con(v-show="cardsList.length>0")
          CardsPreview(:giving="giving",:selectedTeacher="selectedTeacher",:selectedCardObj="selectedCardObj",@setGrantStatus="setGrantStatus",:grantStatus="grantStatus",:grantStatsIng="grantStatsIng")
        // 收件箱按钮
        .greeting-cards-con-receiving(@click="mailbox")
          span.greeting-cards-con-receiving-num {{noReadNnumber}}
          img.greeting-cards-con-receiving-new(v-show="noReadNnumber",src="../../img/greeting_cards/new@2x.png")
        //贺卡规格说明
        .greeting-cards-con-rule-explain(@click="showExplain")
          .icon-secret
          .number 贺卡说明
        .cards-list-default(v-show="cardsList.length==0")
          span
            .cards-list-default-p
              p 没有可发送的贺卡，请联系工作人员～
        // 选择教师弹框
        .cards-select-teacher-con(v-if="isSecretDialogShow")
          .card-dialog-close-btn(@click="closeDialog")
          CardsSelectTeacher(:teacherList = "teacherList" , @selectTeacherId = "selectTeacherId",@getTeacherList="getTeacherList",:selectedTeacherId="selectedTeacherId",:pageNum="pageNum",:teacherTotalPages="teacherTotalPages",:isLoadingTeacher="isLoadingTeacher",:isReqSuccess="isListPageReqSuccess")
          .cards-select-teacher-btn(v-show="teacherList.length>0",:class="confrimFlag?'cards-select-teacher-confrim':'cards-select-teacher-cancle'",@click="confirmSelectTeacher") 确定
          .cards-select-teacher-btn.cards-select-teacher-confrim(v-show="teacherList.length<=0",@click="closeDialog") 确定
        MyDialog(:tipText="'能量石不够，快去积累能量石吧～'", :confirmButton="'确定'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-close ="closeAlertStone",@library-dialog-cancel="closeAlertStone", v-if="isEnough")
        MyDialog(:tipText="'使用贺卡将可能把您的个人信息，如姓名等公布给老师或第三方，请问是否确认授权使用贺卡？'", :confirmButton="'确定'", :type="'confirm'", title="Notice", isShowTitle = true,@library-dialog-close ="closeGrantStatus",@library-dialog-cancel="closeGrantStatus",@library-dialog-confirm="confirmGrantStatus", v-if="isGrantStatus")
        MyDialog(:tipText="errorCon", :confirmButton="'确定'", :type="'alert'", title="Notice", isShowTitle = true, @library-dialog-close ="closeAlert",@library-dialog-cancel="closeAlert", v-if="isBadNetworkAlertShow")
        MyDialog(:tipText="`还没有这张贺卡，是否花费<span>${selectedCardObj.eggshellNumber}</span>能量石购买？`", :confirmButton="'确定'", :type="'confirm'", title="精美贺卡兑换", isShowTitle = true, @library-dialog-close ="closeConfirm",@library-dialog-cancel="closeConfirm",@library-dialog-confirm="confirmBuy", v-if="isBuyAlertShow")
      
      // 发送成功后内容区域
      .greeting-cards-succeed(v-if="isSucceed && !isLoadingList")
        .greeting-cards-succeed-fume
          img.greeting-cards-succeed-fume-img(src="../../img/greeting_cards/fume.png")
        img.greeting-cards-succeed-rocket(src="../../img/greeting_cards/send_success1.png")
        p.greeting-cards-succeed-text 老师已收到～
        .greeting-cards-succeed-send
          img.greeting-cards-succeed-img(src="../../img/greeting_cards/send2.png",@click="sendContinue")
          .greeting-cards-succeed-exit
        // 收件箱按钮
        .greeting-cards-succeed-receiving(@click="mailbox")
          span.greeting-cards-succeed-receiving-num {{noReadNnumber}}
          img.greeting-cards-succeed-receiving-new(v-show="noReadNnumber",src="../../img/greeting_cards/new@2x.png")
      .loading(v-show="isLoadingList")
        img.loading-img(src="../../img/common/loading.gif")
      vkDialogExplain(:showDialog="isShowExplain", @closeIt="isShowExplain = false", :titleImg="titleImg", :titleArr="titleArr", :textArr="textArr", :declare="declare")
</template>
<script>
import axios from 'axios'
import formUrlEncoded from 'form-urlencoded'
import cookies from 'cookies-js'
import number from '../common/vk_number.vue'
import utils from '../../utils/_untils'
import dragonUtils from '../../utils/_dragon.js'

import TopPart from "../common/top_part.vue"
import bg from "./components/bg.vue"
import CardsScroll from "./components/cards_scroll.vue"
import CardsPreview from "./components/cards_preview.vue"
import CardsSelectTeacher from "./components/cards_select_teacher.vue"
import MyDialog from "./components/cards_dialog.vue"
import vkDialogExplain from '../common/vk_dialog_explain.vue'
export default {
  data() {
    return {
      isShowUserGuideMask: false, // 半透明黑色蒙层，每次弹框需开启
      isFullPageLoadingShow: true, // loading遮挡层
      isSecretDialogShow: false ,// 选择教师弹框
      isBadNetworkAlertShow: false, // 发送失败弹框
      isBuyAlertShow: false, // 购买贺卡弹框
      isEnough: false, // 能量石不足弹框
      isGrantStatus: false,// 授权弹框
      isSucceed: false, // 是否发送成功
      isShowExplain: false, //是否展示贺卡说明
      teacherList: [], // 教师列表
      availableNumber: 0, // 能量石数量
      noReadNnumber: 0, // 未读数量 
      grantStatus: "CANCEL_GRANT" ,// 获取是否授权
      selectedTeacherId: 0, // 选中教师的ID
      selectedTeacher: {},// 选中教师
      startSelectTeacher: {},// 记录原始选中教师
      selectedCardObj: {},// 选中贺卡
      startSelectedCardObj: {},// 记录原始贺卡
      confrimFlag: false,// 是否有效状态
      isSending: false,// 发送状态
      cardsList: [],// 贺卡列表
      giving: "",// 赠言
      grantStatsIng: false,// 是否正在操作授权
      errorCon: "贺卡发送失败，请检查网络连接",// 错误码提示
      isLoading: false,// 加载状态
      isLoadingList: false, // 贺卡列表加载状态
      isListPageReqSuccess:true, // 教师列表加载是否成功
      isShopOrderMessage: {
        "499":"商品已下架",
        "498":"商品库存不足",
        "497":"商品库存不足或已下架，<br>再看看其他商品",
        "496":"请选择商品",
        "495":"非法订单",
        "494":"蛋壳数目不足，无法以兑换商品",
        "491":"学生蛋壳扣减失败",
        "490":"蛋壳扣减流水插入失败",
        "489":"订单商品批量插入失败",
        "488":"订单创建失败",
        "487":"商品库存扣减失败",
        "486":"一定时间内兑换商品超过限制数量",
        "485":"您的下单次数过于频繁，请稍后再试",
        "484":"学生或家长非法",
        "483":"肥料总数超过上限，无法兑换",
        "482":"收货地址不完整，请补全!"
      },
      sendMessage: {
        "1000000":"电子贺卡错误",
        "1000001":"电子贺卡已经下架",
        "1000002":"此贺卡免费次数已用完",
        "1000003":"该收费的电子贺卡账户余额不足，<br>请先下单购买",
        "1000004":"非法电子贺卡消息收发类型",
        "1000005":"电子贺卡消息只能回复一次",
        "1000006":"电子贺卡发送失败",
        "1000007":"您的输入消息含有不当内容",
        "1000008":"获取学生信息异常",
        "1000009":"老师不存在或获取老师信息异常",
        "1000010":"请先授权右下角的法务提醒",
        "1002000":"表单重复提交"
      },
      teacherIdReply: this.$route.params.teacherId ? parseInt(this.$route.params.teacherId) : 0,
      teacherInfoReply:{},
      pageNum: 0,
      teacherTotalPages: 0,// 教师列表的总页数
      isLoadingTeacher: false,// 教师列表是否正在加载中
      titleImg: require('../../img/greeting_cards/card_direction_title@2x.png'),
      titleArr: ["贺卡发送","贺卡回复"],
      textArr: [
        '1，每次给老师发送贺卡时，都要消耗一张当前选择的贺卡。 <br>2，发送贺卡时的赠言可以使用已有的模版赠言，也可以自己编辑赠言。<br>3，贺卡发送后可能把您的个人信息，如姓名等公布给老师或第三方，所以在发送前需要授权使用贺卡，未授权时无法发送。<br><br>',
        '1，您可以回复老师主动发送给您的贺卡，回复贺卡也会消耗一张当前选择的贺卡，也需授权使用贺卡。 <br>2，您主动给老师发送贺卡后，老师回复给您的回信贺卡不能直接回复，此时您可以选择新发送一张贺卡给老师以保持联系。<br><br>'   
      ],
      declare: "1，VIPKID有权在法律许可的范围内调整贺卡相关规则，并拥有最终解释权。 <br>2，如果用户对规则说明或在使用VIPKID软件或相关服务过程中有任何疑问或需要任何帮助，请及时与VIPKID客服联系，联系电话：95753。"
    }
  },
  components: {
    TopPart,
    bg,
    CardsScroll,
    CardsPreview,
    CardsSelectTeacher,
    MyDialog,
    vkDialogExplain
  },
  methods: {
    //展示贺卡说明
    showExplain() {
      this.isShowExplain = true
    },
    closeDialog(opt) {
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isSecretDialogShow = false
      this.isBadNetworkAlertShow = false
      this.isBuyAlertShow = false
      this.isGrantStatus = false
      this.isEnough = false
      if(this.selectedTeacherId <= 0){
        this.confrimFlag = false
      }
    },
    // 点击（教师按钮）选择老师
    openShow() {
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isSecretDialogShow = true
      sa.track('learning_click', {
        'click_id': 'pc_learning_greeting_cards_select_teacher'
      })
    },
    // 发送失败弹框-确定按钮
    closeAlert() {
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isBadNetworkAlertShow = false
    },
    // 能量石不足弹框-确定按钮
    closeAlertStone() {
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isEnough = false
    },
    // 关闭确认是否购买
    closeConfirm(){
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isBuyAlertShow = false
    },
    // 关闭授权弹框
    closeGrantStatus(){
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isGrantStatus = false
      sa.track('learning_click', {
        'click_id': 'pc_learning_greeting_cards_frame_set_grant_cancel'
      })
    },
    // 确定购买
    confirmBuy(){
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isBuyAlertShow = false
      this.buyStone()
    },
    // 确定授权
    confirmGrantStatus(){
      this.isShowUserGuideMask = !this.isShowUserGuideMask
      this.isGrantStatus = false
      this.grantStatus = "GRANTED"
      this.setGrantOrCancel()
      sa.track('learning_click', {
        'click_id': 'pc_learning_greeting_cards_frame_set_grant_confirm'
      })
    },
    // 购买 TODO：更改api 前缀
    buyStone(){
      let parentId = cookies.get('parentId')
      let isPad = cookies.get("isFromApp")
      if (isPad) {
        parentId = cookies.get('mbparentid')
      }
      let stonebodymsg = JSON.stringify({
        studentId: cookies.get("studentId"),
        parentId: parentId,
        eshopGoodsList: [
          {
            eshopGoodsId: this.selectedCardObj.eshopGoodsId,
            eshopGoodsCount: 1
          }
        ]
      })
      sa.track('learning_click', {
        'error_url': "/rest/learninggw/api/pc/eshop/order/createEshopOrder" + stonebodymsg
      })
      axios.post("/rest/learninggw/api/pc/eshop/order/createEshopOrder", JSON.stringify({
        studentId: cookies.get("studentId"),
        parentId: parentId,
        eshopGoodsList: [
          {
            eshopGoodsId: this.selectedCardObj.eshopGoodsId,
            eshopGoodsCount: 1
          }
        ]
      }),{ headers: { "Content-Type": "application/json" } }).then(res => {
        sa.track('learning_click', {
          'error_url': "/rest/learninggw/api/pc/eshop/order/createEshopOrder" + stonebodymsg,
          'error_msg': JSON.stringify(res.data)
        })
        if(res.data.code == 200){
          this.sendCon()
          this.getCardsList(false)
          this.getStoneNumber()
        }else{
          let messge = this.isShopOrderMessage[res.data.code]
          if(messge){
            this.$showToast(messge)
          }else{
            this.$showToast("购买失败:"+res.data.code)
          }
        }
      }).catch((err) => {
        sa.track('learning_click', {
          'error_url': "/rest/learninggw/api/pc/eshop/order/createEshopOrder" + stonebodymsg,
          'error_msg': JSON.stringify(err.response.data)
        })
        this.$showToast("购买失败了")
      })
    },
    // 发送内容
    sendCon(){
      this.isSending = true
      let messageType = "STUDENT_TO_TEACHER"
      let replyId = 0
      let from = "OTHER"
      if((this.teacherIdReply == this.selectedTeacher.id)&& this.$route.params.cardId ){
        messageType = "STUDENT_REPLY_TEACHER"
        replyId = this.$route.params.cardId
      }else{
        messageType = "STUDENT_TO_TEACHER"
        replyId = 0
      }
      // 判断使用平台，
      if(dragonUtils.isOnDragonClient()) {
        from = "PC"
        // 客户端
      } else if(cookies.get('isFromApp')){
        from = "iPad"
      } else {
        //在pc端
        from = "PC"
      }

      let bodymsg = JSON.stringify({ 
        studentId: cookies.get("studentId"),
        teacherId: this.selectedTeacher.id,
        teacherName: this.selectedTeacher.showName,
        messageType: messageType,
        deviceType: from,
        egreetingCardId: this.selectedCardObj.id,
        cardName: this.selectedCardObj.name,
        replyId: replyId
      })
      sa.track('learning_click', {
        'error_url': "/rest/learninggw/api/point/egreetingCardSendReceive/send" + bodymsg
      })
      
      // 发送贺卡
      axios.post("/rest/learninggw/api/point/egreetingCardSendReceive/send",JSON.stringify({ 
        studentId: cookies.get("studentId"),
        teacherId: this.selectedTeacher.id,
        teacherName: this.selectedTeacher.showName,
        teacherAvatar: this.selectedTeacher.avatar,
        messageType: messageType,
        deviceType: from,
        egreetingCardId: this.selectedCardObj.id,
        cardName: this.selectedCardObj.name,
        cardWord: this.giving,
        cardImg: this.selectedCardObj.cardImg,
        cardIcon: this.selectedCardObj.cardIcon,
        replyId: replyId
      }),
      { headers: { "Content-Type": "application/json" } }).then(res => {
        sa.track('learning_click', {
          'error_url': "/rest/learninggw/api/point/egreetingCardSendReceive/send" + bodymsg,
          'error_msg': JSON.stringify(res.data)
        })
        if(res.data.code == 200){
          this.sendSucceed()
          this.getCardsList(false)
        }else{
          let messge = this.sendMessage[res.data.code]
          if(messge){
            this.$showToast(messge)
          }else{
            this.$showToast("发送失败:"+res.data.code)
          }
        }
        this.isSending = false
      }).catch((err) => {
        sa.track('learning_click', {
          'error_url': "/rest/learninggw/api/point/egreetingCardSendReceive/send" + bodymsg,
          'error_msg': JSON.stringify(err.response.data)
        })
        this.isSending = false
        this.$showToast("发送失败了")
      })
    },
    // 发送成功
    sendSucceed(){
      this.isSucceed = true
      this.selectedTeacherId = 0
      this.selectedTeacher = {}
      this.selectedCardObj = {}
      this.confrimFlag = false
    },
    // 继续发送
    sendContinue(){
      this.isSucceed = false
      this.$router.push({path: "/greeting_cards"})
    },
    // 确定选中教师
    confirmSelectTeacher(){
      if(this.confrimFlag){
        this.selectedTeacherId = this.startSelectTeacher.id 
        this.selectedTeacher= this.startSelectTeacher
        this.closeDialog()
      }
    },
    // 跳转信箱
    mailbox(){
      sa.track('learning_click', {
        'click_id': 'pc_learning_greeting_cards_set_grant_mailbox'
      })
      this.$router.push("/cards_info_list")
    },
    //获取教师列表 
    //这里的pageNum后端默认是从0开始
    getTeacherList(cb) {
      if((this.teacherTotalPages == 0) || (this.pageNum < this.teacherTotalPages)) {
        this.isLoadingTeacher = true
        axios.get("/rest/learninggw/api/point/teacher/listPage",{
          params: {
            studentId: cookies.get('studentId'),
            pageNum: this.pageNum,
            pageSize: 30
          }
        }).then(res=>{
          if(res.data.code == 200){
            let dataObj = res.data.data
            if(dataObj && dataObj.data){ // 教师列表数据有返回值
              this.teacherTotalPages = dataObj.totalPages 
              if(this.teacherIdReply){ // 回复老师贺卡
                let teachers = dataObj.data.filter(v=>{
                  return this.teacherIdReply != parseInt(v.id)
                })
                this.teacherList = this.teacherList.concat(teachers)
                // 老师信息放到列表第一项
                if(this.pageNum==0){
                  this.teacherList.unshift(this.teacherInfoReply)
                }
                this.confrimFlag = true
                
              }else{ // 主动给老师发送贺卡
                this.teacherList = this.teacherList.concat(dataObj.data)
              }
            }else{ // 教师列表没有返回值
              if(this.teacherIdReply && this.pageNum==0){ 
                this.teacherList.unshift(this.teacherInfoReply)
                this.confrimFlag = true
              }
            }
            this.isListPageReqSuccess = true
          }else{
            this.$showToast('获取教师列表失败<br>请检查网络~')
            this.isListPageReqSuccess = false
          }
          cb && cb(true)
          this.pageNum++
          this.isLoadingTeacher = false
        }).catch(v=>{
          this.$showToast('获取教师列表失败<br>请检查网络~')
          this.isLoadingTeacher = false
          this.isListPageReqSuccess = false
        })
      }
    },
    // 获取能量石数量
    getStoneNumber(){
      axios.get("/rest/learninggw/api/pc/magic/eggshell/getByStudentId", {
        params: {
          studentId: cookies.get('studentId')
        }
      }).then(res => {
        if(res.data.code == 200){
          this.availableNumber = res.data.data.availableNumber
        }else{
          this.$showToast('获取能量石失败<br>请检查网络~')
        }
      }).catch(v => {
        this.$showToast('获取能量石失败<br>请检查网络~')
      })
    },
    // 获取未读取数量
    getNoReadNumber(){
      axios.get("/rest/learninggw/api/point/egreetingCardSendReceive/getUnReadCount", {
        params: {
          studentId: cookies.get('studentId')
        }
      }).then(res => {
        if(res.data.code == 200){
          this.noReadNnumber = res.data.data
        }else{
          this.$showToast('获取未读取贺卡数量失败<br>请检查网络~')
        }
      }).catch(v => {
        this.$showToast('获取未读取贺卡数量失败<br>请检查网络~')
      })
    },
    // 是否授权
    getGrantStatus(){
      axios.get("/rest/learninggw/api/point/egreetingCard/grant/getGrantStatus", {
        params: {
          studentId: cookies.get('studentId')
        }
      }).then(res => {
        if(res.data.code == 200){
          this.grantStatus = res.data.data.status
        }else{
          this.$showToast('获取授权状态失败<br>请检查网络~')
        }
      }).catch(v=>{
        this.$showToast('获取授权状态失败<br>请检查网络~')
      })
    },
    // 设置授权/取消授权
    setGrantOrCancel() {
      if(this.grantStatsIng == true){
        return
      }
      this.grantStatsIng = true
      axios.post("/rest/learninggw/api/point/egreetingCard/grant/grantOrCancel", formUrlEncoded({
        studentId: cookies.get("studentId"),
        status: this.grantStatus
      })).then(res => {
        if(res.data.code != 200){
          if(this.grantStatus == "GRANTED"){
            this.grantStatus = "CANCEL_GRANT"
          }else{
            this.grantStatus = "GRANTED"
          }

          if(res.data.code == 1003000){
            this.$showToast("请不要频繁操作授权")
          }else{
            this.$showToast("操作失败了")
          }
        }
        this.grantStatsIng = false
      }).catch(() => {
        if(this.grantStatus == "GRANTED"){
          this.grantStatus = "CANCEL_GRANT"
        }else{
          this.grantStatus = "GRANTED"
        }
        this.grantStatsIng = false
        this.$showToast("操作失败了")
      })
    },
    // 获取贺卡列表
    getCardsList(show = true){
      if(show){
        this.isLoadingList = true
      }
      axios.get("/rest/learninggw/api/point/egreetingCard/list", {
        params: {
          studentId: cookies.get('studentId')
        }
      }).then(res => {
        if(res.data.code == 200){
          if (res.data.data.data && res.data.data.data.length > 0) {
            this.cardsList = res.data.data.data.filter(v => {
              return v.eggshellNumber > 0 || v.availableCount > 0
            })
          }
        }else{
          this.$showToast('获取贺卡列表失败<br>请检查网络~')
        }
        this.isLoadingList = false
      }).catch(v=>{
        this.$showToast('获取贺卡列表失败<br>请检查网络~')
      })
    },
    // 获取字符长度
    getBLen(str) {
      if (str == null) return 0
      else if (typeof str != "string"){
        str += ""
      }
      return Math.floor(str.replace(/[^\x00-\xff]/g,"01").length/2)
    },
    // 点击获取选中教师
    selectTeacherId(obj){
      this.startSelectTeacher= obj
      this.confrimFlag = true
    },
    // 点击获取选中贺卡
    selectCardObj(idObj){
      this.selectedCardObj = idObj
    },
    // 赠言
    givingCon(msg){
      this.giving = msg.con
    },
    // 设置授权/取消授权
    setGrantStatus(msg){
      if(msg.isChecked == "GRANTED"){
        this.grantStatus = "GRANTED"
        sa.track('learning_click', {
          'click_id': 'pc_learning_greeting_cards_set_grant_cranted'
        })
      }else if(msg.isChecked == "CANCEL_GRANT"){
        this.grantStatus = "CANCEL_GRANT"
        sa.track('learning_click', {
          'click_id': 'pc_learning_greeting_cards_set_grant_cancel'
        })
      }
      this.setGrantOrCancel()
    },
    // 发送贺卡
    sendCard(){
      if(this.isSending){
        return
      }
      sa.track('learning_click', {
        'click_id': 'pc_learning_greeting_cards_send'
      })
      let length = this.getBLen(this.giving)
      if(!this.selectedCardObj.id){
        this.$showToast('请选择贺卡')
        return
      }else if(!this.selectedTeacher.id){
        this.isShowUserGuideMask = !this.isShowUserGuideMask
        this.isSecretDialogShow = true
        return
      }else if(!this.giving){
        this.$showToast('请填写赠言')
        return
      }else if(length >100){
        this.$showToast('赠言字数过多')
        return
      }else if(this.grantStatsIng === true){
        this.$showToast("授权操作请求还未完成，请稍等再点击《发送》按钮")
        return
      }else if(this.grantStatus == "CANCEL_GRANT"){ // 检查授权状态
        this.isShowUserGuideMask = true
        this.isGrantStatus = true
        return
      }
      // 能量石不足且没有剩余卡数
      if(this.selectedCardObj.eggshellNumber > this.availableNumber && !this.selectedCardObj.availableCount){
        this.isShowUserGuideMask = true
        this.isEnough = true
        sa.track('learning_click', {
          'click_id': 'pc_learning_greeting_cards_stone_enough'
        })
        return
      }
      // 是否购买
      if((this.selectedCardObj.eggshellNumber > 0)&& !this.selectedCardObj.availableCount){
        this.isShowUserGuideMask = true
        this.isBuyAlertShow = true
      }else{
        // 免费 直接发送
        this.sendCon()
      }
    },
    // 获取教师信息--用于回复老师贺卡
    getTeacherInfo(cb){
      axios.get("/rest/learninggw/api/point/teacher/detail", {
        params: {
          teacherId: this.teacherIdReply
        }
      }).then(res => {
        if (res.data.code == 200) {
          this.teacherInfoReply = res.data.data
          this.selectedTeacher = res.data.data
          this.startSelectTeacher = res.data.data
          this.selectedTeacherId = this.selectedTeacher.id
          cb()
        } else {
          this.$showToast('获取教师信息不全')
        }
      }).catch(v=>{
        this.$showToast('获取教师信息失败<br>请检查网络~')
      })
    }
  },
  created(){
    // 获取贺卡列表
    this.getCardsList()
    // 获取未读取信数量
    this.getNoReadNumber()
    // 获取能量石数量
    this.getStoneNumber() 
    // 是否授权
    this.getGrantStatus()
    // 如果回复贺卡时教师id大于0，就获取教师信息
    if(this.teacherIdReply){
      this.getTeacherInfo(this.getTeacherList)
    }else{
      // 获取教师列表
      this.getTeacherList()
    }
  }
}

</script>

<style lang="stylus" scoped>
.greeting-cards-container
  position: absolute
  top: 0
  left: 0
  right: 0
  bottom: 0
  width: 100%
  height: 100%
  overflow: hidden
  background-image: url('../../img/greeting_cards/bg_send_big.png')
  background-size: 100% 100%
  @media screen and (min-width: 1920px)
    background-image: url('../../img/greeting_cards/bg_1920.png')
  // 中间背景
  .greeting-cards-center-bg
    position: absolute
    left: 50%
    top: 50%
    width: 1164px
    height: 500px
    margin-left: -582px
    margin-top: -285px
    background: url('../../img/greeting_cards/card_bg_small.png') center no-repeat
    background-size: 100% 100%
    @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
      background-size: 96% 100%
  // 发送成功前中间内容区
  .greeting-cards-con 
    position: absolute
    left: 50%
    top: 50%
    width: 1041px
    height: 565px
    margin-left: -520px
    margin-top: -240px
      // 左侧内容区
      .greeting-cards-con-left-con 
        float: left
        width: 650px
        height: 565px
        margin: 0
        .greeting-cards-con-left-con-top 
            width: 650px
            height: 418px
            background-image: url('../../img/greeting_cards/left-con-bg.png')
            background-size: 100%
            // 老师选择按钮
            .select-teacher-btn 
              display: inline-block
              float: left
              width: auto
              height: 60px
              margin-left: -55px
              background: url('../../img/greeting_cards/teacher_left.png') left no-repeat
              background-size: contain
              cursor: pointer
              .select-teacher-btn-con
                display: inline-block
                float: left
                height: 60px
                max-width: 310px
                background: rgba(246, 247, 245,0.1)
                border-radius: 0 30px 30px 0
                margin-left: 55px
                .select-teacher-btn-img 
                  display: inline-block
                  float: left
                  width: 50px
                  height: 50px
                  margin: 5px 10px 5px 15px
                  border-radius: 50%
                .select-teacher-btn-text 
                  display: inline-block
                  float: left
                  height: 60px
                  max-width: 200px
                  overflow: hidden
                  line-height: 60px
                  font-size: 24px
                  color: #fff
                  text-overflow: ellipsis
                  white-space: nowrap
                .select-teacher-btn-icon
                  display: inline-block
                  float: left
                  width: 15px
                  height: 12px
                  margin: 26px 8px 22px 8px
                  background-image: url('../../img/greeting_cards/select_bg.png')
                  background-size: 100%
            // 能量石数量
            .stone-con 
              display: inline-block
              position: relative
              float: right
              width: auto
              height: 36px
              margin: 20px
              .stone-img 
                position: absolute
                left: -15px
                top: -5px
                width: 36px
                height: 36px
                background-image: url('../../img/greeting_cards/stone.png')
                background-size: 100%
              .stone-num-bg 
                width: auto
                height: 26px
                background: rgba(255, 255, 255, 0.2)
                border-radius: 35px
                .stone-num-con 
                  min-width: 50px
                  max-width: 117px
                  height: 26px
                  overflow: hidden
                  line-height: 26px
                  margin-left: 20px
                  margin-right: 10px
                  text-align: center
                  font-size: 14px
                  color: #fff
                  text-overflow: ellipsis
                  white-space: nowrap
                // 筛选类型
            .select-type 
              clear: both
              width: 560px
              height: 36px
              padding: 0 45px
              .select-type-con 
                display: inline-block
                float: left
                width: 85px
                height: 36px
                line-height: 36px
                margin-right: 10px
                text-align: center
                font-size: 20px
                color: #fff
                background: #9b06ef
                border-radius: 20px
                cursor: pointer
        .greeting-cards-con-left-con-bottom 
          width: 228px
          height: 117px
          margin: 27px 211px
          cursor: pointer
      // 右侧内容区
      .greeting-cards-con-right-con 
        display: inline-block
        float: left
        width: 375px
        height: 565px
        margin-left: 16px
      .greeting-cards-con-receiving 
        position: absolute
        right: 130px
        top: -120px
        width: 198px
        height: 59px
        background-image: url('../../img/greeting_cards/receiving.png')
        background-size: 100% 100%
        line-height: 59px
        color: #fff
        font-size: 18px
        cursor: pointer
        @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
          right: 140px
        .greeting-cards-con-receiving-num 
          margin-left: 120px
        .greeting-cards-con-receiving-new 
          position: absolute
          top: -7px
          right: 80px
          width: 46px
          height: 20px
          animation: scaleNew 1.5s infinite
          @keyframes scaleNew 
            0% 
              transform: rotate(0deg)
              transform-origin: top center
            25% 
              transform: rotate(20deg)
              transform-origin: top center
            75% 
              transform: rotate(0deg)
              transform-origin: top center
            100% 
             transform: rotate(-20deg)
             transform-origin: top center
      .greeting-cards-con-rule-explain
        position: absolute
        right: -58px
        top: -114px
        width: 170px
        height: 45px
        color: #fff
        background-color: #8e66b3
        border-radius: 35px
        cursor: pointer
        @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
          right: -40px
        .icon-secret
          position: absolute
          display: inline-block
          width: 59px
          height: 59px
          top: -6px
          left: -3px
          background: url("../../img/gift/secret.png") no-repeat
          background-size: 100% 100%
        .number
          position: relative
          display: inline-block
          line-height: 45px
          left: 77px
      .cards-list-default
        position: absolute
        width: 500px
        height: 300px
        top: 50px
        left: 50%
        margin-left: -250px
        span
          display: block
          width: 252px
          height: 180px
          background: url("../../img/greeting_cards/none.png")
          background-size: 100% 100%
          margin: 50px auto 0 auto
        .cards-list-default-p
          position: absolute
          left: 0
          top: 250px
          bottom: 40px
          width: 100%
          color: #fff
          font-size: 20px
          p
            color: #fff
            font-size: 18px
            line-height: 24px
            text-align: center
        // 选择教师弹框
      .cards-select-teacher-con
        position: absolute
        z-index: 22
        top: -50px
        left: 50%
        width: 810px
        height: 510px
        background: rgba(161, 142, 227, 1)
        box-shadow: 3px 2px 14px 0px rgba(55, 24, 92, 1)
        border-radius: 18px
        margin-left: -405px
        .card-dialog-close-btn
          position: absolute
          top: -10px
          right: -10px
          width: 40px
          height: 40px
          background-image: url('../../img/greeting_cards/closed.png')
          background-repeat: no-repeat
          background-position: 0 0
          background-size: 100%
          cursor: pointer
        .cards-select-teacher-btn
          position: absolute
          top: 420px
          left: 50%
          width: 150px
          height: 50px
          line-height: 50px
          margin-left: -75px
          background-size: 100% 100%
          text-align: center
          color: #fff
          cursor: pointer
        .cards-select-teacher-confrim
          background: url('../../img/greeting_cards/btn150.png') top no-repeat
          &:hover
            opacity: 0.7
        .cards-select-teacher-cancle
          background: url('../../img/greeting_cards/cancle.png') top no-repeat
  // 发送成功后内容区域
  .greeting-cards-succeed
    position: absolute
    left: 50%
    top: 50%
    width: 1041px
    height: 505px
    margin-left: -520px
    margin-top: -300px
    .greeting-cards-succeed-fume
      display: inline-block
      position: absolute
      left: 50%
      width: 732px
      height: 217px
      margin-left: -366px
      margin-top: 126px
      overflow: hidden
      animation: fume .4s ease .2s 1 both
      @keyframes fume
        from
          top: 60%
          transform: scale(0) 
          opacity: 0
        to
          top: 30%
          transform: scale(1) 
          opacity: .8
      .greeting-cards-succeed-fume-img
         width: 732px
         height: 217px
         margin-left: 5px
         animation: fumeImg 900ms infinite
         @keyframes fumeImg
            0%
              transform: scale(1)  
            25%
              transform: scale(1.01)
            50%
              transform: scale(1)
            75%
              transform: scale(1.01)
    .greeting-cards-succeed-rocket
      display: inline-block
      position: absolute
      left: 50%
      width: 152px
      height: 258px
      margin-left: -76px
      animation: fadeOutUp .4s ease .1s 1 both
      @keyframes fadeOutUp
        from
          top: 70%
          opacity: 1
        to
          top: 25%
          opacity: 1
    .greeting-cards-succeed-text
      display: inline-block
      position: absolute
      left: 50%
      width: 192px
      height: 45px
      line-height: 45px
      margin-left: -97px
      margin-top: -15px
      font-size: 32px
      color: rgba(255,255,255,1)
      animation: fadeOutUpText .4s ease .3s 1 both
      @keyframes fadeOutUpText
        from
          top: 100%
          opacity: 0
        to
          top: 15%
          opacity: 1
    .greeting-cards-succeed-send
      width: 100%
      height: 117px
      margin-top: 505px
      .greeting-cards-succeed-img
        display: inline-block
        float: left
        width: 228px
        height: 117px
        margin-left: 211px
        cursor: pointer
      .greeting-cards-succeed-exit
        display: inline-block
        float: right 
        width: 390px
        height: 26px
        margin-right:-9px 
        margin-top: 65px
        background: url('../../img/greeting_cards/exit_bg.png') bottom right no-repeat
    .greeting-cards-succeed-receiving 
      position: absolute
      right: -58px
      top: -70px
      width: 198px
      height: 59px
      background-image: url('../../img/greeting_cards/receiving.png')
      background-size: 100% 100%
      line-height: 59px
      color: #fff
      font-size: 18px
      cursor: pointer
      @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
        right: -40px
      .greeting-cards-succeed-receiving-num 
        margin-left: 120px
      .greeting-cards-succeed-receiving-new 
        position: absolute
        top: -7px
        right: 80px
        width: 46px
        height: 20px
        animation: newSucceed 1.5s infinite
        @keyframes newSucceed 
          0% 
            transform: rotate(0deg)
            transform-origin: top center
          25% 
            transform: rotate(20deg)
            transform-origin: top center
          75% 
            transform: rotate(0deg)
            transform-origin: top center
          100% 
            transform: rotate(-20deg)
            transform-origin: top center
  .loading
    display: inline-block
    position: absolute
    width: 1124px
    height: 460px
    left: 50%
    top: 50%
    border-radius: 42px
    margin-top: -265px
    margin-left: -562px
    background: rgba(23, 2, 62, 0.85)
    text-align: center
    @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
      width: 1078px
      margin-left: -540px
    .loading-img
      width: 240px
      height: 240px
      margin-top: 120px
// 弹出层背景
.greeting-cards-guide-mask
  width: 100%
  height: 100%
  position: fixed
  top: 0
  left: 0
  right: 0
  bottom: 0
  background: #000
  background-color: rgba(0, 0, 0, 0.6)
  z-index: 10

.greeting-cards-stone-color
  color:#FF5800
</style>