<template lang="jade">
  .cards
    // 贺卡列表
    .cards-list
      .cards-container
        .card-list-content#card-list-content(ref="islandWrapper") 
          .card-list-long#card-list-long(ref="cardList")
            .card-list-each(v-for="(item,index) in cardsList",:class="selectId==item.id?'card-list-each-active':''",:style="{'margin-right':cardsList.length==index+1?0:'20px'}",@click="selectCard(item)")
              .card-list-each-top
                img.card-list-each-top-img(:src="item.cardIcon")
                p.card-list-each-top-num {{item.availableCount}}
              .card-list-each-bottom
                .card-list-each-bottom-title(:title="item.name") {{item.name}}
                .card-list-each-bottom-stone(:class="selectId==item.id?'active':''")
                  .card-list-each-bottom-stone-img(v-if="item.eggshellNumber")
                  span {{item.eggshellNumber>0?item.eggshellNumber:'可用'}}
        .card-list-arrow
          .card-arrow-left(:class="{'card-scroll-disable' : isScrollDisableLeft}", @click="cardScrollLeft")
          .card-arrow-right(:class="{'card-scroll-disable' : isScrollDisableRight}", @click="cardScrollRight")
    // 赠言列表
    .giving-list  
      .giving-list-each(v-for="(item,index) in cardWords",:class="giving==item.content?'active':''",@click="selectGiving(item)",:title="item.title") 
        div(:class="'giving-list-each-'+(index+1)") {{item.title}}
    // 赠言输入框
    .cards-giving-input
      .cards-giving-input-con 
        .cards-giving-input-con-limit 
          span.cards-giving-input-con-limit-span {{givingNum}}
          span /100
        textarea.cards-giving-input-con-text#input(placeholder="请输入赠言，最多输入100字",v-model="giving",maxlength="200")
</template>

<script>
import cookies from 'cookies-js'
export default {
  data() {
    return {
      //列表禁止向左滑动
      isScrollDisableLeft: true,
      //列表禁止向右滑动
      isScrollDisableRight: false,
      //是否停止滚动动画
      isScrolling: false,
      // 选中贺卡的ID
      selectId: this.selectedCardId ||0,
      // 选中贺卡的赠言
      cardWords:[],
      // 赠言
      giving: "",
      givingNum: 0
    }
  },
  props: {
    cardsList:{
      type:Array,
      default: function(){
        return []
      }
    },
    isSucceed:{
      type: Boolean,
      default: false
    }
  },
  mounted(){

  },
  methods: {
    //左滚动
    cardScrollLeft() {
      let that = this
      if (!this.isScrolling && !that.isScrollDisableLeft) {
        //滚动动画停止时执行
        this.isScrolling = true
        Velocity(this.$refs.islandWrapper, "scroll", {
          axis: "x",
          container: this.$refs.islandWrapper,
          duration: 300,
          offset: -600,
          mobileHA: false,
          complete: scrollEnd
        })
      }
      function scrollEnd() {
        //滚动动画回调
        that.isScrolling = false
        if (that.isScrollDisableRight) {
          that.isScrollDisableRight = false
        } else if (that.$refs.islandWrapper.scrollLeft === 0) {
          that.isScrollDisableLeft = true
        }
      }
    },

    // 右滚动
    cardScrollRight() {
      let that = this
      if (!this.isScrolling && !that.isScrollDisableRight) {
        //滚动动画停止时执行
        this.isScrolling = true
        Velocity(this.$refs.islandWrapper, "scroll", {
          axis: "x",
          container: this.$refs.islandWrapper,
          duration: 300,
          offset: 540,
          mobileHA: false,
          complete: scrollEnd
        })
      }
      function scrollEnd() {
        //滚动动画回调
        that.isScrolling = false
        if (
          that.$refs.islandWrapper.scrollLeft > 0 &&
          that.isScrollDisableLeft
        ) {
          that.isScrollDisableLeft = false
        } else if (
          that.$refs.islandWrapper.scrollLeft ===
          that.$refs.cardList.offsetWidth - that.$refs.islandWrapper.offsetWidth
        ) {
          that.isScrollDisableRight = true
        }
      }
    },
    // 点击选中贺卡
    selectCard(obj){
      this.selectId=obj.id
      this.cardWords=JSON.parse(obj.cardWords)
      if(this.cardWords.length >0 ){
        this.giving = this.cardWords[0].content
      }else{
        this.giving = ""
      }
      this.$emit("selectCardObj",obj)
    },
    // 选择赠言
    selectGiving(msg){
      this.giving = msg.content 
      sa.track('learning_click', {
        'click_id': 'pc_learning_greeting_cards_select_giving'
      })
    }
  },
  watch:{
    // 监听卡片列表，设置默认选中项
    cardsList:function(val,oldVal){
      if(val.length == 0){
        return
      }
      let current = val[0]
      this.selectId= current.id
      this.cardWords= JSON.parse(current.cardWords)
      if(this.cardWords.length >0 ){
        this.giving = this.cardWords[0].content
      }else{
        this.giving = ""
      }
      if(val.length>3){
        document.getElementsByClassName('card-list-long')[0].style.minWidth = val.length * 190-20+ 'px'
      }else{
        this.isScrollDisableRight = false
      }
      this.$emit("selectCardObj",current)
    },
    // 监听发送是否成功，初始化选中项
    isSucceed:function(val){
      if(!val){
        let current = this.cardsList[0]
        this.selectId= current.id
        this.cardWords= JSON.parse(current.cardWords)
        if(this.cardWords.length >0 ){
          this.giving = this.cardWords[0].content
        }else{
          this.giving = ""
        }
        this.$emit("selectCardObj",current)
      }
    },
    giving:function(){
      if (this.giving == null) return 0
      if (typeof this.giving != "string"){
        this.giving += ""
      }
      let strGiving = this.giving
      let length = Math.floor(strGiving.replace(/[^\x00-\xff]/g,"01").length/2)
      if(length > 100){
        this.$showToast('赠言最多100字')
      } 
      this.$emit("givingCon",{"con":this.giving})
      this.givingNum = length
    }
  }
}
</script>


<style lang="stylus" scoped>
*
  -moz-user-select none
  -webkit-user-select none
  -ms-user-select none
  -khtml-user-select none
  user-select none
textarea
  -webkit-touch-callout: text 
  -webkit-user-select: text
.cards
  .cards-list 
    width: 610px
    height: 155px
    margin: 10px 20px
    overflow: hidden

    .cards-container
      position: relative
      width: 100%
      height: 100%

    .card-list-content
      position: relative
      width: 550px
      height: 155px
      margin: 0 auto
      overflow: hidden
    .card-list-long
      position: absolute
      left: 0
      top: 0
      min-width: 550px
      overflow: hidden
      // 单个贺卡内容
      .card-list-each
        display: inline-block
        float: left
        width: 170px
        height: 155px
        margin-right: 20px
        border-radius: 10px
        background: rgba(159,106,235,1)
        cursor: pointer
        .card-list-each-top
          position: relative
          width: 170px
          height: 125px
          .card-list-each-top-img
            width: 160px
            height: 120px
            margin: 5px
            background: #fff
            border-radius: 11px
          .card-list-each-top-num
            position: absolute
            bottom: 0
            left: 5px
            width: 150px
            height: 29px
            line-height: 29px
            padding-right: 10px
            text-align: right
            color: #fff
            background: url('../../../img/greeting_cards/cover.png') no-repeat
            background-size: 100% 100%
            
        .card-list-each-bottom
          width: 170px
          height: 27px
          .card-list-each-bottom-title
            display: inline-block
            float: left
            width: 65px
            height: 26px
            line-height: 26px
            margin-left: 5px
            color: #fff
            font-size: 16px
            overflow: hidden
            text-overflow: ellipsis
            white-space: nowrap
          .card-list-each-bottom-stone
            display: inline-block
            position: relative
            float: right
            width: 50px
            height: 20px
            line-height: 20px
            margin: 5px 5px 0 0
            font-size: 14px
            color: #fff
            text-align: center
            background: rgba(143,87,224,1)
            border-radius: 10px
            &.active 
              background: #BC54DA
            .card-list-each-bottom-stone-img
              position: absolute
              width: 24px 
              height: 24px
              right: 33px
              top: -2px
              background: url('../../../img/greeting_cards/stone_2.png') no-repeat
      .card-list-each-active
        background: #DD63FF
    // 左右按钮
    .card-list-arrow 
      .card-arrow-left 
        display: inline-block
        position: absolute
        width: 25px
        height: 39px
        background: url('../../../img/greeting_cards/left.png') no-repeat
        background-size: 100% 100%
        left: 0
        top: 63px
        cursor: pointer
      
      .card-arrow-right 
        display: inline-block
        position: absolute
        right: 0
        top: 63px
        width: 25px
        height: 39px
        background: url('../../../img/greeting_cards/right.png') no-repeat
        background-size: 100% 100%
        cursor: pointer
      .card-scroll-disable 
        opacity: 0.6
        cursor: not-allowed
  // 赠言列表
  .giving-list
    width: 560px
    height: 40px
    margin: 18px 0 0 45px
    overflow: hidden
    .giving-list-each
      display: inline-block
      float: left 
      width: 114px 
      height: 36px
      line-height: 36px
      margin: 0 6px
      padding: 0 10px 0 0
      font-size: 14px
      background: #fff
      color: #555
      border: 2px solid #fff
      border-radius: 24px
      cursor: pointer
      overflow: hidden
      white-space: nowrap
      text-overflow: ellipsis
      &.active
        border: 2px solid #dd63ff
      .giving-list-each-1
        background: url('../../../img/greeting_cards/greeting-icon1.png') no-repeat
        padding-left: 30px
        background-size: 30px 30px
      .giving-list-each-2
        background: url('../../../img/greeting_cards/greeting-icon2.png') no-repeat
        padding-left: 30px
        background-size: 30px 30px
      .giving-list-each-3
        background: url('../../../img/greeting_cards/greeting-icon3.png') no-repeat
        padding-left: 30px
        background-size: 30px 30px
      .giving-list-each-4
        background: url('../../../img/greeting_cards/greeting-icon4.png') no-repeat
        padding-left: 30px
        background-size: 30px 30px
    // 赠言输入框
  .cards-giving-input
    width: 548px
    height: 100px
    padding-top: 14px
    margin-left: 44px
    background: url('../../../img/greeting_cards/greeting.png') no-repeat -6px top
    background-size: 76px 76px
    .cards-giving-input-con
      width: 510px
      height: 100px
      line-height: 40px
      margin-left: 6px
      padding-left: 40px
      background: rgba(255,255,255,.2)
      border-radius: 20px
      color: #fff
      .cards-giving-input-con-text
        display: inline-block
        float: left
        width: 460px
        height:80px
        line-height: 20px
        border: 0
        background-color: transparent
        color: #fff
        margin-top: 11px
        margin-left: 10px
        resize: none
        overflow-y: auto
        &::-webkit-scrollbar
            width: 8px
            height: 8px
            -webkit-border-radius: 4px
            -moz-border-radius: 4px
            border-radius: 4px
        &::-webkit-scrollbar-track
            background: rgba(0, 0, 0, 0)
        &::-webkit-scrollbar-thumb
            background: rgba(0, 0, 0, 0.1)
            border-radius: 4px
        &:focus
          outline: none
        &::placeholder
          color: #fff
      .cards-giving-input-con-limit
        display: inline-block
        float: left
        width: 57px
        height: 40px
        margin-top: 60px
        margin-left: -35px
        .cards-giving-input-con-limit-span
          color: #BDA7C2
        
</style>
