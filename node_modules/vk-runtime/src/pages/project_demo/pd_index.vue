<template lang="jade">
  .pd-main
    pd-back(:title_cn="'竞技太空站'",title_eng="Competition Arena",:gobackurl="'/'")
    work-wall
    .pd-container(@scroll="conScroll($event)", @mousewheel="userSrollDown($event)", @DOMMouseScroll="userSrollDown($event)",ref="pd_container")
      arrow(@arrowClick="arrowClick", :leftEnd = "isAtLeftEnd", :rightEnd = "isAtRightEnd")
      .swiper-container(ref="swiper_container")
        .swiper-item(v-for="(item, i) in activityArr",v-if="item",:class="[{'hasDuration': hasDuration},{'focus':index === i&& !onScrolling},{'pre-focus':index === i+1 && paddingFlag && !onScrolling},{'after-focus':index === i-1 && paddingFlag && !onScrolling}]",:ref="'swiper_item_'+i")
          .swiper-blur
          .swiper-item-main(@click="turn(i,item.id)")
            .activity-title {{item.name}}
            .activity-cover
              img(:src="item.coverImage")
            .activity-status(:class="[{'ing': item.statusKey === 1},{'end':item.statusKey === 2},{'pre':item.statusKey === 0}]")
            .activity-desc
              .time {{item._start}}~{{item._end}}
              .num
                span.cup
                |奖项名额：{{item.winnerSum}}名
      .null(v-if="!activityArr.length")
        .dino
          .dino-null
          .text 这里还什么都没有
    loading(v-show="loading")
    .net-mask(v-show="netError")
      net-error(@errorReload="errorReload")
</template>
<script>
  import axios from 'axios'
  import pdBack from './components/pd_back.vue'
  import arrow from './components/arrow.vue'
  import workWall from './components/work_wall_tips.vue'
  import Function from './js/function.js'
  import loading from '../common/vk_loading.vue'
  import netError from './components/net_error.vue'
  export default {
    mixins: [Function.index()],
    data(){
      return {
        pds: [2,3,1,2,3,1],
        index: 2,
        timer1: null,
        timer2: null,
        timer3: null,
        isAtLeftEnd: true,
        isAtRightEnd: true,
        onScrolling: false,
        hasDuration: true,
        scrollLenght: 570,
        imgSrc: "https://media.vipkidstatic.com/homework/image/grow_c5fcab32-8ac6-44ba-b67d-77e7d2290e371526561151989.png",
        activityStatus: 1,// 0未开始，1进行中，-1，已结束
        nextScroll: true,
        timestamp :  new Date().getTime(),
        _pds: null,
        __pds: null,
        activityArr: [],
        scrollLeft: '',
        paddingFlag: false,
        screenWidth: document.body.clientWidth,
        startTranslateX: '',
        startScroll: '',
        loading: true,
        netError: false
      }
    },
    components: {
      pdBack,
      arrow,
      workWall,
      loading,
      netError
    },
    created(){
    },
    mounted() {
      window.onresize = () => {
        return (() => {
          window.screenWidth = document.body.clientWidth
          this.screenWidth = window.screenWidth
        })()
      }

      if (document.body.offsetWidth>1480) {
        this.paddingFlag = true
      }

      this.timestamp = new Date().getTime()
      //获取大赛广场信息
      this.getPDIndexData(result => {
        if (result) {
          this.loading = false
        }
        if (result.data.code !== -1) {
          this._pds = result.data.data.list
          this.dataInit()
        }
      })
    },
    updated(){
      // document.getElementsByTagName('body')[0].style.minWidth =  0
    },
    watch: {
      screenWidth (val) {
        if (!this.timer) {
          this.screenWidth = val
          this.timer = true
          setTimeout(()=> {
            if (this.screenWidth > 1480) {
              this.paddingFlag = true
            }else{
              this.paddingFlag = false
            }
            this.translateInit()
            this.timer = false
          }, 400)
        }
      }
    },
    methods: {
      errorReload(){
        this.$playSound("click")
        setTimeout(()=> {
          window.location.reload()
        },500)
      },
      dataInit(){
        this.__pds = new Array(this._pds.length)
        let nostart = []
        let ing = []
        let end = []
        this._pds.forEach((val, index) => {
          val._start = this.formatData(val.startTime)
          val._end = this.formatData(val.endVotetime)
          if (val.statusKey === 0) {
            nostart.push(val)
          }
          if (val.statusKey === 1) {
            ing.push(val)
          }
          if (val.statusKey === 2) {
            end.push(val)
          }
        })
        nostart.sort(this._sort)
        ing.sort(this._sort)
        end.sort(this._sort)

        this.fillPds(ing)
        this.fillPds(nostart)
        this.fillPds(end)

        if (this.__pds.length == 1) {
          this.activityArr = this.activityArr.concat(this.__pds)
        }

        if (this.__pds.length == 2) {
          this.activityArr = this.activityArr.concat(this.__pds)
          this.activityArr = this.activityArr.reverse()
        }

        if (this.__pds.length > 2) {
          this.activityArr.push(this.__pds[this.__pds.length-2])
          this.activityArr.push(this.__pds[this.__pds.length-1])
          this.activityArr = this.activityArr.concat(this.__pds)
          this.activityArr.push(this.__pds[0])
        }
        this.screenWidth = document.body.offsetWidth
        this.translateInit()
      },
      translateInit(){
        if (this.activityArr.length == 1) {
          this.$refs.swiper_container.style.width = `100%`
          this.index = 0
          this.isAtLeftEnd = true
          this.isAtRightEnd = true
        }
        if (this.activityArr.length == 2) {
          this.startTranslateX = 230
          this.$refs.swiper_container.style.width = `100%`
          this.$refs.swiper_container.style.transform = `translateX(-${this.startTranslateX}px)`
          if (this.paddingFlag) {
            this.$refs.swiper_container.style.transform = `translateX(-310px)`
          }
          this.index = 1
          this.isAtLeftEnd = false
          this.isAtRightEnd = true
        }
        if (this.activityArr.length > 2) {
          let len = 460*this.activityArr.length + 280
          if (this.paddingFlag) {
            len = 460*this.activityArr.length + 280 + document.body.offsetWidth * 0.2
            this.startTranslateX = Math.floor(100+ 460 + 460 - ((document.body.offsetWidth - 560) / 2) + document.body.offsetWidth * 0.10)
          }else{
            this.startTranslateX = Math.floor(100+ 460 + 460 - ((document.body.offsetWidth - 560) / 2))
          }
          this.$refs.swiper_container.style.width = `${len}px`
          this.$refs.swiper_container.style.transform = `translateX(-${this.startTranslateX}px)`
          this.index = 2
          this.isAtLeftEnd = false
          this.isAtRightEnd = false
        }

      },
      fillPds(type){
        for (let i = 0; i < type.length; i++) {
          if(!this.__pds[i] && i === 0){
            this.__pds[i] = type[i]
          }else{
            for (var j = this.__pds.length - 1; j >= 0; j--) {
              if(!this.__pds[j]){
                this.__pds[j] = type[i]
                break
              }
            }
          }
        }
      },
      _sort(a,b){
        let v1 = a['startTime'] - this.timestamp
        let v2 = b['startTime'] - this.timestamp
        return v2 - v1
      },
      fullTime(t){
        return t < 10 ? '0'+t : t
      },
      formatData(timestamp) {
        var time = new Date(timestamp)
        var y = time.getFullYear()
        var m = time.getMonth()+1
        var d = time.getDate()
        return y+'.'+this.fullTime(m)+'.'+this.fullTime(d)
      },
      conScroll(evt){
      },
      clickScroll(){
      },
      goScroll(){
      }
    }
  }
</script>

<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
  .pd-main
    background: #652a8c url("../../img/project_demo/bg.png") no-repeat
    background-size: 100% auto
  .arrow
    .left-arrow
      width: 60px
      height: 60px
  .swiper-container
      border: 1px solid transparent
      text-align: center
      transition-duration: 1s
      .swiper-item
        position: relative
        width: 400px
        height: 340px
        display: inline-block
        cursor: pointer
        margin-top: 90px
        margin-left: 30px
        margin-right: 30px
        opacity: 0.6
        &:hover
          &.focus
            opacity: 1
        &:after
          content:" ";
          display: inline-block
          width: 120px
          height: 24px
          position: absolute
          bottom: -40px
          left: 35%
          background: transparent url("../../img/project_demo/shadow.png") no-repeat
          background-size: 100% 100%
        span
          position: absolute
        &.hasDuration
          transition-duration: 1s
          &.focus
            transition-duration: 1s
        .swiper-item-main
          position: absolute
          left: 3px
          width: 400px
          height: 340px
          background: transparent url("../../img/project_demo/tv.png") no-repeat
          background-size: 100% auto
        &.focus
          transform: translateZ(0) scale(1.45, 1.45)
          margin-left: 80px
          margin-right: 80px
          opacity: 1
          .swiper-blur
            position: absolute
            top: -18px
            left: 1px
            width: 400px
            height: 360px
            background: transparent url("../../img/project_demo/blur.png") no-repeat
            background-size: 100% auto
            animation: blurAnimate 2s infinite
            animation-direction: alternate
        &.pre-focus
          margin-left: 12vw
          @media  only screen and (min-width : 1450px)
            &:after
              display: none
        &.after-focus
          margin-right: 12vw
          @media  only screen and (min-width : 1450px)
            &:after
              display: none
  .null
    width: 100%
    height: 100%
    position: absolute
    top: 0
    .dino
      width: 300px
      height: 300px
      margin: 0 auto
      position: absolute
      top: 50%
      left: 50%
      transform: translate(-50%,-50%)
      .dino-null
        width: 300px
        height: 300px
        background: transparent url("../../img/project_demo/null.png") no-repeat
        background-size: 100% 100%
      .text
        font-size: 24px
        margin-top: 50px
        text-align: center
        color: #fff
  .net-mask
    width: 100%
    height: 100%
    position: absolute
    top: 0
    left: 0
    background: rgba(0,0,0,0.6)
  .pd-container
    height: 100%
    width: 100%
    overflow: hidden
    padding-top: 14%
  .activity-title
    width: 200px
    height: 30px
    margin-left: 100px
    margin-top: 6px
    text-align: center
    color: #fdfb92
    line-height: 32px
    font-weight: 700
    text-shadow: 0px .6px 0px #f79325
  .activity-cover
    width: 258px
    height: 164px
    margin-left: 70px
    margin-top: 28px
    img
      width: 260px
      height: 165px
      border-radius: 35px
  .activity-status
    width: 70px
    height: 30px
    position: absolute
    left: 40%
    bottom: 90px
    &.ing
      background: url("../../img/project_demo/ing.png") no-repeat
      background-size: 100% 100%
    &.end
      background: url("../../img/project_demo/end.png") no-repeat
      background-size: 100% 100%
    &.pre
      background: url("../../img/project_demo/nostart.png") no-repeat
      background-size: 100% 100%
  .activity-desc
    width: 190px
    height: 50px
    margin: 0 auto
    margin-top: 40px
    font-size: 12px
    color: #fff
    text-align: center
    line-height: 24px
    .num
      span.cup
        display: inline-block
        width: 14px
        height: 10px
        background: red
        position: static
        background: url("../../img/project_demo/cup.png") no-repeat
        background-size: 100% 100%
        margin-right: 3px
  @keyframes blurAnimate
    0%
      transform: scale(1.05, 1.05)
    100%
      transform: scale(1.1, 1.1)
  @keyframes jump
    0%
      top: 0
    50%
      top: 100px
    100%
      top: 0
  @keyframes shrink
    0%
      width:90px
      height: 60px
      background: rgba(120,120,120,.3)
    65%
      width: 10px
      height: 5px
      margin-left: -5px
      background: rgba(120,120,120,.3)
      box-shadow: 0 0 25px 20px rgba(20,20,20,.3)
    100%
      width: 90px
      height:60px
      background: rgba(120,120,120,.1)
      box-shadow: 0 0 25px 20px rgba(20,20,20,.1)
</style>

