<template lang="jade">
  .unit-show-time-main
    //- 列表滚动时的遮罩层
    .list-scrolling-mask(v-show="isListScrolling")
    .back-plants
      .plant-1
      .plant-2
      .plant-3
      .plant-4
      .plant-5
      .plant-6
    pd-back(:title_cn="title",:gobackurl="'/'")
    .level
      .circle.left-circle
      span.level-text Level {{level}}
      .circle.right-circle
    .unit-list-container(@scroll="conScroll($event)", @mousewheel="onUserSrollDown($event)", @DOMMouseScroll="onUserSrollDown($event)",ref="pd_container")
      ul.unit-list
        li.unit-item(v-for="(item, i) in unitList",v-if="item")
          .unit-tv
            .unit-tv-antenna
            .unit-tv-title
              span {{item.unitName}}
            .unit-tv-screen
              ust-video-play(:playData="item",videoSize="small",class="unit-media", :trackData="trackData")
              .unit-white-box
                .unit-video-name {{item.activityName}}
                .unit-tv-btn(@click="onClickTvBtn(item)",:class="[tvBtnStatusMap[item.unlockStatus].className]") {{tvBtnStatusMap[item.unlockStatus].name}}
            .unit-tv-leg
            .unit-tv-bottom-shadow
      .null(v-if="!unitList || !unitList.length")
        .dino
          .dino-null
          .text 这里还什么都没有
    loading(v-show="loading")
    .net-mask(v-show="netError")
      net-error(@errorReload="errorReload")
</template>
<script>
  import axios from 'axios'
  import pdBack from './components/pd_back.vue'
  import Function from './js/function.js'
  import ustVideoPlay from './components/ust_video_play.vue'
  import VideoFunc from './js/video.js'
  import loading from '../common/vk_loading.vue'
  import netError from './components/net_error.vue'
  export default {
    mixins: [Function.index(), VideoFunc.index()],
    data(){
      return {
        title: 'VIPKID风采展示',
        level: '2',
        isListScrolling: false,
        pageNo: 1,
        pageSize: 12,
        unitList: [],
        // 作品按钮的状态对照
        // 0:已上传视频 1:已解锁未上传(未上传) 2:未解锁
        tvBtnStatusMap: [
          {
            name: '已完成',
            className: 'done'
          },
          {
            name: '去录制',
            className: 'un-upload'
          },
          {
            name: '未解锁',
            className: 'locked'
          }
        ],
        // 当前正在播放的视频dom对象
        currentPlayer: null,
        currentPlayItem: null,
        index: 2,
        isAtLeftEnd: true,
        isAtRightEnd: true,
        onScrolling: false,
        hasDuration: true,
        scrollLenght: 570,
        imgSrc: "https://media.vipkidstatic.com/homework/image/grow_c5fcab32-8ac6-44ba-b67d-77e7d2290e371526561151989.png",
        activityStatus: 1,// 0未开始，1进行中，-1，已结束
        nextScroll: true,
        timestamp :  new Date().getTime(),
        activityArr: [],
        scrollLeft: '',
        paddingFlag: false,
        screenWidth: document.body.clientWidth,
        startTranslateX: '',
        startScroll: '',
        loading: true,
        netError: false,
        trackData: {
          clickId: 'pc_learning-effect_ust_UnitShowTimeIndex'
        }
      }
    },
    components: {
      pdBack,
      ustVideoPlay,
      loading,
      netError
    },
    created(){
    },
    mounted() {
      window.onresize = () => {
        return (() => {
          window.screenWidth = document.body.clientWidth
          this.screenWidth = window.screenWidth
        })()
      }

      if (document.body.offsetWidth>1480) {
        this.paddingFlag = true
      }

      this.timestamp = new Date().getTime()
      // 获取大赛广场信息
      this.getUnitIndexData(result => {
        if (result) {
          this.loading = false
        }
        if (result.data.code !== -1) {
          // for (var i = 0; i <= 4; i++) {
          //   result.data.data.list = result.data.data.list.concat(result.data.data.list)
          // }
          this.unitList = result.data.data.list
        }
      })
    },
    updated(){
      // document.getElementsByTagName('body')[0].style.minWidth =  0
    },
    destroy(){
      // 统计当前页面停留时长
      sa.track('learning_click', {
        'click_id': 'pc_learning-effect_ust_UnitShowTimeIndex_duration',
        'duration': (((new Date()).getTime()) - this.timestamp)
      })
    },
    watch: {
      screenWidth (val) {
        if (!this.timer) {
          this.screenWidth = val
          this.timer = true
          setTimeout(()=> {
            if (this.screenWidth > 1480) {
              this.paddingFlag = true
            }else{
              this.paddingFlag = false
            }
            this.translateInit()
            this.timer = false
          }, 400)
        }
      }
    },
    methods: {
      errorReload(){
        this.$playSound("click")
        setTimeout(()=> {
          window.location.reload()
        },500)
      },
      getUnitIndexData(callback){
        // var mock = {"data":{"code": 0, "data": {"list": [{"activityId": 118, "activityName": "21世纪英文演讲", "auditDes": null, "avatar": null, "avatarUrl": null, "awardId": 0, "awardName": null, "awardsImage": null, "awardsTypeId": 0, "count": 0, "countFromVipkid": 0, "countFromWx": 0, "coverImage": "https://vos-media.vipkid-qa.com.cn/learning/6c18a0dc-de4a-42cd-90cf-0221fc0c2287", "currentPartition": null, "endVotetime": null, "gmtCreate": null, "gmtModified": null, "id": 2086, "lessonId": 1, "lessonName": "11", "levelId": 11, "levelName": "2", "liked": 2, "name": "test aoo的作品", "partitionId": 133, "partitionList": null, "rank": 0, "startVotetime": null, "status": 0, "statusName": null, "stuEnglishName": null, "studentId": 1344380, "unitId": 11, "unitName": "3", "unlockStatus": 0, "url": "https://vos-media.vipkid-qa.com.cn/learning/avthumb-fe6e010f-a15b-4592-a15f-bace256f0c2e", "voteStatus": 0 }, {"activityId": 119, "activityName": "测试！！", "auditDes": null, "avatar": null, "avatarUrl": null, "awardId": 0, "awardName": null, "awardsImage": null, "awardsTypeId": 0, "count": 0, "countFromVipkid": 0, "countFromWx": 0, "coverImage": null, "currentPartition": null, "endVotetime": null, "gmtCreate": null, "gmtModified": null, "id": null, "lessonId": 2, "lessonName": "22", "levelId": 12, "levelName": "3", "liked": 2, "name": null, "partitionId": null, "partitionList": null, "rank": 0, "startVotetime": null, "status": 0, "statusName": null, "stuEnglishName": null, "studentId": null, "unitId": 12, "unitName": "4", "unlockStatus": 2, "url": "", "voteStatus": 0 } ], "pageNum": 1, "pageSize": 12, "pages": 1, "total": 2 }, "msg": "success"} }
        // callback(mock)
        axios.get(`/rest/activity/api/activity/user/resource/getUstList`,{
          params: {
            pageNo: this.pageNo,
            pageSize: this.pageSize
          }
        })
          .then((res) => {
            callback(res)
          })
          .catch((res) => {
            // this.netError = true
            // this.loading = false
          })
      },
      conScroll(evt){
      },
      onUserSrollDown(evt){
        var top = evt.currentTarget.scrollTop
        if (top>20) {
          this.isListScrolling = true
        } else {
          this.isListScrolling = false
        }
      },
      clickScroll(){
      },
      goScroll(){
      },
      onClickPlayBtn(item){
        const unlockStatus = item.unlockStatus
        this.currentPlayItem = item
        this.fullscreenPlay(this.$refs['video' + item.unitId][0], this.currentPlayItem)
      },
      onClickTvBtn(item){
        const unlockStatus = item.unlockStatus
        if (unlockStatus === 2) {
          sa.track('learning_click', {
            'click_id': 'pc_learning-effect_ust_UnitShowTimeIndex_locked'
          })
          Vm.$showToast('完成' + item.unitName + '学习才可以录制哦！')
        } else {
          if (unlockStatus === 1) {
            sa.track('learning_click', {
              'click_id': 'pc_learning-effect_ust_UnitShowTimeIndex_toRecord'
            })
          } else if(unlockStatus === 0) {
            sa.track('learning_click', {
              'click_id': 'pc_learning-effect_ust_UnitShowTimeIndex_hasBeenCompleted'
            })
          }
          this.$router.push({
            'path': '/unit_show_time/level2/' + item.activityId,
            'query': {
              'unlockStatus': item.unlockStatus
            }
          })
        }
      }
      // 统计页面停留时长
    }
  }
</script>

<style lang="stylus" scoped>
@import './css/ust.styl'
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
  .unit-show-time-main
    background:linear-gradient(180deg,rgba(53,0,133,1) 0%,rgba(86,52,162,1) 100%)
    color: #fff
    text-align: center
    .list-scrolling-mask
      position: fixed;
      width: 100%;
      height: 157px;
      top: 0;
      left: 0;
      z-index: 1;
      background: #350085;
      filter: blur(20px);
  .back-plants
    position: fixed
    top: 0
    left: 0
    width: 100%
    height: 100%
    .plant-1
      position: absolute
      top: 540px
      left: 588px
      width: 50px
      height: 49px
      background: url("../../img/project_demo/unit_show_time/An asteroid@2x.png") no-repeat
      background-size: 49px
    .plant-2
      position: absolute
      top: 38px
      left: 134px
      width: 92px
      height: 90px
      background: url("../../img/project_demo/unit_show_time/An asteroid@2x.png") no-repeat
      background-size: 92px
    .plant-3
      position: absolute
      top: 675px
      left: 932px
      width: 80px
      height: 79px
      background: url("../../img/project_demo/unit_show_time/Planets in@2x.png") no-repeat
      background-size: 80px
    .plant-4
      position: absolute
      top: 102px
      right: 80px
      width: 300px
      height: 250px
      background: url("../../img/project_demo/unit_show_time/planets@2x.png") no-repeat
      background-size: 300px
    .plant-5
      position: absolute
      top: 456px
      left: -100px
      width: 300px
      height: 250px
      background: url("../../img/project_demo/unit_show_time/planets@2x.png") no-repeat
      background-size: 300px
    .plant-6
      position: absolute
      top: 0
      left: 50%
      margin-left: -300px
      width: 600px
      height: 169px
      background: url("../../img/project_demo/unit_show_time/Semicircle background@2x.png") no-repeat
      background-size: 600px
      -webkit-filter: blur(7px)
      -moz-filter: blur(7px)
      -o-filter: blur(7px)
      -ms-filter: blur(7px)
      filter: blur(7px)
  .level
    position: fixed
    z-index: 8
    top: 84px
    left: 50%
    margin-left: -80px
    width:160px
    height:38px
    background:rgba(119,54,154,1)
    border-radius:19px
    .circle
      width: 11px
      height: 11px
      border-radius: 50%
      background:rgba(137,69,174,1)
    .left-circle
      position: absolute
      left: 11px
      top: 50%
      margin-top: -5.5px
    .right-circle
      position: absolute
      right: 11px
      top: 50%
      margin-top: -5.5px
    .level-text
      font-size: 22px
      line-height: 38px
  .unit-list-container
    width: 100%;
    /* height: 530px; */
    text-align: left;
    position: absolute;
    top: 0;
    bottom: 0;
    /* margin: 0 auto; */
    margin-top: 130px;
    /* transform: translate(-50%, -0); */
    /* -webkit-transform: translate(0, -0); */
    overflow: scroll;
    .unit-list
      width: 870px;
      display: block;
      margin: 0 auto;
      .unit-item
        display: inline-block
        vertical-align: top
        margin: 25px
        text-align: center
        position: relative
        .unit-tv
          position: relative
          .unit-tv-antenna
            width: 131px
            height: 40px
            margin: 0 auto
            margin-bottom: -20px
            background: url("../../img/project_demo/unit_show_time/Small antenna@2x.png") no-repeat
            background-size: 131px
          .unit-tv-title
            position: absolute
            z-index: 2
            top: 0
            left: 50%
            margin-left: -49.5px
            width: 99px
            height: 41px
            background: rgba(160,89,197,1)
            box-shadow: -8px -8px 0px 0px rgba(141,65,182,1) inset
            border-radius: 23px
            border: 4px solid #B077CE
            span
              line-height: 29px
              font-family: Arial-BoldMT
              font-size: 17px
              font-weight: bold
          .unit-tv-screen
            width: 240px
            min-height: 202px
            border: 6px solid #A687EA
            border-radius: 30px
            background: #af62d3
            overflow: hidden
            -webkit-transform: translateZ(0)
            -moz-transform: translateZ(0)
            transform: translateZ(0)
            .unit-media
              position: relative
              width: 100%
              height:129px
            .unit-white-box
              width: 100%
              height: 87px
              background-color: #fff
              overflow: hidden
              .unit-video-name
                margin: 10px auto
                font-size: 16px
                font-weight: 500
                color: rgba(74,74,74,1)
                line-height: 22px
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                padding: 0 10px;
              .unit-tv-btn
                position: relative
                margin: 0 auto
                width:138px;
                height:38px;
                line-height:38px;
                font-size: 17px
                font-weight:400;
                background-repeat: no-repeat
                background-size: 138px
                color:rgba(255,255,255,1);
                ust-btn 19px
                &.done
                  background-image: url("../../img/project_demo/unit_show_time/Has been completed@2x.png")
                &.un-upload
                  background-image: url("../../img/project_demo/unit_show_time/To record@2x.png")
                &.locked
                  background-image: url("../../img/project_demo/unit_show_time/Not unlock@2x.png")
          .unit-tv-leg
            width: 100%
            height: 13px
            margin-top: -6px
            background: url("../../img/project_demo/unit_show_time/The bottom of the TV@2x.png") no-repeat
            background-size: 177px
            background-position: center
          .unit-tv-bottom-shadow
            width: 100%;
            height: 21px;
            margin-top: 3px
            background: url("../../img/project_demo/unit_show_time/Projection TV@2x.png") no-repeat
            background-size: 191px
            background-position: center
  .null
    width: 100%
    height: 100%
    position: absolute
    top: 0
    .dino
      width: 300px
      height: 300px
      margin: 0 auto
      position: absolute
      top: 50%
      left: 50%
      transform: translate(-50%,-50%)
      .dino-null
        width: 300px
        height: 300px
        background: transparent url("../../img/project_demo/null.png") no-repeat
        background-size: 100% 100%
      .text
        font-size: 24px
        margin-top: 50px
        text-align: center
        color: #fff
  .net-mask
    width: 100%
    height: 100%
    position: absolute
    top: 0
    left: 0
    background: rgba(0,0,0,0.6)
  .pd-container
    height: 100%
    width: 100%
    overflow: hidden
    padding-top: 14%
  .activity-title
    width: 200px
    height: 30px
    margin-left: 100px
    margin-top: 6px
    text-align: center
    color: #fdfb92
    line-height: 32px
    font-weight: 700
    text-shadow: 0px .6px 0px #f79325
  .activity-cover
    width: 258px
    height: 164px
    margin-left: 70px
    margin-top: 28px
    img
      width: 260px
      height: 165px
      border-radius: 35px
  .activity-status
    width: 70px
    height: 30px
    position: absolute
    left: 40%
    bottom: 90px
    &.ing
      background: url("../../img/project_demo/ing.png") no-repeat
      background-size: 100% 100%
    &.end
      background: url("../../img/project_demo/end.png") no-repeat
      background-size: 100% 100%
    &.pre
      background: url("../../img/project_demo/nostart.png") no-repeat
      background-size: 100% 100%
  .activity-desc
    width: 190px
    height: 50px
    margin: 0 auto
    margin-top: 40px
    font-size: 12px
    color: #fff
    text-align: center
    line-height: 24px
    .num
      span.cup
        display: inline-block
        width: 14px
        height: 10px
        background: red
        position: static
        background: url("../../img/project_demo/cup.png") no-repeat
        background-size: 100% 100%
        margin-right: 3px
  @keyframes blurAnimate
    0%
      transform: scale(1.05, 1.05)
    100%
      transform: scale(1.1, 1.1)
  @keyframes jump
    0%
      top: 0
    50%
      top: 100px
    100%
      top: 0
  @keyframes shrink
    0%
      width:90px
      height: 60px
      background: rgba(120,120,120,.3)
    65%
      width: 10px
      height: 5px
      margin-left: -5px
      background: rgba(120,120,120,.3)
      box-shadow: 0 0 25px 20px rgba(20,20,20,.3)
    100%
      width: 90px
      height:60px
      background: rgba(120,120,120,.1)
      box-shadow: 0 0 25px 20px rgba(20,20,20,.1)
</style>

