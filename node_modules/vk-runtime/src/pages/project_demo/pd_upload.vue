<template lang="jade">
	transition(name="extension",enter-active-class="animated fadeInRight",leave-active-class="animated fadeOutRight")
		.upload-container
			upload-status(v-show="uploading",:progress="progress",@uploadingClick="uploadingClick",:fail="fail",:text="uploadText")
			.back-mask(v-show="preview",@click="buttonClick('cancel')")
			.mask-shadow(v-show="!preview")
				pd-back(:title_cn="title",@backConfirm="backConfirm")
				.upload-box
					.local-phone
						.cell-bg(:class="mobile ?'mobile':'pc'")
						.cell(v-for="(item, i) in ups" ,:class="'cell-'+i",@click="localOrPhone(i)") {{item}}
					.pc(v-if="!mobile" class="animated fadeInRight")
						.upload-video
							input#file(v-show="!videoURL",type="file" ref="file" @click="clickUpload" @change="fileChange" accept="video/mp4,video/x-ms-wmv,video/quicktime")
							img(:src="imgSrc",v-if="imgSrc&&imgSrc!=='data:,'")
							img(src="../../img/project_demo/upload_success.png",v-if="imgSrc=='data:,'")
							.status(:class="imgSrc === null ?'add':'play'",@click="videoPre")
							span(v-if="!imgSrc") 上传视频
						.upload-tips
							|视频最大可上传200M,
							span.phone
							|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;横屏拍摄的视频效果更佳哦~
						.title-box
							.title-text
								span 作品标题
								input#text(:class="{'focus':maxlengthTips}",ref="text",type="text",v-model="name",@focus="textChange",@blur="textChange('blur')",@input="textInput",autocomplete="off")
								//- span.title-tips(v-show="titleTips")
								.maxlengthTips(v-show="maxlengthTips") 最多支持10个汉字
							.student
								span 作者
								.name {{studentName}}
						.join(@click="joinPD",:class="videoURL && haveAgree && canJoin ? 'active': ''")
							p(v-show="!iconLoading") 确认上传
							img.icon-loading(src="../../img/readers/loading.gif", v-show="iconLoading")
						.agreement
							i(@click="haveAgree=!haveAgree", :class="{'active': haveAgree}")
							span 我已阅读并同意
								a(@click.prevent="rule=!rule") 《VIPKID上传协议》
					.mobile(v-if="mobile" class="animated fadeInLeft")
						.qrcode-box
							qrcode-box(v-if="qrcode" class="qrcode",:value="mobileUrl",:size="140",:level="'H'")
							.mobile-tips 请用微信扫描二维码上传视频哦~
			video(style="display:none;",:src="videoURL",controls="controls",ref="video")
			dialog-box(v-show="showDialog",:title="backObj.title",:tips="backObj.tips",@dialogClick="dialogClick")
			.dino-tips(class="animated fadeIn",v-show="dinoTips",:class="{'long':dinoTipsText.length>15}") {{dinoTipsText}}
			.preview(v-if="preview")
				pd-back(:title_cn="'预览'")
				.video-container
					img(v-if="cantDecode",src="../../img/project_demo/upload_preview.png")
					video(v-if="!cantDecode",:src="videoURL",controls="controls",ref="video2")
				.op(v-show="!videoId")
					.button(@click="buttonClick('cancel')") 取消
					.button(@click="buttonClick('upload')")
						span(v-if="iPad") 确认
						span(v-if="!iPad") 上传
			loading(v-show="loading")
			pd-rule(:show="rule",@closeRule="closeRule",:type="ruleType",:acid="acid", @agree="agree")
			.warn-tips(v-if="warnTips")
				.warn
					img(src="../../img/project_demo/null.png")
					.msg Oops！数据走丢了，正在努力寻找中，请稍后再试…
</template>
<script>
import axios from "axios"
import videoBox from "../common/vk_video.vue"
import VVOS from "vvos-js"
import qrcodeBox from "qrcode.vue"
import pdBack from "./components/pd_back.vue"
import pdRule from "./components/rule.vue"
import uploadStatus from "./components/upload_status.vue"
import dialogBox from "./components/dialog.vue"
import UPLOAD from "./js/upload.js"
import cookies from "cookies-js"
import loading from "../common/vk_loading.vue"
import utils from '../../utils/_untils.js'
export default {
  mixins: [UPLOAD.ipad(), UPLOAD.pc()],
  data() {
    return {
      loading: true,
      iconLoading: false, // iconLoding 图标标识变量
      haveAgree: false, // 是否已经同意协议
      rule: false, // 协议弹窗 显示否
      ruleType: "join", // 协议类型
      acid: 48, // acid值
      videoURL: null,
      imgSrc: null,
      qrcode: true,
      mobile: false,
      ups: ["本地上传", "手机上传"],
      uploading: false,
      progress: "0%",
      mobileUrl:
        "https://mobile.vipkid.com.cn/learning-effect/prd/SelectStudent?a=1&b=1",
      showDialog: false,
      dinoTips: false,
      maxlengthTips: false,
      time: "180",
      type: 0,
      product: "pd",
      preview: false,
      ipadImg: null,
      source: 1,
      currentMaterialId: 1,
      studentName: cookies.get("userName") || "本人",
      name: "",
      fail: false,
      uploadText: "作品上传中...",
      videoSize: null,
      prePlay: false,
      iPad: false,
      count: 0,
      videoId: "",
      isMp4: false,
      activityType: "",
      partitionId: "",
      backObj: {},
      canJoin: false,
      backUrl: "",
      title: "上传作品",
      processTimer: null,
      _preview: false,
      warnTips: false,
      titleTips: true,
      _name: "",
      dinoTipsText: "该视频过大，请选择其他视频",
      cantDecode: false,
      host: "https://a15-mobile.vipkid-qa.com.cn"
    }
  },
  components: {
    pdBack,
    pdRule,
    qrcodeBox,
    uploadStatus,
    dialogBox,
    videoBox,
    loading
  },
  mounted() {
    let host = window.location.host
    let index = host.search("lc.vipkid.com.cn")
    if (index !== -1) {
      if (index === 0) {
        this.host = "https://mobile.vipkid.com.cn"
      } else {
        if (host.search("pre") > -1) {
          this.host = "https://pre-mobile.vipkid.com.cn"
        } else {
          this.host = "https://a15-mobile.vipkid-qa.com.cn"
        }
      }
    }
    if (!cookies.get("userName") || cookies.get("userName") === "null") {
      this.initVKAppBridge()
      this.getStudentName()
    } else {
      this.name = cookies.get("userName") + "的作品"
    }
    this.getPartition()
    this.getAgreement()
  },
  updated() {
    document.getElementsByTagName("body")[0].style.minHeight = 0
    if (document.body.offsetHeight < 700) {
      this.title = ""
    }
  },
  methods: {
    videoPre() {
      this.preview = !this.preview
      this._preview = true
    },
    backConfirm() {
      this.showDialog = true
      this.backObj.title = "退出提示"
      this.backObj.tips = "宝贝还差一步就完成上传啦！确定要退出吗？"
    },
    getStudentName() {
      axios
        .get(`/rest/activity/api/activity/user/activity/getStudentByStudentId`)
        .then(res => {
          this.studentName = res.data.data.englishName
          this.name = this.studentName + "的作品"
        })
        .catch(err => {})
    },
    getPartition() {
      axios
        .get(
          `/rest/activity/api/activity/user/activity/getPartitionByActivityIdAndStudentId/${
            this.$route.params.pdId
          }`
        )
        .then(res => {
          this.loading = false
          this.partitionId = res.data.data.id
          this.activityType = res.data.data.activityType
          this.mobileUrl = `${this.host}/learning-effect/prd/SelectStudent?activityId=${this.$route.params.pdId}&partitionId=${this.partitionId}`
        })
        .catch(err => {})
    },
    // 获取是否同意过协议信息 data:true代表同意过
    getAgreement() {
      axios
        .get(
          `/rest/activity/api/activity/user/activity/getActivityStudentRulesRecord`
        )
        .then(res => {
          res.data.data ? (this.haveAgree = true) : "" // true: this.haveAgree置为 true
        })
        .catch(err => {})
    },
    //参加比赛，确认上传文件
    joinPD() {
      // 没上传作品 提示上传作品
      if (!this.videoURL) {
        this.$showToast("还没有上传视频，请先上传视频")
        return
      }
      // 没勾选协议 提示勾选协议
      if (!this.haveAgree) {
        this.$showToast("请您先同意《VIPKID 上传协议》，即可成功参赛")
        return
      }
      // canJoin 是最终控制状态
      if (!this.canJoin) {
        return
      }
      // 置为交互中状态
      this.iconLoading = true // iconloding 显示
      this.canJoin = false // 参赛按钮 不可点击
      this.$playSound("click")
      // 上传协议
      this.goUpload().then(res => {
        // 协议上传成功后：
        if (res.data) {
          // 先修改名字
          axios
            .post(
              `/rest/activity/api/activity/user/resource/renameByResourceIdAndName?resourceId=${
                this.videoId
              }&name=${this.$refs.text.value}`
            )
            .then(res => {
              if(res.data){
                this.join()
              }
            })
            .catch(err => {
              this.iconLoading = false // iconLoding 消失
              this.canJoin = true // 参赛按钮 active
            })
        }
      })
    },
    join() {
      sa.track("learning_click", {
        click_id:
          "pc_learning_activity_competitionArena_competition_upload_submissionConfirmed"
      })
      axios
        .post(
          `/rest/activity/api/activity/user/resource/signUpByResourceIdAndActivityId/${
            this.videoId
          }/${this.$route.params.pdId}`
        )
        .then(res => {
          if (res.data.code === 0) {
            this.$router.replace({
              path: `/pd_video/${this.videoId}/${this.$route.params.pdId}`
            })
          } else {
            this.warnTips = true
          }
        })
        .catch(err => {
          this.iconLoading = false // iconLoding 消失
          this.canJoin = true // 参赛按钮 active
        })
    },
    buttonClick(type) {
      this.$playSound("click")
      if (type === "cancel") {
        if (this._preview) {
          this.preview = false
        } else {
          this.videoURL = null
          this.videoId = ""
          this.preview = false
          this.$refs.file.value = ""
          this.imgSrc = null
        }
      } else {
        if (this.IS_IN_IPAD_APP) {
          axios
            .post(
              "/rest/activity/api/activity/user/upload/uploadComplete",
              JSON.stringify({
                mp4: true,
                videoUrl: this.videoURL,
                coverImage: this.imgSrc,
                activityId: this.$route.params.pdId,
                partitionId: this.partitionId,
                activityType: this.activityType,
                name: this.$refs.text.value,
                resourceType: 1
              }),
              { headers: { "Content-Type": "application/json" } }
            )
            .then(res => {
              // ipad端 视频是否符合参赛标准的验证
              if (res.data && res.data.code === 0) {
                this.fail = false
                this.preview = false
                this.uploading = false
                this.videoId = res.data.data.id
                this.canJoin = true
              } else {
                this.fail = false
                this.uploading = true
                this.progress = "Oops!"
                if (res.data && res.data.code === 100027) {
                  this.uploadText = "抱歉，该视频已经参加过其他大赛，请您另选一个视频参赛哦！"
                } else if (res.data && res.data.code === 100032) {
                  this.uploadText = "抱歉，该视频已被其他用户上传参赛，请您另选一个视频参赛哦！"
                } else if (res.data && res.data.code === 100033) {
                  this.uploadText = "抱歉，该视频之前上传过但并未通过审核，请您另选一个视频参赛哦！"
                } else {
                  this.uploadText = "上传失败"
                }
              }
            })
            .catch(err => {
              this.fail = true
              this.uploading = true
              this.progress = "Oops!"
              this.uploadText = "上传失败"
            })
        } else {
          this.uploadWork()
        }
      }
    },
    play() {
      this.prePlay = true
      this.$refs.video2.onended = () => {
        this.prePlay = false
      }
      this.$refs.video2.play()
    },
    agree() {
      this.haveAgree = true
      this.rule = false
    },
    retry() {
      location.reload()
    },
    uploadingClick(i) {
      this.$playSound("click")
      if (i === 0) {
        this.uploading = false
        sa.track("learning_click", {
          click_id:
            "pc_learning_activity_competitionArena_competition_upload_canceledByUser"
        })
      } else {
        this.fail = false
        this.progress = "0%"
        this.uploadText = "上传中..."
        this.uploadFile()
      }
    },
    dialogClick(key) {
      this.$playSound("click")
      if (key === "cancel") {
        this.showDialog = false
      } else {
        if(cookies.get('isFromApp')=='1'){ // ipad 平台
          if(history.state && this.gobackurl != '/'){
            history.go(-1)
          }else{
            utils.dispatchForIpad('vkappbridge://history/back')
          }
        }else{ // 非ipad平台
          if (this.gobackurl) {
            this.$router.push(this.gobackurl)
          } else {
            window.history.back()
          }
        }
      }
    },
    localOrPhone(i) {
      this.$playSound("click")
      this.mobile = i === 0 ? false : true
      if (i !== 0) {
        sa.track("learning_click", {
          click_id:
            "pc_learning_activity_competitionArena_competition_upload_QRPhone"
        })
      }
    },
    textInput() {
      if (!this.checkLength(this.name)) {
        this.maxlengthTips = true
        if (!this._name) {
          this._name = this.name
        } else {
          this.name = this._name
        }
        return
      }
    },
    checkLength(str) {
      let length = str.replace(/[\u0391-\uFFE5]/g, "aa").length
      if (length > 20) {
        return false
      } else {
        return true
      }
    },
    textChange(key) {
      if (key === "blur") {
        this.maxlengthTips = false
        if (!this.name) {
          this.name = cookies.get("userName") + "的作品"
          this.titleTips = true
        }
        return
      }
      if (this.name === cookies.get("userName") + "的作品") {
        this.name = ""
      }
      this.titleTips = false
      // this.maxlengthTips = true
    },
    //点击上传按钮，iPad单独调用，PC走原生input type="file"
    clickUpload() {
      this.$playSound("click")
      if (this.IS_IN_IPAD_APP) {
        utils.dispatchForIpad(
          `vkappbridge://fileupload/video?type=${this.type}&product=${
            this.product
          }&max_duration=${this.time}`
        )
        return
      }
    },
    // 关闭协议
    closeRule(key) {
      if (key) {
        this.rule = false
      }
    },
    // 上传协议记录
    goUpload() {
      sa.track("learning_click", {
        click_id: "pc_learning_activity_competitionArena_agree_uploadRule"
      })
      return new Promise((resolve, reject) => {
        axios
          .post(
            `/rest/activity/api/activity/user/activity/setActivityStudentRulesRecordAgree`
          )
          .then(res => {
            if (res.data.code === 0) {
              // 同意协议的记录 存储成功
              if (res.data.data) {
                resolve(res.data)
              } else {
                this.$showToast("协议未上传成功，请重新确认")
                this.haveAgree = false // 协议置为未勾选
                this.iconLoading = false // iconLoding 消失
              }
            } else {
              this.$showToast("协议未上传成功，请重新确认")
              this.haveAgree = false // 协议置为未勾选
              this.iconLoading = false // iconLoding 消失
            }
          })
          .catch(err => {
            this.$showToast("协议未上传成功，请重新确认")
            this.haveAgree = false // 协议置为未勾选
            this.iconLoading = false // iconLoding 消失
          })
      })
    }
  }
}
</script>

<style lang="stylus" scoped>
*
  box-sizing: border-box
  -moz-user-select: none
  -webkit-user-select: none
  -ms-user-select: none
  -khtml-user-select: none
  user-select: none
  -webkit-font-smoothing: antialiased
input
  -webkit-touch-callout: text
  -webkit-user-select: text
.warn-tips
  width: 100%
  height: 100%
  position: absolute
  top: 0
  left: 0
  background: rgba(0, 0, 0, 0.8)
  z-index: 8
  font-family: PingFangSC
  color: #fff
  text-align: center
  font-size: 20px
  padding-top: 200px
  img
    width: 240px
.upload-container
  background: #652a8c url('../../img/project_demo/bg.png') no-repeat
  background-size: 100% auto
  color: #fff
  text-align: center
  .back-mask
    width: 120px
    height: 100px
    position: fixed
    z-index: 1000
    cursor: pointer
  .mask-shadow
    width: 100%
    height: 100%
    background: rgba(0, 0, 0, 0.5)
    position: absolute
  .upload-box
    width: 440px
    height: 580px
    position: absolute
    bottom: 50%
    left: 50%
    transform: translate(-50%, 50%)
    -webkit-transform: translate(-50%, 50%)
    @media only screen and (max-device-height: 700px)
      transform: translate(-50%, 0)
      -webkit-transform: translate(-50%, 0)
      bottom: 3vh
    .pd-tips
      right: 34%
      top: 22%
      width: 36px
      height: 36px
      z-index: 10
    .local-phone
      width: 310px
      height: 40px
      background: rgba(121, 79, 181, 1)
      border-radius: 25px
      margin: 0 auto
      position: relative
      cursor: pointer
      padding: 3px
      .cell-bg
        width: 150px
        height: 34px
        position: absolute
        border-radius: 25px
        background: url('../../img/project_demo/pc_phone.png') no-repeat
        background-size: 100% 100%
        transition-duration: 0.8s
        &.mobile
          left: 157px
        &.pc
          left: 3px
      .cell
        display: inline-block
        width: 150px
        height: 34px
        border-radius: 25px
        line-height: 34px
        position: absolute
        z-index: 1
        &.cell-0
          left: 0
        &.cell-1
          right: 0
    .upload-video
      width: 320px
      height: 180px
      background: rgba(179, 150, 255, 0.3)
      border-radius: 20px
      border: 4px dashed rgba(179, 150, 255, 1)
      margin: 4vh auto 2.5vh
      color: #B396FF
      font-size: 20px
      position: relative
      cursor: pointer
      &:hover
        opacity: 0.5
      img
        width: 100%
        height: 100%
        border-radius: 20px
      span
        display: inline-block
        margin-top: 20px
        font-weight: 400
      .status
        &.play
          width: 60px
          height: 60px
          background: url('../../img/project_demo/play_status.png') no-repeat
          background-size: 100% 100%
          position: absolute
          top: 30%
          left: 40%
        &.add
          width: 60px
          height: 60px
          background: url('../../img/project_demo/combined.png') no-repeat
          background-size: 100% 100%
          margin: 50px auto 0
    .upload-tips
      font-size: 14px
      color: #B396FF
      width: 520px
      margin-left: -40px
      span.phone
        display: inline-block
        width: 20px
        height: 14px
        background: url('../../img/project_demo/mobile_icon.png') no-repeat
        background-size: 100% 100%
        position: absolute
    .title-box
      width: 440px
      height: 160px
      background: rgba(179, 150, 255, 1)
      border-radius: 30px
      margin-top: 4vh
      position: relative
      .title-text
        width: 100%
        display: inline-block
        font-size: 20px
        margin-top: 20px
        .title-tips
          width: 62px
          height: 13px
          font-size: 10px
          position: absolute
          color: #A080E8
          background: url('../../img/project_demo/word.png')
          background-size: 100% 100%
          top: 38px
          right: 45px
        .maxlengthTips
          position: absolute
          width: 150px
          height: 20px
          background: rgba(255, 201, 165, 1)
          border-radius: 0px 0px 10px 10px
          color: #FF6600
          font-size: 12px
          left: 180px
          line-height: 20px
        span
          margin-right: 5px
      .student
        width: 100%
        font-size: 20px
        line-height: 50px
        margin-top: 20px
        .name
          text-align: left
          padding-left: 20px
          display: inline-block
          width: 260px
          height: 50px
          background: rgba(121, 79, 181, 0.3)
          border-radius: 38px
          margin-left: 24px
    .join
      position: relative
      width: 200px
      height: 50px
      background: url('../../img/project_demo/unjoin.png') no-repeat
      background-size: 100% 100%
      margin: 4vh auto
      font-size: 20px
      line-height: 50px
      cursor: pointer
      &.active
        background: url('../../img/project_demo/join.png') no-repeat
        background-size: 100% 100%
      img.icon-loading
        position: absolute
        left: 50%
        top: 50%
        transform: translate(-50%, -50%)
    .agreement
      i
        display: inline-block
        width: 20px
        height: 20px
        background: white
        border-radius: 12px
        border: 2px solid rgba(255, 102, 0, 1)
        &.active
          background: rgba(255, 102, 0, 1) url('../../img/project_demo/checkmark.png') no-repeat 0 0 / 16px 16px
          border-color: rgba(0, 0, 0, 0.5)
      span
        display: inline-block
        vertical-align: bottom
        width: 228px
        height: 19px
        line-height: 19px
        margin-left: 7px
        font-size: 14px
        font-family: MicrosoftYaHei
        color: rgba(179, 150, 255, 1)
        & > a
          text-decoration: underline
  .mobile
    .qrcode-box
      margin: 40px auto
      width: 320px
      height: 320px
      background: rgba(179, 150, 255, 0.3)
      border-radius: 30px 20px 20px 20px
      border: 4px dashed rgba(179, 150, 255, 1)
      .qrcode
        margin: 66px auto
        width: 180px
        height: 180px
        background: #fff
        padding-top: 20px
      .mobile-tips
        margin-top: 120px
#file
  position: absolute
  z-index: 3
  width: 320px
  height: 180px
  border: 1px solid black
  left: 0
  opacity: 0
#text
  width: 260px
  padding: 0 20px
  height: 50px
  background: rgba(255, 255, 255, 1)
  border-radius: 38px
  outline: none
  border: 2px solid transparent
  // color: #371575
  color: #777777
  &.focus
    border: 2px solid #FF6600
    // color #371575
.dino-tips
  width: 330px
  height: 105px
  position: absolute
  background: url('../../img/project_demo/dino_tips.png') no-repeat
  background-size: 100% 100%
  left: 37%
  top: 42%
  color: #777
  line-height: 110px
  padding-left: 50px
  &.long
    line-height: 30px
    padding-top: 24px
#time
  position: absolute
  right: 30px
  top: 30px
  z-index: 13
#type
  position: absolute
  right: 30px
  top: 90px
  z-index: 13
#product
  position: absolute
  right: 30px
  top: 150px
  z-index: 13
.ipadImg
  width: 400px
  height: 300px
  border: 1px solid black
.retry
  width: 100px
  height: 50px
  font-size: 30px
  background: red
.preview
  width: 600px
  height: 450px
  margin: 0 auto
  margin-top: 150px
  position: relative
  @media screen and (min-height: 800px)
    margin-top: 200px
  .video-container
    width: 600px
    height: 340px
    background: black
    border-radius: 10px
  video
    height: 340px
    border-radius: 10px
  img
    height: 340px
    border-radius: 10px
  .play-status
    width: 60px
    height: 60px
    background: url('../../img/project_demo/play_status.png') no-repeat
    background-size: 100% 100%
    position: absolute
    top: 30%
    left: 49%
  .op
    margin-top: 60px
    .button
      display: inline-block
      width: 140px
      height: 40px
      font-size: 18px
      line-height: 38px
      cursor: pointer
      &:first-of-type
        background: url('../../img/project_demo/upload_status_2.png') no-repeat
        background-size: 100% 100%
        margin-right: 40px
      &:last-child
        background: url('../../img/project_demo/upload_status_1.png') no-repeat
        background-size: 100% 100%
        margin-right: 0
</style>
