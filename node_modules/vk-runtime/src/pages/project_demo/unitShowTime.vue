<template lang="jade">
  transition(name="extension", enter-active-class="animated fadeInRight", leave-active-class="animated fadeOutRight")
    .pd(@mousewheel="userSrollDown($event)", @DOMMouseScroll="userSrollDown($event)", @touchstart="touchStart($event)", @touchmove="touchMove($event)", @touchend="touchEnd($event)")
      pd-back(:title_cn="activityName+'：'+activityTheme")

      .pd-container(v-if="detail")

        //- 右侧榜单开关
        .pd-toolkit(@click="showVideoBox()")
          .rank-icon
          .tips(v-if="!showBox") 查看总榜
          .tips(v-if="showBox") 收起榜单
          .triangle(:class="{'active':showBox}")

        //- 右上角活动规则
        .pd-tips(@click="openRule('activity')")
          .tips-btn
          span 活动规则
        
        //- 主要内容
        .pd-detail-container
          showtime-box(:detail="detail", @rule="openRule('join')", @gojoin="goJoin", :partitionId="partitionId")
          .pd-detail-video(:class="{'active':showBox}", @mousewheel.stop="userSrollDown($event, 'pd-detail-video')", @DOMMouseScroll.stop="userSrollDown($event, 'pd-detail-video')", @click="openVideo($event)")
            .pd-detail-bottom
              video-box(v-if="boxType === 'video'", @selectLevel="selectLevel", :show="showBox", :status="detail.activityStudentResource", :whichActivity="whichActivity")
              rank-box(v-if="boxType === 'rank'", @selectLevel="selectLevel", :show="showBox")
              
        //- 活动规则浮层
        pd-rule(:show="rule", @closeRule="closeRule", @agree="goUpload", :type="ruleType", :acid="pdId", :activityType="'SHOW_TIME'")
        
        //- 全屏幕loading
        loading(v-show="loading")

      //- 网络异常的提示
      .net-mask(v-if="netError")
        net-error(@errorReload="errorReload", :msg="errorMsg")

      //- 恭喜学生获得奖牌
      .winner(v-if="winner", @click="closeWinner")
        winner(:type="winnerType")

      //- 异常提示
      .warn-tips(v-if="warnTips")
        .warn
          img(src="../../img/project_demo/null.png")
          .msg Oops！数据走丢了，正在努力寻找中，请稍后再试…
</template>
<script>
  import axios from 'axios'
  import pdBack from './components/pd_back.vue'
  import pdRule from './components/rule.vue'
  import videoBox from './components/video_box.vue'
  import rankBox from './components/rank_box.vue'
  import showtimeBox from './components/show_time_banner.vue'
  import loading from '../common/vk_loading.vue'
  import netError from './components/net_error.vue'
  import winner from './components/winner.vue'
  import FastClick from 'fastclick'
  import Toolkit from './js/toolkit.js'
  export default {
    data(){
      return {
        boxType: '',
        angleType: 'down',
        detail: null,
        // tabs: null,
        rule: false,
        ruleType: 'activity',
        startScroll: 0,
        loading: true,
        netError: false,
        pdDetailBottom: null,
        pdId: this.$route.params.pdId,
        partitionId: '',
        showBox: false,
        startClientY: 0,
        endClientY: 0,
        winner: false,
        winnerType: '',
        warnTips: false,
        errorMsg: '糟糕！网络链接出现问题',
        whichActivity: 'SHOWTIME', // 活动类型
        activityName:'',//活动名称
        activityTheme:''//活动主题
      }
    },
    components: {
      pdBack,
      pdRule,
      videoBox,
      showtimeBox,
      rankBox,
      loading,
      netError,
      winner
    },
    created(){
      FastClick.attach(document.body)
    },
    mounted() {

      this.getWininfo()

      this.getDetailByPid(this.$route.params.pdId, resp => {
        this.loading =false
        let result = resp.data
        if (result.code == 100022) {
          this.netError = true
          this.errorMsg = result.msg
        } else {
          this.detail = result.data
          this.activityName = result.data.name
          this.activityTheme = result.data.theme
          if (this.detail.activityStudentResource === 3) {
            this.boxType = 'rank'
          } else {
            this.boxType = 'video'
          }
        }
      })
    },
    updated(){
      document.getElementsByTagName('body')[0].style.minHeight = 0
    },
    methods: {
      getDetailByPid(activityId,callback) {
        axios.get(`/rest/activity/api/activity/user/activity/getActivityDetailByActivityId/${activityId}`)
          .then((res) => {
            callback(res)
          })
          .catch((res) => {
            this.netError = true
            this.loading = false
            callback(res)
          })
      },
      openVideo(e){
        if (!this.showBox && (e.target.className == 'video-box') || (e.target.className == 'pd-detail-label')) {
          this.showBox = true
        }
      },
      getWininfo(){
        axios.get(`/rest/activity/api/activity/user/message/getMessage/${this.$route.params.pdId}`)
          .then((res) => {
            if (res.data.data.status === 0) {
              this.winnerType = res.data.data.content
              this.winner = true
              setTimeout(() => {
                this.winner = false
              }, 3000)
            } else {
              this.winner = false
            }
          })
          .catch((err) => {
            this.loading = false
          })
      },
      closeWinner(){
        this.winner = false
      },
      selectLevel(id){
        this.partitionId = id
      },
      goJoin(type){
        if (type == 'numClass') {
          this.loading = false
        } else if (type) {
          this.loading = true
        } else {
          this.warnTips = true
          this.loading = false
        }
      },
      errorReload(){
        this.$playSound("click")
        setTimeout(() => {
          window.location.reload()
        }, 500)
      },
      touchScroll(e){
      },
      closeRule(key){
        if (key) {
          this.rule = false
        }
      },
      openRule(type){
        this.$playSound("click")
        if (type === 'activity') {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_ActivityDescription'})
        } else {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_UploadDescription'})
        }
        this.rule = true
        this.ruleType = type
        this.loading = false
      },
      showVideoBox(){
        this.$playSound("click")
        if (this.detail.activityStudentResource !== 3) {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_rankingFloatingEntrance_during'})
        } else {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_WinnersFloatingEntrance_after'})
        }
        this.showBox = !this.showBox
      },
      userSrollDown(evt, flag){
        if (evt.wheelDelta) { //判断浏览器IE，谷歌滑轮事件             
          if (flag === 'pd-detail-video') {
            if (evt.wheelDelta > 0) {
              if (evt.target.className !== 'video-box' && evt.target.className !== 'pd-detail-bottom') {
                let ele = document.getElementsByClassName('pd-detail-thumb')[0]
                if (ele.scrollTop == 0 && evt.wheelDelta > 100) {
                  this.showBox = false
                }
              } else {
                this.showBox = false
              }
            } else {
              this.showBox = true
            }
          } else {
            evt.wheelDelta > 0 ? this.showBox = false : this.showBox = true
          }
        } else if (evt.detail) { //Firefox滑轮事件
          if (flag === 'pd-detail-video') {
            if (evt.delta > 0) {
              if (evt.target.className !== 'video-box' && evt.target.className !== 'pd-detail-bottom') {
                let ele = document.getElementsByClassName('pd-detail-thumb')[0]
                if (ele.scrollTop == 0 && evt.delta > 100) {
                  this.showBox = false
                }
              } else {
                this.showBox = false
              }
            } else {
              this.showBox = true
            }
          } else {
            evt.delta > 0 ? this.showBox = false : this.showBox = true
          }
        }

      },
      goUpload(){
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_agree_uploadRule'})
        this.loading = true
        axios.post(`/rest/activity/api/activity/user/activity/setActivityStudentRulesRecordAgree`)
          .then((res) => {
            this.loading = false
            if (res.data.code === 0) {
              this.checkWorkWall()
            }
          })
          .catch((err) => {
            this.loading = false
          })
      },
      checkWorkWall(){
        axios.get(`/rest/activity/api/activity/user/resource/getResourcesByActivityIdAndStudentId/${this.$route.params.pdId}/1/1`)
          .then((res) => {
            if (res.data.code === 0) {
              if (!res.data.data) {
                this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
                return
              }
              if (res.data.data.list.length) {
                this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}`})
              } else {
                this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
              }

            }
          })
          .catch((err) => {
            this.loading = false
            // this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}`})
          })
      },
      touchStart(e){
        this.startClientY = e.touches[0].clientY
      },
      touchMove(e){
        this.endClientY = e.touches[0].clientY
      },
      touchEnd(e){
        if (parseInt(this.endClientY - this.startClientY) < -50 && this.endClientY !== 0) {
          this.showBox = true
        }

        if (this.endClientY - this.startClientY > 100 && this.endClientY !== 0) {
          let ele = document.getElementsByClassName('pd-detail-thumb')[0]
          if (ele.scrollTop == 0) {
            this.showBox = false
          }
        }
        this.endClientY = 0
        this.startClientY = 0
      }
    }
  }
</script>

<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    outline: none
    -webkit-tap-highlight-color: transparent

  .warn-tips
    width: 100%
    height: 100%
    position: absolute
    top: 0
    left: 0
    background: rgba(0, 0, 0, 0.8)
    z-index: 8
    font-family: PingFangSC
    color: #fff
    text-align: center
    font-size: 20px
    padding-top: 200px
    img
      width: 240px

  .net-mask
    width: 100%
    height: 100%
    position: absolute
    top: 0
    left: 0
    z-index: 6
    background: rgba(0, 0, 0, 0.6)

  .pd-toolkit
    right: 0
    top: 50%
    position: absolute
    width: 40px
    height: 140px
    background: rgba(200, 119, 232, 1)
    border-radius: 20px 0px 0px 20px
    opacity: 0.7
    font-size: 18px
    text-align: center
    cursor: pointer
    z-index: 8
    transform: translateY(-60%)
    -webkit-transform: translateY(-60%)
    transform: scale(1.2, 1.2)
    &:active
      opacity: 1
    &:hover
      opacity: 1
    .rank-icon
      width: 20px
      height: 15px
      display: inline-block
      margin-top: 15px
      background: url("../../img/project_demo/detail.png") no-repeat
      background-position: bottom left
      background-size: 160px
    .tips
      margin-top: 3px
      width: 30px
      display: inline-block
      color: #fff
      line-height: 18px
      -webkit-font-smoothing: antialiased
    .triangle
      width: 14px
      height: 16px
      display: inline-block
      margin-top: 4px
      background: url("../../img/project_demo/detail.png") no-repeat
      background-size: 160px
      background-position: -146px -64px
      &.active
        background-position: -146px -80px

  .pd
    background: #652a8c url("../../img/project_demo/bg.png") no-repeat
    background-size: 100% auto
    .net-mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background: rgba(0, 0, 0, 0.6)
    .pd-detail-container
      width: 100%
      overflow: hidden
      position: relative
      transition-duration: 1s
      margin-top: 78px;
      .pd-detail-video
        width: 1024px
        height: calc(100% - 78px)
        top: 678px
        display: inline-block
        position: fixed
        z-index: 2
        transition-duration: 1s
        left: 50%
        transform: translateX(-50%)
        -webkit-transform: translateX(-50%)
        &.active
          top: 78px
        @media only screen and (min-width: 1500px)
          width: 1352px
        .pd-detail-bottom
          background: #bba4fa
          height: 100%
          border-radius: 30px 30px 0 0

  .pd-tips
    width: 120px
    top: 20px
    right: 20px
    position: absolute
    height: 38px
    z-index: 13
    cursor: pointer
    line-height: 18px
    .tips-btn
      background: url("../../img/project_demo/question_mark.png") no-repeat
      background-size: 100% 100%
      position: absolute
      z-index: 13
      width: 36px
      height: 36px
      left: 0
      &:after
        content: " "
        display: inline-block
        width: 36px
        height: 36px
        border-radius: 28px
        display: none
        position: absolute
      &:hover
        &:after
          background: rgba(255, 255, 255, 0.3)
          display: inline-block
      &:active
        &:after
          background: rgba(0, 0, 0, 0.3)
          display: inline-block
    span
      position: absolute
      color: #fff
      font-size: 18px
      right: 0
      top: 10px
</style>