<template lang="jade">
  transition(name="extension",enter-active-class="animated fadeInRight",leave-active-class="animated fadeOutRight")
    .pd(@mousewheel="userSrollDown($event)", @DOMMouseScroll="userSrollDown($event)",@touchstart="touchStart($event)",@touchmove="touchMove($event)",@touchend="touchEnd($event)")
      pd-back(:title_cn="activityName+'：'+activityTheme", :gobackurl="'/competition_arena'")
      .model-download-btn(@click="downloadPetsModel", v-if="activityType == 6") 下载素材模板
      img(src="../../img/project_demo/pet_model.png" ref="modelImg" style="display: none")
      .pd-container(v-if="detail")
        //- 提示工具
        .pd-toolkit(@click="showVideoBox()")
          .rank-icon
          .tips(v-if="!showBox") 查看总榜
          .tips(v-if="showBox") 收起榜单
          .triangle(:class="{'active':showBox}")
        .pd-mask-container(ref="pd_mask_container",v-show="false")
        .pd-tips(@click="openRule('activity')")
          .tips-btn
          span 活动规则
        .pd-detail-container
          award-box(:detail="detail",@rule="openRule('join')",@gojoin="goJoin",:partitionId="partitionId")
          .pd-detail-video(ref="pd_detail_video",:class="{'active':showBox}",@mousewheel.stop="userSrollDown($event, 'pd-detail-video')", @DOMMouseScroll.stop="userSrollDown($event, 'pd-detail-video')",@click="openVideo($event)")
            .pd-detail-bottom
              video-box(v-if="boxType && boxType === 'video'",ref="video_box",@selectLevel="selectLevel",:show="showBox",:status="detail.activityStudentResource")
              rank-box(v-if="boxType && boxType === 'rank'",ref="video_box",@selectLevel="selectLevel",:show="showBox")
        pd-rule(:show="rule",@closeRule="closeRule",@agree="goUpload",:type="ruleType",:acid="pdId",:activityType="activityType")
        loading(v-show="loading")
      .net-mask(v-if="netError")
        net-error(@errorReload="errorReload",:msg="errorMsg")
      .winner(v-if="winner",@click="closeWinner")
        winner(:type="winnerType",:awardsImage="awardsImage")
      .warn-tips(v-if="warnTips")
        .warn
          img(src="../../img/project_demo/null.png")
          .msg Oops！数据走丢了，正在努力寻找中，请稍后再试…
      .pd-dialog(v-if="isShowIpadAppDownloadNotice")
        .mirror
        .pd-dialog-box
          .notice-img
          h4 下载提示
          .white-board
            p 即将进入【素材模版】页面，长按即可保存模版图片
            .btn.right(@click="goToSafari") 确定
            .btn.left(@click="closeDownloadNotince") 取消
      .pd-dialog(v-if="isShowPcAppDownloadNotice")
        .mirror
        .pd-dialog-box-pcapp
          .notice-img
          h4 下载素材模板
          .white-board
            .prview-model
            img.qrcode(src="../../img/project_demo/pet_model_qrcode.png")
            .qrcode-desc 微信扫描二维码<br>长按保存素材模版
          .close(@click="closeDownloadNotince")

</template>
<script>
  import axios from 'axios'
  import pdBack from './components/pd_back.vue'
  import pdRule from './components/rule.vue'
  import videoBox from './components/video_box.vue'
  import rankBox from './components/rank_box.vue'
  import awardBox from './components/award_box.vue'
  import loading from '../common/vk_loading.vue'
  import netError from './components/net_error.vue'
  import winner from './components/winner.vue'
  import FastClick from 'fastclick'
  import utils from '../../utils/_untils.js'
  import cookies from 'cookies-js'
  import {localStorageUtil} from '../../utils/_untils.js'
  import dragonUtils from '../../utils/_dragon.js'

  export default {
    data(){
      return {
        boxType: null,
        angleType: 'down',
        detail: null,
        // tabs: null,
        rule: false,
        ruleType: 'activity',
        startScroll: 0,
        loading: true,
        netError: false,
        pdDetailBottom: null,
        pdId: this.$route.params.pdId,
        partitionId: '',
        showBox: false,
        startClientY: 0,
        endClientY: 0,
        winner: false,
        winnerType: '',
        awardsImage: '',
        warnTips: false,
        errorMsg: '糟糕！网络链接出现问题',
        activityName:'',//活动名称
        activityTheme:'',//活动主题,
        activityType:0, // 活动类型,1:pd大赛,2:steam大赛,3:UNIT_SHOW比赛, 4: 21世纪, 5:万圣节,
        prevPdId: null,
        isShowIpadAppDownloadNotice: false,
        isShowPcAppDownloadNotice: false
      }
    },
    components: {
      pdBack,
      pdRule,
      videoBox,
      awardBox,
      rankBox,
      loading,
      netError,
      winner
    },
    created(){
      FastClick.attach(document.body)
    },
    activated() {
      // 由于此页面keepalive功能激活， 所以在"竞技太空站"选择不同的活动进来需要判断pdId是否跟上一次相同来刷新数据。
      this.loading = false
      let prevPdId = localStorageUtil.get('pc_learning_pd_id')
      let currentPdId = this.$route.params.pdId
      if (prevPdId != currentPdId) {
        this.initDetailData()
        localStorageUtil.set('pc_learning_pd_id', this.$route.params.pdId)
      }
    },
    mounted() {
      this.initDetailData()
    },
    updated() {
      document.getElementsByTagName('body')[0].style.minHeight = 0
    },
    methods: {
      goToSafari() {
        let _url = encodeURIComponent('https://image.vipkid.com.cn/ys/vipkid_dino_space_travel.png')
        this.dispatchForIpad('vkappbridge://ipadcommon/ipadRouter?route=vkstudy://common/openUrl?url=' + _url)
      },
      closeDownloadNotince() {
        this.isShowIpadAppDownloadNotice = false
        this.isShowPcAppDownloadNotice = false
      },
      downloadPetsModel() {
        if (cookies.get("isFromApp")) {
          // iPad下载提示: 方案是调起浏览器访问打开图片永久地址
          this.isShowIpadAppDownloadNotice = true
        } else if (dragonUtils.isOnDragonClient()) {
          // PC APP 下载提示： 方案是展示图片永久地址的二维码。
          this.isShowPcAppDownloadNotice = true
        } else {
          var img = this.$refs.modelImg
          var url = img.src
          var a = document.createElement('a')
          var event = new MouseEvent('click')
          a.download = name || 'VIPKID宠物装备大赛素材模板'
          a.href = url
          a.dispatchEvent(event)
        }
        sa.track('learning_click', {'click_id': 'pc_learning_activity_download_pets_Model'})
      },
      dispatchForIpad(src) {
        let _iframe = document.createElement('iframe')
        _iframe.setAttribute('src', src)
        _iframe.setAttribute('style', 'display:none;')
        document.body.appendChild(_iframe)
        _iframe.parentNode.removeChild(_iframe)
        _iframe = null
      },
      initDetailData() {
        this.getWininfo()
        this.getDetailByPid(this.$route.params.pdId, resp => {
          this.loading =false
          let result = resp.data
          if (result.code == 100022) {
            this.netError = true
            this.errorMsg = result.msg
          } else {
            this.detail = result.data
            this.activityName = result.data.name
            this.activityTheme = result.data.theme
            this.activityType = result.data.activityType
            if (this.detail.activityStudentResource === 3) {
              this.boxType = 'rank'
            } else {
              this.boxType = 'video'
            }
          }
        })
      },
      getDetailByPid(activityId,callback) {
        axios.get(`/rest/activity/api/activity/user/activity/getActivityDetailByActivityId/${activityId}`)
          .then((res) => {
            callback(res)
          })
          .catch((res) => {
            this.netError = true
            this.loading = false
            callback(res)
          })
      },
      openVideo(e) {
        if (!this.showBox && (e.target.className == 'video-box') || (e.target.className == 'pd-detail-label')) {
          this.showBox = true
        }else if(this.showBox && (e.target.className == 'video-box') || (e.target.className == 'pd-detail-label')){
          this.showBox = false
        }
      },
      getWininfo() {
        axios.get(`/rest/activity/api/activity/user/message/getMessage/${this.$route.params.pdId}`)
          .then((res) => {
            if (res.data.data.status === 0) {
              this.winnerType = res.data.data.content
              this.winner = true
              this.awardsImage = res.data.data.awardsImage
              setTimeout(() => {
                this.winner = false
              }, 3000)
            } else {
              this.winner = false
            }
          })
          .catch((err) => {
            this.loading = false
          })
      },
      closeWinner(){
        this.winner = false
      },
      selectLevel(id){
        this.partitionId = id
      },
      goJoin(type) {
        if (type == 'numClass') {
          this.loading = false
        } else if (type) {
          this.loading = true
        } else {
          this.warnTips = true
          this.loading = false
        }
      },
      errorReload(){
        this.$playSound("click")
        setTimeout(() => {
          window.location.reload()
        }, 500)
      },
      touchScroll(e){
      },
      closeRule(key){
        if (key) {
          this.rule = false
        }
      },
      openRule(type){
        this.$playSound("click")
        if (type === 'activity') {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_ActivityDescription'})
        } else {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_UploadDescription'})
        }
        this.rule = true
        this.ruleType = type
        this.loading = false
      },
      showVideoBox(){
        this.$playSound("click")
        if (this.detail.activityStudentResource !== 3) {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_rankingFloatingEntrance_during'})
        } else {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_WinnersFloatingEntrance_after'})
        }
        this.showBox = !this.showBox
      },
      userSrollDown(evt, flag) {
        if (evt.wheelDelta) { //判断浏览器IE，谷歌滑轮事件
          if (flag === 'pd-detail-video') {
            if (evt.wheelDelta > 0) {
              if (evt.target.className !== 'video-box' && evt.target.className !== 'pd-detail-bottom') {
                let ele = document.getElementsByClassName('pd-detail-thumb')[0]
                if (ele.scrollTop == 0 && evt.wheelDelta > 100) {
                  this.showBox = false
                }
              } else {
                this.showBox = false
              }
            } else {
              this.showBox = true
            }
          } else {
            evt.wheelDelta > 0 ? this.showBox = false : this.showBox = true
          }
        } else if (evt.detail) { //Firefox滑轮事件
          if (flag === 'pd-detail-video') {
            if (evt.delta > 0) {
              if (evt.target.className !== 'video-box' && evt.target.className !== 'pd-detail-bottom') {
                let ele = document.getElementsByClassName('pd-detail-thumb')[0]
                if (ele.scrollTop == 0 && evt.delta > 100) {
                  this.showBox = false
                }
              } else {
                this.showBox = false
              }
            } else {
              this.showBox = true
            }
          } else {
            evt.delta > 0 ? this.showBox = false : this.showBox = true
          }
        }

      },
      goUpload(){
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_agree_uploadRule'})
        this.loading = true
        axios.post(`/rest/activity/api/activity/user/activity/setActivityStudentRulesRecordAgree`)
          .then((res) => {
            this.loading = false
            if (res.data.code === 0) {
              this.checkWorkWall()
            }
          })
          .catch((err) => {
            this.loading = false
          })
      },
      checkWorkWall(){
        axios.get(`/rest/activity/api/activity/user/resource/getResourcesByActivityIdAndStudentId/${this.$route.params.pdId}/1/1`)
          .then((res) => {
            if (res.data.code === 0) {
              if (!res.data.data) {
                this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
                return
              }
              if (res.data.data.list.length) {
                this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}`})
              } else {
                this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
              }

            }
          })
          .catch((err) => {
            this.loading = false
            // this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}`})
          })
      },
      touchStart(e){
        this.startClientY = e.touches[0].clientY
      },
      touchMove(e){
        this.endClientY = e.touches[0].clientY
      },
      touchEnd(e){
        if (parseInt(this.endClientY - this.startClientY) < -50 && this.endClientY !== 0) {
          this.showBox = true
        }

        if (this.endClientY - this.startClientY > 100 && this.endClientY !== 0) {
          let ele = document.getElementsByClassName('pd-detail-thumb')[0]
          if (ele.scrollTop == 0) {
            this.showBox = false
          }
        }
        this.endClientY = 0
        this.startClientY = 0
      }
    }
  }
</script>

<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
    outline: none
    -webkit-tap-highlight-color: transparent
  .pd-dialog
    .mirror
      position: absolute
      top: 0
      bottom: 0
      left: 0
      right: 0
      background: rgba(0,0,0,0.5)
      z-index: 14
    .pd-dialog-box-pcapp
      width: 691px
      height: 444px
      background-color: #a18ee3
      box-shadow: 3px 2px 16px 0px #37185c
      border-radius: 20px
      padding: 53px 14px 1px 14px
      margin: -222px 0 0 -345px
      position: absolute
      top: 50%
      left: 50%
      z-index: 15
      .prview-model
        width: 370px
        height: 261px
        background: url("../../img/project_demo/pet_model_small.png") no-repeat
        background-size: 100%
        position: absolute
        top: 110px
        left: 60px
        border: 5px solid #D6D1E8
        border-radius: 20px
      .qrcode
        width: 160px
        height: 160px
        position: absolute
        top: 140px
        right: 60px
      .qrcode-desc
        position: absolute
        top: 310px
        right: 57px
        color: #777777
        font-size: 18px
        width: 170px
        text-align: center
      .notice-img
        width: 228px
        height: 88px
        position: absolute
        right: 184px
        top: -83px
        z-index: 14
        background: url("../../img/project_demo/notice.png") no-repeat
        background-size: contain
      h4
        font-size:22px
        color: white
        line-height:21px
        text-align: center
        position: absolute
        top: 18px
        width: 100%
        margin-left: -14px
      .close
        width: 60px
        height: 60px
        position: absolute
        right: -28px
        top: -20px
        z-index: 14
        background: url("../../img/project_demo/workwall2.png") no-repeat
        background-size: 160px
        background-position: -60px -60px
        border-radius: 20px
        cursor: pointer
      .white-board
        width: 100%
        height: 94%
        background: #fff
        border-radius: 20px
        padding: 40px
        box-shadow: 0 0 1px 2px #9886D7
        .btn
          width: 123px
          height: 35px
          line-height: 35px
          text-align: center
          cursor: pointer
          color: white
          position: absolute
          background-repeat: no-repeat
          background-size: 100% 100%
          &.right
            background-image: url("../../img/project_demo/upload_status_1.png")
            bottom: 46px
            right: 66px
          &.left
            background-image: url("../../img/project_demo/upload_status_2.png")
            bottom: 46px
            left: 66px
    .pd-dialog-box
      width: 420px
      height: 282px
      background-color: #a18ee3
      box-shadow: 3px 2px 16px 0px #37185c
      border-radius: 20px
      padding: 53px 14px 1px 14px
      margin: -140px 0 0 -210px
      position: absolute
      top: 50%
      left: 50%
      z-index: 15
      .notice-img
        width: 228px
        height: 88px
        position: absolute
        right: 50px
        top: -83px
        z-index: 14
        background: url("../../img/project_demo/notice.png") no-repeat
        background-size: contain
      h4
        font-size:22px
        color: white
        line-height:21px
        text-align: center
        position: absolute
        top: 20px
        width: 100%
        margin-left: -14px
      .close
        width: 60px
        height: 60px
        position: absolute
        right: -28px
        top: -20px
        z-index: 14
        background: url("../../img/project_demo/workwall2.png") no-repeat
        background-size: 160px
        background-position: -60px -60px
        border-radius: 20px
        cursor: pointer
      .white-board
        width: 100%
        height: 94%
        background: #fff
        border-radius: 20px
        padding: 40px
        box-shadow: 0 0 1px 2px #9886D7
        p
          color: #777777
          font-size: 21px
          text-align: center
        .btn
          width: 123px
          height: 35px
          line-height: 35px
          text-align: center
          cursor: pointer
          color: white
          position: absolute
          background-repeat: no-repeat
          background-size: 100% 100%
          &.right
            background-image: url("../../img/project_demo/upload_status_1.png")
            bottom: 46px
            right: 66px
          &.left
            background-image: url("../../img/project_demo/upload_status_2.png")
            bottom: 46px
            left: 66px
  .model-download-btn
    width: 140px
    height: 40px
    line-height: 40px
    text-align: center
    background-image: url("../../img/project_demo/zhuangbei_download_btn.png")
    background-size: 100% 100%
    background-repeat: no-repeat
    position: absolute
    top: 71px
    right: 20px
    cursor: pointer
    z-index: 12
    color: white
    &:hover
      opacity: 0.8
  .warn-tips
    width: 100%
    height: 100%
    position: absolute
    top: 0
    left: 0
    background: rgba(0, 0, 0, 0.8)
    z-index: 8
    font-family: PingFangSC
    color: #fff
    text-align: center
    font-size: 20px
    padding-top: 200px
    img
      width: 240px

  .net-mask
    width: 100%
    height: 100%
    position: absolute
    top: 0
    left: 0
    z-index: 6
    background: rgba(0, 0, 0, 0.6)

  .pd-toolkit
    right: 0
    top: 50%
    position: absolute
    width: 40px
    height: 140px
    background: rgba(200, 119, 232, 1)
    border-radius: 20px 0px 0px 20px
    opacity: 0.7
    font-size: 18px
    text-align: center
    cursor: pointer
    z-index: 8
    transform: translateY(-60%)
    -webkit-transform: translateY(-60%)
    transform: scale(1.2, 1.2)
    &:active
      opacity: 1
    &:hover
      opacity: 1
    .rank-icon
      width: 20px
      height: 15px
      display: inline-block
      margin-top: 15px
      background: url("../../img/project_demo/detail.png") no-repeat
      background-position: bottom left
      background-size: 160px
    .tips
      margin-top: 3px
      width: 30px
      display: inline-block
      color: #fff
      line-height: 18px
      -webkit-font-smoothing: antialiased
    .triangle
      width: 14px
      height: 16px
      display: inline-block
      margin-top: 4px
      background: url("../../img/project_demo/detail.png") no-repeat
      background-size: 160px
      background-position: -146px -64px
      &.active
        background-position: -146px -80px

  .pd
    background: #652a8c url("../../img/project_demo/bg.png") no-repeat
    background-size: 100% auto
    overflow-x: hidden
    .pd-mask-container
      border: 1px solid black
      width: 100%
      height: 578px
      background: rgba(0, 0, 0, 0)
      position: absolute
      z-index: 4
    .net-mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background: rgba(0, 0, 0, 0.6)
    .pd-detail-container
      width: 100%
      overflow: hidden
      position: relative
      transition-duration: 1s
      margin-top: 78px;
      .pd-detail-video
        width: 1024px
        height: calc(100% - 78px)
        top: 678px
        display: inline-block
        position: fixed
        z-index: 2
        transition-duration: 1s
        left: 50%
        transform: translateX(-50%)
        -webkit-transform: translateX(-50%)
        &.active
          top: 78px
        @media only screen and (min-width: 1500px)
          width: 1352px
        .pd-detail-bottom
          background: #bba4fa
          height: 100%
          border-radius: 30px 30px 0 0

  .pd-tips
    width: 120px
    top: 20px
    right: 20px
    position: absolute
    height: 38px
    z-index: 13
    cursor: pointer
    line-height: 18px
    .tips-btn
      background: url("../../img/project_demo/question_mark.png") no-repeat
      background-size: 100% 100%
      position: absolute
      z-index: 13
      width: 36px
      height: 36px
      left: 0
      &:after
        content: " "
        display: inline-block
        width: 36px
        height: 36px
        border-radius: 28px
        display: none
        position: absolute
      &:hover
        &:after
          background: rgba(255, 255, 255, 0.3)
          display: inline-block
      &:active
        &:after
          background: rgba(0, 0, 0, 0.3)
          display: inline-block
    span
      position: absolute
      color: #fff
      font-size: 18px
      right: 0
      top: 10px
</style>

