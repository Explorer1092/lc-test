<template lang="jade">
  transition(name="extension",enter-active-class="animated fadeInRight",leave-active-class="animated fadeOutRight")
  	.upload-container(v-if="work",style="min-height: 700px;")
  		video-box(v-if="!ipad",:videoSrc="work.url",:autoPlay="false",:playEndAction="playEndAction",:source="source",:materialId="currentMaterialId",@fullScreen="fullScreen",:pd="'border-radius: 25px 25px 0 0;margin: 0 auto;'")
  		pd-back(:title_cn="work.name",:gobackurl="backUrl", :isRedirect="isRedirect")
  		.ipad-video-box(v-if="ipad",style="overflow: hidden;")
  			img(v-if="!ipadVideo",:src="work.coverImage")
  			.play-status(v-if="!ipadVideo",@click="playVideo")
  			video(v-show="ipad&&ipadVideo",:src="work.url",controls="controls",ref="video2")
  		.video-desc(v-if="!full&&!ipadFullVideo")
  			.tips(v-if="work.status === 0 || work.status === 5",v-html="tips",:class="{'error':work.status === 5}")
  			.ele.avatar
  				img(src = "../../img/common/avatar/default.png", v-if = "!work.avatarUrl && (work.avatar == 'default'||!work.avatar)")
  				img(src = "../../img/common/avatar/boy_1.png", v-if = "!work.avatarUrl && work.avatar == 'boy_1'")
  				img(src = "../../img/common/avatar/boy_2.png", v-if = "!work.avatarUrl && work.avatar == 'boy_2'")
  				img(src = "../../img/common/avatar/boy_3.png", v-if = "!work.avatarUrl && work.avatar == 'boy_3'")
  				img(src = "../../img/common/avatar/boy_4.png", v-if = "!work.avatarUrl && work.avatar == 'boy_4'")
  				img(src = "../../img/common/avatar/girl_1.png", v-if = "!work.avatarUrl && work.avatar == 'girl_1'")
  				img(src = "../../img/common/avatar/girl_2.png", v-if = "!work.avatarUrl && work.avatar == 'girl_2'")
  				img(src = "../../img/common/avatar/girl_3.png", v-if = "!work.avatarUrl && work.avatar == 'girl_3'")
  				img(src = "../../img/common/avatar/girl_4.png", v-if = "!work.avatarUrl && work.avatar == 'girl_4'")
  				img(:src = "work.avatarUrl", v-if="work.avatarUrl")
  			.ele.name
  				| {{work.stuEnglishName}}
  				span(v-if="work.studentId == studentId")
  			.ele.time(style="opacity: 0.5;") {{work.ago}}
  			.ele.model(@click="showBubble('model')",v-if="work.awardName")
  				.icon(v-if="!award.awardsImage",:class="'icon-'+winnerType")
  				img.icon(v-if="award.awardsImage",:src="award.awardsImage")
  				|{{work.awardName}}
  			.ele.rank(@click="showBubble('rank')",v-if="award")
  				.bubble(v-show="bubble === 'rank'")
  					h1 {{award.activityName}}
  					h2 （{{award.partitionName}}）
  				.icon(:class="'rank-'+work.rank")
  				|排名
  				.pm(v-if="work.rank > 2") {{fullNum(work.rank)}}
  			.ele.vote.ing(v-show="work.status === 2 && !award",style="right: 10px;")
  				.vote-heart(:class="{'liked':liked}", @click='vote')
  					.vote-num(style="width: 80px;") {{fixNum(count)}}
  			a.ele.vote(@click="showBubble('vote')",v-if="work.count && award")
  				.bubble(v-show="bubble === 'vote'")
  					h1
  						|总票数:
  						span {{work.count}}
  					h1
  						|学习中心票数:
  						span {{work.countFromVipkid}}
  					h1
  						|微信票数:
  						span {{work.countFromWx}}
  				.arrow
  				|{{work.count}}票
  		.revoke(v-if="work.status === 2 && studentId == work.studentId && award === null && String(work.activityType) !== '7'",@click="revokeDialog")
  		.share(@click="shareDialog",:class="{'unshare':work.status !== 2}")
  		dialog-box(v-show="showDialog",@dialogClick="dialogClick",:title="dialogTitle",:tips="dialogTips",:type="dialogType",:url="shareUrl",class="animated fadeIn")
  		model-box(v-show="modelDialog",@dialogClick="dialogClick",:model="award",:awardName="work.awardName")
  		.dino-tips(v-show="dinoTips")
  			span {{errorMsg}}
</template>
<script>
  import axios from 'axios'
  import arrowBox from '../common/arrow.vue'
  import pdBack from './components/pd_back.vue'
  import dialogBox from './components/dialog.vue'
  import modelBox from './components/model.vue'
  import videoBox from './common/vk_video.vue'
  import Toolkit from './js/toolkit.js'
  import cookies from 'cookies-js'
  export default {
    mixins: [],
    data(){
      return {
      	isAtLeftEnd: false,
      	isAtRightEnd: false,
      	isActive: true,
      	type: 'upload',
      	title: '',
      	delFlag: false,
      	showDialog: false,
      	dialogType: '',
      	dialogTitle: '撤销作品',
      	dialogTips: '撤销参赛后，该作品获得的投票数会被清零哦，宝贝确定要撤销吗？',
      	currentMaterialUrl: "https://video.vipkid.com.cn/class/vft/acbd13a4f4924e3995a9f82db339f537.mp4",
      	currentMaterialId: "2",
      	source: '23',
      	bubble: '',
      	modelType: 'normal', //奖牌类型
      	modelDialog: false,
      	tips : '审核中<br/>，<br/>仅自己可见',
      	work: null,
      	shareUrl: 'https://mobile.vipkid.com.cn/learning-effect/prd#/VideoInfo?resourceId=18800&activityId=2&partitionId=1',
      	award: null,
      	full: false,
      	backUrl: '',
      	liked: false,
      	studentId: cookies.get('studentId'),
      	count: 0,
      	partitionId: '',
      	dinoTips: false,
      	errorMsg: '',
      	ipad: false,
      	ipadFullVideo: false,
      	winnerType: 'default',
      	ipadVideo: false,
        host: 'https://a15-mobile.vipkid.com.cn',
        voteStatus: 0, // 投票状态(0:未开始；1:进行中；2:已结束)，默认是 0
        isRedirect: false
      }
    },
    props: {
    },
    components: {
    	pdBack,
    	dialogBox,
    	modelBox,
    	videoBox
    },
    mounted() {
	  if (this.$route.params.pdId) {
        this.isRedirect = true
        this.backUrl = `/project_detail/${this.$route.params.pdId}`
	  }
      let host = window.location.host
      let index = host.search('lc.vipkid.com.cn')
      if (index !== -1) {
        if (index === 0) {
          this.host = 'https://mobile.vipkid.com.cn'
        }else{
          if (host.search('pre') > -1) {
            this.host = 'https://pre-mobile.vipkid.com.cn'
          }else{
            this.host = 'https://a15-mobile.vipkid.com.cn'
          }
        }
      }
    	this.ipad = this.IS_IN_IPAD_APP
    	axios.get(`/rest/activity/api/activity/user/resource/getStudentResourceById/${this.$route.params.videoId}`)
	    .then((res) => {
          this.work = res.data.data
          this.voteStatus = this.work.voteStatus // 设置投票状态信息,以此来判断 是否可以点击进行投票
	    	if (this.work.status === 5) {
	    		this.tips = "<i style='display:inline-block;width: 16px;height: 16px;background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////neHiwAAAAF3RSTlMA8oDGDFzh36yRcVY3LiMaB9XUs2VeQEKP0e8AAACvSURBVCjPfZLZDoQgDEVbWWQRxPX+/58Ow5hUTZjzRDjkFkrpR8nGLcyLM7nQjclbXFg/yf4x4sZ40MXOAKuQtE5Bfdf7dZ4BFTU1dFTVmJZfc7ZZcuetptU6xQOq7Q/A0IwCfKFswZHugiLDZjKA0k+hFWDIAYGeggLgaAHSWyRgJQb0W2iA+0KizmE4JUqKN6R497rdB3Zb0mtit+39j2qY59ea/8Mg47MyrzI+Hx8dEeFn6TblAAAAAElFTkSuQmCC) no-repeat;background-size: 100% 100%;'></i>作品内容与主题不符<br/>，<br/>已从大赛区下架"
	    	}
	    	this.work.ago = Toolkit.getTime(this.work.gmtCreate)
	    	this.count = this.work.count
          if(this.work.url.indexOf('mp4thumb') > -1 && this.work.url.indexOf('avthumb') == -1 ){
            this.dinoTips = true
            this.errorMsg = '远程视频解码中,暂不能播放'
          }
	    	if (this.work.partitionList&&this.work.partitionList.length) {
	    		this.partitionId = this.work.partitionList[0].id
	    	}
	    	this.liked = this.work.liked === 2 ? false: true
	    	if (this.work.awardName.indexOf('优秀') > -1) {
	    		this.winnerType = 'excellent'
	    	}else if (this.work.awardName.indexOf('人气') > -1) {
	    		this.winnerType = 'popular'
          }
	    })
	    .catch((err) => {
	    })

	    this.getAward()
    },
    updated(){
    	if (this.IS_IN_IPAD_APP) {
    		this.fullll()
    	}
    },
    methods: {
    	fullNum(num){
    		num++
    		if (num<10) {
    			return '00'+num
    		}
    		if (num<100) {
    			return '0'+num
    		}
    		if (num>999) {
    			return '999+'
    		}
    	},
    	fixNum(num){
    		if (num>9999) {
    			return (num/10000).toFixed(1)+'w'
    		}else{
          return num
        }
    	},
    	playVideo(){
    		this.ipadVideo = true
    		this.$refs.video2.play()
    	},
    	fullll(){
    		let that = this
    		this.$refs.video2.addEventListener("webkitfullscreenchange", function(e) {
				  if (!document.webkitIsFullScreen) {
				    that.ipadFullVideo = false
				  }else{
				    that.ipadFullVideo = true
				  }
        })
    	},
    	vote(id){
      	// voteStatus (integer, optional): 投票信息枚举 0:未开始 1:进行中 2:已结束
        if(this.voteStatus === 0 || this.voteStatus === 2) return // 0 || 2 状态下不能投票

        if (!this.liked) {
          this.liked = true
          this.count++
        }else{
          this.liked = false
          this.count--
        }
    		axios.post('/rest/activity/api/activity/user/like',
          JSON.stringify({partitionId: this.partitionId,resourceId: this.work.id}),
          {headers: {'Content-Type': 'application/json'}})
          .then((res) => {
          })
    	},
    	getVoteCounts(){
        axios.get('/rest/activity/api/activity/user/like/detail',{
          params: {
            partitionId: this.partitionId,
            resourceId: this.work.id
          }}).then((res) => {
          if (res.data.data !== null) {
            this.liked = res.data.data[0].liked === 2 ? false: true
            this.count = res.data.data[0].count
          }else{
            this.liked = false
            this.count = 0
          }
        })
      },
    	fullScreen(state){
    		this.full = !state
    	},
    	getAward(){
    		axios.get(`/rest/activity/api/activity/user/award/getStudentAwardInfo/${this.$route.params.videoId}`)
		    .then((res) => {
		    	this.award = res.data.data
		    })
		    .catch((err) => {
		    })

    	},
    	styleInit(){
		  	this.tips = this.tips.replace(/，/g, "<br/>，<br/>")
		  	// this.tips = this.tips.replace(/,/g, "<br/>,<br/>")
    	},
    	stopDel(e){
    		if(e.target.className == 'mask-shadow'){
    			this.delFlag = false
    			this.modelDialog = false
    			this.showDialog = false
    			this.bubble = ''
    		}
    		if (e.target.className == 'video-player' || e.target.className == 'video-panel' || e.target.className == 'video-desc') {
    			this.bubble = ''
    		}
    	},
    	revokeDialog(){
    		this.$playSound("click")
    		sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_mySubmission_recalled'})
    		// if(document.getElementsByClassName('video-player').length){
    		// 	document.getElementsByClassName('video-player')[0].pause()
    		// }
    		this.dialogType = 'normal'
    		this.showDialog = true
    		this.dialogTitle = '撤销作品'
    		this.dialogTips = '撤销后，新作品需要重新积累投票哦，宝贝确定要撤销吗？'
    	},
    	shareDialog(){
    		if(this.work.status != 2){
    			return
    		}
    		this.$playSound("click")
    		let activityId = this.work&&this.work.partitionList&&this.work.partitionList[0].activityId
      	let partitionId = this.work&&this.work.partitionList&&this.work.partitionList[0].id
    		sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_mySubmission_share'})
    		// if(document.getElementsByClassName('video-player').length){
    		// 	document.getElementsByClassName('video-player')[0].pause()
    		// }
    		this.dialogType = 'share'
    		this.showDialog = true
    		this.dialogTitle = '宝贝作品专属二维码'
        this.dialogTips = '微信分享作品，为自己拉票哦！'
        //此处用活动类型 activityType 但是修改比较大 作品接口中没有返回活动类型 判断更好，此处直接写上线上地址
        if (activityId == 65) {
          this.shareUrl = `https://activity.vipkid.com.cn/activity/pdShare?activityId=${activityId}&resourceId=${this.$route.params.videoId}&parentId=${cookies.get("parentId")}`
        } else if (activityId == 66) {
          this.shareUrl = `https://activity.vipkid.com.cn/activity/pdPetShare?activityId=${activityId}&resourceId=${this.$route.params.videoId}&parentId=${cookies.get("parentId")}`
        } else {
          if (String(this.work.activityType) === '7') {
            this.shareUrl = `${this.host}/learning-effect/prd/ust-video-info?resourceId=${this.$route.params.videoId}&activityId=${activityId}&partitionId=${partitionId}`
          } else {
            this.shareUrl = `${this.host}/learning-effect/prd/VideoInfo?resourceId=${this.$route.params.videoId}&activityId=${activityId}&partitionId=${partitionId}`
          }
        }
    	},
    	dialogClick(key){
    		if (key === 'cancel') {
    			this.showDialog = false
    			this.modelDialog = false
    		}else{
    			if (key === 'confirm') {
    				sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_mySubmission_recalled_confirm'})
    				axios.post(`/rest/activity/api/activity/user/resource/exitActivityByResourceId/${this.$route.params.videoId}`)
		        .then((res) => {
		        	if (res.data.code === 0) {
		        		window.location.reload()
		        	}else{
		        		this.dinoTips = true
    						this.showDialog = false
    						this.errorMsg = '作品状态异常'
    						setTimeout(()=>{
    							this.dinoTips = false
    						},2500)
		        	}
		        })
		        .catch((err) => {
		        })
    			}
    		}
    	},
    	arrowClick(){

    	},
    	upload(){
    		this.$router.push({path: `/pd_upload`})
    	},
    	deleteSwitch(){
    		this.delFlag = !this.delFlag
    	},
    	playEndAction(){

    	},
    	showBubble(key){
    		sa.track('learning_click', {'click_id': `pc_learning_activity_competitionArena_competition_mySubmission_checkMy${key}`})
    		if (key === 'model') {
    			this.modelDialog = true
    			return
    		}
    		if (this.bubble === key) {
    			this.bubble = ''
    		}else{
    			this.bubble = key
    		}
    	}
    }
  }
</script>

<style lang="stylus" scoped>
	*
		box-sizing: border-box
		-moz-user-select: none
		-webkit-user-select: none
		-ms-user-select: none
		-khtml-user-select: none
		user-select: none
		-webkit-font-smoothing: antialiased
	.warning
		display: inline-block
		width: 16px
		height: 16px
		border: 1px solid #fff
	.upload-container
		background: #652a8c url("../../img/project_demo/bg.png") no-repeat
		background-size: 100% auto
		color: #fff
		text-align: center
		padding: 120px 240px 170px 240px
		@media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
				padding: 130px 120px 160px 120px
		.tips
			width: 30px
			min-height: 200px
			background:rgba(255,102,0,0.8)
			border-radius: 0 16px 16px 0
			position: absolute
			right: -30px
			top: -440px
			padding-top: 20px
			padding-bottom: 20px
			@media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
				top: -55vh
			&.error
				background:rgba(255,0,0,0.8)
		.revoke
			width: 58px
			height: 58px
			background: url("../../img/project_demo/workwall2.png") no-repeat
			background-position: 0 0
			background-size: 155px
			position: fixed
			right: 100px
			top: 20px
			cursor: pointer
			z-index: 11
			&:after
				content:" "
				display: inline-block
				width: 58px
				height: 58px
				border-radius: 28px
				display: none
			&:hover
				&:after
					background: rgba(255,255,255,0.3)
					display: inline-block
			&:active
				&:after
					background: rgba(0,0,0,0.3)
					display: inline-block
		.share
			width: 58px
			height: 58px
			background: url("../../img/project_demo/workwall2.png") no-repeat
			background-position: -58px 0
			background-size: 155px
			position: fixed
			right: 20px
			top: 20px
			cursor: pointer
			z-index: 11
			&.unshare
				background: url("../../img/project_demo/workwall2.png") no-repeat
				background-position: 0 -116px
				background-size: 155px
			&:after
				content:" "
				display: inline-block
				width: 58px
				height: 58px
				border-radius: 28px
				display: none
			&:hover
				&:after
					background: rgba(255,255,255,0.3)
					display: inline-block
			&:active
				&:after
					background: rgba(0,0,0,0.3)
					display: inline-block
		.video-box
			width: 100%
			height: 100%
			text-align: left
			border-radius: 25px 25px 0 0
			background: #8561ED
			padding: 5px
			.video-content
				.video-mask
					display: none
		.ipad-video-box
			background: #4d308b
			width: 100%
			height: 100%
			border-radius: 25px 25px 0 0
			text-align: center
			position: relative
			margin: 0 auto
			border: 4px solid #8466e9
			video
				height: 100%
				max-width: 100%
			img
				height: 100%
			.play-status
				display: inline-block
				width: 60px
				height: 60px
				background: url("../../img/project_demo/play_status.png") no-repeat
				background-size: 100% 100%
				position: absolute
				top: 50%
				left: 50%
				cursor: pointer
				transform: translate(-50%,-50%)
				-webkit-transform: translate(-50%, -50%)
		.dino-tips
			position: absolute
			font-size: 14px
			width: 370px
			height: 110px
			left: 50%
			top: 50%
			transform: translate(-50%,-50%)
			-webkit-transform: translate(-50%, -50%)
			background: url("../../img/project_demo/dino_tips.png")
			background-size: 100% 100%
			color: #000
			span
				display: inline-block
				margin-left: 100px
				width: 260px
				margin-top: 50px
				font-size: 20px
		.video-desc
				width: 100%
				height: 60px
				margin: 0 auto
				background: #8561ed
				border-radius: 0 0 20px 20px
				position: relative
				margin-top: -1px
				text-align: left
				.ele
					display: inline-block
					position: absolute
				.avatar
					width: 40px
					height: 40px
					border-radius: 20px
					left: 20px
					top: 8px
					img
						width: 100%
						height: 100%
						border-radius: 20px
				.name
					left: 76px
					top: 8px
					font-size: 18px
					span
						display: inline-block
						width: 24px
						height: 14px
						background: url("../../img/project_demo/rank.png") no-repeat
						background-size: 70px
						background-position: -44px -44px
				.time
					left: 76px
					top: 30px
					font-size: 14px
				.model,.rank
					position: relative
					min-width: 90px
					height: 50px
					background: rgba(0,0,0,0.1)
					border-radius: 10px
					text-align: left
					line-height: 48px
					padding-left: 10px
					font-size: 14px
					cursor: pointer
					.icon
						width: 30px
						height: 38px
						display: inline-block
						position: absolute
						right: 5px
						top: 5px
				.rank
					margin-left: 15px
					.icon
						&.rank-0
							background: url("../../img/project_demo/detail.png") no-repeat
							background-size: 82px
							background-position: -30px 1px
						&.rank-1
							background: url("../../img/project_demo/detail.png") no-repeat
							background-size: 82px
							background-position: 0 -37px
						&.rank-2
							background: url("../../img/project_demo/detail.png") no-repeat
							background-size: 82px
					.pm
						font-size: 20px
						position: absolute
						right: 5px
						top: 2px
					.bubble
						width: 240px
						height: 124px
						position: absolute
						top: -122px
						left: -70px
						background: url("../../img/project_demo/bubble.png") no-repeat
						background-size: 100% 100%
						text-align: center
						h1,h2
							width: 100%
							color: #371575
							height: 20px
							margin-top: 15px
						h1
							font-weight: 700
							font-size: 20px
						h2
							font-size: 18px
				.model
					margin-left: 220px
					padding-right: 40px
					.icon
						background: url("../../img/project_demo/default.png") no-repeat
						background-size: 100% 100%
						&.icon-excellent
							background: url("../../img/project_demo/rank.png") no-repeat
							background-size: 60px
						&.icon-popular
							background: url("../../img/project_demo/rank.png") no-repeat
							background-size: 60px
				.vote
					text-decoration: underline
					right: 30px
					top: 18px
					cursor: pointer
					.bubble
						width: 240px
						height: 124px
						position: absolute
						top: -130px
						left: -80px
						background: url("../../img/project_demo/bubble.png") no-repeat
						background-size: 100% 100%
						text-align: left
						h1
							width: 100%
							color: #371575
							font-size: 18px
							padding-left: 10px
							margin: 10px 0
							@media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
								margin: 6px 0
							&:nth-of-type(1)
								span
									color: red
							&:nth-of-type(2)
								span
									color: blue
							&:nth-of-type(3)
								span
									color: green
					.arrow
						width: 16px
						height: 16px
						display: inline-block
						background: url("../../img/project_demo/detail.png") no-repeat
						background-size: 210px
						background-position: -193px -103px
						margin-right: 3px
				.ing
					width: 100px
					height: 30px
					position: absolute
					text-align: left
					top: 16px
					.vote-heart
						display: inline-block
						width: 36px
						height: 30px
						background: url("../../img/project_demo/detail.png") no-repeat
						background-size: 145px
						background-position: -106px 0
						position: absolute
						z-index: 3
						&.liked
							background: url("../../img/project_demo/detail.png") no-repeat
							background-size: 145px
							background-position: -106px -30px
					.vote-num
						display: inline-block
						color: #fff
						position: absolute
						top: 2px
						left: 16px
						text-align: center
						width: 66px
						height: 28px
						background: url("../../img/project_demo/rectangle@3x.png")
						background-size: 100% 100%
						line-height: 28px
						padding-left: 12px
</style>

