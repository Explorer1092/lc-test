<template lang="jade">
  transition(name="extension",enter-active-class="animated fadeInRight",leave-active-class="animated fadeOutRight")
    .upload-container
      .mask-shadow(@click='stopDel($event)')
        pd-back(:title_cn="title",:gobackurl="backUrl")
        arrow-box(@arrowClick="arrowClick", :leftEnd = "isAtLeftEnd", :rightEnd = "isAtRightEnd")
        .upload-icon(v-if="type === 'upload'" @click="upload") 上传新作品
        .delete(:class="{'deleting': delFlag}",v-if="type !== 'upload'&&!!works.length" @click="deleteSwitch")
        .upload-box(v-if="works.length")
          .item-video(v-for="(item, i) in works",v-if="(type !== 'upload'&&item.status!== 4)||(type === 'upload'&&(item.status === 3 || item.status === 7))",:class="{'shake': delFlag,'upload': type === 'upload','checked': checkedId === item.id,'unchoice':item.status !== 3}",@click="!delFlag&&openVideo($event,item.id)")
            .delLabel(v-show="delFlag" @click="deleteDialog(item.id,item.status)",class="animated zoomIn")
            img(v-if="item.coverImage",:src="item.coverImage")
            img(v-if="!item.coverImage",src="../../img/project_demo/no_image.png")
            .play-status
            .tips(v-if="item.status === 5",v-html="tips[1]")
            .tips.tips-0(v-if="item.status === 0 || item.status === 6",v-html="tips[0]")
            .model(v-if="item.status === 2 && item.awardName",:class="dealName(item.awardName)")
            .join-status(v-if="item.status === 2 && !item.awardName") 参赛
            .name {{item.name}}
            .likes-box(v-if="type !== 'upload'")
              .time {{item.ago}}
              .like(v-if="item.status === 2&&item.awardName") {{item.count}}
              .vote(v-if="item.status === 2&&!item.awardName")
                .vote-heart(:class="{'liked':item.liked === 1}", @click='vote(i,item)')
                .vote-num {{fixNum(item.count)}}
        .null(v-if="!works.length")
          .dino
            .dino-null
            .text 这里还什么都没有
        dialog-box(v-show="showDialog",@dialogClick="dialogClick",:title="'删除作品'",:tips="dialogTips")
        loading(v-show="loading")
        .net-mask
          net-error(v-show="netError")
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import arrowBox from './components/_arrow.vue'
  import pdBack from './components/pd_back.vue'
  import dialogBox from './components/dialog.vue'
  import Toolkit from './js/toolkit.js'
  import loading from '../common/vk_loading.vue'
  import netError from '../common/vk_net_error.vue'
  export default {
    mixins: [],
    data(){
      return {
        isAtLeftEnd: false,
        isAtRightEnd: false,
        imgSrc: "https://media.vipkidstatic.com/homework/image/grow_c5fcab32-8ac6-44ba-b67d-77e7d2290e371526561151989.png",
        isActive: true,
        type: 'upload',
        title: '我的作品墙',
        delFlag: false,
        showDialog: false,
        dialogTips: '该作品是参赛作品哦，删除后会自动撤销参与比赛，确定要删除吗？',
        pageNo: 1,
        pageSize: 6,
        pages: null,
        works: [],
        deleteId: null,
        checkedId: '',
        pdId: '',
        tips : ["审核中，仅自己可见","<i style='display:inline-block;width: 16px;height: 16px;background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////neHiwAAAAF3RSTlMA8oDGDFzh36yRcVY3LiMaB9XUs2VeQEKP0e8AAACvSURBVCjPfZLZDoQgDEVbWWQRxPX+/58Ow5hUTZjzRDjkFkrpR8nGLcyLM7nQjclbXFg/yf4x4sZ40MXOAKuQtE5Bfdf7dZ4BFTU1dFTVmJZfc7ZZcuetptU6xQOq7Q/A0IwCfKFswZHugiLDZjKA0k+hFWDIAYGeggLgaAHSWyRgJQb0W2iA+0KizmE4JUqKN6R497rdB3Zb0mtit+39j2qY59ea/8Mg47MyrzI+Hx8dEeFn6TblAAAAAElFTkSuQmCC) no-repeat;background-size: 100% 100%;position: absolute;left: 12px;top: 3px'></i>作品内容与主题不符，已从大赛区下架"],
        loading: true,
        netError: false,
        backUrl: ''
      }
    },
    components: {
      pdBack,
      arrowBox,
      dialogBox,
      loading,
      netError
    },
    created(){
      
    },
    mounted() {
      this.type = this.$route.params.type
      if (this.type === 'upload') {
        this.pdId = this.$route.params.pdId
        this.title = '从作品墙中选择'
      }
      setTimeout(()=>{
        this.init()
      },200)
    },
    updated(){
      document.getElementsByTagName('body')[0].style.overflow = 'hidden'
      if(document.body.clientWidth > 1499){
        this.pageSize = 8
      }
    },
    methods: {
      dealName(name){
        if (name.indexOf('优秀')> -1) {
          return 'model-1'
        }else if (name.indexOf('人气')> -1) {
          return 'model-2'
        }else{
          return 'model-3'
        }
      },
      fixNum(num){
        if (num>9999) {
          return (num/10000).toFixed(1)+'w'
        }else{
          return num
        }
      },
      vote(i,item){
        let partitionId = null
        if (item.partitionList) {
          partitionId = item.partitionList[0].id
        }
        if (item.liked !== 1) {
          item.liked = 1
          item.count++
          this.$set(this.works,i,item)
        }else{
          item.liked = 2
          item.count--
          this.$set(this.works,i,item)
        }
        axios.post('/rest/activity/api/activity/user/like',
          JSON.stringify({partitionId: partitionId,resourceId: item.id}),
          {headers: {'Content-Type': 'application/json'}})
          .then((res) => {
          })
      },
      init(pageNo){
        let _pageNo = pageNo || this.pageNo
        let url = `/rest/activity/api/activity/user/resource/getStudentResourceListByStudentId/${_pageNo}/${this.pageSize}`
        if (this.$route.params.type === 'upload') {
          url = `/rest/activity/api/activity/user/resource/getResourcesByActivityIdAndStudentId/${this.$route.params.pdId}/${_pageNo}/${this.pageSize}`
        }
        axios.get(url)
          .then((res) => {
            if (res) {
              this.loading = false
            }
            if (res.data.data === null) {
              this.works = []
              // this.upload()
            }
            this.pages = res.data.data.pages
            this.works = res.data.data&&res.data.data.list
            if (!this.works) {
              this.works = []
            }
            this.works.forEach((val, index) => {
              val.ago = Toolkit.getTime(val.gmtCreate)
            })
            if (this.works.length < this.pageSize) {
              if (_pageNo == 1) {
                this.isAtLeftEnd = true
                this.isAtRightEnd = true
              }else{
                this.isAtLeftEnd = false
                this.isAtRightEnd = true
              }
            }else{
              if (_pageNo == 1) {
                if (res.data.data.total <= this.pageSize) {
                  this.isAtLeftEnd = true
  	    				this.isAtRightEnd = true
        			}else{
        				this.isAtLeftEnd = true
		    				this.isAtRightEnd = false
        			}
		    			
		    		}
		    	}
		    	if (res.data.data.total <= this.pageSize) {
		    		this.isAtLeftEnd = true
		    		this.isAtRightEnd = true
		    	}
		    })
		    .catch((err) => {
		      this.isAtLeftEnd = true
		    	this.isAtRightEnd = true
		    })

    	},
    	openVideo(e,i){
    		if (e.target.className.indexOf('vote')>-1) {
    			return
    		}
    		this.$playSound("click")
    		if (this.type === 'upload') {
    			this.checkedId = i
    			this.$router.push({path: `/preview/${i}/${this.pdId}`})
    			// 预览
    			return
    		}
    		this.$router.push({path: `/pd_video/${i}`})
    	},
    	stopDel(e){
    		if(e.target.className == 'mask-shadow'){
    			this.delFlag = false
    		}
    	},
    	deleteDialog(i,status){
    		this.$playSound("click")
    		if (status === 2 || status === 0 || status === 6) {
    			this.showDialog = true
    			this.deleteId = i
    			if (status === 0 || status === 6) {
    				this.dialogTips = '该作品已经报名参加大赛，并且正在审核中，删除后会自动撤销比赛资格，确定删除吗？'
    			}else{
    				this.dialogTips = '该作品是参赛作品哦，删除后会自动撤销参与比赛，确定要删除吗？'
    			}
    		}else{
    			this.deleteId = i
    			this.dialogClick('confirm')
    		}
    	},
    	dialogClick(key){
    		this.$playSound("click")
    		if (key === 'cancel') {
    			this.showDialog = false
    			this.delFlag = false
    			this.deleteId = null
    		}else{
    			axios.post(`/rest/activity/api/activity/user/resource/deleteResourceByResourceId/${this.deleteId}`)
	          .then((res) => {
	            this.showDialog = false
	            this.deleteId = null
	            this.delFlag = false
	            this.init()
	          })
	          .catch((err) => {
	          })
    		}
    	},
    	arrowClick(direction){
    		this.loading = true
    		this.$playSound("click")
    		if(direction === 'left'){
    			this.pageNo--
    			if (this.pageNo>1) {
    				this.isAtRightEnd = false
    			}
    		}else{
    			this.isAtLeftEnd = false
    			this.pageNo++
    			if (this.pages > this.pageNo) {
    				this.isAtRightEnd = false
    			}else{
    				this.isAtRightEnd = true
    			}
    		}
    		if (this.pages >= this.pageNo) {
    			this.init()
    		}
    	},
    	upload() {
        this.$playSound("click")
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_upload_chooseNewVideo'})
        if ([5, 6].indexOf(parseInt(this.$route.params.activityType)) > -1) {
          // 万圣节活动
          if (cookies.get('isFromApp')) {
            this.$router.push({path: `/video_upload/${this.$route.params.pdId}`})
          } else {
            this.$router.push({path: `/video_upload/${this.$route.params.pdId}`})
          }
        } else {
          this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
        }
      },
    	deleteSwitch(){
    		this.$playSound("click")
    		this.delFlag = !this.delFlag
    	}
    }
  }
</script>

<style lang="stylus" scoped>
	.upload-container
		background: #652a8c url("../../img/project_demo/bg.png") no-repeat
		background-size: 100% auto
		color: #fff
		text-align: center
		.mask-shadow
			width: 100%
			height: 100%
			background: rgba(0,0,0,0.5)
			position: absolute
		.upload-icon
			width: 150px
			height: 50px
			background: url("../../img/project_demo/upload.png") no-repeat
			background-size: 100% 100%
			position: absolute
			right: 20px
			top: 40px
			font-size: 18px
			line-height: 48px
			padding-left: 30px
			cursor: pointer
			z-index: 11
		.delete
			width: 58px
			height: 58px
			background: url("../../img/project_demo/workwall2.png") no-repeat
			background-position: 0px -58px
			background-size: 155px
			position: absolute
			right: 30px
			top: 40px
			cursor: pointer
			z-index: 11
			&:after
				content:" "
				display: inline-block
				width: 58px
				height: 58px
				border-radius: 28px
				display: none
			&:hover
				&:after
					background: rgba(255,255,255,0.3)
					display: inline-block
			&:active
				&:after
					background: rgba(0,0,0,0.3)
					display: inline-block
			&.deleting
				background-position: -58px -116px
		.upload-box
			width: 1000px
			height: 530px
			text-align: left
			position: absolute
			top: 50%
			left: 50%
			transform: translate(-50%,-50%)
			-webkit-transform: translate(-50%, -50%)
			@media  only screen and (min-width : 1500px)
				width: 1320px
			.item-video
				display: inline-block
				width: 300px
				min-height: 202px
				border-radius: 20px
				background: #AF62D3
				margin: 10px
				text-align: center
				position: relative
				border: 4px solid transparent
				&:hover
					transition-duration: 1s	
					transform: scale(1.1, 1.1)					
				&.upload
					background: rgba(121,79,181,1)
					.unchoice
						opacity: 0.6
				&.checked
					border: 4px solid #FF6600
				.tips
					position: absolute
					top: 134px
					left: -4px
					width: 278px
					height: 24px
					line-height: 22px
					background: red
					border-radius: 0 0 16px 16px
					opacity: 0.8
					padding-left: 10px
					&.tips-0
						background: #FF6600
				.model
					width: 60px
					height: 76px
					position: absolute
					background: url("../../img/project_demo/rank.png") no-repeat
					background-size: 120px
					top: -10px
					left: -20px
					&.model-1
						background-position: 0 0
					&.model-2
						background-position: -60px 0
					&.model-3
						background: url("../../img/project_demo/default.png") no-repeat
						background-size: 100% 100%
				.join-status
					width: 60px
					height: 28px
					position: absolute
					background: url("../../img/project_demo/rectangle1.png") no-repeat
					background-size: 100% 100%
					top: -4px
					left: -4px
					color: #fff
					font-size: 18px
					line-height: 28px
				.delLabel
					width: 40px
					height: 40px
					position: absolute
					right: -18px
					top: -18px
					z-index: 5
					background: url("../../img/project_demo/workwall2.png") no-repeat
					background-position: -120px 0
					background-size: 160px
					cursor: pointer
				img
					width: 288px
					height: 162px
					margin-top: 5px
					border-radius: 16px
				.play-status
					width: 60px
					height: 60px
					background: url("../../img/project_demo/play_status.png") no-repeat
					background-size: 100% 100%
					position: absolute
					top: 26%
					left: 40%
					cursor: pointer
				.name
					position: absolute
					top: 170px
					left: 10px
					font-size: 18px
					color: rgba(253, 252, 139, 1)
					max-width: 200px
					height: 22px
					overflow: hidden
				.likes-box
					height: 66px
					position: relative
					.time
						position: absolute
						top: 2px
						right: 8px
						font-size: 14px
					.like
						position: absolute
						bottom: 8px
						right: 10px
					.vote
						width: 100px
						height: 30px
						position: absolute
						text-align: left
						top: 32px
						right: 0
						.vote-heart
							display: inline-block
							width: 36px
							height: 30px
							background: url("../../img/project_demo/detail.png") no-repeat
							background-size: 145px
							background-position: -106px 0
							position: absolute
							z-index: 3
							&.liked
								background: url("../../img/project_demo/detail.png") no-repeat
								background-size: 145px
								background-position: -106px -30px
						.vote-num
							display: inline-block
							color: #fff
							position: absolute
							top: 2px
							left: 16px
							text-align: center
							width: 66px
							height: 28px
							background: url("../../img/project_demo/rectangle@3x.png")
							background-size: 100% 100%
							line-height: 28px
							padding-left: 12px
		.null
			width: 100%
			height: 100%
			position: absolute
			top: 0
			.dino
				width: 300px
				height: 300px
				margin: 0 auto
				position: absolute
				top: 50%
				left: 50%
				transform: translate(-50%,-50%)
				-webkit-transform: translate(-50%, -50%)
				.dino-null
					width: 300px
					height: 300px
					background: transparent url("../../img/project_demo/null.png") no-repeat
					background-size: 100% 100%
				.text
					font-size: 24px
					margin-top: 50px
					text-align: center
					color: #fff
		.tips
			font-size: 14px
			margin: 10px
		.mobile
			.qrcode-box
				margin: 30px auto
				width:320px
				height:320px
				background:rgba(179,150,255,0.3)
				border-radius:30px 20px 20px 20px
				border:4px dashed rgba(179,150,255,1)
				.qrcode
					margin: 90px auto
					width: 100px
					height: 100px
					background: #fff
					padding: 20px
				.mobile-tips
					margin-top: 140px
	.shake
		animation: shake 1.4s infinite
	@keyframes shake
		0%, 100%
			transform: rotate(0)
		10%, 30%, 50%, 70%, 90%
			transform: rotate(-1deg)
		20%, 40%, 60%, 80%
			transform: rotate(1.5deg)
	@keyframes jump
		0%
			top: 0
		50%
			top: 100px
		100%
			top: 0
	@keyframes shrink
		0%
			width:90px
			height: 60px
			background: rgba(120,120,120,.3)
		65%
			width: 10px
			height: 5px
			margin-left: -5px
			background: rgba(120,120,120,.3)
			box-shadow: 0 0 25px 20px rgba(20,20,20,.3)
		100%
			width: 90px
			height:60px
			background: rgba(120,120,120,.1)
			box-shadow: 0 0 25px 20px rgba(20,20,20,.1)
</style>

