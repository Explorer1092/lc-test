<template lang="jade">
  .en-speech-banner
    .en-speech-bg
      .label(:class="'label-img-' + detail.rule")
      .sub-title
        p {{groupDictionary[detail.rule-1].subTitle}}
      .title {{groupDictionary[detail.rule-1].title}}
      img.banner-img(:src="detail.coverImage",@click="goToDemoView", v-if="hasDemoVedio")
      .pd-robot-play-button(@click="goToDemoView",v-if="hasDemoVedio")
      .count-down-container
        span {{tipsName[countDownStatus]}}
        .time(v-for="(item, i) in day") {{item}}
        span.margin-trim 天
        .time(v-for="(item, i) in hour") {{item}}
        span.margin-trim-hour 小时
    .pd-join
      .left 
        span
        | {{detail.totalNum}}人参加
      .right
        span 
        | {{detail.totalResourceNum}}个作品
      .button(@click="join", :class="{'available': detail.activityStudentResource == 0, 'grey': detail.activityStudentResource != 0}") {{statusName[detail.activityStudentResource]}}
      .dino-tips(v-show="numClass && detail.activityStudentResource == 0")
        span 再完成{{numClass}}节夏令营课程可解锁大赛
      .dino-tips(v-show="noLevel")
        span 该活动下面不存在于学生level对应赛区
</template>
<script>
import axios from 'axios'
import vloading from './_loading.vue'
import cookies from 'cookies-js'

export default {
  data() {
    return {
      day: [0,0],
      hour: [0,0],
      activityId: this.$route.params.pdId,
      statusName: ['我要参加','已参加','投票结束','活动结束','未开始', '上传截止'],
      tipsName: ['距离活动开始还有', '距离上传截止还有', '距离投票结束还有', '距离颁奖还有'],
      countDownStatus: 0,
      groupDictionary:[
        {
          title: '30秒自我介绍+1分钟英文表达',
          subTitle: '作品要求'
        },
        {
          title: '30秒自我介绍+1分钟英文表达',
          subTitle: '作品要求'
        },
        {
          title: 'My First Specical Memory',
          subTitle: '演讲主题'
        },
        {
          title: 'No pains, No gains',
          subTitle: '演讲主题'
        },
        {
          title: 'My Inspiring Chinese Cultural Hero',
          subTitle: '演讲主题'
        },
        {
          title: 'My Understanding of Responsibility',
          subTitle: '演讲主题'
        }
      ],
      timestamp: null,
      prizes: [0,1,2],
      numClass: 0,
      noLevel: false,
      hasDemoVedio:false,
      isVideoMaskShow: true
    }
  },
  props:['detail'],
  components: {
    vloading
  },
  mounted() {
    this.initCountDown()
  },
  methods: {
    //检查是否有对应的demoVideoUrl
    checkOutIsHaveDemoVideo(demoVideoUrl){
      if(typeof demoVideoUrl == "string" && demoVideoUrl !=="null" && demoVideoUrl.length > 0){
        this.hasDemoVedio = true
      }
    },
    //add by luomingzhong 去demo视频
    goToDemoView(){
      if(this.hasDemoVedio){
        this.$router.push({
          path:`/pd_demo_video/${this.activityId}`
        })
      }
      //减少接口请求
      localStorage.setItem("demoVideoUrl",this.detail.demoVideo)
    },

    initCountDown() {
      this.timestamp = this.detail.systemTime
      let time = 0
      /**
       * @activityStudentResource 4:未开始 0:我要参加 1:已参赛 5:上传截止 2:投票结束 3:活动结束 
       */
      if (this.detail.activityStudentResource == 4) {
        time = this.detail.startTime - this.timestamp
        this.countDownStatus = 0
      }
      if (this.detail.activityStudentResource == 0 || this.detail.activityStudentResource == 1) {
        time = this.detail.endUploadTime - this.timestamp
        this.countDownStatus = 1
      }
      if (this.detail.activityStudentResource == 5) {
        time = this.detail.endVotetime - this.timestamp
        this.countDownStatus = 2
      }
      if (this.detail.activityStudentResource == 2 || this.detail.activityStudentResource == 3) { 
        time = this.detail.endTime - this.timestamp
        this.countDownStatus = 3
      }
      if (time < 0) {
        this.day = [0,0]
        this.hour = [0,0]
      } else {
        this.day = this.fullTime(parseInt(time / (1000 * 60 * 60 * 24))).toString().split('')
        this.hour = this.fullTime(parseInt((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).toString().split('')
      }
      this.checkOutIsHaveDemoVideo(this.detail.demoVideo)
    },
    fullTime(t) {
      return t < 10 ? '0'+t : t
    },
    join() {
      if (this.detail.activityStudentResource !== 0) {
        return
      }
      sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition'})
      this.$playSound("click")
      this.$emit('gojoin', true)
      axios.post(`/rest/activity/api/activity/user/activity/signByActivityIdAndStudentId/${this.$route.params.pdId}`)
        .then((res) => {
          if (res.data.code === 100022) {
            this.noLevel = true
            setTimeout(() => {
              this.noLevel = false
            }, 1500)
            this.$emit('gojoin','numClass')
            return
          } else if (res.data.code === 0) {
            if (res.data.data === 0) {
              this.checkWorkWall() // 去掉协议验证，直接走 checkWorkWall()
            } else {
              this.$emit('gojoin','numClass')
              this.numClass = res.data.data
              setTimeout(()=> {
                this.numClass = 0
              },1500)
            }
          }
          //表明不在白名单内
          else if(res.data.code == 100035){
            this.$emit('gojoin','numClass')
            this.$showToast('本活动暂时只开放给小创造者联盟课程学员，请您等待该课程正式开放。')
          } else{
            this.$emit('gojoin',false)
          }
        })
        .catch((err) => {
        })
    },
    checkWorkWall() {
      axios.get(`/rest/activity/api/activity/user/resource/getResourcesByActivityIdAndStudentId/${this.$route.params.pdId}/1/1`)
        .then((res) => {
          if (res.data.code === 0) {
            if (!res.data.data) {
              this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
              return
            }
            if (res.data.data.list.length) {
              this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}`})
            } else {
              this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
            }
          }
        })
    }
  }
}
</script>
<style lang="stylus" scoped>
.en-speech-banner
  width: 100%
  height: 500px
  position: fixed
  background-size: 100% auto
  color: #fff
  z-index: 1
img.banner-img
  position: absolute
  top: 10px
  left: 10px
  width: 819px
  height: 260px

.en-speech-bg
  width: 836px
  height: 431px
  margin: 0 auto
  margin-top: 30px
  background: url('../../../img/project_demo/speech_detail_banner.png') no-repeat
  background-size: 100% 100%
  position: relative
  text-align: center
  .label
    background-repeat: no-repeat
    background-size: 100% 100%
    position: absolute
    top: -20px
    left: -6px
    width: 333px
    height: 54px
    z-index: 1
    &.label-img-1
      background-image: url('../../../img/project_demo/en_speech_label_1.png')
    &.label-img-2
      background-image: url('../../../img/project_demo/en_speech_label_2.png')
    &.label-img-3
      background-image: url('../../../img/project_demo/en_speech_label_3.png')
    &.label-img-4
      background-image: url('../../../img/project_demo/en_speech_label_4.png')
    &.label-img-5
      background-image: url('../../../img/project_demo/en_speech_label_5.png')
    &.label-img-6
      background-image: url('../../../img/project_demo/en_speech_label_6.png')
      
  .sub-title
    position: absolute
    bottom: 117px
    left: 120px
    width: 600px
    font-size: 14px
    color: #fff
    text-align: center
    p
      position: relative
      display: inline-block
      &:before
        content: ''
        width: 10px
        height: 12px
        background-image: url(../../../img/project_demo/en_speech_sub_icon_left.png)
        background-repeat: no-repeat
        background-size: 100% 100%
        position: absolute
        top: 5px
        left: -20px
      &:after
        content: ''
        width: 10px
        height: 12px
        background-image: url(../../../img/project_demo/en_speech_sub_icon_right.png)
        background-repeat: no-repeat
        background-size: 100% 100%
        position: absolute
        top: 5px
        right: -20px
  .title
    position: absolute
    bottom: 84px
    left: 120px
    width: 600px
    font-size: 18px
    color: #fff
    text-align: center
.count-down-container
  position: absolute
  bottom: 8px
  left: 268px
  span
    display: inline-block
    vertical-align: sub
    color: #fff
    font-size: 15px
    font-weight: 100
    &.margin-trim
      margin-right: 1px
      margin-left: 2px
    &.margin-trim-hour
      margin-left: 0px
  .time
    position: relative
    font-size: 27px
    z-index: 1
    display: inline-block
    vertical-align: middle
    font-weight: 400
    color: #FDFC8B
    width: 26px
    height: 35px
    text-align: center
    background: #5F3FA6
    margin: 0 3px
    border-radius: 8px
    box-sizing: border-box
  
.pd-join
  width: 600px
  height: 40px
  background: rgba(0,0,0,0.3)
  border-radius: 32px
  margin: 0 auto
  margin-top: 40px
  position: relative
  @media only screen and (max-height: 670px)
    margin-top: 30px
  .bottom-tips
    position: absolute
    top: 70px
    left: 34%
    font-size: 14px
  .dino-tips
    position: absolute
    font-size: 14px
    width: 370px
    height: 110px
    left: 50%
    top: 50%
    transform: translate(-50%,-50%)
    -webkit-transform: translate(-50%, -50%)
    background: url("../../../img/project_demo/dino_tips.png")
    background-size: 100% 100%
    color: #000
    span
      display: inline-block
      margin-left: 100px
      width: 260px
      margin-top: 50px
  .left
    width: 146px
    height: 40px
    text-align: center
    line-height: 40px
    position:absolute
    span
      display: inline-block
      width: 16px
      height: 16px
      background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
      background-size: 380px
      background-position: -349px 1px
      margin: -1px 5px
  .right
    width: 146px
    height: 40px
    text-align: center
    line-height: 40px
    position:absolute
    right: 0
    span
      display: inline-block
      width: 16px
      height: 14px
      background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
      background-size: 380px
      background-position: -365px 0
      margin: -1px 3px
.button
  position: absolute
  left: 171px
  top: -13px
  width: 260px
  height: 66px
  background-size: 100% 100%
  background-repeat: no-repeat
  font-size: 28px
  color: #fff
  font-weight: 700
  text-align: center
  line-height: 66px
  cursor: pointer
  &.available
    background-image: url(../../../img/project_demo/orange_button.png)
  &.grey
    background-image: url(../../../img/project_demo/grey_button.png)
  &:hover
    opacity: 0.9
// add by luomingzhong
.pd-robot-play-button
   position:absolute
   left:410px
   top:110px
   width:60px 
   height:60px 
   background:url(../../../img/project_demo/play_status.png)
   background-size:60px 60px
</style>
