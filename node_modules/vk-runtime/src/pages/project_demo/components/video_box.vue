<template lang="jade">
  .video-box
    .pd-detail-label
      select-box(v-if="list && !ustType",:list="list",:selectShow="false",@select="selectLevel")
      .text
      .tab(ref="tab",:class="ustType?'fl':''")
        .tab-bg(:class="'tab-'+active")
        .tab-item(v-for="(item, i) in tabs",:class="'tab-'+i",@click="changeTab(i,item.rankId)") {{item.name}}
    .pd-detail-thumb(ref="pd_detail_thumb",@scroll="onScroll($event)",:class="{'scroll':show}")
      .video-container(ref="video_container")
        video-item(v-if="works",class="animated fadeIn",v-for="(item, i) in works",:key="item.id",:work="item",:partitionId="partitionId",:index="i",:focus="focus",:status="status",@vote="onVote")
        .null(v-if="isLoaded && (!works||!works.length)",class="animated fadeIn")
          .dino-null
          .text 这里还什么都没有
    .spinner(v-if="loading",class="animated fadeIn")
      vloading
    .bottom-tips(v-if="bottomTips") 没有更多了
</template>
<script>
import selectBox from './select.vue'
import videoItem from './video_item.vue'
import vloading from './_loading.vue'
import axios from 'axios'
import Toolkit from '../js/toolkit.js'
export default {
  data() {
    return {
      tabs: [],
      focus: 1,
      partitionId: '',
      pageNo: 1,
      pageSize: 21,
      works: null,
      active: 0,
      isLoaded: false,
      loading: true,
      // tab切换截流
      stopCrazyXhr: null,
      list: null,
      myPartition: '',
      initList: {},
      total: 0,
      bottomTips: false,
      isListRender: true
    }
  },
  components: {
    selectBox,
    videoItem,
    vloading
  },
  props: {
    'show': {
      type: Boolean,
      default: false
    },
    'status': {
      type: Number,
      default: -1
    },
    'whichActivity': {
      type: String,
      default: ''
    },
    'ustType': {
      type: String,
      default: ''
    },
    'firstPartitionId': {
      type: [Number, String],
      default: ''
    },
    trackData: {
      type: Object,
      default: () => {
        return {
          trackId: ''
        }
      }
    }
  },
  watch: {
    works: function (val, oldVal) {
      if (val && val.length > 0) {
        //列表已经渲染后 isListRender = true 过滤掉因为调高冗余提前触发的多次请求
        this.$nextTick(() => {
          this.isListRender = true
        })
      }
    },
    firstPartitionId(val, oldVal) {
      if (val) {
        this.start()
      }
    }
  },
  mounted() {
    this.resize()
    if (!this.ustType) {
      this.start()
    } else if (this.firstPartitionId && this.firstPartitionId !== -1) {
      this.start()
    }
  },
  updated() {
    this.resize()
  },
  methods: {
    resize() {
      this.$refs.pd_detail_thumb.style.height = (document.body.offsetHeight - (this.ustType?222:200)) + 'px'
      if (!this.ustType) {
        if (this.tabs.length == 3) {
          this.$refs.tab.style.right = '-5px'
        }
        if (this.tabs.length == 2) {
          this.$refs.tab.style.right = '-95px'
        }
        if (this.tabs.length == 1) {
          this.$refs.tab.style.right = '-185px'
        }
      }
    },
    start() {
      axios.get(`/rest/activity/api/activity/user/activity/getPartitionByActivityIdAndStudentId/${this.$route.params.pdId}`)
        .then((res) => {
          if (res.data.data) {
            this.myPartition = res.data.data.id
          }
          this.init()
        })
    },
    init() {
      axios.get(`/rest/activity/api/activity/user/activity/getActivityAndRankInfoByActivityId/${this.$route.params.pdId}`)
        .then((res) => {
          let list = res.data.data.partitionModelList
          for (var i = 0; i < list.length; i++) {
            let key = list[i].id
            if ( i === 0) {
              this.partitionId = this.firstPartitionId || list[i].id
            }
            let obj = {}
            // 活动类型：UNIT_SHOW_TIME 时，即 activityType = 3 时
            let newRankModelList = []
            if (this.whichActivity === 'SHOWTIME') {
              let rankList = list[i].rankModelList

              if ( list[i].rankModelList.length === 3) {
                for (let j = 0; j < list[i].rankModelList.length; j++) {
                  //调换接口数据中1和2的位置，并且改名
                  switch(rankList[j].rankId) {
                  case 2:
                    rankList[j].name = "最新"
                    newRankModelList[0] = rankList[j]
                    break
                  case 1:
                    rankList[j].name = "最热"
                    newRankModelList[1] = rankList[j]
                    break
                  case 3:
                    newRankModelList[2] = rankList[j]
                    break
                  }
                }
              } else {
                for (let j = 0; j < list[i].rankModelList.length; j++) {
                  if (rankList[j].rankId === 1) {
                    rankList[j].name = "最热"
                  }
                  newRankModelList.push(rankList[j])
                }
              }
              list[i].rankModelList = newRankModelList
            }
            obj[key] = list[i].rankModelList
            this.initList = Object.assign(this.initList, obj)
          }
          if (this.myPartition !== '') {
            this.list = []
            this.list[0] = null
            list.forEach((val, index) => {
              if (val.id == this.myPartition) {
                this.list[0] = val
              } else {
                this.list.push(val)
              }
            })
          } else {
            this.list = list
          }
          if (this.ustType) {
            this.tabs = this.list[0].rankModelList.filter((item) => {
              if (item.rankId===1) {
                item.name = "推荐视频"
              }
              if (item.rankId===2) {
                item.name = "最新视频"
              }
              return item.rankId!==3
            })
          } else {
            this.tabs = this.list[0].rankModelList
          }
          this.partitionId = this.firstPartitionId || this.list[0].id
          // 活动类型：UNIT_SHOW_TIME 时，即 activityType = 3 时, 做单独处理
          if (this.whichActivity === 'SHOWTIME') {
            this.focus = 2
            this.getNewWorks()
          } else {
            this.getWorks()
          }
        })
    },
    errorReload() {
      this.$playSound("click")
      setTimeout(() => {
        window.location.reload()
      },500)
    },
    changeTab(i,rankId) {
      this.$playSound("click")
      if (this.loading) {
        return
      }
      this.loading = true
      this.$refs.pd_detail_thumb.scrollTop = 0
      if (this.focus === rankId) {
        this.loading = false
        return
      }
      this.active = i
      this.pageNo = 1
      this.works = []
      this.total = 0
      // if (this.stopCrazyXhr) {
      //   window.clearTimeout(this.stopCrazyXhr)
      //   this.stopCrazyXhr = null
      // }
      if (rankId === 1) {
        if(this.focus !== 1) {
          this.focus = 1
          this.getWorks()
        }
        if (!this.trackData.trackId) {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_ranking'})
        } else {
          sa.track('learning_click', {'click_id': `${this.trackData.trackId}_ranking`})
        }
      }
      if (rankId === 2) {
        if(this.focus !== 2) {
          this.focus = 2
          this.getNewWorks()
        }
        if (!this.trackData.trackId) {
          sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_latestSubmission'})
        } else {
          sa.track('learning_click', {'click_id': `${this.trackData.trackId}_latestSubmission`})
        }
      }
      if (rankId === 3) {
        if(this.focus !== 3) {
          this.focus = 3
          this.getMyWorks()
        }
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_mySubmission'})
      }
    },
    thumbsOverflow(style) {
      this.$refs.pd_detail_thumb.style.overflowY = style
    },
    selectLevel(id) {
      this.partitionId = id
      this.works = null
      this.isListRender = true
      this.loading = true
      this.pageNo = 1
      this.total = 0
      this.tabs = this.initList[id]
      this.focus = this.tabs[0].rankId
      this.active = 0
      this.$emit('selectLevel', id)
      if (this.focus === 1) {
        this.getWorks()
      }
      if (this.focus === 2) {
        this.getNewWorks()
      }
      if (this.focus === 3) {
        this.getMyWorks()
      }
    },
    getWorks() {
      axios.get(`/rest/activity/api/activity/user/resource/getHotResourcesByPartitionId/${this.partitionId}/${this.pageNo}/${this.pageSize}`)
        .then((res) => {
          if (!this.works) {
            this.works = []
          }
          this.loading = false
          if (!res.data.data) {
            this.works = null
          }
          if(res.data.data.list) {
            this.total = res.data.data.total
            // for (var i = 0; i < 3; i++) {
            //   res.data.data.list = res.data.data.list.concat(res.data.data.list)
            // }
            this.works = this.works.concat(res.data.data.list)
            this.works.forEach((val, index) => {
              val.ago = Toolkit.getTime(val.gmtCreate)
            })
          } else {
            if (this.pageNo === 1) {
              this.works = null
            }
          }
          this.isLoaded = true
        })
        .catch((err) => {
          this.works = null
        })
    },
    getNewWorks() {
      axios.get(`/rest/activity/api/activity/user/resource/getNewestResourcesByPartitionId/${this.partitionId}/${this.pageNo}/${this.pageSize}`)
        .then((res) => {
          this.loading = false
          if (!this.works) {
            this.works = []
          }
          if (!res.data.data) {
            this.works = null
          }
          if(res.data.data.list) {
            this.total = res.data.data.total
            this.works = this.works.concat(res.data.data.list)
            this.works.forEach((val, index) => {
              val.ago = Toolkit.getTime(val.gmtCreate)
            })
          } else {
            if (this.pageNo === 1) {
              this.works = null
            }
          }
          this.isLoaded = true
        })
        .catch((err) => {
          this.works = null
        })
    },
    getMyWorks() {
      axios.get(`/rest/activity/api/activity/user/resource/getMyResourcesByPartitionIdAndStudentId/${this.partitionId}`)
        .then((res) => {
          this.loading = false
          if (!this.works) {
            this.works = []
          }
          if (res.data.data) {
            let obj = res.data.data
            obj.ago = Toolkit.getTime(obj.gmtCreate)
            this.works.push(obj)
          } else {
            this.works = null
          }
          this.isLoaded = true
        })
    },
    onScroll($event) {
      let num = this.$refs.pd_detail_thumb.scrollTop + this.$refs.pd_detail_thumb.clientHeight
      // 增加冗余，提前触发
      if (this.$refs.video_container.clientHeight - num <= 20) {
        if (this.total > this.pageNo * this.pageSize) {
          //列表已经渲染后
          if (this.isListRender) {
            this.pageNo++
            this.loading = true
            this.isListRender = false
            this.getMore(this.focus)
          }
        } else {
          this.bottomTips = true
          this.isListRender = true
          setTimeout(()=>{
            this.bottomTips = false
          },2000)
        }
      }
    },
    getMore(rankId) {
      this.loading = true
      if (rankId === 1) {
        this.getWorks()
      }
      if (rankId === 2) {
        this.getNewWorks()
      }
      if (rankId === 3) {
        this.getMyWorks()
      }
    },
    // 当视频点赞时
    onVote(data) {
      this.$emit('vote', data)
    }
  }
}
</script>
<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
  .video-box
    position: relative
    padding-top: 30px
  .pd-detail-label
    text-align: center
    width: calc(100% - 60px)
    height: 50px
    background: #794FB5
    border-radius: 25px
    margin: 0 auto
    padding: 0 10px
    .text
      position: absolute
      left: 50%
  .pd-detail-thumb
    width: 100%
    text-align: left
    padding: 10px
    padding-top: 10px
    margin-top: 20px
    overflow: hidden
    -webkit-overflow-scrolling: touch
    &.scroll
      overflow-y: auto
    &::-webkit-scrollbar
      display: none
    .video-container
      width: 100%
      position: relative
      margin-top: -10px
      margin-left: 10px
  .tab
    width: 270px
    height: 100%
    float: right
    position: relative
    cursor: pointer
    padding-top: 5px
    &.fl
      float: left
    .tab-bg
      width: 90px
      height: 40px
      position: absolute
      border-radius: 25px
      background: url("../../../img/project_demo/detial_tab.png") no-repeat
      background-size: 100% 100%
      transition-duration: .8s
      &.tab-0
        left: 0
      &.tab-1
        left: 90px
      &.tab-2
        left: 180px
    .tab-item
      width: 90px
      display: inline-block
      position:absolute
      z-index: 1
      height: 100%
      padding-top: 12px
      font-size: 14px
      color: #fff
      white-space:nowrap
      overflow:hidden
      text-overflow:ellipse
      &.tab-0
        left: 0
      &.tab-1
        left: 90px
      &.tab-2
        right: 0
  .null
    width: 300px
    height: 300px
    position: absolute
    left: 50%
    top: 50%
    transform: translate(-50%,10%)
    -webkit-transform: translate(-50%,10%)
    .dino-null
      width: 285px
      height: 210px
      margin: 0 auto
      background: transparent url("../../../img/project_demo/null2.png") no-repeat
      background-size: 100% 100%
    .text
      font-size: 24px
      margin-top: 50px
      text-align: center
      color: #fff
  .spinner
    width: 100px
    height: 60px
    text-align: center
    font-size: 10px
    position: absolute
    top: 20%
    left: 48%
    z-index: 8
  .bottom-tips
    font-size: 12px
    text-align: center
    color: #fff
    line-height: 28px
</style>
