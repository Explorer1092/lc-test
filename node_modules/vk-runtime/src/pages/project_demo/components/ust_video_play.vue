<template lang="jade">
  .ust-video-play(
    :class="[{ 'playing': isPlaying }, { 'locked': isLocked }, { 'un-upload': isUnUpload }, { 'uploaded': isUploaded }, videoSize]")
    video.player(
      v-show="true || isShowVideo",
      :src="videoSrc",
      :poster="videoCoverImage",
      ref="video",
      webkit-playsinline="true",
      playsinline="true",
      controls="controls"
      @click="onClickVideo")
    .video-play-cover(
      v-show="isShowCover",
      @click="onClickPlayBtn")
      img.unit-cover-img(:src="videoCoverImage | autoCover(imgSize)")
      .play-btn(:class="[{'locked':isLocked}]")
    .unit-vote(v-if="isShowVote && isUploaded") {{vote}}票
</template>
<script>
  import VideoFunc from "../js/video.js"
  export default {
    mixins: [VideoFunc.index()],
    data() {
      return {
        // 正在播放
        isPlaying: false,
        // 是不是播放过
        isHaventPlayed: true,
        // 是不是播放结束
        isPlayEnded: false,
        // 播放链接
        playVideoSrc: '',
        unlockStatusMap: {
          'UPLOADED': 0,
          'UNUPLOAD': 1,
          'LOCKED':   2
        }
      }
    },
    props: {
      playData: {
        type: Object,
        default: {}
      },
      videoSize: {
        type: String,
        default: 'full'
      },
      isShowVote: {
        type: Boolean,
        default: true
      },
      voteData: {
        type: Object,
        default: () => {}
      },
      trackData: {
        type: Object,
        default: () => {
          return {
            trackId: ''
          }
        }
      }
    },
    computed: {
      resourceId(){
        return this.playData.resourceId?parseInt(this.playData.resourceId):-1
      },
      voteResourceId(){
        return this.voteData.resourceId?parseInt(this.voteData.resourceId):-1
      },
      voteCount(){
        return this.voteData.count
      },
      unlockStatus(){
        const unlockStatus = parseInt(this.playData.unlockStatus)
        return isNaN(unlockStatus)?this.unlockStatusMap.UNUPLOAD:unlockStatus
      },
      // 我自己上传的作品视频地址
      url(){
        return this.playData.url
      },
      // 我自己的作品封面
      coverImage(){
        return this.playData.coverImage
      },
      // 活动宣传视频
      demoVideo(){
        return this.playData.demoVideo
      },
      // 活动视频封面
      coverImage2Activity(){
        return this.playData.coverImage2Activity
      },
      // 封面图尺寸
      imgSize(){
        let imgSizeStr = ''
        if (this.videoSize === 'small') {
          imgSizeStr = '228x129'
        } else if(this.videoSize === 'big') {
          imgSizeStr = '594x310'
        }
        return imgSizeStr
      },
      // 投票数
      vote(){
        // 如果当前视频发生点赞时间，则更新点赞数
        let count = this.playData.count?this.playData.count:0
        if (this.resourceId !=-1 && (this.resourceId === this.voteData.resourceId)) {
          count = this.voteCount
        }
        return count
      },
      // 已上传
      isUploaded(){
        return this.unlockStatus === 0
      },
      // 已解锁未上传
      isUnUpload(){
        return this.unlockStatus === 1
      },
      isJustUploaded(){
        return !!this.playData.isJustUploaded
      },
      // 未解锁
      isLocked(){
        return this.unlockStatus === 2
      },
      videoSrc(){
        return (this.isUploaded || this.isJustUploaded)?this.url:this.demoVideo
      },
      videoCoverImage(){
        return (this.isUploaded || this.isJustUploaded)?this.coverImage:this.coverImage2Activity
      },
      // 是否展示播放器
      isShowVideo(){
        return !this.isShowCover
      },
      // 是否展示播放器封面图和播放按钮
      isShowCover(){
        return this.isHaventPlayed || this.isPlayEnded
      }
    },
    components: {},
    filters: {
      autoCover(val, imgSize) {
        val = val || ""
        return (
          val.split("?")[0] +
          "?imageMogr2/auto-orient/thumbnail/!" + imgSize + "r/gravity/Center/crop/" + imgSize + "/quality/85"
        )
      }
    },
    mounted() {
      // console.log(this.playData)
    },
    methods: {
      onClickVideo(){
        this.togglePlay()
      },
      onClickPlayBtn(){
        if (this.isLocked) {
          this.track('learning_click', 'locked')
          Vm.$showToast('完成' + this.playData.unitName + '学习才可以录制哦！')
        } else {
          if (this.isUploaded) {
            this.track('learning_click', 'playMyVideo')
          } else if(this.isUnUpload) {
            this.track('learning_click', 'playTeachingVideo')
          }
          this.fullscreenPlay(this.$refs['video'])
        }
      },
      track(eventName, clickIdStamp){
        if (!this.trackData || !this.trackData.trackId) {
          return
        }
        sa.track('learning_click', {
          'click_id': `${this.trackData.clickId}_${clickIdStamp}`
        })
      }
    }
  }
</script>
<style lang="stylus" scoped>
.ust-video-play
  position: relative
  width: 100%
  &.full
    height: 100%
  &.small
    height: 129px
  &.big
    height: 326px
    .unit-cover-img
      border-bottom-left-radius: 26px;
      border-bottom-right-radius: 26px;
  .player
    width: 100%
    height: 100%
  .video-play-cover
    position: absolute
    z-index: 1
    top: 0
    left: 0
    width: 100%
    height: 100%
    .unit-cover-img
      width: 100%
      height: 100%
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
    .play-btn
      position: absolute
      top: 50%
      left: 50%
      width: 57px
      height: 57px
      transform: translate(-50%, -50%)
      -webkit-transform: translate(-50%, -50%)
      background-image: url("../../../img/project_demo/unit_show_time/Playing small@2x.png")
      background-repeat: no-repeat
      background-size: 57px
      &.locked
        background-image: url("../../../img/project_demo/unit_show_time/lock@2x.png")
  .unit-vote
    position: absolute
    z-index: 2
    right: 5px
    bottom: 5px
    width: 49px
    height: 19px
    border-radius: 10px
    font-size: 10px
    font-weight: 600
    line-height: 19px
    opacity: 0.6
    background: rgba(0,0,0,1)
</style>
