<template lang="jade">
  .show-time-banner
    .show-time-bg
      .title 模仿视频中的内容，录制并上传你的视频
      .count-down-container
        //- .number-bg(v-for="item, index in [1,2,3,4]", :class="'number-bg-' + index")
        span 剩余:
        .time(v-for="(item, i) in day") {{item}}
        span.margin-trim 天
        .time(v-for="(item, i) in hour") {{item}}
        span.margin-trim-hour 小时
      .video-box
        video(v-if="detail.demoVideo", :src="detail.demoVideo" controls controlslist="nodownload" ref="videoDom" oncontextmenu="return false" )
        .video-mask(v-if="isVideoMaskShow")
          img(src="../../../img/project_demo/show_time_banner_img.jpg")
          .fake-play-button(@click.stop="playVideo")
      .lyric-box
        .title {{ detail.lyrics && detail.lyrics.indexOf('&') > -1 && detail.lyrics.split('&')[0] }}
        .line
        .lyric(v-html="detail.lyrics && detail.lyrics.indexOf('%') > -1 && detail.lyrics.split('&')[1].split('%').join('<br>')", @scroll.stop="null", @mousewheel.stop="null", @DOMMouseScroll.stop="null")
    .pd-join
      .left 
        span
        | {{detail.totalNum}}人参加
      .right
        span 
        | {{detail.totalResourceNum}}个作品
      .status(:class="{'status-button': detail.activityStudentResource !== 3, 'unjoin': detail.activityStudentResource !== 0}")
        .join(@click="join", :class="{'end': [3, 5].indexOf(detail.activityStudentResource) > -1 }") {{statusName[detail.activityStudentResource]}}
      .dino-tips(v-show="numClass && detail.activityStudentResource == 0")
        span 再完成{{numClass}}节夏令营课程可解锁大赛
      .dino-tips(v-show="noLevel")
        span 该活动下面不存在于学生level对应赛区
</template>
<script>
import axios from 'axios'
import vloading from './_loading.vue'
import cookies from 'cookies-js'

export default {
  data() {
    return {
      day: ['0','6'],
      hour: ['1','0'],
      awards: null,
      activityId: this.$route.params.pdId,
      statusName: ['上传我的模仿视频','已上传','投票结束','活动结束','未开始', '上传已截止'],
      tipsName: ['距离投票结束还有','距离投票结束还有','距离颁奖开始还有','距离颁奖开始还有','距离比赛开始还有'],
      timestamp: null,
      prizes: [0,1,2],
      numClass: 0,
      _awards: {},
      pid: this.partitionId,
      noLevel: false,
      hasDemoVedio:false,
      isVideoMaskShow: true
    }
  },
  props:['detail','partitionId'],
  components: {
    vloading
  },
  mounted() {
    this.initCountDown()
    if (!cookies.get('isFromApp')) {
      setTimeout(() => {
        this.playVideo()
      }, 1000)
    }
  },
  watch: {
    'partitionId': function() {
      this.awards = this._awards[this.partitionId]
    }
  },
  updated() {
    if (this.awards && this.awards.length>3) {
      let len = this.awards.length*320
      this.$refs.pd_award_container.style.width = `${len}px`
    } else {
      if (this.$refs.pd_award_container) {
        this.$refs.pd_award_container.style.width = '100%'
      }
    }
  },
  methods: {
    playVideo() {
      this.$refs.videoDom.play()
      this.isVideoMaskShow = false
    },
    initCountDown() {
      this.timestamp = new Date().getTime()
      let time = 0
      /**
       * @activityStudentResource 4:未开始 0:我要参加 1:已参赛 5:上传截止 2:投票结束 3:活动结束 
       */
      if (this.detail.activityStudentResource == 4) {
        time = this.detail.startTime - this.timestamp
      }
      if (this.detail.activityStudentResource == 0 || this.detail.activityStudentResource == 1) {
        time = this.detail.endUploadTime - this.timestamp
      }
      if (this.detail.activityStudentResource == 5) {
        time = this.detail.endVotetime - this.timestamp
      }
      if (this.detail.activityStudentResource == 2 || this.detail.activityStudentResource == 3) { 
        time = this.detail.endTime - this.timestamp
      }
      
      if (time < 0) {
        this.day = [0,0]
        this.hour = [0,0]
      } else {
        this.day = this.fullTime(parseInt(time / (1000 * 60 * 60 * 24))).toString().split('')
        this.hour = this.fullTime(parseInt((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).toString().split('')
      }

    },
    //检查是否有对应的demoVideoUrl
    checkOutIsHaveDemoVideo(demoVideoUrl) {
      if(typeof demoVideoUrl == "string" && demoVideoUrl !=="null" && demoVideoUrl.length > 0){
        this.hasDemoVedio = true
      }
    },

    //add by luomingzhong 去demo视频
    goToDemoView() {
      if(this.hasDemoVedio) {
        this.$router.push({
          path:`/pd_demo_video/${this.activityId}`
        })
      }
      //减少接口请求
      localStorage.setItem("demoVideoUrl",this.detail.demoVideo)
    },
    userScrollDown(e) {
      this.$refs.pd_award.scrollLeft += e.deltaY
    },
    fullTime(t) {
      return t < 10 ? '0'+t : t
    },
    join() {
      if (this.detail.activityStudentResource !== 0) {
        return
      }
      sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition'})
      this.$playSound("click")
      this.$emit('gojoin', true)
      axios.post(`/rest/activity/api/activity/user/activity/signByActivityIdAndStudentId/${this.$route.params.pdId}`)
        .then((res) => {
          if (res.data.code === 100022) {
            this.noLevel = true
            setTimeout(() => {
              this.noLevel = false
            }, 1500)
            this.$emit('gojoin','numClass')
            return
          } else if (res.data.code === 0) {
            if (res.data.data === 0) {
              this.checkWorkWall() // 去掉协议验证，直接走 checkWorkWall()
            } else {
              this.$emit('gojoin','numClass')
              this.numClass = res.data.data
              setTimeout(()=> {
                this.numClass = 0
              },1500)
            }
          }
          //表明不在白名单内
          else if(res.data.code == 100035){
            this.$emit('gojoin','numClass')
            this.$showToast('本活动暂时只开放给小创造者联盟课程学员，请您等待该课程正式开放。')
          } else{
            this.$emit('gojoin',false)
          }
        })
        .catch((err) => {
        })
    },
    checkWorkWall() {
      axios.get(`/rest/activity/api/activity/user/resource/getResourcesByActivityIdAndStudentId/${this.$route.params.pdId}/1/1`)
        .then((res) => {
          if (res.data.code === 0) {
            if (!res.data.data) {
              this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
              return
            }
            if (res.data.data.list.length) {
              this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}`})
            } else {
              this.$router.push({path: `/pd_upload/${this.$route.params.pdId}`})
            }
          }
        })
    }
  }
}
</script>
<style lang="stylus" scoped>
.show-time-banner
  width: 100%
  height: 500px
  position: fixed
  background-size: 100% auto
  color: #fff
  z-index: 1

.show-time-bg
  width: 920px
  height: 449px
  margin: 0 auto
  margin-top: 30px
  background: url('../../../img/project_demo/showtimebanner.png') no-repeat
  background-size: 100% 100%
  position: relative
  text-align: center
  .count-down-container
    position: absolute
    top: 122px
    right: 45px
    span
      display: inline-block
      vertical-align: sub
      color: #5F3FA6
      font-size: 14px
      font-weight: 700
      &.margin-trim
        margin-right: 1px
        margin-left: 2px
      &.margin-trim-hour
        margin-left: 0px
    .time
      position: relative
      font-size: 21px
      z-index: 1
      display: inline-block
      vertical-align: middle
      font-weight: 700
      color: #FDFC8B
      width: 20px
      height: 26px
      text-align: center
      background: #5F3FA6
      margin: 0 3px
      border-radius: 8px
      box-sizing: border-box
  .title
    position: absolute
    top: 125px
    left: 294px
    font-size: 18px
  .video-box
    position: absolute
    top: 168px
    left: 18px
    width: 464px
    height: 261px
    border-radius: 20px
    overflow: hidden
    cursor: pointer
    video, img
      width: 100%
      height: 100%
    img
      position: absolute
      top: 0
      left: 0
  .fake-play-button
    position: absolute
    left: 198px
    top: 100px
    width: 60px
    height: 60px
    background: url('../../../img/project_demo/play_status.png')
    background-size: 60px 60px
  .lyric-box
    position: absolute
    top: 168px
    right: 18px
    width: 406px
    height: 261px
    overflow: hidden
    cursor: pointer
    background-color: #794FB5
    border-radius: 20px
    .title
      position: absolute
      top: 37px
      left: 29px
      font-size: 24px
      font-weight: 700
      color: #E4DBF0
      width: 348px
      text-align: left
      overflow: hidden
      text-overflow: ellipsis
      white-space: nowrap 
    .line
      position: absolute
      top: 82px
      left: 29px
      width: 345px
      height: 1px
      background-color: #C877E8
    .lyric
      position: absolute
      top: 97px
      left: 29px
      text-align: left
      width: 348px
      height: 150px
      overflow-y: auto
      &::-webkit-scrollbar
        width: 5px
      &::-webkit-scrollbar-thumb
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.2);
.pd-join
  width: 600px
  height: 40px
  background: rgba(0,0,0,0.3)
  border-radius: 32px
  margin: 0 auto
  margin-top: 40px
  position: relative
  @media only screen and (max-height: 670px)
    margin-top: 30px
  .bottom-tips
    position: absolute
    top: 70px
    left: 34%
    font-size: 14px
  .dino-tips
    position: absolute
    font-size: 14px
    width: 370px
    height: 110px
    left: 50%
    top: 50%
    transform: translate(-50%,-50%)
    -webkit-transform: translate(-50%, -50%)
    background: url("../../../img/project_demo/dino_tips.png")
    background-size: 100% 100%
    color: #000
    span
      display: inline-block
      margin-left: 100px
      width: 260px
      margin-top: 50px
  .left
    width: 146px
    height: 40px
    text-align: center
    line-height: 40px
    position:absolute
    span
      display: inline-block
      width: 16px
      height: 16px
      background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
      background-size: 380px
      background-position: -349px 1px
      margin: -1px 5px
  .right
    width: 146px
    height: 40px
    text-align: center
    line-height: 40px
    position:absolute
    right: 0
    span
      display: inline-block
      width: 16px
      height: 14px
      background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
      background-size: 380px
      background-position: -365px 0
      margin: -1px 3px
  .status
    width:300px
    height:90px
    position: absolute
    left: 160px
    top: -12px
    .end
      width: 260px
      height: 60px
      background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
      background-size: 284px
      text-align: center
      font-size: 28px
      line-height: 56px
  .status-button
    width:300px
    height:90px
    background: url("../../../img/project_demo/pd_btn_4.png") no-repeat
    background-size: 100% 100%
    position: absolute
    left: 150px
    top: -25px
    &:hover
      background: url("../../../img/project_demo/pd_btn_2.png") no-repeat
      background-size: 100% 100%
    &:active
      background: url("../../../img/project_demo/pd_btn_3.png") no-repeat
      background-size: 100% 100%
    &.unjoin
      background: url("../../../img/project_demo/pd_btn_1.png") no-repeat
      background-size: 100% 100%
      .join
        &:active
          line-height: 48px
    .join
      width: 260px
      height: 60px
      text-align: center
      position: absolute
      left: 20px
      top: 10px
      line-height: 48px
      font-size: 28px
      color: #fff
      cursor: pointer
      &:after
        content:" "
        display: inline-block
        width: 260px
        height: 60px
        border-radius: 28px
        display: none
        position: absolute
        top: 0
        left: 0
      &:active
        line-height: 60px
      
 
</style>
