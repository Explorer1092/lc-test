<template lang="jade">
  .video-box(v-if="list")
    .pd-detail-label 
      select-box(:list="list",:selectShow="false",@select="selectLevel")
      .text 获奖名单
      .tab(ref="tab")
        .tab-bg(:class="'tab-'+active")
        .tab-item(v-if="item.awardsTypeId !== 1",v-for="(item, i) in tabs",:class="'tab-'+i",@click="changeTab(i,item.name,item.awardsTypeId,item.id)") {{item.name}}
    .pd-detail-thumb(ref="pd_detail_thumb",@scroll="conScroll($event)",:class="{'scroll':show}")
      .video-container(ref="video_container")
        rank-item(v-if="!mine&&ranks",class="animated fadeIn",v-for="(item, i) in ranks",:rank="item",:rankName="rankName")
        video-item(v-if="mine",class="animated fadeIn",v-for="(item, i) in ranks",:work="item",:partitionId="partitionId",:index="i",:focus="3",:status="3")
        .null(v-if="!ranks",class="animated fadeIn")
          .dino-null
          .text 这里还什么都没有
    .spinner(v-if="loading",class="animated fadeIn")
      vloading
    .bottom-tips(v-if="bottomTips") 没有更多了
</template>
<script>
import selectBox from './select.vue'
import rankItem from './rank_item.vue'
import videoItem from './video_item.vue'
import vloading from './_loading.vue'
import axios from 'axios'
import Toolkit from '../js/toolkit.js'
export default {
  data() {
    return {
      tabs: [],
      partitionId: '',
      awardId: 4,
      pageNo: 1,
      pageSize: 21,
      ranks: null,
      active: 0,
      loading: true,
      list: null,
      total: 0,
      mine: false,
      initList: {},
      myPartition: '',
      bottomTips: false,
      rankName: ''
    }
  },
  components: {
    selectBox,
    rankItem,
    videoItem,
    vloading
  },
  props: ['show'],
  mounted() {
    axios.get(`/rest/activity/api/activity/user/activity/getPartitionByActivityIdAndStudentId/${this.$route.params.pdId}`)
      .then((res) => {
        if (res.data.data) {
          this.myPartition = res.data.data.id
        }
        this.init()
      })
      .catch((res) =>{
      })
  },
  updated(){
    this.$refs.pd_detail_thumb.style.height = (document.body.offsetHeight - 200)+'px'
    this.$refs.tab.style.right = `-${(5-this.tabs.length)*90}px`
  },
  methods: {
    changeTab(i,name,awardsTypeId,awardId){
      this.pageNo = 1
      this.total = 0
      this.$playSound("click")
      this.active = i
      this.loading = true
      if (this.awardId === awardId) {
        this.loading = false
        return
      }
      this.mine = false
      this.ranks = []
      this.awardId = awardId
      this.rankName = name
      if (awardsTypeId === 4) {
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_winners_mySubmission'})
        this.mine = true
        this.getMyWorks()
        return
      }
      if (name.indexOf('优秀') > -1) {
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_winners_excellenceAward'})
      }
      if (name.indexOf('人气') > -1) {
        sa.track('learning_click', {'click_id': 'pc_learning_activity_competitionArena_competition_winners_mostPopularAward'})
      }
      this.getRanks()
    },
    getRanks(){
      axios.get(`/rest/activity/api/activity/user/resource/getAwardResourcesByPartitionIdAndAwardId/${this.partitionId}/${this.awardId}/${this.pageNo}/${this.pageSize}`)
        .then((res) => {
          this.loading = false
          if (!this.ranks) {
            this.ranks = []
          }
          if(res.data.data&&res.data.data.list){
            this.total = res.data.data.total
            this.ranks = this.ranks.concat(res.data.data.list)
          }else{
            if (this.pageNo === 1) {
              this.ranks = null
            } 
          }
        })
        .catch((err) => {
        })
    },
    conScroll($event){
      let num = this.$refs.pd_detail_thumb.scrollTop + this.$refs.pd_detail_thumb.clientHeight
      if (num>=this.$refs.video_container.clientHeight) {
        if (this.total > this.pageNo*this.pageSize) {
          this.pageNo++
          this.loading = true
          this.getMore()
        }else{
          this.bottomTips = true
          setTimeout(()=>{
            this.bottomTips = false
          },2000)
        }
      }
    },
    selectLevel(id){
      this.pageNo = 1
      this.total = 0
      this.partitionId = id
      this.loading = true
      this.ranks = null
      this.$emit('selectLevel',id)
      this.active = 0
      this.tabs = this.initList[id]
      if (this.tabs[0].awardsTypeId !== 4) {
        this.awardId = this.tabs[0].id
        this.getRanks()
      }else{
        this.getMyWorks()
      }
    },
    getMyWorks(){
      axios.get(`/rest/activity/api/activity/user/resource/getMyResourcesByPartitionIdAndStudentId/${this.partitionId}`)
        .then((res) => {
          this.loading = false
          this.ranks = []
          if (res.data.data) {
            let obj = res.data.data
            obj.ago = Toolkit.getTime(obj.gmtCreate)
            this.ranks.push(obj)
          }else{
            this.ranks = null
          }
        
        })
        .catch((err) => {
        })
    },
    getMore(){
      this.loading = true
      this.getRanks()
    },
    thumbsOverflow(style){
      this.$refs.pd_detail_thumb.style.overflowY = style
    },
    init(){
      axios.get(`/rest/activity/api/activity/user/activity/getActivityAwardInfoByActivityId/${this.$route.params.pdId}`)
        .then((res) => {
          let list = res.data.data
          for (var i = 0; i < list.length; i++) {
            let key = list[i].id
            if ( i === 0) {
              this.partitionId = list[i].id
            }
            let obj = {}
            let _arr = []
            list[i].awardModelList.forEach((val, index) => {
              if (val.awardsTypeId !== 1) {
                _arr.push(val)
              }
            })
            obj[key] = _arr
            this.initList = Object.assign(this.initList,obj)
          }
          if(this.myPartition !== ''){
            this.list = []
            this.list[0] = null
            list.forEach((val, index) => {
              if(val.id == this.myPartition){
                this.list[0] = val
              }else{
                this.list.push(val)
              }
            })
          }else{
            this.list = list
          }
          this.partitionId = this.list[0].id
          this.awardId = this.initList[this.partitionId][0].id
          this.tabs = this.initList[this.partitionId]
          this.rankName = this.initList[this.partitionId][0].name
          this.getRanks()
        })
        .catch((res) =>{
    
        })
    }
  },
  created(){
  }
}
</script>
<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased
  .video-box
    padding-top: 30px
  .pd-detail-label
    text-align: center
    width: calc(100% - 60px)
    height: 50px
    background: #794FB5
    border-radius: 25px
    margin: 0 auto
    padding: 0 10px
    .text
      color: #fff
      font-size: 20px
      position: absolute
      top: 40px
      left: 50%
      display: inline-block
  .pd-detail-thumb
    width: 100%
    text-align: left
    padding: 10px
    margin-top: 20px
    -webkit-overflow-scrolling: touch
    &.scroll
      overflow-y: auto
    &::-webkit-scrollbar
      display: none
    .video-container
      width: 100%
      position: relative
      margin-top: -10px
      margin-left: 10px
      padding-top: 10px
  .tab
    width: 450px
    height: 100%
    float: right
    position: relative
    cursor: pointer
    padding-top: 5px
    .tab-bg
      width: 90px
      height: 40px
      position: absolute
      border-radius: 25px
      background: url("../../../img/project_demo/detial_tab.png") no-repeat
      background-size: 100% 100%
      transition-duration: .8s
      &.tab-0
        left: 0
      &.tab-1
        left: 90px
      &.tab-2
        left: 180px
      &.tab-3
        left: 270px
      &.tab-4
        left: 360px
    .tab-item
      width: 90px
      display: inline-block
      position:absolute
      z-index: 1
      height: 100%
      padding-top: 12px
      font-size: 14px
      color: #fff
      white-space:nowrap
      overflow:hidden
      text-overflow:ellipse
      &.tab-0
        left: 0
      &.tab-1
        left: 90px
      &.tab-2
        left: 180px
      &.tab-3
        left: 270px
      &.tab-4
        left: 360px
  .null
    width: 300px
    height: 300px
    position: absolute
    left: 50%
    top: 50%
    transform: translate(-50%,10%)
    -webkit-transform: translate(-50%,10%)
    .dino-null
      width: 285px
      height: 210px
      margin: 0 auto
      background: transparent url("../../../img/project_demo/null2.png") no-repeat
      background-size: 100% 100%
    .text
      font-size: 24px
      margin-top: 50px
      text-align: center
      color: #fff
  .spinner
    width: 100px
    height: 60px
    text-align: center
    font-size: 10px
    position: absolute
    top: 20%
    left: 48%
    z-index: 8
  .bottom-tips
    font-size: 12px
    text-align: center
    color: #fff
    line-height: 28px
</style>
