<template lang="jade">
  .pd-detail-subject
    .pd-robot
      img(:src="detail.detailsImage" @click="goToDemoView")
      .pd-robot-play-button(@click="goToDemoView",v-if="hasDemoVedio")
      .robot-bottom-container(v-if="detail.activityStudentResource !== 3")
        .bottom-tips {{tipsName[detail.activityStudentResource]}}
        .clock(v-for="(item, i) in day") {{item}}
        .word-day 天
        .clock(v-for="(item, i) in hour") {{item}}
        .word-hour 小时
    .pd-join
      .left 
        span
        | {{detail.totalNum}}人参赛
      .right
        span 
        | {{detail.totalResourceNum}}个作品
      .status(:class="{'status-button':detail.activityStudentResource !== 3,'unjoin':detail.activityStudentResource !== 0}")
        .join(@click="join",:class="{'end': detail.activityStudentResource === 3}") {{statusName[detail.activityStudentResource]}}
      .dino-tips(v-show="numClass && detail.activityStudentResource == 0")
        span {{joinButtonToastText}}
      .bottom-tips(v-show="!noLevel && !numClass && detail.activityStudentResource == 0") {{trips}}
      .dino-tips(v-show="noLevel")
        span 该活动下面不存在于学生level对应赛区
    .pd-award(v-if="awards",@scroll="conScroll",ref="pd_award",  @mousewheel.stop="doNothing", @DOMMouseScroll.stop="doNothing")
      .pd-award-container(ref="pd_award_container",@mousewheel="userScrollDown($event)",@DOMMouseScroll="userScrollDown($event)")
        .pd-award-item(v-for="(item, i) in awards", :class="{'four-items' : awards.length >= 4}")
          .img-container
            img(v-if="item.prizes",v-for="(x, n) in item.prizes",:src="x.imgUrl")
            span(v-if="!item.prizes") 奖品图暂缺
          .text-name {{item.name}}
          .num(v-if="item.awardsNum<9999999") {{item.awardsNum}}名
          .num(v-if="item.awardsNum === 9999999") 参与即得
    .spinner(v-if="!awards",class="animated fadeIn")
      vloading
</template>
<script>
import axios from 'axios'
import vloading from './_loading.vue'
import cookies from 'cookies-js'

export default {
  data() {
    return {
      day: ['0','6'],
      hour: ['1','0'],
      awards: null,
      activityId: this.$route.params.pdId,
      statusName: ['我要参加','已参赛','投票结束','活动结束','未开始', '上传已截止'],
      tipsName: ['距离投票结束还有','距离投票结束还有','距离颁奖开始还有','距离颁奖开始还有','距离比赛开始还有'],
      timestamp: null,
      prizes: [0,1,2],
      numClass: 0,
      _awards: {},
      pid: this.partitionId,
      noLevel: false,
      hasDemoVedio:false,
      joinButtonToastText: ''
    }
  },
  props:['detail','partitionId'],
  components: {
    vloading
  },
  computed:{
    trips(){
      //steam大赛
      if (this.activityId == '56') {
        return '完成4节JCL课程可解锁活动资格'
      }
      if (this.detail.activityType == 5) {
        return '完成两节1对1课程后参与'
      }
      if (this.detail.activityType == 6) {
        return ''
      }
      return '完成4节夏令营课程可解锁大赛'
    }
  },
  mounted() {
    this.timestamp = new Date().getTime()
    let time = 0
    if (this.detail.activityStudentResource == 0 || this.detail.activityStudentResource == 1) {
      time = this.detail.endVotetime - this.timestamp
    }
    if (this.detail.activityStudentResource == 2 || this.detail.activityStudentResource == 3) {
      time = this.detail.endTime - this.timestamp
    }
    if (this.detail.activityStudentResource == 4) {
      time = this.detail.startTime - this.timestamp
    }
    this.day = this.fullTime(parseInt(time / (1000 * 60 * 60 * 24))).toString().split('')
    this.hour = this.fullTime(parseInt((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).toString().split('')
    if (!this.partitionId) {
      this.getAwards()
    }else{
      this.awards = this._awards[this.partitionId]
    }
    this.checkOutIsHaveDemoVideo(this.detail.demoVideo)
     
  },
  watch: {
    'partitionId': function() {
      this.awards = this._awards[this.partitionId]
    }
  },
  updated(){
    if (this.awards && this.awards.length>3) {
      let len = this.awards.length*320
      this.$refs.pd_award_container.style.width = `${len}px`
    }else{
      if(this.$refs.pd_award_container)
        this.$refs.pd_award_container.style.width = '100%'
    }
  },
  methods: {
    doNothing() {
      return
    },
    //检查是否有对应的demoVideoUrl
    checkOutIsHaveDemoVideo(demoVideoUrl){
      if(typeof demoVideoUrl == "string" && demoVideoUrl !=="null" && demoVideoUrl.length > 0){
        this.hasDemoVedio = true
      }
    },

    //add by luomingzhong 去demo视频
    goToDemoView(){
      if(this.hasDemoVedio){
        this.$router.push({
          path:`/pd_demo_video/${this.activityId}`
        })
      }
      //减少接口请求
      localStorage.setItem("demoVideoUrl",this.detail.demoVideo)
    },
    userScrollDown(e) {
      this.$refs.pd_award.scrollLeft += e.deltaY
    },
    conScroll(){
    },
    fullTime(t){
      return t < 10 ? '0'+t : t
    },
    getAwards(){
      axios.get(`/rest/activity/api/activity/user/activity/getActivityAwardDetailByActivityId/${this.activityId}`)
        .then((res) => {
          let arr = res.data.data
          this._awards = {}
          for (var i = 0; i < arr.length; i++) {
            let key = arr[i].id
            if ( i === 0) {
              this.pid = arr[i].id
            }
            let obj = {}
            obj[key] = arr[i].awardModelList
            this._awards = Object.assign(this._awards,obj)
          }
          this.awards = this._awards[this.pid]
        })
        .catch((err) => {
        })
    },
    join(){
      if(this.detail.activityStudentResource !== 0){
        return
      }
      sa.track('learning_click', {
        'click_id': 'pc_learning_activity_competitionArena_competition',
        'pd_id': this.$route.params.pdId })
      this.$playSound("click")
      this.$emit('gojoin',true) // 展示全屏loading
      axios.post(`/rest/activity/api/activity/user/activity/signByActivityIdAndStudentId/${this.$route.params.pdId}`)
        .then((res) => {
          if(res.data.code === 100022) {
            // 弹出提示：该活动下面不存在于学生level对应赛区
            this.noLevel = true
            setTimeout(() => {
              this.noLevel = false
            }, 1500)
            this.$emit('gojoin','numClass') // 取消全屏loading
            return
          } else if (res.data.code === 0) {
            // 报名参赛,res.data.data返回数字0代表成功. 1,2,3,4分别代表还需要完成夏令营课程数量
            if (res.data.data === 0) {
              if ([5,6].indexOf(this.detail.activityType) > -1 && cookies.get('isFromApp')) {
                // ipad逻辑
                let type = 0 // @type   0:客户端提示用户“拍照”还是“相册”, 1:直接拍照, 2:直接从相册中选择
                let _ua = navigator.userAgent
                let deviceRegex = /devicemodel\/iPad\d+(\,\d+)*/g // 设备版本, 匹配目标示例: devicemodel/iPad7,5
                let appVersionRegex = /study-app\/\d+(\.\d+)*/g // app版本, 匹配目标示例: study-app/2.13.4
                let versionNumberArray = _ua.match(appVersionRegex)[0].split('/')[1].split('.') // 把UA中的版本号取出来. 格式示例: ["2", "13", "4"]
                let isOldFasionDevice = false

                if (_ua.match(deviceRegex) && _ua.match(deviceRegex)[0].match(/\d+/) == 2 || !_ua.match(deviceRegex)) {
                  //设备版本如果是2 或者 取不到设备号，就属于低端机，不让走拍摄模式，只能从相册选择视频。
                  isOldFasionDevice = true 
                }
                if (versionNumberArray[0] >= 2 && versionNumberArray[1] >= 14 && !isOldFasionDevice) {
                  // APP版本高于2.14 且不为低端机型 则走用户拍摄模式
                  this.$router.push({path: `/video_upload/${this.$route.params.pdId}/user_shoot?activityType=${this.detail.activityType}`})
                } else {
                  this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}/${this.detail.activityType}`})
                }
              } else {
                this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}/${this.detail.activityType}`})
              }

            } else {
              this.$emit('gojoin','numClass')
              this.numClass = res.data.data
              if (this.detail.activityType == 5) {
                this.joinButtonToastText = `再完成${this.numClass}节1v1课程可解锁大赛`
              } else if (this.detail.activityType == 6) {
                this.joinButtonToastText = `抱歉，您暂不满足参与条件哦~`
              } else {
                this.joinButtonToastText = `再完成${this.numClass}节夏令营课程可解锁大赛`
              }
              setTimeout(() => {
                //关闭toast
                this.numClass = 0
              }, 2000)
            }
          } else if(res.data.code == 100035) {
            //表明不在白名单内
            this.$emit('gojoin','numClass')
            this.$showToast('本活动暂时只开放给小创造者联盟课程学员，请您等待该课程正式开放。')
          } else if (res.data.code == 100051 && this.detail.activityType == 6) {
            this.$emit('gojoin','numClass')
            this.$showToast('抱歉，您暂不满足参与条件哦~')
          } else {
            this.$emit('gojoin',false)
          }
        })
    },
    checkWorkWall() {
      let uploadUrl
      if ([5,6].indexOf(this.detail.activityType) > -1) {
        uploadUrl = `/video_upload/${this.$route.params.pdId}`
      } else {
        uploadUrl = `/pd_upload/${this.$route.params.pdId}`
      }
      axios.get(`/rest/activity/api/activity/user/resource/getResourcesByActivityIdAndStudentId/${this.$route.params.pdId}/1/1`)
        .then((res) => {
          if(res.data.code === 0) {
            if (!res.data.data) {
              this.$router.push({path: uploadUrl})
              return
            }
            if (res.data.data.list.length) {
              this.$router.push({path: `/work_wall/upload/${this.$route.params.pdId}/${this.detail.activityType}`})
            } else {
              this.$router.push({path: uploadUrl})
            }
          }
        })
    }
  }
}
</script>
<style lang="stylus" scoped>
  .pd-detail-subject
    width: 100%
    height: 500px
    position: fixed
    background-size: 100% auto
    color: #fff
    z-index: 1
    .pd-robot
      width: 1000px
      height: 280px
      margin: 0 auto
      margin-top: 30px
      background: url("../../../img/project_demo/robot.png") no-repeat
      background-size: 100% 100%
      position: relative
      text-align: center
      @media  only screen and (max-height : 670px)
        margin-top: 0
      // @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
      //   width: 80%
      //   img
      //     width: 622px
      img
        width: 682px
        height: 212px
        margin-top: 13px
        border-radius: 50px
        // @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
        //   width: 622px
      .robot-bottom-container
        width: 100%
        height: 34px
        position: absolute
        bottom: 14px
        .bottom-tips
          width: 140px
          display: inline-block
          height: 34px
          position: absolute
          bottom: -10px
          left: 230px
        .clock
          display: inline-block
          color: #FDFC8B
          font-size: 36px
          font-weight: 700
          background: #5F3FA6
          margin: 0 3px
          border-radius: 8px
          width: 20px
          height: 34px
          text-align: center
          padding: 3px
          line-height: 36px
          @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
            line-height: 33px
        .word-day
          font-size: 20px
          color: #5F3FA6
          font-weight: 700
          display: inline-block
        .word-hour
          font-size: 20px
          color: #5F3FA6
          font-weight: 700
          display: inline-block
    .pd-join
      width:600px
      height:40px
      background:rgba(0,0,0,0.3)
      border-radius:32px
      margin: 0 auto
      margin-top: 40px
      position: relative
      @media  only screen and (max-height : 670px)
        margin-top: 30px
      .bottom-tips
        position: absolute
        top: 70px
        left: 0px
        font-size: 14px
        width: 600px
        text-align: center
      .dino-tips
        position: absolute
        font-size: 14px
        width: 370px
        height: 110px
        left: 50%
        top: 50%
        transform: translate(-50%,-50%)
        -webkit-transform: translate(-50%, -50%)
        background: url("../../../img/project_demo/dino_tips.png")
        background-size: 100% 100%
        color: #000
        span
          display: inline-block
          margin-left: 100px
          width: 260px
          margin-top: 50px
      .left
        width: 146px
        height: 40px
        text-align: center
        line-height: 40px
        position:absolute
        span
          display: inline-block
          width: 16px
          height: 16px
          background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
          background-size: 380px
          background-position: -349px 1px
          margin: -1px 5px
      .right
        width: 146px
        height: 40px
        text-align: center
        line-height: 40px
        position:absolute
        right: 0
        span
          display: inline-block
          width: 16px
          height: 14px
          background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
          background-size: 380px
          background-position: -365px 0
          margin: -1px 3px
      .status
        width:300px
        height:90px
        position: absolute
        left: 160px
        top: -12px
        .end
          width: 260px
          height: 60px
          background: url("../../../img/project_demo/pd_detail_2.png") no-repeat
          background-size: 284px
          text-align: center
          font-size: 28px
          line-height: 56px
      .status-button
        width:300px
        height:90px
        background: url("../../../img/project_demo/pd_btn_4.png") no-repeat
        background-size: 100% 100%
        position: absolute
        left: 150px
        top: -25px
        &:hover
          background: url("../../../img/project_demo/pd_btn_2.png") no-repeat
          background-size: 100% 100%
        &:active
          background: url("../../../img/project_demo/pd_btn_3.png") no-repeat
          background-size: 100% 100%
        &.unjoin
          background: url("../../../img/project_demo/pd_btn_1.png") no-repeat
          background-size: 100% 100%
          .join
            &:active
              line-height: 48px
        .join
          width: 260px
          height: 60px
          text-align: center
          position: absolute
          left: 20px
          top: 10px
          line-height: 48px
          font-size: 28px
          color: #fff
          cursor: pointer
          &:after
            content:" "
            display: inline-block
            width: 260px
            height: 60px
            border-radius: 28px
            display: none
            position: absolute
            top: 0
            left: 0
          &:active
            line-height: 60px
    .spinner
      position: absolute
      left: 48%
      top: 84%
      z-index: 99
      width: 100px
      height: 60px
      text-align: center
      font-size: 10px
    .pd-award
      height: 150px
      margin: 50px auto
      width: 960px
      text-align: center
      overflow-x: auto
      overflow-y: hidden
      @media  only screen and (max-height : 670px)
        margin-top: 34px
        height: 158px
      &::-webkit-scrollbar
        display: none
      .pd-award-item
        width: 280px
        height: 140px
        display: inline-block
        background: url("../../../img/project_demo/mask.png") no-repeat
        background-size: 100% 48%
        background-position-y: 72px
        margin: 0 20px
        position: relative
        text-align: center
        &.four-items
          margin: 0 -10px
          transform: scale(0.8)
        @media  only screen and (max-height : 670px)
          margin-top: 15px
        .img-container
          width: 100%
          height: 100px
          img
            width: 90px
            height: 90px
            margin: 3px auto
          span
            margin-top: 50px
            display: inline-block
        .text-name
          display: inline-block
          color: #FDFC8B
          font-size: 16px
          width: 120px
          position: absolute
          left: 78px
          bottom: 8px
          @media  only screen and (min-device-width : 768px) and (max-device-width : 1024px) and (orientation : landscape)
            bottom: 5px
        .num
          display: inline-block
          font-size: 14px
          width: 58px
          text-align: center
          position: absolute
          right: 30px
          bottom: 8px
//add by luomingzhog
.pd-robot-play-button
   position:absolute
   left:470px
   top:110px
   width:60px 
   height:60px 
   background:url(../../../img/project_demo/play_status.png)
   background-size:60px 60px
</style>
