<template lang="jade">
  .pd-detail-thumb-item(v-if="work",:class="{'mine':work.studentId == studentId}",@click="openVideo($event,work.id)")
    .item-top
      img(v-if="work.coverImage",:src='work.coverImage | autoCover')
      img(v-if="!work.coverImage",src="../../../img/project_demo/defult_img.png")
      .tips(v-if="work.status === 0||work.status === 6") 审核中，仅自己可见
      .play-status
      .view-mask(v-if='work.view')
        .view {{work.view}}
      .medal(v-if="(focus!== 2 && focus!==3) && (work.awardName || work.rank!=='')", :class="'rank-'+index") {{index+1}}
    .itme-bottom
      .title-time
        .title {{cutTitleLength(work.name)}}
        .time(style="opacity: 0.5;") {{work.ago}}
      .other
        .avatar
          img(src = "../../../img/common/avatar/default.png", v-if = " !work.avatarUrl && (work.avatar == 'default' || !work.avatar)")
          img(src = "../../../img/common/avatar/boy_1.png", v-if = " !work.avatarUrl && work.avatar == 'boy_1'")
          img(src = "../../../img/common/avatar/boy_2.png", v-if = " !work.avatarUrl && work.avatar == 'boy_2'")
          img(src = "../../../img/common/avatar/boy_3.png", v-if = " !work.avatarUrl && work.avatar == 'boy_3'")
          img(src = "../../../img/common/avatar/boy_4.png", v-if = " !work.avatarUrl && work.avatar == 'boy_4'")
          img(src = "../../../img/common/avatar/girl_1.png", v-if = " !work.avatarUrl && work.avatar == 'girl_1'")
          img(src = "../../../img/common/avatar/girl_2.png", v-if = " !work.avatarUrl && work.avatar == 'girl_2'")
          img(src = "../../../img/common/avatar/girl_3.png", v-if = " !work.avatarUrl && work.avatar == 'girl_3'")
          img(src = "../../../img/common/avatar/girl_4.png", v-if = " !work.avatarUrl && work.avatar == 'girl_4'")
          // 自定义头像
          img(:src = "work.avatarUrl", v-if="work.avatarUrl")
        .name
          | {{cutNameLength(work.stuEnglishName)}}
          span(v-if="work.studentId == studentId")
        .vote
          .vote-heart(:class="{'liked':liked}", @click='vote')
          .vote-num
            span {{fixNum(count)}}
</template>
<script>
  import axios from "axios"
  import formUrlencoded from "form-urlencoded"
  import cookies from "cookies-js"
  import Toolkit from "../js/toolkit.js"
  export default {
    data() {
      return {
        testImg:
          "https://media.vipkidstatic.com/homework/image/rich_59ae41f5-61ad-48de-a264-c79b46fdf4a71526561156728.png",
        liked: this.work.liked === 2 ? false : true,
        count: this.work.count,
        studentId: cookies.get("studentId")
      }
    },
    props: ["work", "partitionId", "index", "focus", "status"],
    components: {},
    mounted() {},
    filters: {
      autoCover(val) {
        val = val || ""
        return (
          val.split("?")[0] +
          "?imageMogr2/auto-orient/thumbnail/!288x162r/gravity/Center/crop/288x162/quality/85"
        )
      }
    },
    methods: {
      cutTitleLength(text) {
        if (text && text.length > 10) {
          return text.substring(0, 10) + "..."
        } else {
          return text
        }
      },
      cutNameLength(name) {
        if (name && name.length > 5) {
          return name.substring(0, 5) + "..."
        } else {
          return name
        }
      },
      fixNum(num) {
        if (num > 9999) {
          return (num / 10000).toFixed(1) + "w"
        } else {
          return num
        }
      },
      openVideo(e, id) {
        if (e.target.className.indexOf("vote-heart") == -1) {
          sa.track("learning_click", {
            click_id: `pc_learning_activity_competitionArena_competition_Submission`
          })
          this.$router.push({ path: `/pd_video/${id}` })
        }
      },
      vote() {
        // 参赛状态 0:我要参加 1:已参赛 2:投票结束 3:活动结束 4:未开始,5:上传截止,
        // 0,1,5 是可以投票的

        if (this.status != 0 && this.status != 1 && this.status != 5 ) {
          this.$showToast('投票已经结束了哦~宝贝')
          return
        }
        if (!this.liked) {
          this.liked = true
          this.count++
        } else {
          this.liked = false
          this.count--
        }
        this.$emit('vote', {
          resourceId: this.work.id,
          count: this.count
        })
        axios
          .post(
            "/rest/activity/api/activity/user/like",
            JSON.stringify({
              partitionId: this.partitionId,
              resourceId: this.work.id
            }),
            { headers: { "Content-Type": "application/json" } }
          )
          .then(res => {})
      },
      getVoteCounts() {
        axios
          .get("/rest/activity/api/activity/user/like/detail", {
            params: {
              partitionId: this.partitionId,
              resourceId: this.work.id
            }
          })
          .then(res => {
            if (res.data.data !== null) {
              this.liked = res.data.data[0].liked === 2 ? false : true
              this.count = res.data.data[0].count
            } else {
              this.liked = false
              this.count = 0
            }
          })
      }
    },
    created() {}
  }
</script>
<style lang="stylus" scoped>
  .name
    span
      display: inline-block
      width: 24px
      height: 14px
      background: url('../../../img/project_demo/rank.png') no-repeat
      background-size: 70px
      background-position: -44px -44px
  .pd-detail-thumb-item
    width: 308px
    height: 260px
    margin: 10px
    display: inline-block
    padding: 10px 10px
    background: #794FB5
    border-radius: 20px
    &.mine
      background: #AF62D3
    .item-top
      width: 288px
      height: 162px
      position: relative
      .tips
        position: absolute
        top: 138px
        left: 0
        width: 278px
        height: 24px
        line-height: 22px
        background: #FF6600
        border-radius: 0 0 16px 16px
        opacity: 0.8
        padding-left: 10px
        color: #fff
        text-align: center
      img
        width: 100%
        height: 100%
        border-radius: 16px
      .play-status
        width: 60px
        height: 60px
        background: url('../../../img/project_demo/play_status.png') no-repeat
        background-size: 100% 100%
        position: absolute
        top: 35%
        left: 42%
        cursor: pointer
      .medal
        width: 50px
        height: 28px
        line-height: 30px
        text-align: center
        font-weight: 700
        position: absolute
        top: -10px
        left: -10px
        background: url('../../../img/project_demo/rank.png') no-repeat
        background-size: 80px
        color: #fff
        background-position: 0 -80px
        &.rank-0
          width: 60px
          height: 76px
          background: url('../../../img/project_demo/detail.png') no-repeat
          position: absolute
          top: -20px
          left: -20px
          background-size: 166px
          color: transparent
          background-position: -61px 3px
        &.rank-1
          width: 60px
          height: 76px
          background: url('../../../img/project_demo/detail.png') no-repeat
          position: absolute
          top: -22px
          left: -20px
          background-size: 166px
          color: transparent
          background-position: 0 -74px
        &.rank-2
          width: 60px
          height: 76px
          background: url('../../../img/project_demo/detail.png') no-repeat
          position: absolute
          top: -20px
          left: -20px
          background-size: 166px
          color: transparent
      .view-mask
        width: 100%
        height: 40px
        background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.5))
        position: absolute
        bottom: 0
        border-radius: 0px 0px 16px 16px
        .view
          width: 56px
          height: 20px
          color: #fff
          position: absolute
          right: 0
          bottom: 0
          background: url('../../../img/project_demo/eye.png') no-repeat
          background-size: 24px
          padding-left: 34px
    .other
      margin-top: 20px
    .itme-bottom
      position: relative
      width: 288px
      height: 80px
      padding: 5px
      .avatar
        width: 40px
        height: 40px
        display: inline-block
        margin-top: 15px
        position: absolute
        left: 5px
        img
          width: 100%
          height: 100%
          border-radius: 50%
      .name
        display: inline-block
        color: #fff
        font-size: 18px
        position: absolute
        top: 48px
        left: 54px
      .vote
        height: 30px
        cursor: pointer
        position: absolute
        right: 0
        top: 50px
        text-align: left
        padding-right: 8px
        .vote-heart
          display: inline-block
          width: 36px
          height: 30px
          background: url('../../../img/project_demo/detail.png') no-repeat
          background-size: 145px
          background-position: -106px 0
          position: absolute
          left: -16px
          z-index: 3
          &.liked
            background: url('../../../img/project_demo/detail.png') no-repeat
            background-size: 145px
            background-position: -106px -30px
        .vote-num
          display: inline-block
          color: #fff
          text-align: center
          padding-left: 16px
          height: 28px
          background: url('../../../img/project_demo/rectangle@3x.png')
          background-size: 100% 100%
          line-height: 28px
          min-width: 64px
          span
            padding: 0 8px
      .time
        display: inline-block
        float: right
        color: #fff
        font-size: 14px
      .title
        color: #FDFC8B
        float: left
        font-size: 18px
        display: inline-block
</style>
