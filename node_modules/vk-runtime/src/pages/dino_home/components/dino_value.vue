<template lang="jade">
  canvas#c 当前浏览器不支持canvas 请升级！
</template>
<script>
export default {
  data:function(){
    return {
      ctx:null,
      M : Math,
      oW: 65,
      oH: 65,
      lineWidth : 2,// 线宽
      r:0,
      cR:0,
      sp : 0, // 周期偏移量
      nowdata : 0,
      waveupsp : 1
    }
  },
  props:{
    datas:{
      type: Number,
      default: 0
    }
  },
  watch:{
    datas:function(val,oldVal){
      if(val){
        let canvas = document.getElementById("c")
        canvas.width= 65
        canvas.height = 65
        this.r = (this.oW / 2) // 大半径
        this.cR =this.r - 1*this.lineWidth
        this.ctx = canvas.getContext("2d")
        this.ctx.beginPath()
        this.render()
      }
    }
  },
  methods:{
    // 写字
    drawText () {
      this.ctx.globalCompositeOperation = 'source-over'
      var size = 0.4*this.cR
      this.ctx.font = 'bold ' + size + 'px Microsoft Yahei'
      let txt = this.nowdata + '/'+100
      var fonty = this.r + size/2
      var fontx = this.r - size * 0.8
      this.ctx.fillStyle = "#fff"
      this.ctx.textAlign = 'center'
      this.ctx.fillText(txt, this.r, this.r+5)
    },
    // 深紫色圆圈
    grayCircle(){
      this.ctx.beginPath()
      this.ctx.lineWidth = 4
      this.ctx.strokeStyle = '#583995'
      this.ctx.arc(this.r, this.r, this.cR-5, 0, 2 * Math.PI)
      this.ctx.stroke()
      this.ctx.restore()
      this.ctx.beginPath()
    },
    // 白色圆圈
    orangeCircle(){
      this.ctx.beginPath()
      this.ctx.strokeStyle = '#fff'
      this.ctx.lineWidth = 5
      //使用这个使圆环两端是圆弧形状
      this.ctx.lineCap = 'round'
      this.ctx.arc(this.r, this.r, this.cR-5,0 * (Math.PI / 180.0) - (Math.PI / 2),(this.nowdata/100 * 360) * (Math.PI / 180.0) - (Math.PI / 2))
      this.ctx.stroke()
      this.ctx.save()
    },
    //渲染canvas
    render () {
      this.ctx.clearRect(0,0,this.oW,this.oH)
      //灰色圆圈
      this.grayCircle()
      //橘黄色进度圈
      this.orangeCircle()
      let olddata = this.nowdata
      if((this.datas - this.nowdata) > 0) {
        this.nowdata += this.waveupsp
      }
      // 写字
      this.drawText()

      if(olddata !=this.nowdata){
        requestAnimationFrame(this.render)
      }
    }
  }
}
</script>
<style lang="stylus" scoped>

</style>
