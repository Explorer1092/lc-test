<template lang="jade">
  .dino_bg
    // 后退
    top-part(:isAbsoluteFix="true", :ifShow="false")
    // 弹出框透明背景
    .mask(v-show="isShowMask", @click="closeDialog")
    .dino-con(v-show="isShowDinoContent")
      // 页面标题
      .title
      // 进入商店按钮
      .dino-mall(@click="goDinoMall")
        .dino-mall-new.animated.pulse.infinite(v-show="onNew")
      // 服装列表
      .text-content
        .equipment-list-con
          equipment(:list="list",:isLoading="isLoading",:dinoEquipmentObj="dinoEquipmentObj",@changeDinoEquipmentObj="changeDinoEquipmentObj",:petReloadIng="petReloadIng")
          .equipment-more.animated.pulse.infinite(v-show="isShowMore",@click ="getDinoWardrobe")
        .equipment-type-con
          equipmentType(:propParts="propParts",@changePart="changePart",:isLoading="isLoading",:dinoEquipmentObj="dinoEquipmentObj")
      // 舞台
      .platform(:class="isShowZIndex ? 'platform-index':''")
        .platform-value
          .platform-value-round(@click="clickRule")
            .platform-value-round-bg.platform-value-round-bg-no(v-for="(item,index) in dinoValueStart", :key ="index")
              p.platform-value-round-p 0/100
            .platform-value-round-bg-canvas(v-show="dinoValueNum>0")
              dino-value(:datas = "dinoValueNum")
            .platform-value-round-bg.platform-value-round-bg-all(v-for="(item,index) in dinoValueRound" ,:key ="index")
              p.platform-value-round-bg-all-p 100/100
        .platform-dino
          .dino-canvas
            dino(v-if="petObj && petObj.data && petObj.data.data",:petObj = "petObj",@loaded="loaded")
          .platform-dino-name(@mouseenter="textEnter",@mouseout="textOut")
            p(ref="textInner") {{dinoName}}
          .platform-dino-reload(v-show="isHandle")
            .platform-dino-reload-cancel(@click="cancelReload")
            .platform-dino-reload-confirm(@click="petReload")
      // 规则
      dinoDialog(v-show = "isShowRule",@colsebtn="clickRule")
      // 引导
      dino-guide(v-show ="isShowDinoGuidePage",@dinoGuideHideen = "dinoGuideHideen")
      equipmentDialog(v-if="isShowDialogTip && !isShowDinoGuidePage",:tipText="text",:title="title",:isShowTitle="true",:imgType="imgType",:giveMagicSeriesImgSrc="giveMagicSeriesImgSrc",@close="closeDialog")
    // 宠物未出生或者已经关闭状态，通过链接进入页面呈现
    .abnormal(v-show="!isShowDinoContent")
      .abnormal-content
        p.abnormal-content-p oops~ </br>  需要爸爸妈妈打开宠物开关，才能进入房间哦～
</template>


<script>
import axios from 'axios'
import cookies from 'cookies-js'
import TopPart from "../common/top_part.vue"
import dino from './dino.vue'
import dinoDialog from './components/dino_dialog.vue'
import dinoGuide from './components/dino_guide.vue'
import dinoValue from './components/dino_value.vue'
import equipmentDialog from '../dino_mall/components/equipment_dialog.vue'
import equipment from './components/equipment.vue'
import equipmentType from '../dino_mall/components/equipment_type.vue'
import {localStorageUtil} from '../../utils/_untils.js'

export default {
  data:function(){
    return {
      isShowRule: false, // 是否显示规则弹框
      isShowDinoGuidePage: false, // 是否显示引导页
      dinoName:"", // dino 名字
      dinoValueRound:0,// dino 的能量值的达到100的几个圈
      dinoValueNum:0, // dino的能量值 未达到100的值
      dinoValueStart: 0,// dino的能量值为0的几个圈
      animationEnter: false, // 鼠标进入dino名字
      animationOut: false, // 鼠标移除dino名字
      isLoading: false, // 正在加载中
      isShowDinoContent: true, // 是否显示dino内容（防止dino被关闭或未领养通过链接进入）
      petObj:null,
      propParts: '',//服装部位类型
      dinoEquipmentObj:{"HEAD_PARTS":[],"FACE_PARTS":[],"HAND_PARTS":[],"BODY_PARTS":[],"LEG_PARTS":[]},
      start:0 ,// 宠物衣柜页码
      pageTotal: 0,// 衣柜总页码
      isShowMore: false,// 是否显示更多按钮
      list:[],// 宠物服装列表
      isShowZIndex:false,// 是否显示z-index
      dino: null ,
      obj:{},
      startDinoEquipmentObj:{},// 记录原始穿着的服装
      isHandle: false,// 是否操作过服装列表
      propSeries:"" ,// 道具系列
      isErrorMessage:{
        "1010001": "宠物换装失败",
        "1010006":"换装id不允许为空",
        "1010002": "待穿上的宠物道具没有可用余量,库存不足",
        "1010003": "道具已经穿戴在宠物身上",
        "1010004": "道具已经脱下",
        "1010005": "该部位已经有道具穿戴在宠物身上"
      },
      petReloadIng: false, // 是否正在换装
      isShowDialogTip: false, // 赠装扮弹框
      title:"Dino的见面礼",
      text:"Dino的衣柜开启啦，</br> 给小朋友送上一件装扮，快去装扮吧",
      isShowTitle: true,
      imgType:"happy",
      isShowMask: false,// 是否显示透明背景
      giveMagicSeriesImgSrc:"",//赠送装饰图片
      isFirst: true, //是否第一赠
      onNew: false // 是否有上新
    }
  },
  components: {
    TopPart,
    dino,
    dinoDialog,
    dinoGuide,
    dinoValue,
    equipmentType,
    equipment,
    equipmentDialog
  },
  created(){
    this.dinoGuideInfo()
    this.getDinoInfo()
    this.getDinoWardrobe()
    this.getNewShop()
  },
  methods:{
    //显示\关闭规则
    clickRule(){
      this.isShowRule = !this.isShowRule
      if (this.isShowRule) {
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_home_get_rule'
        })
      }
    },
    // 引导页是否显示的信息
    dinoGuideInfo(){
      if(localStorageUtil.get('dino_guide_go')){
        this.isShowDinoGuidePage = false
      }else{
        this.isShowDinoGuidePage = true
        localStorageUtil.set('dino_guide_go', 'show')
      }
    },
    // 关闭引导页
    dinoGuideHideen(){
      this.isShowDinoGuidePage = false
    },
    // 获取宠物的信息
    getDinoInfo(){
      axios.get(`/rest/learninggw/api/pet/homepage/petResourceActionInfo`, {
        params: {
          studentId: cookies.get("studentId"),
          deviceType: "PC_H5"
        }
      }).then((res) => {
        if(res.data && res.data.code == 200 && res.data.data){
          this.petObj = res
          let objCon = res.data.data
          this.dinoName = objCon.pet.name
          let dinoValueData = objCon.pet.haloValue
          if(dinoValueData>300){
            dinoValueData = 300
          }else if(dinoValueData < 0){
            dinoValueData = 0
          }
          this.dinoValueRound = Math.floor(dinoValueData/100)
          this.dinoValueNum = dinoValueData % 100
          this.dinoValueStart = 3 - this.dinoValueRound - (this.dinoValueNum > 0 ? 1 : 0)
          if(objCon.pet.petSwitch =="OFF" || objCon.pet.growUpStatus=="EGG_LOCK"){
            this.isShowDinoContent = false
          }else{
            this.isShowDinoContent = true
          }
          // 获取dino初始服装id
          let startObj = res.data.data.dressedMap
          this.dinoEquipmentObj = JSON.parse(JSON.stringify(startObj))
          this.startDinoEquipmentObj = JSON.parse(JSON.stringify(startObj))
        }else{
          if(res.data.code != 200){
            this.$showToast('获取dino信息失败<br>请检查网络~')
          }
        }
      })
    },
    // 跳转商店n
    goDinoMall(){
      sa.track('learning_click', {
        'click_id': 'pc_learning_dino_home_go_mall'
      })
      this.$router.push({path: "/dino_mall"})
    },
    // dino名字过长，鼠标划过调用
    textEnter(){
      if (!this.animationEnter) {
        this.animationEnter = true
        if (this.$refs.textInner) {
          var textWidth = this.$refs.textInner.scrollWidth - this.$refs.textInner.clientWidth
          Velocity(this.$refs.textInner, {marginLeft: -textWidth}, {
            container: this.$refs.textInner, duration: 1000, mobileHA: false,
            complete: () => {
              this.animationEnter = false
            }
          })
        }
      }
    },
    // dino名字过长，鼠标划出调用
    textOut() {
      if (!this.animationOut) {
        this.animationOut = true
        Velocity(this.$refs.textInner, {marginLeft: 0}, {
          container: this.$refs.textInner, duration: 1000, mobileHA: false,
          complete: () => {
            this.animationOut = false
          }
        })
      }
    },
    loaded(dino){
      this.dino = dino
      setTimeout(() => {
        this.isShowZIndex = true
      }, 500)
    },
    // 更换部位
    changePart(part=''){
      this.list = []
      this.start = 0
      this.propParts = part
      let partName = part ? part.toLowerCase():"all"
      sa.track('learning_click', {
        'click_id': `pc_learning_dino_home_${partName}`
      })
      this.getDinoWardrobe()
    },
    // 更改dino服装
    changeDinoEquipmentObj(item){
    	let arr = [item]
      if(this.dinoEquipmentObj[item.propParts].length>0 && this.dinoEquipmentObj[item.propParts][0].id == item.id){
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_home_try_off'
        })
        this.dinoEquipmentObj[item.propParts] = []
        if(this.obj[item.propParts]){
          delete this.obj[item.propParts]
        }
        this.dino.removeSkin([item.propParts])
      }else {
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_home_try_on'
        })
        if((this.obj && this.obj[item.propParts]) || (this.dinoEquipmentObj && this.dinoEquipmentObj[item.propParts] && this.dinoEquipmentObj[item.propParts].length>0)){
          this.dino.removeSkin([item.propParts])
        }
        this.dinoEquipmentObj[item.propParts] = arr
        this.obj[item.propParts] = JSON.parse(item.pcH5Resource)
        this.dino.replaceSkin(this.obj)
      }
      this.isHandle = true
    },
    // 获取宠物衣柜列表
    getDinoWardrobe(){
    	if(this.start>0){
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_home_get_more'
        })
      }
    	this.isLoading = true
      this.start++
      axios.get("/rest/learninggw/api/pet/petPropStudent/wardrobe", {
        params: {
          studentId: cookies.get('studentId'),
          propParts: this.propParts,
          propSeries: this.propSeries,
          start: this.start,
          limit: 20
        }
      }).then(res => {
        let resObj = res.data
        if(resObj.code == 200 && resObj.data && resObj.data.data){
          this.list = this.list.concat(resObj.data.data)
          this.pageTotal = resObj.data.totalPages
          if(this.start< this.pageTotal){
            this.isShowMore = true
          }else{
            this.isShowMore = false
          }
          if(this.isFirst){
            this.getGiveMagicSeries()
          }
        }else{
          if(resObj.code != 200){
            this.$showToast('获取道具失败<br>请检查网络~')
          }
        }
        this.isLoading = false
      }).catch(v=>{
      	this.isLoading = false
        this.$showToast('获取道具失败<br>请检查网络~')
      })
    },
    // 包括穿上、脱下，脱下并穿上换装
    petReload(){
    	// 防止多次点击
    	if(this.petReloadIng){
    		return
      }
      sa.track('learning_click', {
        'click_id': 'pc_learning_dino_home_save_try_on'
      })
      // 获取脱下和穿上ID
      let deleteArr = []
      let addArr = []
      for(let key in this.startDinoEquipmentObj){
      	let startKeyObj = this.startDinoEquipmentObj[key]
        let newKeyObj = this.dinoEquipmentObj[key]

        if(startKeyObj.length>0 && newKeyObj.length>0){
          if(startKeyObj[0].id != newKeyObj[0].id){
            deleteArr.push(startKeyObj[0].id)
            addArr.push(newKeyObj[0].id)

          }
        }else if(startKeyObj.length>0 && newKeyObj.length<=0){
          deleteArr.push(startKeyObj[0].id)
        }else if(startKeyObj.length<=0 && newKeyObj.length>0){
          addArr.push(newKeyObj[0].id)
        }
      }
      // 检测是否换装
      if(deleteArr.length==0 && addArr.length==0){
        this.$showToast("目前还没有进行换装，请换装")
      	return
      }
      // 监控穿参打点
      let msg = {
        studentId: cookies.get("studentId"),
        dressOnIds: addArr.join(','),
        dressOffIds: deleteArr.join(',')
      }
      sa.track('learning_click', {
        'error_url': "/rest/learninggw/api/pet/petPropStudent/shiftProps" + msg
      })
    	this.petReloadIng = true
      axios.get("/rest/learninggw/api/pet/petPropStudent/shiftProps", {
        params: {
          studentId: cookies.get("studentId"),
          dressOnIds: addArr.join(','),
          dressOffIds: deleteArr.join(',')
        }
      }).then(res => {
        if(res.data.code == 200){
          this.startDinoEquipmentObj = JSON.parse(JSON.stringify(this.dinoEquipmentObj))
          this.$showToast("换装成功","happy")
        }else{
          let message = this.isErrorMessage[res.data.code]
          if(message){
            this.$showToast(message)
          }else{
            this.$showToast("换装失败:"+res.data.code)
          }
        }
        this.petReloadIng = false
        this.isHandle = false
      }).catch((err) => {
      	// 监控报错打点
        sa.track('learning_click', {
          'error_url': "/rest/learninggw/api/pet/petPropStudent/shiftProps" + msg,
          'error_msg': JSON.stringify(err.response.data)
        })
        this.petReloadIng = false
        this.isHandle = false
        this.$showToast("换装失败")
      })
    },
    // 取消换装
    cancelReload(){
      sa.track('learning_click', {
        'click_id': 'pc_learning_dino_home_cancel_try_on'
      })
    	this.isHandle = false
      this.dino.removeAllSkins()
      this.dinoEquipmentObj = JSON.parse(JSON.stringify(this.startDinoEquipmentObj))
      // 过滤 宠物初始化服装
      this.obj = {}
      for(let key in this.dinoEquipmentObj){
        if(this.dinoEquipmentObj[key].length>0){
          this.obj[key] = JSON.parse(this.dinoEquipmentObj[key][0].pcH5Resource)
        }
      }
      this.dino.replaceSkin(this.obj)
    },
    // 第一次进宠物房间 赠送魔法师头部道具
    getGiveMagicSeries(){
      axios.get("/rest/learninggw/api/pet/petPropStudent/giveMagicSeriesHeadPropOnlyOnce", {
        params: {
          studentId: cookies.get('studentId')
        }
      }).then(res => {
        if(res.data.code == 200 && res.data.data){
         	this.isShowDialogTip = true
         	let giveMagicSeries = res.data.data
          this.list.unshift(giveMagicSeries)
          this.giveMagicSeriesImgSrc = giveMagicSeries.imgUrl
          this.isShowMask = true
          this.isShowDialogTip = true
          this.isFirst = false
        }else{
        	if(res.data.code != 200){
            this.$showToast('赠送失败了<br>请检查网络~')
          }
        }
      }).catch(v=>{
        this.$showToast('赠送失败了<br>请检查网络~')
      })
    },
    closeDialog(){
    	this.isShowDialogTip = false
      this.isShowMask = false
    },
    // 获取上新装扮
    getNewShop(){
    	axios.get("/rest/learninggw/api/pet/petProp/onNew", {
    		params: {
    			studentId: cookies.get('studentId')
    		}
    	}).then(res => {
    		if(res.data.code == 200 && res.data.data && res.data.data.onNew){
    			this.onNew = true
    		}else{
    			this.onNew = false
        }
    	}).catch(v => {
    		this.$showToast('获取上新装扮失败<br>请检查网络~')
        this.onNew = false
    	})
    }
  }
}
</script>


<style lang="stylus" scoped>
.dino_bg
  position: relative
  width: 100%
  height: 100%
  min-height: 768px
  min-width: 1024px
  background: #6945AB center center no-repeat url("../../img/dino/bg.png")
  background-size: 1920px 1440px
  .mask
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    background: #000
    background-color: rgba(0, 0, 0, 0.6)
    z-index: 10
  .dino-con
    display: inline-block
    position: absolute
    left: 50%
    top: 50%
    margin-left: -512px
    margin-top: -384px
    width: 1024px
    height: 768px
    .title
      display: inline-block
      position: absolute
      left: 50%
      margin-left: -219px
      width: 458px
      height: 115px
      background: no-repeat url("../../img/dino/title-bg.png")
      background-size: 100% 100%
    .dino-mall
      position: absolute
      top: 0
      right: 125px
      width: 84px
      height:84px
      background: center center no-repeat url("../../img/dino/mall.png")
      background-size: 100% 100%
      transform-origin: 41px 0px
      animation: swing 5s infinite
      cursor: pointer
      .dino-mall-new
        position: absolute
        top: 25px
        right: 0
        width: 46px
        height: 20px
        background: center center no-repeat url("../../img/dino/new.png")
        background-size: 100% 100%
    .text-content
      display: inline-block
      position: relative
      float: right
      width: 490px
      height: 400px
      margin-right: 189px
      margin-top: 120px
      .equipment-list-con
        position: absolute
        left:0
        top: 0
        z-index: 2
        width: 490px
        height: 400px
        margin-top: 10px
        .equipment-more
          width: 22px
          height: 23px
          margin-left: 224px
          cursor: pointer
          background: center center no-repeat url("../../img/dino/more.png")
          background-size: 100%
      .equipment-type-con
        position: absolute
        left: -135px
        top: 0
        z-index: 1
        width: 135px
        height: 241px
        @media screen and (max-height: 750px)
          top: -20px
    .platform-index
      z-index: 0
    .platform
      position: absolute
      left: 100px
      bottom: 0
      width: 327px
      height: 424px
      background: no-repeat url("../../img/dino/platform.png")
      background-size: 100% 100%
      @media screen and (max-height: 750px)
        bottom: 40px
      .platform-value
        display: inline-block
        position: absolute
        left: 0
        top: 0
        width: 87px
        height: 373px
        padding-top: 50px
        z-index: 99
        .platform-value-round
          width: 70px
          height: 210px
          margin-left: 11px
          margin-top: 7px
          cursor: pointer
          .platform-value-round-bg
            width: 70px
            height: 70px
            color: #fff
            font-size: 11px
            line-height: 73px
            overflow: hidden
            text-align: center
            .platform-value-round-p
              line-height: 60px
          .platform-value-round-bg-all
            margin-top: -6px
            background: no-repeat url("../../img/dino/round.png")
            background-size: 100% 100%
            .platform-value-round-bg-all-p
              transform: scale(0.9)
          .platform-value-round-bg-no
            width: 55px
            height: 55px
            margin-left: 7px
            margin-bottom: 6px
            background: no-repeat url("../../img/dino/half.png")
            background-size: 100% 100%
          .platform-value-round-bg-canvas
            margin-top: -2px
            margin-left: 3px
      .platform-dino
        display: inline-block
        position: absolute
        left: 87px
        top: 0
        z-index: 1
        width: 239px
        height: 423px
        .dino-canvas
          position: absolute
          left: -140px
          bottom: 60px
          width: 500px
          height: 600px
        .platform-dino-name
          position: absolute
          left: 27px
          bottom: 22px
          width: 135px
          height: 40px
          line-height: 40px
          padding: 0 10px
          color: #ffffff
          font-size: 14px
          text-align: center
          text-overflow: ellipsis
          overflow: hidden
          white-space: nowrap
        .platform-dino-reload
          position: absolute
          left: 0
          bottom: 16px
          width: 95px
          height: 40px
          padding:15px 58px 0 58px
          background: no-repeat url("../../img/dino/reload.png")
          background-size: 100% 100%
          .platform-dino-reload-cancel
            float: left
            width: 25px
            height: 25px
            background: no-repeat url("../../img/dino/no.png")
            background-size: 100% 100%
            cursor: pointer
          .platform-dino-reload-confirm
            display: inline-block
            float: left
            width: 30px
            height: 30px
            margin-left: 40px
            background: no-repeat url("../../img/dino/yes.png")
            background-size: 100% 100%
            cursor: pointer
  .abnormal
    position: relative
    width: 100%
    height: 100%
    background: linear-gradient(to bottom, #433798 0%, #7f2891 100%)
    .abnormal-content
      display: inline-block
      position: absolute
      left: 50%
      top: 50%
      width: 550px
      height: 400px
      margin-left: -273px
      margin-top: -300px
      background: center center  no-repeat url("../../img/dino/off.png")
      background-size: 400px 300px
      color: #B396FF
      font-size: 26px
      .abnormal-content-p
        text-align: center
        margin-top: 330px
        line-height: 37px
@keyframes swing {
  5% {
    transform: rotate3d(0, 0, 1, 15deg)
  }

  10% {
    transform: rotate3d(0, 0, 1, -10deg)
  }
  15% {
    transform: rotate3d(0, 0, 1, 5deg)
  }
  20% {
    transform: rotate3d(0, 0, 1, -5deg)
  }
  25% {
    transform: rotate3d(0, 0, 1, 0deg)
  }
}
</style>

