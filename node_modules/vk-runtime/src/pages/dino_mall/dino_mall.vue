<template lang="jade">
    .dino-mall
      // 后退
      top-part(:isAbsoluteFix="true", :ifShow="false")
      // 弹出框透明背景
      .user-guide-mask(v-if="isShowUserGuideMask", @click="closeDialog")
        // 兑换须知
        exchangeNotice(:showDialog="showNoticeDialog")
      .dino-mall-con(v-show="isShowDinoContent")
        .dino-mall-small-con
          // 选择装备种类
          .equipment-selected
            equipmentType(:propParts="propParts",@changePart="changePart",:isLoading="isLoading",:dinoEquipmentObj="dinoEquipmentObj")
          .equipment-list-area
            // 装备筛选
            .equipment-top
              .equipment-top-box(@click="changeTradeType")
                .equipment-top-status(:class="tradeType=='EGGSHELL'?'equipment-top-status-checked':''")
                span.equipment-top-status-label 能量石兑换
              .equipment-top-box(@click="changeObtainStatus")
                .equipment-top-status(:class="obtainStatus=='NO'?'equipment-top-status-checked':''")
                span.equipment-top-status-label 未获得
              // 能量石数量
              .stone {{availableNumber}}
            // 装备列表
            equipment(:list="list",:isLoading="isLoading",:availableNumber="availableNumber",:dinoEquipmentObj="dinoEquipmentObj",@changeDinoEquipmentObj="changeDinoEquipmentObj",@buySuccess="buySuccess")
            // 获取更多装备按钮
            .equipment-more.animated.pulse.infinite(v-show="isShowMore",@click ="getPetProp")
          .dino-mall-bottom
            // return 按钮
            .dino-mall-bottom-return(@click="removeAllSkins",:class="isShowCancel ? 'dino-mall-bottom-return-bg':'dino-mall-bottom-return-disabled'")
            // 兑换须知按钮
            .dino-mall-bottom-notice(@click="openSecret",@closeDialog="closeDialog")
          .equipment_dino
            equipmentDino(v-if="petObj && petObj.data && petObj.data.data",:petObj="petObj",:dinoEquipmentObj="dinoEquipmentObj",@getDinoObj="getDinoObj")
          equipmentDialog(v-if="isShowNewShopDialog",:tipText="text",:title="title",:isShowTitle="true",:giveMagicSeriesImgSrc="newShopImg",@close="closeDialog")
      // 宠物未出生或者已经关闭状态，通过链接进入页面呈现
      .abnormal(v-show="!isShowDinoContent")
        .abnormal-content
          p.abnormal-content-p oops~ </br>  需要爸爸妈妈打开宠物开关，才能进入商店哦～

</template>
<script>
import axios from 'axios'
import cookies from 'cookies-js'
import untils from '../../utils/_untils.js'
import TopPart from '../common/top_part.vue'
import exchangeNotice from './components/exchange_notice.vue'
import equipmentType from './components/equipment_type.vue'
import equipment from './components/equipment.vue'
import equipmentDino from './components/equipment_dino.vue'
import equipmentDialog from './components/equipment_dialog.vue'

export default {
  data(){
    return {
      isShowUserGuideMask: false,// 是否显示弹出层透明背景
      showNoticeDialog: false,// 是否显示兑换须知
      pageTotal: 0,// 装备总页数
      isShowMore: false,// 是否显示更多
      propParts: '',// 空代表全部
      obtainStatus: "",// 获得状态
      tradeType: "",// 交易类型
      start: 0, // 道具列表起始页
      propSeries:"" ,// 道具系列
      list:[],// 道具列表
      petObj:{},// 宠物对象
      availableNumber: 0,//能量石数量
      obj:{},
      dinoEquipmentObj:{"HEAD_PARTS":{},"FACE_PARTS":{},"HAND_PARTS":{},"BODY_PARTS":{},"LEG_PARTS":{}},// dino 装备对象
      dino:null,// dino对象
      isLoading: false,
      isShowCancel: false,
      isShowDinoContent: true, // 是否显示dino内容（防止dino被关闭或未领养通过链接进入）
      newShopImg: "", // 上新装扮
      title:"装扮上新",
      text:"本周的新品装扮已经上架啦，</br> 快来看看吧～",
      isShowTitle: true,
      isShowNewShopDialog: false
    }
  },
  components:{
    TopPart,
    equipment,
    equipmentType,
    exchangeNotice,
    equipmentDino,
    equipmentDialog
  },
  methods:{
    // 关闭弹出框
    closeDialog(){
      this.isShowUserGuideMask = false
      this.showNoticeDialog = false
      this.isShowNewShopDialog = false
    },
    openSecret(){
      this.isShowUserGuideMask = true
      this.showNoticeDialog = true
    },
    // 更改获得状态
    changeObtainStatus(){
    	if(this.isLoading){
        this.$showToast('数据加载中，请注意操作间隔')
    		return
      }
    	this.list = []
      this.start = 0
      if(this.obtainStatus =="NO"){
      	this.obtainStatus = ""
      }else{
      	this.obtainStatus = "NO"
      }
      this.getPetProp()
    },
    // 交易类型更改
    changeTradeType(){
      if(this.isLoading){
        this.$showToast('数据加载中，请注意操作间隔')
        return
      }
      this.list = []
      this.start = 0
      if(this.tradeType =="EGGSHELL"){
      	this.tradeType = ""
      }else{
      	this.tradeType = "EGGSHELL"
      }
      this.getPetProp()
    },
    // 更改身体部位
    changePart(part=''){
      this.list = []
      this.start = 0
      this.propParts = part
      let partName = part ? part.toLowerCase():"all"
      sa.track('learning_click', {
        'click_id': `pc_learning_dino_mall_${partName}`
      })
      this.getPetProp()
    },
    // 获取道具列表
    getPetProp(){
    	if(this.start>0){
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_mall_go_more'
        })
      }
    	this.isLoading = true
    	this.start++
      axios.get("/rest/learninggw/api/pet/petProp/pageList", {
        params: {
          studentId: cookies.get('studentId'),
          tradeType: this.tradeType,
          obtainStatus: this.obtainStatus,
          propSeries: this.propSeries,
          propParts: this.propParts,
          start: this.start,
          limit: 20
        }
      }).then(res => {
        let resObj = res.data
        if(resObj.code == 200 && resObj.data && resObj.data.data){
          this.list = this.list.concat(resObj.data.data)
          this.pageTotal = resObj.data.totalPages
          if(this.start < this.pageTotal){
          	this.isShowMore = true
          }else{
          	this.isShowMore = false
          }
        }else{
        	if(resObj.code != 200){
            this.$showToast('获取道具失败<br>请检查网络~')
          }
        }
        this.isLoading =false
      }).catch(v=>{
        this.isLoading =false
        this.$showToast('获取道具失败<br>请检查网络~')
      })
    },
    // 获取宠物的信息
    getDinoInfo(){
      axios.get(`/rest/learninggw/api/pet/homepage/petResourceActionInfo`, {
        params: {
          studentId: cookies.get("studentId"),
          deviceType: "PC_H5"
        }
      }).then((res) => {
        if(res.data && res.data.code == 200 && res.data.data){
          this.petObj = res
          if((res.data.data.pet && res.data.data.pet.petSwitch == "OFF") ||(res.data.data.pet && res.data.data.pet.growUpStatus=="EGG_LOCK") ){
            this.isShowDinoContent = false
          }else{
            this.isShowDinoContent = true
          }
        }else{
        	if(res.data.code != 200){
            this.$showToast('获取dino信息失败<br>请检查网络~')
          }
        }
      })
    },
    // 获取能量石数量
    getStoneNumber(){
      axios.get("/rest/learninggw/api/pc/magic/eggshell/getByStudentId", {
        params: {
          studentId: cookies.get('studentId')
        }
      }).then(res => {
        if(res.data.code == 200){
          this.availableNumber = res.data.data.availableNumber
        }else{
          this.$showToast('获取能量石失败<br>请检查网络~')
        }
      }).catch(v => {
        this.$showToast('获取能量石失败<br>请检查网络~')
      })
    },
    // 更改dino 服装配置
    changeDinoEquipmentObj(item){
      if(this.dinoEquipmentObj[item.propParts] && this.dinoEquipmentObj[item.propParts].id == item.id){
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_mall_try_on'
        })
        this.dinoEquipmentObj[item.propParts] = {}
        if(this.obj[item.propParts]){
          delete this.obj[item.propParts]
        }
        // 是否显示"取消试穿"按钮
        if(JSON.stringify(this.obj)==='{}'){
          this.isShowCancel = false
        }
        this.dino.removeSkin([item.propParts])
      }else {
        sa.track('learning_click', {
          'click_id': 'pc_learning_dino_mall_try_off'
        })
        this.isShowCancel = true
        if(this.obj && this.obj[item.propParts]){
          this.dino.removeSkin([item.propParts])
        }
        this.dinoEquipmentObj[item.propParts] = item
        this.obj[item.propParts] = JSON.parse(item.pcH5Resource)
        this.dino.replaceSkin(this.obj)
      }
    },
    // 获取dino实例
    getDinoObj(obj){
      this.dino = obj
    },
    // 购买成功-减能量石
    buySuccess(obj){
      this.availableNumber = this.availableNumber - obj.tradePrice
    },
    // 脱下所有服装
    removeAllSkins(){
      sa.track('learning_click', {
        'click_id': 'pc_learning_dino_mall_cancel_try_on'
      })
      this.dino.removeAllSkins()
      this.obj = {}
      this.dinoEquipmentObj = {"HEAD_PARTS":{},"FACE_PARTS":{},"HAND_PARTS":{},"BODY_PARTS":{},"LEG_PARTS":{}}
      this.isShowCancel = false
    },
    // 获取上新装扮
    getNewShop(){
      axios.get("/rest/learninggw/api/pet/petProp/onNew", {
        params: {
        	studentId: cookies.get('studentId'),
          type: "shop"
        }
      }).then(res => {
        if(res.data.code == 200 && res.data.data && res.data.data.url){
          this.newShopImg = res.data.data.url
          this.isShowUserGuideMask = true
          this.isShowNewShopDialog = true
        }
      }).catch(v => {
        this.$showToast('获取上新装扮失败<br>请检查网络~')
        this.isShowNewShopDialog = false
        this.isShowUserGuideMask = false
      })
    }
  },
  created(){
  	this.getPetProp()
    this.getDinoInfo()
    this.getStoneNumber()
    this.getNewShop()
  }
}
</script>
<style lang="stylus" scoped>
    .dino-mall
      position: relative
      width: 100%
      height: 100%
      min-height: 768px
      background: #6945AB center center no-repeat url("../../img/dino_mall/dino_mall_bg.png")
      background-size: 1920px 1440px
      .user-guide-mask
        width: 100%
        height: 100%
        position: fixed
        top: 0
        left: 0
        right: 0
        bottom: 0
        background: #000
        background-color: rgba(0, 0, 0, 0.6)
        z-index: 10
      .dino-mall-con
        position: absolute
        left: 50%
        top: 50%
        width: 1024px
        height: 768px
        margin-left: -512px
        margin-top: -384px
        .dino-mall-con-title
          position: absolute
          left: 50%
          margin-left: -147px
          margin-top: 35px
          width: 294px
          height: 80px
          line-height: 80px
          text-align: center
          font-size: 31px
          color: rgba(255,255,255,1)
        .dino-mall-small-con
          position: absolute
          left: 50%
          top: 150px
          width: 816px
          height: 615px
          margin-left: -408px
          .equipment_dino
            position: absolute
            bottom: 25px
            left: 0
            width: 250px
            height: 310px
            @media screen and (max-height: 750px)
              bottom: 85px
          .equipment-list-area
            float: left
            display: inline-block
            width: 470px
            height: 470px
            .equipment-top
              width: 452px
              height: 30px
              padding-left: 18px
              .equipment-top-box
                float: left
                width: auto
                height: 30px
                .equipment-top-status
                  display: inline-block
                  float: left
                  box-sizing: border-box
                  width: 14px
                  height: 14px
                  border-radius: 50%
                  border: 2px solid rgba(255,255,255,0.8)
                  margin-right: 5px
                  align-items: center
                  justify-content: center
                .equipment-top-status-label
                  display: inline-block
                  float: left
                  margin-right: 35px
                  font-size: 16px
                  color: #ffffff
                .equipment-top-status-checked
                  background: center center no-repeat url("../../img/dino_mall/checked.png")
                  background-size: 100%
              .stone
                display: inline-block
                float: right
                width: auto
                height: 25px
                line-height: 25px
                padding-left: 33px
                margin-top: -3px
                background: left top no-repeat url("../../img/dino_mall/store_big.png")
                background-size: 25px
                color: #ffffff
            .equipment-more
              width: 22px
              height: 23px
              margin-left: 224px
              cursor: pointer
              background: center center no-repeat url("../../img/dino_mall/more.png")
              background-size: 100%
          .equipment-selected
            float: left
            display: inline-block
            width: 130px
            height:241px
            margin-left: 100px
            @media screen and (max-height: 750px)
              margin-top: -20px
          .dino-mall-bottom
            position: relative
            width: 816px
            height: 70px
            padding-top: 60px
            clear: both
            @media screen and (max-height: 750px)
              padding-top: 0
            .dino-mall-bottom-return
              position: absolute
              left: 50%
              width: 202px
              height: 72px
              margin-left: -101px
            .dino-mall-bottom-return-bg
              background: center center no-repeat url("../../img/dino_mall/return.png")
              background-size: 100%
              cursor: pointer
            .dino-mall-bottom-return-disabled
              background: center center no-repeat url("../../img/dino_mall/return_dis.png")
              background-size: 100%
              cursor: not-allowed
            .dino-mall-bottom-notice
              position: absolute
              right: 30px
              top: 35px
              height: 52px
              width: 109px
              background: center center no-repeat url("../../img/dino_mall/exchangeNotice.png")
              background-size: 100%
              cursor: pointer
              @media screen and (max-height: 750px)
                top: 5px
      .abnormal
        position: relative
        width: 100%
        height: 100%
        background: linear-gradient(to bottom, #433798 0%, #7f2891 100%)
        .abnormal-content
          display: inline-block
          position: absolute
          left: 50%
          top: 50%
          width: 550px
          height: 400px
          margin-left: -273px
          margin-top: -300px
          background: center center  no-repeat url("../../img/dino/off.png")
          background-size: 400px 300px
          color: #B396FF
          font-size: 26px
          .abnormal-content-p
            text-align: center
            margin-top: 330px
            line-height: 37px

</style>
