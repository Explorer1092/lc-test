<template lang="jade">
    .equipment-list
      // 弹出框透明背景
      .mask(v-show="isShowMask", @click="closeDialog")
      .equipment-all(v-if="list.length>0")
        .equipment(v-for="item in list")
          .equipment-con(@click="selectEquipment(item)")
            .equivalent-con-selected(v-show="dinoEquipmentObj && dinoEquipmentObj[item.propParts] &&  dinoEquipmentObj[item.propParts].id == item.id")
            .equivalent-con-have(v-show="item.obtainStatus=='YES'")
            img.equipment-con-img(:src="item.imgUrl")
            img.equivalent-con-store(src="../../../img/dino_mall/store.png",v-show="item.tradeType=='EGGSHELL'")
            p.equivalent-con-text(v-show="item.tradeType=='EGGSHELL'") {{item.tradePrice}}
            p.equivalent-con-text.equivalent-con-text-p(v-show="item.tradeType=='ONLY_COMPLETED_ACTIVITY'") 活动限定
          .equipment-title(:title="item.name") {{item.name}}
          .equipment-btn(@click="info(item)") 兑换
      .none(v-if="list.length<=0 && !isLoading")
      equipmentDialog(v-if="isShowDialogTip",:tipText="text",:title="title",:isShowTitle="true",:imgType="imgType",@close="closeDialog")
      equipmentInfoDialog(v-if="isShowDialogBuy",:title="titleBuy",:isShowTitle="true",:currentObj="currentObj",@confirm="confirm",@cancel="cancel",@close="closeDialog",:isLess="isLess")

</template>
<script>
import axios from 'axios'
import cookies from 'cookies-js'
import equipmentDialog from './equipment_dialog.vue'
import equipmentInfoDialog from './equipment_info_dialog.vue'
export default {
  data(){
    return {
      text: "购买成功！</br> 可以回到衣橱试穿了！",
      title:"Notice",// 弹出框标题
      isShowMask: false,// 是否显示透明背景
      isShowDialogTip: false,// 是否显示类型弹框
      isShowDialogBuy: false,// 是否显示购买型弹框
      titleBuy:"装扮详情",
      currentObj: {},
      imgType:'happy',// 弹框表情类型
      isBuying: false,// 是否正在购买
      isShopOrderMessage:{
        "499":"商品已下架",
        "498":"商品库存不足",
        "497":"商品库存不足或已下架，<br>再看看其他商品",
        "496":"请选择商品",
        "495":"非法订单",
        "494":"蛋壳数目不足，无法以兑换商品",
        "491":"学生蛋壳扣减失败",
        "490":"蛋壳扣减流水插入失败",
        "489":"订单商品批量插入失败",
        "488":"订单创建失败",
        "487":"商品库存扣减失败",
        "486":"一定时间内兑换商品超过限制数量",
        "485":"您的下单次数过于频繁，请稍后再试",
        "484":"学生或家长非法",
        "483":"肥料总数超过上限，无法兑换",
        "482":"收货地址不完整，请补全!",
        "481":"拥有的该商品数量超过上限，无法兑换!",
        "480":"该道具在服装道具市场已下架"
      },
      isLess: false// 是否能量石不足
    }
  },
  components:{
    equipmentDialog,
    equipmentInfoDialog
  },
  methods: {
    cancel() {
      this.isShowMask = false
      this.isShowDialogBuy = false
      this.isLess = false
    },
    confirm() {
      this.isShowMask = false
      this.isShowDialogBuy = false
      this.isLess = false
      this.buyStone()
    },
    closeDialog() {
      this.isShowMask = false
      this.isShowDialogTip = false
      this.isShowDialogBuy = false
      this.isLess = false
    },
    info(item) {
      sa.track('learning_click', {
        'click_id': 'pc_learning_dino_mall_equipment_info'
      })
      this.isShowMask = true
      this.isShowDialogBuy = true
      this.currentObj = item
      // 检测能量石是否充足
      if (this.availableNumber < this.currentObj.tradePrice) {
        this.isLess = true
      }
    },
    // 选中装扮
    selectEquipment(item) {
      this.$emit('changeDinoEquipmentObj', item)
    },
    // 购买
    buyStone() {
      // 接口进行中不可再次发请求
      if (this.isBuying) {
        return
      }
      sa.track('learning_click', {
        'click_id': 'pc_learning_dino_mall_buy'
      })
      // 配置参数
      let parentId = cookies.get('parentId')
      let isPad = cookies.get("isFromApp")
      if (isPad) {
        parentId = cookies.get('mbparentid')
      }
      this.isBuying = true
      let msg = {
        studentId: cookies.get("studentId"),
        parentId: parentId,
        eshopGoodsList: [
          {
            eshopGoodsId: this.currentObj.eshopGoodsId,
            eshopGoodsCount: 1
          }
        ]
      }
      axios.post("/rest/learninggw/api/pc/eshop/order/createEshopOrder", JSON.stringify(msg), {headers: {"Content-Type": "application/json"}}).then(res => {
        if (res.data.code == 200) {
          this.text = "购买成功！</br> 可以回到衣橱试穿了！"
          this.currentObj.obtainStatus = "YES"
          this.isShowMask = true
          this.isShowDialogTip = true
          this.imgType = 'happy'
          this.$emit('buySuccess', this.currentObj)
        } else {
          let message = this.isShopOrderMessage[res.data.code]
          if (message) {
            this.$showToast(message)
          } else {
            this.$showToast("购买失败:" + res.data.code)
          }
        }
        this.isBuying = false
      }).catch((err) => {
        // 监控报错打点
        sa.track('learning_click', {
          'error_url': "/rest/learninggw/api/pc/eshop/order/createEshopOrder" + msg,
          'error_msg': JSON.stringify(err.response.data)
        })
        this.$showToast("购买失败了")
        this.isShowMask = false
        this.isBuying = false
      })
    }
  },
  props: {
    list: {
      type: Array,
      default: []
    },
    availableNumber:{
      type:Number,
      default: 0
    },
    dinoEquipmentObj:{
      type:Object,
      default: function(){
        return {"HEAD_PARTS":{},"FACE_PARTS":{},"HAND_PARTS":{},"BODY_PARTS":{},"LEG_PARTS":{}}
      }
    },
    isLoading:{
      type:Boolean,
      default: false
    }
  }
}
</script>

<style lang="stylus" scoped>
.equipment-list
  width: 490px
  height: 400px
  overflow-y: auto
  &::-webkit-scrollbar
    width: 8px
    height: 8px
    -webkit-border-radius: 4px
    -moz-border-radius: 4px
    border-radius: 4px
  &::-webkit-scrollbar-track
    background: rgba(0, 0, 0, 0)
  &::-webkit-scrollbar-thumb
    background: rgba(0, 0, 0, 0.1)
    border-radius: 4px
  .none
    width: 360px
    height: 68px
    margin-top: 150px
    margin-left: 70px
    background: center center no-repeat url("../../../img/dino_mall/none.png")
    background-size: 100% 100%
  .mask
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    background: #000
    background-color: rgba(0, 0, 0, 0.6)
    z-index: 10
  .equipment
    float: left
    display: inline-block
    width: 100px
    height: 205px
    margin-left: 17px
    text-align: center
    color: rgba(255,255,255,1)
    font-size: 14px
    .equipment-con
      position: relative
      width: 70px
      height:105px
      background: center center no-repeat url("../../../img/dino_mall/equipment_bg.png")
      background-size: 100% 100%
      padding: 15px 15px 0 15px
      cursor: pointer
      .equipment-con-img
        width: 70px
        height: 70px
        margin-bottom: 4px
      .equivalent-con-text
        float: left
        color: #39F6F3
        line-height: 25px
        min-width: 40px
        text-align: center
      .equivalent-con-text-p
        width: 70px
      .equivalent-con-store
        float: left
        width:22px
        height: 22px
      .equivalent-con-selected
        position: absolute
        top: 50%
        left: 50%
        width: 111px
        height: 130px
        margin-left: -55px
        margin-top: -65px
        background: center center no-repeat url("../../../img/dino_mall/sun_bg.png")
        background-size: 100% 100%
      .equivalent-con-have
        position: absolute
        right: 0
        top: 0
        width: 52px
        height: 53px
        background: center center no-repeat url("../../../img/dino_mall/haved.png")
        background-size: 100% 100%

    .equipment-title
      width:100px
      height: 20px
      line-height: 20px
      margin-top: 11px
      overflow: hidden
      text-overflow: ellipsis
      white-space: nowrap
    .equipment-btn
      width: 60px
      height: 30px
      line-height: 30px
      margin-top: 7px
      margin-left: 20px
      background: center center no-repeat url("../../../img/dino_mall/btn_bg1.png")
      background-size: 100% 100%
      cursor: pointer
</style>

