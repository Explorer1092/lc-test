<template lang="jade">
  .egret-player-box
</template>
<script>
	let getDinoSdk = (cb) => {
	 import('egret-dino').then(() => {
	   !cb || cb()
	 })
	}
	export default {
	  data: function () {
	    return {
	      dino: null
	    }
	  },
	  props: {
	    petObj:{
	      type : Object,
	      default: function(){
	        return {}
	      }
	    },
	    dinoEquipmentObj:{
	      type:Object,
      default: function () {
        return {"HEAD_PARTS":{},"FACE_PARTS":{},"HAND_PARTS":{},"BODY_PARTS":{},"LEG_PARTS":{}}
	      }
    }
	  },
	  mounted () {
	    this.getDinoData()
	  },
	  beforeDestroy() {
	    if (this.dino) {
	      this.dino.hideDino()
	    }
	  },
	  methods: {
	    getDinoData() {
	      if (window.DinoAnim) {
	        this.init()
	      } else {
	        getDinoSdk(() => {
	          // 资源引入结束，此时可以实例化dinoAnim
	          this.init()
	        })
	      }
	    },
	    init() {
	      let petResourceList = []
	      let pcPetResource = []
	      let pushMsgAnim = ""
	      let enterAnim = ""
	      let normalAnim = ""
	      let loopAnim = ""
	      let clickHeadAnim = ""
	      let clickBodyAnim = ""
	      let toLeftAnim = ""
	      let toRightAnim = ""
	      let url = ""
	      let spliceUrl = ""
	      let petObj = this.petObj.data.data
	      petResourceList = petObj.petResourceList
	      for(let i = 0; i < petResourceList.length; i++) {
	        if(petResourceList[i].deviceType == "PC_H5") { //判断设备
	          let data = {
	            "name": petResourceList[i].name,
	            "type": petResourceList[i].type === "dbbin" ? "bin" : petResourceList[i].type,
	            "url": petResourceList[i].url
	          }
	          pcPetResource.push(data)
	          url = petResourceList[i].url
	        }
	        spliceUrl = url.match(/^(([a-z]+:)?(\/\/)?[^\/]+\/).*$/)[1] //截取字符串中的域名
	      }
	      // pushMsgAnim = petObj.petActionLibraryMap.pushMsgAnim.actionCommand
	      enterAnim = petObj.petActionLibraryMap.enterAnim.actionCommand
	      normalAnim = petObj.petActionLibraryMap.normalAnim.actionCommand
	      loopAnim = petObj.petActionLibraryMap.loopAnim.actionCommand
	      clickHeadAnim = petObj.petActionLibraryMap.clickHeadAnim.actionCommand
	      clickBodyAnim = petObj.petActionLibraryMap.clickBodyAnim.actionCommand
	      toLeftAnim = petObj.petActionLibraryMap.toLeftAnim.actionCommand
	      toRightAnim = petObj.petActionLibraryMap.toRightAnim.actionCommand
	      this.dino = new DinoAnim({
	        width: 250,
	        height:320,
	        scale: 0.41,
	        el: this.$el,
	        turnRound: true,
	        centrePoint: [140,215],
	        initAnimNames: {
	          enterAnim: enterAnim,//进场动作名称（选填）
	          normalAnim: normalAnim,//静止状态动作
	          loopAnim: loopAnim,//无消息情况下的循环动作 10s动作一次 （选填）
	          clickHeadAnim: clickHeadAnim,//点击头部动作名称
	          clickBodyAnim: clickBodyAnim,//点击身体动作名称
	          toLeftAnim: toLeftAnim,//向左划动动作名称
	          toRightAnim: toRightAnim//向右滑动作名称
	        },
	        resources: pcPetResource,
	        resRootPath: spliceUrl,
	        isAgreeClick: false,
	        complete: () => {
	          this.dino.showDino()
	          this.dino.playAnimationOnce(normalAnim, () => {
	          })
          this.$emit('getDinoObj',this.dino)
	        },
	        tapHandle: (msg) => {
	          switch (msg) {
	          case 'clickHead':
	            sa.track('learning_click', {
	              'click_id': 'pc_learning_dino_home_click_head'
	            })
	            break
	          case 'clickBody':
	            sa.track('learning_click', {
	              'click_id': 'pc_learning_dino_home_click_body'
	            })
	            break
	          }
	        },
	        errorHandle:(err) => {
	          console.log(err)
	        }
	      })
	    }
	  }
	}
</script>


<style lang="stylus" scoped>
  #egret-player
    -webkit-tap-highlight-color: transparent
    -webkit-touch-callout: none
    -webkit-user-select: none
    user-select:none
    cursor: pointer
  .egret-player-box
    width: 250px
    height: 320px
</style>
