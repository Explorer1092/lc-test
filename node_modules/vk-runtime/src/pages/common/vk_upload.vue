<template lang="jade">
  .upload-dialog-wrapper(:class="'upload_dialog'")
    .upload-dialog-mask
    //- .top
    .upload-dialog-bg.animated.bounceInDown
      .top-cancel-btn(v-if="isShowCloseBtn", @click="close")
        img(src="../../img/readers/cancelmodel.png")
      .title-text
        | 上传图片
      .content-text
        .img-view-source
          .doNotHaveImg(v-if="isShowDoNotHaveImg")
            p 宝贝还没有完成本单元Project<br>记得在Lesson12上课前上传哦！
          img.userHaveImg(v-if="isShowUserProjectImg", :src="projectImgSrc")
          .img-uploading-wrap(v-if="isShowImgUploading")
            .uploading-name(v-show="isShowUploadingName") {{currentFileName}}
            img.uploading-img(:src="uploadingImgSrc", :class="{bigger : isUploadingImgBigger}")
            .progress-wrap(v-show="isShowProgress")
              .progress(:style="{width: uploadPercent + '%'}", :class="{red: isUploadFail}")
            transition(enterActiveClass="animated fadeIn")
              .upload-text(v-show="isShowUploadText", :class="{'red-font': isUploadFail}") {{uploadText}}
            transition(enterActiveClass="animated slideInLeft")
              img.progress-end-icon(v-show="isShowImgUploadOkIcon", src="../../img/icon-yeah@2x.png")
            transition(enterActiveClass="animated slideInLeft")
              img.upload-fail-icon(v-show="isUploadFail", src="../../img/icon-oops@2x.png")
          .img-cuter-wrap(v-if="isShowImgCut")
            cropper(ref="cropper2",
            :img="cropperImg.img",
            :outputSize="cropperImg.size",
            :outputType="cropperImg.outputType",
            :info="cropperImg.info",
            :canScale="cropperImg.canScale",
            :autoCrop="cropperImg.autoCrop",
            :autoCropWidth="cropperImg.width",
            :autoCropHeight="cropperImg.height",
            :fixed="cropperImg.fixed",
            :fixedNumber="cropperImg.fixedNumber")
        .tip(v-if="isShowTip", v-html="tipText")
        .content-btn
          btn.btn(v-if="isShowTrackCancelBtn", type="lg-enable", text="取消", :clickFun="closeWithTrackCancel")
          btn.btn(v-if="isShowCancelBtn", type="lg-enable", text="取消", :clickFun="close")
          btn.btn(v-if="isReUploadImg", type="lg-enable", text="重新上传图片", :clickFun="rePickImg")
          btn.btn(v-if="isUploadImgBtnShow", type="lg-enable", text="上传图片", :clickFun="pickImg")
          btn.btn(v-if="isConfirmBtnShow", type="lg-enable", text="确定", :clickFun="uploadImg")
          btn.btn(v-if="isConfirmCancelBtnShow", type="lg-enable", text="确定", :clickFun="closeWithTrackConfirm")
          input(ref="fileLoader", type="file", name="file", accept=".jpg,.jpeg,.png", @change="uploadImgChange", v-show="false")
</template>
<script>
  import btn from "./vk_button.vue"
  import cropper from "vue-cropper"
  import axios from 'axios'
  import formurlencoded from 'form-urlencoded'
  import cookies from 'cookies-js'

  export default {
    data: function () {
      return {
        userProjectImg: '',
        isReUploadImg: false,
        isUploadImgBtnShow: false,
        isShowTrackCancelBtn: false,
        isConfirmBtnShow: false,
        cropperImg: {
          img: '',
          info: true,
          size: 1,
          outputType: 'jpeg',
          canScale: true,
          autoCrop: true,
          // 只有自动截图开启 宽度高度才生效
          autoCropWidth: 300,
          autoCropHeight: 250,
          // 开启宽度和高度比例
          fixed: true,
          fixedNumber: [4, 3]
        },
        qiniuConfigInfo: {
          token: '',
          file: '',
          key:''
        },
        qiniuUploadUrl: '',
        uploadedImageURL: '',
        formData: '',
        projectImgSrc: '',
        isShowDoNotHaveImg: false,
        isShowUserProjectImg: false,
        isShowImgCut: false,
        isShowImgUploading: false,
        currentFileName: '',
        uploadPercent: 0,
        isShowImgUploadOkIcon: false,
        tipText: '请宝贝选择清晰的图片上传，PNG或JPG格式，大小不超过3M。',
        uploadText: '',
        isShowTip: false,
        isUploadingImgBigger: false,
        timeouts: [],
        isShowUploadingName: false,
        isShowProgress: true,
        isShowUploadText: false,
        uploadingImgSrc: '',
        isConfirmCancelBtnShow: false,
        isUploadFail: false,
        isShowCancelBtn: false,
        projectUrl: '',
        urlHeader: '',
        isShowCloseBtn: false
      }
    },
    props: {
      unitId: {
        type: String,
        required: true
      },
      canUploadImg: {
        type: Boolean,
        required: true
      }
    },
    components: {
      btn, cropper
    },
    beforeDestroy: function () {
      this.beforeLeave()
    },
    computed: {},

    mounted () {
      this.getQiniuConfigInfo() //获取配置信息
      this.checkCurrentImg()
    },
    methods: {

      rePickImg() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_course_project_upload_reupload'})
        this.pickImg()
      },
      checkCurrentImg() {
        axios.get('/rest/learninggw/api/pc/path/projectDemo/getProjectDemoImage', {
          params: {
            studentId: cookies.get('studentId'),
            unitId: this.unitId,
            curriculumType: 3,
            userType: 'STUDENT'
          }
        })
          .then((res) => {
            if(res.data.code == 200) {
              if(res.data.data.success) {
                if(res.data.data.data.projectSrcUrl) {
                  this.projectImgSrc = res.data.data.data.projectSrcUrl
                  if(this.canUploadImg) {
                    this.setReUploadView()
                  } else {
                    this.setExpireWithImg()
                  }
                } else {
                  if(this.canUploadImg) {
                    this.setReuploadWithBadImgView()
                  } else {
                    this.setExpireWithoutImgView()
                  }
                }
              } else {
                if(this.canUploadImg) {
                  this.setUploadView()
                } else {
                  this.setExpireWithoutImgView()
                }
              }
            } else {
              alert('获取图片失败')
            }
          })
          .catch((err) => {

          })
      },
      setReuploadWithBadImgView() {
        //图片违规重新上传
        this.$showToast('图片不合规<br>请重新上传~')
        this.isShowDoNotHaveImg = true
        this.isReUploadImg = true
        this.isShowTip = true
        this.isShowCancelBtn = true
        this.isShowTrackCancelBtn = false
      },
      setReUploadView() {
        this.isShowUserProjectImg = true
        this.isReUploadImg = true
        this.isShowTip = true
        this.isShowCancelBtn = true
        this.isShowTrackCancelBtn = false
      },
      setUploadView() {
        this.isShowCancelBtn = true
        this.isShowTrackCancelBtn = false
        this.isShowTip = true
        this.isUploadImgBtnShow = true
        this.isShowDoNotHaveImg = true
      },
      setExpireWithImg() {
        this.tipText = '上传Project时间已结束啦~<br>宝贝可以直接在教室中与老师进行互动。'
        this.isShowCloseBtn = true
        this.isShowTip = true
        this.isShowUserProjectImg = true
      },
      setExpireWithoutImgView() {
        this.tipText = '上传Project时间已结束啦~<br>宝贝可以直接在教室中与老师进行互动。'
        this.isShowCloseBtn = true
        this.isShowTip = true
        this.isShowDoNotHaveImg = true
      },
      uploadImgChange(e) {
        let file = this.$refs.fileLoader.files[0]
        if(!file) return
        if(!/^image\/png|jpg|jpeg/.test(file.type)) {
          this.$refs.fileLoader.value = ''
          this.$showToast('宝贝,请选择:<br>PNG或JPG格式的图片~')
          return
        }
        if(file.size > 3145728) {
          this.$refs.fileLoader.value = ''
          this.$showToast('宝贝,请选择:<br>3MB以下的图片哦～')
          return
        }
        this.isShowImgUploading = false
        this.isReUploadImg = false
        this.isShowUserProjectImg = false
        this.uploadPercent = 0
        this.isShowImgUploadOkIcon = false
        this.isUploadFail = false
        this.currentFileName = file.name
        if(this.uploadedImageURL) {
          window.URL.revokeObjectURL(this.uploadedImageURL) //释放已存在的 URL 对象
        }
        this.uploadedImageURL = window.URL.createObjectURL(file)
        this.cropperImg.img = this.uploadedImageURL
        this.isUploadImgBtnShow = false
        this.isShowTip = false
        this.isShowDoNotHaveImg = false
        this.isConfirmBtnShow = true
        this.isShowImgCut = true
      },
      uploadImg() {
        this.isShowCancelBtn = false
        this.isShowTrackCancelBtn = true
        this.isConfirmBtnShow = false
        this.uploadText = '正在上传...'
        this.isShowUploadText = true
        
        let config = {
          headers: {'Content-Type': 'multipart/form-data, boundary=------vipkidxAu002IsFuWd'},
          onUploadProgress: (progressEvt) => {
            let percent = (progressEvt.loaded / progressEvt.total) * 100.00
            if(percent > 95) {
              percent = 95
            }
            this.uploadPercent = percent
          }
        }
        this.$refs.cropper2.getCropData((data) => {
          this.uploadingImgSrc = data
          this.isShowUserProjectImg = false
          this.isShowImgCut = false
          this.isShowImgUploading = true
        })
        this.$refs.cropper2.getCropBlob((data) => {
          this.formData.append('file', data)
          this.formData.append(this.$refs.fileLoader.files[0].name, this.$refs.fileLoader.files[0])
          this.$nextTick(() => {
            axios.post(this.qiniuUploadUrl, this.formData, config).then((res) => {
              this.bindImage()
            })
              .catch((err) => {
                this.failUploading()
              })
          })          
        })
      },
      bindImage() {
        axios.get('/rest/learninggw/api/pc/path/projectDemo/projectDemoBindImage', {
          params: {
            studentId: cookies.get('studentId'),
            unitId: this.unitId,
            curriculumType: 3,
            projectUrl: this.projectUrl
          }
        })
          .then((res) => {
            if(res.data.data) {
              sa.track('learning_click', {'click_id': 'pc_learning_major_course_project_upload_success'})
              this.uploadText = '上传成功'
              this.uploadPercent = 100
              this.isShowImgUploadOkIcon = true
              this.timeouts.push(setTimeout(() => {
                this.isConfirmCancelBtnShow = true
                this.isShowUploadingName = false
                this.isShowProgress = false
                this.isShowTrackCancelBtn = false
                this.isShowCancelBtn = true
                this.isShowImgUploadOkIcon = false
                this.isUploadingImgBigger = true
              }, 1500))
            } else {
              this.failUploading()
            }
          })
          .catch((err) => {
            this.failUploading()
          })
      },
      failUploading() {
        this.$refs.fileLoader.value = ''
        this.isShowUploadText = false
        this.uploadText = '网络链接超时'
        this.isShowCancelBtn = true
        this.isShowTrackCancelBtn = false
        this.isShowUploadText = true
        this.isUploadFail = true
        this.isReUploadImg = true
      },
      getQiniuConfigInfo() {
        axios.get('/rest/learninggw/api/pc/path/projectDemo/getConfigByServerType', {
          params: {
            fileType: 'jpg'
          }
        })
          .then((res) => {
            this.formData = new FormData()
            this.formData.append('token', res.data.data.auth.token)
            this.formData.append('key', res.data.data.key)
            this.qiniuUploadUrl = res.data.data.uploadPath
            this.projectUrl = res.data.data.url + '/' +res.data.data.key
          })
      },
      close() {
        this.$emit('closeUploadDialogEvent')
      },
      closeWithTrackCancel() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_course_project_upload_cancel'})
        this.close()
      },
      closeWithTrackConfirm() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_course_project_upload_ok'})
        this.close()
      },
      pickImg() {
        this.$refs.fileLoader.click()
      },
      beforeLeave() {
        for (var i = 0; i < this.timeouts.length; i++) {
          clearTimeout(this.timeouts[i])
        }
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .top
    height: 50%
    margin-bottom: -370px
  .upload-dialog-wrapper
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    z-index: 120
    .upload-dialog-mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background: #000
      opacity: 0.8
    .upload-dialog-bg
      width: 810px
      min-height: 600px
      background: #8f82bc
      border-radius: 30px
      position: absolute
      left: 50%
      top: 50%
      padding: 15px
      margin: -300px 0 0 -400px
      .top-cancel-btn
        position: absolute
        right: -10px
        top: -10px
        cursor: pointer
        & > img
          width: 40px
          height: 40px
      .title-text
        position: relative
        box-sizing: border-box
        width: 150px
        height: 55px
        color: #ffffff
        font-size: 24px
        margin: 0 auto
        overflow: hidden
        text-align: center
        font-weight: bold
    .content-text
      width: 791px
      height: 525px
      padding: 37px 37px 37px 37px
      line-height: 1.4
      background-color: #FFFFFF
      border: solid 5px rgba(0, 0, 0, 0.05)
      margin: 0 auto
      color: #666
      overflow: hidden
      box-sizing: border-box
      position: relative
      border-radius: 20px
      .img-view
        width: 400px
        height: 300px
        border-radius: 20px
        margin: auto
      .img-view-source
        width: 700px
        min-height: 305px
        border-radius: 20px
        margin: auto
        .img-uploading-wrap
          position: relative
          width: 700px
          height: 380px
          padding-top: 15px
          box-sizing: border-box
          .upload-text
            font-size: 22px
            text-align: center
            color: #555
            margin-top: 22px
            font-weight: normal
            &.red-font
              color: #ff6600
          .uploading-name
            font-size: 22px
            color: #555555
            font-weight: normal
            margin: 0 auto
            width: 100%
            height: 60px
          img.uploading-img
            width: 200px
            height: 150px
            border-radius: 20px
            margin: 20px auto 0 auto
            display: block
            &.bigger
              width: 400px
              height: 300px
          .progress-wrap
            margin: 0 auto
            width: 260px
            height: 20px
            border-radius: 100px
            background-color: #eeeeee
            overflow: hidden
            margin: 30px auto 0 auto
            .progress
              height: 100%
              border-radius: 100px
              background-color: #a18ee3
              transition: all 0.2s
              &.red
                background-color: #ff6600
          img.progress-end-icon
            position: absolute
            width: 32px
            height: 32px
            bottom: 134px
            right: 165px
          img.upload-fail-icon
            position: absolute
            width: 40px
            height: 40px
            bottom: 132px
            right: 165px
        .img-cuter-wrap
          width: 700px
          height: 380px
          border-radius: 20px
          margin: -10px auto auto auto
        img.userHaveImg
          width: 400px
          height: 300px
          border-radius: 20px
          margin: 0 auto
          display: block
        .doNotHaveImg
          background-image: url('../../img/pic-weishangchuan@2x.png')
          width: 400px
          height: 300px
          background-size: 100% 100%
          background-repeat: no-repeat
          margin: 0 auto
          text-align: center
          p
            font-size: 24px
            padding-top: 34px
            font-weight: normal
      .tip
        font-size: 22px
        text-align: center
        color: #555555
        margin-top: 30px
        font-weight: normal
      .content-btn
        text-align: center
        width: 460px
        margin: 0 auto 0 auto
        position: absolute
        bottom: 17px
        left: 0
        right: 0
        .btn
          margin: 0 25px
          display: inline-block
          vertical-align: middle
</style>

