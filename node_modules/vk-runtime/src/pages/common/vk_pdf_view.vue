<template lang="jade">
  div.pdf-wrap
    .pdf-con(v-vkLoading="isLoading")
      .pd-view(ref="pdfView",v-show="isSupport")
    .loading-text(v-if="isLoading")
      | 复习资料较多，宝贝耐心等待一下...
    .no-support(v-if="!isSupport")
      img(src="../../img/common/net-error.png")
      .ns-text
        | 对不起，宝贝的浏览器不支持PDF播放，建议使用最新版的谷歌浏览器。
</template>
<script>
  import pdfjsLib from "pdfjs-dist"
  import Vue from "vue"
  import {Base64} from 'js-base64'
  import pdfWorker from "pdfjs-dist/build/pdf.worker.min"
  import loading from "../common/plugins/Loading"
  Vue.use(loading)
  export default {
    data: function () {
      return {
        canvas: null,
        isSupport: true,
        pdfDoc: null,
        pageNum: 1,
        pageRendering: false,
        pageNumPending: null,
        scale: 0.8,
        isLoading: true
      }
    },
    props: {
      pdfUrl: {
        default: "",
        type: String
      }
    },
    mounted () {
      try {
        this.isLoading = true
        this.isSupport = true
        let pdfPath = Base64.decode(this.pdfUrl)
        pdfjsLib.GlobalWorkerOptions.workerSrc = pdfWorker
        var loadingTask = pdfjsLib.getDocument(pdfPath)
        loadingTask.promise.then((pdf) => {
          this.getPage(pdf, 1).then(() => {
            this.isLoading = false
            for (var pageNum = 2; pageNum <= pdf.numPages; ++pageNum) {
              this.getPage(pdf, pageNum)
            }
          })
        }, (reason) => {
          this.isLoading = false
          this.isSupport = false
        })
      } catch (e) {
        this.isLoading = false
        this.isSupport = false
      }
    },
    methods: {
      getPage(pdf, pageNum){
        return new Promise((r, j) => {
          pdf.getPage(pageNum).then((page) => {
            var scale = 3
            var viewport = page.getViewport(scale)
            var canvas = document.createElement('canvas')
            canvas.style.width = "100%"
            var context = canvas.getContext('2d')
            canvas.height = viewport.height
            canvas.width = viewport.width
            var renderContext = {
              canvasContext: context,
              viewport: viewport
            }
            var renderTask = page.render(renderContext)
            this.$refs.pdfView.appendChild(canvas)
            renderTask.then(() => {
              r()
            })
          })
        })
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .pdf-wrap
    height: 100%
  .pdf-con
    width: 100%
    height: 100%
    overflow-y: auto

  .loading-text
    position: absolute
    color: #ffffff
    font-size: 20px
    bottom: 30%
    left: 50%
    margin-left: -150px

  .pd-view
    width: 100%

  .no-support
    img
      margin: 100px auto
      width: 350px
    .ns-text
      font-size: 25px
      color: #ffffff
</style>