<template lang="jade">
  .book_detail_dialog_wrapper(:class="'library_dialog_'")
    .library_dialog_mask
    .top
    .library_dialog_bg.animated.bounceInDown
      .top-cancel-btn(@click="close")
        img(src="../../img/readers/cancelmodel.png")
      .title-text
        p.tt-ul
          span.level {{config.level}}
          span.unit {{"  "+config.unit}}
        slide-text.lesson(:text="config.showName",:isAutoSlide="true")
      .content_text
        .book-img
          img(:src="config.bookCoverResUrl")
        .book-content
          .title
            | Information
          .desc
            | {{config.bookDescription}}
          .tip(v-if="isShowTip")
            | 看完绘本才可以玩哦 ~
          .btns
            vk-btn(:class="activityState.currentStatus==1?'':'begin-btn'",icon="icon-eye",type="lg-enable",:text="config.readStatus?'Reread':'Read'",:isNewTab="false",:clickFun="begin")
            .play-btn(@click.stop="showTip",@mouseleave="leaveTip")
              vk-btn(v-if="activityState.currentStatus==2",icon="icon-activity",type="lg-disable-locked",text="Activity")
            vk-btn.play-btn(v-if="activityState.currentStatus==3",icon="icon-activity",type="lg-yellow-enable",text="Activity",:clickFun="play",clickId="homepage_btn_play_activity")
            vk-btn.play-btn(v-if="activityState.currentStatus==4",type="lg-yellow-enable",icon="icon-activity",text= "Activity",:clickFun="play",clickId="homepage_btn_replay_activity")
          .result(v-if="activityState.currentStatus==4")
            img(src="../../img/index/card_yes_enable.png")
            .right-num {{activityState.rightCount}}
            img(src="../../img/index/card_error_enable.png")
            .error-num {{activityState.wrongCount}}
</template>

<script>
  import vkBtn from './vk_button.vue'
  import slideText from './vk_slide_text.vue'
  import axios from 'axios'
  import cookies from 'cookies-js'
  import vue from 'vue'
  import utils from '../../utils/_untils'
  import {$get, $post, $all} from '../readers/api.js'
  export default {
    data() {
      return {
        clickBookUrl: '/api/pc/service/reader/clickBook',
        readStartTimeUrl: '/api/pc/service/reader/setBeginTime',
        isShowTip: false,
        activityState: {
          currentStatus: 1
        }
      }
    },
    components: {
      vkBtn, slideText
    },
    props: {
      // currentStatus: 1、不显示；2、已解锁；3、未做；4、已做
      // config示例：
      // "readStatus": true,
      // "unit": "Unit 2",
      // "itemType": "book",
      // "biz_code": "R0000081",
      // "showName": "The Sun Sets on the Hill (Phonics Stories)",
      // "level": "Level 3",
      // "bookCoverResUrl": "https://teacher-media.vipkid.com.cn/resource/5bece249347d4f179fddcc3060c72a7c.jpg",
      // "bookDescription": "In \"The Sun Sets on the Hill\", Ben and Eve go to see the sun set.",
      // "id": 100
      config: {
        type: Object,
        required: false,
        default: {}
      }
    },
    mounted() {
      this.initData()
    },
    methods: {
      initData(){
        axios.get("/rest/learninggw/api/pc/material/activity/getActivityButtonInfo", {
          params: {
            readerCode: this.config.bookCode,
            studentId: cookies.get("studentId"),
            deviceType: 1,
            bookId: this.config.id
          }
        }).then(res => {
          if (res.data.code == 200) {
            this.activityState = res.data.data
          }
        })
      },
      close() {
        this.$modelClose()
      },
      play(){
        utils.clickEvent(
          cookies.get('studentId'),
          this.config.id,
          this.config.source,
          utils.clickEventConst.ACTIVITY,
          '',
          '')
        this.close()
        this.config.router.push(`/homework/activity/${cookies.get("studentId")}/${this.config.bookCode}/${this.config.id}`)
      },
      begin(){
        this.$modelClose()
        let id = this.config.id
        $all(this.setClickBook(id), this.setReadStartTime(id))
          .then(axios.spread((acct, perms) => {
            this.config.router.push({path: '/dgl/book/' + id + '/1/0'}) // 1 为major course reader
          }))
          .catch(() => {
            this.config.router.push({path: '/dgl/book/' + id + '/1/0'})
          })
      },
      showTip(){
        this.isShowTip = true
      },
      leaveTip(){
        this.isShowTip = false
      },
      setClickBook(id){
        return $post(this.clickBookUrl, {
          studentId: cookies.get("studentId"),
          bookId: id
        })
      },
      setReadStartTime(id){
        return $post(this.readStartTimeUrl, {
          studentId: cookies.get("studentId"),
          bookId: id
        })
      }
    }
  }
</script>

<style lang="stylus" scoped>
  p
    margin: 0

  .top
    height: 50%
    margin-bottom: -260px

  .book_detail_dialog_wrapper
    width: 100%
    height: 100%
    position: fixed
    top: 0
    left: 0
    z-index: 120
    .library_dialog_mask
      width: 100%
      height: 100%
      position: absolute
      top: 0
      left: 0
      background-color: rgba(0, 0, 0, 0.8)
    .library_dialog
      width: 210px
      position: absolute
      left: 50%
      margin-left: -106px
      z-index: 1
    .library_dialog_bg
      width: 810px
      min-height: 510px
      background: #8f82bc
      border-radius: 30px
      position: absolute
      left: 50%
      margin-left: -400px
      .top-cancel-btn
        position: absolute
        right: -10px
        top: -10px
        cursor: pointer
        & > img
          width: 40px
          height: 40px
      .title-text
        box-sizing: border-box
        width: 80%
        height: 96px
        padding-top: 15px
        color: #ffffff
        font-size: 12px
        margin: 0 auto
        overflow: hidden
        text-align: center
        position: relative
        .tt-ul
          font-size: 24px
        .lesson
          font-size: 34px
      .content_text
        width: 791px
        min-height: 405px
        padding: 37px
        line-height: 1.4
        background: url('../../img/readers/bookdetail_bg.png') no-repeat
        background-size: 100% 100%
        margin: 0 auto
        color: #666
        overflow: hidden
        box-sizing: border-box
        position: relative
        .book-img
          float: left
          width: 270px
          height: 330px
          background: url("../../img/readers/book.png") no-repeat
          background-size: 100% 100%
          img
            width: 254px
            height: 286px
            margin: 1px 0 0 15px
        .book-content
          float: left
          width: 410px
          margin-left: 30px
          .title
            text-align: center
            font-size: 28px
            color: #000000
          .desc
            height: 195px
            margin-top: 13px
            overflow-y: scroll
            font-size: 20px
          .tip
            box-sizing: border-box
            position: absolute
            bottom: 100px
            right: 20px
            width: 220px
            height: 56px
            text-align: center
            padding-top: 10px
            background: url("../../img/common/bg_tip_top.png") no-repeat
            background-size: 100% 100%
          .btns
            overflow: hidden
            margin-top: 30px
            .play-btn, .begin-btn
              float: left
              transition: all 0.5s
            .play-btn
              margin-left: 50px
          .result
            float: right
            width: 180px
            margin-top: 20px
            margin-bottom: -20px
            text-align: center
            img
              float: left
              margin-right: 10px
              margin-left: 30px
            div
              float: left

  .play-btn-hide
    display: none

</style>
