<template lang="jade">
  .hot-activity-container
    bg
    //后退
    top-part(:isAbsoluteFix="true", :ifShow="false")
    //右侧账单
    .diamond-sum-wrapper
      .diamond-sum
        .diamond-sum-content(@click="showSecretBook")
          .icon-secret
          .number 秘籍
        .diamond-sum-content(@click="enterGiftShop")
          .icon-gem
          .number {{impelNumber}}
          .icon-right-btn
          .add-number.animated.fadeInUp(v-show="isShowAddNumber")
            number.number-text(:number="addImpelsNumber")
      .diamond-sum-content-bar
    // 电子贺卡入口
    .greeting-cards
      .greeting-cards-con(@click="enterGreetingCards")
        .greeting-cards-icon(:class="{'greeting-cards-icon-new': hasNewGreetingCard}")
        .greeting-cards-new(v-if="hasNewGreetingCard")
        img.light-new(src="../../img/greeting_cards/light@2x.png", v-if="hasNewGreetingCard")

    //中部宝箱
    .diamond-container
      .diamond-container-head
        .diamond-container-head-content-div
          p.diamond-container-head-content {{activityNotice}}
      .diamond-container-bg
      .diamond-container-body
        //宝箱列表
        week-impel(@openWeekImpelBox="showAddImpels")
        //周打卡区域
        week-check(@afterOpenBox="showAddImpels" @sortAllToast="sortAllToast", :toast-regulator="toastRegulator")
    //任务卡
    task-cards(@afterOpenBox="showAddImpels" @sortAllToast="sortAllToast", :toast-regulator="toastRegulator")
    // 宝石增加动画
    bong-package(v-if="isShowBong",:number="addImpelsNumber",@boxClose="closeBox")
    //引导页
    guide(v-if="isShowGuidePage",@guideClose="isShowGuidePage = false")
    //剩余月宝箱发放
    finish-month(v-if="toastRegulator === 'month'",@close="toastRegulator=''")
    vkDialogSecret(:showDialog="isShowSecretBook", @closeIt="isShowSecretBook = false", :secretDialogType="'task_book'")
    .dino-player-box
      dinoPlayer(:is-home="false")
</template>

<script>
  import axios from 'axios'
  import formUrlEncoded from 'form-urlencoded'
  import cookies from 'cookies-js'
  import TopPart from '../common/top_part.vue'
  import number from '../common/vk_number.vue'
  import bongPackage from './components/bong_package.vue'
  import weekCheck from './components/week_check.vue'
  import weekImpel from './components/week_impel.vue'
  import utils from '../../utils/_untils'
  import guide from './components/guide.vue'
  import bg from './components/bg.vue'
  //下次delete
  import finishMonth from './components/finish_month.vue'
  import taskCards from './components/task_cards.vue'
  import openImpelSound from '../../assets/sound/open_impel_sound.mp3'
  import showImpelSound from '../../assets/sound/show_impel_sound.mp3'
  import vkDialogSecret from '../common/vk_dialog_secret.vue'
  import dinoPlayer from '../index/components/dino.vue'
  import {localStorageUtil} from '../../utils/_untils'

  export default {
    data(){
      return {
        isShowSecretBook: false, //显示任务秘籍
        toastRegulator: '', // 允许显示的弹出层 'guide', 'motivate', 'week', 'month'
        toastListRegulator: [], // 弹出层控制 按优先级顺序排列 新手引导-周打卡中断-月宝箱领取-激励海报
        isShowAddNumber: false,
        addImpelsNumber: "0",//增加的宝石数
        impelNumber: 123,//总宝石数
        activityNotice: '上课解锁能量包，得能量石！兑换更多好礼！',
        isShowBong: false,
        //引导页判断
        isShowGuidePage: false,
        hasNewGreetingCard: false//有新贺卡
      }
    },
    components: {
      TopPart,
      number,
      bongPackage,
      weekImpel,
      weekCheck,
      guide,
      bg,
      finishMonth,
      taskCards,
      vkDialogSecret,
      dinoPlayer
    },
    watch: {
      // 等待所有弹出窗的异步请求结束处理弹出优先级
      toastListRegulator: function(val, oldVal) {
        if (val.length === 4) {
          let arr = []
          //按层级高低排序
          for (let i = 0; i < val.length; i++) {
            if (val[i].val) {
              arr[val[i].priority] = val[i].name
            } else {
              arr[val[i].priority] = ''
            }
          }
          //找出最高层级赋值给this.toastRegulator
          for (let j = 0; j < arr.length; j++) {
            if (arr[j] !== '') {
              //当前显示的弹出层名称
              this.toastRegulator = arr[j]
              if (this.toastRegulator === 'motivate') {
                //弹出定向激励新任务，清除缓存内容
                localStorageUtil.del('motivate_poster_content')
              }
              arr[j] = ''
              break
            }
          }
          localStorageUtil.set('wait_toast_names', JSON.stringify(arr))
        }
      }
    },
    created(){
      this.$soundPush(
        [
          {name: 'openImpel', path: openImpelSound},
          {name: 'showImpel', path: showImpelSound}
        ]
      )
      // 新手引导
      setTimeout(() => {
        this.isShowGuide()
      }, 1000)
      //获取学生的初始化信息
      this.getStudentImpelNumbers()
      //打开所有月宝箱
      this.openAllMonthBox()
      //获取电子贺卡未读数
      this.getGreetingCardsNoReadNumber()
    },
    methods: {
      //打开账单
      showSecretBook() {
        this.isShowSecretBook = true
        this.$playSound("click")
      },
      // 电子贺卡入口
      enterGreetingCards(){
        sa.track('learning_click', {
          'click_id': 'pc_learning_greeting_cards_enter'
        })
        this.hasNewGreetingCard = false
        this.$router.push("/greeting_cards")
      },
      // 电子贺卡未读数
      getGreetingCardsNoReadNumber(){
        axios.get("/rest/learninggw/api/point/egreetingCardSendReceive/getUnReadCount", {
          params: {
            studentId: cookies.get('studentId')
          }
        }).then(res => {
          if(res.data.code == 200){
            if(res.data.data) {
              this.hasNewGreetingCard = true
            } else {
              this.hasNewGreetingCard = false
            }
          }
        })
      },
      // 弹出层统一管理
      sortAllToast(msg) {
        let arr = ['guide', 'motivate', 'week', 'month'] // 优先权从高到低
        for (let key in msg) {
          this.toastListRegulator.push({
            name: key,
            val: msg[key],
            priority: key === 'week-1' || key === 'week-2' ? 2 : arr.indexOf(key)
          })
        }
      },
      //展示增加宝石的动画,打开领取宝石的弹窗
      showAddImpels(impelNumber){
        this.isShowBong = true
        this.addImpelsNumber = impelNumber.toString()
        //刷新用户宝石数
        this.getStudentImpelNumbers()
      },
      //关闭弹窗
      closeBox(){
        //显示宝石数动画
        this.isShowAddNumber = true
        this.isShowBong = false
        setTimeout(() => {
          this.isShowAddNumber = false
        }, 2000)
      },

      //打开之前的所有月宝箱
      openAllMonthBox(){
        axios.get('rest/learninggw/api/pc/magic/treasureBox/hasClosedMonthTreasureBoxByStudentId',
          {
            params: {
              studentId: cookies.get("studentId")
            }
          }).then((res) => {
          // 获取弹出层缓存队列
          let toastNames = localStorageUtil.get('wait_toast_names')
          let toastNamesArr = toastNames ? JSON.parse(toastNames) : []
          if (toastNamesArr[3] === 'month' || res.data && res.data.code == 200 && res.data.data) {
            this.sortAllToast({"month": true})
          } else {
            this.sortAllToast({"month": false})
          }
        }).catch(() => {
          this.sortAllToast({"month": false})
        })
      },
      //获取学生的egg数目
      getStudentImpelNumbers(){
        let promise = axios.get("/rest/learninggw/api/pc/magic/eggshell/getByStudentId", {
          params: {
            studentId: cookies.get("studentId")
          }
        })
        promise.then(res => {
          if (res.data.code == 200)
            this.impelNumber = res.data.data.availableNumber
        })
      },

      //打开宝石记录
      enterGiftShop(){
        this.$router.push("/gift_exchange")
        sa.track('learning_click', {
          'click_id': 'pc_learning_impel_box_acitivity_enter_gift'
        })
      },
      //引导页相关----------------------
      //是否显示宝箱引导页
      isShowGuide(){
        if (!window.localStorage) {
          this.sortAllToast({"guide": false})
          return
        }
        if (!window.localStorage.getItem('ifFirst')) {
          this.isShowGuidePage = true
          window.localStorage.setItem('ifFirst', true)
          this.sortAllToast({"guide": true})
        } else {
          this.sortAllToast({"guide": false})
          return
        }
      }
    }
  }
</script>
<style lang="stylus" scoped>
  .add-number
    position: absolute
    width: 200px
    height: 46px

  .hot-activity-container
    position: absolute
    top: 0
    left: 0
    right: 0
    bottom: 0
    background-size: 100% 100%

  .dino-player-box
    position: fixed
    left: 30px
    bottom: 10px
    z-index: 2

  //背景图 end
  //title start
  .diamond-sum-wrapper
    position: absolute
    height: 46px
    top: 26px
    right: 35px

  // 电子贺卡入口
  .greeting-cards
    position: absolute
    width :122px
    top: 120px
    right: 11px
    .greeting-cards-con
      position: relative
      height: 69px
      background-color: #7342A0
      z-index: 20
      cursor: pointer
      padding-left: 15px
      border : 8px solid #AD9AFF
      // background-image:linear-gradient(#fff,#fff),linear-gradient(#5c5fa5,)
      border-right:0
      border-radius: 100px  0px  0px  100px
      .greeting-cards-new
        position :absolute
        width :46px
        height :20px
        top: 2px
        right: 3px
        z-index: 2
        background: url("../../img/greeting_cards/new@2x.png") no-repeat
        background-size: 100% auto
        animation: newScale linear 2s infinite
      .greeting-cards-icon
        position :absolute
        width :60px
        height :62px
        top: 0px
        right: 35px
        z-index: 1
        background: url("../../img/greeting_cards/mail_icon@2x.png") no-repeat
        background-size: 100% auto
      .greeting-cards-icon-new
        background: url("../../img/greeting_cards/card_icon@2x.png") no-repeat
        background-size: 100% auto
      .light-new
        width: 97px
        margin: -10px 0 0 -15px
        animation: lightRotate linear 5s infinite

  .diamond-sum-content-bar
    position: absolute
    display: inline-block
    top: 0
    right: -35px
    width: 50px
    height: 46px
    background: url("../../img/hot_activity/hot_activity_star_no.png") no-repeat
    background-size: 100% 100%

  .diamond-sum
    position: relative
    height: 46px
    background-color: #5D3B7C
    border-radius: 70px
    z-index: 20
    cursor: pointer
    padding-left: 15px
    .icon-gem
      position: absolute
      display: inline-block
      left: -10px
      top: -3px
      background: url("../../img/hot_activity/hot_activity_meteorite.png") no-repeat
      background-size: 100% 100%
      width: 32px
      height: 32px
    .icon-secret
      position: absolute
      display: inline-block
      left: -11px
      top: -6px
      background: url("../../img/gift/secret.png") no-repeat
      background-size: 100% 100%
      height: 36px
      width: 36px
      cursor: pointer
    .icon-right-btn
      position: relative
      display: inline-block
      margin-top: 7px
      margin-left: 6px
    .number
      position: relative
      display: inline-block
      font-size: 14px
      color: #fff
      line-height: 26px
      text-align: right
    .diamond-sum-content
      position: relative
      display: inline-block
      background-color: #8e66b3
      height: 26px
      border-radius: 35px
      padding-left: 30px
      padding-right: 8px
      margin: 10px

  //该样式是为了保证让 通知超过所承载的长度时，能够从右向左移动
  .diamond-container-visibility-hidden
    position: absolute
    top: 100px
    font-weight: 500
    font-size: 24px
    line-height: 25px
    visibility: hidden

  //宝箱活动 start
  .diamond-container
    position: absolute
    left: 50%
    width: 830px
    height: 290px
    margin-left: -415px

  .diamond-container-head
    position: absolute
    bottom: 20px
    left: 0px
    width: 100%
    height: 32px
    z-index: 15

  .diamond-container-head-content-div
    background: url(../../img/hot_activity/hot_activity_announce_bg.png) no-repeat
    background-size: 100% 100%
    position: relative
    display: inline-block
    left: 50%
    top: 0
    width: 420px
    height: 32px
    margin-left: -210px
    overflow: auto

  .diamond-container-head-content
    position: relative
    width: 100%
    font-size: 14px
    font-weight: 500
    line-height: 32px
    text-align: center
    overflow-y: hidden
    color: #fff

  .diamond-container-head_animate
    animation: translateLeft 12s 1s linear infinite

  .diamond-container_notice
    position: absolute
    display: table
    top: 47px
    left: 221px
    width: 597px
    height: 58px
    background: url(../../img/hot_activity/hot_activity-lesson@2x.png) no-repeat
    background-size: 597px 58px
    z-index: 21

  .diamond-container_notice_content
    display: table-cell
    padding: 0 31px
    width: 520px
    vertical-align: middle
    font-size: 14px
    line-height: 1.3
    color: #ffffff
    text-align: center

  .diamond-container-bg
    position: absolute
    top: 0
    width: 830px
    height: 290px
    background: url(../../img/hot_activity/top_bg@2x.png) no-repeat
    background-size: 100% 100%

  .diamond-container-body
    position: absolute
    top: 0
    width: 830px
    height: 290px
    z-index: 20

  .diamond-week-activity-name
    position: absolute
    left: 76px
    top: 63px
    font-size: 14px
    font-weight: 600
    color: #fff
    opacity: .8

  //下面的是对宝箱的背部面板的样式
  .diamond_month_back_pane
    position: absolute
    left: 14px
    bottom: 11px
    width: 1016px
    height: 192px
    z-index: 10

  .diamond-month-container
    position: absolute
    left: 0
    top: 0
    min-width: 180px
    width: 180px
    height: 172px
    background-color: rgba(142, 123, 225, 0.9)
    border-radius: 45px
    overflow: hidden
    transition: 0.5s transform

  //月度宝箱信息
  .diamond_month_message
    position: absolute
    left: 177px
    top: 30px
    font-size: 14px
    color: #fff
    opacity: .8

  .float-none
    float: none

  @-webkit-keyframes movemove
    0%
      left: 0px
    100%
      left: -141px

  @media screen and (min-width: 1800px)
    .bag-star
      background: none

    .task-list-bar
      bottom: 20%

    .hot-activity-container
      background: url("../../img/hot_activity/hot_activity_big_bg.png") no-repeat
      background-size: 100% auto

    .task-list
      width: 1350px
      margin-left: -675px

    .task-list-content
      width: 1150px

    .task-arrow-left
      left: 30px

    .task-arrow-right
      right: 30px

    .diamond-container
      top: 103px

    .diamond-sum-wrapper
      top: 169px
      right: 194px

    .greeting-cards
      top: 260px
      right: 159px

  @media screen and (max-width: 1280px)
    .diamond-container
      top: 10px

    .diamond-sum-wrapper
      transform: scale(0.9)
      z-index: 1
      right: 21px

    .greeting-cards
      transform: scale(0.9)
      z-index: 1
      right: 3px

    .list-detail-wrapper
      transform: scale(0.9)

    @keyframes translateLeft
      0%
        transform: translateX(100%)
      25%
        transform: translateX(50%)
      50%
        transform: translateX(0%)
      75%
        transform: translateX(-50%)
      100%
        transform: translateX(-100%)

@keyframes lightRotate
  0%
    opacity: 0.5
    transform: rotateZ(0deg) scale(0.8, 0.8)
  50%
    opacity: 1
    transform: rotateZ(180deg) scale(1.2, 1.2)
  100%
    opacity: 0.5
    transform: rotateZ(360deg) scale(0.8, 0.8)
@keyframes newScale
  0%
    transform: scale(0.8, 0.8)
  50%
    transform: scale(1, 1)
  100%
    transform: scale(0.8, 0.8)
</style>

