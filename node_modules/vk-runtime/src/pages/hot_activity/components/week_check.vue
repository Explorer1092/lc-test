//周打卡组件
<template lang="jade">
  .week-check-con
    vk-tip(:class="{'vk-tip-count-down': isShowCountDown}", v-if="isShowTip || isShowCountDown",:message="buildingText",type="while-top")
    //打卡未开始
    .no-open(v-if="!isOpenWeekCheck",@click="isShowTip = true",@mouseleave="isShowTip = false")
      img(src="../../../img/hot_activity/sign_in_bg@2x.png")
    //周打卡
    week-check-package(v-if="isOpenWeekCheck",:isCurrentWeek="isFinishCurrentWeekCheck",:step="continueWeek",@openIt="openBox",:treasureBoxCount="noOpenBox")
    //没有连续打卡的提示
    no-serial-week-check(v-if="isShowNoSerialWeekCheckComputed",:weekBeforeBreak="continueWeekBeforeBreak",:continueWeek="continueWeek",@close="closeNoSerialWeekCheck")
    //周打卡获取宝石
    week-check-getter(v-if="isShowOpenBoxCheckComputed",@openIt="openBox",:step="continueWeek")
</template>
<script>
  import formurlencoded from "form-urlencoded"
  import axios from 'axios'
  import cookies from 'cookies-js'
  import hotActivityTip from "./hot_activity_tip.vue"
  import weekCheckGetter from './week_check_getter.vue'
  import noSerialWeekCheck from './no_serial_week_check.vue'
  import weekCheckPackage from './week_check_package.vue'
  import vkTip from '../../common/vk_tip.vue'
  import bongPackage from './bong_package.vue'
  import {localStorageUtil} from '../../../utils/_untils'

  export default {
    props: {
      toastRegulator: {
        type: String,
        default: ''
      }
    },
    data() {
      return {
        isShowCountDown: false, //是否显示过期倒计时
        firstEnter: true,
        //未连续打卡
        isShowNoSerialWeekCheck: false,
        continueWeek: 0,
        boxId: 0,
        noOpenBox: 0,
        //是否开启周打卡
        isOpenWeekCheck: false,
        buildingText: "新活动建设中~",
        isShowTip: false,
        gemNumber: 0,
        isFinishCurrentWeekCheck: false,
        //中断之前的打卡周数
        continueWeekBeforeBreak: 0,
        isShowOpenBox: false
      }
    },
    components: {
      noSerialWeekCheck,
      weekCheckGetter,
      weekCheckPackage,
      vkTip,
      bongPackage
    },
    computed: {
      isShowNoSerialWeekCheckComputed() {  
        let flag = this.isShowNoSerialWeekCheck && this.toastRegulator === 'week-1'
        if (flag) {
          localStorageUtil.set("is_have_show_break_page", flag)
        }        
        return flag
      },
      isShowOpenBoxCheckComputed() {
        return this.isShowOpenBox && this.toastRegulator === 'week-2'
      }
    },
    methods: {
      closeNoSerialWeekCheck(){
        this.isShowNoSerialWeekCheck = false
      },
      //是否开启周打卡
      isShowWeekCheck(){
        axios.get("/rest/learninggw/api/point/activity/weekSign/isBeginWeekSign").then(res => {
          if (res.data && res.data.code == 200 && res.data.data) {
            this.weekBox()
            this.isOpenWeekCheck = true
          } else {
            this.$emit("sortAllToast", {"week": false})
          }
        }).catch(() => {
          this.$emit("sortAllToast", {"week": false})
        })
      },
      //开宝箱
      openBox(){
        this.$playSound("click")
        axios.post("/rest/learninggw/api/point/activity/weekSignTreasureBox/openByIdAndStudentId",
          formurlencoded({
            id: this.boxId,
            studentId: cookies.get("studentId")
          })
        ).then(res => {
          if (res.data && res.data.code == 200) {
            this.isShowOpenBox = false
            this.gemNumber = res.data.data
            this.weekBox()
            this.$emit("afterOpenBox", this.gemNumber)
            this.isShowCountDown = false //过期提示重置
          } else {
            this.$showToast("已经领取过了")
            this.isShowOpenBox = false
          }
        })
        sa.track('learning_click', {'click_id': 'pc_learning_hot_activity_open_week_check'})
      },
      //周打卡
      weekBox(){ 
        axios.get("/rest/learninggw/api/point/activity/weekSign/weekSignInfoAndCloseBoxCount", {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then(res => {
          var data = null
          let emitData = {"week": false}
          if (res.data && res.data.code == 200 && res.data.data) {
            data = res.data.data
          } else {
            this.$showToast("获取周打卡宝箱失败了")
            this.$emit("sortAllToast", emitData)
            return
          }
          // 获取弹出层缓存队列
          let toastNames = localStorageUtil.get('wait_toast_names')
          let toastNamesArr = toastNames ? JSON.parse(toastNames) : []
          //中断 is_have_show_break_page 是否已经显示过了,
          //continueWeekBeforeBreak 必须之前有连续打卡状态才弹出中断弹窗，否则就是刚上线，初始化状态
          if (toastNamesArr[2] === "week-1" || data.continueStatus == 'BREAK' && data.continueWeekBeforeBreak > 0 && !localStorageUtil.get("is_have_show_break_page")) {
            this.isShowNoSerialWeekCheck = true
            emitData = {"week-1": true}
            this.continueWeekBeforeBreak = data.continueWeekBeforeBreak
          }
          //连续打卡时清除 is_have_show_break_page 状态
          if (data.continueStatus == 'CONTINUE') {
            localStorageUtil.set("is_have_show_break_page", false)
            //清除打卡中断标识
            if (toastNamesArr[2] === "week-1") {
              toastNamesArr[2] = ''
              localStorageUtil.set('wait_toast_names', JSON.stringify(toastNamesArr))
            }
          }
          //连续
          this.continueWeek = data.continueWeek
          // this.continueWeek = 3   
          this.boxId = data.activityWeekSignTreasureBoxId
          this.noOpenBox = data.treasureBoxCount
          this.isFinishCurrentWeekCheck = data.isCurrentWeekSign
          // 有未打开的宝箱，并且当前页第一提示，中断弹窗没有弹出
          if (this.noOpenBox > 0 && this.firstEnter && !this.isShowNoSerialWeekCheck) {
            this.firstEnter = false
            this.isShowOpenBox = true
            emitData = {"week-2": true}
          } else if (!this.noOpenBox) {
            //没有未打开的宝箱
            if (toastNamesArr[2] === "week-2") {
            // 如果有上次未显示的弹出层，清除  
              toastNamesArr[2] = ''
              localStorageUtil.set('wait_toast_names', JSON.stringify(toastNamesArr))
            }
          }
          this.$emit("sortAllToast", emitData)
          //倒计时提示
          this.getCountDownTimeTip(data.expireDateTime, data.serverDateTime)
        }).catch(error => {
          this.$showToast("获取周打卡宝箱失败了,", error)
          this.$emit("sortAllToast", {"week": false})
        })
      },
      //获取倒计时提示
      getCountDownTimeTip(expireDateTime, serverDateTime) {
        //如果有未打开的宝箱并且宝箱理过期时间还有3天之内，提示倒计时
        if (!expireDateTime || !serverDateTime || expireDateTime - serverDateTime <= 0) {
          return
        }
        let serverDateTimer = new Date(serverDateTime)
        let expireDateTimer = new Date(expireDateTime)
        if (this.noOpenBox > 0 && serverDateTimer.getFullYear() === expireDateTimer.getFullYear() && expireDateTimer.getMonth() === serverDateTimer.getMonth() && expireDateTimer.getDate() - serverDateTimer.getDate() < 4) {
          this.isShowCountDown = true
          let dayCount = expireDateTimer.getDate() - serverDateTimer.getDate()
          this.buildingText = dayCount === 0 ? '今天到期' : `${dayCount}天后过期`
        }
      }
    },
    mounted() {
      this.isShowWeekCheck()
    }
  }
</script>
<style lang="stylus" scoped>
  .week-check-con
    position: absolute
    left: 35px
    top: 43px
    width: 180px
    height: 192px
    z-index: 1

    .vk-tip-count-down
      left: 48px
      top: 8px

  .no-open
    margin: -26px auto
    cursor: pointer
    img
      width: 100%

</style>
