<template lang="jade">
  //宝箱列表页
  .diamond-week-container(id="diamondWeekContainer")
    hot-activity-tip.animated.zoomIn(v-if="isShowTip",:config="tip")
    //宝箱的选择日期
    .diamond-choose-date
      .diamond-choose-left(
      @click="clickLeftBtn")
        .diamond-choose-left-arrow.icon-right-btn(style="transform:rotate(180deg)")
      .diamond-choose-content  {{impelFromDate}}~{{impelToDate}}
      .diamond-choose-right(@click="clickRightBtn",:class="{'is-not-click':disableClick}")
        .diamond-choose-right-arrow.icon-right-btn
    .diamond-week-double-flag-container
      .diamond-double-container(:class="'diamond-double-container-box-'+index",v-if="box.status === 'close' && box.rate > 1",v-for="(box,index) in weekImpels")
        .diamond-double-impel
        number.number-text(:number="box.rate.toString()")
    //课程宝箱
    .diamond-week-box(:class="'diamond-week-box-' +index",v-for ="(box,index) in weekImpels")
      .impel-stone-count-tip(v-if="box.status === 'close'")
        i.icon 
        span +
        span.number {{box.totalEggshellNumber}} 
      .diamond-week-impel(:id="'icon-box-' + (index+1)",:class="'icon-box-' + (index+1)+'-lock'",
      @mouseleave="isShowTip=false", 
      @click.stop="openPackage(box.totalEggshellNumber,box.refId,box.status,index,$event)")  
      .diamond-week-bg(
      @click.stop="openPackage(box.totalEggshellNumber,box.refId,box.status,index,$event)",
      :id="'icon-succeed-bg-' + (index+1)")
    //灰色进度条
    .diamond-week-process
    //进度条到哪了
    .diamond-week-current
      .diamond-line-inner(v-for="(box,index) in weekImpels")
        .diamond-week-circle(style="display:none;",:id="'diamond_week_circle_'+(index+1)",:class="'diamond-week-circle-'+(index+1)+ '-' +box.status"
        v-show="ifDiamondWeeKCircle")
        .diamond_week_line(:id="'diamond_week_line-'+(index+1)",:class="'diamond_week_line-'+(index+1)+'-'+box.status")
    //课节行
    .diamond-week-lesson
      span(v-for="i in 5")
        | 第{{i}}节

</template>
<script>
  import formurlencoded from "form-urlencoded"
  import axios from 'axios'
  import cookies from 'cookies-js'
  import hotActivityTip from './hot_activity_tip.vue'
  import number from '../../common/vk_number.vue'
  import utils from '../../../utils/_untils'
  import Vue from 'vue'
  export default {
    data() {
      return {
        impelFromDate: "",
        impelToDate: "",
        //提示的信息
        disableClick: false,
        durationTime: 4000,
        //背景图片
        weekImpelBg: [],
        //diamond-week-circle这处不用显示了
        ifDiamondWeeKCircle: false,
        weekImpels: [],
        impelToTime: 0,
        isShowTip: false,
        tip: {
          state: '',
          isShowWeekCheck: false,
          isShowWeek: true,
          tipStyle: {
            top: 0,
            left: 0
          },
          minImpels: 0,
          maxImpels: 0,
          weekNeededLesson: 0
        }
      }
    },
    components: {
      hotActivityTip,
      number
    },
    methods: {
      //显示提示
      showTrips(tipConfig){
        this.isShowTip = true
        const impelNums = [
          [10, 25],
          [50, 60],
          [60, 80],
          [100, 110],
          [115, 120]
        ]
        tipConfig.isShowWeek = true
        tipConfig.minImpels = impelNums[tipConfig.weekNeededLesson - 1][0]
        tipConfig.maxImpels = impelNums[tipConfig.weekNeededLesson - 1][1]
        this.tip = tipConfig
      },
      //设置周宝箱的状态
      _setWeekImpelsStatus(weekImpelsArray, serverTime){
        let length = weekImpelsArray.length
        if (length > 0) {
          for (let i = 0; i < length; i++) {
            var week = {}
            if (weekImpelsArray[i].status === 'CLOSE' && serverTime >= weekImpelsArray[i].expireDateTime) {
              //宝箱过期了
              week.status = 'o-expired'
            } else {
              week.status = weekImpelsArray[i].status.toLowerCase()
            }
            week.refId = weekImpelsArray[i].id
            week.totalEggshellNumber = weekImpelsArray[i].totalEggshellNumber
            week.rate = weekImpelsArray[i].rate
            Vue.set(this.weekImpels, i, week)
          }
          Vue.nextTick(() => {
            this.initWeekImpel()
          })
        }
      },
      //设置
      _setDate(fromTime, toTime){
        this.impelFromTime = fromTime
        this.impelToTime = toTime
        this.impelFromDate = utils.timeFormat(this.impelFromTime)
        this.impelToDate = utils.timeFormat(this.impelToTime)
        this._isOutDateBound()
      },
      //获取宝箱数据
      getImpelsData(fromDate = null, toDate = null){
        let paramsData = {
          params: {
            studentId: cookies.get("studentId")
          }
        }
        if (fromDate) {
          paramsData.params.fromDate = fromDate
          paramsData.params.toDate = toDate
        } 
        let promise = axios.get('rest/learninggw/api/pc/magic/treasureBox/findWeekAndMonthTreasureBoxByStudentIdAndPeriodDate', paramsData)
        promise.then((resp) => {
          let data1 = resp.data
          this.weekImpels = []
          this.$nextTick(() => {
            for (var i = 0; i < 5; i++) {
              let weekImpelStatus = {
                status: 'lock',
                refId: '',
                rate: 1, //是否翻倍
                totalEggshellNumber: 0
              }
              Vue.set(this.weekImpels, i, weekImpelStatus)
            }
            if (data1.code == 200) {
              this._setDate(data1.data.currentWeekPeriodDate.fromDate, data1.data.currentWeekPeriodDate.toDate)
              let length = 5 - data1.data.weekTreasureBoxDTOList.length
              if (!this.disableClick && length > 0) {
                //历史周 进行未解锁状态的过期展示
                for (let j = 0; j < length; j++) {
                  data1.data.weekTreasureBoxDTOList.push({
                    status: 'l-expired', //解锁过期
                    refId: '',
                    rate: 1, //是否翻倍
                    totalEggshellNumber: 0
                  })
                }
              } 
              this._setWeekImpelsStatus(data1.data.weekTreasureBoxDTOList, data1.data.serverTime)
            }
          })
        })
      },
      _isOutDateBound(){
        let nowTime = Date.now()
        if (this.impelToTime >= nowTime) {
          this.disableClick = true
        } else {
          this.disableClick = false
        }
      },
      //点击左边按钮
      clickLeftBtn(){
        this._isOutDateBound()
        this.widthAuto = false
        this.$refs.monthImpel && this.$refs.monthImpel.MonthBoxAnimating()
        this.impelFromTime = this.impelFromTime - 24 * 3600 * 1000 * 7
        this.impelToTime = this.impelToTime - 24 * 3600 * 1000 * 7
        this.impelFromDate = utils.timeFormat(this.impelFromTime)
        this.impelToDate = utils.timeFormat(this.impelToTime)
        let fromDate = (utils.formatDate(this.impelFromTime).split(" "))[0]
        let toDate = (utils.formatDate(this.impelToTime).split(" "))[0]
        this.getImpelsData(fromDate, toDate)
      },
      //点击右边按钮
      clickRightBtn(){
        this._isOutDateBound()
        if (!this.disableClick) {
          this.widthAuto = false
          this.$refs.monthImpel && this.$refs.monthImpel.MonthBoxAnimating()
          this.impelFromTime = this.impelFromTime + 24 * 3600 * 1000 * 7
          this.impelToTime = this.impelToTime + 24 * 3600 * 1000 * 7
          this.impelFromDate = utils.timeFormat(this.impelFromTime)
          this.impelToDate = utils.timeFormat(this.impelToTime)
          let fromDate = (utils.formatDate(this.impelFromTime).split(" "))[0]
          let toDate = (utils.formatDate(this.impelToTime).split(" "))[0]
          this.getImpelsData(fromDate, toDate)
        }
      },
      //设置周宝箱进度条直线的位置
      _setWeekImpelsCircleLinePosition() {
        let length = this.weekImpels.length
        for (let i = 0; i < length; i++) {
          let circleNodeLine = document.getElementById('diamond_week_line-' + (i + 1))
          if (i + 1 == length || this.weekImpels[i + 1].status === "lock") {
            return
          }
          Velocity(circleNodeLine, {
            scaleX: 1
          }, {
            duration: 7900,
            delay: this.durationTime * (i / length),
            easing: 'linear'
          })
        }
      },
      //设置周宝箱进度条原点位置
      _setWeekImpelsCirclePosition() {
        let length = this.weekImpels.length
        let offset = 550 / (length - 1)
        for (let i = 0; i < length; i++) {
          let circleNode = document.getElementById('diamond_week_circle_' + (i + 1))
          let weekImpel = document.getElementById('icon-box-' + (i + 1))
          let weekImpelBg = document.getElementById('icon-succeed-bg-' + (i + 1))
          let status = this.weekImpels[i].status
          if (i === 0) {
            //视图的刷新还可以使用vue.$set ,此处有点简单粗暴
            weekImpel.classList.add('icon-box-1-' + status)
            if (status == "close") {
              weekImpelBg.classList.add('icon-succeed-bg')
              weekImpel.classList.add('box-close')
            }
            continue
          } else if (i + 1 == length) {
            Velocity(circleNode, {
              translateX: 550 - 10
            },
            {
              easing: 'linear',
              duration: this.durationTime * (i / length),
              complete: () => {
                if (status == "close") {
                  weekImpelBg.classList.add('icon-succeed-bg')
                  weekImpel.classList.add('box-close')
                }
                weekImpel.classList.add('icon-box-' + (i + 1) + '-' + status)
              }
            })
          } else {
            Velocity(circleNode, {
              translateX: offset * i - 5
            },
            {
              easing: 'linear',
              duration: this.durationTime * (i / length),
              complete: () => {
                if (status == "close") {
                  weekImpelBg.classList.add('icon-succeed-bg')
                  weekImpel.classList.add('box-close')
                }
                weekImpel.classList.add('icon-box-' + (i + 1) + '-' + status)
              }
            }
            )
          }
        }
      },
      //打开宝箱
      openPackage(impelNumber, relatedId, status, index, e) {
        let emitContent = {
          weekNeededLesson: index + 1,
          tipStyle: {
            top: 0,
            left: 0
          }
        }
        if (status && status !== 'close') {
          if (status == "o-expired" || status == "l-expired") {
            emitContent.tipStyle.top = e.target.getBoundingClientRect().top - 36 + "px"
            emitContent.tipStyle.left = e.target.getBoundingClientRect().left + 13 + "px"
          } else {
            //"lock" || "open" 
            emitContent.tipStyle.top = e.target.getBoundingClientRect().top - 46 + "px"
            emitContent.tipStyle.left = e.target.getBoundingClientRect().left - 19 + "px"
          }
          emitContent.state = status
          this.showTrips(emitContent)
          return
        }
        
        axios.post("/rest/learninggw/api/pc/magic/treasureBox/openByIdAndStudentId", formurlencoded({
          studentId: cookies.get("studentId"),
          id: relatedId
        })).then(res => {
          if (res.data.code == 200) {
            //刷新宝箱列表
            this.getImpelsData()
            //抛出事件，刷新用户宝箱数
            this.$emit("openWeekImpelBox", impelNumber.toString())
            this.$playSound("openImpel")
          } else {
            this.$showToast("领取失败")
          }
        })
        sa.track('learning_click', {
          'click_id': 'pc_learning_impel_box_acitivity_week_box'
        })
      },
      //初始化周宝箱
      initWeekImpel() {
        for (let i = 0; i < 5; i++) {
          this.weekImpelBg.push(false)
        }
        this._setWeekImpelsCirclePosition()
        this._setWeekImpelsCircleLinePosition()
      }
    },
    mounted() {
      this.getImpelsData()
    }
  }
</script>
<style lang="stylus" scoped>

  //----------------日期选择的样式start
  .diamond-choose-date
    position: absolute
    left: 258px
    top: 22px
    height: 34px
    width: 180px
    border-radius: 9px
    overflow: hidden
    margin-left: -90px

  .diamond-choose-left
    position: absolute
    left: 0
    top: 0
    width: 30px
    height: 34px
    border-top-left-radius: 9px
    border-bottom-left-radius: 9px
    cursor: pointer
    background-color: #8561ed
    .diamond-choose-left-arrow
      position: absolute
      left: 8px
      top: 10px

  .diamond-choose-right
    position: absolute
    right: 0
    width: 30px
    height: 34px
    border-top-right-radius: 9px
    border-bottom-right-radius: 9px
    background-color: #8561ed
    cursor: pointer
    .diamond-choose-right-arrow
      position: absolute
      left: 8px
      top: 10px

  .diamond-choose-content
    position: absolute
    left: 30px
    width: 120px
    height: 34px
    font-family: 'Century Gothic'
    font-size: 18px
    font-weight: 700
    text-align: center
    line-height: 34px
    color: #ffffff
    background-color: rgba(255, 255, 255, 0.2)

  //----------------日期选择的样式end

  .diamond-week-container
    position: absolute
    top: 0px
    left: 236px
    height: 217px

  .diamond-week-double-flag-container
    position: absolute
    left: 10px
    top: 66px
    height: 26px
    width: 640px

  .diamond-double-container
    position: absolute
    top: 3px
    height: 26px
    width: 100px
    background-size: 53px 20px
    .diamond-double-impel
      position: absolute
      top: -5px
      transform: scale(.7, .7)
      height: 31px
      width: 31px
      background: url(../../../img/icon/icon_index.png) no-repeat -200px -63px
      background-size: 242px 150px
    .number-text
      position: absolute
      left: -5px
      top: -12px
      width: 160px
      transform: scale(.6, .6)

  //处理倍数位置
  for location in 0 1 2 3 4
    .diamond-double-container-box-{location}
      left: location * 112px

  .diamond-week-box
    position: relative
    display: inline-block
    top: 90px
    width: 90px
    height: 90px
    cursor: pointer
    z-index: 1
    margin-right: 20px

    &:hover .impel-stone-count-tip
      animation-name: zoomIn
      opacity: 1

  .impel-stone-count-tip
    position: absolute
    display: flex
    display: -webkit-flex
    align-items: center
    justify-content: center
    box-sizing: border-box
    -webkit-align-items: center
    -webkit-justify-content: center
    min-width: 86px
    height: 39px
    font-size: 12px
    text-align: center
    padding: 7px 5px
    background: url("../../../img/hot_activity/hot_acitivity-purplebuble@2x.png") no-repeat
    background-size: 86px 39px
    top: -40px
    left: 2px 
    opacity: 0 
    animation-duration: 0.5s
    animation-fill-mode: both

    .icon
      background: url("../../../img/hot_activity/hot_activity_meteorite.png") no-repeat
      background-size: 100% 65%
      background-position: center center
      width: 20px
      height: 31px
      margin: 0 4px 0 0

    span
      color: #F85415
      font-size: 14px
      font-weight: bold

  @keyframes zoomIn {
    from {
      opacity: 0
      transform: scale3d(.3, .3, .3)
    }

    50% {
      opacity: 1
    }
  }

  .diamond-week-impel
    position: absolute
    width: 90px
    height: 90px
    background-repeat: no-repeat

  .diamond-week-bg
    position: absolute
    bottom: -8px
    left: -3px
    animation: opAn 4s linear infinite

  @keyframes opAn
    0%
      opacity 0
    10%
      opacity 0.2
    50%
      opacity 1
    100%
      opacity 0

  .box-close
    transform-origin: center bottom
    animation: boxAn 2s infinite

  @keyframes boxAn
    10%
      transform: rotate3d(0, 0, 1, 5deg)
    20%
      transform: rotate3d(0, 0, 1, -4deg)
    30%
      transform: rotate3d(0, 0, 1, 3deg)
    50%
      transform: rotate3d(0, 0, 1, -2deg)
    60%
      transform: rotate3d(0, 0, 1, 0deg)
    100%
      transform: rotate3d(0, 0, 1, 0deg)

  .diamond-week-process
    position: absolute
    top: 128px
    left: 40px
    width: 450px
    height: 14px
    background-color: rgba(255, 170, 216, 0.3)
    border-radius: 7px

  .diamond-week-current
    position: absolute
    top: 128px
    left: 40px
    width: 450px
    height: 14px
    border-radius: 7px

  .diamond-week-lesson
    position: absolute
    top: 195px
    left: 28px
    width: 600px
    span
      font-size: 12px
      color: #fff
      margin-right: 81px
      font-weight: bold
      display: inline-block

  .diamond-week-circle
    position: absolute
    width: 20px
    height: 20px
    border-radius: 100%

  .diamond-week-circle-1-open,
  .diamond-week-circle-1-o-expired,
  .diamond-week-circle-1-close
    background-color: #dbe11b

  .diamond-week-circle-2-open,
  .diamond-week-circle-2-o-expired,
  .diamond-week-circle-2-close
    background-color: #b3d649

  .diamond-week-circle-3-open,
  .diamond-week-circle-3-o-expired,
  .diamond-week-circle-3-close
    background-color: #94f0be

  .diamond-week-circle-4-open,
  .diamond-week-circle-4-o-expired,
  .diamond-week-circle-4-close
    background-color: #7dd8d6

  .diamond-week-circle-5-open,
  .diamond-week-circle-5-o-expired,
  .diamond-week-circle-5-close
    background-color: #94a2f0

  .diamond_week_line-5-open,
  .diamond_week_line-5-close,
  .diamond_week_line-5-lock
    display: none

  .diamond_week_line
    position: absolute
    top: 0px
    height: 14px
    width: 112.5px
    transition: all .79s linear
    transform: scale3d(0, 1, 1)
    transform-origin: left center

  .diamond_week_line-1-close, .diamond_week_line-1-open, .diamond_week_line-1-o-expired
    left: 0px
    background: -moz-linear-gradient(left, #dbe11b 0%, #b3d649 100%)
    background: -webkit-linear-gradient(left, #dbe11b 0%, #b3d649 100%)
    background: linear-gradient(to right, #dbe11b 0%, #b3d649 100%)
    border-top-left-radius: 7px
    border-bottom-left-radius: 7px

  .diamond_week_line-2-close, .diamond_week_line-2-open, .diamond_week_line-2-o-expired
    left: 112.5px
    background: -moz-linear-gradient(left, #b3d649 0%, #94f0be 100%)
    background: -webkit-linear-gradient(left, #b3d649 0%, #94f0be 100%)
    background: linear-gradient(to right, #b3d649 0%, #94f0be 100%)

  .diamond_week_line-3-close, .diamond_week_line-3-open, .diamond_week_line-3-o-expired
    left: 225px
    background: -moz-linear-gradient(left, #94f0be 0%, #7dd8d6 100%)
    background: -webkit-linear-gradient(left, #94f0be 0%, #7dd8d6 100%)
    background: linear-gradient(to right, #94f0be 0%, #7dd8d6 100%)

  .diamond_week_line-4-close, .diamond_week_line-4-open, .diamond_week_line-4-o-expired
    left: 337.5px
    background: -moz-linear-gradient(left, #7dd8d6 0%, #94a2f0 100%)
    background: -webkit-linear-gradient(left, #7dd8d6 0%, #94a2f0 100%)
    background: linear-gradient(to right, #7dd8d6 0%, #94a2f0 100%)
    border-top-right-radius: 7px
    border-bottom-right-radius: 7px

  .is-not-click
    opacity: .4
    cursor: not-allowed
</style>
