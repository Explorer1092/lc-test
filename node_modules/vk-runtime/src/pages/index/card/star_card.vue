<template lang="jade">
  //上课评星的卡片
  .star-content
    transition-group(enter-active-class="animated fadeInDown")
      .panel-face(key="1",v-show="currentPanelState=='face'||currentPanelState=='open'")
        .star-teacher-img(:class="isSummerCamp?'star-teacher-img-summer':''")
          img(:src="config.teacherAvatar?config.teacherAvatar+'?imageView2/2/w/70/h/70':noImg",@error="teacherErrorImg")
        .star-teacher-name
          slide-text.lesson(:text="config.teacherName",:isAutoSlide="true")
        .star-stars
          template(v-for="star in config.stars")
            .icon-star-enable
          template(v-for="star in (5-config.stars)")
            img(src="../../../img/index/card_star_disable.png")
        vk-btn.star-btn(:type="starBtn.type",:text="starBtn.text",:isNewTab="false",:link="starBtn.link", :clickFun="starClick")
        vk-progress(:pps="pps",ref="vkProgress")
      back-card(key="2",v-if="currentPanelState=='back'",:config="config")
</template>
<script>
  import axios from "axios"
  import Vue from "vue"
  import vkBtn from "../../common/vk_button.vue"
  import dialogTrial from "../../common/vk_dialog_trial.vue"
  import backCard from "./back_card.vue"
  import cookies from "cookies-js"
  import vkProgress from "../components/progress.vue"
  import dragonUtils from '../../../utils/_dragon.js'
  let noImg = require("../../../img/index/teacher_bg.png")
  import slideText from "../../common/vk_slide_text.vue"
  import model from "../../common/plugins/Model"
  import channelUtils from "../../common/course/classroomChannel.js"
  Vue.use(model)
  export default {
    data: function () {
      return {
        isShowTrail: false,
        isInDragonClient: false,
        isSummerCamp: false,
        noImg: noImg,
        starBtn: {
          type: 'lg-hide',
          text: '',
          link: '#'
        },
        pps: [
          {
            name: "预习",
            state: "use"//disable:灰色 use：可预习 used：预习完
          },
          {
            name: "上课",
            state: "use"//disable:灰色 use：可预习 used：预习完
          },
          {
            name: "做作业",
            state: "disable"//disable:灰色 use：可预习 used：预习完
          }
        ],
        //        HIDE(0,"不显示"),
        //        LOCK(1,"不可用"),
        //        UNLOCK(2, "可用"),
        //        FINISH_UNLOCK(3, "完成并继续可用"),
        //        FINISH_LOCK(4, "完成但不可用");
        backButtonState: ['hide', 'disable', 'enable', 'enable', 'disable'],
        channelUrl: '',
        tempWindow: null
      }
    },
    components: {
      vkBtn, vkProgress, backCard, slideText, dialogTrial
    },
    props: [
      'config', 'currentPanelState'
    ],
    watch: {
      config: function (n, o) {
        this.initState()
        this.initBtn()
      }
    },
    computed: {},
    mounted () {
      this.initState()
      this.initBtn()
    },
    methods: {
      initState(){
        //lessonStatus的所有取值：
        //UN_BOOKED(0,"未约"),
        //BOOKED(1, "已约，未开始"),               //11:30之前
        //IN_CLASS(2, "课程前30分钟至课程结束"),    //11：30 -- 12：30
        //OUT_CLASS(3, "已下课"),                 //12：30 -- 13：00
        //CLASS_OVER(4, "课程结束后30分钟"),       //13：00之后
        //CLASS_REPALY(5, "FINISHED & AS_SCHEDULED");     //课程状态变成FINISHED之后
        if (this.pps.length == 3) {
          if (this.config.preHomeworkButton > 2) {
            this.pps[0].state = "used"
          }
          if (this.config.classroomButton > 2) {
            this.pps[1].state = "used"
          }
          if (this.config.afterHomeworkButton > 1) {
            this.pps[2].state = "use"
          }
          if (this.config.afterHomeworkButton == 0) {
            this.pps.pop()
          }
        }
        //cardType为4 表示是公开课 公开课进度只有一个icon 5为其他课程 2：美国营队
        if ([2, 4, 5, 12].indexOf(this.config.cardType) > -1) {
          this.pps = [
            {
              name: "上课",
              state: "use"
            }]
          if (this.config.classroomButton > 2) {
            this.pps = [
              {
                name: "上课",
                state: "used"
              }]
          }
        }
        if ([11].indexOf(this.config.cardType) > -1) {
          this.pps[2].name = this.config.afterHomeworkButtonText
        }

        if ([13].indexOf(this.config.cardType) > -1) {
          this.pps = [
            {
              name: "读绘本",
              state: "used"
            },
            {
              name: "上课",
              state: "disable"
            }
          ]
          if (this.config.bookStatus == 1) {
            this.pps[0].state = "used"
          }
          if (this.config.classroomButton > 2) {
            this.pps[1].state = "used"
          }
        }
      },
      async starClick() {
        //        CourseCardStatus
        //          PRE_CLASS(0, "预习状态"),
        //            ON_CLASS(1, "上课状态"),
        //            ON_HOMEWORK(2, "做作业状态"),
        //            AFTER_CLASS(3, "课程已经完成"),
        //            ON_RESULT(4, "查看结果状态");
        //查看结果状态，点击查看结果，跳转报告页面,注意是用 courseCardStatus 判断的
        if (this.config.courseCardStatus == 4) {
          axios.get('/rest/learninggw/api/pc/homepage/getStudentTrailResult', {
            params: {
              studentId: cookies.get("studentId"),
              onlineClassId: this.config.onlineClassId
            }
          }).then((res) => {
            if (res.data.data && res.data.data.hasTrialResult) {
              this.$router.push("/test_result/0/" + this.config.onlineClassId)
            } else {
              this.$showToast("英语等级报告正在生成中，请稍后查看~")
            }
          }).catch((err) => {
            this.$showToast("英语等级报告正在生成中，请稍后查看~")
          })
          return
        }
        //课程回放
        if ([5].indexOf(this.config.lessonStatus) > -1) {
          this.starBtn.link = `/router/learning/replay/major?onlineClassId=${this.config.onlineClassId}`
          if ([4, 13].indexOf(this.config.cardType) > -1) {
            this.starBtn.link = `/router/www/openclass/student/playback?onlineClassId=${this.config.onlineClassId}`
          }
          this.courseReplay()
          return
        }
        //进教室
        if ([2, 3].indexOf(this.config.lessonStatus) > -1) {
          this.starBtn.link = `/router/learning/classroom/major?onlineClassId=${this.config.onlineClassId}`
          //公开课 进教室
          if ([4, 13].indexOf(this.config.cardType) > -1) {
            switch (this.config.classType) {
            case "PUBLIC_CLASSROOM_RECORDED"://录播课进教室
              window.open(`//${window.location.host.replace(/lc/, 'www')}/icvideo/?onlineClassId=${this.config.onlineClassId}`)
              return
            case "PUBLIC_CLASSROOM"://正常公开课进教室
              this.starBtn.link = `/router/www/openclass/student/onlineclass?onlineClassId=${this.config.onlineClassId}`
              break
            }
            this.starBtn.link = `/router/www/openclass/student/onlineclass?onlineClassId=${this.config.onlineClassId}`
          } else {
            // 请求之后打开窗口会被拦截，提前打开
            if (!dragonUtils.isOnDragonClient() && this.config.courseId !== 597767) {
              this.tempWindow = window.open('_blank')
            }
            // 接入渠道判断
            this.channelUrl = await channelUtils.getChannel(this.config.onlineClassId)
          }
          this.checkTrial()
          return
        }
      },
      //Trial课超约判断
      checkTrial(){
        if (this.config.courseId == 597767) {
          if (this.config.bookType != 0 && this.config.bookType != 2) {
            axios.get('/rest/learninggw/api/pc/homepage/classroom/checkExcessClassAndAllotTeacher', {
              params: {
                studentId: cookies.get("studentId"),
                onlineClassId: this.config.onlineClassId
              }
            }).then((res) => {
              if (res.data.code == 200) {
                this.trailToast()
              } else {
                //弹出toast
                this.$showToast('啊哦，教室创建失败，<br>建议联系约课老师重新安排哦')
              }
            }).catch((err) => {
              this.$showToast('啊哦，教室创建失败，<br>建议联系约课老师重新安排哦')
            })
          } else {
            this.trailToast()
          }
        } else {
          this.enterClassRoom()
        }
      },
      trailToast(){
        this.$modelShow({
          model: dialogTrial,
          title: "为了确保试听效果，请您阅读如下注意事项并进行检查确认",
          buttonText: "知道了",
          enter: () => {
            this.$modelClose()
            this.enterClassRoom()
          },
          closeDialog: () => {
            this.$modelClose()
          }
        })
      },
      //进教室 小恐龙判断
      enterClassRoom() {
        // 非公开课接入护城河（one to one）
        if (this.channelUrl) {
          this.goChannel(this.channelUrl, this.tempWindow)
          return
        }
        if (dragonUtils.isOnDragonClient()) {
          //pc app进教室loading
          this.starBtn.type = "lg-loading"
          this.starBtn.text = "进入中"
          sa.track('learning_click', {
            'click_id': 'pc_learning_homepage_pcapp_btn_enter_classroom',
            'online_class_id': this.config.onlineClassId,
            'book_type': this.config.bookType
          })
          var isOpenClass = true
          if ([4, 13].indexOf(this.config.cardType) > -1) {
            isOpenClass = true
          } else {
            isOpenClass = false
          }
          dragonUtils.goToClassRoomInDragon(this.config.onlineClassId, isOpenClass, () => {
            this.initBtn()
          })
        } else {
          sa.track('learning_click', {
            'click_id': 'pc_learning_homepage_btn_enter_classroom',
            'online_class_id': this.config.onlineClassId,
            'book_type': this.config.bookType
          })
          window.open(this.starBtn.link)
        }
      },
      //点击课程回放
      courseReplay() {
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_btn_replay',
          'online_class_id': this.config.onlineClassId
        })
        setTimeout(() => {
          window.open(this.starBtn.link)
        })
      },
      initBtn() {
        this.starBtn.type = "lg-" + this.backButtonState[this.config.classroomButton]
        this.starBtn.text = this.config.classroomButtonText
        //卡片正面查看报告
        if (this.config.courseCardStatus == 4) {
          this.starBtn.type = "lg-" + this.backButtonState[this.config.trialResultButton]
          this.starBtn.text = this.config.trialResultText
        }
      },
      teacherErrorImg(e) {
        e.target.src = noImg
      },
      // 接入护城河
      goChannel(url, tempWindow) {
        if (dragonUtils.isOnDragonClient()) {
          sa.track('learning_click', {
            'click_id': 'pc_learning_pcapp_wop_enter_classroom',
            'online_class_id': this.config.onlineClassId,
            'book_type': this.config.bookType,
            'service_url': url
          })
          window.location.href = url
        } else {
          sa.track('learning_click', {
            'click_id': 'pc_learning_wop_enter_classroom',
            'online_class_id': this.config.onlineClassId,
            'book_type': this.config.bookType,
            'service_url': url
          })
          if (tempWindow) {
            tempWindow.location.href = url
          } else {
            window.open(url)
          }
        }
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .star-content
    position: relative
    text-align: center
    padding-top: 25px

  .star-video
    height: 127px
    width: 180px
    border-radius: 20px
    border: solid #ff5c01 5px
    margin: 0 auto

  .star-btn
    margin: 20px auto

  .pb-btn
    margin: 20px auto

  .star-teacher-img
    height: 70px
    width: 70px
    border: solid 4px #6ad3c5
    border-radius: 50%
    overflow: hidden
    margin: auto
    img
      width: 100%

  .star-teacher-img-summer
    border: solid 4px #bee9b5

  .star-teacher-name
    color: #999999
    font-size: 22px
    text-align: center
    width: 200px
    margin: 10px auto

  .star-stars
    margin-top: 5px
    div
      display: inline-block
      margin-left: 10px

  .panel-back
    padding-top: 20px

  @keyframes cardChange
    from
      transformX: 100%
    to
      transform: 0
</style>
