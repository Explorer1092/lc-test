/*
*本组件非常重要，涉及进教室，如有修改，务必全部回归测试，code review！
*/
<template lang="jade">
  .cards
    .card-light(:class="ui.cardBgLight")
    .card
      .card-top(:class="ui.cardBg")
        slide-text.lesson(:text="config.lessonName")
        .date(v-if="[0,1,2,3,4,5,11,12,13,14,15,16,17,18].indexOf(config.cardType)>-1")
          span.week {{weekTime()}}
          span.time {{dateTime()}}
        .lesson-name(v-if="[6,7,8,10,200].indexOf(config.cardType)>-1") {{config.name}}
        slide-text.course-type-name(v-if="[2,3,4,5,11,12,13,14,15,16,17,18].indexOf(config.cardType)>-1",:text="config.courseNameCn",:isAutoSlide="true")
        .hand(v-if="[0,3,11,12,13,14,15,16,17,18].indexOf(this.config.cardType)>-1",ref="hand")
          .h-black
          .h-line(ref="handLine",:style="{height:ui.cardHandTop+'px'}")
          .h-circle.icon-hand-circle(ref="cardHand",@click="handClick",@mouseenter="handHover",@mousedown="handPull($event)",:style="{top:ui.cardHandTop+'px'}")
      .card-content(:class="([3,11,12,13,14,15,16,17,18].indexOf(config.cardType)> -1)?'card-content-'+ui.currentPanelState+'-star':'card-content-'+ui.currentPanelState")
        //- 绘本
        reader-card(v-if="[13].indexOf(config.cardType) > -1 && [0].indexOf(config.courseCardStatus) > -1", :config="config", :currentPanelState="ui.currentPanelState")
        //- 主修课/冬令营/自然拼读课 -课前
        pre-course(v-if="[0,11,16].indexOf(config.cardType)>-1 && [0].indexOf(config.courseCardStatus)>-1", :config="config", :currentPanelState="ui.currentPanelState")
        //- 优美发音课/唱一唱/聊一聊 -课前课后
        after-course(v-if="[15,17,18].indexOf(config.cardType)>-1 && [0,2].indexOf(config.courseCardStatus)>-1", :config="config", :currentPanelState="ui.currentPanelState")
        //- 主修课 -上课
        star(v-if="[0].indexOf(config.cardType)>-1&&[1,3].indexOf(config.courseCardStatus)>-1",:config="config",:currentPanelState="ui.currentPanelState")
        //- 主修课/自然拼读课/冬令营课后KTV -课后作业
        work(v-if="[0,11,16].indexOf(config.cardType)>-1&&[2].indexOf(config.courseCardStatus)>-1",:config="config",:currentPanelState="ui.currentPanelState")
        //- 拓展视频
        extension(v-if="[1].indexOf(config.cardType)>-1",:config="config")
        //- 夏令营 小托福 公开课 其他课程等等 -上课状态 (otherCard的courseCardStatus有4)
        star(v-if="[2,3,4,5,11,12,13,14,15,16,17,18].indexOf(config.cardType)>-1&&[1,3,4].indexOf(config.courseCardStatus)>-1",:config="config",:currentPanelState="ui.currentPanelState")
        //- 夏令营小托福 课前作业状态和课后作业
        work(v-if="[3,14].indexOf(config.cardType)>-1&&[0,2].indexOf(config.courseCardStatus)>-1",:config="config",:currentPanelState="ui.currentPanelState")
        //- CT测试
        test(v-if="[6].indexOf(config.cardType)>-1",:config="config")
        //- 学生 教师指导 projectdemo
        video-card(v-if="[7,8,10].indexOf(config.cardType)>-1",:config="config")
        //- 提示卡片
        message(v-if="[9].indexOf(config.cardType)>-1",:config="config")
        //- 错误卡片
        error(v-if="[100].indexOf(config.cardType)>-1",:config="config")
        //- IT test卡片
        it-test(v-if="[200].indexOf(config.cardType)>-1", :config="config")
    img.pet-img(v-if="isShowPet", :src='petImgSrc')
</template>
<script>
  import readerCard from './reader_card.vue'
  import preCourse from "./pre_video.vue"
  import afterCourse from "./pre_video.vue"
  import star from "./star_card.vue"
  import work from "./work_card.vue"
  import test from "./test_card.vue"
  import videoCard from "./video_card.vue"
  import itTest from "./it_test_card.vue"
  import message from "./message_card.vue"
  import util from '../../../utils/_untils'
  import Velocity from 'velocity-animate'
  import extension from './extension_card.vue'
  import error from './error_card.vue'
  import slideText from '../../common/vk_slide_text.vue'
  import {CARD_TYPE} from '../../common/course/courseEnum'
  export default {
    data: function () {
      return {
        isShowPet: false,
        videoConfig: {
          videoSrc: "",
          autoPlay: true,
          materialId: "1",
          source: "",
          title: "指导视频",
          closeVideoFun: null
        },
        //课程参数定义的详情，请查看WIKI: http://wiki.vipkid.com.cn/pages/viewpage.action?pageId=33141779
        cardTypeEnum: CARD_TYPE,
        //对应接口参数 courseCardStatus
        majorStateEnum: {
          pre: 0,//预习状态
          on: 1,//上课状态
          onHomeWork: 2,//做作业状态
          after: 3,//课程已经完成
          onResult: 4//查看结果
        },
        //以12：00的课为例,对应接口参数lessonStatus
        lessonStatusEnum: {
          unBooked: 0,//未约
          booked: 1,//已约，未开始 11:30之前
          inClass: 2,//课程前30分钟至课程结束 11：30 -- 12：30
          outClass: 3,//已下课 12：30 -- 13：00
          classOver: 4,//课程结束后30分钟 13：00之后
          classReplay: 5//FINISHED & AS_SCHEDULED 课程状态变成FINISHED之后
        },
        ui: {
          $cardHand: null,
          cardBg: "pre-card",
          cardBgLight: "",
          currentPanelState: "face",
          cardHandTop: 30,
          lessonAnimationEnter: false,
          lessonAnimationOut: false,
          isHandAnimationing: false
        },
        data: {}
      }
    },
    /*
     config后端传过来的示例数据
     "courseType":"MAJOR",
     "courseCardStatus":2, //枚举CourseCardStatus 标识卡片应该处于哪个页面
     "afterHomeworkTotal":0, //课后作业总体数目
     "homeworkStatus":0, // 0为未做作业 1为已做作业
     "pptButton":2, //枚举HomePageStatusEnum
     "scheduledDateTime":1497859200000,
     "afterHomeworkButtonText":"做作业",
     "classroomButton":2, //枚举HomePageStatusEnum
     "finishType":"AS_SCHEDULED",
     "pptButtonText":"查看课件",
     "preHomeworkButtonText":"已预习",
     "lessonName":"Lesson 5 Who am I? 5",
     "cardType":0, //枚举CardType 标识卡片的类型
     "courseId":597816,
     "teacherAvatar":"https://teacher-media.vipkid.com.cn/teacher/avatar/2035617/avatar_large/image_20161222190718_a4510e63f4964b0bb7997aa39835059b.png",
     "lessonStatus":5,
     "lessonTopic":"Who am I?",
     "teacherName":"testtea 测试不要约课",
     "lessonId":842636,
     "classStatus":"FINISHED",
     "stars":0,
     "preHomeworkStatus":1, // 0为未预习 1为已预习
     "afterHomeworkRight":0,
     "afterHomeworkButton":2, //枚举HomePageStatusEnum
     "courseName":"Major Course 2016",
     "onlineClassId":17860740,
     "preHomewordImg":"https://image.vipkid.com.cn/preclass/MC-L1-U11-LC2-6.png", //预习的预览图片
     "preHomeworkButton":3, //枚举HomePageStatusEnum
     "classroomButtonText":"课程回放",
     "afterHomeworkImg":null //作业的图片 目前还没拿到资源后续补充
     * */
    props: {
      config: {
        type: Object,
        required: false,
        default: {}
      },
      petImgSrc: {
        type: String,
        required: false
      }
    },
    components: {
      preCourse, star, work, test, videoCard, message, extension, error, slideText, readerCard, afterCourse, itTest
    },
    computed: {},
    mounted () {
      this.ui.$cardHand = this.$refs.cardHand
      this.initTopBg()
    },
    methods: {
      initTopBg(){
        if ([0].indexOf(this.config.cardType) > -1) {
          if ([this.lessonStatusEnum.inClass].indexOf(this.config.lessonStatus) > -1) {
            this.ui.cardBgLight = "major-access-class-light"
            this.isShowPet = true
          }
        }
        if ([2, 3, 4, 5, 11, 12, 13, 14, 15, 16, 17, 18].indexOf(this.config.cardType) > -1) {
          this.ui.cardBg = "open-card"
          //进教室
          if ([this.lessonStatusEnum.inClass].indexOf(this.config.lessonStatus) > -1) {
            this.ui.cardBgLight = "open-access-class-light"
            this.isShowPet = true
          }
        }
        if (this.config.cardType == this.cardTypeEnum.kidVideo) {
          this.ui.cardBg = "kid-card"
        }
        if (this.config.cardType == this.cardTypeEnum.parentVideo) {
          this.ui.cardBg = "parent-card"
        }
        if ([9, 100].indexOf(this.config.cardType) > -1) {
          this.ui.cardBg = "message-card"
        }
        if ([200].indexOf(this.config.cardType) > -1) { // it test card
          this.ui.cardBg = "it-test-card"
        }
        if (this.config.cardType == this.cardTypeEnum['testCourse']) {
          this.ui.cardBg = "test-card"
        }
        if (this.config.cardType == this.cardTypeEnum.majorExtension) {
          this.config.lessonName = this.config.newCard.lessonName
          this.ui.cardBg = "extension-card"
        }
        if (this.config.cardType == this.cardTypeEnum.projectDemo) {
          this.config.lessonName = this.config.subTitle
          this.config.name = this.config.mainTitle
          this.ui.cardBg = "project-demo-card"
        }
      },
      weekTime(){
        return util.weekTime(this.config.scheduledDateTime)
      },
      dateTime(){
        return util.dateTime(this.config.scheduledDateTime)
      },
      handClick(){
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_hand_pull'
        })
        if (!this.ui.isHandAnimationing) {
          this.ui.isHandAnimationing = true
          Velocity(this.ui.$cardHand, {top: "80px"}, {
            easing: "spring", mobileHA: false,
            duration: 500, complete: () => {
              if (this.ui.currentPanelState == "back") {
                this.ui.currentPanelState = "face"
              } else {
                this.ui.currentPanelState = "back"
              }
              this.$emit("handToBack")
              Velocity(this.ui.$cardHand, {top: "30px"}, {
                duration: 500, mobileHA: false,
                complete: () => {
                  this.ui.isHandAnimationing = false
                }
              })
            }
          })
          Velocity(this.$refs.handLine, {height: "80px"}, {
            easing: "spring",
            duration: 500, complete: () => {
              Velocity(this.$refs.handLine, {height: "30px"}, {
                duration: 500, mobileHA: false
              })
            }
          })
        }
        this.$playSound("click")
      },
      handPull(e) {
        window.event.returnValue = false
        e.preventDefault()
        e.stopPropagation()
        var y = e.clientY
        var hy = this.ui.cardHandTop
        this.ui.$cardHand.onmousemove = (ec) => {
          var cy = ec.clientY - y
          this.ui.cardHandTop = hy + cy
          if (this.ui.cardHandTop > 30 || this.ui.cardHandTop == 30) {
            if (this.ui.cardHandTop > 80) {
              this.ui.cardHandTop = 30
              this.ui.$cardHand.onmousemove = null
              this.$emit("handToBack")
              this.$playSound("click")
              sa.track('learning_click', {
                'click_id': 'pc_learning_homepage_hand_pull'
              })
              if (this.ui.currentPanelState == "back") {
                this.ui.currentPanelState = "face"
              } else {
                this.ui.currentPanelState = "back"
              }
            }
          } else {
            this.ui.cardHandTop = 30
            this.ui.$cardHand.onmousemove = null
          }
        }
        window.onmouseup = () => {
          this.ui.$cardHand.onmousemove = null
        }
      },
      handHover(){
        if (this.$refs.hand.style.animation == "none" || this.$refs.hand.style.animation == "") {
          this.$refs.hand.style.animation = "swing 1.5s"
          setTimeout(() => {
            this.$refs.hand.style.animation = "none"
          }, 1500)
        }
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .cards
    position: relative
    display: inline-block
    width: 100%
    height: 460px
    &:hover
      -webkit-animation-play-state: paused

  .pet-img
    width: 80px
    position: absolute
    bottom: 66px
    left: 231px
    z-index: 2
    animation: petMove 2s ease-in-out infinite
    animation-direction: alternate

  .card
    position: absolute
    z-index: 2
    width: 300px
    vertical-align: top

  .course-type-name
    position: absolute
    right: 20px
    top: 37px
    width: 100px !important
    text-align: center

  .lesson-name
    height: 30px
    line-height: 30px
    margin-top: 10px
    margin-left: 30px

  .card-top
    position: absolute
    width: 300px
    height: 175px
    top: 0
    .lesson
      width: 230px
      height: 35px
      text-align: left
      line-height: 35px
      font-size: 18px
      font-weight: 500
      margin-top: 62px
      margin-left: 20px
      border-radius: 20px
      padding-left: 10px
    .date
      margin-top: 7px
      margin-left: 32px
      line-height: 30px
      .week
        font-size: 18px
        font-weight: 500
      .time
        font-size: 14px
        margin-left: 5px

  .card-content
    height: 330px
    border-radius: 0 0 35px 35px
    margin-top: 130px
    overflow: hidden
    transition: background-color 0.5s

  /*transition: background-color 1s*/

  .card-content-back
    background-color: #6ad3c6

  .card-content-back-star
    background-color: #7fd16f

  .card-content-face
    background-color: #FFFFFF

  .card-content-face-star
    background-color: #FFFFFF

  .pre-card
    background: url("../../../img/icon/icon_card.png") -330px -217px

  .test-card
    background: url("../../../img/icon/icon_card.png") -330px -10px

  .open-card
    background: url("../../../img/icon/icon_card.png") -10px -217px

  .kid-card
    background: url("../../../img/icon/icon_card.png") -10px -411px

  .parent-card
    background: url("../../../img/icon/icon_card.png") -10px -10px

  .project-demo-card
    background: url("../../../img/icon/icon_card.png") -650px -590px

  .message-card
    background: url("../../../img/index/card_bg_msg.png") top

  .it-test-card
    background: url("../../../img/index/card_head_it_test.png") 0px 36px  no-repeat

  .major-access-class-light
    position: absolute
    z-index: 1
    height: 490px
    background: url("../../../img/index/major_card_light.png") center no-repeat
    background-size: 95% 96%
    animation: cardFade 1s infinite alternate
    width: 360px
    left: -30px

  .open-access-class-light
    position: absolute
    z-index: 1
    height: 490px
    background: url("../../../img/index/open_card_light.png") center no-repeat
    background-size: 95% 98%
    animation: cardFade 1s infinite alternate
    width: 360px
    left: -30px

  .extension-card
    height: 130px
    padding-top: 5px
    background: url("../../../img/icon/icon_card.png") -330px -410px

  .hand
    position: absolute
    width: 44px
    top: 115px
    right: 15px
    text-align: center
    z-index: 100
    .h-black
      height: 8px
      width: 8px
      margin: auto
      background-color: #421f66
      border-radius: 50%
      opacity: 0.6

    .h-line
      position: absolute
      width: 2px
      height: 100px
      margin: -4px 21px
      border-radius: 12px
      background-color: #FFFFFF
      box-shadow: 1px 1px 0 0 rgba(0, 0, 0, 0.3)
    .h-circle
      position: absolute
      height: 46px
      width: 44px
      z-index: 100
      cursor: pointer

  @keyframes cardFade
    from
      transform: scale(1.03, 1.03)
      opacity 1
    to
      opacity 0.5
      transform: scale(1, 1)

  @keyframes cardHover
    from
      transform: scale(1, 1)
    to
      transform: scale(1.1, 1.1)

  @keyframes petMove
    100%
      transform: translateY(20px)
</style>