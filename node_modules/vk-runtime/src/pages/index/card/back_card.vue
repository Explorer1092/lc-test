<template lang="jade">
  .panel-back
    .circle.circle-1
    .circle.circle-2
    .circle.circle-3
    .btns
      template(v-for="(pbButton,index) in pbButtons")
        vk-btn.animated.fadeInDown.pb-btn(v-if="pbButton.link!='0'",v-show="isBtnShow",:type="'white-line-'+pbButton.state",:key="pbButton",:text="pbButton.name",:link="pbButton.link",
        :isNewTab="pbButton.isNew",:clickId="pbButton.clickId",:style="'animation-delay:'+(index*100)/1000+'s'",:clickFun="buttonClick(pbButton.link,pbButton.clickId)")
        vk-btn.animated.fadeInDown.pb-btn(v-if="pbButton.link=='0'",v-show="isBtnShow",:type="'white-line-'+pbButton.state",:style="'animation-delay:'+(index*100)/1000+'s'",:text="pbButton.name",:link="pbButton.link",
        :isNewTab="pbButton.isNew",:clickId="pbButton.clickId", :clickFun="dragonButtonClick")
</template>
<script>
  import vkBtn from "../../common/vk_button.vue"
  import cookies from "cookies-js"
  import dragonUtils from '../../../utils/_dragon.js'
  import Vue from "vue"
  import axios from 'axios'
  import channelUtils from "../../common/course/classroomChannel.js"
  export default {
    data: function () {
      return {
        //        HIDE(0,"不显示"),
        //        LOCK(1,"不可用"),
        //        UNLOCK(2, "可用"),
        //        FINISH_UNLOCK(3, "完成并继续可用"),
        //        FINISH_LOCK(4, "完成但不可用");
        backButtonState: ['hide', 'disable', 'enable', 'enable', 'disable'],
        pbButtons: [],
        isBtnShow: false
      }
    },
    components: {
      vkBtn
    },
    props: ['config'],
    computed: {},
    mounted () {
      this.initBackButton()
      setTimeout(() => {
        this.isBtnShow = true
      }, 300)
    },
    methods: {
      buttonClick(link, clickId) {
        return async () => {
          if (clickId == "homepage_btn_pre_back" || clickId == "homepage_btn_homework_back") {
            this.$getWorkUrl(this.config, this, clickId == "homepage_btn_pre_back" ? 'PRE' : 'AFTER', 'homepage_btn_homework_back')
          } else {
            if ([2, 3].indexOf(this.config.lessonStatus) > -1 && [4, 13].indexOf(this.config.cardType) === -1 && clickId == "homepage_btn_enter_classroom_back") {
              let tempWindow = window.open('_blank')
              let channelUrl = await channelUtils.getChannel(this.config.onlineClassId)
              sa.track('learning_click', {
                'click_id': 'pc_learning_wop_enter_classroom',
                'service_url': channelUrl,
                'online_class_id': this.config.onlineClassId,
                'book_type': this.config.bookType
              })
              tempWindow.location.href = channelUrl
              return
            }
            sa.track('learning_click', {
              'click_id': clickId,
              'online_class_id': this.config.onlineClassId,
              'book_type': this.config.bookType
            })
            setTimeout(() => {
              //进教室跳转到新页面
              if (clickId == "homepage_btn_enter_classroom_back") {
                window.open(link)
              } else {
                this.$router.push(link)
              }
            }, 200)
          }
        }
      },
      //调取小恐龙进教室native组件
      async dragonButtonClick() {
        //查看报告
        if ([12].indexOf(this.config.cardType) > -1) {
          sa.track('learning_click', {
            'click_id': 'pc_learning_homepage_card_back_see_report',
            'online_class_id': this.config.onlineClassId
          })
          axios.get('/rest/learninggw/api/pc/homepage/getStudentTrailResult', {
            params: {
              studentId: cookies.get("studentId"),
              onlineClassId: this.config.onlineClassId
            }
          }).then((res) => {
            if (res.data.data && res.data.data.hasTrialResult) {
              this.$router.push("/test_result/0/" + this.config.onlineClassId)
            } else {
              this.$showToast("英语等级报告正在生成中，请稍后查看~")
            }
          }).catch((err) => {
            this.$showToast("英语等级报告正在生成中，请稍后查看~")
          })
          return
        }
        if ([4, 13].indexOf(this.config.cardType) === -1 && [2, 3].indexOf(this.config.lessonStatus) > -1) {
          let channelUrl = await channelUtils.getChannel(this.config.onlineClassId)
          sa.track('learning_click', {
            'click_id': 'pc_learning_wop_enter_classroom',
            'service_url': channelUrl,
            'online_class_id': this.config.onlineClassId,
            'book_type': this.config.bookType
          })
          window.location.href = channelUrl
          return
        }
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_pcapp_enter_classroom_on_back',
          'online_class_id': this.config.onlineClassId,
          'book_type': this.config.bookType
        })
        dragonUtils.goToClassRoomInDragon(this.config.onlineClassId)
      },
      initBackButton() {
        //校验curriculumVersion
        if (!this.config.curriculumVersion || this.config.curriculumVersion == '' || this.config.curriculumVersion == 'undefined' || this.config.curriculumVersion == 'null') {
          this.config.curriculumVersion = 1
        }
        this.pbButtons = [{
          name: this.config.preHomeworkButtonText,
          state: this.backButtonState[this.config.preHomeworkButton],
          link: "/video/pre/" + this.config.lessonId + "/2" + "/" + this.config.curriculumVersion,
          isNew: false,
          clickId: "homepage_btn_pre_back",
          isShowThisButton: true
        }, {
          name: this.config.pptButtonText,
          state: this.backButtonState[this.config.pptButton],
          link: "/courseware/" + this.config.onlineClassId + "/" + this.config.lessonNumber + "/" + this.config.lessonId,
          isNew: false,
          clickId: "homepage_btn_ppt_back",
          isShowThisButton: true
        }, {
          name: this.config.classroomButtonText,
          state: this.backButtonState[this.config.classroomButton],
          link: "#",
          isNew: false,
          clickId: "homepage_btn_enter_classroom_back",
          isShowThisButton: true
        }, {
          name: this.config.afterHomeworkButtonText,
          state: this.backButtonState[this.config.afterHomeworkButton],
          link: '/homework/' + cookies.get("studentId") + '/' + this.config.lessonId + '/2?curriculumVersion=' + this.config.curriculumVersion,
          isNew: false,
          clickId: "homepage_btn_homework_back",
          isShowThisButton: true
        }]

        //进教室
        if ([2, 3].indexOf(this.config.lessonStatus) > -1) {
          if (dragonUtils.isOnDragonClient()) {
            this.pbButtons[2].link = "0"
            this.pbButtons[2].isNew = false
            Vue.set(this.pbButtons, 2, this.pbButtons[2])
          } else {
            this.pbButtons[2].link = '/router/learning/classroom/major?onlineClassId=' + this.config.onlineClassId
          }
        }
        //课程回放
        if ([5].indexOf(this.config.lessonStatus) > -1) {
          this.pbButtons[2].link = '/router/learning/replay/major?onlineClassId=' + this.config.onlineClassId
        }
        //公开课 课程回放
        if ([4, 13].indexOf(this.config.cardType) > -1) {
          if ([5].indexOf(this.config.lessonStatus) > -1) {
            this.pbButtons[2].link = "/router/www/openclass/student/playback?onlineClassId=" + this.config.onlineClassId
          }
        }

        //新版trail课 只有上课 + 查看报告
        if ([12].indexOf(this.config.cardType) > -1) {
          this.pbButtons = [this.pbButtons[2], {
            name: this.config.trialResultText,
            state: this.backButtonState[this.config.trialResultButton],
            link: 0,
            isNew: false,
            clickId: "homepage_btn_see_report"
          }]
        }
        //绘本公开课
        if ([13].indexOf(this.config.cardType) > -1) {
          this.pbButtons[2].link = `/router/www/openclass/student/onlineclass?onlineClassId=${this.config.onlineClassId}`
          this.pbButtons = [{
            name: this.config.bookButtonText,
            state: this.backButtonState[this.config.bookButton],
            link: `/dgl/digitalLibrary/detail/${this.config.bookId}/${this.config.bookCode}`,
            isNew: false,
            clickId: "homepage_btn_see_report"
          }, this.pbButtons[2]]
        }
      }
    }
  }
</script>

<style lang="stylus" scoped>

  .pb-btn
    margin: 20px auto

  .panel-back
    position: relative
    padding-top: 10px
    text-align: center
    height: 280px

  .btns
    position: relative
    margin: 20px auto
    z-index: 2

  .circle
    position: absolute
    border-radius: 50%
    background-color: rgba(0, 0, 0, 0.05)

  .circle-1
    z-index: 1
    left: -10px
    top: 50px
    height: 100px
    width: 100px

  .circle-2
    z-index: 2
    left: 250px
    top: 50px
    height: 50px
    width: 50px

  .circle-3
    z-index: 3
    left: 230px
    top: 200px
    height: 80px
    width: 80px


</style>
