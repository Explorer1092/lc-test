<template lang="jade">
  .learning-home(:class="isNoScroll?'learning-home-no-scroll':''",@mousewheel="userScrollDown($event)",
  @DOMMouseScroll="userScrollDown($event)",@scroll="conScroll")
    //老版本的PC APP弹出更新提示
    .update-tip.animated.zoomIn(@click.stop="isShowUpdate=false",v-if="isShowUpdate")
      p 亲爱的宝贝，有新版本哦
      p 快到VIPKID.com.cn官网下载安装吧～
    //背景
    index-bg.learning-bg
    //宠物系统入口
    .pet-enter-wrapper(:class="{'et-enter-wrapper-app': isShowSetting}")
      pet-enter(:isHome="isHome", :isInApp="isShowSetting")
    //激励系统入口
    impel-enter(:listForEnglish="list21Activity")
    //设置按钮 app专用
    .setting-btn.icon-setting(v-if="isShowSetting",@click.stop="showSetting")
    //重新加载按钮 app专用
    .reload-btn.icon-reload(v-if="isShowSetting",@click.stop="reload")
    //左右按钮
    .lb-btn-left(v-show="isBtnLeftShow",@click.stop="leftBtnClick")
      .icon-arrow-left
    .lb-btn-right(v-show="isBtnRightShow",@click.stop="rightBtnClick")
      .icon-arrow-right
    //引导页
    guide(v-show="isShowGuidePage",v-on:guideClose="guideCloseFun")
    //指导视频调取
    simple-video.sm-video(v-if="isShowVideo",:videoConfig="videoConfig")
    //有新的拓展卡解锁了
    .uncard(v-if="newCardIsShow",@click.stop="newCardIsShow=false")
      unlock-card(:unlockCard="newCard")
    //头部
    i-header(:userInfo="userInfo",@21-century-acitivity="check21CenturyActivity")
    //中部卡片
    iBody.learning-body(:configCards="cards",:isErrorCardShowConfig="isErrorCardShow", :petImgSrc="giftConfig.petImgSrc")
    //飞船动画
    giftAnimate(:imgConfig="giftConfig",v-if="isShowGiftAnimate")
    //用户协议
    userAgreement
</template>
<script>
  import Vue from 'vue'
  import axios from 'axios'
  import utils from '../../utils/_untils'
  import dragon from '../../utils/_dragon'
  import cookies from 'cookies-js'
  import iHeader from './components/header.vue'
  import iBody from './components/index_body.vue'
  import card from './card/cards.vue'
  import message from './card/message_card.vue'
  import simpleVideo from '../video/simple_video.vue'
  import indexBg from './components/index_bg.vue'
  import guide from './components/guide.vue'
  import unlockCard from './components/unlock_card.vue'
  import userAgreement from '../common/user_agreement.vue'
  import guideModel from './components/guide_model.vue'
  import giftAnimate from './components/gift_animate.vue'
  import impelEnter from './components/impel_enter.vue'
  import petEnter from './components/dino.vue'
  import Velocity from 'velocity-animate'
  import vkLoading from '../common/plugins/Loading'
  import vkToast from '../common/plugins/Toast'
  import model from '../common/plugins/Model'
  import {CARD_TYPE} from '../common/course/courseEnum'
  import WorkEntrance from '../common/plugins/WorkEntrance'
  Vue.use(WorkEntrance)
  Vue.use(model)
  Vue.use(vkLoading)
  Vue.use(vkToast)
  export default {
    data: function () {
      return {
        isShowGiftAnimate: false,
        isBtnRightShow: false,
        isBtnLeftShow: false,
        isErrorCardShow: false,
        isHaveConfirmOrderFlag: false,//是否有七天后未确认的订单
        isHaveOneImpel: false,
        //卡的唯一标示
        cardId: 0,
        //新解锁卡
        newCard: {},
        newCardIsShow: false,
        isShowVideo: false,
        videoConfig: {},
        cardShow: false,
        cardChange: 0,
        userInfo: {},
        cards: [],
        //按照不同课程 类型分类
        cardTypes: {},
        isNoScroll: false,
        accessClassRoomCardMove: 0,
        currentScrollLeft: 0,
        isOrderAnimated: false,
        intervals: [],
        timeouts: [],
        isShowCards: false,
        isShowImpel: false,
        isShowGuidePage: false,
        impelRelatedId: "",
        headerIsShowEgg: false,
        isShowUpdate: false,
        giftConfig: {
          aircraftImgSrc: '',
          petImgSrc: '',
          aircraftImgDirection: '',
          isShowPet: true
        },
        list21Activity: [],
        isHome: true
      }
    },
    components: {
      card,
      iHeader,
      message,
      simpleVideo,
      indexBg,
      guide,
      unlockCard,
      iBody,
      giftAnimate,
      userAgreement,
      impelEnter,
      petEnter
    },
    computed: {
      isShowSetting: function () {
        //如果是小恐龙显示设置
        return dragon.isOnDragonClient()
      }
    },
    created(){
      let interfaces = [
        'getMajorCard',
        'getSummerCard',
        'getSummerSimpleCard',
        'getOtherCard',
        'getInfoCard',
        'getOpenCard',
        'getTaskCard',
        'getMaterialCard',
        'getCTCard',
        'getVideoCard']
      //cardType 存储器
      for (let cardType of interfaces) {
        this.cardTypes[cardType] = []
      }
    },
    mounted() {
      //强制10秒显示错误卡
      this.timeouts.push(setTimeout(() => {
        if (this.cards.length == 0) {
          this.isErrorCardShow = true
        }
      }, 20000))
      this.isShowUpdateFun()
      this.initCard()
      this.initCardUI()
    },
    //返回首页
    activated(){
      this.$el.style.opacity = 0.3
      this.getAircraftPetImg() //获取宠物 飞船图片
      //刷新用户信息宝石
      this.userInfoData()
      this.timeouts.push(setTimeout(() => {
        this.$el.style.opacity = 1
        this.refresh()
        this.$el.scrollLeft = this.currentScrollLeft
      }, 300))
      //监听 任务卡片 upDateTaskCard
      eventBus.$on('upDateTaskCard', () => {
        this.updateTaskCard()
      })
      //更新用户信息
      eventBus.$on('getRewardUpdateUserInfo', () => {
        this.userInfoData()
      })
    },
    //离开首页
    deactivated(){
      this.leaveBefore()
    },
    watch: {
      //实时排序
      cardChange: function (n, o) {
        let tempCard = []
        for (let card of Object.values(this.cardTypes)) {
          for (let cardItem of card) {
            tempCard.push(cardItem)
          }
        }
        //排序
        tempCard = tempCard.sort(this.sortNumber)
        //卡片位置绝对定位
        let leftPx = 0
        for (let i = 0; i < tempCard.length; i++) {
          tempCard[i].left = leftPx
          if (tempCard[i].cardType == 101) {
            leftPx += 540
          } else {
            leftPx += 360
          }
        }
        this.cards = tempCard
        //右侧滑动按钮
        if (this.cards.length > 0 && this.cards[this.cards.length - 1].left - document.body.clientWidth > 0) {
          this.isBtnRightShow = true
        }
        //复位
        this.restPosition()
      },
      //定位进教室
      accessClassRoomCardMove: function (n, o) {
        Velocity(this.$el, "scroll", {
          axis: "x",
          container: this.$el,
          delay: 1000,
          duration: 1000, offset: n + "px", mobileHA: false,
          complete: () => {
          }
        })
      }
    },
    beforeDestroy: function () {
      this.leaveBefore()
    },
    methods: {
      //PC app的window 2.0.0版本显示更新提示
      isShowUpdateFun () {
        if (dragon.isOnDragonClient()) {
          var dragonClientUA = navigator.userAgent.match(/vipkid\/\d+(\.\d+)*/i)
          var version = (dragonClientUA[0].split("\/"))[1]
          var isWindow = navigator.userAgent.indexOf("Windows") > -1
          if (version == "2.0.0" && isWindow) {
            sa.track('learning_click', {
              'click_id': 'pc_learning_homepage_show_update_tip'
            })
            this.isShowUpdate = true
          }
        }
        this.isShowUpdate = false
      },
      //显示首页的展示的飞船宠物
      getAircraftPetImg() {
        this.isShowGiftAnimate = false
        axios.get('/rest/learninggw/api/pc/service/studentstar/getCurrentAirCraftAndPetByStudentId', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.data.currentAirCraftSrc != "" || res.data.data.currentPetSrc != "") {
            this.isShowGiftAnimate = true
            this.giftConfig.aircraftImgSrc = res.data.data.currentAirCraftSrc
            this.giftConfig.petImgSrc = res.data.data.currentPetSrc
            this.giftConfig.aircraftImgDirection = res.data.data.aircraftDirection
          }
        })
      },

      //初始化定位卡片
      initCardUI(){
        this.timeouts.push(setTimeout(() => {
          this.isShowCards = true
          this.restPosition()
        }, 1000))
      },

      //复位
      restPosition(){
        this.$nextTick(() => {
          var cardNum = this.initPositionAccessClassRoom()
          if (this.cards.length > 0 && this.cards[cardNum].left > window.innerWidth / 2) {
            this.accessClassRoomCardMove = this.cards[cardNum].left - window.innerWidth / 2 + 180
          } else {
            this.accessClassRoomCardMove = 0
          }
        })
      },

      //初始化除定时刷新以外的卡片
      initCard() {
        axios.all([
          this.cardData('getMaterialCard'),
          this.cardData('getCTCard'),
          this.cardData('getVideoCard'),
          this.getProjectDemoEntryGreyState()])
          .then(axios.spread((acct, perms) => {
          }))
      },
      // 定时刷新
      refresh(){
        var cardTypes = [
          'getMajorCard',
          'getTaskCard',
          'getSummerCard',
          'getSummerSimpleCard',
          'getOtherCard',
          'getInfoCard',
          'getOpenCard']
        for (var i = 0; i < cardTypes.length; i++) {
          let cardType = cardTypes[i]
          this.timeouts.push(
            setTimeout(() => {
              this.cardData(cardType)
              this.intervals.push(setInterval(() => {
                this.cardData(cardType)
              }, 50000))
            }, 1000 * (i + 1)))
        }
      },
      //定位需要可以进教室和可预习的卡片
      initPositionAccessClassRoom(){
        for (var i = 0; i < this.cards.length; i++) {
          if ([101].indexOf(this.cards[i].cardType) > -1 && this.cards[i].bottomButton && this.cards[i].bottomButton.buttonText == "进教室") {
            return i
          } else if (this.cards[i].classroomButtonText == "进教室" || ([0, 2, 3, 4, 5].indexOf(this.cards[i].cardType) > -1 && this.cards[i].courseCardStatus == 0 && this.cards[i].preHomeworkButtonText == "预习")) {
            if (this.cards[i].classroomButtonText == "进教室") {
              this.giftConfig.isShowPet = false
            }
            return i
          }
        }
        return 0
      },
      //引导页关闭
      guideCloseFun(isOut){
        this.isShowGuidePage = false
        this.isNoScroll = false
        Velocity(this.$el, "scroll", {
          axis: "x",
          container: this.$el, duration: 500, offset: this.accessClassRoomCardMove
        })
        if (!isOut) {
          //modified by luomingzhong
          //this.autoShowImpel()
        }
      },
      //显示引导页弹出窗
      isForceShowGuide(){
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_show_guide'
        })
        this.$playSound("click")
        this.$modelShow({model: guideModel, isShowImpelGuide: this.isShowImpel})
      },
      //是否显示宝箱引导页
      isShowGuide(){
        return axios.get('/rest/learninggw/api/pc/homepage/showWelcome', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data.show) {
              this.timeouts.push(setTimeout(() => {
                this.isShowGuidePage = true
                this.isNoScroll = true
              }, 2000))
              return
            }
          }
        }
        )
      },
      //用户信息
      userInfoData(){
        return axios.get('/rest/learninggw/api/pc/homepage/getStudentInfo', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            this.userInfo = res.data.data
            this.userInfo.isShow = true
            utils.setCookie("userName", res.data.data.studentName)
          }
        }
        )
      },
      //卡片数据
      cardData(type){
        let params
        if (type === 'getInfoCard') {
          //for it test
          params = {
            studentId: cookies.get("studentId"),
            source: dragon.isOnDragonClient() ? 2 : 1,
            deviceNum: dragon.isOnDragonClient() ? navigator.userAgent.match(/vipkid\/\d(\.\d)+/i)[0] + '/' + cookies.get("studentId") : cookies.get("deviceNum")
          }
        } else {
          params = {
            studentId: cookies.get("studentId")
          }
        }

        if (type === 'getTaskCard') {
          return axios.get('/rest/learninggw/api/pc/path/' + type, {params}).then((res) => {
            if (res.data.code == 200) {
              let resDatas = []
              if (res.data.data && res.data.data.taskCardItems.length > 0) {
                res.data.data.taskCardItems.map((item) => {
                  item.hadReward = false
                  item.rewardCount = 0
                  item.scaleButton = false
                })
                resDatas = [res.data.data]
              }
              this.cardGenerator(resDatas, type)
            }
          }
          ).catch(function (error) {
          })
        }

        return axios.get('/rest/learninggw/api/pc/homepage/' + type, {params}).then((res) => {
          if (res.data.code == 200) {
            let resDatas = res.data.data
            this.cardGenerator(resDatas, type)
          }
        }
        ).catch(function (error) {
        })
      },
      //卡片解析
      cardGenerator(resDatas, type){
        if (resDatas && resDatas.length != 0) {
          this.cardTypes[type] = resDatas
          //TODO 拓展触发解锁新卡片 有老卡就解锁新卡
          if (type == "getMaterialCard" && resDatas[0].oldCard) {
            this.newCard = resDatas[0]
            this.newCardIsShow = true
            this.timeouts.push(setTimeout(() => {
              this.newCardIsShow = false
            }, 5000))
          }
        } else {
          this.cardTypes[type] = []
        }
        this.cardChange++
      },
      //卡片按时间排序 如果时间相同 则按照cardType排序
      sortNumber(a, b) {
        if (a.scheduledDateTime - b.scheduledDateTime > 0) {
          return 1
        }
        if (a.scheduledDateTime - b.scheduledDateTime < 0) {
          return -1
        }
        if (a.scheduledDateTime - b.scheduledDateTime == 0) {
          if (a.cardType - b.cardType < 0) {
            return -1
          }
          if (a.cardType - b.cardType > 0) {
            return 1
          }
          if (a.cardType - b.cardType == 0) {
            return 0
          }
        }
      },
      //滑动控制
      userScrollDown(e) {
        this.$el.scrollLeft += e.deltaY || e.detail * 5
      },
      conScroll(){
        this.currentScrollLeft = this.$el.scrollLeft
        if (this.$el.scrollLeft == 0) {
          this.isBtnLeftShow = false
        } else {
          this.isBtnLeftShow = true
        }
        if (this.$el.scrollLeft == this.$el.scrollWidth - window.innerWidth) {
          this.isBtnRightShow = false
        } else {
          this.isBtnRightShow = true
        }
      },
      //跟新任务卡片
      updateTaskCard(){
        this.cardData('getTaskCard')
      },
      getProjectDemoEntryGreyState() {
        axios.get('/rest/learninggw/api/pc/grey/getProjectDemoGrey', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data) {
              this.cardData('getMajorProjectDemoCard')
            }
          } else {
            this.cardData('getMajorProjectDemoCard')
          }
        })
      },
      checkImpelAccess(){
        //新用户来做引导
        this.isShowGuide()
        this.isShowImpel = true
      },
      rightBtnClick() {
        Velocity(this.$el, "scroll", {
          axis: "x",
          container: this.$el, duration: 500, offset: 500
        })
        this.$playSound("click")
      },
      leftBtnClick() {
        Velocity(this.$el, "scroll", {
          axis: "x",
          container: this.$el, duration: 500, offset: -500
        })
        this.$playSound("click")
      },
      leaveBefore() {
        //销毁所有setinterval clearTimeout
        for (var i = 0; i < this.timeouts.length; i++) {
          clearTimeout(this.timeouts[i])
        }
        for (var i = 0; i < this.intervals.length; i++) {
          clearInterval(this.intervals[i])
        }
      },
      showSetting(){
        this.$playSound("click")
        this.$router.push("/setting")
      },
      reload(){
        window.location.reload()
      },
      //检查
      check21CenturyActivity(list){
        this.list21Activity = list
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .learning-home
    height: 100%
    width: 100%
    background-repeat: repeat-x
    background-position: 0 0
    background-size: auto 100%
    animation: bgMove 100s infinite
    overflow-x: auto
    transition: opacity 0.3s

    .pet-enter-wrapper
      position: fixed
      right: 42px
      bottom: 12px
      z-index: 10

    .et-enter-wrapper-app
      right: 62px

  .learning-home-no-scroll
    overflow: visible
    .cards
      -webkit-animation-play-state: paused

  /*引导页*/
  .guide-light-btn, .setting-btn, .reload-btn
    position: fixed
    bottom: 28px
    right: 50px
    cursor: pointer
    z-index: 120
    transition: transform 0.3s
    &:hover
      transform: scale(1.2, 1.2)

  /*入口动画*/
  .reload-btn
    bottom: 80px
    right: 50px

  .lb-btn-left, .lb-btn-right
    position: fixed
    z-index: 100
    height: 120px
    width: 60px
    top: 50%
    cursor: pointer
    background-color: rgb(133, 97, 237)
    opacity: 0.3
    text-align: center
    .icon-arrow-right
      margin: 40px auto 0 25px
    .icon-arrow-left
      margin: 40px 25px 0 auto
    &:hover
      background-color: rgb(133, 97, 237)
      opacity: 0.85

  .lb-btn-left
    left: 0
    border-bottom-right-radius: 60px
    border-top-right-radius: 60px
    img
      margin-right: 20px

  .lb-btn-right
    right: 0
    border-bottom-left-radius: 60px
    border-top-left-radius: 60px
    img
      margin-left: 20px

  .learning-body
    position: relative
    z-index: 2
    height: 100%
    color: #FFFFFF

  .update-tip
    box-sizing: border-box
    position: fixed
    top: 77px
    left: 50%
    margin-left: -130px
    height: 94px
    width: 260px
    text-align: center
    background: url("../../img/index/bg_version_update.png") no-repeat
    background-size: 100% 100%
    color: #FFFFFF
    font-size: 14px
    z-index: 120
    padding: 40px 0
    cursor: pointer
    transition: all 0.5s
    &:hover
      transform: scale(1.1, 1.1)

</style>
