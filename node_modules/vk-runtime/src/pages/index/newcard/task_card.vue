<template>
	<div class="task-card">
    <div class="header">
      <div class="lesson-name">
      	{{ config.title }}
      </div>
    </div>
    <div class="task-box">
      <transition-group name="task-ani" tag="div" class="task-ani">
      	<div class="task" v-for="(task , index) in this.config.taskCardItems" :key="task.taskSign">
      		<div>
	        	<slide-text class="task-title" :text="task.taskTitle"></slide-text>
	        	<slide-text class="task-dec" :text="task.taskDesc"></slide-text>
	        	<p class="task-reward">
							<i :class="task.taskRewardType=='EGGSHELL' ? 'eggshell' : 'egreeing-card'"></i>
	        		<span>{{task.taskRewardText}}</span>
	        	</p>
	        </div>
	        <div class="button-box">
	        	<vk-btn :type="buttonType(task)" :text="buttonText(task)" :clickFun="buttonClick(task)" :class="{scaleButton: task.scaleButton}"></vk-btn>
	        	<div class="progress" v-if="task.taskItemProgress.hasProgress">
	        		<p>{{task.taskItemProgress.progressFinished}}/{{task.taskItemProgress.progressTotal}}</p>
	        		<div class="progress-box">
	        			<div :style="{width:progressWidth(task)}"></div>
	        		</div>
	        	</div>
	        	<div class="rewardAniUp" :class="{fadeOut: task.hadReward}">
	        		<i :class="task.taskRewardType=='EGGSHELL' ? 'eggshell' : 'egreeing-card'"></i><span>+{{task.rewardCount}}</span>
	        	</div>
	        </div>
      	</div>
      </transition-group>
      <div class="more-task" v-if="tasks.length>2" @click="moreTask"></div>
    </div>
  </div>
</template>
<script>
	import axios from "../../../utils/_vkaxios"
	import slideText from '../../common/vk_slide_text.vue'
	import vkBtn from '../../common/vk_button.vue'
	import { SUPPER_SMALL_BUTTON_STYLE_MAP } from '../../common/course/courseEnum'
	import Course from "../../common/course/Course"
	import cookies from "cookies-js"
	export default {
	  data(){
	    return {
	      id:'',
	      tasks: this.config.taskCardItems
	    }
	  },
	  components:{
	    slideText,
	    vkBtn
	  },
	  props:{
	    config:{
	      type: Object
	    }
	  },
	  methods:{
	    buttonClick(task){
	      return ()=>{
	        if(task.taskItemButton.buttonFunction == 'SIGN_UP_TASK'){
	  				this.signUpTask(task)
	  				return
	        }else if(task.taskItemButton.buttonFunction == 'GET_REWARD'){
	          const url = '/rest/learninggw/api/point/activity/treasureBox/openByIdAndStudentId'
	          this.getReward(task,url)
	          return
	        }else if(task.taskItemButton.buttonFunction == 'GET_POINT_REWARD'){
	          const url = '/rest/learninggw/api/point/activity/appoint/treasureBox/openByActivityAppointTaskIdAndStudentId'
	          this.getReward(task,url)
	          return
	        }
	        Course.courseButtonClick({
	          type: task.taskItemButton.buttonFunction,
	          lessonNum: task.taskItemButton.lessonNumber,
	          clickId: task.taskItemButton.clickId + "_front",
	          buttonExtra: task.taskItemButton.buttonExtra
	        })
	      }
	    },
	    leftBtnEvent(){
	      this.$emit('dialogInfo',{
	        showDialog:false,
	        contentText:"",
	        leftBtnEvent:null,
	        rightBtnEvent:null
	      })
	    },
	    rightBtnEvent(){
	      this.$emit('dialogInfo',{
	        showDialog:false,
	        contentText:"",
	        leftBtnEvent:null,
	        rightBtnEvent:null
	      })
	      axios({
	        method: 'post',
	        url: '/rest/learninggw/api/point/activity/appoint/task/signUpTask',
	        data: `id=${this.id}&studentId=${cookies.get('studentId')}`,
	        headers: { 'content-type': 'application/x-www-form-urlencoded' }
	      }).then((res)=>{
	        if(res.data.code == 200){
	          eventBus.$emit('upDateTaskCard')
	        }else{
	          this.$showToast('报名失败请重试')
	        }
	      }).catch((err)=>{
	      	this.$showToast('报名失败请重试')
	      })
	    },
	    signUpTask(task){
	      this.id = task.taskItemButton.buttonExtra.activityId
	      this.$emit('dialogInfo',{
	        showDialog:true,
	        contentText:task.taskItemButton.buttonExtra.signUpDesc,
	        leftBtnEvent:this.leftBtnEvent,
	        rightBtnEvent:this.rightBtnEvent
	      })
	      sa.track('learning_click', {
	        'click_id': task.taskItemButton.clickId
	      })
	    },
	    getReward(task, url){
	      let parmas = 'id'
	      if(task.taskItemButton.buttonFunction == 'GET_POINT_REWARD'){
	        parmas = 'activityAppointTaskId'
	      }
	      const id = task.taskItemButton.buttonExtra.rewardId
	      const clickId = task.taskItemButton.clickId
	      axios({
	        method: 'post',
	        url: url,
	        data: `${parmas}=${id}&studentId=${cookies.get('studentId')}`,
	        headers: { 'content-type': 'application/x-www-form-urlencoded' }
	      }).then((res)=>{
	        if(res.data.code == 200){
	          
	          eventBus.$emit('getRewardUpdateUserInfo')

	          task.rewardCount = res.data.data
	          task.hadReward = true
	          task.scaleButton = true
	          setTimeout(()=>{
	          	eventBus.$emit('upDateTaskCard')
	          },300)
	        }else{
	        	this.$showToast('领取失败请重试')
	        }
	      }).catch((err)=>{
	      	this.$showToast('领取失败请重试')
	      })
	      sa.track('learning_click', {
		      'click_id': clickId
		    })	
	    },
	    moreTask(){
	    	this.$router.push({path:'/hot_activity'})

	    	sa.track('learning_click', {
		      'click_id': "pc_learning_task_card_more_task"
		    })
	    }
	  },
	  computed:{
	    buttonType(){
	      return (task)=>{
	        if(task && task.taskItemButton && task.taskItemButton.buttonStatus){
	          return SUPPER_SMALL_BUTTON_STYLE_MAP[task.taskItemButton.buttonStatus]
	        }else{
	          return SUPPER_SMALL_BUTTON_STYLE_MAP["GRAY"]
	        }
	      }
	    },
	    buttonText(){
	      return (task)=>{
	        if(task && task.taskItemButton && task.taskItemButton.buttonText){
	          return task.taskItemButton.buttonText
	        }
	      }
	    },
	    progressWidth(){
	      return (task)=>{
	        if(task.taskItemProgress.progressTotal == 0){
	          return 0
	        }
	        return task.taskItemProgress.progressFinished / task.taskItemProgress.progressTotal * 100 + '%'
	      }
	    }
	  }
	}
</script>
<style scoped>
	.task-card{
		width: 300px;
    	height: 460px;
		background-image:url(../../../img/task_card/home_missoncard_bg@2x.png);
		background-repeat: no-repeat;
		background-position:left bottom;
		background-size: contain;
	}
	.header{
		position: relative;
		height:128px;
	}
	.lesson-name{
		position: absolute;
		left:30px;
		top:78px;
		font-size:18px;
		font-weight:500;
		color:rgba(255,255,255,1);
		line-height:25px;
	}
	.task-box{
		position: relative;
		height: 332px;
		overflow: hidden;
	}
	.task{
		width: 282px;
		height: 90px;
		background: rgba(251,241,253,1);
		border-radius: 16px;
		margin: 10px auto;

		transition: all 1s ease;
	}
	.task>div:nth-child(1){
		float: left;
		margin:11px 0 0 10px;
	}
	.more-task{
		position: absolute;
		bottom:0;
		left:50%;
		width:110px;
		height:26px;
		transform: translate(-50%,0);
		background-image: url(../../../img/task_card/more_task@2x.png);
		background-repeat: no-repeat;
		background-size: contain;
		cursor: pointer;
	}
	.task-title{
		width:154px;
		height:28px;
		font-size:20px;
		font-weight:500;
		color:rgba(136,88,166,1);
		line-height:28px;
	}
	.task-dec{
		width:155px;
		height:20px;
		margin-top:3px;
		font-size:12px;
		font-weight:400;
		color:rgba(136,88,166,1);
		line-height:17px;
	}
	.task-reward{
		margin-top:3px;
		font-size:12px;
		font-weight:normal;
		color:rgba(82,176,178,1);
		line-height:14px;
	}
	.task-reward i{
		float: left;
		width:14px;
		height: 14px;
		
		background-size: contain;
		background-repeat:no-repeat;
	}
	.task-reward i.eggshell{
		background-image: url(../../../img/task_card/meteorite@2x.png);
	}
	.task-reward i.egreeing-card{
		background-image: url(../../../img/task_card/award_post_card_s.png);
	}
	.task-reward span {
		float: left;
		margin-left:4px;
	}
	.button-box{
		position: relative;
		float: right;
		margin: 11px 10px 0 0;
	}
	.scaleButton{
		animation: scaleButton .3s ease;
	}
	@keyframes scaleButton {
		0%{
			transform: scale(1);
		}
		50%{
			transform:  scale(0.5);
		}
		100%{
			transform: scale(1);
		}
	}
	.vk-button{
		position: relative;
		z-index: 2;
	}
	.progress{
		width:83px;
		height: 14px;
		margin:10px auto;
		font-size:12px;
		color:rgba(82,176,178,1);
		line-height:14px;
	}
	.progress-box{
		float: right;
		margin-top:5px;
		width:40px;
		height:4px;
		background:rgba(226,226,226,1);
		border-radius:3px;
	}
	.progress-box>div{
		width:0;
		height:4px;
		background:rgba(82,176,178,1);
		border-radius:3px;
	}
	.progress>p{
		float: right;
		margin-left:4px;
	}
	.rewardAniUp{
		position: absolute;
		top:6px;
		left:14px;
		font-size: 16px;
		font-weight: bold;
		color: #70C57E;
		z-index: 1;
		opacity: 1;
	}
	.rewardAniUp i{
		float: left;
		width: 26px;
		height: 26px;
		background-image: url(../../../img/rankings/energy_store@2x.png);
		background-size: contain;
		background-repeat:no-repeat;
	}
	.rewardAniUp i.eggshell{
		background-image: url(../../../img/rankings/energy_store@2x.png);
	}
	.rewardAniUp i.egreeing-card{
		background-image: url(../../../img/task_card/award_post_card_s.png);
	}
	.rewardAniUp span{
		float: left;
		line-height: 26px;
	}
	.task-ani{  
		height:300px;
		overflow: hidden;
	}
	.task-ani-enter,
  .task-ani-leave-to{ 
	  opacity: 0;
	  transform: translateX(282px);
	}
	.task-ani-leave-active {
	  position: absolute;
	}
	.fadeOut{
		animation: fadeOut .3s ease;
	}
	@keyframes  fadeOut{
		0%{
			top:6px;
			opacity: 1;
		}
		90%{
			opacity: 1;
		}
		100%{
			top:-26px;
			opacity: 0;
		}
	}
</style>