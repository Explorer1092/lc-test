<template lang="jade">
  .setting(@mousewheel="userScrollDown($event)",@DOMMouseScroll="userScrollDown($event)",@scroll="conScroll")
    vk-header(titleCn="设置",titleEn="Setting")
    //左右按钮
    .lb-btn-left(v-show="isBtnLeftShow",@click.stop="leftBtnClick")
      .icon-arrow-left
    .lb-btn-right(v-show="isBtnRightShow",@click.stop="rightBtnClick")
      .icon-arrow-right
    .child-body(:style="{width:(studentList.length*280+80)+'px'}")
      .top
      .child-content
        .child-item(v-for="(child,index) in studentList",:class="index==currentIndex?'child-item-active':''",@click.stop="clickItem(index)")
          .child-sign(v-if="index==currentIndex")
          .child-img
            img(src="../../../img/common/avatar/boy_1.png",v-if="!child.avatarUrl && (child.avatar == 'default'|| !child.avatar)")
            img(src="../../../img/common/avatar/boy_1.png",v-if="!child.avatarUrl && child.avatar=='boy_1'")
            img(src="../../../img/common/avatar/boy_2.png",v-if="!child.avatarUrl && child.avatar=='boy_2'")
            img(src="../../../img/common/avatar/boy_3.png",v-if="!child.avatarUrl && child.avatar=='boy_3'")
            img(src="../../../img/common/avatar/boy_4.png",v-if="!child.avatarUrl && child.avatar=='boy_4'")
            img(src="../../../img/common/avatar/girl_1.png",v-if="!child.avatarUrl && child.avatar=='girl_1'")
            img(src="../../../img/common/avatar/girl_2.png",v-if="!child.avatarUrl && child.avatar=='girl_2'")
            img(src="../../../img/common/avatar/girl_3.png",v-if="!child.avatarUrl && child.avatar=='girl_3'")
            img(src="../../../img/common/avatar/girl_4.png",v-if="!child.avatarUrl && child.avatar=='girl_4'")
            // 新增自定义头像
            img(:src="child.avatarUrl",v-if="child.avatarUrl")
          .child-name-en
            | {{child.englishName}}
          .child-name-cn
            | {{child.name}}
    .setting-bottom
      .it-test-btn(v-if="isShowItTestButton", @click="itTestClick") 客户端设备检测
      vk-button(v-if="isShowLogout", text="退出",type="lg-enable",:clickFun="logout")
      .copy-right
        | V {{version}}
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import vkHeader from '../../common/vk_header.vue'
  import vkButton from '../../common/vk_button.vue'
  import Velocity from 'velocity-animate'
  import dragonUtil from '../../../utils/_dragon'
  import utils from '../../../utils/_untils'
  export default {
    data: function () {
      return {
        currentIndex: 0,
        isShowLogout: false,
        studentList: [],
        isBtnRightShow: false,
        isBtnLeftShow: false,
        version: "1.0.0",
        itTestUrl: '#',
        isShowItTestButton: false
      }
    },
    components: {
      vkHeader, vkButton
    },
    computed: {},
    mounted () {
      this.initData()
      if (dragonUtil.isOnDragonClient()) {
        this.isShowLogout = true
        var dragonClientUA = navigator.userAgent.match(/vipkid\/\d+(\.\d+)*/i)
        this.version = (dragonClientUA[0].split("\/"))[1]
      }
    },
    methods: {
      itTestClick() {
        window.open(this.itTestUrl)
      },
      logout(){
        window.__bridge.logout() //小恐龙退出登录
      },
      clickItem(index){
        utils.setCookie("userId", this.studentList[index].id)
        utils.setCookie("studentId", this.studentList[index].id)
        //更新小恐龙的cookie
        if (dragonUtil.isOnDragonClient()) {
          window.__bridge.updateUserInfo('studentId', this.studentList[index].id).then(() => {
            window.location.href = "/"
          })
          window.__bridge.updateUserInfo('userId', this.studentList[index].id)
        } else {
          window.location.href = "/"
        }
      },
      initData(){
        axios.get('/rest/learninggw/api/pc/homepage/getPcAppSetting',{
          params: {
            studentId: cookies.get("studentId"),
            familyId: cookies.get("familyId"),
            source: dragonUtil.isOnDragonClient() ? 2 : 1,
            deviceNum: dragonUtil.isOnDragonClient() ? navigator.userAgent.match(/vipkid\/\d+(\.\d+)*/i)[0] + '/' + cookies.get("studentId") : cookies.get("deviceNum")
          }
        }).then((res) => {
          this.studentList = res.data.data.studentList
          this.itTestUrl = res.data.data.itTest.jumpUrl
          this.isShowItTestButton = res.data.data.itTest.isShow
          this.currentIndex = Math.ceil(this.studentList.length / 2) - 1
          for (var i = 0; i < this.studentList.length; i++) {
            if (this.studentList[i].id == cookies.get("studentId")) {
              var temp = this.studentList[i]
              this.studentList[i] = this.studentList[this.currentIndex]
              this.studentList[this.currentIndex] = temp
            }
          }
          this.$nextTick(() => {
            let sw = this.$el.scrollWidth / 2 - window.innerWidth / 2
            if (this.studentList.length % 2 == 0) {
              sw = sw + 100
            }
            this.$el.scrollLeft = 0
            Velocity(this.$el, "scroll", {
              axis: "x",
              container: this.$el,
              duration: 500,
              offset: sw + "px",
              delay: 500,
              mobileHA: false
            })
          })
        })
      },
      //滑动控制
      userScrollDown(e) {
        if (!this.forbiddenHorizontalScroll) {
          this.$el.scrollLeft += e.deltaY || e.detail * 5
        }
      },
      conScroll(){
        if (this.$el.scrollLeft == 0) {
          this.isBtnLeftShow = false
        } else {
          this.isBtnLeftShow = true
        }
        if (this.$el.scrollLeft == this.$el.scrollWidth - window.innerWidth) {
          this.isBtnRightShow = false
        } else {
          this.isBtnRightShow = true
        }
      },
      rightBtnClick(){
        Velocity(this.$el, "scroll", {
          axis: "x",
          container: this.$el, duration: 500, offset: 500
        })
        this.$playSound("click")
      },
      leftBtnClick(){
        Velocity(this.$el, "scroll", {
          axis: "x",
          container: this.$el, duration: 500, offset: -500
        })
        this.$playSound("click")
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .setting
    width: 100%
    height: 100%
    background: url("../../../img/index/bg/bg_star.png") no-repeat top
    overflow-x: scroll
    text-align: center

  .child-body
    height: 100%
    margin: auto

  .top
    height: 50%
    margin-bottom -100px

  .child-content
    color: #FFFFFF
    margin: auto
    height: 300px
    white-space: nowrap
    .child-item
      display: inline-block
      position: relative
      height: 200px
      width: 192px
      padding: 20px 0 0 0
      text-align: center
      border-radius: 20px
      background-color: #a18ee3
      margin-left: 40px
      margin-right: 40px
      cursor: pointer
      box-sizing: border-box
      transition: all 0.2s
      .child-sign
        position: absolute
        left: -2px
        top: -2px
        height: 60px
        width: 60px
        background: url("../../../img/index/child_sign.png") no-repeat
        background-size: 100% auto
      &:hover
        transform: scale(1.5, 1.5) translateY(-10%)
      .child-img
        height: 80px
        width: 80px
        border-radius: 50%
        overflow: hidden
        margin: auto
        box-shadow: 0 5px 0 0 rgba(0, 0, 0, 0.05)
        img
          width: 100%
      .child-name-en
        width: 100%
        height: 32px
        font-size: 22.4px
        margin-top: 12px
      .child-name-cn
        width 100%
        height 25px
        opacity 0.75
        font-size 17px
        margin-top: 5px
    .child-item-active
      transform: scale(1.5, 1.5) translateY(-10%)
      margin: auto 80px

  .setting-bottom
    position: absolute
    top: 50%
    margin-top: 180px
    width: 100%
    height: 100px
    cursor: pointer
    .copy-right
      height: 80px
      color: #FFFFFF
      line-height: 80px
    .it-test-btn
      width: 476px
      height: 52px
      margin: 0 auto
      border-radius: 99px
      border: 2px solid #A18EE3
      font-size: 24px
      color: #fff
      line-height: 52px
      padding-left: 20px
      margin-bottom: 60px
      text-align: left
      background-image: url(../../../img/common/little_arrow_right.png)
      background-repeat: no-repeat
      background-position: 463px 12px
      background-size: 14px

  .lb-btn-left, .lb-btn-right
    position: fixed
    z-index: 100
    height: 120px
    width: 60px
    top: 50%
    cursor: pointer
    background-color: rgb(133, 97, 237)
    opacity: 0.3
    text-align: center
    img
      height: 60px
      margin: 30px auto 0 auto
    &:hover
      background-color: rgb(133, 97, 237)
      opacity: 0.85

  .lb-btn-left
    left: 0
    border-bottom-right-radius: 60px
    border-top-right-radius: 60px
    .icon-arrow-left
      margin: 40px 10px

  .lb-btn-right
    right: 0
    border-bottom-left-radius: 60px
    border-top-left-radius: 60px
    .icon-arrow-right
      margin: 40px 25px

@media screen and (max-height: 720px)         
  .child-body
    margin-top: -80px
    .child-content
      margin-left: -80px
      transform: scale(0.8)
  .setting-bottom
    margin-top: 150px
    transform: scale(0.8)
    .it-test-btn
      margin-bottom: 10px
</style>
