<template lang="jade">
  .impel-btn(ref="impel_btn")
    .icon-impel-bg(v-if="isHaveNewImpel")
    .icon-impel-new-one-impel(v-if="isHaveNewImpel&&isHaveOneImpel")
    .impel-package(@click.stop="gotoHotActivity")
      .icon-circle(v-if="isHaveNewImpel")
      .icon-direction
      .icon-impel(v-bind:class="{'icon-impel-animation':isHaveNewImpel}")
    .impel-pd(v-if="hasPd",@click.stop="goPd($event)")
      .icon-light-3
      .icon-cup
      .star-big
      .star-small
      .bubble-1(v-if="pdFirst") 快来参加比赛～上传自己的作品，与众多小伙伴PK吧！
      .bubble-2(v-if="pdFirst",@click="iknow") 知道了
    .impel-english-speech(v-if="listForEnglish.length > 0")
      img(:src="listForEnglish[0].activityCategoryImage", @click="goCenturySpeech(listForEnglish[0].activityCategoryURL)")

</template>
<script>
  import axios from "axios"
  import cookies from "cookies-js"
  export default {
    data: function () {
      return {
        isHaveNewImpel: false, //是否有新宝箱
        isHaveOneImpel: false,
        hasPd: false,
        pdFirst: true
      }
    },
    props:{
      listForEnglish:{
        type:Array,
        defalult:()=>{
          return []
        }
      }
    },
    activated(){
      //刷新能量站入口状态
      this.hotActivityPageEntryStatus()
      this.showPd()
      this.getPdFirst()
    },
    deactivated: function () {
      this.isHaveNewImpel = false
      //恢复新任务提醒相关参数
      this.isHaveOneImpel = false
    },
    methods: {
      showPd(){
        axios.get('/rest/activity/api/activity/user/activity/entrance', {}).then((res) => {
          if (res.data.code === 0 && res.data.data) {
            this.hasPd = true
          }
        })
      },
      goPd(e){
        if (e.target.className == 'icon-cup') {
          sa.track('learning_click', {
            'click_id': 'pc_learning_homepage_enter_competition_arena'
          })
          this.$router.push("/competition_arena")
          if (this.pdFirst) {
            this.iknow()
          }
        }
      },
      iknow(){
        this.pdFirst = false
        axios.post('/rest/activity/api/activity/user/activity/setActivityStudentRulesRecordAgreePad', {}).then((res) => {
        })
      },
      getPdFirst(){
        axios.get('/rest/activity/api/activity/user/activity/getActivityStudentRulesRecordPad', {}).then((res) => {
          if (!res.data.data) {
            this.pdFirst = true
          } else {
            this.pdFirst = false
          }
        })
      },
      checkImpelsNumber(){
        axios.get('/rest/learninggw/api/pc/magic/treasureBox/getTreasureBoxEntranceStatusByStudentId', {
          params: {
            studentId: cookies.get('studentId')
          }
        }).then(res => {
          if (res.data.code == 200) {
            //如果有三个宝箱未打开
            if (res.data.data.atLeastThreeClose) {
              this.impelEntryAnimation()
            } else if (res.data.data.atLeastOneClose) {
              //如果一个到三个宝箱未打开
              this.isHaveOneImpel = true
              this.impelEntryAnimation()
            } else {
              this.impelEntryAnimation()
            }
          }
        }).catch(err => {
          this.impelEntryAnimation()
        })
      },
      // 能量站入口状态逻辑
      // 查询是否有需要提示的定向激励新任务
      hotActivityPageEntryStatus() {
        this.checkNewImpels()
      },
      //宝石入场动画
      impelEntryAnimation(){
        this.$nextTick(() => {
          Velocity(this.$refs.impel_btn, {
            opacity: 1,
            translateX: 110
          },
          {
            duration: 800,
            easing: 'spring'
          })
        })
      },
      checkNewImpels(){
        axios.get('/rest/learninggw/api/pc/magic/treasureBox/hasClosedTreasureBoxByStudentId', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then(res => {
          if (res.data.code == 200 && res.data.data == true) {
            this.isHaveNewImpel = true
          }
          this.checkImpelsNumber()
        })
      },
      gotoHotActivity() {
        //去能量站
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_impelbox_page'
        })
        this.$playSound("click")
        this.$router.push('/hot_activity')
      },
      //去21世纪英语比赛
      goCenturySpeech(routetString){
        this.$router.push({
          path:routetString
        })
      }
    }
  }
</script>

<style lang="stylus" scoped>
  /*宝石的入口样式 */
  .impel-btn
    position: fixed
    left: -100px
    bottom: 30px
    width: 155px
    height: 182px
    cursor: pointer
    z-index: 100
    opacity: 0
    .icon-impel-bg
      position: absolute
      width: 155px
      height: 173px
      background-size: 155px 173px
    .impel-package
      position: absolute
      bottom: 12.6px
      left: 48px
      width: 66px
      height: 81px
      background: url(../../../img/index/index-impel-entry-package@2x.png) no-repeat
      background-size: 66px 81px
    .icon-circle
      position: absolute
      left: 7px
      top: 23px
      width: 52px
      height: 52px
      background: url(../../../img/index/index-impel-entry-circle@2x.png) no-repeat
      background-size: 52px 52px
      transform-origin: center center
      animation: circle 2s linear .3s infinite
    .icon-direction
      position: absolute
      left: 19px
      top: 33px
      width: 12px
      height: 13px
      transform: scale(1.4)
      background: url(../../../img/index/index-impel-entry-decatrion@2x.png) no-repeat
      background-size: 12px auto

    .icon-impel-new-one-impel
      position: absolute
      left: 29px
      bottom: -3px
      width: 102px
      height: 100px
      background: url(../../../img/index/index-impel-entry-last-one-impel-bg.png) no-repeat
      animation: diDas 2s linear infinite

    .icon-impel
      position: absolute
      left: 22px
      top: 35px
      width: 25px
      height: 25px
      background: url(../../../img/index/index-impel-entry-impel@2x.png) no-repeat
      background-size: 25px 25px

    .icon-impel-animation
      opacity: 0
      animation: pulses 2s linear .3s infinite

    .icon-impel-number
      position: absolute
      width: 20px
      height: 20px
      background: url(../../../img/index/index-impel-entry-impel@2x.png) no-repeat
      background-size: 20px 20px
      transform-origin: center

  .impel-english-speech
    position: absolute
    left: 298px
    bottom: 13px
    width: 103px
    height: 73px
    cursor: pointer
    z-index: 100
    background-size: 100% 100%
    background-repeat: no-repeat
    img
      width: 103px
      height: 73px

  .impel-pd
    position: absolute
    bottom: 18px
    left: 148px
    width: 124px
    height: 60px
    background: url(../../../img/project_demo/bg_index.png) no-repeat
    background-size: 100% 100%
    &:active
      opacity: 0.6
    .icon-light-3
      width: 47px
      height: 44px
      background: url(../../../img/project_demo/light_index.png) no-repeat
      background-size: 100% 100%
      position: absolute
      left: 36px
      top: -8px
      animation: cupShining 3s linear 1.3s infinite
    .icon-cup
      position: absolute
      width: 50px
      height: 47px
      background: url(../../../img/project_demo/cup_index.png) no-repeat
      background-size: 100% 100%
      left: 36px
      top: 16px
    .star-big
      position: absolute
      width: 17px
      height: 15px
      background: url(../../../img/project_demo/star_big.png) no-repeat
      background-size: 100% 100%
      right: 46px
      top: -8px
      animation: starShining 3.5s linear .3s infinite
    .star-small
      position: absolute
      width: 9px
      height: 9px
      background: url(../../../img/project_demo/star_small.png) no-repeat
      background-size: 100% 100%
      top: 5px
      right: 36px
      animation: starShining 3.5s linear 2.5s infinite
    .bubble-1
      width: 140px
      height: 37px
      background: url(../../../img/project_demo/bubble_index.png) no-repeat
      background-size: 100% 100%
      position: absolute
      right: -190px
      top: -10px
      color: #8561ed
      font-size: 14px
      padding: 20px
      padding-left: 29px
      padding-top: 15px
      z-index: 102
    .bubble-2
      width: 55px
      height: 28px
      background: url(../../../img/project_demo/bubble2_index.png) no-repeat
      background-size: 100% 100%
      position: absolute
      z-index: -1
      right: -266px
      top: 5px
      color: #FFFFFF
      font-size: 14px
      padding-left: 55px
      padding-top: 12px

  @keyframes pulses
    0%
      transform: scale3d(1, 1, 1)
      opacity: 1
    50%
      transform: scale3d(1.1, 1.1, 1.1)
      opacity: 1
    100%
      transform: scale3d(1, 1, 1)
      opacity: 1

  @keyframes diDas
    0%
      opacity: 0
    50%
      opacity: 1
    100%
      opacity: 0

  @keyframes circle
    0%
      transform: rotateZ(0deg)
    50%
      transform: rotateZ(-180deg)
    100%
      transform: rotateZ(-360deg)

</style>
