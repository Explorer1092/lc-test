<template lang="jade">
  .pet-container(:class="{'egret-player-hot': !this.isHome, 'egret-player-index': this.isHome}",v-if="isPetSwitch")
    .pet-egg-lock(:class="{'pet-egg-lock-left': isInApp && this.isHome}", v-if="growUpStatus =='EGG_LOCK'", @click.stop="showEggTip")
    .pet-egg-new(:class="{'pet-egg-new-hot': !this.isHome, 'egg-move-left-new': isInApp && this.isHome}",v-if="growUpStatus =='EGG'", @click="enterDinoComics")
    .pet-egg-light(:class="{'pet-egg-light-hot': !this.isHome, 'egg-move-left-light': isInApp && this.isHome}",v-if="growUpStatus =='EGG'",@click="enterDinoComics")
    .egret-player-shadow(v-if="isShowPlayer", ref="playerShadow")
    transition(enterActiveClass="animated fadeInUp",leaveActiveClass="animated fadeOutDown")
      .pet-vk-tip-top(:class="{'pet-vk-tip-right': !this.isHome, 'pet-vk-tip-left': isInApp && this.isHome}", v-if="isShowPetEggTip && growUpStatus =='EGG_LOCK'", style="top:-60px")
        p(v-if="growUpStatus =='EGG_LOCK'") 完成一节主修课，解锁宠物功能
      .pet-vk-tip-top.dinoTip(:class="{'dinoTip-right': !this.isHome}",v-if="isShowPetDinoTip", class="dinoTip", @click.stop="hideTip")
        p {{petMessage}}
</template>
<script>
	import axios from 'axios'
	import cookies from 'cookies-js'
	let getDinoSdk = (cb) => {
	 import('egret-dino').then(() => {
	   !cb || cb()
	 }
		)  //eslint-disable-line
	}
	export default {
	  data: function () {
	    return {
	      messageSwitch: false, //消息开关
	      dino: null,
	      isShowPetEggTip: true, //宠物蛋提示显示与否
	      isShowPetDinoTip: false, //小恐龙提示显示与否
	      growUpStatus: "", //"EGG_LOCK", //当前宠物解锁和出生状态：EGG_LOCK 未上课之前锁定 、EGG 上一节主修课课解锁蛋、BORN 点击解锁了的蛋出生
	      isPetSwitch: true,
	      petMessage: "",
	      isShowPlayer: false, //动画是否展示,
	      timer: null, // 定时器名称
	      isAgreeMove: false,
	      agreeNewDinoCount: 0, //是否允许实例化dino次数
	      isAgreeNewDino: true //是否允许实例化dino
	    }
	  },
	  props: {
	    isHome: {
	      type: Boolean,
	      default: true
	    },
	    isInApp: {
	      type: Boolean,
	      default: false
	    }
	  },
	  mounted () {
	    if (this.isHome) {
	      return
	    }
	    this.timer = setTimeout(()=>{
	      this.getDinoData()
	    },500)
	  },
	  activated() {
	    if (!this.isHome) {
	      return
	    }
	    this.isAgreeMove = true
	    this.timer = setTimeout(()=>{
	      this.isAgreeNewDino = true
	      this.getDinoData()
	    },500)
	  },
	  deactivated() {
	    if (this.dino) {
	      this.dino.hideDino()
	    }
	    clearTimeout(this.timer)
	    this.isAgreeMove = false
	    this.isShowPlayer = false
	    this.dino = null
	    this.isAgreeNewDino = false
	  },
	  beforeDestroy() {
	    //组件销毁之前清除定时器
	    clearTimeout(this.timer)
	    if (this.dino) {
	      this.dino.hideDino()
	    }
	    this.timer = null
	    this.dino = null
	    this.isAgreeNewDino = false
	  },
	  methods: {
	    showEggTip() {
	      if (this.isShowPetEggTip) {
	        clearTimeout(this.timer)
	        this.isShowPetEggTip = false
	      } else {
	        this.isShowPetEggTip = true
	        this.timer = setTimeout(() => {
	          this.isShowPetEggTip = false
	        }, 5000)
	      }
	      sa.track('learning_click', {
	        'click_id': this.isHome ? 'pc_learning_homepage_click_egg_lock' : 'pc_learning_hot_activity_click_egg_lock'
	      })
	    },
	    enterDinoHome(){
	      sa.track('learning_click', {
	        'click_id': this.isHome ? 'pc_learning_homepage_go_dino_home' : 'pc_learning_hot_activity_go_dino_home'
	      })
	      //this.$router.push('/hot_activity')
	      this.$router.push('/dino_home')
	    },
	    enterDinoComics() {
	      sa.track('learning_click', {
	        'click_id': this.isHome ? 'pc_learning_homepage_click_egg_open' : 'pc_learning_hot_activity_click_egg_open'
	      })
	      this.$router.push({path: "/dino_comics/0"})
	    },
	    //获取消息推送接口
	    getMessage(pushMsgAnim, enterAnim, loopAnim) {
	      axios.get('/rest/learninggw/api/pet/message/getMessage',{
	        params: {
	          studentId: cookies.get("studentId")
	        }
	      }).then(res => {
	        if (!this.isAgreeNewDino) {
	          return
	        }
	        if (res.data.code == "200" && res.data.data!=null) {
	          this.getIsShowPetDinoTip(true)
	          this.dino.showDino()
	          this.dino.playAnimationOnce(pushMsgAnim)
	          this.petMessage = res.data.data.message
	        } else {
	          this.dino.showDino()
	          this.getIsShowPetDinoTip(false)
	          // 入场
	          this.dino.playAnimationOnce(enterAnim, ()=>{
	            this.setBoxSize()
	          })
	        }
	        // 循环
	        this.dino.loopRandomAnim(loopAnim, 10000)
	      }).catch((err) => {
	        if (!this.dino) {
	          return
	        }
	        this.dino.showDino()
	        this.dino.playAnimationOnce(enterAnim, () => {
	          this.setBoxSize()
	        })
	        // 循环
	        this.dino.loopRandomAnim(loopAnim, 10000)
	      })
	    },
	    //消息推送提示是否展示
	    getIsShowPetDinoTip(status) {
	      this.isShowPetDinoTip = status
	      if (!status) {
	        return
	      }
	      this.timer = setTimeout(() => { //5秒之后动画提示消失
	        this.isShowPetDinoTip = false
	        this.setBoxSize()
	      },5000)
	    },
	    hideTip() {
	      sa.track('learning_click', {
	        'click_id': this.isHome ? 'pc_learning_homepage_close_push_tip' : 'pc_learning_hot_activity_close_push_tip'
	      })
	      this.isShowPetDinoTip = false
	      this.setBoxSize()
	      this.dino.clearAnim()
	    },
	    _getSDKFn() {
	      if (window.DinoAnim) {
	        this.getPetResourceActionInfo()
	      } else {
	        getDinoSdk(() => {
	          this.getPetResourceActionInfo()
	        })
	      }
	    },
	    getDinoData() {
	      //请求dino信息
	      axios
	        .get("/rest/learninggw/api/pet/pet/detail", {
	          params: {
	            studentId: cookies.get("studentId")
	          }
	        })
	        .then(res => {
	          if (res.data.code == "200" && res.data.data.petSwitch == "ON") {
	            if (res.data.data.growUpStatus =='BORN') {
	              this.isShowPlayer = true
	              this._getSDKFn()
	              this.growUpStatus = res.data.data.growUpStatus
	              this.messageSwitch = res.data.data.messageSwitch === "ON"
	            } else {
	              this.growUpStatus = res.data.data.growUpStatus
	              this.timer = setTimeout(() => { //5秒之后提示消失
	                this.isShowPetEggTip = false
	              },5000)
	            }
	          } else {
	            this.isShowPlayer = false
	          }
	        })
	    },
	    getPetResourceActionInfo() {
	      let petResourceList = []
	      let pcPetResource = []
	      let pushMsgAnim = ""
	      let enterAnim = ""
	      let normalAnim = ""
	      let loopAnim = ""
	      let clickHeadAnim = ""
	      let clickBodyAnim = ""
	      let toLeftAnim = ""
	      let toRightAnim = ""
	      let url = ""
	      let spliceUrl = ""
	      this.agreeNewDinoCount++
	      axios.get(`/rest/learninggw/api/pet/homepage/petResourceActionInfo`, {
	        params: {
	          studentId: cookies.get("studentId"),
	          deviceType: "PC_H5"
	        }
	      }).then((res) => {
	        this.agreeNewDinoCount--
	        if (this.agreeNewDinoCount !== 0 || !this.isAgreeNewDino) {
	          this.agreeNewDinoCount = this.agreeNewDinoCount <= 0 ? 0 : this.agreeNewDinoCount
	          return
	        }
	        petResourceList = res.data.data.petResourceList || []
	        for(let i = 0; i < petResourceList.length; i++) {
	          if(petResourceList[i].deviceType == "PC_H5") { //判断设备
	            let data = {
	              "name": petResourceList[i].name,
	              "type": petResourceList[i].type === "dbbin" ? "bin" : petResourceList[i].type,
	              "url": petResourceList[i].url
	            }
	            pcPetResource.push(data)
	            url = petResourceList[i].url
	          }
	          spliceUrl = url.match(/^(([a-z]+:)?(\/\/)?[^\/]+\/).*$/)[1] //截取字符串中的域名
	        }
	        let petObj = res.data.data
	        if(!petObj || JSON.stringify(petObj) === '{}'){
	          return
	        }
	        pushMsgAnim = petObj.petActionLibraryMap.pushMsgAnim.actionCommand
	        enterAnim = petObj.petActionLibraryMap.enterAnim.actionCommand
	        normalAnim = petObj.petActionLibraryMap.normalAnim.actionCommand
	        loopAnim = petObj.petActionLibraryMap.loopAnim.actionCommand
	        clickHeadAnim = petObj.petActionLibraryMap.clickHeadAnim.actionCommand
	        clickBodyAnim = petObj.petActionLibraryMap.clickBodyAnim.actionCommand
	        toLeftAnim = petObj.petActionLibraryMap.toLeftAnim.actionCommand
	        toRightAnim = petObj.petActionLibraryMap.toRightAnim.actionCommand
	        // 过滤 宠物初始化服装
	        let dressedMap = {}
	        for(let key in petObj.dressedMap){
	          if(petObj.dressedMap[key].length>0){
	            dressedMap[key] = JSON.parse(petObj.dressedMap[key][0].pcH5Resource)
	          }
	        }
	        this.dino = new DinoAnim({
	          width: 200,
	          height: 230,
	          scale: 0.22,
	          el: this.$refs.playerShadow,
	          turnRound: this.isHome ? false : true,
	          centrePoint: [110, 170],
	          initAnimNames: {
	            pushMsgAnim: pushMsgAnim,//推送消息动作名称（选填）
	            enterAnim: enterAnim,//进场动作名称（选填）
	            normalAnim: normalAnim,//静止状态动作
	            loopAnim: loopAnim,//无消息情况下的循环动作 10s动作一次 （选填）
	            clickHeadAnim: clickHeadAnim,//点击头部动作名称
	            clickBodyAnim: clickBodyAnim,//点击身体动作名称
	            toLeftAnim: toLeftAnim,//向左划动动作名称
	            toRightAnim: toRightAnim//向右滑动作名称
	          },
	          resources: pcPetResource,
	          resRootPath: spliceUrl,
	          isAgreeClick: false,
	          initSkinData: dressedMap,
	          complete: () => {
	            if (!this.dino) {
	              return
	            }
	            //推送消息打开
	            if (this.messageSwitch) {
	              this.getMessage(pushMsgAnim, enterAnim, loopAnim)
	            } else {
	              this.dino.showDino()
	              this.dino.playAnimationOnce(enterAnim, ()=>{
	                this.setBoxSize()
	              })
	              // 循环
	              this.dino.loopRandomAnim(loopAnim, 10000)
	            }
	          },
	          tapHandle: (msg) => {
	            this.enterDinoHome()
	          },
	          errorHandle:(err) => {
	            console.log(err)
	          }
	        })
	      })
	    },
	    // 防止首页遮挡卡片
	    setBoxSize() {
	      if (!this.isHome || !this.isAgreeMove) {
	        return
	      }
	      let egretPlayer = document.getElementById('egret-player')
	      if (egretPlayer && this.$refs.playerShadow) {
	        egretPlayer.style.top = '-60px'
	        this.$refs.playerShadow.style.height = '170px'
	      }
	    }
	  }
	}
</script>


<style lang="stylus" scoped>
  .pet-egg-new,.pet-egg-light,.pet-egg-light,#egret-player
    -webkit-tap-highlight-color: transparent
    -webkit-touch-callout: none
    -webkit-user-select: none
    user-select:none

  .egret-player-index
    .egret-player-shadow
      position: absolute
      right: 0
      bottom: -10px
      width: 200px
      height: 230px
      overflow: hidden

  .egret-player-hot
    .egret-player-shadow
      position: absolute
      left: -60px
      bottom: -10px
      width: 200px
      height: 230px
      overflow: hidden

  /* 宠物的入口样式 */
  .pet-container
    position: relative
    cursor: pointer
    z-index: 10
    .pet-egg-lock
      width: 70px
      height: 70px
      background: url('../../../img/index/index-pet-enter-lock-spirtes.png') -10px -8px no-repeat
      background-size: 200px
      transition: transform 0.3s
      cursor: not-allowed
      &:hover
        transform: scale(1.1, 1.1)
        cursor: pointer
    .pet-egg-lock-left
      margin-right: 50px

    .pet-egg-light
      position: absolute
      right: 0
      bottom: 0
      width: 80px
      height: 38px
      background: url('../../../img/index/index-pet-enter-lock-spirtes.png') 3px -80px no-repeat
      background-size: 200px
      animation: opAn 4s linear infinite
    .pet-egg-new
      position: absolute
      right: 9px
      bottom: -5px
      width: 70px
      height: 70px
      background: url('../../../img/index/index-pet-enter-lock-spirtes.png') -72px -8px no-repeat
      background-size: 200px
      transition: transform 0.3s
      animation: egg-move 2s infinite alternate ease-in-out
      &:hover
        transform: scale(1.2, 1.2)

    .pet-egg-new-hot
      right: -40px
    .egg-move-left-new
      right: 60px

    .pet-egg-light-hot
      right: -49px

    .egg-move-left-light
      right: 51px

    .pet-vk-tip-top
      position: absolute
      width: 260px
      right: 9px
      top: -55px
      box-sizing: border-box
      background: rgba(255, 255, 255, 1)
      border-radius: 25px
      border: 2px solid rgba(133, 97, 237, 1)
      cursor: auto
      z-index: 20
      &:after
        content: ''
        position: absolute
        right: 18px
        width: 26px
        height: 20px
        background: url('../../../img/index/index-arrow_bottom.png') no-repeat
        background-size: 100%
      p
        padding: 12px 0 12px 0
        line-height: 20px
        text-align: center
        color: #8561ED
        font-size: 14px
    .pet-vk-tip-left
      right: 58px

    .pet-vk-tip-right
      right: -185px
      &:after
        right: 212px

    .dinoTip
      right: 62px
      top: auto
      bottom: 130px
      // padding-bottom: 10px
      &:after
        bottom: -20px
      p
        padding: 12px 16px
        max-height: 51px
        overflow: hidden

    .dinoTip-right
      right: -264px
      &:after
        right: 195px

  @keyframes opAn
    0%
      opacity 0
    10%
      opacity 0.2
    50%
      opacity 1
    100%
      opacity 0
  @keyframes grow
    0%
      transform: scale(0)
    60%
      transform: scale(1.15)
    80%
      transform: scale(0.95)
    100%
      transform: scale(1)
  @keyframes egg-move
    10%
      transform: rotate3d(0, 0, 1, 5deg)
    20%
      transform: rotate3d(0, 0, 1, -4deg)
    30%
      transform: rotate3d(0, 0, 1, 3deg)
    50%
      transform: rotate3d(0, 0, 1, -2deg)
    60%
      transform: rotate3d(0, 0, 1, 0deg)
    100%
      transform: rotate3d(0, 0, 1, 0deg)
</style>
