<template lang="jade">
  .header(:style="isShowAddNumber?'z-index:122':''")
    .jh-panel(v-if="userInfo.isShow")
      .jh-user(@click.stop="openUseInfo")
        //- 吊坠 Show Time
        img.show-time-hang.animated(v-for="item in filterShowTimeEntryData", @click.stop="enterActivity(item.activityCategoryURL)", :src="item.activityCategoryImage")
        .user-avatar
          img(src="../../../img/common/avatar/boy_1.png",v-if="!userInfo.avatarUrl && (userInfo.studentAvatar == 'default'|| !userInfo.studentAvatar)")
          img(src="../../../img/common/avatar/boy_1.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='boy_1'")
          img(src="../../../img/common/avatar/boy_2.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='boy_2'")
          img(src="../../../img/common/avatar/boy_3.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='boy_3'")
          img(src="../../../img/common/avatar/boy_4.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='boy_4'")
          img(src="../../../img/common/avatar/girl_1.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='girl_1'")
          img(src="../../../img/common/avatar/girl_2.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='girl_2'")
          img(src="../../../img/common/avatar/girl_3.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='girl_3'")
          img(src="../../../img/common/avatar/girl_4.png",v-if="!userInfo.avatarUrl && userInfo.studentAvatar=='girl_4'")
          // 新增自定义头像
          img(:src="userInfo.avatarUrl",v-if="userInfo.avatarUrl")
        .myself-panel
          slide-text.name(:class="!(userInfo.currentLevel&&userInfo.currentUnit)?'name-mid':''",:text="userInfo.studentName",:isAutoSlide="true")
          .level-unit(v-if="(userInfo.currentLevel&&userInfo.currentUnit)") {{userInfo.currentLevel}} {{userInfo.currentUnit}}
          .rate(v-if="(userInfo.currentLevel&&userInfo.currentUnit)")
            .rate-over(:style="{width:userInfo.finishPercent+'%'}")    
      .jh-star.animated.zoomIn(@click.stop="goToStar")
        .icon-star-small
        .number {{userInfo.starNum}}
        //- 吊坠 活动
        .promotion-in-top(v-if="isHavePromotion")
        .promotion-in.animated(v-if="isHavePromotion",@click.stop="goToPromotion")
      .jh-honor.animated.zoomIn(@click.stop="showHonor")
        .icon-honor-small
        .number {{userInfo.medalNum}}
        .red-circle(v-if="hasNewHonor")
      .jh-gem.animated.zoomIn(@click="goToHotActivity")
        .icon-gem-small
        .number {{userInfo.eggShellNum}}
        .add-number.animated.fadeInUp(v-show="isShowAddNumber")
          number.number-text(:number="impelNumber")
        //- 吊坠 电子贺卡入口
        .greeting-cards-in-top
        .greeting-cards-in.animated(@click.stop="goToECard")
      //排行榜入口    
      .jh-rank(v-if="showRankEntry", @click="goToRankings") 
        .icon-rank-small   
    .jh-server
      .jh-server-btn.js4.animated.zoomIn(v-if="courseEnterState.lib!='hide'", @click.stop="goToLib", :class="courseEnterState.lib=='locked'?'js4-locked':''")
        .jh-cn 数字图书馆
        .jh-en Digital Library
        .jg-new(v-if="courseEnterState.lib=='new'")
        .jg-lock(v-if="courseEnterState.lib=='locked'")
      .jh-server-btn.js3.animated.zoomIn(v-if="courseEnterState.supplementary!='hide'", @click.stop="goToSupplementary", :class="courseEnterState.supplementary=='locked'?'js3-locked':''")
        .jh-cn 辅修课程
        .jh-en Supplementary Course
        .jg-new(v-if="courseEnterState.supplementary=='new'")
        .jg-lock(v-if="courseEnterState.supplementary=='locked'")
      .jh-server-btn.js2.animated.zoomIn(v-if="courseEnterState.extension!='hide'", @mouseleave="isShowMajorExtensionTip=false", @click.stop="goToMajorExtension", :class="courseEnterState.extension=='locked'?'js2-locked':''")
        .jh-cn 主修拓展
        .jh-en Major Course Extension
          vk-tip(v-if="isShowMajorExtensionTip",type="bottom",message="完成每个学习周期可以获得新拓展内容哦~")
        .jg-new(v-if="courseEnterState.extension=='new'")
        .jg-lock(v-if="courseEnterState.extension=='locked'")
      .jh-server-btn.js1.animated.zoomIn(v-if="courseEnterState.major!='hide'",@click.stop="goToMajor",:class="courseEnterState.major=='locked'?'js1-locked':''")
        .jh-cn 主修课程
        .jh-en Major Course
        .jg-new(v-if="courseEnterState.major=='new'")
        .jg-lock(v-if="courseEnterState.major=='locked'")
    .seven-day-no-confim-order(v-if="isHaveConfirmOrderFlag")
      .seven-day-no-confirm-trips
        p  宝贝有订单需要爸爸妈妈确认<br/>才能发货哦！
      .seven-day-no-confirm-button(@click.stop="closeConfirmOrderTrips")
        p  知道了
    Honor(v-if="honorShow",:closeHonor="closeHonor")
    student-info(v-if="isShowUserInfo",:close="closeUserInfo",:user="userInfo")
</template>
<script>
  import Honor from './honor.vue'
  import util from '../../../utils/_untils'
  import axios from 'axios'
  import cookies from 'cookies-js'
  import vkTip from '../../common/vk_tip.vue'
  import slideText from '../../common/vk_slide_text.vue'
  import number from '../../common/vk_number.vue'
  import studentInfo from './student_info.vue'
  export default {
    data: function () {
      return {
        isShowUserInfo: false,
        isShowMajorExtensionTip: false,
        isHaveConfirmOrderFlag: false,
        honorShow: false,
        timeouts: [],
        impelNumber: "0",
        isShowAddNumber: false,
        //显示promotion
        isHavePromotion: false,
        //用户课程入口 hide,new,locked,unlocked
        courseEnterState: {
          major: "hide",
          extension: "hide",
          supplementary: "hide",
          lib: "hide"
        },
        //排行榜入口
        showRankEntry: false,
        //show time 吊坠
        showTimeEntryData: [],
        hasNewHonor: false //拥有新勋章
      }
    },
    computed:{
      //过滤能够参赛的入口
      filterShowTimeEntryData(){
        return this.showTimeEntryData.filter((item)=>{
          return item.activityCategory == "pd" && item.isActivityOpen == true 
        })
      }
    },
    components: {
      Honor, vkTip, slideText, number, studentInfo
    },
    props: {
      userInfo: {
        type: Object,
        required: false,
        default: {
          studentName: "---",
          studentAvatar: "",
          currentUnit: "--",
          currentLevel: "--",
          finishPercent: 0,
          starNum: 0,
          eggShellNum: 0,
          isShow: false
        }
      }
    },
    watch: {
      userInfo: function (n, o) {
        if (o.eggShellNum == undefined) {
          return
        }
        this.impelNumber = (n.eggShellNum - o.eggShellNum) + ""
        //显示能量石增加
        if (this.impelNumber > 0) {
          this.timeouts.push(setTimeout(() => {
            this.isShowAddNumber = true
          }, 2500))
          this.timeouts.push(setTimeout(() => {
            this.isShowAddNumber = false
          }, 4000))
        }
        //显示勋章增加
        this.hasNewHonor = n.medalNum - o.medalNum > 0
      }
    },
    beforeDestroy: function () {
      //销毁所有setTimeout
      for (var i = 0; i < this.timeouts.length; i++) {
        clearTimeout(this.timeouts[i])
      }
    },
    mounted(){
      //孩子兑换了礼品，但是家长没有同意的情况下弹出提示窗
      this.isHaveNoConfirmOrder()
      // TODO 营销活动入口
      this.showPromotion()
      //右上角 课程入口
      this.timeouts.push(setTimeout(() => {
        this.libEnter()
        this.majorEnterState()
        this.supplementEnterState()
        this.majorExtensionEnterState()
        this.getShowTimeHang()
      }, 1000))
      this.checkRankEntry()
    },
    methods: {
      enterActivity(link) {
        this.$router.push({path: link})
      },
      //showTime吊坠
      getShowTimeHang() {
        axios.get('/rest/learninggw/api/pc/path/projectDemo/getOrnamentInfo', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          this.showTimeEntryData = res.data.data
          this.lanuch21CenteryActivity()
        })
      },
      lanuch21CenteryActivity(){
        let activityListFor21 = this.showTimeEntryData.filter((item)=>{
          return item.isActivityOpen && item.activityCategory == "21century"
        })
        this.$emit('21-century-acitivity',activityListFor21)
      },
      //电子贺卡入口
      goToECard(){
        sa.track('learning_click', {'click_id': 'pc_learning_homepage_enter_greeting_cards'})
        this.$router.push({path: '/greeting_cards'})
      },
      //检查排行榜入口
      checkRankEntry() {
        axios.get(`/rest/learninggw/api/rank/score/getEntranceStatusByStudentId`, {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data === 'SHOW' || res.data.data === 'NEED_AGREE_PROTOCOL') {
              this.showRankEntry = true
            }
          }
        })
      },
      //跳转排行榜
      goToRankings() {
        sa.track('learning_click', {'click_id': 'pc_learning_homepage_enter_rankings'})
        this.$router.push({path: '/rankings'})
      },
      //数字图书馆灰度接口
      libEnter() {
        axios.get(`/rest/learninggw/api/pc/service/digitlib/${cookies.get("studentId")}/isPayUser`)
          .then((res) => {
            if (res.data.code == 200) {
              if (res.data.data) {
                this.courseEnterState.lib = "unlocked"
              } else {
                this.courseEnterState.lib = "hide"
              }
            }
          }
          )
      },
      //主修入口
      majorEnterState(){
        return axios.get('/rest/learninggw/api/pc/path/majorCourse/getMajorCoursePathPermission', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data == 1) {
              this.courseEnterState.major = "unlocked"
            } else {
              this.courseEnterState.major = "hide"
            }
          }
        }
        ).catch((error) => {
        })
      },
      //辅修课
      supplementEnterState(){
        return axios.get('/rest/learninggw/api/pc/path/elective/getPermisson', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data) {
              this.courseEnterState.supplementary = "unlocked"
            } else {
              this.courseEnterState.supplementary = "hide"
            }
          }
        }
        ).catch((error) => {
        })
      },
      //主修拓展
      majorExtensionEnterState(){
        return axios.get('/rest/learninggw/api/pc/material/getMaterialEntryInfoBySID', {
          params: {
            sid: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            this.courseEnterState.extension = res.data.data.status
          }
        }
        ).catch((error) => {
        })
      },
      //是否显示Promotion
      showPromotion(){
        return axios.get('/rest/learninggw/api/pc/service/arbor/isArborActivityOpen', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data) {
              this.isHavePromotion = true
            }
          }
        }
        )
      },
      //打开勋章弹窗
      showHonor() {
        this.honorShow = true
        this.hasNewHonor = false
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_honor'
        })
        this.$playSound("click")
      },
      //关闭勋章弹窗
      closeHonor() {
        this.honorShow = false
        this.$playSound("click")
      },
      //打开用户信息弹窗
      openUseInfo(){
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_open_user_info'
        })
        this.isShowUserInfo = true
      },
      //关闭用户信息弹窗
      closeUserInfo(){
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_close_user_info'
        })
        this.isShowUserInfo = false
      },
      //去参加营销活动
      goToPromotion(){
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_promotion_star_lottery'
        })
        this.$playSound("click")
        window.location.href = "/games/index.html"
      },
      goToLib(){
        this.courseEnterState.lib == 'locked' ? null : this.$router.push({path: '/dgl/digitalLibrary'})
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_lib'
        })
        this.$playSound("click")
      },
      goToSupplementary(){
        this.courseEnterState.supplementary == 'locked' ? null : this.$router.push({path: '/extension'})
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_supplementary'
        })
        this.$playSound("click")
      },
      goToMajor(){
        this.courseEnterState.major == 'locked' ? null : this.$router.push({path: '/major_course_catalog'})
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_major'
        })
        this.$playSound("click")
      },
      goToMajorExtension(){
        this.courseEnterState.extension == 'locked' ? this.isShowMajorExtensionTip = true : this.$router.push({path: '/major_extension_mc'})
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_major_extension'
        })
        this.$playSound("click")
      },
      //星星商店
      goToStar(){
        this.$router.push({path: '/star_store'})
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_star'
        })
        this.$playSound("click")
      },
      //打开能量站
      goToHotActivity(){
        this.$router.push({path: '/gift_exchange'})
        sa.track('learning_click', {
          'click_id': 'pc_learning_homepage_enter_gift'
        })
        this.$playSound("click")
      },
      //判断是否在七天内有未确认的订单
      isHaveNoConfirmOrder(){
        axios.get('/rest/learninggw/api/pc/eshop/order/get7DayNotConfirmedOrderCount', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then(res => {
          if (res.data.code == 200 && res.data.data > 0) {
            this.isHaveConfirmOrderFlag = true
          }
        })
      },
      //关闭订单窗口
      closeConfirmOrderTrips(){
        this.isHaveConfirmOrderFlag = false
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .header
    position: fixed
    left: 20px
    top: 20px
    right: 40px
    height: 150px
    z-index: 110
    color: #FFFFFF
    .jh-panel
      float: left
      border-radius: 44px
      height: 64px
      padding-right: 10px
      background-color: rgba(255, 255, 255, 0.2)
      .jh-user
        float: left
        height: 64px
        cursor: pointer
        padding-right: 10px
        .user-avatar
          float: left
          height: 60px
          width: 60px
          margin-top: 2px
          margin-left: 2px
          border-radius: 50%
          background: url("../../../img/common/avatar/boy_1.png") no-repeat center
          background-size: 100% 100%
          img
            width: 100%
            height: 100%
            border-radius: 50%
        .myself-panel
          float: left
          width: 104px
          margin-left: 10px
          .name
            height: 28px
            font-size: 20px
            line-height: 30px
          .name-mid
            line-height 60px
            height: 60px
            font-size: 20px
          .level-unit
            height: 20px
            font-size: 14px
          .rate
            height: 6px
            border-radius: 3px
            width: 100%
            background-color: rgba(255, 255, 255, 0.5)
            .rate-over
              background-color: #70c57e
              height: 6px
              border-radius: 3px
              margin-top: 2px

  .add-number
    position: absolute
    top: -40px

  .jh-star, .jh-honor, .jh-gem, .jh-rank
    position: relative
    float: left
    height: 46px
    background-color: rgba(0, 0, 0, .1)
    border-radius: 70px
    margin-top: 9px
    margin-left: 10px
    cursor: pointer
    display: flex
    display: -webkit-flex
    align-items: center
    justify-content: center
    -webkit-align-items: center
    -webkit-justify-content: center

    &:hover div
      opacity: 0.8
      transform: scale(1.05, 1.05)
    div
      transition: all 0.5s
    .number
      padding-right: 10px
      font-size: 18px
      min-width: 18px
    
    //改版小图标类
    .icon-star-small
      background: url("../../../img/rankings/home_starstore@2x.png") no-repeat
      background-size: 100% 100%
      width: 32px
      height: 32px
      margin: 0 6px 0 10px

    .icon-honor-small
      background: url("../../../img/rankings/home_medal@2x.png") no-repeat
      background-size: 100% 100%
      width: 32px
      height: 32px
      margin: 0 6px 0 10px

    .icon-gem-small
      background: url("../../../img/rankings/energy_store@2x.png") no-repeat center center
      background-size: 100% 100%
      width: 32px
      height: 32px
      margin: 0 4px 0 10px

    .icon-rank-small
      background: url("../../../img/rankings/home_rank@2x.png") no-repeat
      background-size: 100% 100%
      width: 32px
      height: 32px
      margin: 0 12px 0
    
    .red-circle
      position: absolute
      right: 0
      top: 0
      width: 10px
      height: 10px
      background: rgba(255,102,0,1)
      border-radius: 10px

  .jh-rank
    margin-left: 20px

  .promotion-in
    position: absolute
    background: url("../../../img/index/star_lottery_index.png") no-repeat
    background-size: 100% auto
    width: 50px
    height: 77px
    top: 43px
    left: 1px
    transform-origin: 25px 2px
    animation: sw 5s infinite
    cursor: pointer

  .dream-in, .greeting-cards-in
    position: absolute
    background: url("../../../img/index/home_my_dream@2x.png") no-repeat
    background-size: 100% auto
    width: 50px
    height: 54px
    top: 48px
    left: 1px
    transform-origin: 25px 2px
    animation: sw 5s infinite
    cursor: pointer
  
  .greeting-cards-in
    background: url("../../../img/index/home_greeting_cards@2x.png") no-repeat
    background-size: 100% auto
  
  .show-time-top
    position: absolute
    width: 18px
    left: 17px
    top: 37px
    height: 30px
    background: url("../../../img/index/chain@2x.png") no-repeat
    background-size: 100% auto

  .promotion-in-top, .dream-in-top, .greeting-cards-in-top
    position: absolute
    width: 18px
    left: 17px
    top: 37px
    height: 30px
    background: url("../../../img/index/chain@2x.png") no-repeat
    background-size: 100% auto

  .dream-in-top, .greeting-cards-in-top
    height: 8px
    top: 40px

  .jh-server-btn
    position: relative
    float: right
    height: 85px
    width: 85px
    margin-left: 20px
    cursor: pointer
    transition: all 0.5s
    &:hover .jg-new
      animation: newAn 1s
    &:hover
      transform: scale(1.05, 1.05)
      opacity 0.8
    .jh-cn
      font-size: 12px
      margin-top: 90px
      text-align: center
    .jh-en
      position: relative
      font-size: 12px
      text-align: center
    .jg-new
      position: absolute
      width: 36px
      height: 32px
      top: 15px
      right: 10px
      background: url("../../../img/icon/icon_index.png") no-repeat center
      background-position: -38px -86px
    .jg-lock
      position: absolute
      width: 36px
      height: 36px
      top: 37px
      left: 24px
      background: url("../../../img/icon/icon_index.png") -41px -122px

  .js1
    background: url('../../../img/icon/icon_header.png') -158px -237px

  .js1-locked
    cursor: not-allowed
    background: url('../../../img/icon/icon_header.png') -210px -357px

  .js2
    background: url('../../../img/icon/icon_header.png') -258px -233px

  .js2-locked
    cursor: not-allowed
    background: url("../../../img/index/major_extension_icon_lock.png") no-repeat top

  .js3
    background: url('../../../img/icon/icon_header.png') -457px -10px

  .js3-locked
    background: url('../../../img/icon/icon_header.png') -10px -357px
    cursor: not-allowed
    background: url("../../../img/index/extension_icon_lock.png") no-repeat top

  .js4
    background: url('../../../img/icon/icon_header.png') -445px -115px

  .js4-locked
    background: url('../../../img/icon/icon_header.png') -110px -357px
    cursor: not-allowed

  @keyframes newAn {
    20% {
      -webkit-transform: rotate3d(-1, -1, 1, 15deg)
      transform: rotate3d(-1, -1, 1, 15deg)
    }
    40% {
      -webkit-transform: rotate3d(-1, -1, 1, -10deg)
      transform: rotate3d(-1, -1, 1, -10deg)
    }
    60% {
      -webkit-transform: rotate3d(-1, -1, 1, 5deg)
      transform: rotate3d(-1, -1, 1, 5deg)
    }
    80% {
      -webkit-transform: rotate3d(-1, -1, 1, -5deg)
      transform: rotate3d(-1, -1, 1, -5deg)
    }
    to {
      -webkit-transform: rotate3d(-1, -1, 1, 0deg)
      transform: rotate3d(-1, -1, 1, 0deg)
    }
  }

  .seven-day-no-confim-order
    position: absolute
    left: 323px
    top: 55px

  .seven-day-no-confirm-trips
    position: absolute
    left: 0px
    top: 0px
    width: 234px
    height: 65px
    background: url(../../../img/index/seven-no-confirm-trips.png) no-repeat
    bacground-size: 234px 65px
    p
      padding-top: 25px
      line-height: 1.2
      font-size: 14px
      text-align: center
      color: #8561ed

  .seven-day-no-confirm-button
    position: absolute
    left: 234px
    top: 20px
    width: 74px
    height: 40px
    background: url(../../../img/index/seven-no-confirm-button.png) no-repeat
    background-size: 74px 40px
    cursor: pointer
    p
      padding-left: 10px
      line-height: 38px
      text-align: center
  .show-time-hang
    width: 50px
    height: 54px
    position: absolute
    top: 62px
    left: 8px
    transform-origin: 25px 2px
    animation: sw 5s infinite
    cursor: pointer

  @keyframes sw {
    5% {
      transform: rotate3d(0, 0, 1, 15deg)
    }

    10% {
      transform: rotate3d(0, 0, 1, -10deg)
    }
    15% {
      transform: rotate3d(0, 0, 1, 5deg)
    }
    20% {
      transform: rotate3d(0, 0, 1, -5deg)
    }
    25% {
      transform: rotate3d(0, 0, 1, 0deg)
    }
  }
</style>
