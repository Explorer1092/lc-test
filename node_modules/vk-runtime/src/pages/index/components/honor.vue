<template lang="jade">
  transition(enter-active-class="animated bounceInDown",leave-active-class="animated bounceOutUp")
    .honor-con(:class="showClass")
      .hc-panel-top
      .hc-panel
        .hc-close.icon-honor-close(@click="close")
        .hc-panel-in
          .hc-title 我的勋章
          net-error.honor-net-error(v-if="netError")
          .no-honor(v-if="currentHonors.length==0")
            p 还没有获得勋章哦～
            p 完成Unit的学习就可以获得勋章啦～
          transition(enter-active-class="animated pageIn",leave-active-class="animated pageOut")
            .hc-list(v-if="currentHonors.length!=0",v-show="listShow")
              .hcl-item(v-for="(honor,index) in currentHonors",class="animated zoomIn",:style="{animationDelay:index*0.1+'s'}")
                img(:src="honor.name",@error="errorImgFun")
        .hc-circle(:class="honorHandAnimated?'hand-hover':''")
          .h-black
          .h-line(ref="honorHandLine",:style="{height:honorHandTop+'px'}")
          .h-circle.icon-honor-circle(ref="honorHand",@click="handClick",@mouseenter="honorHandHover",@mousedown="honorHandPull($event)",:style="{top:honorHandTop+'px'}")
</template>
<script>
  var noImg = require('../../../img/index/honor_item_icon.png')
  import netError from '../../common/vk_net_error.vue'
  import Velocity from 'velocity-animate'
  import axios from 'axios'
  import cookies from 'cookies-js'

  export default {
    data: function () {
      return {
        netError: false,
        showClass: '',
        currentHonors: [],
        honorHandTop: 60,
        $honorHand: null,
        honorHandAnimated: false,
        currentPage: 1,
        honors: [],
        listShow: true
      }
    },
    components: {
      netError
    },
    watch: {
      honors: function (n, o) {
        this.nextPage()
      }
    },
    props: [
      'closeHonor'
    ],
    mounted(){
      this.$honorHand = this.$refs.honorHand
      this.honorData()
    },
    methods: {
      honorData(){
        axios.get('/rest/learninggw/api/pc/homepage/getStudentMedal', {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            this.honors = res.data.data
          }
        }
        )
      },
      errorImgFun(e){
        e.target.src = noImg
      },
      nextPage(){
        if (this.currentPage > Math.ceil(this.honors.length / 15)) {
          this.currentPage = 1
        }
        var start = (this.currentPage - 1) * 15
        var end = this.currentPage * 15
        this.currentHonors = this.honors.slice(start, end)
      },
      close(){
        this.showClass = ''
        this.closeHonor()
      },
      handClick(){
        this.currentPage++
        this.listShow = false
        setTimeout(() => {
          this.nextPage()
          this.listShow = true
        }, 100)
        Velocity(this.$refs.honorHand, {top: "100px"}, {
          easing: "spring",
          duration: 500, complete: () => {
            Velocity(this.$refs.honorHand, {top: "60px"}, {
              duration: 300
            })
          }
        })
        Velocity(this.$refs.honorHandLine, {height: "100px"}, {
          easing: "spring",
          duration: 500, complete: () => {
            Velocity(this.$refs.honorHandLine, {height: "60px"}, {
              duration: 300
            })
          }
        })
      },
      honorHandPull(e) {
        window.event.returnValue = false
        e.preventDefault()
        e.stopPropagation()
        var y = e.clientY
        var hy = this.honorHandTop
        this.$honorHand.onmousemove = (ec) => {
          var cy = ec.clientY - y
          this.honorHandTop = hy + cy
          if (this.honorHandTop > 30 || this.honorHandTop == 30) {
            if (this.honorHandTop > 100) {
              this.honorHandTop = 60
              this.$honorHand.onmousemove = null
              this.currentPage++
              this.listShow = false
              setTimeout(() => {
                this.nextPage()
                this.listShow = true
              }, 500)
            }
          } else {
            this.honorHandTop = 60
            this.$honorHand.onmousemove = null
          }
        }
        window.onmouseup = () => {
          this.$honorHand.onmousemove = null
          this.honorHandTop = 60
        }
      },
      honorHandHover() {
        if (!this.honorHandAnimated) {
          this.honorHandAnimated = true
          setTimeout(() => {
            this.honorHandAnimated = false
          }, 1500)
        }
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .honor-con
    position: fixed
    top: 0
    left: 0
    right: 0
    bottom: 0
    z-index: 200
    text-align: center
    background-color: rgba(23, 2, 62, 0)
    transition: background-color 0.3s linear

    .hc-close
      width: 57px
      height: 40px
      margin-top: 140px
      margin-left: 720px
      cursor: pointer
      transition: all 0.2s
      &:hover
        margin-left: 730px
    .hc-panel
      position: relative
      height: 471px
      width: 737px
      margin: 0 auto
    .hc-panel-in
      height: 471px
      width: 737px
      margin-top: -150px
      overflow: hidden
      background: url("../../../img/index/honor_bg.png") center no-repeat
      .hc-list
        height: 300px
        box-sizing: border-box
        margin-top: 60px
        margin-left: 40px
        padding: 0 60px 40px 60px
        overflow: hidden
        background: url("../../../img/index/honor_list_bg.png") repeat-y
      .hcl-item
        float: left
        margin-left: 32px
        margin-top: 38px
        margin-bottom: 15px
        width: 66px
        height: 47px
        background-repeat: no-repeat
        background-size: 100% 100%
        cursor: pointer
        &:hover
          transform: scale(1.2, 1.2)
    .hc-panel-top
      height: 50%
      margin-bottom: -300px
    .hc-title
      font-size: 20px
      text-align: center
      line-height: 45px

  img
    width: 100%

  .honor-net-error
    width: 210px
    margin: 80px auto 0 auto

  .no-honor
    width: 740px
    height: 400px
    box-sizing: border-box
    padding-top: 290px
    font-size: 18px
    background: url("../../../img/index/no_data_bg.png") no-repeat bottom

  .honor-con-black
    background-color: rgba(23, 2, 62, 0.85)
    transition: background-color 0.3s linear

  .hc-circle
    position: absolute
    width: 40px
    top: -5px
    right: 35px
    text-align: center
    .h-black
      height: 8px
      width: 8px
      margin: auto
      background-color: #8760fc
      border-radius: 50%
      opacity: 0.6

    .h-line
      position: absolute
      width: 2px
      height: 100px
      margin: -4px 19px
      border-radius: 12px
      background-color: #8760fc
      box-shadow: 1px 1px 0 0 rgba(0, 0, 0, 0.3)
    .h-circle
      position: absolute
      z-index: 100
      margin-left: 5px
      cursor: pointer

  .hand-hover
    animation: swing 1.5s
    z-index: 100

  .pageOut
    animation-name: pageOutKey
    -webkit-backface-visibility: visible !important
    backface-visibility: visible !important
    transform-origin: 0 0

  @keyframes pageOutKey
    from
      transform: perspective(0px)
    30%
      transform: perspective(0px) rotate3d(1, 0, 0, -30deg)
      opacity: 1
    to
      transform: perspective(0px) rotate3d(1, 0, 0, 90deg)
      opacity: 0

  .pageIn
    -webkit-backface-visibility: visible !important
    backface-visibility: visible !important
    animation-name: pageInKey
    transform-origin: 50% 0

  .bounceInDown
    animation-duration 0.2s

  .bounceOutUp
    animation-duration 0.3s

  @keyframes pageInKey
    from
      transform: perspective(400px) rotate3d(1, 0, 0, 90deg)
      animation-timing-function: ease-in
      opacity: 0
    40%
      transform: perspective(400px) rotate3d(1, 0, 0, -20deg)
      animation-timing-function: ease-in

    60%
      transform: perspective(400px) rotate3d(1, 0, 0, 10deg)
      opacity: 1
    80%
      transform: perspective(400px) rotate3d(1, 0, 0, -5deg)
    to
      transform: perspective(400px)


</style>
