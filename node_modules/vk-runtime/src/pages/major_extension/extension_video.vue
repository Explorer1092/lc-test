<template lang="jade">
  //- sw:see-world
  transition(name="extension",enter-active-class="animated fadeInRight",leave-active-class="animated fadeOutRight")
    .sw-content
      .sw-back(@click="back")
      .sw-title
        h1 {{titleCn}}
        h2 {{titleEn}}
      .sli-tip(ref="sliTip",v-show="sliTopShow")
        | {{lockTip}}
      .sw-panel
        .sw-video
          over-video(:videoSrc="currentMaterialUrl",:autoPlay="true",:playEndAction="playEndAction",:source="source",:materialId="currentMaterialId")
        .sw-list
          .sw-list-content(ref="listContent",@scroll="listScrollListener")
            .error
              net-error(v-show="listErrorShow",:errorReload="listErrorReload")
            .sw-list-item(v-for="(course,index) in courseList",:class="currentSelected==index?'sw-list-item-selected':''",@click="selectedVideo($event,index)")
              .sli-locked(v-if="course.status==status['locked']")
              .sli-open(v-if="course.status==status['unlocked']")
                .sli-level  Level {{course.levelNum}}
                .sli-unit   Unit {{course.unitNum}}
                .sli-course  {{course.videoNum}}
              .sli-no-read(v-if="course.status==status['new']")
                .sli-level  Level {{course.levelNum}}
                .sli-unit   Unit {{course.unitNum}}
                .sli-course  {{course.videoNum}}
          .sw-list-top
            .sw-list-top-in(@click="topClick",v-show="topShow")
              img(src="../../img/major_extension/list-top.png")
          .sw-list-bottom
            .sw-list-bottom-in(@click="bottomClick",v-show="bottomShow")
              img(src="../../img/major_extension/list-bottom.png")

</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import overVideo from '../common/vk_video.vue'
  import netError from '../common/vk_net_error.vue'
  import Velocity from 'velocity-animate'
  import formurlencoded from 'form-urlencoded'
  export default {
    data: function () {
      return {
        $listContent: null,
        topShow: true,
        bottomShow: true,
        listErrorShow: false,
        listScrollTop: 0,
        lockTip: "完成每个学习周期可以获得新拓展内容哦~",
        sliTopShow: false,
        bizCode: "",
        titleEn: "",
        titleCn: "",
        currentSelected: 0,
        currentMaterialUrl: "",
        currentMaterialId: "",
        source: "",
        status: {
          locked: 1,
          unlocked: 2,
          new: 3
        },
        courseList: []
      }
    },
    components: {
      overVideo,
      netError
    },
    mounted() {
      this.bizCode = this.$route.params.bizCode
      this.source = "major_extension_detail_" + this.bizCode
      this.$listContent = this.$refs.listContent
      this.getCourseList()
    },
    methods: {
      back() {
        sa.track('learning_click', {
          'click_id': 'pc_learning_major_extension_detail_back',
          'material_id': Number(this.materialId)
        })
        this.$router.back()
      },
      //播放结束
      playEndAction() {
        if (this.courseList[this.currentSelected + 1].status == this.status['locked']) {
          var e = this.$listContent.childNodes[1]
          this.selectedVideo({target: e}, 0)
        } else {
          var e = this.$listContent.childNodes[this.currentSelected]
          this.selectedVideo({target: e}, this.currentSelected + 1)
        }
      },

      //重新加载左侧列表
      listErrorReload() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_extension_detail_listerrorreload'})
        this.listErrorShow = false
        this.getCourseList()
      },
      getCourseList() {
        axios.get('/rest/learninggw/api/pc/material/getMaterialsDetailByStudentID', {
          params: {
            sid: cookies.get("studentId"),
            bizCode: this.bizCode
          }
        })
          .then((res) => {
            if (res.data.code == 200) {
              this.listErrorShow = false
              this.courseList = res.data.data.mList
              this.courseList.push({
                status: 1
              })
              this.titleEn = res.data.data.pcShowNameEN
              this.titleCn = res.data.data.pcShowNameCH
              this.currentSelected = this.courseList.length - 2
              this.currentMaterialUrl = this.courseList[this.currentSelected].materialUrl
              this.currentMaterialId = this.courseList[this.currentSelected].materialId + ""
              this.changeReadState(this.currentSelected)
              this.$nextTick(() => {
                var scrollTop = this.$listContent.scrollHeight - this.$listContent.clientHeight
                if (scrollTop > 500) {
                  this.$listContent.scrollTop = scrollTop - 500
                }
                Velocity(this.$listContent, "scroll", {
                  container: this.$listContent, duration: 800, offset: scrollTop, mobileHA: false
                })
                if (this.$listContent.scrollTop == 0) {
                  this.topShow = false
                }
                if (this.$listContent.scrollHeight - this.$listContent.scrollTop == this.$listContent.clientHeight) {
                  this.bottomShow = false
                }
              })
            } else {
              this.listErrorShow = true
            }
          }).catch((error) => {
            this.listErrorShow = true
          })
      },
      //选择哪个视频
      selectedVideo(e, index) {
        if (this.courseList[index].status == this.status["locked"]) {
          this.sliTopShow = true
          //IE兼容
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var scrollLeft = window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft
          this.$refs.sliTip.style.top = e.target.getBoundingClientRect().top + scrollTop - 70 + "px"
          this.$refs.sliTip.style.left = e.target.getBoundingClientRect().left + scrollLeft - 65 + "px"
          e.target.onmouseleave = () => {
            this.sliTopShow = false
            this.onmouseleave = null
          }
          return
        }
        this.currentSelected = index
        this.changeReadState(this.currentSelected)
        this.currentMaterialUrl = this.courseList[index].materialUrl
        this.currentMaterialId = this.courseList[index].materialId + ""
        const c = this.$listContent.getBoundingClientRect().top + this.$listContent.clientHeight / 2 - e.target.getBoundingClientRect().top
        Velocity(this.$listContent, "scroll", {
          container: this.$listContent, duration: 1000, offset: -c, mobileHA: false
        })
      },
      //修改未读状态
      changeReadState(index) {
        //未读变已读
        if (this.courseList[index].status == this.status["new"]) {
          axios.post('/rest/learninggw/api/pc/material/saveAlreadySeen', formurlencoded({
            sid: cookies.get("studentId"),
            materialId: this.courseList[index].materialId
          })).then(() => {
            this.courseList[index].status = this.status["unlocked"]
          })
        }
      },
      listScrollListener() {
        if (this.$listContent.scrollTop == 0) {
          this.topShow = false
        } else {
          this.topShow = true
        }
        if (this.$listContent.scrollHeight - this.$listContent.scrollTop == this.$listContent.clientHeight) {
          this.bottomShow = false
        } else {
          this.bottomShow = true
        }
      },
      topClick() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_extension_detail_list_top'})
        Velocity(this.$listContent, "scroll", {
          container: this.$listContent, duration: 500, mobileHA: false, offset: -160, complete: () => {
            if (this.$listContent.scrollTop == 0) {
              this.topShow = false
            } else {
              this.topShow = true
            }
            if (this.$listContent.scrollHeight - this.$listContent.scrollTop == this.$listContent.clientHeight) {
              this.bottomShow = false
            } else {
              this.bottomShow = true
            }
          }
        })
      },
      bottomClick() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_extension_detail_list_bottom'})
        Velocity(this.$listContent, "scroll", {
          container: this.$listContent, duration: 500, mobileHA: false, offset: 80, complete: () => {
            if (this.$listContent.scrollHeight - this.$listContent.scrollTop == this.$listContent.clientHeight) {
              this.bottomShow = false
            } else {
              this.bottomShow = true
            }
            if (this.$listContent.scrollTop == 0) {
              this.topShow = false
            } else {
              this.topShow = true
            }
          }
        })
      }
    }
  }
</script>

<style lang="stylus" scoped>
  *
    box-sizing: border-box
    -moz-user-select: none
    -webkit-user-select: none
    -ms-user-select: none
    -khtml-user-select: none
    user-select: none
    -webkit-font-smoothing: antialiased

  .sw-back
    position: absolute
    height: 58px
    width: 58px
    top: 20px
    left: 40px
    cursor: pointer
    z-index: 11
    background: url("../../img/common/back.png") no-repeat center
    &:hover
      background: url("../../img/common/back-hover.png") no-repeat center
    &:active
      background: url("../../img/common/back-pressed.png") no-repeat center

  .sw-content
    height: 100%
    width: 100%
    scroll-padding-top: 200px
    padding: 139px 120px 61px 120px
    transition: scrollTop 1s
    overflow: hidden
    .sw-title
      position: absolute
      text-align: center
      width: 100%
      top: 20px
      left: 0
      color #FFFFFF
      z-index 10
      h1
        font-size: 34px
        line-height: 45px
        font-weight: 300
      h2
        font-size: 24px
        line-height: 27px
        font-weight: 300
    .sli-tip
      position: absolute
      z-index: 999
      height: 75px
      width: 240px
      padding: 9px 21px 22px 21px
      background: url("../../img/major_extension/tip_bg.png") no-repeat center
    .sw-panel
      height: 100%
      width: 100%
      .sw-video
        float: left
        width: 100%
        height: 100%
        margin-right: -260px
        padding-right: 260px;
      .sw-list
        position: relative
        float: left
        height: 100%
        width: 250px
        overflow: hidden
        margin-left: 10px
        border-radius: 25px
        border: solid 4px #8561ed
        background-color: #4e2c8d
        .sw-list-content
          position: absolute
          overflow-y: scroll
          overflow-x: hidden
          width: 268px
          padding: 10px
          bottom: 2px
          top: 2px
          .error
            text-align: center
            width: 90%
          .sw-list-item-selected
            background: url("../../img/major_extension/unit-selected.png") no-repeat center
          .sw-list-item
            float: left
            width: 110px
            height: 90px
            margin-top: 10px
            cursor: pointer
            &:hover
              opacity: 0.8
            div
              text-align: center
            .sli-level
              font-size: 10px
              color: #36185c
              line-height: 35px
            .sli-unit
              color: #ffffff
              font-size: 14px
              line-height: 20px
            .sli-course
              color: #ffffff
              font-size: 18px
              line-height: 30px
            .sli-locked
              position: relative
              width: 100%
              height: 100%
              background: url("../../img/major_extension/unit-locked.png") no-repeat center
            .sli-open
              width: 100%
              height: 100%
              background: url("../../img/major_extension/unit-open.png") no-repeat center
            .sli-no-read
              width: 100%
              height: 100%
              background: url("../../img/major_extension/unit-noread.png") no-repeat center
        .sw-list-top
          position: absolute
          top: 0
          height: 46px
          width: 100%
          text-align: center
          border-top-right-radius: 17px
          border-top-left-radius: 17px
          background: rgba(78, 44, 141, 0.0)
          background: -moz-linear-gradient(top, #4e2c8d, rgba(78, 44, 141, 0.0))
          background: -webkit-gradient(linear, 0 0, 0 bottom, from(#4e2c8d), to(rgba(78, 44, 141, 0.0)))
          background: -o-linear-gradient(top, #4e2c8d, rgba(78, 44, 141, 0.0))
          background: linear-gradient(to bottom, #4e2c8d, rgba(78, 44, 141, 0.0))
          .sw-list-top-in
            height: 46px
            width: 92px
            border-radius: 0 0 46px 46px
            background-color: rgba(255, 255, 255, 0.1)
            margin: 0 auto 0 auto
            cursor: pointer
            text-align: center
            &:hover
              background-color: rgba(255, 255, 255, 0.3)
            img
              margin: 10px auto
        .sw-list-bottom
          position: absolute
          bottom: 0
          height: 46px
          width: 100%
          text-align: center
          border-bottom-right-radius: 17px
          border-bottom-left-radius: 17px
          background: rgba(78, 44, 141, 0.0)
          background: -moz-linear-gradient(bottom, #4e2c8d, rgba(78, 44, 141, 0.0))
          background: -webkit-gradient(linear, 0 0, 0 bottom, from(rgba(78, 44, 141, 0.0)), to(#4e2c8d))
          background: -o-linear-gradient(bottom, #4e2c8d, rgba(78, 44, 141, 0.0))
          background: linear-gradient(to top, #4e2c8d, rgba(78, 44, 141, 0.0))
          .sw-list-bottom-in
            height: 46px
            width: 92px
            margin: auto
            border-radius: 46px 46px 0 0
            background-color: rgba(255, 255, 255, 0.1)
            cursor: pointer
            text-align: center
            &:hover
              background-color: rgba(255, 255, 255, 0.3)
            img
              margin: 20px auto

</style>