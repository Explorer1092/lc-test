<template lang="jade">
  .work-collect-wrap
    top-part(:title_cn = "title_chinese", :title_eng = "title_english", :gobackurl="'/'")
    .main-container
      .tab-wrap
        .tab-item(v-for="(item, index) in tree.courseGroupList", :class="[{active: item.isSelected}, 'tab-' + index]", @click="chooseItem(item.serialNumber, null, null)") {{item.name}}
      .main-board
        .shadow
        .pages-pic
        .left-side
        .page(v-if="isShowPageNumber")
          span {{pageNum}}/{{totalPage}}
        .top-bar(v-gscroll="")
          .sec-item-box
            .sec-item(v-for="(item, index) in tree.courseList" , :class="{active: item.isSelected}", @click="chooseItem(item.serialNumber, item.busType, item.busId)") {{item.name}}
        .filter(v-if="tree.levelList.length" @mouseenter="expandMenu(1)", @mouseleave="closeMenu")
          .btn
            .current {{levelShowName}}
            .arrow(:class="{active: currentExpandMenuNum == 1}")
          .menu(v-if="currentExpandMenuNum == 1")
            .item-box
              .menu-item(v-for="item in tree.levelList", :class="{active: item.isSelected}", @click="chooseItem(item.serialNumber, item.busType, item.busId, item.name, 'LEVEL')") {{item.name}}
        .filter.unit(@mouseenter="expandMenu(2)", @mouseleave="closeMenu")
          .btn
            .current {{unitShowName}}
            .arrow(:class="{active: currentExpandMenuNum == 2}")
          .menu(v-if="currentExpandMenuNum == 2")
            .item-box
              .menu-item(v-for="item in tree.unitList", :class="{active: item.isSelected}", @click="chooseItem(item.serialNumber, item.busType, item.busId, item.name, 'UNIT')") {{item.name}}
        .card-box
          .none-list-place-holder(v-if="!pageList || tree.courseList.length==0") 暂无约课哦～
          .list-scroll(v-else)
            .btn.next(v-if="isNextBtnShow", @click="nextPage")
            .btn.prev(v-if="isPrevBtnShow", @click="prevPage")
            .list-box-container(ref="listBox", @mousewheel="mousewheelHandler")
              .list-box(v-for="itemPageList in pageList")
                .item(v-for="item in itemPageList")
                  img.wave(v-if="item.itemStyle == 0", src="../../img/work_collect/green1.png")
                  img.wave(v-else, src="../../img/work_collect/green2.png")
                  .container
                    .title(v-if="item.itemStyle == 1")
                      slide-text(:text="titleSplit(item.itemTitle)[0]")
                      slide-text.bigger(:text="titleSplit(item.itemTitle)[1]")
                    .title.solo(v-else)
                      slide-text(:text="item.itemTitle")
                    .button-container
                      .btn-box(v-for="itemBtn in item.items")
                        .text(v-if="itemBtn.itemContentType == 'COLORTEXT'")
                          .label {{itemBtn.itemContent.colorTitle}}
                          .result {{itemBtn.itemContent.colorText ? itemBtn.itemContent.colorText : '--'}}
                        .number(v-else-if="itemBtn.itemContentType == 'HOMEWORK'")
                          .icon(:class="itemBtn.itemContent.rightNum == null ? 'grey-check-icon' : 'check-icon'") {{itemBtn.itemContent.rightNum == null ? '--' : itemBtn.itemContent.rightNum}}
                          .icon(:class="itemBtn.itemContent.rightNum == null ? 'grey-wrong-icon' : 'wrong-icon'") {{itemBtn.itemContent.wrongNum == null ? '--' : itemBtn.itemContent.wrongNum}}
                        .placeholder(v-else)
                        .button.grey(v-if="itemBtn.itemButton.itemButtomStatus == 0") {{itemBtn.itemButton.itemButtonText}}
                        .button(v-else, :class="itemBtn.extraType == 1 ? 'yellow' : 'red'", @click.stop="goHomework(item, itemBtn.extraType)") {{itemBtn.itemButton.itemButtonText}}
</template>
<script>
import Vue from 'vue'
import axios from 'axios'
import cookies from 'cookies-js'
import TopPart from '../common/top_part.vue'
import Velocity from 'velocity-animate'
import VerticalScroll from '../common/plugins/VerticalScroll'
import slideText from '../common/vk_slide_text.vue'
import Course from '../common/course/Course.js'
Vue.use(VerticalScroll)
export default {
  data: function () {
    return {
      title_chinese: '资源中心',
      title_english: 'Learning Files Depot',
      currTabNumber: 1,
      serialNumber: 'GROUP-MAJOR', //默认
      tree: {
        courseGroupList: [],
        courseList: [],
        levelList: [],
        unitList: []
      },
      allLevelsObj: {
        busId: '',
        busType: '',
        isSelected: true,
        name: "全部Levels",
        serialNumber: 'ALL_LEVELS'
      },
      allUnitsObj: {
        busId: '',
        busType: '',
        isSelected: true,
        name: "全部Units",
        serialNumber: 'ALL_UNITS'
      },
      levelShowName: '全部Levels',
      unitShowName: '全部Units',
      currentExpandMenuNum: null,
      readyToScoll: true,
      isNextBtnShow: false,
      isPrevBtnShow: false,
      curriculumType: '',
      curriculumId: '',
      pageSize: 8,
      pageNum: 1,
      totalPage: 1,
      cardList: [],
      pageList: {},
      currentMaxPageNumber: 9,
      isShowPageNumber: false
    }
  },
  computed: {
    titleSplit() {
      return (titleString) => {
        let titles = []
        titles.push(titleString.split(' ')[0] + ' ' + titleString.split(' ')[1] + ' ' + titleString.split(' ')[2] + ' ' + titleString.split(' ')[3])
        titles.push(titleString.split(' ')[4] + ' ' + titleString.split(' ')[5])
        return titles
      }
    }

  },
  components: {
    TopPart,
    slideText
  },
  mounted() {
    this.getFilterTree()
  },
  methods: {
    goHomework(cardData, extraType) {
      Course.courseButtonClick({
        type: extraType == 1 ? "PRE" : "AFTER",
        clickId: 'learning_files_depot',
        onlineClassId: cardData.onlineClassId,
        lessonId: cardData.lessonId,
        courseId: cardData.courseId, 
        curriculumVersion: cardData.curriculumVersion,
        buttonExtra: '',
        lessonNum: 0
      })
    },
    nextPage() {
      if (this.pageNum < this.currentMaxPageNumber) {
        this.pageNum++
        this.getDataList( this.scoll('next') )
      }
    },
    prevPage() {
      if (this.pageNum > 1) {
        this.pageNum--
        this.getDataList( this.scoll('prev') )
      }
    },
    scoll(direct) {
      return () => {
        this.$nextTick(() => {
          Velocity(this.$refs.listBox, "scroll", {
            axis: "x",
            container: this.$refs.listBox,
            duration: 300,
            offset: direct == 'next' ? 946 : 0 - 946
          })
        })
      }
    },
    expandMenu(num) {
      if (num === this.currentExpandMenuNum) {
        this.currentExpandMenuNum = null
      } else {
        this.currentExpandMenuNum = num
      }
    },
    closeMenu() {
      this.currentExpandMenuNum = null
    },
    chooseItem(serialNumber, curriculumType, curriculumId, name, type) {
      if (serialNumber == "ALL_LEVELS") {
        this.allLevelsObj.isSelected = true
      } else {
        this.allLevelsObj.isSelected = false
      }
      if (serialNumber == "ALL_UNITS") {
        this.allUnitsObj.isSelected = true
      } 
      if (serialNumber != "ALL_UNITS" && type == "UNIT") {
        this.allUnitsObj.isSelected = false
      }
      if (type == "LEVEL") {
        this.levelShowName = name
        this.unitShowName = '全部Units'
        this.allUnitsObj.busId = curriculumId
        this.allUnitsObj.busType = curriculumType
        this.allUnitsObj.serialNumber = serialNumber //当选择Level x 的时候，unit只能看到在level x中的所有unit
        this.allUnitsObj.isSelected = true //只要在level处操作，unit就会到全部unit
      } else if(type == "UNIT") {
        this.allLevelsObj.isSelected = false
        this.unitShowName = name
      } else {
        this.levelShowName = '全部Levels'
        this.unitShowName = '全部Units'
        this.allLevelsObj.busId = curriculumId
        this.allLevelsObj.busType = curriculumType
        this.allLevelsObj.serialNumber = serialNumber
        this.allLevelsObj.isSelected = true
        this.allUnitsObj.isSelected = true
      }
      this.pageList = {}
      this.serialNumber = serialNumber
      this.curriculumType = curriculumType
      this.curriculumId = curriculumId
      this.pageNum = 1
      if (serialNumber == "ALL_LEVELS" || serialNumber == "ALL_UNITS") {
        this.serialNumber = 'GROUP-MAJOR' //回归默认
        this.getFilterTree()
      } else {
        this.getFilterTree()
      }
    },
    getFilterTree() {
      axios.get('/rest/learninggw/api/pc/material/extra/getCurriculumTree', {
        params: {
          studentId: cookies.get('studentId'),
          serialNumber: this.serialNumber
        }
      }).then((res) => {
        let data = res.data.data
        if((!this.curriculumType || !this.curriculumId) && data.course.length>0) {
          //courseGroup是顶级分类，筛不出list，所以往下走一级到course的第一个item
          this.curriculumType = data.course[0].busType
          this.curriculumId = data.course[0].busId
          this.allLevelsObj.busId = this.curriculumId
          this.allLevelsObj.busType = this.curriculumType
        }
        if(Array.isArray(data.level)){
          data.level.unshift(this.allLevelsObj)
        }
        data.unit.unshift(this.allUnitsObj)
        this.tree.courseGroupList = data.courseGroup
        this.tree.courseList = data.course

        this.tree.levelList = data.level || []
        this.tree.unitList = data.unit
        let levelList = data.level || []
        //由于当在all level时去选择unit的时候，level会自动定位到level 1，所以这里直接让@levelShowName从接口取name
        for (let i = 0; i < levelList.length; i++) {
          if (levelList[i].isSelected) {
            this.levelShowName = levelList[i].name
            break
          }
        }
        if(data.course.length>0){
          this.getDataList()
        }
      })
    },
    getDataList( cb ) {
      this.scollButtonControl()
      if ( !this.canPullData() ) {
        if(cb) {
          this.$nextTick(() => {
            cb()
          })
        }
        return
      }
      axios.get('/rest/learninggw/api/pc/material/extra/getExtraSummaryList?', {
        params: {
          studentId: cookies.get('studentId'),
          curriculumType: this.curriculumType,
          curriculumId: this.curriculumId,
          pageSize: this.pageSize,
          pageNum: this.pageNum
        }
      }).then((res) => {
        if (res.data.code == 200 && res.data.data.extraItemList != null && res.data.data.extraItemList.length != 0) {
          let data = res.data.data
          this.currentMaxPageNumber = data.totalPageCount
          this.isShowPageNumber = true
          this.totalPage = data.totalPageCount.toString()
          this.scollButtonControl()
          this.$set(this.pageList, this.pageNum, data.extraItemList)
          if(cb) {
            this.$nextTick(() => {
              cb()
            })
          }
        } else {
          this.isShowPageNumber = false
          this.pageList = null
        }
      })
    },
    scollButtonControl() {
      if (this.currentMaxPageNumber > 1) {
        if (this.pageNum == this.currentMaxPageNumber) {
          this.isNextBtnShow = false
        } else {
          this.isNextBtnShow = true
        }
        if (this.pageNum == 1) {
          this.isPrevBtnShow = false
        } else {
          this.isPrevBtnShow = true
        }
      } else {
        this.isNextBtnShow = false
        this.isPrevBtnShow = false
      }
    },
    canPullData() {
      //检查列表里是否存在该页数据，如果有，则直接翻页不需要请求数据。
      let keyList = Object.keys(this.pageList)
      for (let i = 0; i < keyList.length; i++) {
        if (keyList[i] == this.pageNum) {
          return false
        }
      }
      return true
    },
    mousewheelHandler(event) {
      if(!this.readyToScoll) {
        return
      } else {
        this.readyToScoll = false
        setTimeout(() => {
          this.readyToScoll = true
        }, 1300)
        if(event.deltaY > 0) {
          this.nextPage()
        } else {
          this.prevPage()
        }
      }
    }
  }
}
</script>
<style lang="stylus" scoped>
.bigger
  font-size: 18px
  font-weight: 700
.button-container
  position: absolute
  top: 53px
  left: 29px
.page
  position: absolute
  bottom: 7px
  left: 50%
  margin-left: 17px
  font-size: 16px
  color: #fff
.work-collect-wrap
  width: 100%
  height: 100%
  position: relative
  .main-container
    position: absolute
    z-index: 9
    top: 50%
    left: 50%
    margin: -300px 0 0px -504px
    @media screen and (min-width: 1680px)
      transform: scale(1.2)
    @media screen and (max-height: 760px)
      transform: scale(0.9)
    .tab-wrap
      position: relative
      width: 950px
      left: 57px
      .tab-item
        display: inline-block
        vertical-align: middle
        width: 159px
        height: 57px
        background-image: url('../../img/work_collect/tabcoll.png')
        background-size: 326px
        background-repeat: no-repeat
        cursor: pointer
        margin-right: -31px
        position: relative
        color: #A4A4F0
        font-size: 24px
        line-height: 68px
        text-align: center
        &.active
          text-shadow: 1px 1px 2px #363771
          color: #fff
        &.tab-0
          background-position: 0px 6px
          z-index: 0
          &.active
            background-position: 0px -57px
            z-index: 1
        &.tab-1
          background-position: -175px 6px
          z-index: 0
          &.active
            background-position: -167px -57px
            z-index: 1
.main-board
  position: relative
  width: 1005px
  height: 547px
  display: inline-block
  background-color: #7F5FDD
  border-radius: 30px
  padding-left: 64px
  box-sizing: border-box
  .card-box
    position: relative
    width: 939px
    height: 420px
    margin-top: 32px
    .list-scroll
      width: 100%
      height: 100%
      .btn
        position: absolute
        background-repeat: no-repeat
        background-size: 100% 100%
        width: 26px
        height: 40px
        top: 50%
        margin-top: -20px
        cursor: pointer
        &:hover
            opacity: 0.8
        &.next
          background-image: url('../../img/work_collect/next.png')
          right: 10px
        &.prev
          background-image: url('../../img/work_collect/prev.png')
          left: 10px
.list-box-container
  white-space: nowrap
  overflow-x: hidden
  .list-box
    display: inline-block
    vertical-align: middle
    width: 818px
    margin: 0 auto
    white-space: normal
    margin: 0 63px
    height: 448px
    .item
      position: relative
      width: 175px
      height: 200px
      border-radius: 30px
      overflow: hidden
      display: inline-block
      vertical-align: middle
      margin: 12px 14px
      img.wave
        position: absolute
        top: 0px
        left: 0px
        z-index: 0
        width: 175px
        border-top-left-radius: 30px
        border-top-right-radius: 30px
        height: 72px
      .container
        position: relative
        width: 100%
        height: 100%
        background-image: url('../../img/work_collect/white_wave_big_1.png')
        background-repeat: no-repeat
        background-position: 0px 48px
        background-size: 350px
        transition: all 0.3s ease-out
        &:hover
          background-position: -175px 48px
        .title
          width: 88%
          color: #fff
          text-align: center
          padding-top: 5px
          white-space: nowrap
          overflow: hidden
          text-overflow: ellipsis
          margin: 0 auto
          font-size: 14px
          &.solo
            padding-top: 20px
            font-size: 16px
        .btn-box
          position: relative
          margin-top: 9px
          text-align: center
          .placeholder
            height: 25px
          &.below
            margin-top: 12px
          .number
            height: 25px
            position: relative
            .icon
              background-repeat: no-repeat
              background-size: 10px
              display: inline-block
              vertical-align: middle
              font-size: 14px
              color: #666666
              width: 38px
              box-sizing: border-box
              padding-left: 8px
              &.grey-wrong-icon
                background-image: url('../../img/work_collect/grey_wrong.png')
                background-position: 0px 5px
              &.grey-check-icon
                background-image: url('../../img/work_collect/grey_check.png')
                background-position: 0px 5px
              &.wrong-icon
                background-image: url('../../img/work_collect/wrong_icon.png')
                background-position: 0px 5px
              &.check-icon
                position: relative
                left: 6px
                margin-right: 20px
                background-position: 0px 6px
                background-image: url('../../img/work_collect/check_icon.png')
          .text
            font-size: 14px
            height: 25px
            .label
              display: inline-block
              vertical-align: middle
              color: #666666
              margin-right: 6px
            .result
              display: inline-block
              vertical-align: middle
              color: #FAA215
          .button
            cursor: pointer
            width: 116px
            height: 33px
            background-repeat: no-repeat
            background-size: 100% 100%
            display: inline-block
            color: white
            font-size: 14px
            padding-top: 5px
            box-sizing: border-box
            &.yellow
              background-image: url('../../img/work_collect/yellow_button.png')
              &:hover
                opacity: 0.8
            &.red
              background-image: url('../../img/work_collect/red_button.png')
              &:hover
                opacity: 0.8
            &.grey
              background-image: url('../../img/work_collect/grey_button.png')
              cursor: not-allowed
      
.pages-pic
  position: absolute
  top: 0
  right: -44px
  width: 70px
  z-index: -1
  height: 547px
  background-image: url('../../img/work_collect/pages.png')
  background-repeat: no-repeat
  background-size: 100% 100%
.shadow
  position: absolute
  width: 1005px
  height: 493px
  top: 50px
  left: 0
  box-shadow: -12px 0 80px #2a2248
  border-radius: 30px
  z-index: -1
.left-side
  position: absolute
  top: 0
  left: -17px
  background-image: url('../../img/work_collect/yellow_edge.png')
  background-size: 100% 100%
  width: 80px
  height: 547px
  background-position: 0 0
.top-bar
  width: 941px
  height: 45px
  background: #6F50CC
  border-radius: 0px 30px 0px 0px
  overflow-x: auto
  &::-webkit-scrollbar
    height: 3px
  &::-webkit-scrollbar-thumb
    border-radius: 999px
    background-color: #9d81ef
  .sec-item-box
    white-space: nowrap
    position: relative
    top: 7px
    padding-left: 10px
    .sec-item
      display: inline-block
      vertical-align: middle
      margin-right: 10px
      cursor: pointer
      color: #FFFFFF
      text-align: center
      height: 32px
      line-height: 32px
      border-radius: 17px
      padding: 0 14px
      &:hover
        background-color: rgba(0,0,0,0.2)
      &.active
        background-color: rgba(0,0,0,0.15)
.filter
  position: absolute
  top: 52px
  right: 152px
  z-index: 1
  &.unit
    top: 52px
    right: 58px
  .btn
    cursor: pointer
    .current
      color: #fff
      font-size: 14px
    .arrow
      border-top: 3px solid #fff
      border-left: 3px solid transparent
      border-bottom: 3px solid transparent
      border-right: 3px solid transparent
      position: absolute
      top: 10px
      right: -10px
      transform-origin: top
      &.active
        transform: rotate(180deg)
  .menu
    position: absolute
    background-image: url('../../img/work_collect/dropdownmenugb.png')
    background-repeat: no-repeat
    background-size: 100%
    background-position: bottom
    width: 116px
    height: 205px
    top: 0px
    left: -19px
    cursor: pointer
    border-radius: 10px
    .item-box
      width: 94%
      height: 146px
      overflow-y: auto
      color: #fff
      margin-top: 47px
      font-size: 16px
      &::-webkit-scrollbar
        width: 3px
      &::-webkit-scrollbar-thumb
        border-radius: 999px
        background: rgba(255, 255, 255, 0.8)
      .menu-item
        line-height: 30px
        text-indent: 16px
        &:hover
          background-color: rgba(0, 0, 0, 0.2)
        &.active
          background-color: rgba(0, 0, 0, 0.3)
.none-list-place-holder
  text-align: center
  width: 400px
  height: 400px
  background-image: url('../../img/common/net-error.png')
  background-repeat: no-repeat
  background-size: 216px
  background-position: center
  margin: 0 auto
  color: white
  font-size: 20px
  padding: 354px 0 0 32px
  box-sizing: border-box
</style>
