<template lang="jade">
  .evaluate-home
    full-page-loading(v-if="isFullPageLoadingShow",:loadingText="loadingText")
    .evalute-bg
    top-part(:title_cn = "title_chinese", :title_eng = "title_english", :isAbsoluteFix = "true", :gobackurl="''", :mark="'libarary_detail'")
    .evalute-ufo(v-if="isNormalView")
      .evalute-can-techer(v-if="isCanEvalute")
        .evalute-ufo-teacher(v-bind:class="{'dialgo-level3':cssLevels}")
          .evalute-ufo-dialog
            .evalute-ufo-teacher-text 宝贝是否愿意再次约{{teacherName}}老师的课
          img(:src="teacherAvatar").evaute-ufo-teahcer-potho
        .evalute-ufo-like(v-bind:class="{'level3':cssLevels&&isLikeTeacher == false}")
          .evalute-like.content(@click="chooseMood(true)")
            .evalute-img-like
            .evalue-eyes-left.eyes-style(v-bind:class="{'like-eyes-animation':isLikeTeacher}")
            .evalue-eyes-right.eyes-style(v-bind:class="{'like-eyes-animation':isLikeTeacher}")
            .evalute-text 愿意
            .evalute-like-choosed(v-if="isLikeTeacher")
          .evalute-dislike.content(@click="chooseMood(false)",v-bind:class="{'dislike-choosed':isLikeTeacher== false}")
            .evalute-img-dislike
            .evalue-eyes-dislike-left.eyes-style(v-bind:class='{"dislike-left-eye":isLikeTeacher== false}')
            .evalue-eyes-dislike-right.eyes-style(v-bind:class='{"dislike-right-eye":isLikeTeacher== false}')
            .evalute-text 不愿意
            .evalute-like-choosed(v-if="isLikeTeacher == false")
        .evalute-ufo-detail-mood(v-bind:class="{'fadeInEase':cssLevels&&!isLikeTeacher}", v-if="cssLevels&&(isLikeTeacher == false)")
          .evalute-item(
          v-for="(item,index) in commentsList",
          @click="chooseEvalute(index,item)",
          v-bind:class='{"choosed":item.choosed}'
          )
            p.evalute-item-text {{item.text}}
          .evalute-text 告诉VIPKID为什么吧？
        .evalute-ufo-button(@click="submitEvaluteInformation()" v-if="!cssLevels && moodIsChoosed ")
          .text 提交
        .evalute-ufo-button(@click="submitEvaluteInformation()" v-if= "(cssLevels&&isLikeTeacher&&moodIsChoosed) ||(!isLikeTeacher && cssLevels && isChoosed && moodIsChoosed)")
          .text 提交
      .evalute-can-not-teacher(v-if="!isCanEvalute")
        .evalute-can-not-img(v-bind:class='{"evalute-have-evaluted":canNotEvaluteStyle, "evalute-no-start-class":!canNotEvaluteStyle}')
        .evalute-can-not-title {{canNotEvaluteTitle}}
        .evalute-can-not-text  {{canNotEvaluteText}}
    .evalute-net-error-view(v-if="!isNormalView")
      .evalute-net-error-view-img
      .evalute-net-error-text 网络连接好像有点问题，是否重新尝试？
      .evalute-net-error-refresh-button(@click="refreshView")
        .text 刷新重试
</template>
<script>
  import axios from "axios"
  import cookies from "cookies-js"
  import formurlencoded from 'form-urlencoded'
  import TopPart from '../common/top_part.vue'
  import fullPageLoading from "../common/vk_turn_page_loading.vue"
  import defaultTeacherImg from "../../img/user-imag@2x.png"
  export default {
    data(){
      return {
        title_chinese: '',
        title_english: '',
        onlineClassId: this.$route.params.onlineClassId,
        commentsList: [],
        comments: [],
        level: 0,
        teacherName: '',
        isLikeTeacher: null, //默认喜欢老师
        loadingText: '评价信息提交中...',
        isFullPageLoadingShow: false,
        commentEnterClassroomId: 0,
        teacherAvatar: defaultTeacherImg,//教师图片地址
        canNotEvaluteTitle: '还不能评价哦～',
        canNotEvaluteText: '宝贝还没上课，上完课才能选择是否愿意再上哦~',
        isCanEvalute: false,
        canNotEvaluteStyle: false,
        isNormalView: true,
        isChoosed: false,
        moodIsChoosed: false
      }
    },
    components: {
      TopPart,
      fullPageLoading
    },
    computed: {
      cssLevels(){
        if (this.level > 2) {
          return true
        }
        return false
      }
    },
    methods: {
      getCommentList(){
        let promise = axios.get("/rest/learninggw/api/point/comment/getCommentEnterClassroom", {
          params: {
            onlineClassId: this.onlineClassId
          }
        })
        promise.then(res => {
          if (res.data.code == 200) {
            let data = res.data.data
            this.setCanEvaluteData(data)
          } else if (res.data.code == 499) {
            this.setCanNotEvaluteData()
          } else if (res.data.code == 400) {
            //网络异常
            this.setNetErrorWork()
          }
        }).catch(error => {
          this.setNetErrorWork()
        })
      },
      //设置网络异常
      setNetErrorWork(){
        this.isNormalView = false
      },
      //刷新网络
      refreshView(){
        location.reload()
      },
      //设置上课未开始的数据
      setCanNotEvaluteData(){
        this.isNormalView = true
        this.isCanEvalute = false
        this.canNotEvaluteStyle = false
        this.canNotEvaluteTitle = "还不能评价哦～"
        this.canNotEvaluteText = "宝贝还没上课，上完课才能选择是否愿意再上哦~"
      },
      //设置能够评价的数据
      setCanEvaluteData(data){
        let commentsList = data.commentList
        this.level = data.lessonLevel
        if (typeof data.teacherAvatar == "string" && data.teacherAvatar.length > 0 && data.teacherAvatar !== "null") {
          this.teacherAvatar = data.teacherAvatar
        } else {
          this.teacherAvatar = defaultTeacherImg
        }
        this.teacherName = data.teacherName
        this.commentEnterClassroomId = data.commentEnterClassroomId
        this.isNormalView = true
        commentsList.map((item, index) => {
          //过滤key==0的脏数据
          if (item.key !== 0) {
            let temItem = {}
            temItem.text = item.value
            temItem.key = item.key.toString()
            temItem.choosed = false
            this.commentsList.push(temItem)
          }
        })
        if (data.commentStatus !== 0) {
          this.isCanEvalute = false
          this.canNotEvaluteTitle = "任务已完成～"
          this.canNotEvaluteText = "任务已完成，不能重复做任务哦～"
          this.canNotEvaluteStyle = true
        } else {
          this.isCanEvalute = true
        }
      },
      //学生选择
      chooseEvalute(index, text){
        this.commentsList[index].choosed = !this.commentsList[index].choosed
        this.checkoutIsChoosed()
      },
      //检查是否被选择
      checkoutIsChoosed(){
        let result = this.commentsList.filter(list => list.choosed == true)
        if (result.length > 0) {
          this.isChoosed = true
        } else {
          this.isChoosed = false
        }
      },
      paddingComments(){
        let tempArray = []
        this.commentsList.map(item => {
          if (item.choosed) {
            let tempText = item.key
            tempArray.push(tempText)
          }
        })
        this.comments = tempArray.toString()
      },
      //选择是否喜欢老师
      chooseMood(flag){
        this.isLikeTeacher = flag
        let clickId = 'pc_learning_evalute_home_choose_like_teacher'
        if (!flag) {
          clickId = 'pc_learning_evalute_home_choose_dislike_teacher'
        }
        sa.track('learning_click', {
          'click_id': clickId
        })
        this.moodIsChoosed = true
      },
      //提交评价信息
      submitEvaluteInformation(){
        this.isFullPageLoadingShow = true
        this.paddingComments()
        let promise = axios.post('/rest/learninggw/api/point/comment/insertComment',
          formurlencoded({
            commentEnterClassroomId: this.commentEnterClassroomId,
            willing: this.isLikeTeacher ? 1 : 0,
            commentCodes: !this.isLikeTeacher && (this.comments.length > 0) ? this.comments : "0"
          })
        )
        promise.then(res => {
          this.isFullPageLoadingShow = false
          this.$router.push({path: `/evaluate_feedback/${this.isLikeTeacher.toString()}/${this.teacherName}`})
        }).catch(error => {
          this.isFullPageLoadingShow = false
          this.setNetErrorWork()
        })
        sa.track('learning_click', {
          'click_id': 'pc_learning_evalute_home_view_sumit_button'
        })
      }
    },
    mounted(){
      this.getCommentList()
    }
  }
</script>
<style lang="stylus" scoped>
  .evaluate-home
    position: absolute
    top: 0
    left: 0
    right: 0
    bottom: 0
    overflow: hidden
    font-family: "PingFangSC-Medium"

  .evalute-bg
    position: absolute
    width: 100%
    height: 100%
    background: url(../../img/index/bg/bg_star.png) no-repeat
    animation: starFlash 5s infinite
    z-index: -3

  @keyframes starFlash
    0%
      opacity: 1
    50%
      opacity: 0.1
    100%
      opacity: 1

  .evalute-ufo
    position: fixed
    margin-left: -656px
    left: 50%
    bottom: -40px
    width: 1312px
    height: 1030px
    background: url(../../img/evalute_teacher/evaluate-bg-ufo-1920-1080.png) no-repeat
    background-size: 1312px 1030px
    @media screen and (min-height: 660px)
      bottom: -80px

  .evalute-can-techer
    position: absolute
    height: 100%
    width: 100%

  .evalute-can-not-teacher
    position: absolute
    margin-top: -200px
    top: 56%
    width: 100%
    height: 400px

  .evalute-ufo-button
    position: absolute
    margin-left: -90px
    bottom: 140px
    left: 50%
    width: 180px
    height: 50px
    background: url(../../img/evalute_teacher/evaluate-teacher-button@2x.png) no-repeat
    background-size: 180px 50px
    &:hover
      opacity: .8
    .text
      padding-top: 6px
      height: 30px
      text-align: center
      font-size: 22px
      color: #fff
      line-height: 30px

  .evalute-ufo-detail-mood
    position: absolute
    margin-left: -300px
    left: 50%
    bottom: 201px
    width: 600px
    height: 159px
    background: url(../../img/evalute_teacher/evalute-questionbg.png) no-repeat
    background-size: 600px 159px
    opacity: 0
    z-index: 20
    .evalute-text
      position: absolute
      top: 0
      width: 100%
      margin-top: 29px
      height: 22px
      text-align: center
      font-size: 16px
      color: #fff
      line-height: 22px

  .evalute-item
    margin-top: 78px
    margin-right: 15px
    float: left
    width: 120px
    height: 40px
    color: #fff
    background: rgba(255, 255, 255, .4)
    border-radius: 28px
    box-sizing: border-box
    &:nth-child(1)
      margin-left: 30px
    &:hover
      opacity: .8
    &.choosed
      color: #8561ED
      border: 3px solid #8561ED
      background: #fff

  p.evalute-item-text
    text-align: center
    line-height: 40px

  .evalute-ufo-like
    position: absolute
    margin-left: -300px
    bottom: 326px
    left: 50%
    width: 600px
    height: 200px
    transition: bottom .8s ease-in 0s
    z-index: 30
    &.level3
      bottom: 366px
    .content
      position: absolute
      width: 198px
      height: 200px

  .evalute-like
    left: 60px
    background: url(../../img/evalute_teacher/evaluate-like.png) no-repeat center center
    background-size: 146px 146px
    .evalue-eyes-left
      left 58px
      top: 75px
    .evalue-eyes-right
      right: 58px
      top: 75px
    &:hover
      .evalue-eyes-left
        left 55px
        top: 75px
        animation-duration: 2.4s
        animation-name: DisLikeLeftToRight
        animation-iteration-count: infinite
        animation-timing-function: ease-in
      .evalue-eyes-right
        right: 55px
        top: 75px
        animation-duration: 2.4s
        animation-name: DisLikeLeftToRight
        animation-iteration-count: infinite
        animation-timing-function: ease-in

  .like-eyes-animation
    animation-duration: 1.2s
    animation-name: DisLikeLeftToRight
    animation-iteration-count: infinite
    animation-timing-function: ease-in

  .eyes-style
    position: absolute
    width: 12px
    height: 12px
    background: url(../../img/evalute_teacher/evalute_eye.png) no-repeat
    background-size: 12px 12px

  .evalute-dislike
    right: 60px
    background: url(../../img/evalute_teacher/evaluate-dislike@2x.png) no-repeat center center
    background-size: 146px 146px
    .evalue-eyes-dislike-left
      display: none
    .evalue-eyes-dislike-right
      display: none
    .dislike-left-eye
      display: block
      left: 62px
      top: 76px
      animation-duration: 2.4s
      animation-name: DisLikeLeftToRight
      animation-iteration-count: infinite
      animation-timing-function: ease-in
    .dislike-right-eye
      display: block
      right: 62px
      top: 76px
      animation-duration: 2.4s
      animation-name: DisLikeLeftToRight
      animation-iteration-count: infinite
      animation-timing-function: ease-in
    &:hover
      background: url(../../img/evalute_teacher/evalue-teacher-dislike.png) no-repeat center center
      background-size: 146px 146px
      .evalue-eyes-dislike-left
        display: block
        left: 62px
        top: 76px
        animation-duration: 2.4s
        animation-name: DisLikeLeftToRight
        animation-iteration-count: infinite
        animation-timing-function: ease-in
      .evalue-eyes-dislike-right
        display: block
        right: 62px
        top: 76px
        animation-duration: 2.4s
        animation-name: DisLikeLeftToRight
        animation-iteration-count: infinite
        animation-timing-function: ease-in

  .dislike-choosed
    background: url(../../img/evalute_teacher/evalue-teacher-dislike.png) no-repeat center center
    background-size: 146px 146px

  @keyframes DisLikeLeftToRight
    0%, 50%, 100%
      transform: translateX(0px)
    25%
      transform: translateX(10px)
    75%
      transform: translateX(-10px)

  .evalute-text
    position: absolute
    bottom: 8px
    width: 100%
    height: 25px
    text-align: center
    font-size: 18px
    color: #fff
    line-height: 25px

  .evalute-like-choosed
    position: absolute
    width: 198px
    height: 200px
    background: url(../../img/evalute_teacher/evaluate-slecetd.png)
    background-size: 198px 200px
    z-index: -1

  .evalute-ufo-teacher
    position: absolute
    left: 50%
    bottom: 520px
    margin-left: -250px
    height: 100px
    width: 500px
    @media screen and (min-width: 1280) and (max-width: 1367px)
      bottom: 480px
    &.dialgo-level3
      bottom: 582px

  .evalute-ufo-dialog
    position: absolute
    height: 100px
    width: 378px
    background: url(../../img/evalute_teacher/evalute-teacher-dialog.png) no-repeat
    background-size: 378px 100px

  .evaute-ufo-teahcer-potho
    position: absolute
    right: 10px
    box-sizing: border-box
    width: 100px
    height: 100px
    border-radius: 100%
    border: 4px solid #fff

  .evalute-ufo-teacher-text
    padding: 12px 0px 14px 37px;
    width: 300px;
    height: 74px
    font-size: 26px
    color: #8561ED
    text-align: cetner
    line-height: 37px
    word-wrap: break-word
    overflow: hidden

  //-----不能评价老师的样式
  .evalute-can-not-img
    margin-left: -206px
    position: absolute
    top: 0px
    bottom: 298px
    left: 50%
    width: 413px
    height 250px

  .evalute-can-not-title
    position: absolute
    top: 270px
    font-family: PingFangSC
    width: 100%
    height: 50px
    color: #fff
    text-align: center
    font-size: 36px
    font-weight: 700
    line-height: 50px

  .evalute-can-not-text
    position: absolute
    top: 320px
    font-family: PingFangSC
    width: 100%
    height: 25px
    color: #fff
    text-align: center
    font-size: 18px
    font-weight: 700
    line-height: 25px

  .evalute-have-evaluted
    background: url(../../img/evalute_teacher/evalute-finish-teacher.png) no-repeat
    background-size: 413px 250px

  .evalute-no-start-class
    background: url(../../img/evalute_teacher/evalute-no-start-class.png) no-repeat
    background-size: 413px 250px

  // 网络错误代码
  .evalute-net-error-view
    position: absolute
    margin-top: -200px
    top: 50%
    width: 100%
    height: 400px

  .evalute-net-error-view-img
    margin-left: -91px
    position: absolute
    left: 50%
    bottom: 135px
    width: 183px
    height: 191px
    background: url(../../img/common/net-error.png) no-repeat
    background-size: 183px 191px

  .evalute-net-error-text
    position: absolute
    bottom: 65px
    width: 100%
    color: #B396FF
    font-size: 37px
    text-align: center

  .evalute-net-error-refresh-button
    margin-left: -100px
    position: absolute
    left: 50%
    bottom: 0px
    width: 200px
    height: 50px
    background: url(../../img/evalute_teacher/evaluate-teacher-button@2x.png)
    background-size: 200px 50px
    &:hover
      opacity: .8
    .text
      line-height: 50px
      height: 50px
      color: #fff
      font-size: 22px
      text-align: center

  .fadeInEase
    animation-name: fadeInEase
    animation-delay: 0.9s
    animation-fill-mode: both
    animation-timing-function: ease-in
    animation-duration: .8s

  @keyframes fadeInEase
    0%
      display: block
      opacity: 0
    100%
      display: block
      opacity: 1
</style>
