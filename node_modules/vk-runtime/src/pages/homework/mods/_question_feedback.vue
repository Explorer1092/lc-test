<template>
  <div class="question-feedback">

    <div class="feedback-base feedback-wrapper-mini" v-show="hasminihomework && questionshowtype== 'mini'">
      <a class="fw-close" href="javascript:void(0);" v-on:click="feedbackClose"></a>
      <div class="fw-dinosaur">
        <img src="../../../img/common/dino_modalface_happy.png" />
      </div>
      <div class="fw-content">
        <div class="fw-title-mini">快速反馈</div>
        <div class="fw-main">
          <div class="fw-minititle">为了解决宝贝在作业中遇到的问题，VIPKID提供了“迷你版作业”赶快来体验一下吧！</div>
          <div class="fw-minititle fw-minititle-minihome">您也可以选择提交反馈，告诉我们遇到的问题～</div>
          <div class="fw-submit">
            <input v-on:click="storylineFeedback" class="active" type="button" value="问题反馈">
            <input v-on:click="switchMiniHomework" class="active ml-40" type="button" value="迷你版作业">
          </div>
        </div>
      </div>
    </div>

    <div class="feedback-base feedback-wrapper-mini" v-show="hasstandard && questionshowtype== 'standard'">
      <a class="fw-close" href="javascript:void(0);" v-on:click="feedbackClose"></a>
      <div class="fw-dinosaur">
        <img src="../../../img/common/dino_modalface_happy.png" />
      </div>
      <div class="fw-content">
        <div class="fw-title-mini">快速反馈</div>
        <div class="fw-main">
          <div class="fw-minititle">为了解决宝贝在作业中遇到的问题，VIPKID提供了“新版作业”赶快来体验一下吧！</div>
          <div class="fw-minititle fw-minititle-minihome">您也可以选择提交反馈，告诉我们遇到的问题～</div>
          <div class="fw-submit">
            <input v-on:click="storylineFeedback" class="active" type="button" value="问题反馈">
            <input v-on:click="switchStandardHomework" class="active ml-40" type="button" value="新版作业">
          </div>
        </div>
      </div>
    </div>

    <div class="feedback-base feedback-wrapper" v-show="!hasminihomework && !hasstandard && feedbackWrapper">
      <a class="fw-close" href="javascript:void(0);" v-on:click="feedbackClose"></a>
      <div class="fw-dinosaur">
        <img src="../../../img/common/dino_modalface_happy.png" />
      </div>
      <div class="fw-content">
        <div class="fw-title">宝贝遇到了什么问题？</div>
        <div class="fw-main">
          <div class="fw-minititle">选择你遇到的问题，我们会尽快为您解决</div>
          <ul class="fw-errors fn-clear">
            <li v-for="tag in tags" v-bind:class="{'active':tag.active}" v-on:click="selectQuestion(tag.id)">{{tag.title}}</li>
          </ul>
          <div class="fw-type">
            <input type="text" placeholder="请输入您遇到的其他问题" maxLength="100" v-model="customIssue">
          </div>
          <div class="fw-submit">
            <input type="button" v-bind:class="{active:submitActive}" value="提交" v-on:click="questionSubmit">
          </div>
        </div>
      </div>
    </div>

    <div class="feedback-base feedback-success" v-show="feedbackSuccess">
      <div class="fw-dinosaur">
        <img src="../../../img/common/dino_modalface_happy.png" />
      </div>
      <div class="fw-content">
        <div class="fw-title">Notice</div>
        <div class="fw-text">
          <p>问题反馈提交成功～</p>
          <p>我们会尽快为您处理</p>
          <a href="javascript:void(0);" v-on:click="feedbackSuccessIKnow">知道了</a>
        </div>
      </div>
    </div>
  </div>
</template>
<script type="text/javascript">
import {
  getHomeworkissueTag,
  homeworkissueSave
} from './_api.js'
import cookies from 'cookies-js'
import { getDeviceType } from './_toolsFunction.js'
export default {
  props: ['questionshowtype', 'hasstandard', 'hasminihomework', 'homeworkid'],
  data() {
    return {
      feedbackSuccess: false,
      feedbackWrapper: true,
      customIssue: '',
      submitActive: false,
      tags: []
    }
  },
  watch: {
    customIssue: function() {
      this.switchSubmitClass()
    }
  },
  mounted() {
    getHomeworkissueTag().then(res => {
      let tempTags = res.data.data.tags
      for (let i = 0; i < tempTags.length; i++) {
        tempTags[i].active = false
      }
      this.tags = tempTags
    })
  },
  methods: {
    storylineFeedback() {
      this.hasminihomework = false
      this.hasstandard = false
    },
    feedbackClose() {
      this.$emit('emit-feedbackclose')
    },
    switchMiniHomework() {
      this.$emit('emit-feedbackclose')
      this.$emit('emit-switchminihomework')
    },
    switchStandardHomework(){
      this.$emit('emit-feedbackclose')
      this.$emit('emit-switchstandardhomework')
    },
    questionSubmit() {
      if (!this.submitActive) {
        return
      }
      let selectedIssues = []
      for (let i = 0; i < this.tags.length; i++) {
        if (this.tags[i].active) {
          let tempObj = {
            issueTagId: this.tags[i].id,
            issueTagContent: this.tags[i].title
          }
          selectedIssues.push(tempObj)
        }
      }
      let params = {
        type: this.$route.params.type,
        studentId: cookies.get('studentId'),
        homeworkId: this.homeworkid,
        client: getDeviceType,
        model: navigator.userAgent,
        customIssue: this.customIssue,
        issues: selectedIssues
      }
      homeworkissueSave(JSON.stringify(params)).then(res => {
        this.feedbackSuccess = true
        this.feedbackWrapper = false
      }).catch(error => {
        alert('网络异常，请重试！')
      })
    },
    feedbackSuccessIKnow() {
      this.feedbackSuccess = false
      this.feedbackWrapper = true
      this.$emit('emit-feedbackclose')
    },
    switchSubmitClass() {
      if (this.customIssue) {
        this.submitActive = true
      } else {
        for (let i = 0; i < this.tags.length; i++) {
          if (this.tags[i].active) {
            this.submitActive = true
            break
          } else {
            this.submitActive = false
          }
        }
      }
    },
    selectQuestion(id) {
      for (let i = 0; i < this.tags.length; i++) {
        if (this.tags[i].id == id * 1) {
          this.tags[i].active = !this.tags[i].active
          break
        }
      }
      this.switchSubmitClass()
    }
  }
}
</script>

<style lang="stylus" scoped>
.question-feedback
  position: fixed
  left: 0
  top: 0
  width: 100%
  height: 100%
  background: rgba(0,0,0,.7)
  z-index: 2
  .feedback-base
    position: absolute
    left: 50%
    top: 50%
    border-radius: 20px
    z-index: 2
    a.fw-close
      position: absolute
      right: -10px
      top: -10px
      width: 40px
      height: 40px
      background: url('../../../img/homework/closed.png') no-repeat center
      background-size: 40px 40px
    .fw-dinosaur
      position: absolute
      top: -80px
      left: 50%
      margin-left: -121px
      width: 242px
      height: 91px
      img
        width: 100%
    .fw-content
      width: 100%
      height: 100%
      box-sizing: border-box
      background-color: #fff
      border: 5px solid #8f82bc
      border-radius: 16px
      .fw-title-mini
        text-align: center
        color: #fff
        font-size: 24px
        background-color: #8f82bc
        height: 80px
        line-height: 80px
        height: 58px
        line-height: 58px
      .fw-title
        text-align: center
        color: #fff
        font-size: 24px
        background-color: #8f82bc
        height: 80px
        line-height: 80px
      .fw-main
        padding: 0 45px
        .fw-minititle-minihome
          font-size: 16px !important
          color: #999 !important
        .fw-minititle
          margin-top: 20px
          margin-bottom: 15px
          color: #333
          font-size: 18px
          line-height: 25px
          text-align: center
        ul.fw-errors
          margin-right: -15px
          li
            float: left
            margin-right: 12px
            margin-bottom: 20px
            width: 162px
            height: 40px
            line-height: 40px
            font-size: 18px
            color: #666
            border-radius: 30px
            border: 1px solid #d9d9d9
            text-align: center
            cursor: pointer
            &.active
              // background-color: #ff6600
              color: #ff6600
              border: 1px solid #ff6600
        .fw-type
          width: 100%
          input
            width: 100%
            height: 40px
            font-size: 18px
            border: 1px solid #d9d9d9
            border-radius: 30px
            text-indent: 20px
            color: #666
            &:focus
              outline: none
            &::placeholder
              color: #999
        .fw-submit
          margin-top: 20px
          text-align: center
          .ml-40
            margin-left: 40px
          input,a
            display: inline-block
            width: 142px
            height: 40px
            line-height: 40px
            color: #fff
            font-size: 18px
            text-decoration: none
            background: url('../../../img/homework/button-disable.png') no-repeat center
            background-size: 142px 40px
            cursor: not-allowed
            border: none
            padding: 0
          input:focus
            outline: none
          input.active,a.active
            background: url('../../../img/homework/button-confirmed.png') no-repeat center
            background-size: 142px 40px
            cursor: pointer
            &:hover
              background: url('../../../img/homework/button-hover.png') no-repeat center
              background-size: 142px 40px
          input.visited
            background: url('../../../img/homework/button-click.png') no-repeat center
            background-size: 142px 40px
  .feedback-wrapper
    margin-left: -308px
    margin-top: -197px
    width: 616px
    height: 395px
  .feedback-wrapper-mini
    margin-left: -232px
    margin-top: -157px
    width: 464px
    height: 273px

  .feedback-success
    width: 400px
    height: 277px
    margin-left: -200px
    margin-top: -138px
    .fw-content
      .fw-title
        height: 68px
        line-height: 68px
        font-size: 30px
      .fw-text
        text-align: center
        margin-top: 42px
        p
          color: #666
          font-size: 16px
          line-height: 24px
        a
          display: inline-block
          margin-top: 45px
          width: 142px
          height: 40px
          background: url('../../../img/homework/button-confirmed.png') no-repeat center
          background-size: 142px 40px
          color: #fff
          font-size: 18px
          line-height: 40px
          text-decoration: none
          &:hover
            background: url('../../../img/homework/button-hover.png') no-repeat center
            background-size: 142px 40px
        a.visited
          background: url('../../../img/homework/button-click.png') no-repeat center
          background-size: 142px 40px
  

</style>