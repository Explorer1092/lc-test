<template lang="jade">
  .homework-wrapper
    homework-header(
      v-show="homeworkHeaderData.show" 
      v-bind:big-title="homeworkHeaderData.bigTitle"
      v-bind:sub-title="homeworkHeaderData.subTitle",
      :fromUrlProp="vmFromUrl")

    .page-iframe(v-show="iframeData.pageIframeShow" id="js-iframe-wrap")
      iframe(src="" id="js-iframe" frameborder="0")

    homework-result(
      v-show="homeworkResult.homeworkResultShow"
      v-bind:result-right-number="homeworkResult.resultRightNumber"
      v-bind:result-wrong-number="homeworkResult.resultWrongNumber"
      v-bind:result-time="homeworkResult.resultTime"
      v-on:emit-replayeventclick="repalyEventClick")

</template>
<script>
import Vue from 'vue'
import queryString from 'query-string'
import homeworkHeader from '../mods/homework_header.vue'
import homeworkResult from '../mods/_homework_result.vue'
import {
  getActivityHomework,
  homeworkReplayAndInit,
  saveResultItem
} from '../mods/_api.js' 
import { isFromAppClient, isOldVipkidClient, isVipkidClient, getQueryString } from '../mods/_toolsFunction.js'
import { messagePostOffice } from '../mods/message_manager.js'
const TWO_WAY_ACTION_INFO = {
  breakpoint: 'container:breakpoint continuation', //断点续答消息值
  singleItemError: 'container:single item save error' //单题保存消息值
}
const VOYAGER = 'voyager'
let fromUrl = null

export default {
  beforeRouteEnter (to, from, next) {
    next()
    fromUrl = from.path
  },
  data() {
    return {
      vmFromUrl: fromUrl,
      postOfficeObj: new messagePostOffice().createMessageManager(this.receiveMessage),
      homeworkHeaderData: {
        show: true,
        bigTitle: '',
        subTitle: ''
      },
      homeworkResultId: '',
      homeworkType: {
        data: {}
      },
      homeworkResult: {
        homeworkResultShow: false,
        resultRightNumber: '',
        resultWrongNumber: '',
        resultTime: ''
      },
      iframeData: {
        pageIframeShow: true
      }
    }
  },
  props: [],
  components: {
    homeworkHeader,
    homeworkResult
  },
  watch: {
      
  },
  mounted() {
    getActivityHomework(this.$route.params.studentId, this.$route.params.readerCode, this.$route.params.bookId).then(res => {
      let data = res.data.data
      let targetUrl = getQueryString('targetUrl')
        
      if (targetUrl) {
        data.url = targetUrl
      }
      this.homeworkType.data = data
      this.homeworkHeaderData.bigTitle = data.title
      this.homeworkHeaderData.subTitle = data.subTitle
      document.title = data.title
      this.iframeSettingAndShow(data.url)
    })
  },
  methods: {
    repalyEventClick() {
      this.iframeData.pageIframeShow = true
      this.homeworkResult.homeworkResultShow = false
      this.homeworkType.data.breakpoint.lastFinished = 1
      this.iframeSettingAndShow(this.homeworkType.data.url)
    },
    iframeSettingAndShow(homeworkUrl) {
      if (isFromAppClient()) {
        document.getElementById("js-iframe-wrap").style.width = "96%"
        var widthIpad = document.getElementById('js-iframe-wrap').clientWidth
        var heightIpad = widthIpad * 54 / 95
        var xIpad = widthIpad / 96 * 2
        var yIpad = 120
        this.iframeData.pageIframeShow = false
        let param = ''
        param += '?x=' + xIpad
        param += '&y=' + yIpad
        param += '&width=' + widthIpad
        param += '&height=' + heightIpad

        this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.setInterViewFrame + param)
      } else {
        this.iframeData.pageIframeShow = true
        var winWd = window.innerWidth
        var winHt = window.innerHeight
        var titleZoneHeight = 81

        var iframeWrapHt = winHt - titleZoneHeight
        var iframeWrapWd = iframeWrapHt * 95 / 54

        if (iframeWrapWd > winWd) {
          iframeWrapWd = winWd * 0.9
          iframeWrapHt = iframeWrapWd * 54 / 95
        }
        document.getElementById('js-iframe-wrap').style.width = iframeWrapWd + "px"
        document.getElementById('js-iframe-wrap').style.height = iframeWrapHt + "px"
        document.getElementById('js-iframe-wrap').innerHTML = '<iframe src="" id="js-iframe" frameborder="0"></iframe>'
        document.getElementById('js-iframe').setAttribute('src', homeworkUrl)
        document.getElementById('js-iframe').style.width = iframeWrapWd + "px"
        document.getElementById('js-iframe').style.height = iframeWrapHt + "px"
      }
    },
    receiveMessage(message) {
      if (message && message.code && message.code == 'api is ready') {
        if (this.homeworkType.data.breakpoint.lastFinished === 0) {
          this.homeworkResultId = this.homeworkType.data.breakpoint.homeworkResultId
          let msg = {
            action: TWO_WAY_ACTION_INFO.breakpoint, // 断点续答消息值
            target: VOYAGER,
            params: this.homeworkType.data.breakpoint
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
        } else {
          // mini 作业和activity作业需要 进行初始化 homeworkResultId
          homeworkReplayAndInit(205, this.homeworkType.data.studentHomeworkId).then(res => {
            if (res.data.data && res.data.data.homeworkResultId) {
              this.homeworkResultId = res.data.data.homeworkResultId
            }
          })
        }
        this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.loadingStop)
      } else {
        if (message && message.action && message.action == 'breakpoint_replay') {
          // mini 作业和activity作业需要 进行初始化 homeworkResultId
          homeworkReplayAndInit(205, this.homeworkType.data.studentHomeworkId).then(res => {
            if (res.data.data && res.data.data.homeworkResultId) {
              this.homeworkResultId = res.data.data.homeworkResultId
            }
          })
          sa.track('pc_trigger', { 'trigger_id': 'activity_homework_breakpoint_replay' })
        } else if (message && message.action && message.action == 'breakpoint_close') {
          // mini 作业和activity作业需要 进行初始化 homeworkResultId
          homeworkReplayAndInit(205, this.homeworkType.data.studentHomeworkId).then(res => {
            if (res.data.data && res.data.data.homeworkResultId) {
              this.homeworkResultId = res.data.data.homeworkResultId
            }
          })
          sa.track('pc_trigger', { 'trigger_id': 'activity_homework_breakpoint_close' })
        } else if (message && message.action && message.action == 'breakpoint_continue') {
          sa.track('pc_trigger', { 'trigger_id': 'activity_homework_breakpoint_continue' })
        } else {
          this.messageRecieveHandler(message)
        }
      }
    },
    messageRecieveHandler(message) {
      // 基本格式校验，避免IE9无限消息抛送
      if (/[F|T]+:[\d]+:[\d]+/.test(message) || (message.hasOwnProperty('action') && message.hasOwnProperty('params'))) {
        var homework = this.homeworkMessageParser(message)
        // result : 保存作业结果
        // finish : 作业结束，显示结果
        // active : 用户打点消息
        // score  : 新的作业的总的结果
        // answer : 单题结果，并保存单题结果
        // result_finish : 保存结果，并展示结果
        if (homework.action === 'finish') {
          this.showScore(homework.params)
        } else if (homework.action === 'result_finish') {
          this.showScore(homework.params)
        } else if (homework.action === 'score') {
          let homeworkResult = homework.params.data.join('') + ':' + homework.params.start + ':' + homework.params.end
          this.showScore(homeworkResult)
        } else if (homework.action === 'answer') {
          this.saveAnswer(homework.params)
        }
      }
    },
    homeworkMessageParser(message) {
      if (message.hasOwnProperty('action') && message.hasOwnProperty('params')) {
        return message
      } else {
        return {
          'action': 'result_finish',
          'params': message
        }
      }
    },
    showScore(resultMessage) {
      var result = resultMessage.split(':')

      var homework = {
        'result': result[0],
        'startTime': parseInt(result[1], 10),
        'endTime': parseInt(result[2], 10)
      }

      var duration = homework.endTime - homework.startTime
      var minutes = parseInt((duration / 1000) / 60, 10)
      var seconds = parseInt((duration / 1000) % 60, 10)
      minutes = minutes >= 10 ? minutes : '0' + minutes
      seconds = seconds >= 10 ? seconds : '0' + seconds

      var rNum = 0
      var wNum = 0
      for (var index = 0; index < homework.result.length; index++) {
        homework.result[index] === 'T' ? rNum++ : wNum++
      }
      this.homeworkResult.resultRightNumber = 'x' + rNum
      this.homeworkResult.resultWrongNumber = 'x' + wNum
      this.homeworkResult.resultTime = minutes + ':' + seconds

      this.iframeData.pageIframeShow = false
      this.homeworkResult.homeworkResultShow = true

      this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.webViewClose)
      this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.didSubmitResult)
    },
    saveAnswer(answer) {
      saveResultItem(
        205,
        this.homeworkResultId,
        answer.stage_id,
        answer.select.toString(),
        answer.right,
        answer.start,
        answer.end,
        answer.routeName,
        answer.isBreakPoint ? 1 : 0,
        answer.isLastItem ? 1 : 0
      ).then(res => {
        if (res.data && res.data.code != 200) {
          let msg = {
            action: TWO_WAY_ACTION_INFO.singleItemError, //单题保存消息值
            target: VOYAGER,
            params: answer
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
          sa.track('pc_trigger', { 'trigger_id': 'activity_homework_answer_save_failed' })
        } else {
          if (answer.isLastItem === 1) {
            sa.track('pc_trigger', { 'trigger_id': 'activity_homework_save_success' })
          }
        }
        // 这里发送单体保存成功提示
      }).catch(e => {
        // 这里发送单体保存失败消息
        let msg = {
          action: TWO_WAY_ACTION_INFO.singleItemError, //单题保存消息值
          target: VOYAGER,
          params: answer
        }
        this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
        sa.track('pc_trigger', { 'trigger_id': 'activity_homework_answer_save_failed' })
      })
    }

  }
}
</script>

<style lang="stylus" scoped>
.homework-html
  height: 100%

.homework-body
  background: #302a35 url("../../../img/homework/bg.png") no-repeat center center fixed;
  -webkit-background-size: cover
  background-size: cover
  height: 100%
.homework-wrapper
  .page-iframe
    width: 90%
    margin: 0 auto
                  
</style>
