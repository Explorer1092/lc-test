<template lang="jade">
  .homework
    homework-header(
      v-show="homeworkHeaderData.show",
      :big-title="homeworkHeaderData.bigTitle",
      :sub-title="homeworkHeaderData.subTitle",
      :switchminishow="switchminishow",
      :commonproblemshow="commonproblemshow",
      :homeworkresultshow="homeworkResult.homeworkResultShow",
      :fromUrlProp="vmFromUrl",
      @emit-feedbackshow="feedbackshow",
      :hasstandard="feedbackData.hasStandard",
      :hasminihomework="feedbackData.hasminihomework",
      @emit-switchminihomework="switchMiniHomework",
      @emit-switchstandardhomework="switchStandardHomework",
      :lessonId = "lessonIdFromUrl",
      :homeworkid="homeworkType.storyline.data.studentHomeworkId")

    .page-iframe(v-show="iframeData.pageIframeShow" id="js-iframe-wrap")
      iframe(src="" id="js-iframe" frameborder="0")
    .page-iframe-standard(v-show="pageIframeStandard" id="js-iframe-wrap-standard")
      iframe(src="" id="js-iframe-standard" v-show="pageIframeStandard" frameborder="0")

    question-feedback(
      v-show="feedbackData.questionFeedbackShow",
      :hasminihomework="feedbackData.hasminihomework",
      :hasstandard="feedbackData.hasStandard",
      :questionshowtype="feedbackData.questionShowType",
      :homeworkid="homeworkType.storyline.data.studentHomeworkId",
      @emit-feedbackclose="feedbackshow",)

    homework-result(
      v-show="homeworkResult.homeworkResultShow",
      :result-right-number="homeworkResult.resultRightNumber",
      :result-wrong-number="homeworkResult.resultWrongNumber",
      :result-time="homeworkResult.resultTime",
      @emit-replayeventclick="replayEventClick")
    
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import TopPart from '../common/top_part.vue'
  import homeworkHeader from './mods/homework_header.vue'
  import questionFeedback from './mods/_question_feedback.vue'
  import homeworkResult from './mods/_homework_result.vue'
  import { messagePostOffice } from './mods/message_manager.js'
  
  import {
    getHomework,
    getActivityHomework,
    storylineSaveResult,
    homeworkReplayAndInit,
    homeworkReplayAndSectionIdsInit,
    saveResultItem
  } from './mods/_api.js'

  import { isFromAppClient, isOldVipkidClient, isVipkidClient, getQueryString } from './mods/_toolsFunction.js'
  let targetUrl = getQueryString('targetUrl')
  let fromUrl = null
  const TWO_WAY_ACTION_INFO = {
    breakpoint: 'container:breakpoint continuation', //断点续答消息值
    standardBreakpoint: 'container:standard breakpoint continuation',
    standardBusinessData: 'container:standard business data',
    singleItemError: 'container:single item save error' //单题保存消息值
  }
  const VOYAGER = 'voyager'

  export default {
    beforeRouteEnter (to, from, next) {
      next()
      fromUrl = from.path
    },
    data() {
      return {
        lessonIdFromUrl: '',
        homeWorkTypeFromRouter: this.$route.params.type,
        vmFromUrl: fromUrl,
        postOfficeObj: {},
        homeworkHeaderData: {
          show: false,
          bigTitle: '',
          subTitle: ''
        },
        doHomeworkingType: 'storyline',
        homeworkResultId: '',
        lessonSn: '', // 打点需要的课程序号
        homeworkType: {
          storyline: {
            has: false,
            data: {}
          },
          mini: {
            has: false,
            data: {}
          },
          standard: {
            has: false,
            data: {}
          }
        },
        sectionIds: {},
        switchminishow: true,
        commonproblemshow: true, // 作业做完隐藏常见问题按钮
        commontRequestParams: {

        },
        feedbackData: {
          questionFeedbackShow: false,
          hasminihomework: false,
          hasStandard: false,
          questionShowType: null,
          firstShowType: 'storyline'
        },
        pageIframeStandard: false,
        homeworkResult: {
          homeworkResultShow: false,
          resultRightNumber: '',
          resultWrongNumber: '',
          resultTime: ''
        },
        iframeData: {
          pageIframeShow: true
        },
        testStoryLineMessage: { // 为了方便测试 storyline 弄得假数据 调用方法： this.messageRecieveHandler(this.testStoryLineMessage.messageFinish)
          messageResult: {
            action: "result",
            params: "FTFFFTFFTFFFFFF:1508830189542:1508830780053"
          },
          messageFinish: {
            action: "finish",
            params: "FTFFFTFFTFFFFFF:1508830189542:1508830780053"
          },
          messageResult_finish: {}
        }
      }
    },
    components: {
      TopPart,
      homeworkHeader,
      questionFeedback,
      homeworkResult
    },
    mounted() {
      this.lessonIdFromUrl = this.$route.params.lessonId
      getHomework(this.$route.params.studentId, this.$route.params.lessonId, this.$route.params.type, getQueryString('curriculumVersion')).then(res => {
        let data = res.data.data
        if(data.showpoint) {
          this.feedbackData.questionShowType = data.showpoint.question //问题反馈情况中的作业类型
          this.feedbackData.firstShowType = data.showpoint.first //初始化页面的作业类型
        }
        if (isFromAppClient() && data.standard ) {
          //iPad APP
          this.homeworkHeaderData.show = false
          this.feedbackData.questionFeedbackShow = false
          this.homeworkResult.homeworkResultShow = false
          this.iframeData.pageIframeShow = false

          if (targetUrl) {
            data.standard.url = targetUrl
          }
          this.lessonSn = data.standard.lessonSn
          this.feedbackData.hasStandard = true
          this.homeworkType.standard.has = true
          this.homeworkType.standard.data = data.standard
          document.title = data.standard.title
          this.homeworkResultId = data.standard.homeworkResultId
          this.postOfficeObj = new messagePostOffice().createMessageManager(this.standardReceiveMessage)
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.setFullScreen)
        } else {
          if( this.feedbackData.firstShowType == "standard" && data.standard ) {
            //直接全屏展示standard作业
            this.homeworkHeaderData.show = false
            this.feedbackData.questionFeedbackShow = false
            this.homeworkResult.homeworkResultShow = false
            this.iframeData.pageIframeShow = false
            if (targetUrl) {
              data.standard.url = targetUrl
            }
            this.lessonSn = data.standard.lessonSn
            this.feedbackData.hasStandard = true
            this.homeworkType.standard.has = true
            this.homeworkType.standard.data = data.standard
            document.title = data.standard.title
            this.homeworkResultId = data.standard.homeworkResultId
            this.postOfficeObj = new messagePostOffice().createMessageManager(this.standardReceiveMessage)
            this.pageIframeStandard = true
            document.getElementById('js-iframe-standard').setAttribute('src', data.standard.url)
            sa.track('pc_trigger', { 'trigger_id': 'standard_homework_start', 'lesson_sn': this.lessonSn })
          } else {
            //先展示story line
            this.postOfficeObj = new messagePostOffice().createMessageManager(this.receiveMessage)
            this.homeworkHeaderData.show = true
            if (data.storyline) {
              this.homeworkType.storyline.has = true
              this.homeworkType.storyline.data = data.storyline
              this.homeworkHeaderData.bigTitle = data.storyline.title
              this.homeworkHeaderData.subTitle = data.storyline.subTitle
              document.title = data.storyline.title
              if (targetUrl) {
                data.storyline.url = targetUrl
              }
              this.lessonSn = data.storyline.lessonSn
              this.iframeSettingAndShow(data.storyline.url)
            }
            if (data.mini) {
              this.feedbackData.hasminihomework = true
              this.homeworkType.mini.has = true
              this.homeworkType.mini.data = data.mini
            }
            if(data.standard){
              this.feedbackData.hasStandard = true
              this.homeworkType.standard.has = true
              this.homeworkType.standard.data = data.standard
            }
          }
        }
        sa.track('pc_trigger', { 'trigger_id': 'homework_start', 'lesson_sn': this.lessonSn })
      })
     
    },
    methods: {
      feedbackshow() {
        this.feedbackData.questionFeedbackShow = !this.feedbackData.questionFeedbackShow
        if (this.feedbackData.questionFeedbackShow) {
          sa.track('pc_trigger', { 'trigger_id': 'problem_feedback_start', 'lesson_sn': this.lessonSn })
        }
      },
      replayEventClick() {
        this.iframeData.pageIframeShow = true
        this.homeworkResult.homeworkResultShow = false
        if (this.doHomeworkingType == 'mini') {
          this.homeworkType.mini.data.breakpoint.lastFinished = 1
          this.iframeSettingAndShow(this.homeworkType[this.doHomeworkingType].data.url)
        } else {
          this.iframeSettingAndShow(this.homeworkType[this.doHomeworkingType].data.url)
        }
        sa.track('pc_trigger', { 'trigger_id': 'homework_replay', 'lesson_sn': this.lessonSn })
      },
      switchMiniHomework() {
        this.switchminishow = false // 切换mini作业问题反馈按钮将被隐藏
        this.doHomeworkingType = 'mini'
        this.iframeSettingAndShow(this.homeworkType.mini.data.url)
        sa.track('pc_trigger', { 'trigger_id': 'mini_homework_start', 'lesson_sn': this.lessonSn })
      },
      switchStandardHomework() {
        this.switchminishow = false // 切换standard作业问题反馈按钮将被隐藏

        this.homeworkHeaderData.show = false
        this.feedbackData.questionFeedbackShow = false
        this.homeworkResult.homeworkResultShow = false
        this.iframeData.pageIframeShow = false

        document.title = this.homeworkType.standard.data.title
        this.homeworkResultId = this.homeworkType.standard.data.homeworkResultId
        this.postOfficeObj = new messagePostOffice().createMessageManager(this.standardReceiveMessage)
        this.pageIframeStandard = true
        document.getElementById('js-iframe-standard').setAttribute('src', this.homeworkType.standard.data.url)
        // document.getElementById('js-iframe').setAttribute('src','')

        sa.track('pc_trigger', { 'trigger_id': 'standard_homework_start', 'lesson_sn': this.lessonSn })
      },
      iframeSettingAndShow(homeworkUrl) {
        if (isFromAppClient()) {
          this.doHomeworkingType = 'mini'
          document.getElementById("js-iframe-wrap").style.width = "96%"
          var widthIpad = document.getElementById('js-iframe-wrap').clientWidth
          var heightIpad = widthIpad * 54 / 95
          var xIpad = widthIpad / 96 * 2
          var yIpad = 120
          this.iframeData.pageIframeShow = false
          let param = ''
          param += '?x=' + xIpad
          param += '&y=' + yIpad
          param += '&width=' + widthIpad
          param += '&height=' + heightIpad
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.setInterViewFrame + param)
        } else {
          this.iframeData.pageIframeShow = true
          var winWd = window.innerWidth
          var winHt = window.innerHeight
          var titleZoneHeight = 81

          var iframeWrapHt = winHt - titleZoneHeight
          var iframeWrapWd = iframeWrapHt * 95 / 54

          if (iframeWrapWd > winWd) {
            iframeWrapWd = winWd * 0.9
            iframeWrapHt = iframeWrapWd * 54 / 95
          }
          document.getElementById('js-iframe-wrap').style.width = iframeWrapWd + "px"
          document.getElementById('js-iframe-wrap').style.height = iframeWrapHt + "px"
          document.getElementById('js-iframe-wrap').innerHTML = '<iframe src="" id="js-iframe" frameborder="0"></iframe>'
          document.getElementById('js-iframe').setAttribute('src', homeworkUrl)
          document.getElementById('js-iframe').style.width = iframeWrapWd + "px"
          document.getElementById('js-iframe').style.height = iframeWrapHt + "px"
        }
      },
      standardMessageHandler(message) {
        switch (message.action) {
        case 'homework_back': //返回
          if (isFromAppClient()) {
            //iPad APP
            this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.pageBack)
          } else {
            this.$router.push(this.vmFromUrl)
          }
          break
        case 'breakpoint_continue':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_breakpoint_continue', 'lesson_sn': this.lessonSn })
          break
        case 'answer':
          this.messageRecieveHandler(message)
          break
        case 'breakpoint_replay': //不去断点续答 用户选择重做
          homeworkReplayAndSectionIdsInit(message.params.sectionId, this.homeworkResultId).then(res => {
            if (res.data.data && res.data.data.homeworkSectionResultId) {
              this.sectionIds[message.params.sectionId] = res.data.data.homeworkSectionResultId
            }
          })
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_breakpoint_replay', 'lesson_sn': this.lessonSn })
          break
        case 'breakpoint_close': //关掉断点续答
          homeworkReplayAndSectionIdsInit(message.params.sectionId, this.homeworkResultId).then(res => {
            if (res.data.data && res.data.data.homeworkSectionResultId) {
              this.sectionIds[message.params.sectionId] = res.data.data.homeworkSectionResultId
            }
          })
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_breakpoint_close', 'lesson_sn': this.lessonSn })
          break
        case 'homework_sectionIds': // 初始化一些东西
          if (!this.homeworkType.standard.data.homeworkResultId) {
            homeworkReplayAndInit(105, this.homeworkType.standard.data.studentHomeworkId, message.params.sectionIds).then(res => {
              if (res.data.data && res.data.data.homeworkResultId) {
                this.homeworkResultId = res.data.data.homeworkResultId
              }
            })
          }
          break
        case 'homework_section_in': //standard选择section
          homeworkReplayAndSectionIdsInit(message.params.sectionId, this.homeworkResultId).then(res => {
            if (res.data.data && res.data.data.homeworkSectionResultId) {
              this.sectionIds[message.params.sectionId] = res.data.data.homeworkSectionResultId
            }
          })
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_section_in', 'lesson_sn': this.lessonSn })
          break
        default:
          this.saStatistics(message.params.target)
        }
      },
      saStatistics(target) {
        switch (target) {
        case 'homework_start':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_start', 'lesson_sn': this.lessonSn })
          break
        case 'homework_section':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_section', 'lesson_sn': this.lessonSn })
          break
        case 'homework_section_back':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_section_back', 'lesson_sn': this.lessonSn })
          break
        case 'homework_practice_back':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_practice_back', 'lesson_sn': this.lessonSn })
          break
        case 'homework_practice_exit':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_practice_exit', 'lesson_sn': this.lessonSn })
          break
        case 'homework_practice_continue':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_practice_continue', 'lesson_sn': this.lessonSn })
          break
        case 'homework_practice_close':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_practice_close', 'lesson_sn': this.lessonSn })
          break
        case 'homework_result_back':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_result_back', 'lesson_sn': this.lessonSn })
          break
        case 'homework_result_replay':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_result_replay', 'lesson_sn': this.lessonSn })
          break
        case 'homework_result_next':
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_result_next', 'lesson_sn': this.lessonSn })
          break
        }
      },
      standardReceiveMessage(message) {
        if (message && message.code && message.code == 'api is ready') {
          let msg = {
            action: TWO_WAY_ACTION_INFO.standardBusinessData, // 断点续答消息值
            target: VOYAGER,
            params: {
              title: this.homeworkType.standard.data.title,
              subTitle: this.homeworkType.standard.data.subTitle,
              sectionResults: this.homeworkType.standard.data.sectionResults
            }
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))

          // 作业信息
          let msgHomeWork = {
            action: TWO_WAY_ACTION_INFO.standardBreakpoint, // 断点续答消息值
            target: VOYAGER,
            params: {
              sectionBreakPoints: this.homeworkType.standard.data.sectionBreakPoints
            }
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msgHomeWork))

          if (this.homeworkType.standard.data.sectionBreakPoints && this.homeworkType.standard.data.sectionBreakPoints.length > 0) {
            let sectionBreakPoints = this.homeworkType.standard.data.sectionBreakPoints
            for (let i = 0; i < sectionBreakPoints.length; i++) {
              if (sectionBreakPoints[i].homeworkSectionResultId) {
                this.sectionIds[sectionBreakPoints[i].sectionId] = sectionBreakPoints[i].homeworkSectionResultId
              }
            }
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.loadingStop)
        } else {
          if (message && message.action) {
            this.standardMessageHandler(message)
          }
        }
      },
      receiveMessage(message) {
        if (message && message.code && message.code == 'api is ready') {
          if(!this.homeworkType.mini.data.breakpoint) return
          if (this.homeworkType.mini.data.breakpoint.lastFinished === 0) {
            this.homeworkResultId = this.homeworkType.mini.data.breakpoint.homeworkResultId
            let msg = {
              action: TWO_WAY_ACTION_INFO.breakpoint, // 断点续答消息值
              target: VOYAGER,
              params: this.homeworkType.mini.data.breakpoint
            }
            this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
          } else {
            // mini 作业和activity作业需要 进行初始化 homeworkResultId
            homeworkReplayAndInit(104, this.homeworkType.mini.data.studentHomeworkId).then(res => {
              if (res.data.data && res.data.data.homeworkResultId) {
                this.homeworkResultId = res.data.data.homeworkResultId
              }
            })
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.loadingStop)
        } else {
          if (message && message.action && message.action == 'breakpoint_replay') {
            // mini 作业和activity作业需要 进行初始化 homeworkResultId
            homeworkReplayAndInit(104, this.homeworkType.mini.data.studentHomeworkId).then(res => {
              if (res.data.data && res.data.data.homeworkResultId) {
                this.homeworkResultId = res.data.data.homeworkResultId
              }
            })
            sa.track('pc_trigger', { 'trigger_id': 'mini_homework_breakpoint_replay', 'lesson_sn': this.lessonSn })
          } else if (message && message.action && message.action == 'breakpoint_close') {
            // mini 作业和activity作业需要 进行初始化 homeworkResultId
            homeworkReplayAndInit(104, this.homeworkType.mini.data.studentHomeworkId).then(res => {
              if (res.data.data && res.data.data.homeworkResultId) {
                this.homeworkResultId = res.data.data.homeworkResultId
              }
            })
            sa.track('pc_trigger', { 'trigger_id': 'mini_homework_breakpoint_close', 'lesson_sn': this.lessonSn })
          } else if (message && message.action && message.action == 'breakpoint_continue') {
            sa.track('pc_trigger', { 'trigger_id': 'mini_homework_breakpoint_continue', 'lesson_sn': this.lessonSn })
          } else {
            this.messageRecieveHandler(message)
          }
        }
      },
      messageRecieveHandler(message) {
        // 基本格式校验，避免IE9无限消息抛送
        if (/[F|T]+:[\d]+:[\d]+/.test(message) || (message.hasOwnProperty('action') && message.hasOwnProperty('params'))) {
          var homework = this.homeworkMessageParser(message)
          // result : 保存作业结果
          // finish : 作业结束，显示结果
          // active : 用户打点消息
          // score  : 新的作业的总的结果
          // answer : 单题结果，并保存单题结果
          // result_finish : 保存结果，并展示结果
          if (homework.action === 'result') {
            this.storylineSaveHomeworkResult(homework.params)
          } else if (homework.action === 'finish') {
            this.showScore(homework.params)
            this.storylineSaveHomeworkResult(homework.params)
          } else if (homework.action === 'result_finish') {
            this.showScore(homework.params)
            this.storylineSaveHomeworkResult(homework.params)
          } else if (homework.action === 'score') {
            let homeworkResult = homework.params.data.join('') + ':' + homework.params.start + ':' + homework.params.end
            this.showScore(homeworkResult)
          } else if (homework.action === 'answer') {
            if (this.homeworkType.standard.has) {
              this.standardSaveAnswer(homework.params)
            } else {
              this.saveAnswer(homework.params)
            }
          }
        }
      },
      homeworkMessageParser(message) {
        if (message.hasOwnProperty('action') && message.hasOwnProperty('params')) {
          return message
        } else {
          return {
            'action': 'result_finish',
            'params': message
          }
        }
      },
      showScore(resultMessage) {
        var result = resultMessage.split(':')

        var homework = {
          'result': result[0],
          'startTime': parseInt(result[1], 10),
          'endTime': parseInt(result[2], 10)
        }

        var duration = homework.endTime - homework.startTime
        var minutes = parseInt((duration / 1000) / 60, 10)
        var seconds = parseInt((duration / 1000) % 60, 10)
        minutes = minutes >= 10 ? minutes : '0' + minutes
        seconds = seconds >= 10 ? seconds : '0' + seconds

        var rNum = 0
        var wNum = 0
        for (var index = 0; index < homework.result.length; index++) {
          homework.result[index] === 'T' ? rNum++ : wNum++
        }
        this.homeworkResult.resultRightNumber = 'x' + rNum
        this.homeworkResult.resultWrongNumber = 'x' + wNum
        this.homeworkResult.resultTime = minutes + ':' + seconds

        this.iframeData.pageIframeShow = false
        this.homeworkResult.homeworkResultShow = true

        this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.webViewClose)
        this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.didSubmitResult)
      },
      storylineSaveHomeworkResult(resultMessage) {
        let homeworkResult = resultMessage.split(':')
        let studentHomeworkId = this.homeworkType.storyline.data.studentHomeworkId
        let result = homeworkResult[0]
        let startTime = parseInt(homeworkResult[1])
        let endTime = parseInt(homeworkResult[2])

        storylineSaveResult(this.$route.params.studentId, studentHomeworkId, result, startTime, endTime).then(res => {
          sa.track('pc_trigger', { 'trigger_id': 'homework_save_success', 'lesson_sn': this.lessonSn })
        }).catch(error => {
          let solt = `<div> <div>作业成绩上传失败啦，请重试~</div> </div>`
          // let modalConfig = {
          //   'dragon': modal.dragon.sad,
          //   'confirm': '重新提交',
          //   'cancel': '取消',
          //   'slot': solt
          // }
          // modal.alert('', modalConfig).onConfirm(() => {
          //   modal.close()
          //   this.storylineSaveHomeworkResult(resultMessage)
          // })
          sa.track('pc_trigger', { 'trigger_id': 'homework_save_failed', 'lesson_sn': this.lessonSn, 'trigger_content': error.toString() })
        })
      },
      standardSaveAnswer(answer) {
        saveResultItem(
          105,
          this.sectionIds[answer.sectionId],
          answer.stage_id,
          answer.select.toString(),
          answer.right,
          answer.start,
          answer.end,
          answer.routeName,
          answer.isBreakPoint ? 1 : 0,
          answer.isLastItem ? 1 : 0
        ).then(res => {
          if (res.data && res.data.code != 200) {
            let msg = {
              action: TWO_WAY_ACTION_INFO.singleItemError, //单题保存消息值
              target: VOYAGER,
              params: answer
            }
            this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
            sa.track('pc_trigger', { 'trigger_id': 'standard_homework_save_fail' })
          } else {
            if (answer.isLastItem === 1) {
              sa.track('pc_trigger', { 'trigger_id': 'standard_homework_save_success', 'lesson_sn': this.lessonSn })
            }
          }
          // 这里发送单体保存成功提示
        }).catch(e => {
          // 这里发送单体保存失败消息
          let msg = {
            action: TWO_WAY_ACTION_INFO.singleItemError, //单题保存消息值
            target: VOYAGER,
            params: answer
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
          sa.track('pc_trigger', { 'trigger_id': 'standard_homework_save_fail', 'trigger_content': e })
        })
      },
      saveAnswer(answer) {
        saveResultItem(
          104,
          this.homeworkResultId,
          answer.stage_id,
          answer.select.toString(),
          answer.right,
          answer.start,
          answer.end,
          answer.routeName,
          answer.isBreakPoint ? 1 : 0,
          answer.isLastItem ? 1 : 0
        ).then(res => {
          if (res.data && res.data.code != 200) {
            let msg = {
              action: TWO_WAY_ACTION_INFO.singleItemError, //单题保存消息值
              target: VOYAGER,
              params: answer
            }
            this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
            sa.track('pc_trigger', { 'trigger_id': 'homework_answer_save_failed' })
          } else {
            if (answer.isLastItem === 1) {
              sa.track('pc_trigger', { 'trigger_id': 'mini_homework_save_success', 'lesson_sn': this.lessonSn })
            }
          }
          // 这里发送单体保存成功提示
        }).catch(e => {
          // 这里发送单体保存失败消息
          let msg = {
            action: TWO_WAY_ACTION_INFO.singleItemError, //单题保存消息值
            target: VOYAGER,
            params: answer
          }
          this.postOfficeObj.sendMessage(this.postOfficeObj.ipadCommunication.postMessage, JSON.stringify(msg))
          sa.track('pc_trigger', { 'trigger_id': 'homework_answer_save_failed', 'trigger_content': e })
        })
      }
    }
  }
</script>

<style lang="stylus" scoped>
.homework
  background: #302a35 url("../../img/homework/bg.png") no-repeat center center fixed
  -webkit-background-size: cover
  background-size: cover
  height: 100%
  .page-iframe
    width: 90%
    margin: 0 auto
    .no-border
      outline: 0
      border: 0 
  .page-iframe-standard
    position: fixed
    width: 100%
    height: 100%
    margin: 0 auto
    .no-border
      outline: 0
      border: 0 
    iframe
      width: 100%
      height: 100%
      outline: 0
      border: 0
                  
</style>
