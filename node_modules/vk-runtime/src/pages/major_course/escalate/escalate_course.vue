<template lang="jade">
  .island-page-wrapper
    top-part(:title_cn="titleCh", :title_eng="titleEn", :gobackurl="'/major_course_catalog'")
    vertical-scroll(:marginT="'-204px'")
      .vertical-scroll-box(ref='scrollWarp')
        .island(v-for = "(items, index) in cardList", :class="[{'has-bridge': index < cardList.length - 1}, ui.islandTypeClass]")
          template(v-for = "(item, index) in items")
            path-card(@detailTrigger="showDetail(item.onlineClassId, item.lessonId, item.workType)", :island-type="planetNumber", :course-data="item", :course-index="index", :server-time="serverTime", @trialDialogTriger="trialDialogControl")
    new-course-detail(:isCourseDetailShow="isCourseDetailChildShow", @courseDetailLayerTriger="closeCourseDetail", :courseDetailDataProp="courseDetailData", :planetNumProp="planetNumber", @trialDialogTriger="trialDialogControl")
    course-switch
    move-background
    .homeWorkRevise-container(v-if="homeWorkRevise && homeWorkRevise.show",@click = 'changeTipShow')
      .homeWorkIcon
        .errNumber {{homeWorkRevise.reviseNum}}
        transition(name="fade")
          .tips(v-if="tipShow") 错题都改完了~
      .homeWorkRevise-name(@click = 'changeTipShow') {{homeWorkRevise.text}}
</template>
<script>
/** 
 *  
 *  @PlanetNumber:
 *  public: 1
 *  toefl: 2
 *  winter: 3
 *  summer: 4
 *  others: 5
 *  phonics: 6
 *  pronun: 7
 *  vov: 8
 *  freetalk: 9
 *  class_major: 10
 *  class_major2016: 11
 *  class_esl: 12
 *  steam: 13
 *  escalate: 14
 * 
 **/
import Vue from 'vue'
import TopPart from '../../common/top_part.vue'
import axios from 'axios'
import cookies from 'cookies-js'
import Velocity from 'velocity-animate'
import moveBackground from '../../common/move_background.vue'
import newCourseDetail from '../../common/course_detail.vue'
import courseSwitch from '../components/major_course_switch.vue'
import verticalScroll from '../../common/vertical_scroll.vue'
import pathCard from './escalate_card.vue'
import vkDialog from '../../common/vk_dialog_trial.vue'
import model from "../../common/plugins/Model"
Vue.use(model)
export default {
  data: function () {
    return {
      titleCh: '',
      titleEn: '',
      planetNumber: parseInt(this.$route.params.planetNumber),
      majorType: this.$route.params.majorType,
      minorType: this.$route.params.minorType,
      curriculumId: this.$route.params.curriculumId,
      curriculumType: this.$route.params.curriculumType,
      isCourseDetailChildShow: false,
      courseDetailData: {},
      cardList: [],
      tipShow: false,
      homeWorkRevise: '',
      serverTime: 0,
      ui:{
        islandTypeClass: 'island-type-' + this.$route.params.planetNumber
      }
    }
  },
  components: {
    TopPart,
    newCourseDetail,
    courseSwitch,
    moveBackground,
    verticalScroll,
    pathCard
  },
  mounted() {
    this.getLessons()
  },
  updated(){
  },
  methods: {
    changeTipShow(){
      if(this.homeWorkRevise.reviseNum==0 && !this.tipShow){
        this.tipShow = true
        setTimeout(()=>{
          this.tipShow = false
        },2000)
      } else if(this.homeWorkRevise.reviseNum!=0){
        sa.track('learning_click', {'click_id': 'pc_learning_escalate_jump_to_questionsRevise_button'})
        window.location.href = this.homeWorkRevise.reviseUrl+ "&back_url=" + encodeURIComponent(document.location.href)//@back_url 用于作业端返回
        // window.open(this.homeWorkRevise.reviseUrl,'_blank')
      }
    },
    trialDialogControl(func) {
      this.$modelShow({
        model: vkDialog,
        title: "为了确保试听效果，请您阅读如下注意事项并进行检查确认",
        buttonText: "知道了",
        enter: () => {
          this.$modelClose()
          func()
        },
        closeDialog: () => {
          this.$modelClose()
        }
      })
    },
    showDetail(onlineClassId, lessonId, workType) {
      axios.get('/rest/learninggw/api/pc/path/major/getMajorPathDetail', {
        params: {
          studentId: cookies.get("studentId"),
          lessonId: lessonId,
          onlineClassId: onlineClassId
        }
      })
        .then((res) => {
          this.courseDetailData = res.data.data
          this.isCourseDetailChildShow = true
        })
        .catch((err) => {
          alert('网络有点问题，检查一下网络连接吧')
        })
    },
    closeCourseDetail() {
      this.isCourseDetailChildShow = false
    },
    getLessons() {
      let url
      let param
      if (this.curriculumId) {
        url = '/rest/learninggw/api/pc/path/major/getMajorPath'
        param = {
          studentId: cookies.get("studentId"),
          majorType: this.majorType,
          planetNumber: this.planetNumber,
          curriculumId: this.curriculumId,
          curriculumType: this.curriculumType
        }
      } else {
        url = '/rest/learninggw/api/pc/path/major/getMajorPathDefault'
        param = {
          studentId: cookies.get("studentId"),
          planetNumber: this.planetNumber,
          majorType: this.majorType
        }
      }
      
      axios.get(url, {
        params: param
      }).then((res) => {
        let data = res.data.data
        if(res.data.code != 200) {
          alert('网络有点问题，检查一下网络连接吧')
          return
        }
        this.titleCh = data.title
        this.homeWorkRevise = data.homeWorkRevise
        if (data.subTitle && data.subTitle != 'N/A') {
          this.titleEn = data.subTitle
        } else {
          this.titleEn = ''
        }
        this.serverTime = data.serverTime    
        let list = this.chunk(data.pathLessonList, 3)
        for(let i = 0; i < list.length; i++) {
          this.cardList.push(list[i])
        }
      })
    },
    chunk(array, subArrayLen) {
      if(!array){
        return
      }
      var result = []
      for (var i = 0, len = array.length; i < len; i += subArrayLen) {
        result.push(array.slice(i, i + subArrayLen))
      }
      return result
    }
  }
}
</script>
<style lang="stylus" scoped>
  .island-page-wrapper
    position: relative
    height: 100%
    .vertical-scroll-box
      display:inline-block
    .island
      position: relative
      display: inline-block
      width: 920px
      height: 570px
      background-repeat: no-repeat
      background-size: contain
      @media screen and (max-height: 720px)
        transform: scale(0.9)
      &.has-bridge
        margin-right: 40px
        @media screen and (max-height: 720px)
          margin-right: -52px
      &.has-bridge:after
        content: ''
        position: absolute
        top: 230px
        right: -161px
        z-index: 0
        width: 282px
        height: 170px
        display: inline-block
        background-repeat: no-repeat
        background-size: 282px
      &.island-type-1 //openCourse
        background-image: url("../../../img/extension/opencoure_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/opencoure_bridge.png")
      &.island-type-2 //toefl
        background-image: url("../../../img/extension/toefl_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/toefl_bridge.png")
      &.island-type-3 //wintercamp
        background-image: url("../../../img/extension/wintercamp_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/wintercamp_bridge.png")
      &.island-type-4 //summercamp
        background-image: url("../../../img/extension/summercamp_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/summercamp_bridge.png")
      &.island-type-5 // otherCourse
        background-image: url("../../../img/extension/othercoure_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/othercoure_bridge.png")
      &.island-type-6 //phonics
        background-image: url("../../../img/extension/phonics_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/phonics_bridge.png")
      &.island-type-7 //pronunciation
        background-image: url("../../../img/extension/pronun_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/pronun_bridge.png")
      &.island-type-8 //vov
        background-image: url("../../../img/extension/vov_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/vov_bridge.png")
      &.island-type-9 //freeTalk
        background-image: url("../../../img/extension/freetalk_island.png")
      &.island-type-13 //steam
        background-image: url("../../../img/extension/toefl_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/toefl_bridge.png")
      
        &.has-bridge:after
          background-image: url("../../../img/extension/freetalk_bridge.png")
      &.island-type-14 //openCourse
        background-image: url("../../../img/extension/opencoure_island.png")
        &.has-bridge:after
          background-image: url("../../../img/extension/opencoure_bridge.png")
    .homeWorkRevise-container
      position: fixed
      bottom: 16px
      left: 56px
      cursor: pointer
      text-align:center
      .homeWorkIcon
        position:relative
        width:55px
        height:60px
        margin:0 auto
        background-image: url('../../../img/common/bread@2x.png')
        background-size: 100% 100%
        .errNumber
          position:absolute
          top:-12px
          right:-12px
          padding:0 5px
          line-height:24px
          border-radius:12px
          font-size:14px
          font-family:PingFangSC-Regular
          font-weight:400
          color:rgba(255,255,255,1)
          background:rgba(255,102,0,1)
        .tips
          position:absolute
          left:-40px
          top:-51px
          width:95px
          height: 38px;
          padding: 0 20px;
          padding-top: 6px;
          font-size:14px
          font-family:MicrosoftYaHei
          color:rgba(133,97,237,1)
          background:url('../../../img/common/bg@2x.png')
          background-size:100% 100%
      .homeWorkRevise-name
        font-size:20px
        font-family:MicrosoftYaHei
        font-weight: 300
        color:rgba(255,255,255,1)
        line-height:26px
        width: 97px
        margin-top: 5px
  .fade-enter-active, .fade-leave-.fade-enter-active
    transition: opacity .5s;
  .fade-enter, .fade-leave-to
    opacity: 0
</style>
