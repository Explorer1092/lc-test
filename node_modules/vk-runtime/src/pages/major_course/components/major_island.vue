<template lang="jade">
  transition(enterActiveClass="animated fadeInRight")
    .container
      .island-wrap#j-island-wrap(v-cloak)
        .island-container#j-island-con.animated.fadeInRight(v-if="isShowCard")
          .island(:class="islandType")
            .learning-cycle-board.first
              .board-bg {{learningCycleTitle[0]}}
            .learning-cycle-board.second
              .board-bg {{learningCycleTitle[1]}}
            .theme-song(v-if="isThemeSongShow", @click="jumpToSong") 单元主题歌
              .theme-song-btn
            .baoxiang.open(v-if="isBaoXiangOpen", :class="islandType", v-cloak)
              img.medal(:src="medalImgUrl")
            .baoxiang.closed(v-else-if="isBaoXiangClosed", @mouseenter="ballBubbleHintShow", @mouseleave="ballBubbleHintHide", :class="islandType", v-cloak)
              .bubble-hint(v-show="isBubbleHintShow") 完成本单元课程即可获得勋章
            transition-group(tag="span",enterActiveClass="animated bounceInDown")
              template(v-for = "(items, index) in cardItemCollection")
                card(@courseDetailLayerTriger="openCourseDetail",
                :course-data="items",
                :course-index="index",
                :server-time="serverTime",
                :island-type="islandType",
                :key="items",
                :style="{animationDelay:index*0.05+'s'}"
                )
        .project-container(v-if="projectDemoStatus != -1")
          template(v-if="projectDemoStatus == 0")
            .locked(@mouseenter="projectBallBubbleHintShow", @mouseleave="projectBallBubbleHintHide")
              .locker
          template(v-else-if="projectDemoStatus == 1")
            .unclick-state(@click="jumpToProjectDemoPage")
              .light
              .bread
          template(v-else-if="projectDemoStatus == 2")
            .normal(@click="jumpToProjectDemoPage")
          .project-hint(v-show="isProjectBubbleHintShow") 完成 Lesson5 可以观看<br>project项目展示作业啦～
          .project-text Project
        .homeWorkRevise-container(v-if="homeWorkRevise && homeWorkRevise.show",@click = 'changeTipShow')
          .homeWorkIcon
            .errNumber {{homeWorkRevise.reviseNum}}
            transition(name="fade")
              .tips(v-if="tipShow") 错题都改完了~
          .homeWorkRevise-name(@click = 'changeTipShow') {{homeWorkRevise.text}}
        .diagnostic-container(v-if= "dtEntrance && dtEntrance.status !== 0 && defaultData != null",:class= "{'diagnosticPositionL': homeWorkRevise.show == false}")
          template(v-if="this.dtEntrance.status == '1'")
           .diagnosticIcon.diagnosticIconLock(@mouseenter="diagnosticTipsShow", @mouseleave="diagnosticTipsHide")
          template(v-else-if="this.dtEntrance.status == '2'")
           .diagnosticIcon(@click = "goToDiagnosticpage")
          .diagnosticTxt(v-if="this.dtEntrance.status == '1'" @mouseenter="diagnosticTipsShow", @mouseleave="diagnosticTipsHide") Diagnostic Test
          .diagnosticTxt(v-if="this.dtEntrance.status == '2'" @click = "goToDiagnosticpage")  Diagnostic Test 
          .diagnosticTips(v-if= "isDtTipShow")   
            p(v-html= "this.dtTipInfo")
         
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import utils from '../../../utils/_untils.js'
  import card from './major_card.vue'
  import bgImg from '../../../img/major/major_normal_island.png'
  export default {
    data: function () {
      return {
        cardItemCollection: [],
        realItems: [],
        serverTime: 0,
        isBubbleHintShow: false,
        isProjectBubbleHintShow: false,
        preVipIsland: null,
        islandType: '',
        isThemeSongShow: false,
        learningCycleTitle: [],
        currUnitId: '',
        isBaoXiangOpen: false,
        isBaoXiangClosed: false,
        medalImgUrl: '',
        isProjectShow: false,
        isProjectUnLock: false,
        projectClicked: false,
        projectDemoStatus: -1,
        tipShow: false,
        homeWorkRevise:'',
        dtEntrance: '',
        defaultData:'',
        isDtTipShow: false,
        dtTipInfo: '完成Lesson12就可以让Dino<br/>来帮助你检测学习成果哦~',
        theLastAsScheduledIndex: null,
        isShowCard: false,
        planetNumber: parseInt(this.$route.params.planetNumber),
        curriculumId: this.$route.params.curriculumId,
        majorType: this.$route.params.majorType,
        curriculumType: this.$route.params.curriculumType
      }
    },
    components: {
      card
    },
    mounted() {
      this.getLessons()
      //背景图加载完之后 执行卡片添加
      let bg = new Image()
      bg.src = bgImg
      bg.onload = () => {
        this.isShowCard = true
      }
    },
    methods: {
      jumpToProjectDemoPage() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_jump_to_project_button'})
        this.$router.push({path: '/video/project/' + this.currUnitId})
      },
      jumpToSong() {
        sa.track('learning_click', {'click_id': 'pc_learning_major_jump_to_song_button'})
        this.$router.push({path: '/video/pre/' + this.currUnitId + '/1'}) //1代表主题歌视频
      },
      changeTipShow(){
        if(this.homeWorkRevise.reviseNum==0 && !this.tipShow){
          this.tipShow = true
          setTimeout(()=>{
            this.tipShow = false
          },2000)
        } else if(this.homeWorkRevise.reviseNum!=0) {
          sa.track('learning_click', {'click_id': 'pc_learning_major_jump_to_questionsRevise_button'})
          window.location.href = this.homeWorkRevise.reviseUrl + "&back_url=" + encodeURIComponent(document.location.href)//@back_url 用于作业端返回
        }
      },
      diagnosticTipsShow() {
        this.isDtTipShow = true
      },
      diagnosticTipsHide() {
        this.isDtTipShow = false
      },
      goToDiagnosticpage() { 
        sa.track('learning_click', {'click_id': 'pc_learning_dt_entrance'})
        this.$router.push({path: "/" + this.dtEntrance.dtRouteUrl})  
      },
      getLessons() {
        var url, param
        if (this.curriculumId) {
          url = '/rest/learninggw/api/pc/path/major/getMajorPath'
          param = {
            studentId: cookies.get("studentId"),
            planetNumber: this.planetNumber,
            curriculumId: this.curriculumId,
            curriculumType: this.curriculumType,
            majorType: this.majorType
          }
        } else {
          url = '/rest/learninggw/api/pc/path/major/getMajorPathDefault'
          param = {
            studentId: cookies.get("studentId"),
            planetNumber: this.planetNumber,
            majorType: this.majorType
          }
        }

        axios.get(url, {
          params: param
        })
          .then((res) => {
            this.defaultData = res.data.data
            this.cardItemCollection = res.data.data.pathLessonList
            this.projectDemoStatus = res.data.data.projectDemoStatus
            this.homeWorkRevise = res.data.data.homeWorkRevise
            this.dtEntrance = res.data.data.dtEntrance
            this.learningCycleTitle = res.data.data.lcTitleList
            this.$emit('setTitleEvent', res.data.data.title, res.data.data.subTitle)

            this.serverTime = res.data.data.serverTime
            this.currUnitId = res.data.data.curriculumId
            this.isProjectShow = res.data.data.haveProjectDemo
            this.isProjectUnLock = res.data.data.isUnlockProjectDemo
            this.projectClicked = res.data.data.haveSeenProjectDemo
            if (res.data.data.islandNumber == 1) {
              //有勋章 有主题歌 level_1
              this.isPreVip(true)
            } else {
              this.isPreVip(false)
            }
            if (res.data.data.medalUrl) {
              this.isBaoXiangOpen = true
              this.medalImgUrl = res.data.data.medalUrl
            } else {
              this.isBaoXiangClosed = true
            }
            setTimeout(() => {
              document.getElementById('j-move-el-box').style.width = (document.getElementById('j-island-con').clientWidth + 60) + 'px'
              if (document.querySelectorAll('.j-init-booked-status-lesson').length != 0) {
                let des = document.querySelectorAll('.j-init-booked-status-lesson')[0].getBoundingClientRect().left - (window.innerWidth / 2 - 125)
                //定位到第一个booked状态card
                document.getElementById('j-scroll').scrollLeft = des
              }
              this.setTheLastAsScheduledCard()
            }, 1000)

          })
      },
      setTheLastAsScheduledCard() {
        let listLength = this.cardItemCollection.length
        for (let i = listLength - 1; i >= 0; i--) {
          if (this.cardItemCollection[i].lessonStatus == 5) {
            this.theLastAsScheduledIndex = i
            document.querySelectorAll('.card-item')[this.theLastAsScheduledIndex].className += ' latest-finish'
            return
          }
        }
      },
      isPreVip(isPreVip) {
        if (isPreVip) {
          this.isThemeSongShow = true
          this.islandType = 'major-pre-vip'
        } else {
          this.isThemeSongShow = false
          this.islandType = 'major-normal'
        }
      },
      projectBallBubbleHintShow() {
        this.isProjectBubbleHintShow = true
      },
      projectBallBubbleHintHide() {
        this.isProjectBubbleHintShow = false
      },
      ballBubbleHintShow() {
        this.isBubbleHintShow = true
      },
      ballBubbleHintHide() {
        this.isBubbleHintShow = false
      },
      openCourseDetail(courseDetailData) {
        this.$emit('courseDetailLayerTriger', courseDetailData)
      }
    }
  }
</script>

<style lang="stylus" scoped>
  [v-cloak]
    display: none

  .container
    height: 100%
    .island-wrap
      position: relative
      height: 100%
      z-index: 2
      .island-container
        position: absolute
        top: 55%
        margin-top: -214px
        padding: 0 0 0 100px
        white-space: nowrap
        .island
          position: relative
          display: inline-block
          height: 528px
          background-repeat: no-repeat
          background-size: contain
          .learning-cycle-board
            text-align: center
            position: absolute
            width: 500px
            .board-bg
              background-image: url('../../../img/major/learning-cycle-board.png')
              background-repeat: no-repeat
              background-size: 100% 100%
              padding: 0 16px
              margin: 0 auto
              line-height: 36px
              color: #7f5536
              display: inline-block
              min-width: 110px
          &.hide-island
            display: none
          &.major-pre-vip
            background-image: url("../../../img/major/major_previp_island.png")
            width: 3807px
            .learning-cycle-board.first
              top: 455px
              left: 318px
            .learning-cycle-board.second
              top: 441px
              left: 1792px
          &.major-normal
            background-image: url("../../../img/major/major_normal_island.png")
            width: 3934px
            .learning-cycle-board.first
              top: 395px
              left: 135px
            .learning-cycle-board.second
              top: 365px
              left: 1780px
          .theme-song
            background-image: url('../../../img/major/rounded@2x.png')
            background-size: 160px
            background-repeat: no-repeat
            width: 160px
            height: 60px
            position: absolute
            top: 103px
            left: -18px
            cursor: pointer
            box-sizing: border-box
            color: white
            font-size: 14px
            line-height: 60px
            padding-left: 25px
            .theme-song-btn
              background-image: url('../../../img/major/playbutton@2x.png')
              background-size: 56px
              background-repeat: no-repeat
              width: 56px
              height: 57px
              position: absolute
              top: 2px
              left: 115px
          .baoxiang
            background-repeat: no-repeat
            position: absolute
            cursor: pointer
            .medal
              width: 66px
              position: absolute
              top: 23px
              left: 40px
              animation: medalMove 1s infinite
              animation-direction: alternate
              animation-timing-function: ease-in-out
              -webkit-animation: medalMove 1s infinite
              -webkit-animation-direction: alternate
              -webkit-animation-timing-function: ease-in-out
            &.major-pre-vip
              top: 94px
              right: 121px
            &.major-normal
              top: 88px
              right: 71px
            &.closed
              background-image: url('../../../img/major/baoxiang_closed.png')
              background-size: 132px
              width: 132px
              height: 124px
            &.open
              background-image: url('../../../img/major/baoxiang_open.png')
              width: 186px
              height: 136px
              &.major-normal
                top: 73px
                right: 28px
              &.major-pre-vip
                top: 74px
                right: 63px
            .bubble-hint
              position: absolute
              top: -83px
              left: -10px
              background-image: url('../../../img/bubble_bg@2x.png')
              background-size: 150px
              background-repeat: no-repeat
              width: 150px
              height: 75px
              color: #555555
              font-size: 16px
              padding: 12px 15px
              box-sizing: border-box
              white-space: normal
              line-height: 20px
              text-align: center

    .project-container
      position: fixed
      bottom: 70px
      left: 50px
      cursor: pointer
      .locked
        background-image: url('../../../img/major/bread-locked@2x.png')
        background-size: 100% 100%;
        width: 58px;
        height: 60px;
        background-repeat: no-repeat
        text-align: center
        .locker
          background-image: url('../../../img/major/lock@2x.png')
          background-size: 100% 100%
          width: 20px
          height: 25px
          background-repeat: no-repeat
          display: inline-block
          position: absolute
          top: 33px
          right: 3px
          margin: 0 auto
      .unclick-state
        width: 58px
        height: 60px
        .light
          background-image: url('../../../img/major/light@2x.png')
          background-size: 108px
          width: 108px
          height: 108px
          background-repeat: no-repeat
          text-align: center
          animation: breadlight 1s infinite
          animation-direction: alternate
          animation-timing-function: ease-in-out
          -webkit-animation: breadlight 1s infinite
          -webkit-animation-direction: alternate
          -webkit-animation-timing-function: ease-in-out
          position: absolute
          left: -25px
          top: -24px
        .bread
          background-image: url('../../../img/major/bread@2x.png')
          background-size: 100% 100%
          width: 58px
          height: 60px
          background-repeat: no-repeat
          display: inline-block
          position: absolute
      .normal
        width: 66px
        height: 60px
        background-image: url('../../../img/major/bread-normal@2x.png')
        background-size: 100% 100%
        margin: 0 auto
        background-repeat: no-repeat
        text-align: center
        transition: all 0.3s;
        -moz-transition: all 0.3s; /* Firefox 4 */
        -webkit-transition: all 0.3s; /* Safari 和 Chrome */
        -o-transition: all 0.3s; /* Opera */
        &:hover
          transform: scale(1.1)
          -ms-transform: scale(1.1) /* IE 9 */
          -moz-transform: scale(1.1) /* Firefox */
          -webkit-transform: scale(1.1) /* Safari 和 Chrome */
          -o-transform: scale(1.1)
      /* Opera */
      .project-hint
        position: absolute
        top: -75px
        left: -17px
        background-image: url('../../../img/major/bubble-bg.png')
        background-size: 238px
        width: 238px
        height: 60px
        background-repeat: no-repeat
        text-align: center
        line-height: 20px
        padding-top: 9px
        box-sizing: border-box
        color: #333333
        &:after
          content: ''
          position: absolute
          bottom: -13px
          left: 36px
          display: inline-block
          background-image: url('../../../img/major/triangle.png')
          background-size: 27px
          width: 27px
          height: 13px
          background-repeat: no-repeat
      .project-text
        font-size: 20px
        color: #fff
        font-family:MicrosoftYaHei
        font-weight: 300
        width: 67px;
        position:absolute
        top:60px
        left:-4.5px
        margin-top:5px
        line-height:26px
        text-align: center
        transition: all 0.3s;
        -moz-transition: all 0.3s; /* Firefox 4 */
        -webkit-transition: all 0.3s; /* Safari 和 Chrome */
        -o-transition: all 0.3s;
    .homeWorkRevise-container
      position: fixed
      bottom: 70px
      left: 156px
      cursor: pointer
      text-align:center
      .homeWorkIcon
        position:relative
        width: 55px
        height: 60px
        background-image: url('../../../img/common/bread@2x.png')
        background-size: 100% 100%
        .errNumber
          position:absolute
          top:-12px
          right:-12px
          padding:0 5px
          line-height:24px
          border-radius:12px
          font-size:14px
          font-family:PingFangSC-Regular
          font-weight:400
          color:rgba(255,255,255,1)
          background:rgba(255,102,0,1)
        .tips
          position:absolute
          left:-40px
          top:-51px
          width:95px
          height: 38px;
          padding: 0 20px;
          padding-top: 6px;
          font-size:14px
          font-family:MicrosoftYaHei
          color:rgba(133,97,237,1)
          background:url('../../../img/common/bg@2x.png')
          background-size:100% 100%
      .homeWorkRevise-name
        width:97px
        font-size:20px
        font-family:MicrosoftYaHei
        font-weight: 300
        color:rgba(255,255,255,1)
        line-height:26px
        position:absolute
        top:60px
        left:-21px
        margin-top:5px
    .diagnostic-container
        position: fixed
        bottom: 70px
        left: 276px
        cursor: pointer
        text-align: center
    .diagnosticPositionL
        left: 200px   
      .diagnosticIcon
        width: 60px
        height: 60px
        background-image: url('../../../img/major/dtSattus@2x.png')
        background-size: 100% 100%
      .diagnosticIconLock
        background-image: url('../../../img/major/dtSattusLock@2x.png')
        background-size: 100% 100%
      .diagnosticTxt
        position:absolute
        left: -21px
        top: 64px
        width: 97px
        line-height: 26px
        font-size: 20px
        font-family: MicrosoftYaHei
        font-weight: 300
        color:rgba(255,255,255,1)
      .diagnosticTips  
        position: absolute
        width: 260px
        left: -99px
        bottom: 84px
        padding: 10px 0 10px 0
        box-sizing: border-box
        background: rgba(255, 255, 255, 1)
        border-radius: 32px
        border: 2px solid rgba(133, 97, 237, 1)
        cursor: pointer 
        &:after
          content: ''
          position: absolute
          left: 45%
          bottom: -20px
          width: 26px
          height: 20px
          background: url('../../../img/index/index-arrow_bottom.png') no-repeat
          background-size: 100%
        p
          line-height: 20px
          text-align: center
          color: #8561ED
          font-size: 14px    
  /* Opera */

  @keyframes medalMove {
    from {
      transform: translateY(0px)
    }
    to {
      transform: translateY(-10px)
    }
  }

  @-moz-keyframes medalMove {
    from {
      transform: translateY(0px)
    }
    to {
      transform: translateY(-10px)
    }
  }

  @-webkit-keyframes medalMove {
    from {
      transform: translateY(0px)
    }
    to {
      transform: translateY(-10px)
    }
  }

  @-o-keyframes medalMove {
    from {
      transform: translateY(0px)
    }
    to {
      transform: translateY(-10px)
    }
  }

  @keyframes breadlight {
    from {
      transform: scale(1);
      opacity: 1
    }
    to {
      transform: scale(1.1);
      opacity: 0.3
    }
  }

  @-moz-keyframes breadlight {
    from {
      transform: scale(1);
      opacity: 1
    }
    to {
      transform: scale(1.1);
      opacity: 0.3
    }
  }

  @-webkit-keyframes breadlight {
    from {
      transform: scale(1);
      opacity: 1
    }
    to {
      transform: scale(1.1);
      opacity: 0.3
    }
  }

  @-o-keyframes breadlight {
    from {
      transform: scale(1);
      opacity: 1
    }
    to {
      transform: scale(1.1);
      opacity: 0.3
    }
  }

  .fade-enter-active, .fade-leave-.fade-enter-active
    transition: opacity .5s;
  .fade-enter, .fade-leave-to
    opacity: 0
</style>
