<template lang="jade">
  .switch-course
    .switch-layer-wrapper(v-visible="isThisLayerShow")
      .black-mirror(@click.stop="closeThisLayer")
      .switch-planet-box
        .close-btn(@click.stop="closeThisLayer")
        .planet-shelter
          .planet-btn.planet-right(@click.stop="planetScrollToRight($event)", v-if="isPlanetRightBtnShow")
            .click-feedback(@click.stop="")
          .planet-btn.planet-left(@click.stop="planetScrollToLeft($event)", v-if="isPlanetLeftBtnShow")
            .click-feedback(@click.stop="")
          .switch-planet-wrapper(ref="planetWrap", v-gscroll="", @scroll="onScroll")
            .switch-planet-item-box(ref="itemBox")
              .switch-planet-item(v-for="item, index in planetList", @click.stop="switchCourse(item.planetNumber, item.majorType)", :class="[{active: currentPlanetNumber ? item.planetNumber === currentPlanetNumber : item.isSelect}, ui.planetClassList[item.planetNumber]]", v-if="item.isHas")
                img(:src="item.imageUrl")
                .switch-course-type-title-holder
                  slide-text(:text="item.chName")
                  slide-text(:text="item.enName")
        .switch-wrapper
          .switch-container(v-for="(itemPlanetList, indexPlanetList) in planetList", v-show="currentPlanetNumber ? itemPlanetList.planetNumber === currentPlanetNumber : itemPlanetList.isSelect")
            .switch-tabs(v-if="itemPlanetList.frames")
              .switch-tab-item(v-for="(tabItem, tabIndex) in itemPlanetList.frames", @click.stop="switchTab(itemPlanetList.planetNumber, tabIndex)", :class="[{active: currentTab(itemPlanetList.planetNumber, tabIndex, tabItem.isSelect) }, ui.planetClassList[itemPlanetList.planetNumber]]")
                p {{tabItem.chName}}
                // slide-text(:text="tabItem.enName")
            .switch-box(v-if="itemPlanetList.frames", v-gscroll="", :class="ui.planetClassList[itemPlanetList.planetNumber]")
              .switch-box-item-container(v-for="(itemFrame, indexFrame) in itemPlanetList.frames", v-show="currentTab(itemPlanetList.planetNumber, indexFrame, itemFrame.isSelect)")
                .switch-box-item(v-for="(itemUnit, indexUnit) in itemFrame.tabs", @click.stop="jumpTo(itemPlanetList.planetNumber, itemUnit.curriculumId, itemUnit.curriculumType)" )
                  img(v-if="itemUnit.imageUrl", :src="itemUnit.imageUrl")
                  img(v-else, src="../../../img/summercamp_Beginning@2x.png")
                  p {{itemUnit.chName}}
    .change-level(@click.stop="openThisLayer")
      p 切换课程
      img(src="../../../img/change-level-next@2x.png")
</template>
<script>
  import Vue from 'vue'
  import axios from 'axios'
  import cookies from 'cookies-js'
  import utils from '../../../utils/_untils.js'
  import VerticalScroll from '../../common/plugins/VerticalScroll'
  import Velocity from 'velocity-animate'
  import slideText from '../../common/vk_slide_text.vue'
  Vue.use(VerticalScroll)
  export default {
    data() {
      return {
        isThisLayerShow: false,
        unitBoxMoving: false,
        unitBoxTranslateX: null,
        unitBox: null,
        isLeftButtonShow: false,
        isRightButtonShow: false,
        currUnitItemBoxWidth: null,
        //重构字段
        isPlanetRightBtnShow: false,
        isPlanetLeftBtnShow: false,
        tabIndex: 0,
        tabMark: [],
        planetList: [],
        currentPlanetNumber: null,
        majorType: this.$route.params.majorType,
        ui:{
          planetClassList: {
            10: 'old-major',
            11: 'new-major',
            12: 'esl',
            14: 'escalate'
          }
        },
        initNum:0
      }
    },
    props: [],
    mounted() {
      this.getSwitchData()
    },
    updated(){
      if(this.initNum == 0){
        this.initArrow()
      }
    },
    directives: {
      visible(el, binding) {
        if (binding.value) el.style.visibility = 'visible'
        else el.style.visibility = 'hidden'
      }
    },
    watch: {
    },
    components: {
      slideText
    },
    methods: {
      planetScrollToRight(e) {
        this.planetScroll('right')
      },
      planetScrollToLeft(e) {
        this.planetScroll('left')
      },
      planetScroll(direction) {
        Velocity(this.$refs.planetWrap, "scroll", {
          axis: "x",
          container: this.$refs.planetWrap,
          duration: 300,
          offset: direction == 'right' ? 150 : 0 - 400 //gys尚未解决该问题
        })
      },
      initArrow(){
        let planetWrap_wid = this.$refs.planetWrap.offsetWidth
        let itemBox_wid = this.$refs.itemBox.offsetWidth
        if(itemBox_wid > planetWrap_wid){
          this.isPlanetRightBtnShow = true
        } else {
          this.isPlanetRightBtnShow = false
        }
        this.initNum = 1
      },
      onScroll(e) {
        if (e.target.scrollLeft == 0) {
          this.isPlanetLeftBtnShow = false
        } else {
          this.isPlanetLeftBtnShow = true
        }
        if (e.target.scrollLeft == e.target.scrollWidth - e.target.clientWidth) {
          this.isPlanetRightBtnShow = false
        } else {
          this.isPlanetRightBtnShow = true
        }
      },
      jumpTo(planetNumber, curriculumId, curriculumType) {
        if (planetNumber == 12) {
          window.location.href = `/esl/${this.majorType}/${planetNumber}/${curriculumId}/${curriculumType}`
        } else if (planetNumber == 14) {
          window.location.href = `/escalate/${this.majorType}/${planetNumber}/${curriculumId}/${curriculumType}`
        } else {
          window.location.href = `/major/${this.majorType}/${planetNumber}/${curriculumId}/${curriculumType}`
        }
      },
      currentTab: function (planetNumber, tabIndex, isSelect) {
        //切换标签，并且不影响非当前星球的标签。
        if( this.tabMark.length == 0 ) {
          return isSelect
        } else if( this.tabMark[0] == planetNumber ) {
          if( this.tabMark[1] == tabIndex ) {
            return true
          } else {
            return false
          }
        } else {
          return isSelect
        }
      },
      getSwitchData() {
        axios.get('/rest/learninggw/api/pc/path/major/getMajorTree', {
          params: {
            studentId: cookies.get("studentId"),
            planetNumber: this.$route.params.planetNumber,
            curriculumId: this.$route.params.curriculumId ? this.$route.params.curriculumId : ''
          }
        }).then((res) => {
          let totalPlanetCount = 0
          let distance = 0
          this.planetList = res.data.data
          if (totalPlanetCount > 4) {
            this.isPlanetRightBtnShow = true
            this.$nextTick(() => {
              this.$refs.planetWrap.scrollLeft = distance - this.$refs.planetWrap.clientWidth
            })
          }
        })
      },
      switchTab( planetNumber, tabIndex ) {
        this.tabMark = []
        this.tabMark.push(planetNumber)
        this.tabMark.push(tabIndex)
      },
      openThisLayer() {
        this.isThisLayerShow = true
        this.$emit('openSwitch')
      },
      switchCourse( flag, majorType ) {
        this.currentPlanetNumber = flag
        this.majorType = majorType
      },
      closeThisLayer() {
        this.$emit('closeSwitch')
        this.isThisLayerShow = false
      }
    }
  }
</script>
<style lang="stylus" scoped>
  .switch-course
    .switch-layer-wrapper
      position: fixed
      top: 0
      left: 0
      right: 0
      bottom: 0
      z-index: 22
      .black-mirror
        position: fixed
        top: 0
        bottom: 0
        left: 0
        right: 0
        z-index: 22
        width: 100%
        height: 100%
        background-color: rgba(0, 0, 0, 0.7)
      .switch-planet-box
        position: absolute
        z-index: 22
        top: 50%
        left: 50%
        margin-top: -255px
        margin-left: -405px
        display: inline-block
        width: 810px
        height: 510px
        box-sizing: border-box
        background-color: #19388a
        background-image: url("../../../img/switch_course_bg@2x.png")
        border-radius: 18px
        box-shadow: 3px 2px 14px 0 #36185c
        .close-btn
          position: absolute
          top: -10px
          right: -10px
          display: inline-block
          z-index: 22
          width: 40px
          height: 40px
          background-image: url("../../../img/summercamp_button_collection.png")
          background-repeat: no-repeat
          background-position: -80px -220px
          background-size: 400px
          cursor: pointer
          &:hover
            background-position: 0 -220px
          &:active
            background-position: -40px -220px
        .planet-shelter
          overflow: hidden
          height: 175px
          .planet-btn
            position: absolute
            height: 140px
            width: 111px
            top: 34px
            background-color: transparent
            background-repeat: no-repeat
            cursor: pointer
            overflow: hidden
            &:hover
              opacity: 0.7
            &.planet-right
              background-image: url('../../../img/extension/planet_next.png')
              background-position: center left
              right: 0
            &.planet-left
              background-image: url('../../../img/extension/planet_last.png')
              background-position: center right
              left: 0
            .click-feedback
              width: 4px
              height: 4px
              border-radius: 99px
              background-color: #a18ee3
              position: absolute
              opacity: 0
              &.move
                animation: Click-Feedback 0.4s ease-out
          .switch-planet-wrapper
            width: 566px
            box-sizing: border-box
            padding: 35px 0 0 0
            margin: 0 auto
            text-align: center
            overflow: auto
            &::-webkit-scrollbar
              height: 5px
            &::-webkit-scrollbar-thumb
              border-radius: 999px
              background: rgba(0, 0, 0, 0.2)
            .switch-planet-item-box
              white-space: nowrap
              display: inline-block
              .switch-planet-item
                position: relative
                display: inline-block
                width: 210px
                height: 140px
                cursor: pointer
                &.esl.active
                  background-image: url('../../../img/major/esl_switch_hang.png')
                  background-repeat: no-repeat
                  background-size: 140px
                  background-position: center 67px
                  margin: 0
                &.escalate.active
                  background-image: url('../../../img/major/new_major_switch_hang.png')
                  background-repeat: no-repeat
                  background-size: 140px
                  background-position: center 67px
                &.new-major.active
                  background-image: url('../../../img/major/new_major_switch_hang.png')
                  background-repeat: no-repeat
                  background-size: 140px
                  background-position: center 67px
                &.old-major.active
                  background-image: url('../../../img/major/major_switch_hang.png')
                  background-repeat: no-repeat
                  background-size: 140px
                  background-position: center 67px
                img
                  width: 100px
                  vertical-align: middle
                .switch-course-type-title-holder
                  color: #fff
                  font-size: 12px
                  font-weight: 300
                  line-height: 15px
                  position: relative
                  top: 4px
                  left: 48px
                  width: 115px
        .switch-wrapper
          margin-top: 40px
          .switch-container
            position: relative
            .switch-tabs
              position: relative
              top: 1px
              left: 3px
              z-index: 1
              width: 756px
              margin: 0 auto
              .switch-tab-item
                display: inline-block
                vertical-align: middle
                width: 80px
                height: 40px
                line-height: 40px
                opacity: 1
                border-radius: 10px
                margin-right: 5px
                border-top-left-radius: 10px
                border-top-right-radius: 10px
                border-bottom-left-radius: 0
                border-bottom-right-radius: 0
                background-color: #ba8b52
                box-shadow: inset 2px 1px 0 0 #eab975
                color: #d5b998
                text-align: center
                font-size: 14px
                box-sizing: border-box
                padding: 3px 12px 0 12px
                cursor: pointer
                &.active
                  color: #ffffff
                  background-color: #ffaf3b
                  box-shadow: inset 2px 1px 0 0 #ffce85

                &.esl
                  color: #A4DBD0
                  background-color: #4AB8A1
                  box-shadow: inset 2px 1px 0 0 #5CD0B8
                  &.active
                    color: #ffffff
                    background-color: #5FDA99
                    box-shadow: inset 2px 1px 0 0 #A7FFD1

                &.escalate
                  color: #F9BA90
                  background-color: #F37622
                  box-shadow: inset 2px 1px 0 0 #FF9A6E
                  &.active
                    color: #ffffff
                    background-color: #FFA81A
                    box-shadow: inset 2px 1px 0 0 #FFDA8C

                &.new-major
                  color: #F9BA90
                  background-color: #F37622
                  box-shadow: inset 2px 1px 0 0 #FF9A6E
                  &.active
                    color: #ffffff
                    background-color: #FFA81A
                    box-shadow: inset 2px 1px 0 0 #FFDA8C

                &.old-major
                  color: #C7A888
                  background-color: #905112
                  box-shadow: inset 2px 1px 0 0 #AB6927
                  &.active
                    color: #ffffff
                    background-color: #DCC032
                    box-shadow: inset 2px 1px 0 0 #FFE45C
                
            .switch-box
              position: relative
              width: 780px
              height: 244px
              border-radius: 20px
              margin: 0 auto 0 auto
              background-repeat: no-repeat
              background-size: cover
              background-image: url("../../../img/summer-camp-bg.png")
              border: solid 5px #ffaf3b
              z-index: 2
              box-sizing: border-box
              overflow: auto
              &::-webkit-scrollbar
                height: 7px
              &::-webkit-scrollbar-thumb
                border-radius: 999px
                background: rgba(0, 0, 0, 0.4)
              &.esl
                background-image: url("../../../img/major/esl_switch_bg.png")
                border: solid 5px #5FDA99
              &.escalate
                background-image: url("../../../img/major/new_major_switch_bg.png")
                border: solid 5px #FFA81A
              &.new-major
                background-image: url("../../../img/major/new_major_switch_bg.png")
                border: solid 5px #FFA81A
              &.old-major
                background-image: url("../../../img/major/major_switch_bg.png")
                border: solid 5px #DCC032
              .switch-box-item-container
                white-space: nowrap
                width: 100%
                height: 100%
                text-align: center
                .switch-box-item
                  display: inline-block
                  text-align: center
                  color: white
                  font-size: 14px
                  cursor: pointer
                  margin: 64px 20px 0px 20px
                  text-decoration: none
                  img
                    width: 100px
                    height: 100px
                    margin-bottom: 11px
    .change-level
      position: fixed
      top: 0
      right: 22px
      color: #fff
      font-size: 18px
      background: url("../../../img/change-level@2x.png")
      background-size: contain
      width: 156px
      height: 73px
      cursor: pointer
      z-index: 9
      &:hover img
        transform: scale(1.2)
        -ms-transform: scale(1.2)
        -moz-transform: scale(1.2)
        -webkit-transform: scale(1.2)
        -o-transform: scale(1.2)
      p
        position: absolute
        top: 40px
        left: 26px
        line-height: 1em
      img
        position: absolute
        top: 39px
        right: 27px
        width: 20px
        transition: all 0.2s
        -moz-transition: all 0.2s
        -webkit-transition: all 0.2s
        -o-transition: all 0.2s
@keyframes Click-Feedback
  0%
    opacity: 0
    transform: scale(1)
  30%
    opacity: 0.5
    transform: scale(25)
  to
    opacity: 0
    transform: scale(50)
</style>