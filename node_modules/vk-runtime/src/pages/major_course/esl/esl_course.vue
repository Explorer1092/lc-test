<template lang="jade">
  .island-page-wrapper
    top-part(:title_cn="titleCh", :title_eng="titleEn", :gobackurl="'/major_course_catalog'")
    vertical-scroll(:marginT="'-282px'")
      .vertical-scroll-box
        .island(:class="ui.islandTypeClass")
          template(v-for = "(item, index) in cardList")
            esl-card(@detailTrigger="showDetail(item.onlineClassId, item.lessonId, item.workType)", :island-type="planetNumber", :card-data="item", :card-index="index+1", :server-time="serverTime")
    new-course-detail(:isCourseDetailShow="isCourseDetailChildShow", @courseDetailLayerTriger="closeCourseDetail", :courseDetailDataProp="courseDetailData", :planetNumProp="planetNumber")
    course-switch
    move-background
    .homeWorkRevise-container(v-if="homeWorkRevise && homeWorkRevise.show",@click = 'changeTipShow')
      .homeWorkIcon
        .errNumber {{homeWorkRevise.reviseNum}}
        transition(name="fade")
          .tips(v-if="tipShow") 错题都改完了~
      .homeWorkRevise-name(@click = 'changeTipShow') {{homeWorkRevise.text}}
</template>
<script>
import Vue from 'vue'
import TopPart from '../../common/top_part.vue'
import axios from 'axios'
import cookies from 'cookies-js'
import Velocity from 'velocity-animate'
import moveBackground from '../../common/move_background.vue'
import newCourseDetail from '../../common/course_detail.vue'
import courseSwitch from '../components/major_course_switch.vue'
import verticalScroll from '../../common/vertical_scroll.vue'
import eslCard from './esl_card.vue'
import vkDialog from '../../common/vk_dialog_trial.vue'
import model from '../../common/plugins/Model'
Vue.use(model)
export default {
  data: function () {
    return {
      titleCh: '',
      titleEn: '',
      lightCardControl: 'allowed',
      planetNumber: parseInt(this.$route.params.planetNumber),
      majorType: this.$route.params.majorType,
      curriculumId: this.$route.params.curriculumId,
      curriculumType: this.$route.params.curriculumType,
      isCourseDetailChildShow: false,
      courseDetailData: {},
      tipShow: false,
      homeWorkRevise:"",
      //重构字段
      cardList: [],
      serverTime: 0,
      ui:{
        islandTypeClass: 'island-type-1'
      }
    }
  },
  components: {
    TopPart,
    newCourseDetail,
    courseSwitch,
    moveBackground,
    verticalScroll,
    eslCard,
    vkDialog
  },
  mounted() {
    this.getLessons()
  },
  methods: {
    changeTipShow(){
      if(this.homeWorkRevise.reviseNum==0 && !this.tipShow){
        this.tipShow = true
        setTimeout(()=>{
          this.tipShow = false
        },2000)
      } else if(this.homeWorkRevise.reviseNum!=0){
        sa.track('learning_click', {'click_id': 'pc_learning_esl_jump_to_questionsRevise_button'})
        window.location.href = this.homeWorkRevise.reviseUrl+ "&back_url=" + encodeURIComponent(document.location.href)//@back_url 用于作业端返回
      }
    },
    showDetail(onlineClassId, lessonId, workType) {
      axios.get('/rest/learninggw/api/pc/path/major/getMajorPathDetail', {
        params: {
          studentId: cookies.get("studentId"),
          lessonId: lessonId,
          onlineClassId: onlineClassId
        }
      })
        .then((res) => {
          this.courseDetailData = res.data.data
          this.isCourseDetailChildShow = true
        })
        .catch((err) => {
          alert('网络有点问题，检查一下网络连接吧')
        })
    },
    closeCourseDetail() {
      this.isCourseDetailChildShow = false
    },
    getLessons() {
      let url
      let param

      if (this.curriculumId) {
        url = '/rest/learninggw/api/pc/path/major/getMajorPath'
        param = {
          studentId: cookies.get("studentId"),
          majorType: this.majorType,
          planetNumber: this.planetNumber,
          curriculumId: this.curriculumId,
          curriculumType: this.curriculumType
        }
      } else {
        url = '/rest/learninggw/api/pc/path/major/getMajorPathDefault'
        param = {
          studentId: cookies.get("studentId"),
          planetNumber: this.planetNumber,
          majorType: this.majorType
        }
      }
      
      axios.get(url, {
        params: param
      }).then((res) => {
        let data = res.data.data
        if(res.data.code != 200) {
          alert('网络有点问题，检查一下网络连接吧')
          return
        }
        this.titleCh = data.title
        this.homeWorkRevise = data.homeWorkRevise
        if (data.subTitle && data.subTitle != 'N/A') {
          this.titleEn = data.subTitle
        } else {
          this.titleEn = ''
        }
        
        this.serverTime = data.serverTime
        let list = data.pathLessonList
        for(let i = 0; i < list.length; i++) {
          if (list[i].onlineStatus == "BOOKED" && this.lightCardControl === 'allowed') {
            //让最近一节状态为BOOKED的卡片闪耀起来
            this.lightCardControl = 'not-allowed'
            list[i].letCardShining = 1
          }
          this.cardList.push(list[i])
        }
      })
    },
    chunk(array, subArrayLen) {
      if(!array){
        return
      }
      var result = []
      for (var i = 0, len = array.length; i < len; i += subArrayLen) {
        result.push(array.slice(i, i + subArrayLen))
      }
      return result
    },
    courseSwitchOpen() {
    },
    courseSwitchClose() {
    }
  }
}
</script>
<style lang="stylus" scoped>
  .island-page-wrapper
    position: relative
    height: 100%
    .island
      position: relative
      display: inline-block
      width: 3900px
      height: 670px
      background-size: contain
      background-repeat-x: repeat
      margin: 0 486px 0 300px
      @media screen and (max-height: 720px)
        transform: scale(0.9)
        margin: 0 336px 0 110px

      &.island-type-1
        background-image: url("../../../img/major/4@2x.png")
      &:before
        content: ''
        position: absolute
        top: 0
        left: -204px
        width: 207px
        height: 100%
        background-image: url("../../../img/major/esl_island_head.png")
        background-repeat: no-repeat
        background-size: contain
      &:after
        content: ''
        position: absolute
        top: 0
        right: -486px
        width: 486px
        height: 100%
        background-image: url("../../../img/major/esl_island_end.png")
        background-repeat: no-repeat
        background-size: contain
    .homeWorkRevise-container
      position: fixed
      bottom: 16px
      left: 56px
      cursor: pointer
      text-align:center
      .homeWorkIcon
        position:relative
        width:55px
        height:60px
        margin:0 auto
        background-image: url('../../../img/common/bread@2x.png')
        background-size: 100% 100%
        .errNumber
          position:absolute
          top:-12px
          right:-12px
          padding:0 5px
          line-height:24px
          border-radius:12px
          font-size:14px
          font-family:PingFangSC-Regular
          font-weight:400
          color:rgba(255,255,255,1)
          background:rgba(255,102,0,1)
        .tips
          position:absolute
          left:-40px
          top:-51px
          width:95px
          height: 38px;
          padding: 0 20px;
          padding-top: 6px;
          font-size:14px
          font-family:MicrosoftYaHei
          color:rgba(133,97,237,1)
          background:url('../../../img/common/bg@2x.png')
          background-size:100% 100%
      .homeWorkRevise-name
        font-size:20px
        font-family:MicrosoftYaHei
        font-weight: 300
        color:rgba(255,255,255,1)
        line-height:26px
        width: 97px
        margin-top: 5px
  .fade-enter-active, .fade-leave-.fade-enter-active
    transition: opacity .5s;
  .fade-enter, .fade-leave-to
    opacity: 0
</style>
