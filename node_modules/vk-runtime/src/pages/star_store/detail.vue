<template lang="jade">
  .nexus-detail(@mouseleave="hideDetail")
    error.error(v-if="isError",:errorReload="fetchDefault")
    .nexus-body(v-if="!isError")
      transition(enter-active-class="nexus-in",leave-active-class="nexus-leave")
        .nexus-bg(v-show="isShowPet")
          .nexus-inner
            ul
              li.nexus-item(v-for="(item,index) in pets",:class="{'item-refresh':isRefresh}",:style="!item.hasOwned?{overflow:'hidden'}:''")
                .no-card(v-if="!item.hasOwned",@click.stop="clickLi(index)",@mouseenter="liEnter(index,item.hasOwned)",@mouseleave="liLeave(item.hasOwned)")
                  img.pic(:src="item.picName+ '?x-oss-process=image/resize,w_60'")
                  .text(v-text="item.isSpecialPet==0?'尚未获取':'活动获取'")
                  img.card-right(:class="isHoverIndex==index?'card-right-leave':''",src="../../img/star_store/gateopening_r.png")
                  img.card-left(:class="isHoverIndex==index?'card-left-leave':''",src="../../img/star_store/gateopening_l.png")
                .has-card(v-if="item.hasOwned",@click.stop="liEnter(index,item.hasOwned)")
                  img.use(v-if="index==usedIndex&&currentPage==usedPage",src="../../img/star_store/use.png")
                  img.new(v-if="item.new?true:false",src="../../img/star_store/new.png")
                  img.pic(:src="item.picName+ '?x-oss-process=image/resize,w_60'",style="height:70px")
      transition(enter-active-class="nexus-in",leave-active-class="nexus-leave")
        .nexus-bg(v-show="isShowAcs")
          .nexus-inner
            ul
              li.nexus-item(v-for="(item,index) in acs",:class="{'item-refresh':isRefresh}",:style="!item.hasOwned?{overflow:'hidden'}:''")
                .no-card(v-if="!item.hasOwned",@click.stop="clickLi(index)",@mouseenter="liEnter(index,item.hasOwned)",@mouseleave="liLeave(item.hasOwned)")
                  img.pic(:src="item.picName+ '?x-oss-process=image/resize,w_60'")
                  .text 尚未获取
                  img.card-right(:class="isHoverIndex==index?'card-right-leave':''",src="../../img/star_store/gateopening_r.png")
                  img.card-left(:class="isHoverIndex==index?'card-left-leave':''",src="../../img/star_store/gateopening_l.png")
                .has-card(v-if="item.hasOwned",@click.stop="liEnter(index,item.hasOwned)")
                  img.use(v-if="index==usedIndex&&currentPage==usedPage",src="../../img/star_store/use.png")
                  img.new(v-if="item.new?true:false",src="../../img/star_store/new.png")
                  .text(v-if="!(index==0&&currentPage==1)") {{item.level}}/5
                  .text-no(v-if="index==0&&currentPage==1")
                  img.pic(:src="item.picName+ '?x-oss-process=image/resize,w_60'")
      .pre(v-if="currentPage > 1&&isShowPre",@click.stop="pre")
        .icon-arrow-left
      .next(v-if="currentPage < totalPage",@click.stop="next")
        .icon-arrow-right
      .nexus-left(:class="{'nexus-left-0':type==0,'nexus-left-1':type==1}")
        .text-title
          vk-slide-text(class="animated zoomIn",v-if="!isShowAnimation",:text="currentShow.name",:isAutoSlide="true")
        .show-stage
          img.bottom(v-if="type==0",src="../../img/star_store/ship_s_stage.png")
          img.bottom(v-if="type==1",src="../../img/star_store/pet_s_stage.png")
          img.light(src="../../img/star_store/light.png",v-if="isHomeShow")
          .pic(:class="{'pic-animation':isShowAnimation}")
            img(:src="currentShow.pic+ '?x-oss-process=image/resize,w_185'")
        .use-button(v-if="isPad",@click.stop="setHomeShow",:style="isHomeShow==0?'background-color:#3a1c7a':''")
          span(:style="{transform:isHomeShow==1?'scale(1)':'scale(0)',transition: 'transform 0.8s'}") ON
          span(:style="{transform:isHomeShow==0?'scale(1)':'scale(0)',marginLeft:'5px',transition: 'transform 0.8s',color:'rgba(255,255,255,0.2)'}") OFF
          .use-circle(:class="{'use-circle-yes':isHomeShow==1}")
        .use-text(v-if="type==0&&isPad")
          | 在首页展示飞船
        .use-text(v-if="type==1&&isPad")
          | 在首页展示宠物
      .nexus-page
        ul.nexus-page-inner
          li(v-for="n in totalPage",:class="{'page-li-active':(n)==currentPage}")
      .nexus-bottom
        .start-button(@click.stop="twistShip")
          template(v-if="type==0")
            span.text-cn
              | 飞船扭蛋
            span.text-en
              | The new spaceship
            span.text-number
              | X 15
          template(v-if="type==1")
            span.text-cn
              | 宠物扭蛋
            span.text-en
              | The new pet
            span.text-number
              | X 30
          .icon-star
      level-up.detail(v-if="isShowDetail",:currentType="type",:info="currentInfo",:index="currentIndex",
      :allIndex="currentIndex+(currentPage-1)*15",
      :usingIndex="usedSequence",
      :usingLevel="usedLevel",
      :level="currentLevel",
      :stars="currentStar",
      @useEvent="fetchDefault",
      @levelUpEvent="upFinish",
      @errorMsg="errorMsg")
    .nexus-kuang
    transition(leave-active-class="animated fadeOutLeft",enter-active-class="animated fadeInLeft")
      .message-word(v-if="isShowTip")
        img.dino(src="../../img/common/sweaty-dinosaurs.png")
        span {{tipText}}
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import vkSlideText from '../common/vk_slide_text.vue'
  import levelUp from './levelinfo.vue'
  import formUrlencoded from 'form-urlencoded'
  import Vue from 'vue'
  import error from '../common/vk_net_error.vue'

  export default {
    data: function () {
      return {
        isShowAcs: true,
        isShowPet: false,
        isPad: false,
        currentShow: {
          name: "",
          pic: "",
          id: ""
        },
        isHomeShow: 0,
        currentPage: 1,
        isHoverIndex: -1,
        currentLevel: 1,
        currentIndex: 2,
        isShowDetail: false,
        totalPage: 0,
        isShowNext: false,
        initOpen: true,
        acs: [],
        pets: [],
        currentInfo: [],
        isRefresh: false,
        usedIndex: -1,
        usedLevel: -1,
        usedPage: -1,
        usedSequence: -1,
        isShowLottery: true,
        isShowTip: false,
        tipText: "",
        setTime: undefined,
        isAnimation: false,
        //用于动画是不显示
        isShowPre: true,
        isShowAnimation: false,
        isError: false
      }
    },
    props: ['type', 'showLottery', "currentStar", "starRefresh"],
    components: {vkSlideText, levelUp, error},
    computed: {},
    mounted () {
      this.fetchDefault()
      this.isShowPre = false
      this.isPad = this.isIpad()
      setTimeout(() => {
        this.isShowPre = true
      }, 800)
      setTimeout(() => {
        if (this.acs.length == 0) {
          this.isError = true
        }
      }, 5000)
    },
    watch: {
      type: function (o, n) {
        this.fetchDefault()
        this.hideDetail()
        this.isShowPre = false
        setTimeout(() => {
          this.isShowPre = true
        }, 800)
        if (n == 0) {
          this.isShowAcs = false
        } else {
          this.isShowAcs = true
        }
        if (n == 1) {
          this.isShowPet = false
        } else {
          this.isShowPet = true
        }
      }
    },
    methods: {
      //Mozilla/5.0 (iPad; CPU OS 8_2 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Mobile/12D508 vkhybrid/0.0.1 study-app/2.5.1 --ipad
      isIpad() {
        //是在ipad上，且版本2.6以上
        if (cookies.get("isFromApp")) {
          const ua = navigator.userAgent.toLowerCase()
          if (ua && ua != "") {
            const u = ua.split("study-app\/")
            const u1 = u[1]
            if (u1) {
              const v1 = parseInt(u1.split(".")[0])
              const v2 = parseInt(u1.split(".")[1])
              if (u1 && v1 > 1 && v2 > 5) {
                return true
              } else {
                return false
              }
            } else {
              return false
            }
          } else {
            return false
          }
        } else {
          return true
        }
      },
      errorMsg(msg){
        this.showTip(msg)
      },
      fetchDefault() {
        let url
        if (this.type == 0) {
          url = "/rest/learninggw/api/pc/service/aircraft/getCurrentAircraftInfo"
        }
        if (this.type == 1) {
          url = "/rest/learninggw/api/pc/service/pet/getCurrentPetInfo"
        }
        axios.get(url, {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (this.type == 0) {
            this.currentShow.name = res.data.data.englishName
            this.usedLevel = res.data.data.level
            this.currentShow.id = res.data.data.actemplateId
          }
          if (this.type == 1) {
            this.currentShow.name = res.data.data.name
            this.usedLevel = 1
            this.currentShow.id = res.data.data.petTemplateId
          }
          this.currentShow.pic = res.data.data.picName
          this.isHomeShow = res.data.data.display
          this.usedPage = res.data.data.currentPage
          this.usedIndex = (res.data.data.sequence - 1) % 15
          this.usedSequence = res.data.data.sequence
          this.currentPage = res.data.data.currentPage
          this.$nextTick(() => {
            this.isShowAnimation = true
            setTimeout(() => {
              this.isShowAnimation = false
            }, 200)
          })
          this.fetchData()
        })
      },
      fetchData(fetchNew) {
        let url
        if (this.type == 0) {
          this.acs = []
          url = "/rest/learninggw/api/pc/service/aircraft/findAllAirCraftByStudentId"
        }
        if (this.type == 1) {
          this.pets = []
          url = "/rest/learninggw/api/pc/service/pet/findAllPetByStudentId"
        }
        axios.get(url, {
          params: {
            studentId: cookies.get("studentId"),
            start: this.currentPage
          }
        }).then((res) => {
          if (this.type == 0) {
            this.acs = res.data.data.list
          }
          if (this.type == 1) {
            this.pets = res.data.data.list
          }
          this.isError = false
          this.totalPage = res.data.data.totalPage
          if (fetchNew) {
            fetchNew()
          }
        })
      },
      next(){
        //暂停一秒
        if (this.isAnimation) {
          return
        }
        this.setTime = setTimeout(() => {
          clearTimeout(this.setTime)
          this.isAnimation = false
        }, 1000)
        this.isAnimation = true
        this.hideDetail()
        this.isRefresh = true
        setTimeout(() => {
          this.isRefresh = false
          if (this.currentPage < this.totalPage) {
            this.currentPage++
            this.fetchData()
          } else {
            this.isShowPre = false
          }
        }, 200)
        this.$playSound("click")
      },
      pre(){
        //暂停一秒
        if (this.isAnimation) {
          return
        }
        this.setTime = setTimeout(() => {
          clearTimeout(this.setTime)
          this.isAnimation = false
        }, 1000)
        this.isAnimation = true
        this.hideDetail()
        this.isRefresh = true
        setTimeout(() => {
          this.isRefresh = false
          if (this.currentPage > 0) {
            this.currentPage--
            this.fetchData()
          } else {
            this.isShowNext = false
          }
        }, 500)
        this.$playSound("click")
      },
      hideDetail(){
        this.isShowDetail = false
      },
      clickLi(i){
        this.hideDetail()
        if (this.setTime) {
          clearTimeout(this.setTime)
        }
        this.isHoverIndex = i
        this.setTime = setTimeout(() => {
          this.isHoverIndex = -1
        }, 2000)
        this.$playSound("click")
      },
      liEnter(i, hasOwned){
        if (hasOwned) {
          if (this.isShowDetail && this.currentIndex == i) {
            this.isShowDetail = false
            return
          }
          this.isShowDetail = true
          if (this.type == 0) {
            this.currentInfo = this.acs[i].airCraftTemplates
            this.currentLevel = this.acs[i].level
          }
          if (this.type == 1) {
            this.pets[i].chineseName = this.pets[i].name
            this.pets[i].chineseDesc = this.pets[i].chineseDescription
            this.pets[i].englishDesc = this.pets[i].englishDescription
            let info = []
            info.push(this.pets[i])
            this.currentInfo = info
            this.currentLevel = 1
          }
          this.currentIndex = i
        } else {
          this.hideDetail()
          this.isHoverIndex = i
        }
      },
      liLeave(hasOwned){
        if (hasOwned) {
          this.isShowDetail = false
        } else {
          this.isHoverIndex = -1
        }
      },
      setHomeShow() {
        if (this.isHomeShow) {
          this.isHomeShow = 0
        } else {
          this.isHomeShow = 1
          this.isShowAnimation = true
          setTimeout(() => {
            this.isShowAnimation = false
          }, 200)
        }
        axios.post('/rest/learninggw/api/pc/service/studentstar/changPetAircraftDisplayStatus',
          formUrlencoded({
            studentId: cookies.get('studentId'),
            isShow: this.isHomeShow,
            type: this.type
          })).then((res) => {
          if (this.type == 0) {
            sa.track('learning_click', {
              'click_id': `pc_learning_star_store_airship_homeshow_${this.currentShow.id}_${this.isHomeShow}`
            })
          }
          if (this.type == 1) {
            sa.track('learning_click', {
              'click_id': `pc_learning_star_store_pet_homeshow_${this.currentShow.id}_${this.isHomeShow}`
            })
          }
        })
        this.$playSound("click")
      },
      showTip(text){
        if (!this.isShowTip) {
          this.tipText = text
          this.isShowTip = true
          setTimeout(() => {
            this.isShowTip = false
          }, 2000)
        }
      },
      twistShip() {
        this.hideDetail()
        this.$playSound("click")
        let url
        if (this.type == 0) {
          sa.track('learning_click', {
            'click_id': 'pc_learning_star_store_airship_click_lottery'
          })
          if (this.currentStar < 15) {
            this.showTip("星星数量不足")
            return
          }
          url = "/rest/learninggw/api/pc/service/aircraft/create"
        }
        if (this.type == 1) {
          sa.track('learning_click', {
            'click_id': 'pc_learning_star_store_pet_click_lottery'
          })
          if (this.currentStar < 30) {
            this.showTip("星星数量不足")
            return
          }
          url = "/rest/learninggw/api/pc/service/pet/insert"
        }
        axios.post(url, formUrlencoded({
          studentId: cookies.get("studentId")
        })).then(res => {
          if (res.data.code == 200) {
            this.showLottery(res.data.data.picName)
            this.currentPage = res.data.data.currentPage
            this.starRefresh()
            this.fetchData(() => {
              res.data.data.new = true
              res.data.data.hasOwned = 1
              if (this.type == 0) {
                Vue.set(this.acs, res.data.data.sequence % 15 - 1, res.data.data)
              }
              if (this.type == 1) {
                Vue.set(this.pets, res.data.data.sequence % 15 - 1, res.data.data)
              }
            })
          } else {
            this.showTip("都抽完了")
          }
        }).catch(err => {
          this.showTip("都抽完了")
        })
      },
      upFinish(){
        this.currentLevel++
        this.fetchData()
        this.starRefresh()
      }
    }
  }
</script>

<style lang="stylus" scoped>
  .nexus-detail
    .nexus-leave
      animation leave 1s ease
      -webkit-animation leave 1s ease
    .nexus-in
      animation: keyin 1s ease
      -webkit-animation keyin 1s ease
    .error
      width: 300px
      margin: 100px auto
    .nexus-body
      position: relative
      height: 492px
      width: 1040px
      border-radius: 40px
      overflow: hidden
      background: url("../../img/star_store/bg_net.png")
      .pre
        position: absolute
        left: 360px
        top: 190px
        transform: scale(0.8, 0.8)
        opacity: 0.5
        cursor: pointer
        &:hover
          animation: btnLeft 1s infinite
      .next
        position: absolute
        right: 20px
        top: 190px
        transform: scale(0.8, 0.8)
        opacity: 0.5
        cursor: pointer
        &:hover
          animation: btnRight 1s infinite
      .nexus-bg
        position: absolute
        right: 10px
        top: 10px
        height: 492px
        width: 730px
        animation-fill-mode: forwards
        background: url("../../img/star_store/gatebg.png") no-repeat
        .nexus-inner
          position: absolute
          height: 340px
          width: 620px
          right: 15px
          top: 24px
          padding: 10px 0
          overflow: hidden
          ul
            transition: transform 1s
          .item-refresh
            animation: fresh 1s
          .nexus-item
            position: relative
            float: left
            box-sizing: border-box
            width: 100px
            height: 100px
            margin-right: 20px
            margin-bottom: 20px
            border-radius: 20px
            border: solid 4px rgb(155, 167, 241)
            background-color: rgba(115, 115, 117, 0.34)
            .no-card
              height: 90px
              width: 100px
              padding-top: 5px
              margin: -4px
              background: url(../../img/star_store/gate.png) no-repeat
            .has-card
              margin: -4px
              padding-top: 13px
              height: 100px
              width: 100px
              background: url(../../img/star_store/gate.png) no-repeat
              cursor: pointer
              .use
                position: absolute
                top: -10px
                right: -10px
              .new
                position: absolute
                left: -5px
                bottom: 0
            .pic
              height: 60px
            .text
              font-size: 12px
              color: #FFFFFF
            .text-no
              height: 7px
            .card-right
              position: absolute
              right: -2px
              top: -4px
              transition: right 0.5s
            .card-right-leave
              right: -60px
            .card-left
              position: absolute
              left: -4px
              top: -4px
              transition: left 0.5s
            .card-left-leave
              left: -60px
      .nexus-left-0
        animation: leftInAc 1s
      .nexus-left-1
        animation: leftInPet 1s
      .nexus-left
        height: 480px
        width: 300px
        text-align: center
        .text-title
          width: 220px
          height: 25px
          color: #FFFFFF
          margin: 60px auto 30px auto
          cursor: auto
          font-size: 20px
        .show-stage
          position: relative
          height: 300px
          .pic
            position: absolute
            height: 180px
            width: 300px
            text-align: center
            top: 15px
            animation: picKey 3s
            img
              height: 185px
              margin: auto
          .pic-animation
            animation: none
          .light
            position: absolute
            width: 235px
            left: 35px
            top: 100px
            animation: lightKey 3s
          .bottom
            position: absolute
            height: 80px
            top: 200px
            left: 55px
        .use-button
          position: relative
          width: 55px
          height: 18px
          margin: 0 auto 5px auto
          border-radius: 14px
          background-color: rgb(160, 97, 253)
          border: solid 4px rgba(110, 79, 198, 0.54)
          font-size: 12px
          color: #FFFFFF
          cursor: pointer
          span
            display: inline-block
            line-height: 20px
          .use-circle
            box-sizing: border-box
            position: absolute
            width: 25px
            height: 25px
            top: -3px
            left: 0
            border-radius: 12.5px
            background-color: rgb(133, 97, 237)
            box-shadow: inset 0 -2px 0 0 rgba(0, 0, 0, 0.2)
            transition: left 0.5s
          .use-circle-yes
            left: 30px
        .use-text
          font-size: 12px
          text-align: center
          color: rgb(172, 144, 255)
      .nexus-page
        position: absolute
        right: 50px
        bottom: 90px
        width: 620px
        text-align: center
        .nexus-page-inner
          height: 20px
          margin: auto
          li
            display: inline-block
            width: 30px
            height: 4px
            margin-left: 10px
            border-radius: 3px
            background-color: rgb(117, 127, 195)
          .page-li-active
            background-color: rgb(189, 197, 255)
      .nexus-bottom
        position: absolute
        right: 260px
        bottom: 30px
        .start-button, .start-button-disable
          height: 50px
          width: 200px
          border-radius: 46px
          box-shadow: inset 0 -3px 0 0 rgb(125, 74, 215)
          background: rgb(160, 97, 253) url("../../img/icon/icon_header.png") -414px -367px no-repeat
          color: #FFFFFF
          cursor: pointer
          &:hover
            background-color: rgb(172, 132, 231)
            box-shadow: inset 0 -3px 0 0 rgb(125, 74, 215)
          .text-cn
            position: absolute
            left: 58px
            top: 5px
            font-size: 16px
          .text-en
            position: absolute
            bottom: 14px
            right: 80px
            height: 12px
            font-size: 11px
            color: #fff
          .icon-star
            position: absolute
            right: 10px
            top: 2px
            background-size: 363px 243px
            background-position: 9px -60px
          .text-number
            position: absolute
            right: 40px
            top: 14px
            font-size: 16px
            color: rgb(255, 235, 86)
        .start-button-disable
          cursor: not-allowed
          box-shadow: inset 0 -6px 0 0 rgba(0, 0, 0, 0.1)
          background: rgb(192, 192, 192) url("../../img/icon/icon_header.png") -417px -370px no-repeat
          &:hover
            box-shadow: inset 0 -6px 0 0 rgba(0, 0, 0, 0.1)
            background: rgb(192, 192, 192) url("../../img/icon/icon_header.png") -417px -370px no-repeat
          .icon-star-disable
            position: absolute
            right: 10px
            top: 7px
            transform: scale(0.8)
    .nexus-kuang
      position: absolute
      height: 492px
      width: 1050px
      top: 60px
      pointer-events: none
      background: url("../../img/star_store/kuang.png") no-repeat
    .message-word
      position: absolute
      box-sizing: border-box
      width: 260px
      padding: 0 10px
      height: 80px
      border-radius: 85px
      background-color: rgba(255, 255, 255, 0.9)
      border: 2px solid rgba(0, 0, 0, 0.3)
      line-height: 80px
      font-size: 14px
      color: #555
      top: 245px
      left: 570px
      .dino
        position: absolute
        top: -30px
        left: -40px

  @keyframes leave
    from
      transform: translateX(0)
    to
      transform: translateX(100%)

  @keyframes keyin
    from
      transform: translateX(100%)
    to
      transform: translateX(0%)

  @-webkit-keyframes leave
    from
      -webkit-transform: translateX(0)
    to
      -webkit-transform: translateX(100%)

  @-webkit-keyframes keyin
    from
      -webkit-transform: translateX(100%)
    to
      -webkit-transform: translateX(0%)

  @keyframes btnLeft
    0%
      left: 360px
      opacity: 0.5
    50%
      left: 355px
      opacity: 0.8
    100%
      left: 360px
      opacity: 0.5

  @keyframes btnRight
    0%
      right: 20px
      opacity: 0.5
    50%
      right: 15px
      opacity: 0.8
    100%
      right: 20px
      opacity: 0.5

  @keyframes fresh
    from
      transform: rotateY(0)
    to
      transform: rotateY(360deg)

  @keyframes leftInAc
    from
      transform: translateY(100%)
    to
      transform: translateY(0)

  @keyframes leftInPet
    from
      transform: translateY(-100%)
    to
      transform: translateY(0)

  @keyframes picKey
    0%
      transform: translateY(0%)
      opacity: 1
    50%
      transform: translateY(-20%)
      opacity: 0.5
    100%
      transform: translateY(0%)
      opacity: 1

  @keyframes picUnKey
    0%
      transform: translateY(0%)
    50%
      transform: translateY(-20%)
    100%
      transform: translateY(0%)

  @keyframes lightKey
    0%
      transform: scaleX(1)
      opacity: 1
    50%
      transform: scaleX(0.8)
      opacity: 0.5
    100%
      transform: scaleX(1)
      opacity: 1


</style>
