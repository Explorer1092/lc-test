<template lang="jade">
  .levelinfo(:style="levelPosition")
    .triangle(:style="trianglePo",:class='triangleImg')
    .spaceship-zone
      .name-region
        vk-slide-text.chinese-name(:text="levels[current].chineseName",:isAutoSlide="true")
        vk-slide-text.english-name(:text="levels[current].englishName",:isAutoSlide="true")
      .pic-region
        img.theme-pic(:src="levels[current].picName+ '?x-oss-process=image/resize,w_65'",:style="currentType==1?'height:80px':''")
        .level-show(v-if="levels.length>1") {{levels[current].level}}/{{levels.length}}
      .description-region(:style="currentType==1?'height:140px':''")
        .guide 介绍：
        .chinese-des(v-text="levels[current].chineseDesc")
        .guide Introduce:
        .english-des(v-text="levels[current].englishDesc")
      .co-btn-prev.icon-arrow-left(v-if="canPrev",@click.stop="prevShow")
      .co-btn-next.icon-arrow-right(v-if="canNext",@click.stop="nextShow")
    .control-zone
      .control-btn(:class="{'control-btn-used':useStatus}")
        .use-btn(v-if="canUse && !useStatus",@click.stop="favoriteIt")
          | 使用 Use
        .use-btn(v-if="useStatus")
          | 使用中 In Used
        .levelup-btn(v-if="canLevelUp&&stars>needStar-1",@click.stop="startLevelUp")
          .icon-star
          .star-prefix {{needStar}}升级
          .star-text Tack you {{needStar}} to upLoad
        .frozen(v-if="frozenStatus")
          .icon-star-disable
          .star-prefix {{needStar}}升级
          .star-text Tack you {{needStar}} to upLoad
          .lock
        .frozen(v-if="canLevelUp&&stars<needStar")
          .icon-star-disable
          .star-prefix 不足{{needStar}}
          .star-text Tack you {{needStar}} to upLoad
          .lock
</template>
<script>
  import axios from 'axios'
  import formurlencoded from 'form-urlencoded'
  import cookies from 'cookies-js'
  const positionStyle = ['30px', '150px', '270px']
  const levelLeft = ['515px', '635px', "755px"]
  import vkSlideText from '../common/vk_slide_text.vue'
  import utils from '../../utils/_untils'
  export default {
    props: ['info', 'index', 'level', 'allIndex', 'currentType', 'usingIndex', 'usingLevel', 'stars'],
    data() {
      return {
        updatePic: '',
        useOne: '',
        useImg: '',
        value: -1
      }
    },
    watch: {
      index: function (o, n) {
        this.value = -1
      }
    },
    components: {vkSlideText},
    computed: {
      currentLevel(){
        return this.level
      },
      //按照level排序
      levels(){
        this.info = this.info.sort(utils.compare('level'))
        return this.info
      },
      current(){
        return this.level + this.value
      },
      levelPosition(){
        if (this.index == 0
          || this.index == 5
          || this.index == 10) {
          return {
            transformOrigin: "0 " + positionStyle[Math.floor(this.index / 5)],
            left: levelLeft[0]
          }
        }
        if (this.index == 3
          || this.index == 8
          || this.index == 13) {
          return {
            transformOrigin: "210px " + positionStyle[Math.floor(this.index / 5)],
            left: levelLeft[0]
          }
        }
        if (this.index == 1
          || this.index == 6
          || this.index == 11) {
          return {
            transformOrigin: "0 " + positionStyle[Math.floor(this.index / 5)],
            left: levelLeft[1]
          }
        }
        if (this.index == 4
          || this.index == 9
          || this.index == 14) {
          return {
            transformOrigin: "210px " + positionStyle[Math.floor(this.index / 5)],
            left: levelLeft[1]
          }
        }
        if (this.index == 2
          || this.index == 7
          || this.index == 12) {
          return {
            transformOrigin: "0 " + positionStyle[Math.floor(this.index / 5)],
            left: levelLeft[2]
          }
        }
      },
      useStatus() {
        return this.usingIndex == this.levels[this.current].sequence && (this.current + 1) == this.usingLevel
      },
      canUse() {
        return this.current <= this.currentLevel - 1 ? true : false
      },
      canLevelUp() {
        return this.current == this.currentLevel ? true : false
      },
      frozenStatus() {
        return this.current > this.currentLevel ? true : false
      },
      needStar() {
        return this.levels[this.current].price
      },
      trianglePo() {
        return {
          top: positionStyle[Math.floor(this.index / 5)]
        }
      },
      triangleImg() {
        return this.index % 5 == 3 || this.index % 5 == 4 ? 'trir' : 'tril'
      },
      canPrev() {
        return this.current > 0 ? true : false
      },
      canNext() {
        if (this.levels.length > 1) {
          return this.current <= 3 ? true : false
        } else {
          return false
        }
      }
    },
    methods: {
      prevShow() {
        this.value--
        this.$playSound("click")
      },
      nextShow() {
        this.value++
        this.$playSound("click")
      },
      //使用
      favoriteIt() {
        let url, param
        if (this.currentType == 0) {
          url = '/rest/learninggw/api/pc/service/aircraft/updateSetCurrent'
          param = {
            studentId: cookies.get("studentId"),
            actemplateId: this.levels[this.current].id
          }
          sa.track('learning_click', {
            'click_id': 'pc_learning_star_store_airship_used_' + this.levels[this.current].id
          })
        }
        if (this.currentType == 1) {
          url = '/rest/learninggw/api/pc/service/pet/updateSetCurrent'
          param = {
            studentId: cookies.get("studentId"),
            petTemplateId: this.levels[this.current].petTemplateId
          }
          sa.track('learning_click', {
            'click_id': 'pc_learning_star_store_pet_used_' + this.levels[this.current].petTemplateId
          })
        }
        axios.post(url, formurlencoded(param)).then((res) => {
          if (res.data.code == 200 && res.data.data == 1) {
            this.useOne = this.index * 5 + this.current + 1
            this.useImg = this.levels[this.current].picName
            this.$emit('useEvent')
          }
        }).catch(err => {
          let msg = err.response.data.msg
          this.$emit('errorMsg',msg)
        })
        this.$playSound("click")
      },
      startLevelUp() {
        let url = '/rest/learninggw/api/pc/service/aircraft/upgrade'
        axios.post(url, formurlencoded({
          studentId: cookies.get('studentId'),
          sequence: this.allIndex + 1
        }))
          .then(res => {
            this.updatePic = res.data.data.picName
            const updateIndex = this.current
            this.levels[updateIndex].picName = this.updatePic
            this.value--
            this.$emit('levelUpEvent')
            sa.track('learning_click', {
              'click_id': 'pc_learning_star_store_airship_update_' + this.levels[this.current].id
            })
          })
          .catch(err => {
            let msg = err.response.data.msg
            this.$emit('errorMsg',msg)
          })
        this.$playSound("click")
      }
    }
  }
</script>
<style lang="stylus" scoped>
  .levelinfo
    position: absolute
    top: 40px
    width: 210px
    height: 340px
    background: url('../../img/star_store/morebg.png') no-repeat
    background-size: 100.5% 100%
    border-radius: 17px
    border: 4px solid rgb(195, 204, 255)
    transition: left 0.3s
    animation: big 0.4s

  .triangle
    position: absolute
    width: 24px
    height: 30px
    background-size: cover
    transition: top 0.3s

  .tril
    left: -22px
    top: 15px
    background-image: url('../../img/star_store/group.png')

  .trir
    left: 208px
    background-image: url('../../img/star_store/gr.png')

  .name-region
    padding-top: 20px
    text-align: center

  .chinese-name
    width: 90%
    margin: auto
    font-size: 14px
    color: #fff

  .english-name
    width: 90%
    margin: auto
    font-size: 12px
    color: rgba(#fff, .75)

  .pic-region
    height: 68px
    margin: 0 auto
    margin-top: 10px

  .description-region
    width: 192px
    height: 118px
    margin: 0 auto
    margin-top: 20px
    border-radius: 6px
    background-color: rgba(255, 255, 255, .2)
    overflow: auto
    text-align: left

  .description-region::-webkit-scrollbar
    background-color: transparent
    width: 4px
    opacity: 0.3

  .description-region::-webkit-scrollbar-thumb
    width: 2px
    background-color: rgba(255, 255, 255, .3)
    border-radius: 2px

  .guide
    color: #fff
    font-size: 12px
    padding: 8px

  .chinese-des, .english-des
    padding-left: 8px
    color: rgba(#fff, .5)
    font-size: 12px
    font-weight: 600
    line-height: 1.3
    margin-bottom: 10px

  .co-btn-prev
    position: absolute
    top: 80px
    left: 40px
    width: 13px
    height: 20px
    cursor: pointer
    background-size: 90px 60px
    background-position: -30px -17px
    animation: btnLeft ease 1s

  .co-btn-next
    position: absolute
    top: 80px
    right: 40px
    width: 13px
    height: 20px
    cursor: pointer
    background-size: 90px 60px
    background-position: -44px -17px
    animation: btnRight ease 1s

  .co-btn-prev-dis
    position: absolute
    top: 80px
    left: 50px
    width: 13px
    height: 15px
    background-size: cover

  .co-btn-next-dis
    position: absolute
    top: 80px
    right: 50px
    width: 13px
    height: 15px
    background-size: cover

  .control-btn
    width: 150px
    height: 34px
    margin: 0 auto
    margin-top: 15px
    color: #fff
    font-size: 12px
    text-align: center
    line-height: 17px
    border-radius: 46px
    box-shadow: inset 0 -3px 0 0 rgb(125, 74, 215)
    background: rgb(160, 97, 253) url("../../img/icon/icon_header.png") -417px -370px no-repeat
    &:hover
      background-color: rgb(172, 132, 231)
      box-shadow: inset 0 -3px 0 0 rgb(125, 74, 215)

  .control-btn-used
    width: 150px
    height: 34px
    opacity: 0.54
    border-radius: 47.6px
    background: rgba(26, 0, 64, 0.7)
    box-shadow: none
    cursor: auto
    &:hover
      background-color: rgba(26, 0, 64, 0.7)
      box-shadow: none

  .theme-pic
    height: 65px

  .level-show
    text-align: center
    color: #fff
    line-height: 0.5
    opacity: 0.8
    font-size: 12px

  .use-btn
    cursor: pointer
    line-height: 30px

  .levelup-btn, .frozen
    position: relative
    cursor: pointer
    .star-prefix
      float: right
      width: 130px
    .icon-star
      position: absolute
      transform: scale(0.4, 0.4)
      left: 38px
      top: -9px
    .icon-star-disable
      position: absolute
      transform: scale(0.5, 0.5)
      left: 38px
      top: -7px

  .frozen
    width: 150px
    height: 34px
    cursor: not-allowed
    border-radius: 46px
    box-shadow: inset 0 -6px 0 0 rgba(0, 0, 0, 0.1)
    background: rgb(192, 192, 192) url("../../img/icon/icon_header.png") -417px -370px no-repeat

  .lock
    width: 10px
    height: 11px
    position: absolute
    top: 2px
    right: 20px

  .star-text
    font-size: 12px
    transform: scale(0.8, 0.8)

  @keyframes btnLeft
    0%
      left: 40px
    50%
      left: 35px
    100%
      left: 40px

  @keyframes btnRight
    0%
      right: 40px
    50%
      right: 35px
    100%
      right: 40px

  @keyframes big
    from
      transform: scale(0)
    to
      transform: scale(1)
</style>
