<template lang="jade">
.rankings-list
  .content-top-all-list(v-if="showAllList", :class="{'add-padding': scrollContentList.length >= 7}")
    .content-top-translucent-cover
    .content-top-title.animated.slideInDown
      span 姓名
      span 分数
    .previous-rankings-btn-all-list(@click="goPre", v-if="!hideCheckRankBtn")
      img(v-if="!isPre", src="../../../img/rankings/rank_icon@2x.png")
      img(v-if="isPre", src="../../../img/rankings/back-jet@2x.png")
  transition(@leave="contentTopLeave",@before-enter="contentTopbeforeEnter",@enter="contentTopEnter",)  
    .content-top(:class="{'content-top-many': isMany}",v-if="!showAllList",@touchstart.stop="touchStartEvFn($event)",@touchmove.stop="touchMoveFn($event)", @mousewheel.stop="mouseWheelMove($event)", @DOMMouseScroll.stop="mouseWheelMove($event)")
      .previous-rankings-btn(v-if="!hideCheckRankBtn")
        img(v-if="!isPre", src="../../../img/rankings/rank_icon@2x.png")
        img(v-if="isPre", src="../../../img/rankings/back-jet@2x.png")
        .text(@click="goPre") {{isPre ? "返回本期": "上期榜单"}}
      template(v-for="item in topRankArr", v-if="topRankArr.length > 0")
        user-header(:item="item", @showDetail="showDetail", :key="item.rankingScoreId", :doAnimated="doAnimated")
  .content-list(@scroll="onscroll", @touchstart.stop="touchStartEvFn($event, 'list')",@touchmove.stop="touchMoveFn($event, 'list')", @mousewheel.stop="mouseWheelMove($event, 'list')", @DOMMouseScroll.stop="mouseWheelMove($event, 'list')", ref="contentList", :class="{'slideInUp': doAnimated, 'animated': true, 'max-screen-height': showAllList, 'scroll-hidden': scrollContentList.length === 5}")
    template(v-for="item in scrollContentList")
      list-item(:isSelf="item.isSelf", :item="item", @showDetail="showDetail", :key="item.rankingScoreId")
  .translucent-cover
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import userHeader from './rankings_user_header.vue'
  import listItem from './rankings_list_item.vue'
  export default {
    props: {
      //隐藏榜单切换按钮
      hideCheckRankBtn: {
        type: Boolean,
        default: false
      },
      //是否是上一期
      isPre: {
        type: Boolean,
        default: false
      },
      getRankingListDetail: {
        type: Boolean,
        default: false
      },
      preRankingInfo: {
        type: Object,
        default() {
          return {}
        }
      },
      nowRankingInfo: {
        type: Object,
        default() {
          return {}
        }
      },
      //是否显示加载动画
      showLoading: {
        type: Boolean,
        default: false
      }
    },
    data(){
      return {
        hasJuxtaposition: false,
        topRankArr: [], //前几名
        afterRankArr:[], //后几名
        allRankArr: [], //所有排名
        showAllList: false, //全列表显示
        isMany: true, //10个人榜
        scrollTopData: 0,
        timer: 0,
        doAnimated: false,
        startY: 0
      }
    },
    watch: {
      getRankingListDetail: function (val, old) {
        if (val) {
          let teamSign = this.isPre ? this.preRankingInfo.teamSign : this.nowRankingInfo.teamSign
          let rankingConfigId = this.isPre ? this.preRankingInfo.rankingConfigId : this.nowRankingInfo.rankingConfigId
          this.getRankListDetail(teamSign, rankingConfigId)
        }
      },
      showLoading: function (val, old) {
        if (!val && old) {
          this.doAnimated = true
        }
      }
    },
    computed: {
      scrollContentList() {
        return this.showAllList ? this.allRankArr : this.afterRankArr
      }
    },
    components: {
      userHeader,
      listItem
    },
    beforeDestroy() {
      if (this.timer) {
        clearTimeout(this.timer)
      }
    },
    methods: {
      touchStartEvFn(event, target) {
        this.startY = event.touches[0].pageY
      },
      touchMoveFn(event, target) {
        let endY = event.changedTouches[0].pageY
        //关闭详情卡片
        this.$emit('closeDetailCard')
        this.doAnimated = false
        if (parseInt(endY) - parseInt(this.startY) < 0) {
          // 手指向上滑动
          if (this.isMany && !this.showAllList && target !== 'list') {
            this.showAllList = true
          } 
        } else {
          if (target === 'list') {
            if (!this.hasJuxtaposition && this.isMany && this.showAllList && this.$refs.contentList.scrollTop === 0) {
              this.showAllList = false
            }
          }
        }
      },
      //鼠标滚轮事件
      mouseWheelMove(evt, target) {
        //关闭详情卡片
        this.$emit('closeDetailCard')
        this.doAnimated = false
        if (evt.wheelDelta) { //判断浏览器IE，谷歌滑轮事件
          if (evt.wheelDelta < 0) {
            if (this.isMany && !this.showAllList && target !== 'list') {
              this.showAllList = true
            }
          } else {
            if (target === 'list') {
              if (!this.hasJuxtaposition && this.isMany && this.showAllList && this.$refs.contentList.scrollTop === 0) {
                this.showAllList = false
              }
            }
          }
        } else if (evt.detail) { //Firefox滑轮事件
          if (evt.detail > 0) {
            if (this.isMany && !this.showAllList && target !== 'list') {
              this.showAllList = true
            }
          } else {
            if (target === 'list') {
              if (!this.hasJuxtaposition && this.isMany && this.showAllList && this.$refs.contentList.scrollTop === 0) {
                this.showAllList = false
              }
            }
          }
        }
      },
      //过滤列表数据
      filterArrData(arr) {
        if (!arr || arr.length === 0) {
          return
        }
        let topRankArr = []
        let afterRankArr = []
        let studentId = cookies.get("studentId")
        let rankObj = {
          '1': 0,
          '2': 0,
          '3': 0
        }
        for (let i = 0; i < arr.length; i++) {
          if (parseInt(arr[i].studentId) === parseInt(studentId)) {
            arr[i].isSelf = true
          } else {
            arr[i].isSelf = false
          } 
          if (i < 3) {
            //前三名
            switch(i) {
            case 0:
              topRankArr[1] = arr[i]
              break
            case 1:
              topRankArr[0] = arr[i]
              break
            case 2:
              topRankArr[i] = arr[i]
              break
            }
            rankObj[arr[i].rank + '']++
          } else {
            //后几名
            afterRankArr.push(arr[i])
          }
        }
        //前三名有并列的情况 全列表显示 不再有动画效果
        if (rankObj['1'] > 1 || rankObj['2'] > 1 || rankObj['3'] > 1 || arr[3].rank === 3) {
          this.hasJuxtaposition = true
          this.showAllList = true
          topRankArr = []
        } else {
          this.showAllList = false
          this.hasJuxtaposition = false
        }
        this.topRankArr = topRankArr
        this.afterRankArr = afterRankArr
        this.allRankArr = arr
      },
      //获取排行榜列表详情
      getRankListDetail(teamSign, rankingConfigId) {
        axios.get(`/rest/learninggw/api/rank/score/getGroupRankDetail`, {
          params: {
            studentId: cookies.get("studentId"),
            teamSign: teamSign,
            rankingConfigId: rankingConfigId
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data.length > 5) {
              this.isMany = true
            } else {
              this.isMany = false
            }
            this.filterArrData(res.data.data)
            this.$emit('resetGetRankingListDetail', true)
          } else {
            this.$showToast("请求出错了")
            this.$emit('resetGetRankingListDetail', false)
          }
        }).catch(() => {
          this.$emit('resetGetRankingListDetail', false)
          this.$showToast("请求出错了")
        })
      },
      contentTopbeforeEnter(el) {
        el.style.opacity = 0
        el.style.height = 0
      },
      contentTopEnter(el, done) {
        Velocity(el, { 
          opacity: 1,
          height: '196px'
        }, { complete: done })
      },
      contentTopLeave(el, done) {
        if (this.hasJuxtaposition) {
          done()
          return
        }
        let box = el.querySelector('.previous-rankings-btn')
        if (box) {
          box.setAttribute('style', `display: none`)
        }
        Velocity(el, {
          height: '0',
          opacity: 0
        }, { complete: done })
      },
      onscroll(ev) {
        //关闭详情卡片
        this.$emit('closeDetailCard')
        this.doAnimated = false
        if (!this.hasJuxtaposition) {
          if (ev.target.scrollTop - this.scrollTopData > 0) {
            //'向下'
            if (this.isMany && !this.showAllList && ev.target.scrollTop > 0 && this.scrollTopData > 0) {
              this.showAllList = true
            }
          } else {
            //'向上'
            if (ev.target.scrollTop < 20) {
              if (this.isMany && this.showAllList) {
                this.showAllList = false
                //ev.target.scrollTop = 0
              }
            } else {
              if (this.timer) {
                clearTimeout(this.timer)
              }
              this.timer = setTimeout(this.closeAllList, 10)
            }
          }
          this.scrollTopData = ev.target.scrollTop
        }
      },
      closeAllList() {
        if (this.isMany && this.showAllList && this.$refs.contentList.scrollTop <= 10) {
          this.showAllList = false
        }
      },
      showDetail(data) {
        this.$emit('showDetail', data)
      },
      goPre() {
        this.$emit("goPre")
        this.doAnimated = false
        this.$refs.contentList.scrollTop = '0px'
      }
    }
  }
</script>
<style lang="stylus" scoped>
.rankings-list
  height: 417px
  overflow: hidden
  position: relative

  .content-top-all-list
    padding: 15px 0 0
    position: relative
    
    .content-top-translucent-cover
      position: absolute
      left: 123px
      bottom: -10px
      width: 613px
      height: 12px
      background: linear-gradient(180deg,rgba(151,109,255,1),rgba(151,109,255,0.36))
      box-shadow: 0px -2px 4px 0px rgba(69,0,93,0.01)

    .content-top-title
      width: 600px
      height: 33px
      background: linear-gradient(180deg,rgba(149,119,255,0.6),rgba(199,175,255,0.16))
      border-radius: 0px 0px 29px 29px
      margin: 0 auto
      box-sizing: border-box
      padding: 0 30px 0 44px
      display: flex
      display: -webkit-flex
      align-items: center
      justify-content: space-between
      -webkit-align-items: center
      -webkit-justify-content: space-between
      font-size: 14px
      color: #fff

    .previous-rankings-btn-all-list
      position: absolute
      right : 74px
      top: 15px
      width: 44px
      height: 44px
      background-image: url("../../../img/rankings/lastboard-bg-s@2x.png")
      background-repeat: no-repeat
      background-size: 100% 100%
      cursor: pointer
      z-index: 2

      img 
        display: block
        width: 24px
        height: 24px
        margin: 8px auto 0

  .add-padding
    padding-right: 10px

  .content-top
    display: flex 
    display: -webkit-flex
    align-items: flex-end
    justify-content: center
    -webkit-align-items: flex-end
    -webkit-justify-content: center
    padding: 37px 0 28px
    position: relative

    .previous-rankings-btn
      position: absolute
      right : 74px
      top: 15px
      width: 100px
      height: 68px
      background-image: url("../../../img/rankings/lastboard-bg@2x.png")
      background-repeat: no-repeat
      background-size: 100% 100%
      cursor: pointer
      z-index: 2

      img 
        display: block
        width: 24px
        height: 24px
        margin: 8px auto 2px

      .text
        height: 20px
        font-size: 14px
        color: rgba(255,255,255,1)
        line-height: 20px
        text-align: center 

  .content-top-many
    padding: 17px 0 18px

  .content-list
    box-sizing: border-box
    width: 635px
    height: 357px
    padding-top: 10px
    margin: 0 auto
    overflow-x: hidden
    overflow-y: auto

    &::-webkit-scrollbar
      width: 10px

    &::-webkit-scrollbar-track
      background-color: transparent

    &::-webkit-scrollbar-thumb
      border-radius: 4px
      background-color: rgba(255,255,255,0.1)

  .scroll-hidden
    overflow: hidden

  .translucent-cover
    position: absolute
    left: 123px
    bottom: 0
    width: 613px
    height: 22px
    background: linear-gradient(180deg,rgba(151,109,255,0.36),rgba(151,109,255,1))
    box-shadow: 0px -2px 4px 0px rgba(69,0,93,0.01)

@media screen and (min-width: 1920px) 
  .rankings-list
    height: 617px
    padding-bottom: 10px
  
    .content-top-all-list
      padding: 21px 0 18px
      
      .content-top-translucent-cover
        width: 900px
  
      .content-top-title
        width: 760px
  
      .previous-rankings-btn-all-list
        right : 136px
        top: 21px
  
    .content-top
      padding: 21px 0 28px
  
      .previous-rankings-btn
        right : 136px
        top: 61px
  
    .content-top-many
      padding: 21px 0 28px
  
    .content-list
      width: 800px
      height: 440px
  
    .max-screen-height
      height: 540px 
  
    .translucent-cover
      width: 973px    
</style>

