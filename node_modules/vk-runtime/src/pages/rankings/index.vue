<template lang="jade">
.rankings-box
  //后退
  top-part(:isAbsoluteFix="true", :ifShow="false")
  index-bg
  .rankings-container.flex-center
    .rankings-content-wrapper(v-show="isAgreeRankings && !isNetError", :class="{'slideInDown': isAgreeRankings && isNeedAnimated, 'animated': isAgreeRankings && isNeedAnimated}", ref="rankingsContent")
      .rankings-ship
        .rankings-tabship
          .rankings-tabship-top
          .rankings-tabship-body(ref="tabsWrapper")
            .tab-selected(:style="tabSelectedBg")
            .rankings-tabs(:class="{'long-rankings-tabs': rankTabs.length < 4}", ref="tabs", :style="tabsBoxStyle")
              .tab-box-wrapper
                .tab-box(:class="{'tab-box-selected': tabIndex === index}",v-for="(item, index) in rankTabs", @click="fetchRanksInfo(item, index + 1)") {{item.rankingName}}
          .rankings-tabship-bottom
        .rankings-title {{rankTitle}}
        .rankings-timer {{rankTimer}}
        .rankings-status(v-show="rankingsStatus !== 3", :class="{'rankings-status-statistical': rankingsStatus === 1, 'rankings-status-over': rankingsStatus === 2}")
        .list-loading(v-show="showRankingListLoading")
          img(src="../../img/common/loading.gif")
        //列表区
        .rankings-list-box
          rankings-list(:isPre="isPre", :showLoading="showRankingListLoading", :preRankingInfo="preRankingInfo", :nowRankingInfo="nowRankingInfo", :getRankingListDetail="getRankingListDetail", @resetGetRankingListDetail="doResetGetRankingListDetail", @goPre="doPreRankings", @showDetail="showDetail", :hideCheckRankBtn="hideCheckRankBtn", @closeDetailCard="isShowDetail = false")
        .rankings-count-down(v-if="rankingsStatus === 0") {{cutDownDay >= 0 ? '距离下次结算剩余' : '本期榜单已经结束了'}}
          span {{cutDownDay >= 0 ? cutDownDay : ''}}
          span(v-if="cutDownDay >= 0") 天
        .rankings-count-down-msg(v-if="rankingsStatus !== 0") 
          .icon(v-if="rankingsStatus === 1")
          span(v-if="rankingsStatus === 1 || rankingsStatus === 2") {{ rankingsStatus === 1 ? '榜单结算中，本周二更新结果' : '榜单已公布'}}
          span(v-if="rankingsStatus === 3") 榜单已结束
        .rankings-direction(@click="isShowDirection = true") 规则说明
        get-stone(v-if="isAgreeRankings && isShowGift", :ranking="myRanking", :stoneNum="stoneNum", @goBackRank="goBackRank")
      transition(name="fade")
        .detail-card(v-if="isShowDetail", ref="detailCard")
          rankings-detail-card(:isNormal="detailCardData.isNormal", :isSelf="detailCardData.isSelf", :detailList="detailCardData.data", :studentInfo="detailCardData.studentInfo")
    //排行榜说明
    vkDialogSecret(:showDialog="isShowDirection", @closeIt="isShowDirection = false", :secretDialogType="'rankings'")
    agreeDialog(:isThisDialogShow="isThisDialogShow", @closeIt="doAgree")
    netError(v-if="isNetError")
</template>
<script>
  import axios from 'axios'
  import cookies from 'cookies-js'
  import TopPart from '../common/top_part.vue'
  import vkDialogSecret from '../common/vk_dialog_secret.vue'
  import netError from '../common/vk_net_error.vue'
  //排行榜列表
  import rankingsList from './components/rankings_list.vue'
  //领取能量石
  import getStone from './components/rankings_get_stone.vue'
  //用户协议
  import agreeDialog from './components/agree_dialog.vue'
  import rankingsDetailCard from './components/rankings_detail_card.vue'
  import formurlencoded from "form-urlencoded"
  import indexBg from '../index/components/index_bg.vue'
  import untils from '../../utils/_untils.js'
  export default {
    data(){
      return {
        detailCardData: {
          studentInfo: {
            studentName: '',
            ageGroup: '',
            city: '',
            levelTitle: ''
          },
          isNormal: true,
          isSelf: false,
          data: []
        },
        stoneNum: '', //获奖的能量石个数
        myRanking: 1, //我的排名结果
        rankTabs: [], //排行榜类型
        rankName:'', //排行榜名称
        hideCheckRankBtn: false, //隐藏本期与上期榜单切换按钮
        isNetError: false, //网络错误
        isNeedAnimated: false,
        isShowDetail: false, //显示详细信息
        rankingsStatus: 0, //排行榜状态，0 初始 1 统计中 2 已领奖 3 已经结束
        isPre: false, //是否是上一期榜单
        isThisDialogShow: false, //显示用户协议
        isAgreeRankings: false, //是否同意排行榜
        isShowGift: false, //显示领取礼物
        isShowDirection: false, //显示排行榜说明
        preRankingInfo: {}, //上期排行信息
        nowRankingInfo: {}, //当前排行信息
        getRankingListDetail: false, //获取列表详情
        rankTimer: '',
        isSend: false, //防抖
        cutDownDay: 1, //倒计时天数
        tabIndex: 0, //当前选中按钮
        showRankingListLoading: false, //显示列表加载
        sendDoAgree: false, //发送同意协议
        rankTitle: '',
        whichStudentId: 0 //当前显示的用户,排行榜详情信息
      }
    },
    computed: {
      tabSelectedBg() {
        return {
          top: this.rankTabs.length > 3 ? this.tabIndex * 80 + 'px' : this.tabIndex * 80 + 33 + 'px'
        }
      },
      tabsBoxStyle() {
        return {
          padding: this.rankTabs.length > 3 ? '2px 0 2px' : '35px 0 35px'
        }
      }
    },
    components: {
      TopPart,
      vkDialogSecret,
      rankingsList,
      getStone,
      agreeDialog,
      rankingsDetailCard,
      netError,
      indexBg
    },
    created(){
      this.checkRankEntry()
      this.fetchRankTabs()
    },
    mounted() {
      //点击页面其它地方去除详情弹出框
      if (cookies.get("isFromApp")) {
        document.addEventListener('touchend', this.delDetailCard)
      } else {
        document.addEventListener('click', this.delDetailCard)
      }
    },
    beforeDestroy() {
      if (cookies.get("isFromApp")) {
        document.removeEventListener('touchend', this.delDetailCard)
      } else {
        document.removeEventListener('click', this.delDetailCard)
      }
    },
    methods: {
      //获取排行榜类型
      fetchRankTabs() {
        axios.get(`/rest/learninggw/api/rank/score/findPageByStudentId`, {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200 && res.data.data.pageList.length) {
            //排行榜一期限定为一个tab 取第一个
            this.rankTabs.push(res.data.data.pageList[0])
            this.$nextTick(() => {
              this.fitHeight()
            })
            //默认取第一个
            this.fetchRanksInfo(this.rankTabs[0])
          } else {
            this.isNetError = true
          }
        }).catch(() => {
          this.isNetError = true
        })

      },
      //获取最近某一类排行榜最近两期的信息
      fetchRanksInfo(data, index) {
        if (this.isSend) {
          return
        }
        if (index) {
          //修改选中按钮背景
          this.setTabChecked(index - 1)
          sa.track('learning_click', {'click_id': 'pc_learning_rankings_genre_config_id_' + data.rankingConfigId})
        }
        this.isSend = true
        //设置排行榜名称
        this.rankName = data.rankingName
        axios.get(`/rest/learninggw/api/rank/score/getRecordByStudentIdAndRankingConfigId`, {
          params: {
            studentId: cookies.get("studentId"),
            rankingConfigId: data.rankingConfigId
          }
        }).then((res) => {
          this.isSend = false
          if (res.data.code == 200 && res.data.data) {
            if (res.data.data.length === 2) {
              //分出当前期
              if (res.data.data[0].fromDate > res.data.data[1].fromDate) {
                this.preRankingInfo = res.data.data[1]
                this.nowRankingInfo = res.data.data[0]
              } else {
                this.preRankingInfo = res.data.data[0]
                this.nowRankingInfo = res.data.data[1]
              }
              //判断前一期是否有宝箱
              if (this.preRankingInfo.rankingTreasureBoxStatus === 'CLOSE') {
                this.isPre = true
                this.checkRankingInfo()
                this.myRanking = this.preRankingInfo.rank || 1
                this.stoneNum = this.preRankingInfo.eggshellNumber + '' || ''
                this.showGift(this.preRankingInfo.rankingScoreId) //领奖
              } else {
                this.isPre = false
                this.checkRankingInfo()
              }
            } else {
              //没有上一期的情况
              this.hideCheckRankBtn = true
              this.nowRankingInfo = res.data.data[0]
              this.isPre = false
              this.checkRankingInfo()
            }
          } else {
            this.isNetError = true
          }
        }).catch(() => {
          this.isNetError = true
          this.isSend = false
        })
      },
      //更换排行榜当前展示信息
      checkRankingInfo() {
        this.getRankingListDetail = true //执行排行榜列表数据请求
      },
      //检查排行榜入口
      checkRankEntry() {
        axios.get(`/rest/learninggw/api/rank/score/getEntranceStatusByStudentId`, {
          params: {
            studentId: cookies.get("studentId")
          }
        }).then((res) => {
          if (res.data.code == 200) {
            if (res.data.data === 'SHOW') {
              this.isAgreeRankings = true
              this.$nextTick(() => {
                this.fitHeight()
              })
            } else if (res.data.data === 'NEED_AGREE_PROTOCOL') {
              this.isThisDialogShow = true
              this.isNeedAnimated = true
            } else {
              untils.gotoFirstPage()
            }
          } else {
            this.isNetError = true
          }
        }).catch(() => {
          this.isNetError = true
        })
      },
      //显示详细信息
      showDetail(data) {
        this.detailCardData = data
        for (let key in this.detailCardData) {
          this.detailCardData[key] = data[key]
        }
        if (this.isShowDetail) {
          if (this.whichStudentId !== data.studentInfo.studentId) {
            this.isShowDetail = false
            this.$nextTick(() => {
              this.isShowDetail = true
              this.whichStudentId = data.studentInfo.studentId
              this.$nextTick(() => {
                this.setDetailCardOrientation(data)
              })
            })
          } else {
            this.isShowDetail = false
            this.whichStudentId = 0
          }
          return
        } else {
          this.isShowDetail = true
          this.whichStudentId = data.studentInfo.studentId
          this.$nextTick(() => {
            this.setDetailCardOrientation(data)
          })
        }
        if (data.isSelf) {
          sa.track('learning_click', {'click_id': 'pc_learning_rankings_view_self_detail'})
        } else {
          sa.track('learning_click', {'click_id': 'pc_learning_rankings_view_other_detail'})
        }
      },
      //设置详情内容卡片的位置
      setDetailCardOrientation(data) {
        let rect = this.$refs.rankingsContent.getBoundingClientRect()
        if (data.isNormal) {
          this.$refs.detailCard.setAttribute("style", `top:${data.top - rect.top - (this.$refs.detailCard.clientHeight / 2)}px;left:${data.right - rect.left + 23}px`)
        } else {
          this.$refs.detailCard.setAttribute("style", `top:${data.top - rect.top - (this.$refs.detailCard.clientHeight / 2)}px;left:${data.left - rect.left -336 - 23}px`)
        }
      },
      //同步tab容器的高度
      fitHeight() {
        this.$refs.tabsWrapper.setAttribute('style', `height: ${this.$refs.tabs.clientHeight}px`)
      },
      doAgree(msg) {
        if (this.sendDoAgree) {
          return
        }
        this.sendDoAgree = true
        if (msg) {
          //发送同意协议请求
          this.$playSound("click")
          axios.post("/rest/learninggw/api/rank/status/agreeProtocolStatusByStudentId",
            formurlencoded({
              studentId: cookies.get("studentId")
            })
          ).then((res) => {
            if (res.data.code == 200) {
              this.isAgreeRankings = true
              this.$nextTick(() => {
                this.fitHeight()
              })
              this.isThisDialogShow = false
            }
            this.sendDoAgree = false
          }).catch(() => {
            this.sendDoAgree = false
          })
        } else {
          untils.gotoFirstPage()
        }
      },
      doPreRankings() {
        //防抖
        if (this.getRankingListDetail) {
          return
        }
        this.showRankingListLoading = true
        this.isPre = !this.isPre
        this.checkRankingInfo()
        sa.track('learning_click', {'click_id': 'pc_learning_rankings_check_period'})
        this.$playSound("click")
      },
      delDetailCard() {
        this.isShowDetail = false
        this.whichStudentId = 0
      },
      //获取奖励
      showGift(id) {
        //发送打开宝箱接口
        axios.post("/rest/learninggw/api/rank/treasureBox/openByRankingScoreIdAndStudentId",
          formurlencoded({
            rankingScoreId: id,
            studentId: cookies.get("studentId")
          })
        ).then((res) => {
          if (res.data.code == 200) {
            this.isShowGift = true
            this.rankingsStatus = 2
          }
        })
      },
      doResetGetRankingListDetail(flag) {
        this.getRankingListDetail = false
        this.showRankingListLoading = false
        if (flag) {
          //获取列表成功
          if (this.isPre) {
            this.rankTimer = `${untils.dateTime(this.preRankingInfo.fromDate).split('-').join('.')} ~ ${untils.dateTime(this.preRankingInfo.toDate).split('-').join('.')}`
            if (this.preRankingInfo.rankingTreasureBoxStatus) {
              //已经领奖
              this.rankingsStatus = 2
            } else if (this.nowRankingInfo.serverTime - this.nowRankingInfo.toDate > 1000 * 3600 * 24 * 3) {
              //已经错过结束时间 结束后三天 过期
              this.rankingsStatus = 3
            } else {
              //结算中
              this.rankingsStatus = 1
            }
            this.rankTitle = '上期' + this.rankName
          } else {
            this.rankTimer = `${untils.dateTime(this.nowRankingInfo.fromDate).split('-').join('.')} ~ ${untils.dateTime(this.nowRankingInfo.toDate).split('-').join('.')}`
            this.rankingsStatus = 0
            //结算时间为活动时间结束后1到3天，这里取1天
            this.cutDownDay = parseInt((this.nowRankingInfo.toDate - this.nowRankingInfo.serverTime) / (1000 * 3600 * 24)) + 1
            this.rankTitle = '本期' + this.rankName
          }
        } else {
          //获取列表失败,重置回原切换状态
          this.isPre = !this.isPre
        }
      },  
      //关闭领奖返回排行榜
      goBackRank() {
        this.$playSound("click")
        this.isShowGift = false
      },
      setTabChecked(index) {
        this.tabIndex = index || 0
        this.resetSomeData()
      },
      //重置数据
      resetSomeData() {
        this.myRanking = 1
        this.stoneNum = ''
        this.hideCheckRankBtn = false 
        this.isNetError = false 
        this.isNeedAnimated = false
        this.isShowDetail = false 
        this.rankingsStatus = 0 
        this.isPre = false
      }
    }
  }
</script>
<style lang="stylus" scoped>
  .fade-leave-active
    transition: opacity .5s

  .fade-leave-to
    opacity: 0

  *
    user-select: none
    -webkit-tap-highlight-color: transparent
    
  .flex-center
    display: flex
    display: -webkit-flex
    align-items: center
    justify-content: center
    -webkit-align-items: center
    -webkit-justify-content: center
    
  .rankings-container
    width: 100%
    height: 100%
    position: absolute
    left: 0
    right: 0
    z-index: 2

    .rankings-content-wrapper
      padding-left: 143px
      position: relative

      .detail-card
        position: absolute
        z-index: 20
        top: 0
        left: 0

      .rankings-ship
        width: 860px
        height: 607px
        background-image: url("../../img/rankings/ship-bg@2x.png")
        background-repeat: no-repeat
        background-size: 100% 100%
        position: relative
        border-top: 1px solid transparent
        
        .rankings-list-box
          overflow: hidden

        .list-loading
          display: flex
          display: -webkit-flex
          -webkit-align-items: center
          -webkit-justify-content: center
          align-items: center
          justify-content: center
          position: absolute
          left: 60px
          top: 126px
          width: 740px
          height: 443px
          z-index: 200
          background: url('../../img/rankings/mask_award@2x.png') no-repeat
          background-size: 100% 100%
          border-radius:30px 30px 400px 400px/30px 30px 30px 30px
          overflow: hidden

          img
            display: block
            width: 120px
            height: 120px  
              

        .rankings-status
          display: none
          position: absolute
          top: 31px
          right: 181px
          width: 94px
          height: 72px

        .rankings-status-statistical
          display: block
          background-image: url("../../img/rankings/checked@2x.png")
          background-repeat: no-repeat
          background-size: 100% 100%

        .rankings-status-over
          display: block
          background-image: url("../../img/rankings/award_checked@2x.png")
          background-repeat: no-repeat
          background-size: 100% 100%

        .rankings-tabship
          position: absolute
          left: -143px
          top: 95px
          z-index: 2
          width: 160px

          .rankings-tabship-top
            width: 100%
            height: 96px
            background-image: url("../../img/rankings/jet-body_up@2x.png")
            background-repeat: no-repeat
            background-size: 100% 100%

          .rankings-tabship-body
            position: relative
            width: 100%
            background-image: url("../../img/rankings/jet-body@2x.png")
            background-repeat: no-repeat
            background-size: 100% 100%

            .tab-selected
              width: 184px
              height: 136px
              background-image: url("../../img/rankings/selected@2x.png")
              background-repeat: no-repeat
              background-size: 100% 100%
              position: absolute
              top: 33px
              left: 6px
              transition: top 0.5s
            
            .long-rankings-tabs
              display: flex
              display: -webkit-flex
              -webkit-align-items: center
              -webkit-justify-content: center
              -webkit-flex-direction: column
              align-items: center
              justify-content: center
              flex-direction: column

            .rankings-tabs
              position: absolute
              box-sizing: border-box
              min-height: 137px
              max-height: 312px
              width: 100%
              top: 0
              left: 0
              z-index: 10
              overflow: hidden
              
              .tab-box-wrapper
                .tab-box
                  width: 138px
                  height: 68px
                  font-size: 20px
                  line-height: 68px
                  color: #fff
                  text-align: center
                  background-image: url("../../img/rankings/tab@2x.png")
                  background-repeat: no-repeat
                  background-size: 100% 100%
                  cursor: pointer
                  margin: 0 auto 12px
                  overflow: hidden
                  
                  &:last-child
                    margin-bottom: 0

              .tab-box-selected
                background-image: url("../../img/rankings/tab_selected@2x.png")
                background-repeat: no-repeat
                background-size: 100% 100%   

          .rankings-tabship-bottom
            width: 100%
            height: 85px
            background-image: url("../../img/rankings/jet-body_down@2x.png")
            background-repeat: no-repeat
            background-size: 100% 100%

        .rankings-title 
          width: 100%
          height: 50px
          font-size: 36px
          color: rgba(129,253,255,1)
          line-height: 50px
          text-align: center
          margin-top: 20px
        
        .rankings-timer
          width: 206px
          height: 22px
          background: rgba(129,253,255,0.31)
          border-radius: 12px
          font-size: 16px
          color: rgba(255,255,255,1)
          line-height: 22px
          text-align: center
          margin: 5px auto 29px

        .rankings-count-down
          position: absolute
          left: 0
          bottom : 48px
          width: 100%
          height: 25px
          font-size: 14px
          color: #fff
          line-height: 20px
          text-align: center

          span:nth-child(1)
            font-size: 18px
            margin: 0 3px
        
        .rankings-count-down-msg
          display: flex
          display: -webkit-flex
          align-items: center
          justify-content: center
          -webkit-align-items: center
          -webkit-justify-content: center
          position: absolute
          left: 0
          bottom : 48px
          width: 100%

          .icon
            display: inline-block
            width: 22px
            height: 22px
            background-image: url("../../img/rankings/counting@2x.png")
            background-repeat: no-repeat
            background-size: 100% 100%
            margin-right: 7px

          span
            font-size: 14px
            color: #fff


        .rankings-direction
          position: absolute
          left: 341px
          bottom : -18px
          width: 180px
          height: 44px
          line-height: 44px
          text-align: center
          font-size: 14px
          color: #fff
          background-image: url("../../img/rankings/ruler-bg@2x.png")
          background-repeat: no-repeat
          background-size: 100% 100%
          cursor: pointer

  @media screen and (min-width: 1920px)
    .rankings-container
      .rankings-content-wrapper
        .rankings-ship
          width: 1290px
          height: 911px
  
          .list-loading
            width: 1110px
            height: 665px
            left: 90px
            top: 189px
  
          .rankings-status
            top: 44px
            right: 300px
  
          .rankings-tabship
            left: -120px
            top: 166px  
  
          .rankings-title
            margin-top: 51px
  
          .rankings-timer
            margin: 5px auto 60px
  
          .rankings-count-down
            bottom : 80px
          
          .rankings-count-down-msg
            bottom : 80px
          .rankings-direction
            left: 555px
            bottom : -18px
  
  @media screen and (max-width: 1025px)         
    .rankings-container
      .rankings-content-wrapper
        .rankings-ship
          transform: scale(0.9)
</style>

