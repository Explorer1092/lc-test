<template lang="jade">
  .steam-upload
    top-part(:title_cn="titleCh", :title_eng="titleEn", :gobackurl="null")
    .upload-area(v-vkLoading="isLoading", @click="!isReplaceButtonShow && fileLoaderTriger()", :class="{'has-image': isReplaceButtonShow}")
      img.upload-cross(v-if="isAddIconShow", src="../../../img/extension/upload_cross.png")
      .upload-area-text(v-if="isAddIconShow") 快来上传你的精彩作品吧～
      img.after-cut-view(v-if="bindedImageURL", :src="bindedImageURL", @load="loadingImageSuccess")
    vk-btn.upload-button(v-if="isReplaceButtonShow", :type="buttonType", :text="'替换作品'", :clickFun="fileLoaderTriger")
    .mirror(v-if="isShowMirror")
    .cutter(v-if="isShowImgCut")
      .img-cutter
        vk-btn.cutter-button-left(:type="'sl'", :text="'取消'", :clickFun="cancel")
        vk-btn.cutter-button-right(:type="'sl'", :text="'确定'", :clickFun="confirmCut")
        .img-cutter-wrap
          cropper.vue-cropper-inner(ref="cropper2",
          :img="cropperImg.img",
          :outputSize="cropperImg.size",
          :outputType="cropperImg.outputType",
          :info="cropperImg.info",
          :canScale="cropperImg.canScale",
          :autoCrop="cropperImg.autoCrop",
          :autoCropWidth="cropperImg.width",
          :autoCropHeight="cropperImg.height",
          :fixed="cropperImg.fixed",
          :fixedNumber="cropperImg.fixedNumber")
    .upload-processing(v-if="isUploadingShow")
      .process-percent {{progress + '%'}}
      .process-bar
        .process-box
          .process-inside(:style="{'width': progress + '%'}")
      .process-text 作品上传中...
    .failed(v-if="isFailedShow")
      .oops Oops
      img.dragon(src="../../../img/extension/han.png")
      .fail-text 图片上传失败，再试一次吧～！
      vk-btn.cutter-button-left(:type="'sl'", :text="'取消'", :clickFun="cancel")
      vk-btn.cutter-button-right(:type="'sl'", :text="'重试'", :clickFun="tryAagin")
    input(ref="fileLoader", type="file", name="file", accept=".jpg,.jpeg,.png", @change="sendImageToCutter", v-show="false")

</template>
<script>
  import Vue from "vue"
  import axios from 'axios'
  import VVOS from "vvos-js"
  import uploadStatus from '../../project_demo/components/upload_status.vue'
  import UPLOAD from '../../project_demo/js/upload.js'
  import cookies from 'cookies-js'
  import TopPart from '../../common/top_part.vue'
  import vkBtn from '../../common/vk_button.vue'
  import cropper from "vue-cropper"
  import loading from "../../common/plugins/Loading"
  import utils from '../../../utils/_untils.js'
  Vue.use(loading)
  export default {
    data(){
      return {
        titleCh: "上传作品",
        titleEn: "Upload Your Project",
        isLoading: true,
        buttonType: 'lg-enable',
        cutedImage: '',
        uploadedImageURL: null,
        bindedImageURL: null,
        progress: 0,
        isShowImgCut: false,
        isShowMirror: false,
        isFailedShow: false,
        isUploadingShow: false,
        isReplaceButtonShow: false,
        isAddIconShow: false,
        cropperImg: {
          img: '',
          info: true,
          size: 1,
          outputType: 'jpeg',
          canScale: true,
          autoCrop: true,
          // 只有自动截图开启 宽度高度才生效
          autoCropWidth: 400,
          autoCropHeight: 300,
          // 开启宽度和高度比例
          fixed: true,
          fixedNumber: [4, 3]
        },
        blobData: null,
        cropTipsForPad: '快来上传你的精彩作品吧～'
      }
    },
    components: {
      uploadStatus,
      loading,
      TopPart,
      cropper,
      vkBtn
    },
    mounted() {
      this.checkSteamWork()
      let userAgent = navigator.userAgent
      if(userAgent.indexOf("VIPKID") == -1 && userAgent.indexOf("vipkid") == -1) {
        if (cookies.get('isFromApp')) {
          this.initVKAppBridge()
	    	}
      }
    },
    methods: {
      loadingImageSuccess() {
        this.isLoading = false
      },
      checkSteamWork() {
        axios.get('/rest/learninggw/api/pc/path/minor/getSteamHomework',{
          params: {
            studentId: cookies.get("studentId"),
            lessonId: this.$route.params.curriculumId,
            curriculumVersion: this.$route.params.curriculumVersion
          }
        }).then((res) => {
          if (res.data.data && res.data.data.projectUrl) {
            this.bindedImageURL = res.data.data.projectUrl
            this.isReplaceButtonShow = true
          } else {
            this.isLoading = false
            this.isAddIconShow = true
          }
        })
      },
      confirmCut() {
        this.isShowImgCut = false
        this.isUploadingShow = true
        this.isShowMirror = true
        this.$refs.cropper2.getCropBlob((data) => {
          this.blobData = data
          this.$nextTick(() => {
            this.uploadByVvos()
          })
        })
      },
      uploadByVvos() {
        let file = new File([this.blobData], this.$refs.fileLoader.files[0].name, {type: this.blobData.type, lastModified: Date.now()})
        let upload = new VVOS ({
          api:{
            // 上传时取得token
            gettoken: '/rest/learninggw/api/pc/path/minor/getToken',
            // 上传完成后通知接口
            notifier: '/rest/learninggw/api/pc/path/minor/uploadComplete'
          },
          cover: true,
          client: 'vos-js.sdk 1.0.0.0'
        })

        upload.addfiles([file])
        // 提交文件
        upload.submit({
          gettoken: {},
          notifier: {
            resourceType: 0,
            mp4: false,
            name: this.$refs.fileLoader.files[0].name
          },
          exists: {}
        }, (err, data) => {
          let imgUrl = data.data.data
          if (data.data.code == 200) {
            this.uploadedImageURL = imgUrl
            this.$nextTick(() => {
              this.bindImage()
            })
          }
        }, (err, process) => {
          // 上传进度回调
          if (process) {
            if (process.process) {
              this.progress = Math.floor(process.process * 100)
            } else {
              this.progress = 99
            }
          }
        })

      },
      bindImage() {
        axios.post('/rest/learninggw/api/pc/path/minor/uploadSteamHomework', {
          studentId: cookies.get('studentId'),
          curriculumId: this.$route.params.curriculumId,
          curriculumVersion: this.$route.params.curriculumVersion,
          curriculumType: 'lesson',
          projectUrl: this.uploadedImageURL
        })
          .then((res) => {
            if(res.data.data) {
              sa.track('learning_click', {'click_id': 'pc_learning_minor_course_steam_upload_success'})
              this.isAddIconShow = false
              this.bindedImageURL = this.uploadedImageURL
              this.isUploadingShow = false
              this.isShowImgCut = false
              this.isShowMirror = false
              this.isReplaceButtonShow = true
            } else {
              this.uploadFail()
            }
          })
          .catch((err) => {
            this.uploadFail()
          })
      },
      uploadFail() {
        this.isFailedShow = true
        this.isShowMirror = true
        this.isShowImgCut = false
        this.isUploadingShow = false
      },
      sendImageToCutter(e) {
        let file = this.$refs.fileLoader.files[0]
        if(!file) return
        if(!/^image\/png|jpg|jpeg/.test(file.type)) {
          this.$refs.fileLoader.value = ''
          this.$showToast('宝贝,请选择:<br>PNG或JPG格式的图片~')
          return
        }
        if(file.size > 3145728) {
          this.$refs.fileLoader.value = ''
          this.$showToast('宝贝,请选择:<br>3MB以下的图片哦～')
          return
        }
        if(this.cutedImage) {
          window.URL.revokeObjectURL(this.cutedImage) //释放已存在的 URL 对象
        }
        this.cutedImage = window.URL.createObjectURL(file)
        this.cropperImg.img = this.cutedImage
        this.isShowImgCut = true
        this.isShowMirror = true
      },
      fileLoaderTriger() {
        let type = 0 //@type 0:客户端提示用户“拍照”还是“相册”, 1:直接拍照, 2:直接从相册中选择
        if (cookies.get('isFromApp')) {
          let _ua = navigator.userAgent
          let regex = /devicemodel\/iPad\d+(\,\d+)*/g
          if (_ua.match(regex) && _ua.match(regex)[0].match(/\d+/) == 2 || !_ua.match(regex)) {
            type = 2 //取到设备版本号后如果是低端机or取不到设备号，都只能从相册选择图片。
          }
          utils.dispatchForIpad(`vkappbridge://fileupload/picture?type=${type}&product=pd&crop_enable=1&crop_tips=${this.cropTipsForPad}`)
        } else {
          this.$refs.fileLoader.click()
        }
      },
      tryAagin() {
        this.isFailedShow = false
        this.isUploadingShow = true
        this.uploadByVvos()
      },
      cancel() {
        this.$refs.fileLoader.value = ''
        this.isFailedShow = false
        this.isShowMirror = false
        this.isShowImgCut = false
        this.cropperImg.img = ''
      },
      initVKAppBridge() {
        window.VKAppBridge = {}
        window.VKAppBridge['receiveFromNative'] = (iosRes) => {
          let data = JSON.parse(iosRes)
          if (data.data.code === 0) {
            this.uploadedImageURL = data.data.image_url
            this.$nextTick(() => {
              this.bindImage()
            })
          }
        }
      }
    }
  }
</script>

<style lang="stylus" scoped>

.vue-cropper-inner
  height: 150%
  width: 200%
  transform: scale(0.5)
  transform-origin: 0 0

.failed
  position: absolute
  top: 50%
  left: 50%
  width: 500px
  height: 375px
  margin: -180px 0 0 -250px
  z-index: 7
  .oops
    position: absolute
    top: 50%
    left: 50%
    margin-left: -65px
    margin-top: -160px
    width: 130px
    height: 70px
    background-image: url('../../../img/extension/qipao.png')
    background-repeat: no-repeat
    background-size: 100% 100%
    color: white
    font-size: 36px
    text-align: center
    line-height: 56px
  .dragon
    position: absolute
    top: 50%
    left: 50%
    margin-left: -58px
    margin-top: -47px
    width: 116px
    height: 161px
  .fail-text
    position: absolute
    top: 337px
    left: 125px
    color: white
    font-size: 20px
    
.upload-cross
  position: absolute
  top: 50%
  left: 50%
  margin-left: -50px
  margin-top: -74px
  width: 100px
  height: 100px

.upload-button
  position: absolute
  top: 50%
  left: 50%
  margin: 245px 0 0 -90px
  @media screen and (min-width: 1025px) and (min-height: 680px)
    margin: 272px 0 0 -90px
  @media screen and (min-width: 1281px) and (min-height: 725px)
    margin: 309px 0 0 -90px
  @media screen and (min-width: 1680px) and (min-height: 855px)
    margin: 375px 0 0 -90px
.upload-processing
  position: absolute
  top: 50%
  left: 50%
  width: 500px
  height: 375px
  margin: -180px 0 0 -250px
  z-index: 7
  .process-percent
    position: absolute
    width: 100px
    top: 119px
    left: 50%
    margin-left: -50px
    text-align: center
    font-size: 30px
    color: #B396FF
.process-text
  position: absolute
  top: 229px
  left: 190px
  color: white
  font-size: 20px
  
.process-bar
  position: absolute
  top: 50%
  left: 50%
  margin-top: -15px
  margin-left: -200px
  width: 400px
  height: 30px
  border: 2px solid #B396FF
  background-color: black
  border-radius: 20px
  overflow: hidden
  box-sizing: border-box
  .process-box
    position: absolute
    top: 3px
    left: 3px
    height: 20px
    border-radius: 20px
    width: 390px
    overflow: hidden
    .process-inside
      height: 100%
      background-color: #B396FF
      border-radius: 20px

.upload-area
  position: absolute
  top: 50%
  left: 50%
  width: 500px
  height: 375px
  box-sizing: border-box
  margin: -180px 0 0 -250px
  border: 4px dashed #B396FF
  border-radius: 20px
  background-color: rgba(179,150,255,0.3)
  cursor: pointer
  overflow: hidden
  @media screen and (min-width: 1025px) and (min-height: 680px)
    width: 600px
    height: 454px
    margin: -213px 0 0 -300px
  @media screen and (min-width: 1281px) and (min-height: 725px)
    width: 700px
    height: 525px
    margin: -246px 0 0 -350px
  @media screen and (min-width: 1680px) and (min-height: 855px)
    width: 900px
    height: 675px
    margin: -324px 0 0 -450px
  &.has-image
    border: 4px solid #B396FF
    &:hover
      background-color: rgba(179,150,255,0.3)
      cursor: default
  &:hover
    background-color: rgba(179,150,255,0.6)
.upload-area-text
  position: absolute
  top: 50%
  left: 50%
  color: #b396ff
  font-size: 20px
  font-weight: 800
  width: 250px
  margin: 36px 0 0 -117px
  text-align: center
.img-cutter
  position: absolute
  top: 50%
  left: 50%
  z-index: 10
  margin: -215px 0 0 -290px
  width: 580px
  height: 435px
  box-sizing: border-box
  border: 3px solid #B396FF
  border-radius: 23px
  background-color: #594B80
.img-cutter-wrap
  width: 574px
  height: 497px
  position: absolute
  top: 29px
  left: 0px
.mirror
  position: fixed
  top: 0
  left: 0
  right: 0
  bottom: 0
  background-color: #000
  opacity: 0.8
  z-index: 7
.cutter-button-left
  position: absolute
  bottom: -80px
  left: 101px
  z-index: 2
.cutter-button-right
  position: absolute
  bottom: -80px
  right: 101px
  z-index: 2
.after-cut-view
  width: 100%
  height: 100%
  position: relative
  z-index: 6
  
</style>