<template lang="jade">
    .project_page_wrapper(ref="wrapper", :class="{'no_scroll': isDimmed}")
        top-part(:title_cn="titleCh", :title_eng="titleEn", :isAbsoluteFix="true")
        .card_container
            .card.img_card(v-if="!!result.demoImage")
                .card_item_title 
                    p {{result.demoImage.name}}
                .card_item.card_item_img
                    .img_list
                        template(v-if="!!result.demoImage.demoImageList", v-for="(item, index) in result.demoImage.demoImageList")
                            img(@click="showImageLayer($event)", :src="item", :class="{'is_show': index===imgIndex}")/
                    .page_count(v-if="!result.demoImage.demoImagePdf")
                        p {{imgIndex + 1}}/{{imgListSize}}
                .arrow_group(v-if="!result.demoImage.demoImagePdf")
                    .arrow_item.left(@click="switchImage('left')", :class="{'is_hidden': imgIndex===0}")
                    .arrow_item.right(@click="switchImage('right')", :class="{'is_hidden': imgIndex===imgListSize-1}")
            .card.video_card(v-if="!!result.demoVideo")
                .card_item_title 
                    p {{result.demoVideo.name}}
                .card_item.card_item_video
                    video(controls="controls", :poster="result.demoVideo.preViewImage")
                        source(:src="result.demoVideo.demoVideo")/ 
                        | Your browser does not support the video tag.
            .card.button_card
                .card_item_button(:class="!!result.codespark ? 'dubble' : 'single'")
                    .button_item.file_button(v-if="!!result.demoPdf")
                        p(@click="downloadTemplate()") {{result.demoPdf.name}}
                    .button_item.app_button(v-if="!!result.codespark && isNewIpadApp", @click="goToThirdPartyApp()") 
                        p {{result.codespark.name}}
                .card_item_info(v-if="!!result.demoInfo")
                    p {{result.demoInfo}}
        .bottom_tip(:class="{'is_hidden': isHiddenTip}")
            div
        .black_mirror(v-if="isDimmed")
            div(@click="hiddenImageLayer()")
            img(:src="orgImgUrl")
</template>

<script>
    import TopPart from '../common/top_part.vue'
    import dragonUtils from "../../utils/_dragon"
    import utils from '../../utils/_untils.js'
    import cookies from 'cookies-js'
    import {Base64} from "js-base64"
    import axios from 'axios'
    export default {
      data() {
        return {
          titleCh: '',
          titleEn: '',
          imgListSize: 0,
          imgIndex: 0,
          // 是否显示蒙层
          isDimmed: false,
          // 大图链接
          orgImgUrl: '',
          // 是否显示下滑提示
          isHiddenTip: false,
          isIpadApp: !!cookies.get('isFromApp'),
          isNewIpadApp: false,
          isPcApp: dragonUtils.isOnDragonClient(),
          result: {}
        }
      },
      components: {
        TopPart
      },
      created: function() {
        // 调用获取素材函数
        this.getSource()
      },
      mounted() {
        // 监听滚动事件，并隐藏下滑提示
        this.initBottomTip()
        this.$refs.wrapper.onscroll = () => {
          this.initBottomTip()
        }
        // 判断是否是 2.14.* 以上版本
        var ua = navigator.userAgent.toLowerCase()
        var versionNum = ua.match(/study-app\/(\d*\.\d*\.\d*) /i) && ua.match(/study-app\/(\d*\.\d*\.\d*) /i)[1]
        var numList = !!versionNum && versionNum.indexOf(".") > 0 && versionNum.split(".")
        if (numList.length > 1 && numList[0] >= 2 && numList[1] >= 14) {
          this.isNewIpadApp = true
        }
      },
      methods: {
        // 获取按钮函数
        getSource() {
          let url = "/rest/learninggw/api/pc/path/minor/getPDHomeworkDetail"
          let param = {
            studentId: cookies.get("studentId"),
            courseId: this.$route.params.courseId,
            lessonId: this.$route.params.lessonId,
            // 0为PC 1为PC-APP 2为IPAD
            source: this.isIpadApp ? 2 : (this.isPcApp ? 1 : 0)
          }
                
          axios.get(url, {
            params: param
          }).then((res) => {
            if(res.data.code != 200) {
              alert("网络有点问题，检查一下网络连接吧")
              return
            }
            this.result = res.data.data
            // 获取标题
            this.titleCh = this.result.title
            if (this.result.subTitle && this.result.subTitle != "N/A") {
              this.titleEn = this.result.subTitle
            } else {
              this.titleEn = ""
            }
            // 获取图片列表长度
            if (this.result.demoImage && this.result.demoImage.demoImageList) {
              this.imgListSize = this.result.demoImage.demoImageList.length  
            } else {
              this.imgListSize = 0
            }  
          })
        },
        // 切换图片
        switchImage(direction) {
          // 向右切
          if (direction === "right" && this.imgIndex < this.imgListSize - 1) {
            this.imgIndex++
            // 向左切
          } else if (direction === "left" && this.imgIndex > 0) {
            this.imgIndex--
          }
        },
        // 显示大图浮层
        showImageLayer(event) {
          // 如果是pdf文件的话跳转到pdf浏览页
          if (!!this.result.demoImage.demoImagePdf) {
            var url = Base64.encode(this.result.demoImage.demoImagePdf)
            this.$router.push("/pdf_view/" + url)
            return
          }
          // 图片的情况
          var target = event.target || event.srcElement
          // 图片文件时
          if (target.nodeName === "IMG") {
            this.orgImgUrl = target.src
            this.isDimmed = true
          }
        },
        // 隐藏大图浮层
        hiddenImageLayer() {
          this.isDimmed = false
        },
        // 下载模版
        downloadTemplate() {
          // 神策打点
          sa.track('learning_click', {'click_id': this.result.demoPdf.clickId})
          // 点击音效
          this.$playSound("click")
          // iPad App 和 PC APP 的话跳转到 PDF 展示页，PC WEB 提供下载
          if (this.isIpadApp || this.isPcApp) {
            var url = Base64.encode(this.result.demoPdf.demoPdf)
            this.$router.push("/pdf_view/" + url)
          } else {
            window.location.href = this.result.demoPdf.demoPdf
          }
        },
        // 打开 codespark 应用
        goToThirdPartyApp() {
          // 神策打点
          sa.track('learning_click', {'click_id': this.result.codespark.clickId})
          // 点击音效
          this.$playSound("click")
          utils.dispatchForIpad("vkappbridge://appopen/open?scheme=" + this.result.codespark.app_scheme + "&storelink=" + this.result.codespark.app_storelink)
        },
        // 初始化下滑提示
        initBottomTip() {
          var wrapper = this.$refs.wrapper
          if (wrapper.scrollHeight * 0.7 < (wrapper.clientHeight + wrapper.scrollTop)) {
            this.isHiddenTip = true
          }
        }       
      }
    }
</script>

<style lang="stylus" scoped>
    .project_page_wrapper
        width: 100%
        background: #433798;
        background: -moz-linear-gradient(top, #433798 0%, #782A92 100%);
        background: -webkit-linear-gradient(top, #433798 0%, #782A92 100%);
        background: linear-gradient(to bottom, #433798 0%, #782A92 100%);
        overflow: scroll
        &.no_scroll
            overflow: hidden
        .card_container
            position: relative
            width: 100%
            margin-top: 114px
            .card
                position: relative
                width: 984px
                margin: 0 auto
                &.video_card
                    margin-top: 38px
                &.button_card
                    margin-bottom: 71px
                .card_item_title
                    background-image: url("../../img/project/project_rectangle4_@2x.png")
                    background-size: cover
                    margin: 0 auto
                    height: 42px
                    width: 278px
                    p 
                        text-align: center 
                        color: #ffffff
                        font-size: 20px;
                        line-height: 26px;
                        padding-top: 12px;
                .card_item
                    margin: 0 auto
                    position: relative
                    border: 10px solid #9E7CFF
                    border-radius: 20px
                .card_item_img
                    width: 800px
                    height: 569px
                    .img_list
                        overflow: hidden
                        height: 100%
                        border-radius: 10px
                        img 
                            width: 100%
                            cursor: pointer
                            display: none
                            &.is_show
                                display: block
                    .page_count
                        width: 92px
                        height: 18px
                        border: 4px solid #9E7CFF
                        border-radius: 20px
                        background: #7F5DE1
                        position: absolute
                        bottom: -18px
                        left: 350px
                        p
                            text-align: center 
                            font-size: 14px
                            color: #ffffff
                            line-height: 19px
                .arrow_group
                    .arrow_item
                        width: 38px
                        height: 70px
                        top: 302px
                        background-size: cover
                        position: absolute
                        cursor: pointer
                        &.left
                            background-image: url("../../img/project/project_arrow_left_@2x.png")
                            left: 0
                        &.right
                            background-image: url("../../img/project/project_arrow_right_@2x.png")
                            right: 0
                        &.is_hidden
                            display: none
                .card_item_video
                    width: 964px
                    video 
                        height: 100%
                        width: 100%
                        border-radius: 10px
                        display: block
                .card_item_button
                    margin: 30px auto 0px auto
                    height: 50px
                    text-align: center
                    p
                        text-align: center 
                        font-size: 22px
                        color: #ffffff
                        line-height: 2
                    .button_item
                        width: 240px
                        height: 50px
                        margin: auto 30px
                        background-size: cover
                        cursor: pointer
                        background-image: url("../../img/project/project_app_button_@2x.png")
                        display: inline-block
                    &.dubble
                        .file_button
                            background-image: url("../../img/project/project_template_button_@2x.png")                  
                .card_item_info
                    margin: 13px
                    p
                        font-size: 18px
                        font-weight: 400
                        color: rgba(158,124,255,1)
                        line-height: 25px
                        text-align: center 
        .bottom_tip
            position: fixed
            bottom: 30px
            width: 100%
            animation: arrowJumping 0.4s linear infinite alternate
            div
                margin: auto
                width: 60px
                height: 60px
                background-image: url("../../img/project/project_bottom_tip_@2x.png")
                background-size: cover
            &.is_hidden
                div
                    animation: arrowHidden 0.5s linear
                    animation-fill-mode: forwards
        .black_mirror
            position: fixed
            top: 0
            bottom: 0
            left: 0
            right: 0
            z-index: 20
            width: 100%
            height: 100%
            background-color: rgba(0, 0, 0, 0.7)
            overflow: scroll
            display:flex;/*Flex布局*/
            display: -webkit-flex; /* Safari */
            align-items:center;/*指定垂直居中*/
            div
                position: absolute
                z-index: 30
                width: 40px 
                height: 40px
                top: 50px
                right: 60px
                background-image: url("../../img/project/project_image_layer_close_button_@2x.png")
                background-size: cover
                cursor: pointer
            img 
                width: 100%
                margin: auto;
    @keyframes arrowJumping
        from
            bottom: 35px
        to
            bottom: 25px
    @keyframes arrowHidden
        from
            opacity: 1
        to
            opacity: 0
</style>