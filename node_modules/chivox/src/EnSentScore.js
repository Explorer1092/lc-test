/*
 * ChiVox API provides ChiVox Ltd's (www.chivox.com) world leading pronunciation
 * evaluation, speech recognition technologies, and text-to-speech technologies.
 *
 * ChiVox Ltd opens this API hoping make every programmer be capable to implement
 * speech enabled applicaitons.
 *
 * Copyright (c) 2008-2014 by ChiVox. All rights reserved.
 *
 */
//========================================//
/**
 * EnSentScore 类，用于解析英文句子评分结果<br>
 * 支持的内核版本号为AIScoreEnSent_v1.5.5<br>
 * $Id: EnSentScore.js 4935 2014-08-21 09:03:38Z zhiyuan.liang $
 *
 * @namespace 英文句子评分结果类
 */
chivox.EnSentScore = function(data){
    this.data = data;
}
/**
 * 获得用户设置的评分参数（部分参数经过了过滤处理）
 */
chivox.EnSentScore.prototype.getParams = function(){
    return this.data.params;
}
/**
 * 获得本次评分的录音id。<br>
 * 在startRecord的时候，服务器生成的一个唯一的id，并回传给客户端
 */
chivox.EnSentScore.prototype.getRecordId = function(){
    return this.data.recordId;
}
/**
 * 获得本次请求的录音文件地址
 * @return {string}
 */
chivox.EnSentScore.prototype.getAudioUrl = function(){
    return this.data.audioUrl;
}
/**
 * 判断是否评分错误
 * @return {boolean}
 */
chivox.EnSentScore.prototype.hasError = function(){
    var r = false;
    if (typeof this.data.result == "undefined" || typeof this.data.result["err"] != "undefined" || typeof this.data.result["error"] != "undefined" || typeof this.data.result["errID"] != "undefined") {
        r = true;
    }
    return r;
}
/**
 * 获得错误码。如果不存在错误，则无返回值。
 * @return {int}
 */
chivox.EnSentScore.prototype.getErrorCode = function(){
    if (this.hasError()) {
        if (typeof this.data.result != "undefined" && this.data.result["errID"] != "undefined") {
            return this.data.result["errID"];
        } else {
            return this.data["error"];
        }
    }
    return;
}
/**
 * 句子综合评分
 * @return {int}
 */
chivox.EnSentScore.prototype.getOverall = function(){
    return this.data.result["overall"];
}
/**
 * 句子发音评分
 * @return {int}
 */
chivox.EnSentScore.prototype.getPron = function(){
    return this.data.result["pron"];
}
/**
 * 句子的流利度评分
 * @return {int}
 */
chivox.EnSentScore.prototype.getFluency = function(){
    return this.data.result.fluency["overall"];
}
/**
 * 句子完整性评分
 * @return {int}
 */
chivox.EnSentScore.prototype.getIntegrity = function(){
    return this.data.result["integrity"];
}
/**
 * 句子韵律性评分
 * @return {int}
 */
chivox.EnSentScore.prototype.getRhythm = function(){
    return this.data.result["rhythm"].overall;
}
/**
 * 句子准确性评分
 * @return {int}
 */
chivox.EnSentScore.prototype.getAccuracy = function(){
    return this.data.result["accuracy"];
}
/**
 * 本次评分的分制
 * @return {int}
 */
chivox.EnSentScore.prototype.getRank = function(){
    return this.data.result["rank"];
}
///**
// * 是否需要升调的标识，1表示升调
// * @return {int}
// */
//chivox.EnSentScore.prototype.getToneRef = function(){
//    return this.data.result["toneref"];
//}
///**
// * (暂时保留)
// */
//chivox.EnSentScore.prototype.getToneScore = function(){
//    return this.data.result["tonescore"];
//}
/**
 * 句子中的单词个数
 * @return {int}
 */
chivox.EnSentScore.prototype.getWordSize = function(){
    if (typeof this.data.result["chars"] != "undefined" && this.data.result["chars"].length > 0) {
        return this.data.result["chars"].length;
    } else {
        if (typeof this.data.result["details"] != "undefined" && this.data.result["details"].length > 0) {
            return this.data.result["details"].length;
        } else {
            return 0;
        }
    }
}
/**
 * 句子中第i个单词的评分细节。
 * @param {int} i
 * @return {chivox.EnSentScore.Word}
 */
chivox.EnSentScore.prototype.getWord = function(i){
    if (typeof this.data.result["chars"] != "undefined" && this.data.result["chars"].length > 0) {
        var charI = {
            "char": "",
            "dur": 0,
            "fluency": 0,
            "score": 0,
            "senseref": 0,
            "sensescore": 0,
            "stressref": 0,
            "stressscore": 0,
            "toneref": 0,
            "tonescore": 0,
            "liaison": 0
        };
        
        var passLength = 0;
        for (var j = 0; j < i; j++) {
            passLength += this.data.result["chars"][j].normalize.length;
        }
        
        var cl = this.data.result["chars"][i];
        charI["char"] = cl["char"];
        for (var num = 0; num < cl.normalize.length; num++) {
            var obj = this.data.result["details"][passLength + num];
            charI["dur"] += obj["dur"];
            charI["fluency"] += obj["fluency"];
            charI["score"] += obj["score"];
            charI["senseref"] += obj["senseref"];
            charI["sensescore"] += obj["sensescore"];
            charI["stressref"] += obj["stressref"];
            charI["stressscore"] += obj["stressscore"];
            charI["toneref"] += obj["toneref"];
            charI["tonescore"] += obj["tonescore"];
            charI["liaison"] += obj["liaison"];
        }
        charI["fluency"] = Math.round(charI["fluency"] / cl.normalize.length);
        charI["score"] = Math.round(charI["score"] / cl.normalize.length);
        charI["sensescore"] = Math.round(charI["sensescore"] / cl.normalize.length);
        charI["stressscore"] = Math.round(charI["stressscore"] / cl.normalize.length);
        charI["tonescore"] = Math.round(charI["tonescore"] / cl.normalize.length);
        
        return new chivox.EnSentScore.Word(charI);
        
    } else {
        var charI = this.data.result["details"][i];
        return new chivox.EnSentScore.Word(charI);
    }
}

//========================================//
/**
 * EnSentScore.Word 类，用于解析英文词语评分结果中details部分<br>
 * $Id: EnSentScore.js 4935 2014-08-21 09:03:38Z zhiyuan.liang $
 *
 * @namespace 英文句子评分结果Word类
 */
chivox.EnSentScore.Word = function(data){
    this.data = data;
}
/**
 * 单词文本
 * @return {string}
 */
chivox.EnSentScore.Word.prototype.getChar = function(){
    return this.data["char"];
}
/**
 * 单词语音帧长度
 * @return {int}
 */
chivox.EnSentScore.Word.prototype.getDur = function(){
    return this.data["dur"];
}
/**
 * 单词的流利度评分
 * @return {int}
 */
chivox.EnSentScore.Word.prototype.getFluency = function(){
    return this.data["fluency"];
}
/**
 * 单词的评分
 * @return {int}
 */
chivox.EnSentScore.Word.prototype.getScore = function(){
    return this.data["score"];
}
/**
 * 是否需要重音的标识，1表示重音，和参数中s:1标注对应。
 */
chivox.EnSentScore.Word.prototype.getStressRef = function(){
    return this.data["stressref"];
}
/**
 * 重音评分，stressscore=stressref 表示重音发音和标注符合。
 */
chivox.EnSentScore.Word.prototype.getStressScore = function(){
    return this.data["stressscore"];
}
/**
 * 是否需要升调的标识，1表示升调，和参数中t:1对应。
 */
chivox.EnSentScore.Word.prototype.getToneRef = function(){
    return this.data["toneref"];
}
/**
 * 语调评分， tonescore=toneref 表示语调发音和标注符合。
 */
chivox.EnSentScore.Word.prototype.getToneScore = function(){
    return this.data["tonescore"];
}

/**
 * 连读评分
 */
chivox.EnSentScore.Word.prototype.getLiaison = function(){
    return this.data["liaison"];
}
